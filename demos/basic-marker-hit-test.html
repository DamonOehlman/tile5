<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title></title>
  <meta name="description" content="">
  <meta name="author" content="Damon Oehlman">

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="_demogen/js/modernizr-2.0.6.min.js"></script>
</head>

<body>
  
  <style type="text/css">html, body, #mapContainer {
    margin: 0;
    height: 100%;
    width: 100%;
}

body {
    font: 1em Helvetica, Arial;
}

.t5-copyright {
    background: #e8e8e8;
    opacity: 0.4;
    font-size: 0.8em;
    padding: 5px;
}</style>
  
  <div id="mapContainer"></div>


  <!--[if lt IE 7 ]>
    <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

  <script src="_demogen/js/keymaster.min.js"></script>
  <script src="_demogen/js/jquery-1.6.2.min.js"></script>
  <script src="_demogen/js/ace/ace.js"></script>
  <script src="_demogen/js/ace/theme-twilight.js"></script>
  <script src="_demogen/js/ace/mode-javascript.js"></script>
  <script src="_demogen/js/runner.js"></script>
  <script src="../dist/tile5.cloudmade.js"></script>
  
  <script>
  var settings = {"theme":"twilight","mode":"javascript","body":"<div id=\"mapContainer\"></div>"};
  </script>
  <script defer="defer">// create the map
var map = new T5.Map('mapContainer', {
    renderer: settings.renderer || 'canvas',
    drawOnMove: settings.drawOnMove,
    drawOnTween: settings.drawOnTween
});

map.layer('tiles', 'tile', {
    generator: 'osm.cloudmade',
    // demo api key, register for an API key at http://dev.cloudmade.com/
    apikey: '7960daaf55f84bfdb166014d0b9f8d41',
    styleid: settings.mapstyle
});

map.zoom(8).center('-27.469 153.020');

var SEARCH_URL = 'http://ws.geonames.org/searchJSON?country=AU&fcode=PPL&maxRows=100',
    minRotate = 0,
    maxRotate = Math.PI / 2,
    clusterer,
    sample = {
        createMarkers: createMarkers,
        easing: 'sine.out'
    };
    
function animateMarkers(easingType) {
    var aniOpts,
        markers = map.layer('markers').find(),
        marker;

    // iterate through the markers
    for (var ii = markers.length; ii--; ) {
        marker = markers[ii];

        // initialise the animation opts
        aniOpts = {
            easing: sample.easing,
            duration: Math.random() * 1000 + 500 | 0
        };

        marker.scale(4).scale(1, aniOpts, true);
        marker.translate(0, -400).translate(0, 400, aniOpts);
    } // for
}        
    
function createMarkers() {
    var markers = map.layer('markers');
    
    // clear any existing markers
    markers.clear();

    // create the markers
    for (ii = 0 ; ii < data.length; ii++) {
        markers.create('marker', {
            xy: new T5.GeoXY(new GeoJS.Pos(data[ii][0], data[ii][1])),
            markerType: 'image',
            imageUrl: 'img/square-marker.png',
            size: 15
        });
    } // for
    
    animateMarkers();

    // DEMO.status('TIP: Hover over markers to highlight, tap to get info.', 1200);
    map.invalidate();
} // loadData

function tapMarker(marker) {
    marker.rotate(90, {
        easing: 'bounce.out'
    });
} // tapMarker

function handleHoverHit(evt, elements, absXY, relXY, offsetXY) {
    updateMarkerImages(elements, 'img/square-marker-highlight.png');
} // handleHoverHit

function handleHoverOut(evt, elements, absXY, relXY, offsetXY) {
    updateMarkerImages(elements, 'img/square-marker.png');
} // handleHoverOut

function handleTap(evt, elements, absXY, relXY, offsetXY) {
    var tappedNames = [],
        markers = [],
        ii, jj;
        
    T5.log('captured tap: hit ' + elements.length + ' elements');

    for (ii = elements.length; ii--; ) {
        var marker = elements[ii].target;
        
        // check for a cluster
        if (marker.children) {
            for (jj = marker.children.length; jj--; ) {
                markers[markers.length] = marker.children[jj];
            } // for
        }
        else {
            markers[markers.length] = marker;
        }

        if (marker) {
            tapMarker(marker);
        } // if
    } // for
    
    // iterate through the markers and add the names
    for (ii = markers.length; ii--; ) {
        tappedNames.push(markers[ii].name);
    } // for

    // DEMO.status('tapped: ' + tappedNames.join(', '), 1200);
} // handleTap

function loadEasingTypes() {
    var types = [],
        items = '';
    
    for (var ii = 0; ii < types.length; ii++) {
        items += '<a href="#">' + types[ii] + '</a>\n';
    } // for
    
    $('#easing-types').html(items).bind('click', function(evt) {
        animateMarkers(evt.target.innerText);
        
        return false;
    });
} // loadEasingTypes

function updateMarkerImages(elements, imageUrl) {
    for (var ii = elements.length; ii--; ) {
        var marker = elements[ii].target;
        
        marker.reset = true;
        marker.imageUrl = imageUrl;
    } // for
    
    map.invalidate();
} // updateMarkerImages

/* exports */

map.zoom(3).center('20.760000598852155 -46.23046875');

map.bind('tapHit', handleTap);
map.bind('hoverHit', handleHoverHit);
map.bind('hoverOut', handleHoverOut);

// Initiate a request using GRUNTS jsonp call and send the returned information to loadData();
// DEMO.status('Loading City Data from Geonames');

// load the easing types
loadEasingTypes();

/*
DEMO.createMarkers = createMarkers;

var ui = DEMO.makeSampleUI();
ui.gui.add(sample, 'easing').options('sine.out', 'sine.in', 'quad.in', 'bounce.out', 'linear');
ui.gui.add(sample, 'createMarkers').name('Drop Markers');
ui.done();
*/

// create the markers
createMarkers();

</script>
</body>
</html>
