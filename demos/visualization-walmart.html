<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title></title>
  <meta name="description" content="">
  <meta name="author" content="Damon Oehlman">

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="_demogen/js/modernizr-2.0.6.min.js"></script>
</head>

<body>
  
  <style type="text/css">html, body, #mapContainer {
    margin: 0;
    height: 100%;
    width: 100%;
}

body {
    font: 1em Helvetica, Arial;
}

.t5-copyright {
    background: #e8e8e8;
    opacity: 0.4;
    font-size: 0.8em;
    padding: 5px;
}</style>
  
  <div id="mapContainer"></div>


  <!--[if lt IE 7 ]>
    <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

  <script src="_demogen/js/keymaster.min.js"></script>
  <script src="_demogen/js/jquery-1.6.2.min.js"></script>
  <script src="_demogen/js/ace/ace.js"></script>
  <script src="_demogen/js/ace/theme-twilight.js"></script>
  <script src="_demogen/js/ace/mode-javascript.js"></script>
  <script src="_demogen/js/runner.js"></script>
  <script src="../dist/tile5.cloudmade.js"></script>
  <script src="_data/walmarts.js"></script>
  <script>
  var settings = {"theme":"twilight","mode":"javascript","body":"<div id=\"mapContainer\"></div>","drawOnMove":true,"mapstyle":999,"renderer":"canvas/dom"};
  </script>
  <script defer="defer">// create the map
var map = new T5.Map('mapContainer', {
    renderer: settings.renderer || 'canvas',
    drawOnMove: settings.drawOnMove,
    drawOnTween: settings.drawOnTween
});

map.layer('tiles', 'tile', {
    generator: 'osm.cloudmade',
    // demo api key, register for an API key at http://dev.cloudmade.com/
    apikey: '7960daaf55f84bfdb166014d0b9f8d41',
    styleid: settings.mapstyle
});

map.zoom(8).center('-27.469 153.020');

var storeIndex = 0,
    yearTimeout = 0,
    glowMarker,
    inactiveMarker,
    sample = {
        animated: false,
        year: 0,
        markers: 0,
        run: run
    },
    hslaFormatter = T5.formatter('hsla({0}, {1}%, {2}%, {3})');

function createGlowMarker(size, stopFn) {
    // create the glow marker as a new canvas
    var marker = document.createElement('canvas');
        stopPoints = [0, 0.1, 1];
        
    // initialise the marker with and height
    marker.width = marker.height = size;

    // get the canvas context
    var context = marker.getContext('2d'),
        halfSize = size / 2,
        radGrad = context.createRadialGradient(halfSize, halfSize, 0, halfSize, halfSize, halfSize);

    for (var ii = 0; ii < stopPoints.length; ii++) {
        var stopVal = stopPoints[ii],
            alpha = 0.4 - (0.4 * Math.sqrt(stopVal));

        radGrad.addColorStop(stopVal, stopFn(stopVal, alpha));
    } // for

    // draw the glow marker
    context.beginPath();
    context.arc(halfSize, halfSize, halfSize, 0, Math.PI * 2, false);
    context.fillStyle = radGrad;              
    context.fill();

    return marker;
} // createGlowMarker

function displayStores(year) {
    sample.year = year;
    sample.markers = storeIndex;

    var store = walmarts[storeIndex];

    if (! store) {
        return;
    } // if

    while (store && year >= parseInt(store.opening_date, 10)) {
        pinStore(store);
        storeIndex += 1;
        store = walmarts[storeIndex];
    } // while
    
    map.invalidate();
    yearTimeout = setTimeout(function() {
        displayStores(year + 1);
    }, 250);
} // displayStores

function pinStore(store) {
    var storePos = new GeoJS.Pos(store.latitude, store.longitude),
        marker = map.layer('markers').create('marker', {
            xy: new T5.GeoXY(storePos),
            markerType: 'image',
            image: glowMarker,
            name: store.name,
            opening_date: store.opening_date,
            size: 20
        });
        
    if (sample.animated) {
        marker.scale(2, {
            easing: 'back.out', 
            duration: 300,
            complete: function() {
                marker.scale(1, {
                    easing: 'sine.out',
                    duration: 300
                }, true);
            }
        });
    } // if
} // pinStore

function run() {
    // reset the run state
    map.layer('markers').clear();
    clearTimeout(yearTimeout);
    storeIndex = 0;
    displayStores(parseInt(walmarts[0].opening_date, 10));
} // reset

// create the glow marker
glowMarker = createGlowMarker(8, function(stopVal, alpha) {
    var hue = ~~(150 + 70 * stopVal),
        saturation = 80 + ~~((1 - stopVal / 1) * 20),
        lightness = 50;

    return hslaFormatter(hue, saturation, lightness, alpha);
});

inactiveMarker = createGlowMarker(8, function(stopVal, alpha) {
    var hue = ~~(50 + 20 * stopVal),
        saturation = 60 + ~~((1 - stopVal / 1) * 20),
        lightness = 50;

    return hslaFormatter(hue, saturation, lightness, alpha);
});

map.center('37.16 -96.68').zoom(4);

setTimeout(run, 50);

/*
// create the ui
var ui = DEMO.makeSampleUI();
ui.gui.add(sample, 'animated');
ui.gui.add(sample, 'year').name('Year').listen();
ui.gui.add(sample, 'markers').name('Marker Count').listen();
ui.gui.add(sample, 'run');
ui.done();
*/

</script>
</body>
</html>
