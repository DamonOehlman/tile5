<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title></title>
  <meta name="description" content="">
  <meta name="author" content="Damon Oehlman">

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="_demogen/js/modernizr-2.0.6.min.js"></script>
</head>

<body>
  
  <style type="text/css">html, body, #mapContainer {
    margin: 0;
    height: 100%;
    width: 100%;
}

body {
    font: 1em Helvetica, Arial;
}

.t5-copyright {
    background: #e8e8e8;
    opacity: 0.4;
    font-size: 0.8em;
    padding: 5px;
}</style>
  
  <div id="mapContainer"></div>


  <!--[if lt IE 7 ]>
    <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

  <script src="_demogen/js/keymaster.min.js"></script>
  <script src="_demogen/js/jquery-1.6.2.min.js"></script>
  <script src="_demogen/js/ace/ace.js"></script>
  <script src="_demogen/js/ace/theme-twilight.js"></script>
  <script src="_demogen/js/ace/mode-javascript.js"></script>
  <script src="_demogen/js/runner.js"></script>
  <script src="../dist/tile5.cloudmade.js"></script>
  
  <script>
  var settings = {"theme":"twilight","mode":"javascript","body":"<div id=\"mapContainer\"></div>"};
  </script>
  <script defer="defer">// create the map
var map = new T5.Map('mapContainer', {
    renderer: settings.renderer || 'canvas',
    drawOnMove: settings.drawOnMove,
    drawOnTween: settings.drawOnTween
});

map.layer('tiles', 'tile', {
    generator: 'osm.cloudmade',
    // demo api key, register for an API key at http://dev.cloudmade.com/
    apikey: '7960daaf55f84bfdb166014d0b9f8d41',
    styleid: settings.mapstyle
});

map.zoom(8).center('-27.469 153.020');

(function() {
    // define constants
    var pdxApiFormatter = T5.formatter('http://pdxapi.com/{0}/geojson?bbox={1},{2},{3},{4}'),
        parser = new T5.GeoJSONParser(),
        MAXDIST = 40;
    
    // initialise variables
    var lastUrl = '',
        seqCounter = 0,
        datasources = {},
        layerZ = 800,
        ui,
        sample = {},
        currentDataset = '';
        
    function defineLayer(dsid, styleId) {
        // add the datasource to the list of datasources
        datasources[dsid] = {
            style: styleId ? styleId : null,
            requestActive: false,
            zindex: layerZ--
        };
        
        // set the datasource active flag to false
        sample[dsid] = false;
        ui.gui.add(sample, dsid).onChange(function(active) {
            toggleLayer(dsid);
        });
    } // defineLayer
    
    function initLayers() {
        // defineLayer('bicycle_network', 'path.bike');
        defineLayer('bridges');
        // defineLayer('business_associations');
        // defineLayer('buslines');
        // defineLayer('council');
        // defineLayer('counties');
        defineLayer('guardrails');
        defineLayer('neighborhoods', 'area.general');
        defineLayer('parks', 'area.parkland');
        // defineLayer('parks_taxlots');
        // defineLayer('parks_trails');
        // defineLayer('pavement_moratorium');
        defineLayer('pedestrian_districts', 'area.general');        
        // defineLayer('schools');
        // defineLayer('redline_1938');
        // defineLayer('zipcode');
    } // initLayers
        
    function retrieveData(dsid, bounds) {
        var requestId, 
            dsUrl = pdxApiFormatter(
                dsid,
                bounds.min.lon,
                bounds.min.lat,
                bounds.max.lon,
                bounds.max.lat
            );
                
        if (datasources[dsid].requestActive) {
            return;
        } // if

        $('#' + dsid + '_title').addClass('loader');
        
        datasources[dsid].requestActive = true;

        $.ajax({
            url: dsUrl,
            dataType: 'jsonp',
            success: function(data) {
                updateData(dsid, data);
            }
        });
        
        lastUrl = dsUrl;
    } // retrieveData
    
    function showMessage(msg, msgClass, autohide) {
        var messageContainer = $('#status');
        
        messageContainer
            .removeClass('error info')
            .html(msg)
            .addClass(msgClass ? msgClass : 'info')
            .slideDown();
        
        if (autohide) {
            setTimeout(function() {
                messageContainer.slideUp();
            }, autohide);
        } // if
    } // showMessage
    
    function toggleLayer(dsid) {
        var layerDetails = datasources[dsid],
            layer = map.layer(dsid);

        if (layer) {
            layer.remove();
        }
        else {
            retrieveData(dsid, map.bounds());
        } // if..else
    } // toggleLayer
    
    function updateData(dsid, data) {
        var layer = map.layer(dsid, 'draw', datasources[dsid]);
        
        // unbind previous handlers
        parser.unbind();
        parser.bind('*', function(evt, data) {
            layer.create(evt.name, data);
        });
        
        for (var ii = data.rows.length; ii--; ) {
            parser.run({
                type: 'Feature',
                geometry: data.rows[ii].geometry
            });
        } // for
    } // updateData
    
    function updateLayers(bounds) {
        for (var dsid in datasources) {
            if (datasources[dsid].enabled) {
                retrieveData(dsid, bounds);
            } // if
        } // for
    } // updateLayers
    
    ui = DEMO.makeSampleUI();
    initLayers();
    ui.done();

	map = new T5.Map('mapContainer', {
		renderer: DEMO.getRenderer()
	});

	// create the tile layer
    map.layer('tiles', 'tile', {
    	generator: 'osm.cloudmade',
        // demo api key, register for an API key at http://dev.cloudmade.com/
        apikey: '7960daaf55f84bfdb166014d0b9f8d41'
    });
    
    map.zoom(15).center('45.52615953236141 -122.67342567443849');
})();

(function() {
    var parser = T5.Registry.create('parser', 'geojson'),
        container = $('#mapContainer')[0];

    map = new T5.Map('mapContainer', {
    	renderer: 'canvas',
    	padding: 'auto'
    });

    map.layer('tiles', 'tile', {
    	generator: 'osm.cloudmade',
        // demo api key, register for an API key at http://dev.cloudmade.com/
        apikey: '7960daaf55f84bfdb166014d0b9f8d41'
    });

    map.center(DEMO.getHomePosition()).zoom(4);
     
    container.addEventListener("dragover", function (evt) {
        evt.preventDefault();
    }, false);

    // Handle dropped image file - only Firefox and Google Chrome
    container.addEventListener("drop", function (evt) {
        var files = evt.dataTransfer.files;
        if (files.length > 0) {
            var file = files[0];
            if (typeof FileReader !== "undefined") {
                var reader = new FileReader();
                // Note: addEventListener doesn't work in Google Chrome for this event
                reader.onload = function (evt) {
                    parser(map, JSON.parse(evt.target.result), function(layers) {
                        for (var key in layers) {
                            layers[key].visible = true;
                        } // for
                        
                        map.invalidate();
                    });
                };
                reader.readAsText(file);
            }
        }
        evt.preventDefault();
    }, false);
})();

</script>
</body>
</html>
