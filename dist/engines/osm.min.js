T5.OSM=function(){var r=Math.PI/180,w=180/Math.PI,q=function(b){b=COG.extend({flipY:false,tileSize:256,tilePath:"{0}/{1}/{2}.png",osmDataAck:true},b);var k=null,m=[],x=b.tilePath,p={buildTileUrl:function(c,a,n,f,g){if(a>=0&&a<f){c=(c%f+f)%f;a=COG.formatStr(x,n,c,g?Math.abs(a-f+1):a);if(k)a=(m.length?COG.formatStr(k.baseUrl,m[c%m.length]):k.baseUrl)+a;return a}},run:function(c,a,n,f){if(c=c.getZoomLevel?c.getZoomLevel():0){var g=2<<c-1,d=b.tileSize,i=Math.PI*2/(d<<c),s=(a.w/d|0)+1,t=(a.h/d|0)+1;a=
T5.GeoXY.toPos(T5.XY.init(a.x,a.y),i);var e=a.lat;a=T5.XY.init((a.lon+180)/360*g|0,(1-Math.log(Math.tan(e*r)+1/Math.cos(e*r))/Math.PI)/2*g%g|0);e=Math.PI-2*Math.PI*a.y/g;var o=a.x/g*360-180;e=new T5.Pos(w*Math.atan(0.5*(Math.exp(e)-Math.exp(-e))),o);i=T5.GeoXY.init(e,i);e=b.flipY;var j=n.search({x:i.x,y:i.y,w:s*d,h:t*d});o={};var h;for(h=j.length;h--;)o[j[h].id]=true;m=(k=p.getServerDetails?p.getServerDetails():null)&&k.subDomains?k.subDomains:[];for(j=0;j<=s;j++)for(h=0;h<=t;h++){var l=a.x+j,u=a.y+
h,v=l+"_"+u;if(!o[v]){tileUrl=p.buildTileUrl(l,u,c,g,e);l=new T5.Tile(i.x+j*d,i.y+h*d,tileUrl,d,d,v);n.insert(l,l)}}f&&f()}}};b.osmDataAck&&T5.userMessage("ack","osm",'Map data (c) <a href="http://openstreetmap.org/" target="_blank">OpenStreetMap</a> (and) contributors, CC-BY-SA');return p};T5.Generator.register("osm.mapbox",function(b){b=COG.extend({style:"world-light",version:"1.0.0",flipY:true},b);T5.userMessage("ack","osm.mapbox",'Tiles Courtesy of <a href="http://mapbox.com/" target="_blank">MapBox</a>');
return COG.extend(new q(b),{getServerDetails:function(){return{baseUrl:COG.formatStr("http://{2}.tile.mapbox.com/{0}/{1}/",b.version,b.style,"{0}"),subDomains:["a","b","c","d"]}}})});T5.Generator.register("osm.mapquest",function(b){T5.userMessage("ack","osm.mapquest",'Tiles Courtesy of <a href="http://open.mapquest.co.uk/" target="_blank">MapQuest</a>');return COG.extend(new q(b),{getServerDetails:function(){return{baseUrl:"http://otile{0}.mqcdn.com/tiles/1.0.0/osm/",subDomains:["1","2","3","4"]}}})});
T5.Generator.register("osm.local",q);return{Generator:q}}();
