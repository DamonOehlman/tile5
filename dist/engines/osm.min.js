T5.Geo.OSM=function(){var r=Math.PI/180,u=180/Math.PI,m=function(b){b=COG.extend({flipY:false,tileSize:256,tilePath:"{0}/{1}/{2}.png",osmDataAck:true},b);var k=null,n=[],v=b.tilePath,q={buildTileUrl:function(c,a,o,g,h){if(a>=0&&a<g){c=(c%g+g)%g;a=COG.formatStr(v,o,c,h?Math.abs(a-g+1):a);if(k)a=(n.length?COG.formatStr(k.baseUrl,n[c%n.length]):k.baseUrl)+a;return a}},run:function(c,a,o,g){if(c=c.getZoomLevel?c.getZoomLevel():0){var h=2<<c-1,d=b.tileSize,j=Math.PI*2/(d<<c),s=(a.w/d|0)+1,t=(a.h/d|0)+
1;a=T5.GeoXY.toPos(T5.XY.init(a.x,a.y),j);var e=a.lat;a=T5.XY.init(Math.floor((a.lon+180)/360*h),Math.floor((1-Math.log(Math.tan(e*r)+1/Math.cos(e*r))/Math.PI)/2*h)%h);e=Math.PI-2*Math.PI*a.y/h;var p=a.x/h*360-180;e=new T5.Pos(u*Math.atan(0.5*(Math.exp(e)-Math.exp(-e))),p);j=T5.GeoXY.init(e,j);e=b.flipY;var i=o.search({x:j.x,y:j.y,w:s*d,h:t*d});p={};var f;for(f=i.length;f--;)p[i[f].id]=true;n=(k=q.getServerDetails?q.getServerDetails():null)&&k.subDomains?k.subDomains:[];for(i=0;i<=s;i++)for(f=0;f<=
t;f++){var l=a.x+i+"_"+(a.y+f);if(!p[l]){tileUrl=q.buildTileUrl(a.x+i,a.y+f,c,h,e);l=new T5.Tile(j.x+i*d,j.y+f*d,tileUrl,d,d,l);o.insert(l,l)}}g&&g()}}};b.osmDataAck&&T5.userMessage("ack","osm",'Map data (c) <a href="http://openstreetmap.org/" target="_blank">OpenStreetMap</a> (and) contributors, CC-BY-SA');return q};T5.Generator.register("osm.cloudmade",function(b){b=COG.extend({apikey:null,styleid:1},b);T5.userMessage("ack","osm.cloudmade",'This product uses the <a href="http://cloudmade.com/" target="_blank">CloudMade</a> APIs, but is not endorsed or certified by CloudMade.');
return COG.extend(new m(b),{getServerDetails:function(){return{baseUrl:COG.formatStr("http://{3}.tile.cloudmade.com/{0}/{1}/{2}/",b.apikey,b.styleid,256,"{0}"),subDomains:["a","b","c"]}}})});T5.Generator.register("osm.mapbox",function(b){b=COG.extend({style:"world-light",version:"1.0.0",flipY:true},b);T5.userMessage("ack","osm.mapbox",'Tiles Courtesy of <a href="http://mapbox.com/" target="_blank">MapBox</a>');return COG.extend(new m(b),{getServerDetails:function(){return{baseUrl:COG.formatStr("http://{2}.tile.mapbox.com/{0}/{1}/",
b.version,b.style,"{0}"),subDomains:["a","b","c","d"]}}})});T5.Generator.register("osm.mapquest",function(b){T5.userMessage("ack","osm.mapquest",'Tiles Courtesy of <a href="http://open.mapquest.co.uk/" target="_blank">MapQuest</a>');return COG.extend(new m(b),{getServerDetails:function(){return{baseUrl:"http://otile{0}.mqcdn.com/tiles/1.0.0/osm/",subDomains:["1","2","3","4"]}}})});T5.Generator.register("osm.local",m);return{Generator:m}}();
