COG=typeof COG!=="undefined"?COG:{};COG.extend=function(){for(var q=arguments[0]||{},r,u=1,p=arguments.length;u<p;u++)if((r=arguments[u])!==null)for(var f in r){var e=r[f];if(q!==e)if(e!==undefined)q[f]=e}return q};
(function(){var q=/^P(\d+Y)?(\d+M)?(\d+D)?$/,r=/^(\d+H)?(\d+M)?(\d+S)?$/,u={8601:function(f){f=f.split("T");var e=null;e=null;var l=0,n=0;q.lastIndex=-1;e=q.exec(f[0]);l+=e[3]?parseInt(e[3].slice(0,-1),10):0;r.lastIndex=-1;e=r.exec(f[1]);n+=e[1]?parseInt(e[1].slice(0,-1),10)*3600:0;n+=e[2]?parseInt(e[2].slice(0,-1),10)*60:0;n+=e[3]?parseInt(e[3].slice(0,-1),10):0;return new p(l,n)}},p=COG.Duration=function(f,e){return{days:f?f:0,seconds:e?e:0}};COG.addDuration=function(){for(var f=new p,e=arguments.length;e--;){f.days+=
arguments[e].days;f.seconds+=arguments[e].seconds}if(f.seconds>=86400){f.days+=~~(f.seconds/86400);f.seconds%=86400}return f};COG.formatDuration=function(f){var e,l,n="";if(f.days)n=f.days+" days ";if(f.seconds){f=f.seconds;if(f>=3600){e=~~(f/3600);f-=e*3600}if(f>=60){l=Math.round(f/60);f-=l*60}if(e)n=n+e+(e>1?" hrs ":" hr ")+(l?(l>10?l:"0"+l)+" min ":"");else if(l)n=n+l+" min";else if(f>0)n=n+(f>10?f:"0"+f)+" sec"}return n};COG.parseDuration=function(f,e){var l=e?u[e]:null;if(l)return l(f);COG.Log.warn("Could not find duration parser for specified format: "+
e);return new p}})();
T5.Geo.Decarta=function(){function q(a){return COG.formatStr("<xls:XLS version='1' xls:lang='en' xmlns:xls='http://www.opengis.net/xls' rel='{4}' xmlns:gml='http://www.opengis.net/gml'><xls:RequestHeader clientName='{0}' clientPassword='{1}' sessionID='{2}' configuration='{3}' />{5}</xls:XLS>",e.clientName,e.clientPassword,e.sessionID,e.configuration,e.release,a)}function r(a,d){return COG.formatStr("<xls:Request maximumResponses='{0}' version='{1}' requestID='{2}' methodName='{3}Request'>{4}</xls:Request>",a.maxResponses,
a.version,a.requestID,a.methodName,d)}function u(a,d){e.server||COG.warn("No server configured for deCarta - we are going to have issues");return COG.formatStr("{0}/JSON?reqID={1}&chunkNo=1&numChunks=1&data={2}&responseFormat=JSON",e.server,a.requestID,escape(d))}function p(a,d){COG.jsonp(u(a,q(r(a,a.getRequestBody()))),function(b){var c=b.response.XLS.Response;if(c.numberOfResponses>0&&c[a.methodName+"Response"]){b=null;if(a.parseResponse)b=a.parseResponse(c[a.methodName+"Response"]);d&&d(b)}else COG.error("no responses from server: "+
b.response)})}function f(a,d){var b=new z.Street({json:a.StreetAddress}),c=new z.Place({countryCode:a.countryCode});c.parse(a.Place);return new T5.Geo.Address({streetDetails:b,location:c,country:a.countryCode?a.countryCode:"",postalCode:a.PostalCode?a.PostalCode:"",pos:d})}var e={sessionID:T5.ticks(),server:"",clientName:"",clientPassword:"",configuration:"",maxResponses:25,release:"4.4.2sp03",tileFormat:"PNG",fixedGrid:true,useCache:true,tileHosts:[],requestTimeout:3E4,geocoding:{countryCode:"US",
language:"EN"}},l={DEFAULT:function(a){for(var d=["landmark","municipalitySubdivision","municipality","countrySubdivision"],b="",c=0;c<d.length;c++)if(a[d[c]])b+=a[d[c]]+" ";return b}},n=1,z={Address:function(a){a=COG.extend({countryCode:e.geocoding.countryCode,language:e.geocoding.language,freeform:null,streetAddress:{building:null}},a);return{getXML:function(){var d=COG.formatStr('<xls:Address countryCode="{0}" language="{1}">',a.countryCode,a.language);if(a.freeform){var b=String(a.freeform).replace(/(\'|\")/,
"\\$1");d+="<xls:freeFormAddress>"+b+"</xls:freeFormAddress>"}return d+"</xls:Address>"}}},Place:function(a){a=COG.extend({landmark:"",municipality:"",municipalitySubdivision:"",countrySubdivision:"",countryCode:""},a);var d=COG.extend({calcMatchPercentage:function(b){var c=0;if(a.landmark&&a.landmarkSubType){if(COG.wordExists(b,a.landmarkSubType)){c+=0.4;c+=COG.wordExists(b,a.landmark)?0.6:0}}else{c+=COG.wordExists(b,a.municipalitySubdivision)?0.8:0;if(c===0&&a.municipality)c+=COG.wordExists(b,a.municipality)?
0.7:0}if(a.countrySubdivision)c+=COG.wordExists(b,a.countrySubdivision)?0.2:0;return c},getCountryCode:function(){if(a.countryCode)return a.countryCode.toUpperCase();return""},parse:function(b){for(var c=0;b&&c<b.length;c++){var h=b[c].type?b[c].type.slice(0,1).toLowerCase()+b[c].type.slice(1):"";if(typeof a[h]!=="undefined"){a[h]=b[c].content;if(b[c].subType)a[h+"SubType"]=b[c].subType}}COG.extend(d,a)},toString:function(){var b=l[d.getCountryCode()];if(!b)b=l.DEFAULT;return b(a)}},a);return d},
Street:function(a){a=COG.extend({json:{}},a);var d="",b="";if(a.json.Street)d=a.json.Street.content?a.json.Street.content:a.json.Street;d=d&&d.replace?d.replace(/\/\d+$/,""):"";if(a.json.Building)if(a.json.Building.number)b=a.json.Building.number;return{building:b,street:d,calcMatchPercentage:function(c){var h=0,g=T5.Geo.A.normalize(c),m=T5.Geo.A.normalize(d);if(a.json.Building)if(T5.Geo.A.buildingMatch(c,a.json.Building.number.toString()))h+=0.2;if(g&&m&&COG.wordExists(g,m))h+=0.8;return h},toString:function(){if(d)return(b?
b+" ":"")+d;return""}}},CenterContext:function(a){return{centerPos:new T5.Pos(a.CenterPoint?a.CenterPoint.pos.content:""),radius:new T5.Geo.Radius(a.Radius?a.Radius.content:0,a.Radius?a.Radius.unit:null)}}},w=function(){return{methodName:"",maxResponses:25,version:"1.0",requestID:n++,getRequestBody:function(){return""},parseResponse:function(a){return a}}},E=function(){return COG.extend(new w,{methodName:"RUOK",parseResponse:function(a){return{aliasCount:a.maxHostAliases,host:a.hostName}}})},F=function(a){function d(c){var h=
[],g=c?c.numberOfGeocodedAddresses:0,m=[];if(g>1)m=c.GeocodedAddress;else if(g==1)m=[c.GeocodedAddress];try{for(c=0;m&&c<m.length;c++){var o,i=m[c],j=g=null;if(i&&i.GeocodeMatchCode&&i.GeocodeMatchCode.matchType!=="NO_MATCH"){if(i&&i.Point)j=new T5.Pos(i.Point.pos);if(i&&i.Address)g=f(i.Address,j)}(o=g)&&h.push(o)}}catch(k){COG.exception(k)}return h}a=COG.extend({addresses:[],parserReport:false,parseOnly:false,returnSpatialKeys:false},a);var b=new w;return COG.extend({},b,{methodName:"Geocode",getRequestBody:function(){for(var c=
COG.formatStr('<xls:GeocodeRequest parserReport="{0}" parseOnly="{1}" returnSpatialKeys="{2}">',a.parserReport,a.parseOnly,a.returnSpatialKeys),h=0;h<a.addresses.length;h++)c+=a.addresses[h].getXML();return c+"</xls:GeocodeRequest>"},parseResponse:function(c){if(a.addresses.length===1)return[d(c.GeocodeResponseList)];else{for(var h=[],g=0;g<a.addresses.length;g++)h.push(d(c.GeocodeResponseList[g]));return h}}})},G=function(a){a=COG.extend({position:null,geocodePreference:"StreetAddress"},a);return COG.extend(new w,
{methodName:"ReverseGeocode",getRequestBody:function(){return"<xls:ReverseGeocodeRequest><xls:Position><gml:Point><gml:pos>"+a.position.toString()+"</gml:pos></gml:Point></xls:Position><xls:ReverseGeocodePreference>"+a.geocodePreference+"</xls:ReverseGeocodePreference></xls:ReverseGeocodeRequest>"},parseResponse:function(d){var b=null;if(d&&d.Point)b=new T5.Pos(match.Point.pos);if(d&&d.ReverseGeocodedLocation&&d.ReverseGeocodedLocation.Address)return f(d.ReverseGeocodedLocation.Address,b);return null}})},
H=function(a){a=COG.extend({waypoints:[],provideRouteHandle:false,distanceUnit:"KM",routeQueryType:"RMAN",routePreference:"Fastest",routeInstructions:true,routeGeometry:true},a);var d=new w;return COG.extend({},d,{methodName:"DetermineRoute",getRequestBody:function(){if(a.waypoints.length<2)throw Error("Cannot send RouteRequest, less than 2 waypoints specified");var b=COG.formatStr('<xls:DetermineRouteRequest provideRouteHandle="{0}" distanceUnit="{1}" routeQueryType="{2}">',a.provideRouteHandle,
a.distanceUnit,a.routeQueryType);b+="<xls:RoutePlan>";b+="<xls:RoutePreference>"+a.routePreference+"</xls:RoutePreference>";b+="<xls:WayPointList>";for(var c=0;c<a.waypoints.length;c++)b+=COG.formatStr("<xls:{0}><xls:Position><gml:Point><gml:pos>{1}</gml:pos></gml:Point></xls:Position></xls:{0}>",c===0?"StartPoint":c===a.waypoints.length-1?"EndPoint":"ViaPoint",a.waypoints[c].toString());b+="</xls:WayPointList>";b+="</xls:RoutePlan>";if(a.routeInstructions)b+='<xls:RouteInstructionsRequest rules="maneuver-rules" providePoint="true" />';
if(a.routeGeometry)b+="<xls:RouteGeometryRequest />";b+="</xls:DetermineRouteRequest>";return b},parseResponse:function(b){var c=T5.RouteTools.RouteData,h=T5.Geo.Position.parseArray(b.RouteGeometry.LineString.pos),g=b.RouteInstructionsList;b=[];g=g&&g.RouteInstruction?g.RouteInstruction:[];for(var m=0,o=new COG.Duration,i=0;i<g.length;i++){var j;j=g[i].distance;var k={M:1,KM:1E3}[j.uom?j.uom.toUpperCase():"M"];j=j.value&&k?j.value*k:0;k=COG.parseDuration(g[i].duration,"8601");m+=j;o=COG.addDuration(o,
k);b.push(new T5.RouteTools.Instruction({position:new T5.Pos(g[i].Point),description:g[i].Instruction,distance:j,distanceTotal:m,time:k,timeTotal:o}))}return new c({geometry:h,instructions:b})}})},x={applyConfig:function(a){COG.extend(e,a)},calculateRoute:function(a,d){a=COG.extend({waypoints:[]},a);if(typeof T5.RouteTools!=="undefined"){var b=new H(a);p(b,function(c){d&&d(c)})}else COG.warn("Could not generate route, T5.RouteTools plugin not found")},geocode:function(a){a=COG.extend({addresses:[],
complete:null},a);var d,b=[];if(a.addresses&&!COG.isArray(a.addresses))a.addresses=[a.addresses];for(d=0;d<a.addresses.length;d++)COG.isPlainObject(a.addresses[d])?COG.warn("attempting to geocode a simple object - not implemented"):b.push(new z.Address({freeform:a.addresses[d]}));if(b.length>0){b=new F({addresses:b});p(b,function(c){if(a.complete)for(d=0;d<c.length;d++)a.complete(a.addresses[d],c[d])})}},reverseGeocode:function(a){a=COG.extend({position:null,complete:null},a);if(!a.position)throw Error("Cannot reverse geocode without a position");
var d=new G(a);p(d,function(b){a.complete&&a.complete(b)})}};T5.Generator.register("decarta",function(a){function d(h,g,m,o){if(h=h.getZoomLevel?h.getZoomLevel():0){var i=2<<h-1,j=i>>1,k=a.tileSize,B=(g.w/k|0)+1,y=(g.h/k|0)+1,A=(g.x/k|0)-j;g=i-(g.y/k|0)-j-y;var s=m.search({x:(j+A)*k,y:(j+g*-1-y)*k,w:B*k,h:y*k});i={};var t;for(t=s.length;t--;)i[s[t].id]=true;for(s=0;s<=B;s++)for(t=0;t<=y;t++){var v=A+s,C=g+t-1,D=v+"_"+C;if(!i[D]){v=new T5.Tile((j+A+s)*k,(j+g*-1-t)*k,c[s%c.length]+"/openls/image-cache/TILE?LLMIN=0.0,0.0&LLMAX="+
b[h]+"&CACHEABLE=true&DS=navteq-world&WIDTH=256&HEIGHT=256&CLIENTNAME="+e.clientName+"&SESSIONID="+e.sessionID+"&FORMAT=PNG&CONFIG="+e.configuration+"&N="+C+"&E="+v,k,k,D);m.insert(v,v)}}o&&o()}}a=COG.extend({tileSize:256},a);var b=["89.787438015348100000,360.00000000000000000","85.084059050110410000,180.00000000000000000","66.653475896509040000,90.00000000000000000","41.170427238429790000,45.000000000000000000","22.076741328793200000,22.500000000000000000","11.251819676168665000,11.250000000000000000",
"5.653589942659626000,5.625000000000000000","2.830287664051185000,2.812500000000000000","1.415581451872543800,1.406250000000000000","0.707845460801532700,0.703125000000000000","0.353929573271679340,0.351562500000000000","0.176965641673330230,0.175781250000000000","0.088482927761462040,0.087890625000000000","0.044241477246363230,0.043945312500000000","0.022120740293895182,0.021972656250000000","0.011060370355776452,0.010986328125000000","0.005530185203987857,0.005493164062500000","0.002765092605263539,0.002746582031250000",
"0.001382546303032519,0.001373291015625000","0.000691272945568983,0.000686645507812500","0.000345636472797214,0.000343322753906250"],c=null;T5.userMessage("ack","decarta","&copy; deCarta, Inc. Map and Imagery Data &copy; NAVTEQ or Tele Atlas or DigitalGlobe");return{run:function(h,g,m,o){c?d(h,g,m,o):p(new E,function(i){c=[];if(i.aliasCount)for(var j=0;j<i.aliasCount;j++)c[j]="http://"+i.host.replace("^(.*?).(.*)$","\u0001-0"+(j+1)+".\u0002");else c=["http://"+i.host];d(h,g,m,o)})}}});new T5.Geo.Engine({id:"decarta",
route:x.calculateRoute,geocode:x.geocode,reverseGeocode:x.reverseGeocode,compareFns:function(){return{streetDetails:function(a,d){return d.calcMatchPercentage(a)},location:function(a,d){return d.calcMatchPercentage(a)}}}()});return x}();
