COG=typeof COG!=="undefined"?COG:{};COG.extend=function(){for(var t=arguments[0]||{},u,x=1,s=arguments.length;x<s;x++)if((u=arguments[x])!==null)for(var f in u){var e=u[f];if(t!==e)if(e!==undefined)t[f]=e}return t};
(function(){var t=/^P(\d+Y)?(\d+M)?(\d+D)?$/,u=/^(\d+H)?(\d+M)?(\d+S)?$/,x={8601:function(f){f=f.split("T");var e=null;e=null;var n=0,q=0;t.lastIndex=-1;e=t.exec(f[0]);n+=e[3]?parseInt(e[3].slice(0,-1),10):0;u.lastIndex=-1;e=u.exec(f[1]);q+=e[1]?parseInt(e[1].slice(0,-1),10)*3600:0;q+=e[2]?parseInt(e[2].slice(0,-1),10)*60:0;q+=e[3]?parseInt(e[3].slice(0,-1),10):0;return new s(n,q)}},s=COG.Duration=function(f,e){return{days:f?f:0,seconds:e?e:0}};COG.addDuration=function(){for(var f=new s,e=arguments.length;e--;){f.days+=
arguments[e].days;f.seconds+=arguments[e].seconds}if(f.seconds>=86400){f.days+=~~(f.seconds/86400);f.seconds%=86400}return f};COG.formatDuration=function(f){var e,n,q="";if(f.days)q=f.days+" days ";if(f.seconds){f=f.seconds;if(f>=3600){e=~~(f/3600);f-=e*3600}if(f>=60){n=Math.round(f/60);f-=n*60}if(e)q=q+e+(e>1?" hrs ":" hr ")+(n?(n>10?n:"0"+n)+" min ":"");else if(n)q=q+n+" min";else if(f>0)q=q+(f>10?f:"0"+f)+" sec"}return q};COG.parseDuration=function(f,e){var n=e?x[e]:null;if(n)return n(f);COG.Log.warn("Could not find duration parser for specified format: "+
e);return new s}})();
T5.Decarta=function(){function t(a){return C(e.clientName,e.clientPassword,e.sessionID,e.configuration,e.release,a)}function u(a,d){return D(a.maxResponses,a.version,a.requestID,a.methodName,d)}function x(a,d){e.server||_log("No server configured for deCarta - we are going to have issues","warn");return E(e.server,a.requestID,escape(d))}function s(a,d){_jsonp(x(a,t(u(a,a.getRequestBody()))),function(b){var c=b.response.XLS.Response;if(c.numberOfResponses>0&&c[a.methodName+"Response"]){b=null;if(a.parseResponse)b=
a.parseResponse(c[a.methodName+"Response"]);d&&d(b)}else _log("no responses from server: "+b.response,"error")})}function f(a,d){var b=new F({json:a.StreetAddress}),c=new G({countryCode:a.countryCode});c.parse(a.Place);return new T5.Geo.Address({streetDetails:b,location:c,country:a.countryCode?a.countryCode:"",postalCode:a.PostalCode?a.PostalCode:"",pos:d})}var e={sessionID:T5.ticks(),server:"",clientName:"",clientPassword:"",configuration:"",maxResponses:25,release:"4.4.2sp03",tileFormat:"PNG",fixedGrid:true,
useCache:true,tileHosts:[],requestTimeout:3E4,geocoding:{countryCode:"US",language:"EN"}},n={DEFAULT:function(a){for(var d=["landmark","municipalitySubdivision","municipality","countrySubdivision"],b="",c=0;c<d.length;c++)if(a[d[c]])b+=a[d[c]]+" ";return b}},q=1,C=_formatter("<xls:XLS version='1' xls:lang='en' xmlns:xls='http://www.opengis.net/xls' rel='{4}' xmlns:gml='http://www.opengis.net/gml'><xls:RequestHeader clientName='{0}' clientPassword='{1}' sessionID='{2}' configuration='{3}' />{5}</xls:XLS>"),
D=_formatter("<xls:Request maximumResponses='{0}' version='{1}' requestID='{2}' methodName='{3}Request'>{4}</xls:Request>"),E=_formatter("{0}/JSON?reqID={1}&chunkNo=1&numChunks=1&data={2}&responseFormat=JSON"),G=function(a){a=T5.ex({landmark:"",municipality:"",municipalitySubdivision:"",countrySubdivision:"",countryCode:""},a);var d=T5.ex({calcMatchPercentage:function(b){var c=0;if(a.landmark&&a.landmarkSubType){if(T5.wordExists(b,a.landmarkSubType)){c+=0.4;c+=T5.wordExists(b,a.landmark)?0.6:0}}else{c+=
T5.wordExists(b,a.municipalitySubdivision)?0.8:0;if(c===0&&a.municipality)c+=T5.wordExists(b,a.municipality)?0.7:0}if(a.countrySubdivision)c+=T5.wordExists(b,a.countrySubdivision)?0.2:0;return c},getCountryCode:function(){if(a.countryCode)return a.countryCode.toUpperCase();return""},parse:function(b){for(var c=0;b&&c<b.length;c++){var h=b[c].type?b[c].type.slice(0,1).toLowerCase()+b[c].type.slice(1):"";if(typeof a[h]!=="undefined"){a[h]=b[c].content;if(b[c].subType)a[h+"SubType"]=b[c].subType}}T5.ex(d,
a)},toString:function(){var b=n[d.getCountryCode()];if(!b)b=n.DEFAULT;return b(a)}},a);return d},F=function(a){a=T5.ex({json:{}},a);var d="",b="";if(a.json.Street)d=a.json.Street.content?a.json.Street.content:a.json.Street;d=d&&d.replace?d.replace(/\/\d+$/,""):"";if(a.json.Building)if(a.json.Building.number)b=a.json.Building.number;return{building:b,street:d,calcMatchPercentage:function(c){var h=0,g=T5.Geo.A.normalize(c),i=T5.Geo.A.normalize(d);if(a.json.Building)if(T5.Geo.A.buildingMatch(c,a.json.Building.number.toString()))h+=
0.2;if(g&&i&&T5.wordExists(g,i))h+=0.8;return h},toString:function(){if(d)return(b?b+" ":"")+d;return""}}},z=function(){return{methodName:"",maxResponses:25,version:"1.0",requestID:q++,getRequestBody:function(){return""},parseResponse:function(a){return a}}},H=function(){return T5.ex(new z,{methodName:"RUOK",parseResponse:function(a){return{aliasCount:a.maxHostAliases,host:a.hostName}}})};T5.Registry.register("generator","decarta",function(a){function d(h,g,i,o){if(h=h.zoomlevel?h.zoomlevel():0){var j=
2<<h-1,k=j>>1,l=a.tileSize,m=(g.w/l|0)+1,p=(g.h/l|0)+1,r=(g.x/l|0)-k;g=j-(g.y/l|0)-k-p;var v=i.search({x:(k+r)*l,y:(k+g*-1-p)*l,w:m*l,h:p*l});j={};var w;for(w=v.length;w--;)j[v[w].id]=true;for(v=0;v<=m;v++)for(w=0;w<=p;w++){var y=r+v,A=g+w-1,B=y+"_"+A;if(!j[B]){y=new T5.Tile((k+r+v)*l,(k+g*-1-w)*l,c[v%c.length]+"/openls/image-cache/TILE?LLMIN=0.0,0.0&LLMAX="+b[h]+"&CACHEABLE=true&DS=navteq-world&WIDTH=256&HEIGHT=256&CLIENTNAME="+e.clientName+"&SESSIONID="+e.sessionID+"&FORMAT=PNG&CONFIG="+e.configuration+
"&N="+A+"&E="+y,l,l,B);i.insert(y,y)}}o&&o()}}a=T5.ex({tileSize:256},a);var b=["89.787438015348100000,360.00000000000000000","85.084059050110410000,180.00000000000000000","66.653475896509040000,90.00000000000000000","41.170427238429790000,45.000000000000000000","22.076741328793200000,22.500000000000000000","11.251819676168665000,11.250000000000000000","5.653589942659626000,5.625000000000000000","2.830287664051185000,2.812500000000000000","1.415581451872543800,1.406250000000000000","0.707845460801532700,0.703125000000000000",
"0.353929573271679340,0.351562500000000000","0.176965641673330230,0.175781250000000000","0.088482927761462040,0.087890625000000000","0.044241477246363230,0.043945312500000000","0.022120740293895182,0.021972656250000000","0.011060370355776452,0.010986328125000000","0.005530185203987857,0.005493164062500000","0.002765092605263539,0.002746582031250000","0.001382546303032519,0.001373291015625000","0.000691272945568983,0.000686645507812500","0.000345636472797214,0.000343322753906250"],c=null;T5.userMessage("ack",
"decarta","&copy; deCarta, Inc. Map and Imagery Data &copy; NAVTEQ or Tele Atlas or DigitalGlobe");return{run:function(h,g,i,o){c?d(h,g,i,o):s(new H,function(j){c=[];if(j.aliasCount)for(var k=0;k<j.aliasCount;k++)c[k]="http://"+j.host.replace("^(.*?).(.*)$","\u0001-0"+(k+1)+".\u0002");else c=["http://"+j.host];d(h,g,i,o)})}}});T5.Service.register("geocoder",function(){var a=function(b){function c(i){var o=[],j=i?i.numberOfGeocodedAddresses:0,k=[];if(j>1)k=i.GeocodedAddress;else if(j==1)k=[i.GeocodedAddress];
try{for(i=0;k&&i<k.length;i++){var l,m=k[i],p=j=null;if(m&&m.GeocodeMatchCode&&m.GeocodeMatchCode.matchType!=="NO_MATCH"){if(m&&m.Point)p=new T5.Pos(m.Point.pos);if(m&&m.Address)j=f(m.Address,p)}(l=j)&&o.push(l)}}catch(r){_log(r,"error")}return o}b=T5.ex({addresses:[],parserReport:false,parseOnly:false,returnSpatialKeys:false},b);var h=_formatter('<xls:GeocodeRequest parserReport="{0}" parseOnly="{1}" returnSpatialKeys="{2}">'),g=new z;return T5.ex({},g,{methodName:"Geocode",getRequestBody:function(){for(var i=
h(b.parserReport,b.parseOnly,b.returnSpatialKeys),o=0;o<b.addresses.length;o++)i+=b.addresses[o].getXML();return i+"</xls:GeocodeRequest>"},parseResponse:function(i){if(b.addresses.length===1)return[c(i.GeocodeResponseList)];else{for(var o=[],j=0;j<b.addresses.length;j++)o.push(c(i.GeocodeResponseList[j]));return o}}})},d=function(b){b=T5.ex({position:null,geocodePreference:"StreetAddress"},b);return T5.ex(new z,{methodName:"ReverseGeocode",getRequestBody:function(){return"<xls:ReverseGeocodeRequest><xls:Position><gml:Point><gml:pos>"+
b.position.toString()+"</gml:pos></gml:Point></xls:Position><xls:ReverseGeocodePreference>"+b.geocodePreference+"</xls:ReverseGeocodePreference></xls:ReverseGeocodeRequest>"},parseResponse:function(c){var h=null;if(c&&c.Point)h=new T5.Pos(match.Point.pos);if(c&&c.ReverseGeocodedLocation&&c.ReverseGeocodedLocation.Address)return f(c.ReverseGeocodedLocation.Address,h);return null}})};return{forward:function(b){b=T5.ex({addresses:[],complete:null},b);var c,h=[];if(b.addresses&&!T5.is(b.addresses,"array"))b.addresses=
[b.addresses];for(c=0;c<b.addresses.length;c++)T5.is(b.addresses[c],"object")?_log("attempting to geocode a simple object - not implemented","warn"):h.push(new types.Address({freeform:b.addresses[c]}));if(h.length>0){h=new a({addresses:h});s(h,function(g){if(b.complete)for(c=0;c<g.length;c++)b.complete(b.addresses[c],g[c])})}},reverse:function(b){b=T5.ex({position:null,complete:null},b);if(!b.position)throw Error("Cannot reverse geocode without a position");var c=new d(b);s(c,function(h){b.complete&&
b.complete(h)})}}});T5.Service.register("routing",function(){var a=function(d){d=T5.ex({waypoints:[],provideRouteHandle:false,distanceUnit:"KM",routeQueryType:"RMAN",routePreference:"Fastest",routeInstructions:true,routeGeometry:true},d);var b=new z,c=_formatter('<xls:DetermineRouteRequest provideRouteHandle="{0}" distanceUnit="{1}" routeQueryType="{2}">'),h=_formatter("<xls:{0}><xls:Position><gml:Point><gml:pos>{1}</gml:pos></gml:Point></xls:Position></xls:{0}>");return T5.ex({},b,{methodName:"DetermineRoute",
getRequestBody:function(){if(d.waypoints.length<2)throw Error("Cannot send RouteRequest, less than 2 waypoints specified");var g=c(d.provideRouteHandle,d.distanceUnit,d.routeQueryType);g+="<xls:RoutePlan>";g+="<xls:RoutePreference>"+d.routePreference+"</xls:RoutePreference>";g+="<xls:WayPointList>";for(var i=0;i<d.waypoints.length;i++)g+=h(i===0?"StartPoint":i===d.waypoints.length-1?"EndPoint":"ViaPoint",d.waypoints[i].toString());g+="</xls:WayPointList>";g+="</xls:RoutePlan>";if(d.routeInstructions)g+=
'<xls:RouteInstructionsRequest rules="maneuver-rules" providePoint="true" />';if(d.routeGeometry)g+="<xls:RouteGeometryRequest />";g+="</xls:DetermineRouteRequest>";return g},parseResponse:function(g){var i=T5.RouteTools.RouteData,o=T5.Geo.Position.parseArray(g.RouteGeometry.LineString.pos),j=g.RouteInstructionsList;g=[];j=j&&j.RouteInstruction?j.RouteInstruction:[];for(var k=0,l=new COG.Duration,m=0;m<j.length;m++){var p;p=j[m].distance;var r={M:1,KM:1E3}[p.uom?p.uom.toUpperCase():"M"];p=p.value&&
r?p.value*r:0;r=COG.parseDuration(j[m].duration,"8601");k+=p;l=COG.addDuration(l,r);g.push(new T5.RouteTools.Instruction({position:new T5.Pos(j[m].Point),description:j[m].Instruction,distance:p,distanceTotal:k,time:r,timeTotal:l}))}return new i({geometry:o,instructions:g})}})};return{calculate:function(d,b){d=T5.ex({waypoints:[]},d);if(typeof T5.RouteTools!=="undefined"){var c=new a(d);s(c,function(h){b&&b(h)})}else _log("Could not generate route, T5.RouteTools plugin not found","warn")}}});return{applyConfig:function(a){T5.ex(e,
a)},compareFns:function(){return{streetDetails:function(a,d){return d.calcMatchPercentage(a)},location:function(a,d){return d.calcMatchPercentage(a)}}}()}}();
