T5.Clusterer=function(e,m){function w(c){function g(){for(var f=0,h=arguments.length;h--;)f+=arguments[h];return f/arguments.length|0}for(var b=[],d=[],a=c.length;a--;){b[a]=c[a].xy.x;d[a]=c[a].xy.y}return new T5.XY(g.apply(null,b),g.apply(null,d))}function r(c){for(var g=e.layer(),b=g.length;b--;){var d=g[b];c=c||d.id.indexOf(n)<0&&d.itemCount&&d.itemCount!==o[d.id]}if(c){c=e.layer();_log("checking for clusters");for(g=c.length;g--;){b=c[g];if(!T5.is(b.itemCount,"undefined")){d=s(b,true);b.visible=
!d}o[b.id]=b.itemCount}}}function x(c,g,b){if(b-t>=y){r();t=b}}function u(c,g,b){delete j[n+b.id];r(true)}function z(){for(var c in j)e.removeLayer(c);o={};j={}}function s(c,g){var b=c.find({typeName:"Marker"}),d={},a;for(a=b.length;a--;){var f=b[a].xy;f=(f.x/q|0)+"_"+(f.y/q|0);var h=d[f];h||(h=d[f]=[]);h[h.length]=b[a]}a=false;for(var i in d)a=a||d[i].length>1;b=n+c.id;i=g?j[b]:null;if(a)if(i){d=i;var k=c.find({typeName:"Marker"});for(b=k.length;b--;)if(!k[b].cluster){a=d.find();f=null;h=Infinity;
for(var p=a.length;p--;){var l=void 0-a[p].xy.x,v=void 0-a[p].xy.y;l=Math.sqrt(l*l+v*v);if(l<h){f=a[p];h=l}}a=h<=q?f:null;if(!a){a=new T5.Marker(_extend({},k[b],{children:[]}));d.add(a)}a.children.push(k[b]);a.size+=1;k[b].cluster=a}}else{i=j[b]=new T5.DrawLayer({id:b});for(k in d){a=d[k];f=w(a,e||c.view);f=new T5.Marker(_extend({},a[0],{xy:f,size:a[0].size+a.length,children:a}));for(h=a.length;h--;)a[h].cluster=f;i.add(f)}i=i;if(e){e.setLayer(b,i);e.invalidate()}}else if(i){delete j[b];if(e){e.removeLayer(b);
e.invalidate()}}return i}m=_extend({dist:32,checkInterval:100},m);var n="cluster_",t=0,y=m.checkInterval,o={},j={},q=m.dist;if(e){e.bind("drawComplete",x);e.bind("layerChange",u);e.bind("layerRemove",u);e.bind("zoom",z)}return{checkLayer:s,uncluster:function(){o={};for(var c in j){var g=e.getLayer(c.slice(n.length));if(g)g.visible=true;e.removeLayer(c)}e.invalidate()}}};
