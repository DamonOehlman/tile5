T5.Clusterer=function(d,m){function w(b,g){function c(){for(var i=0,j=arguments.length;j--;)i+=arguments[j];return i/arguments.length|0}for(var h=[],a=[],f=false,e=b.length;e--;){h[e]=b[e].xy.x;a[e]=b[e].xy.y;f=f||b[e].xy.mercXY}h=T5.XY.init(c.apply(null,h),c.apply(null,a));f&&g&&g.syncXY([h],true);return h}function x(){_log("checking for clusters");d.eachLayer(function(b){if(!T5.is(b.itemCount,"undefined")){var g=r(b,true);b.visible=!g}n[b.id]=b.itemCount})}function s(b){d.eachLayer(function(g){b=
b||g.id.indexOf(o)<0&&g.itemCount&&g.itemCount!==n[g.id]});b&&x()}function y(b,g,c){if(c-t>=z){s();t=c}}function u(b,g,c){delete k[o+c.id];s(true)}function A(){for(var b in k)d.removeLayer(b);n={};k={}}function r(b,g){var c=b.find({typeName:"Marker"}),h={},a;for(a=c.length;a--;){var f=c[a].xy;f=(f.x/q|0)+"_"+(f.y/q|0);var e=h[f];e||(e=h[f]=[]);e[e.length]=c[a]}a=false;for(var i in h)a=a||h[i].length>1;c=o+b.id;i=g?k[c]:null;if(a)if(i){h=i;var j=b.find({typeName:"Marker"});for(c=j.length;c--;)if(!j[c].cluster){a=
h.find();f=null;e=Infinity;for(var p=a.length;p--;){var l=void 0-a[p].xy.x,v=void 0-a[p].xy.y;l=Math.sqrt(l*l+v*v);if(l<e){f=a[p];e=l}}a=e<=q?f:null;if(!a){a=new T5.Marker(_extend({},j[c],{children:[]}));h.add(a)}a.children.push(j[c]);a.size+=1;j[c].cluster=a}}else{i=k[c]=new T5.DrawLayer({id:c});for(j in h){a=h[j];f=w(a,d||b.view);f=new T5.Marker(_extend({},a[0],{xy:f,size:a[0].size+a.length,children:a}));for(e=a.length;e--;)a[e].cluster=f;i.add(f)}i=i;if(d){d.setLayer(c,i);d.invalidate()}}else if(i){delete k[c];
if(d){d.removeLayer(c);d.invalidate()}}return i}m=_extend({dist:32,checkInterval:100},m);var o="cluster_",t=0,z=m.checkInterval,n={},k={},q=m.dist;if(d){d.bind("drawComplete",y);d.bind("layerChange",u);d.bind("layerRemove",u);d.bind("zoomLevelChange",A)}return{checkLayer:r,uncluster:function(){n={};for(var b in k){var g=d.getLayer(b.slice(o.length));if(g)g.visible=true;d.removeLayer(b)}d.invalidate()}}};
