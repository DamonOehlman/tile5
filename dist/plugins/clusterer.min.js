T5.Clusterer=function(d,l){function u(b,a){function f(){for(var i=0,j=arguments.length;j--;)i+=arguments[j];return i/arguments.length|0}for(var c=[],g=[],h=false,e=b.length;e--;){c[e]=b[e].xy.x;g[e]=b[e].xy.y;h=h||b[e].xy.mercXY}c=T5.XY.init(f.apply(null,c),f.apply(null,g));h&&a&&a.syncXY([c],true);return c}function v(){COG.info("checking for clusters");d.eachLayer(function(b){if(!T5.is(b.itemCount,"undefined")){var a=p(b);b.visible=!a}m[b.id]=b.itemCount})}function q(b){d.eachLayer(function(a){b=
b||a.id.indexOf(n)<0&&a.itemCount&&a.itemCount!==m[a.id]});b&&v()}function w(b,a,f){if(f-r>=x){q();r=f}}function s(b,a,f){delete k[n+f.id];q(true)}function y(){for(var b in k)d.removeLayer(b);m={};k={}}function p(b){var a=b.find({typeName:"Marker"}),f={},c;for(c=a.length;c--;){var g=a[c].xy;g=(g.x/o|0)+"_"+(g.y/o|0);var h=f[g];h||(h=f[g]=[]);h[h.length]=a[c]}c=false;for(var e in f)c=c||f[e].length>1;a=n+b.id;e=k[a];if(c)if(e){f=e;b=b.find({typeName:"Marker"});for(var i=b.length;i--;)if(!b[i].cluster){a=
f.find();c=null;g=Infinity;for(h=a.length;h--;){var j=void 0-a[h].xy.x,t=void 0-a[h].xy.y;j=Math.sqrt(j*j+t*t);if(j<g){c=a[h];g=j}}a=g<=o?c:null;if(!a){a=new T5.Marker(COG.extend({},b[i],{children:[]}));f.add(a)}a.children.push(b[i]);a.size+=1;b[i].cluster=a}}else{e=k[a]=new T5.DrawLayer({id:a});for(i in f){c=f[i];g=u(c,d||b.view);g=new T5.Marker(COG.extend({},c[0],{xy:g,size:c[0].size+c.length,children:c}));for(h=c.length;h--;)c[h].cluster=g;e.add(g)}e=e;if(d){d.setLayer(a,e);d.invalidate()}}else if(e){delete k[a];
if(d){d.removeLayer(a);d.invalidate()}}return e}l=COG.extend({dist:32,checkInterval:100},l);var n="cluster_",r=0,x=l.checkInterval,m={},k={},o=l.dist;if(d){d.bind("drawComplete",w);d.bind("layerChange",s);d.bind("layerRemove",s);d.bind("zoomLevelChange",y)}return{checkLayer:p,uncluster:function(){m={};for(var b in k){var a=d.getLayer(b.slice(n.length));if(a)a.visible=true;d.removeLayer(b)}d.invalidate()}}};
