T5.Clusterer=function(g,m){function s(e){function c(){for(var f=0,h=arguments.length;h--;)f+=arguments[h];return f/arguments.length|0}for(var d=[],a=[],b=e.length;b--;){d[b]=e[b].xy.x;a[b]=e[b].xy.y}return T5.XY.init(c.apply(null,d),c.apply(null,a))}function t(){COG.info("checking for clusters");g.eachLayer(function(e){if(!T5.is(e.itemCount,"undefined")){var c=e.find({typeName:"Marker"}),d={},a;for(a=c.length;a--;){var b=c[a].xy;b=(b.x/o|0)+"_"+(b.y/o|0);var f=d[b];f||(f=d[b]=[]);f[f.length]=c[a]}var h;
c=false;for(h in d)c=c||d[h].length>1;h=c;a=p+e.id;c=k[a];if(h)if(c){d=e.find({typeName:"Marker"});for(var i=d.length;i--;)if(!d[i].cluster){a=c.find();b=null;f=Infinity;for(var j=a.length;j--;){var l=void 0-a[j].xy.x,q=void 0-a[j].xy.y;l=Math.sqrt(l*l+q*q);if(l<f){b=a[j];f=l}}a=f<=o?b:null;if(!a){a=new T5.Marker(COG.extend({},d[i],{children:[]}));c.add(a)}a.children.push(d[i]);a.size+=1;d[i].cluster=a}}else{c=k[a]=new T5.DrawLayer({id:a});for(i in d){b=d[i];f=s(b);f=new T5.Marker(COG.extend({},b[0],
{xy:f,size:b[0].size+b.length,children:b}));for(j=b.length;j--;)b[j].cluster=f;c.add(f)}g.setLayer(a,c);g.invalidate()}else if(c){delete k[a];g.removeLayer(a);g.invalidate()}e.visible=!h}n[e.id]=e.itemCount})}m=COG.extend({dist:32,checkInterval:100},m);var p="cluster_",r=0,u=m.checkInterval,n={},k={},o=m.dist;g.bind("drawComplete",function(e,c,d){if(d-r>=u){var a=false;g.eachLayer(function(b){a=a||b.id.indexOf(p)<0&&b.itemCount&&b.itemCount!==n[b.id]});a&&t();r=d}});g.bind("zoomLevelChange",function(){for(var e in k)g.removeLayer(e);
n={};k={}});return{uncluster:function(){n={};for(var e in k){var c=g.getLayer(e.slice(p.length));if(c)c.visible=true;g.removeLayer(e)}g.invalidate()}}};
