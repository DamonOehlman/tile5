function ColorParser(h){this.ok=false;if(h.charAt(0)=="#")h=h.substr(1,6);h=h.replace(/ /g,"");h=h.toLowerCase();for(var i=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(g){return[parseInt(g[1],10),parseInt(g[2],10),parseInt(g[3],10)]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(g){return[parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],
process:function(g){return[parseInt(g[1]+g[1],16),parseInt(g[2]+g[2],16),parseInt(g[3]+g[3],16)]}}],j=0;j<i.length;j++){var u=i[j].process,x=i[j].re.exec(h);if(x){channels=u(x);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r;this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g;this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b;this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toHex=function(){var g=
this.r.toString(16),p=this.g.toString(16),m=this.b.toString(16);if(g.length==1)g="0"+g;if(p.length==1)p="0"+p;if(m.length==1)m="0"+m;return parseInt("0x"+g+p+m,16)}}
T5.registerRenderer("three:webgl",function(h,i,j,u,x){function g(a){var b=a>>1;return D[a]=new Cube(b,b,b)}function p(a,b){if(!E[a]&&b)E[a]=b();return E[a]}function m(a,b,c){a=new ColorParser(c.fill||"#ffffff");var f=new ColorParser(c.stroke||"#ffffff");M[b]=[new THREE.MeshLambertMaterial({color:a.toHex(),shading:THREE.FlatShading})];F[b]=[new THREE.LineBasicMaterial({color:f.toHex(),opacity:c.opacity||1,linewidth:c.lineWidth||2})]}function y(a,b,c,f){return{draw:f||P,viewport:a,state:c,hit:false,
vpX:G,vpY:H}}function Q(a){z[a.id]=a;T5.getImage(a.url,function(b){b=new THREE.Texture(b);var c=a.mesh=new THREE.Mesh(N,[new THREE.MeshBasicMaterial({map:b})].concat(O));c.id=a.id;c.rotation.x=-Math.PI/2;b.needsUpdate=true;c.position.x=a.x+a.w/2;c.position.z=a.y+a.h/2;l.addObject(c);h.invalidate()})}function A(a,b,c){var f=[];for(var d in a){var e=a[d];if(c?e[c]:!b[d]){if(e.mesh){l.removeChild(e.mesh);e.mesh=null}f[f.length]=d}}for(b=f.length;b--;)delete a[f[b]]}function P(a){var b=this.mesh;if(b){var c=
b instanceof THREE.Line?F:M;c=c[v]||c.basic;B[this.id]=this;b.position.x=(a.x||this.xy.x)+this.translateX;b.position.z=a.y||this.xy.y;if(this.materials)c=c.concat(this.materials);b.materials=c}}function w(a,b,c,f,d){b.z=d||b.z||1;a.position.x=(c||b.xy.x)+b.translateX;a.position.y=b.z-b.translateY;a.position.z=f||b.xy.y;if(b.scaling!==1)a.scale=new THREE.Vector3(b.scaling,b.scaling,b.scaling);I[b.id]=b;l.addObject(a)}u=COG.extend({guides:false},u);var q,l,r,I={},z={},B={},C={},v="basic",R=new THREE.JSONLoader,
n,N,O=[],s,t,D=[],k=[],M={},F={},G=0,H=0,J=null,E={};(function(){var a,b;if(i){s=i.offsetWidth-h.padding*2;t=i.offsetHeight-h.padding*2;a=(s/256|0)+1;b=(t/256|0)+1;l=new THREE.Scene;var c;globalLight=c=new THREE.DirectionalLight(16777215,2);c.position.z=1;l.addLight(c);n=new THREE.Mesh(new Plane(a*256,b*256,a,b),new THREE.MeshBasicMaterial({color:14540253,wireframe:true}));if(u.guides){a=new THREE.Geometry;b=new THREE.Geometry;c=new THREE.Geometry;a.vertices.push(new THREE.Vertex(new THREE.Vector3(0,
0,0)));a.vertices.push(new THREE.Vertex(new THREE.Vector3(128,0,0)));b.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,0)));b.vertices.push(new THREE.Vertex(new THREE.Vector3(0,128,0)));c.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,0)));c.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,128)));k.push(new THREE.Line(a,[new THREE.LineBasicMaterial({color:16711680,linewidth:3})]));k.push(new THREE.Line(b,[new THREE.LineBasicMaterial({color:65280,linewidth:3})]));k.push(new THREE.Line(c,
[new THREE.LineBasicMaterial({color:255,linewidth:3})]));for(a=k.length;a--;){k[a].position.y=1;l.addObject(k[a])}}n.rotation.x=-Math.PI/2;n.position.y=-1;l.addObject(n);globalCamera=q=new THREE.Camera(45,s/t,1,2E3,n);N=new Plane(256,256,4,4);O=[];r=new THREE.WebGLRenderer;r.setSize(s,t);r.domElement.style.margin=COG.formatStr("{0}px 0 0 {0}px",h.padding);i.appendChild(r.domElement)}new Cube(5,5,5)})();j=COG.extend(x,{fastpan:false,applyStyle:function(a){var b;if(v!==a){b=v;v=a}return b||"basic"},
applyTransform:function(a){var b=a.mesh,c=a.translateX!==0||a.translateY!==0||a.scaling!==1||a.rotation!==0;if(b&&(c||a.transformed)){b.scale.x=b.scale.y=b.scale.z=a.scaling;b.rotation.y=-a.rotation;b.position.x=a.xy.x+a.translateX;b.position.y=a.z-a.translateY;J={undo:function(){J=null},x:a.xy.x,y:a.xy.y}}a.transformed=c;return J},drawTiles:function(a,b){var c,f;for(f=b.length;f--;){c=b[f];!c.mesh&&!z[c.id]&&Q(c);C[c.id]=c}},prepare:function(a,b){G=b.x+h.padding;H=b.y+h.padding;for(var c=G+(s>>1),
f=H+(t>>1),d=b.scaleFactor,e=k.length;e--;){k[e].position.x=c;k[e].position.z=f}n.position.x=c;n.position.z=f;q.position.x=c;q.position.y=200/d;q.position.z=f+200/d;A(I,B);B={};A(z,C);C={};return true},prepArc:function(a,b,c,f){if(!a.mesh){var d=new Sphere(a.size,15,15);d=a.mesh=new THREE.Mesh(d);w(d,a);d.rotation.x=Math.PI/2}return y(b,c,f)},prepImage:function(a,b,c,f,d){var e=d.image||a.image;if(e&&!a.mesh){var o=new Plane(e.width,e.height),K=(d.x||a.xy.x)+e.width/2;d=(d.y||a.xy.y)+e.height/2;e=
new THREE.Texture(e);o=a.mesh=new THREE.Mesh(o,new THREE.MeshBasicMaterial({map:e,blending:THREE.BillboardBlending}));e.needsUpdate=true;w(o,a,K,d,1)}return y(b,c,f)},prepMarker:function(a,b,c,f){if(!a.mesh&&!a.loading){var d=a.size,e;switch(a.markerStyle.toLowerCase()){case "image":a.materials=p("marker_image_"+a.imageUrl,function(){return[new THREE.MeshBasicMaterial({map:ImageUtils.loadTexture(a.imageUrl)})]});e=a.mesh=new THREE.Mesh(D[a.size]||g(a.size));break;case "model.ascii":a.loading=true;
R.load({model:a.modelUrl,callback:function(o){e=a.mesh=new THREE.Mesh(o);w(e,a)}});break;default:e=a.mesh=new THREE.Mesh(D[a.size]||g(a.size))}if(e){a.z=d>>1;w(e,a)}}return y(b,c,f)},prepPoly:function(a,b,c,f,d){if(!a.mesh){d=d.points||a.points;for(var e=new THREE.Geometry,o=a.xy.x,K=a.xy.y,L=d.length;L--;)e.vertices.push(new THREE.Vertex(new THREE.Vector3(d[L].x-o,1,d[L].y-K)));d=a.mesh=new THREE.Line(e,F[v]);a.removeOnReset=true;w(d,a)}return y(b,c,f)},render:function(){r.render(l,q)},getCamera:function(){return q},
getContext:function(){return context},getDimensions:function(){return{width:s,height:t}}});j.bind("detach",function(){i.removeChild(r.domElement)});j.bind("reset",function(){A(z,C={});A(I,B,"removeOnReset")});(function(){for(var a in T5.styles)m(null,a,T5.styles[a]);T5.bind("styleDefined",m)})();COG.info("created three:webgl renderer");return j});
