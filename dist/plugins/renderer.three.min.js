function ColorParser(h){this.ok=false;if(h.charAt(0)=="#")h=h.substr(1,6);h=h.replace(/ /g,"");h=h.toLowerCase();for(var i=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(g){return[parseInt(g[1],10),parseInt(g[2],10),parseInt(g[3],10)]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(g){return[parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],
process:function(g){return[parseInt(g[1]+g[1],16),parseInt(g[2]+g[2],16),parseInt(g[3]+g[3],16)]}}],j=0;j<i.length;j++){var A=i[j].process,r=i[j].re.exec(h);if(r){channels=A(r);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r;this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g;this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b;this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toHex=function(){var g=
this.r.toString(16),l=this.g.toString(16),k=this.b.toString(16);if(g.length==1)g="0"+g;if(l.length==1)l="0"+l;if(k.length==1)k="0"+k;return parseInt("0x"+g+l+k,16)}}
T5.registerRenderer("three:webgl",function(h,i,j,A){function r(a){var b=a>>1;return B[a]=new Cube(b,b,b)}function g(a,b){if(!C[a]&&b)C[a]=b();return C[a]}function l(a,b,c){a=new ColorParser(c.fill||"#ffffff");var e=new ColorParser(c.stroke||"#ffffff");s[b]=[new THREE.MeshLambertMaterial({color:a.toHex(),shading:THREE.FlatShading})];J[b]=[new THREE.LineBasicMaterial({color:e.toHex(),opacity:c.opacity||1,linewidth:c.lineWidth||2})]}function k(a,b,c,e){return{draw:e||P,viewport:a,state:c,hit:false,vpX:a.x,
vpY:a.y}}function Q(a){a.loading=true;T5.getImage(a.url,function(b){if(D[a.id]){b=new THREE.Texture(b);var c=a.mesh=new THREE.Mesh(K,[new THREE.MeshBasicMaterial({map:b})].concat(L));c.id=a.id;a.loading=false;M[a.id]=a;b.needsUpdate=true;c.position.x=a.x+a.w/2;c.position.y=-(a.y+a.h/2);m.addObject(c);h.invalidate()}})}function E(a,b,c){var e=[];for(var d in a){var f=a[d];if(f[c]||!b[d]){m.removeChild(f.mesh);f.mesh=null;e[e.length]=d}}for(b=e.length;b--;)delete a[e[b]]}function w(a,b,c,e,d){b.z=d||
b.z||1;a.position.x=(c||b.xy.x)+b.translateX;a.position.y=(e||b.xy.y)*-1;a.position.z=b.z-b.translateY;if(b.scaling!==1)a.scale=new THREE.Vector3(b.scaling,b.scaling,b.scaling);F[b.id]=b;m.addObject(a)}function x(a,b,c,e){if(a){y[b.id]=b;a.position.x=(c||b.xy.x)+b.translateX;a.position.y=(e||b.xy.y)*-1}}j=COG.extend({},j);var n,m,t,F={},M={},y={},D={},u="basic",o,K,L=[],p,q,B=[],s={},J={},N=0,O=0,G=null,C={},z={},P=function(){};(function(){var a,b;if(i){p=h.width=i.offsetWidth;q=h.height=i.offsetHeight;
a=(p/256|0)+1;b=(q/256|0)+1;m=new THREE.Scene;var c;c=new THREE.DirectionalLight(16777215,2);c.position.z=1;m.addLight(c);o=new THREE.Mesh(new Plane(a*256,b*256,a,b),new THREE.MeshBasicMaterial({color:16777215,wireframe:true}));o.position.z=-1;m.addObject(o);n=new THREE.Camera(45,p/q,1,1500,o);n.position.z=150;K=new Plane(256,256,4,4);L=[];t=new THREE.WebGLRenderer;t.setSize(p,q);i.appendChild(t.domElement)}new Cube(5,5,5)})();j=COG.extend(A,{interactTarget:t.domElement,applyStyle:function(a){var b;
b=i.id;z[b]||(z[b]=[]);b=z[b].pop()||"basic";if(s[a]){z[i.id].push(a);u=a;return b}},applyTransform:function(a){var b=a.mesh,c=a.translateX!==0||a.translateY!==0||a.scaling!==1||a.rotation!==0;if(b&&(c||a.transformed)){b.scale.x=b.scale.y=b.scale.z=a.scaling;b.rotation.z=-a.rotation;b.position.x=a.xy.x+a.translateX;b.position.z=-a.translateY+a.z;G={undo:function(){G=null},x:a.xy.x,y:a.xy.y}}a.transformed=c;return G},drawTiles:function(a,b){var c,e;for(e=b.length;e--;){c=b[e];!c.mesh&&!c.loading&&
Q(c);D[c.id]=c}},prepare:function(a,b){N=b.x;O=b.y;n.position.x=o.position.x=N+p/2;o.position.y=-O-q/2;n.position.y=o.position.y-200/b.scaleFactor;n.position.z=150/b.scaleFactor;y={};return true},prepArc:function(a,b,c,e){if(!a.mesh){var d=new Sphere(a.size,15,15);d=a.mesh=new THREE.Mesh(d,s[u]);w(d,a);d.rotation.x=Math.PI/2}x(a.mesh,a);return k(b,c,e)},prepImage:function(a,b,c,e,d){var f=d.image||a.image;if(f&&!a.mesh){var v=new Plane(f.width,f.height),H=(d.x||a.xy.x)+f.width/2;d=(d.y||a.xy.y)+f.height/
2;f=new THREE.Texture(f);v=a.mesh=new THREE.Mesh(v,new THREE.MeshBasicMaterial({map:f,blending:THREE.BillboardBlending}));f.needsUpdate=true;w(v,a,H,d,1)}x(a.mesh,a);return k(b,c,e)},prepMarker:function(a,b,c,e){if(!a.mesh){var d=a.size,f;switch(a.markerStyle.toLowerCase()){case "image":f=g("marker_image_"+a.imageUrl,function(){return[new THREE.MeshBasicMaterial({map:ImageUtils.loadTexture(a.imageUrl)})]});f=a.mesh=new THREE.Mesh(B[a.size]||r(a.size),s[u].concat(f));break;default:f=a.mesh=new THREE.Mesh(B[a.size]||
r(a.size),s[u])}if(f){a.z=d>>1;w(f,a)}}x(a.mesh,a);return k(b,c,e)},prepPoly:function(a,b,c,e,d){if(!a.mesh){d=d.points||a.points;for(var f=new THREE.Geometry,v=a.xy.x,H=a.xy.y,I=d.length;I--;)f.vertices.push(new THREE.Vertex(new THREE.Vector3(d[I].x-v,(d[I].y-H)*-1,1)));d=a.mesh=new THREE.Line(f,J[u]);a.removeOnReset=true;w(d,a)}x(a.mesh,a);return k(b,c,e)},render:function(){E(F,y);t.render(m,n)},reset:function(){E(M,D);E(F,y,"removeOnReset")},getCamera:function(){return n},getContext:function(){return context},
getDimensions:function(){return{width:p,height:q}}});(function(){for(var a in T5.styles)l(null,a,T5.styles[a]);T5.bind("styleDefined",l)})();COG.info("created three:webgl renderer");return j});
