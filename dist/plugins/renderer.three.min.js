function ColorParser(h){this.ok=false;if(h.charAt(0)=="#")h=h.substr(1,6);h=h.replace(/ /g,"");h=h.toLowerCase();for(var i=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(g){return[parseInt(g[1],10),parseInt(g[2],10),parseInt(g[3],10)]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(g){return[parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],
process:function(g){return[parseInt(g[1]+g[1],16),parseInt(g[2]+g[2],16),parseInt(g[3]+g[3],16)]}}],l=0;l<i.length;l++){var q=i[l].process,v=i[l].re.exec(h);if(v){channels=q(v);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r;this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g;this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b;this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toHex=function(){var g=
this.r.toString(16),n=this.g.toString(16),j=this.b.toString(16);if(g.length==1)g="0"+g;if(n.length==1)n="0"+n;if(j.length==1)j="0"+j;return parseInt("0x"+g+n+j,16)}}
T5.registerRenderer("three:webgl",function(h,i,l,q){function v(a){var b=a>>1;return C[a]=new Cube(b,b,b)}function g(a,b){if(!D[a]&&b)D[a]=b();return D[a]}function n(a,b,c){a=new ColorParser(c.fill||"#ffffff");var f=new ColorParser(c.stroke||"#ffffff");J[b]=[new THREE.MeshLambertMaterial({color:a.toHex(),shading:THREE.FlatShading})];E[b]=[new THREE.LineBasicMaterial({color:f.toHex(),opacity:c.opacity||1,linewidth:c.lineWidth||2})]}function j(a,b,c,f){return{draw:f||M,viewport:a,state:c,hit:false,vpX:a.x,
vpY:a.y}}function N(a){z[a.id]=a;T5.getImage(a.url,function(b){b=new THREE.Texture(b);var c=a.mesh=new THREE.Mesh(K,[new THREE.MeshBasicMaterial({map:b})].concat(L));c.id=a.id;c.rotation.x=-Math.PI/2;b.needsUpdate=true;c.position.x=a.x+a.w/2;c.position.z=a.y+a.h/2;m.addObject(c);h.invalidate()})}function A(a,b,c){var f=[];for(var d in a){var e=a[d];if(c?e[c]:!b[d]){if(e.mesh){m.removeChild(e.mesh);e.mesh=null}f[f.length]=d}}for(b=f.length;b--;)delete a[f[b]]}function M(a){var b=this.mesh;if(b){var c=
b instanceof THREE.Line?E:J;c=c[w]||c.basic;B[this.id]=this;b.position.x=(a.x||this.xy.x)+this.translateX;b.position.z=a.y||this.xy.y;if(this.materials)c=c.concat(this.materials);b.materials=c}}function x(a,b,c,f,d){b.z=d||b.z||1;a.position.x=(c||b.xy.x)+b.translateX;a.position.y=b.z-b.translateY;a.position.z=f||b.xy.y;if(b.scaling!==1)a.scale=new THREE.Vector3(b.scaling,b.scaling,b.scaling);F[b.id]=b;m.addObject(a)}l=COG.extend({guides:false},l);var r,m,s,F={},z={},B={},y={},w="basic",O=new THREE.JSONLoader,
o,K,L=[],t,u,C=[],k=[],J={},E={},P=0,Q=0,G=null,D={};(function(){var a,b;if(i){t=h.width=i.offsetWidth;u=h.height=i.offsetHeight;a=(t/256|0)+1;b=(u/256|0)+1;m=new THREE.Scene;var c;globalLight=c=new THREE.DirectionalLight(16777215,2);c.position.z=1;m.addLight(c);o=new THREE.Mesh(new Plane(a*256,b*256,a,b),new THREE.MeshBasicMaterial({color:14540253,wireframe:true}));if(l.guides){a=new THREE.Geometry;b=new THREE.Geometry;c=new THREE.Geometry;a.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,0)));
a.vertices.push(new THREE.Vertex(new THREE.Vector3(128,0,0)));b.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,0)));b.vertices.push(new THREE.Vertex(new THREE.Vector3(0,128,0)));c.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,0)));c.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,128)));k.push(new THREE.Line(a,[new THREE.LineBasicMaterial({color:16711680,linewidth:3})]));k.push(new THREE.Line(b,[new THREE.LineBasicMaterial({color:65280,linewidth:3})]));k.push(new THREE.Line(c,[new THREE.LineBasicMaterial({color:255,
linewidth:3})]));for(a=k.length;a--;){k[a].position.y=1;m.addObject(k[a])}}o.rotation.x=-Math.PI/2;o.position.y=-1;m.addObject(o);globalCamera=r=new THREE.Camera(45,t/u,1,2E3,o);K=new Plane(256,256,4,4);L=[];s=new THREE.WebGLRenderer;s.setSize(t,u);i.appendChild(s.domElement)}new Cube(5,5,5)})();q=COG.extend(q,{interactTarget:s.domElement,applyStyle:function(a){var b;if(w!==a){b=w;w=a}return b||"basic"},applyTransform:function(a){var b=a.mesh,c=a.translateX!==0||a.translateY!==0||a.scaling!==1||a.rotation!==
0;if(b&&(c||a.transformed)){b.scale.x=b.scale.y=b.scale.z=a.scaling;b.rotation.y=-a.rotation;b.position.x=a.xy.x+a.translateX;b.position.y=a.z-a.translateY;G={undo:function(){G=null},x:a.xy.x,y:a.xy.y}}a.transformed=c;return G},drawTiles:function(a,b){var c,f;for(f=b.length;f--;){c=b[f];!c.mesh&&!z[c.id]&&N(c);y[c.id]=c}},prepare:function(a,b){P=b.x;Q=b.y;for(var c=b.x+(t>>1),f=b.y+(u>>1),d=b.scaleFactor,e=k.length;e--;){k[e].position.x=c;k[e].position.z=f}o.position.x=c;o.position.z=f;r.position.x=
c;r.position.y=200/d;r.position.z=f+200/d;A(F,B);B={};A(z,y);y={};return true},prepArc:function(a,b,c,f){if(!a.mesh){var d=new Sphere(a.size,15,15);d=a.mesh=new THREE.Mesh(d);x(d,a);d.rotation.x=Math.PI/2}return j(b,c,f)},prepImage:function(a,b,c,f,d){var e=d.image||a.image;if(e&&!a.mesh){var p=new Plane(e.width,e.height),H=(d.x||a.xy.x)+e.width/2;d=(d.y||a.xy.y)+e.height/2;e=new THREE.Texture(e);p=a.mesh=new THREE.Mesh(p,new THREE.MeshBasicMaterial({map:e,blending:THREE.BillboardBlending}));e.needsUpdate=
true;x(p,a,H,d,1)}return j(b,c,f)},prepMarker:function(a,b,c,f){if(!a.mesh&&!a.loading){var d=a.size,e;switch(a.markerStyle.toLowerCase()){case "image":a.materials=g("marker_image_"+a.imageUrl,function(){return[new THREE.MeshBasicMaterial({map:ImageUtils.loadTexture(a.imageUrl)})]});e=a.mesh=new THREE.Mesh(C[a.size]||v(a.size));break;case "model.ascii":a.loading=true;O.load({model:a.modelUrl,callback:function(p){e=a.mesh=new THREE.Mesh(p);x(e,a)}});break;default:e=a.mesh=new THREE.Mesh(C[a.size]||
v(a.size))}if(e){a.z=d>>1;x(e,a)}}return j(b,c,f)},prepPoly:function(a,b,c,f,d){if(!a.mesh){d=d.points||a.points;for(var e=new THREE.Geometry,p=a.xy.x,H=a.xy.y,I=d.length;I--;)e.vertices.push(new THREE.Vertex(new THREE.Vector3(d[I].x-p,1,d[I].y-H)));d=a.mesh=new THREE.Line(e,E[w]);a.removeOnReset=true;x(d,a)}return j(b,c,f)},render:function(){s.render(m,r)},reset:function(){y={};A(z,y);A(F,B,"removeOnReset")},getCamera:function(){return r},getContext:function(){return context},getDimensions:function(){return{width:t,
height:u}}});q.bind("detach",function(){i.removeChild(s.domElement)});(function(){for(var a in T5.styles)n(null,a,T5.styles[a]);T5.bind("styleDefined",n)})();COG.info("created three:webgl renderer");return q});
