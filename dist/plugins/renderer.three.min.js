function ColorParser(h){this.ok=false;if(h.charAt(0)=="#")h=h.substr(1,6);h=h.replace(/ /g,"");h=h.toLowerCase();for(var i=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(g){return[parseInt(g[1],10),parseInt(g[2],10),parseInt(g[3],10)]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(g){return[parseInt(g[1],16),parseInt(g[2],16),parseInt(g[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],
process:function(g){return[parseInt(g[1]+g[1],16),parseInt(g[2]+g[2],16),parseInt(g[3]+g[3],16)]}}],j=0;j<i.length;j++){var C=i[j].process,v=i[j].re.exec(h);if(v){channels=C(v);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r;this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g;this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b;this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toHex=function(){var g=
this.r.toString(16),n=this.g.toString(16),k=this.b.toString(16);if(g.length==1)g="0"+g;if(n.length==1)n="0"+n;if(k.length==1)k="0"+k;return parseInt("0x"+g+n+k,16)}}
T5.registerRenderer("three:webgl",function(h,i,j,C){function v(a){var b=a>>1;return D[a]=new Cube(b,b,b)}function g(a,b){if(!E[a]&&b)E[a]=b();return E[a]}function n(a,b,c){a=new ColorParser(c.fill||"#ffffff");var e=new ColorParser(c.stroke||"#ffffff");q[b]=[new THREE.MeshLambertMaterial({color:a.toHex(),shading:THREE.FlatShading})];K[b]=[new THREE.LineBasicMaterial({color:e.toHex(),opacity:c.opacity||1,linewidth:c.lineWidth||2})]}function k(a,b,c,e){return{draw:e||O,viewport:a,state:c,hit:false,vpX:a.x,
vpY:a.y}}function P(a){a.loading=true;T5.getImage(a.url,function(b){if(F[a.id]){b=new THREE.Texture(b);var c=a.mesh=new THREE.Mesh(L,[new THREE.MeshBasicMaterial({map:b})].concat(M));c.id=a.id;c.rotation.x=-Math.PI/2;a.loading=false;N[a.id]=a;b.needsUpdate=true;c.position.x=a.x+a.w/2;c.position.z=a.y+a.h/2;m.addObject(c);h.invalidate()}})}function G(a,b,c){var e=[];for(var d in a){var f=a[d];if(f[c]||!b[d]){m.removeChild(f.mesh);f.mesh=null;e[e.length]=d}}for(b=e.length;b--;)delete a[e[b]]}function w(a,
b,c,e,d){b.z=d||b.z||1;a.position.x=(c||b.xy.x)+b.translateX;a.position.y=b.z-b.translateY;a.position.z=e||b.xy.y;if(b.scaling!==1)a.scale=new THREE.Vector3(b.scaling,b.scaling,b.scaling);H[b.id]=b;m.addObject(a)}function z(a,b,c,e){if(a){A[b.id]=b;a.position.x=(c||b.xy.x)+b.translateX;a.position.z=e||b.xy.y}}j=COG.extend({},j);var r,m,x,H={},N={},A={},F={},s="basic",Q=new THREE.JSONLoader,o,L,M=[],t,u,D=[],l=[],q={},K={},R=0,S=0,I=null,E={},B={},O=function(){};(function(){var a,b;if(i){t=h.width=
i.offsetWidth;u=h.height=i.offsetHeight;a=(t/256|0)+1;b=(u/256|0)+1;m=new THREE.Scene;var c;globalLight=c=new THREE.DirectionalLight(16777215,2);c.position.z=1;m.addLight(c);o=new THREE.Mesh(new Plane(a*256,b*256,a,b),new THREE.MeshBasicMaterial({color:14540253,wireframe:true}));a=new THREE.Geometry;b=new THREE.Geometry;c=new THREE.Geometry;a.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,0)));a.vertices.push(new THREE.Vertex(new THREE.Vector3(128,0,0)));b.vertices.push(new THREE.Vertex(new THREE.Vector3(0,
0,0)));b.vertices.push(new THREE.Vertex(new THREE.Vector3(0,128,0)));c.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,0)));c.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,128)));l.push(new THREE.Line(a,[new THREE.LineBasicMaterial({color:16711680,linewidth:3})]));l.push(new THREE.Line(b,[new THREE.LineBasicMaterial({color:65280,linewidth:3})]));l.push(new THREE.Line(c,[new THREE.LineBasicMaterial({color:255,linewidth:3})]));for(a=l.length;a--;){l[a].position.y=1;m.addObject(l[a])}o.rotation.x=
-Math.PI/2;o.position.y=-1;m.addObject(o);globalCamera=r=new THREE.Camera(45,t/u,1,2E3,o);L=new Plane(256,256,4,4);M=[];x=new THREE.WebGLRenderer;x.setSize(t,u);i.appendChild(x.domElement)}new Cube(5,5,5)})();j=COG.extend(C,{interactTarget:x.domElement,applyStyle:function(a){var b;b=i.id;B[b]||(B[b]=[]);b=B[b].pop()||"basic";if(q[a]){B[i.id].push(a);s=a;return b}},applyTransform:function(a){var b=a.mesh,c=a.translateX!==0||a.translateY!==0||a.scaling!==1||a.rotation!==0;if(b&&(c||a.transformed)){b.scale.x=
b.scale.y=b.scale.z=a.scaling;b.rotation.y=-a.rotation;b.position.x=a.xy.x+a.translateX;b.position.y=a.z-a.translateY;I={undo:function(){I=null},x:a.xy.x,y:a.xy.y}}a.transformed=c;return I},drawTiles:function(a,b){var c,e;for(e=b.length;e--;){c=b[e];!c.mesh&&!c.loading&&P(c);F[c.id]=c}},prepare:function(a,b){R=b.x;S=b.y;for(var c=b.x+(t>>1),e=b.y+(u>>1),d=b.scaleFactor,f=l.length;f--;){l[f].position.x=c;l[f].position.z=e}o.position.x=c;o.position.z=e;r.position.x=c;r.position.y=200/d;r.position.z=
e+200/d;A={};return true},prepArc:function(a,b,c,e){if(!a.mesh){var d=new Sphere(a.size,15,15);d=a.mesh=new THREE.Mesh(d,q[s]);w(d,a);d.rotation.x=Math.PI/2}z(a.mesh,a);return k(b,c,e)},prepImage:function(a,b,c,e,d){var f=d.image||a.image;if(f&&!a.mesh){var p=new Plane(f.width,f.height),y=(d.x||a.xy.x)+f.width/2;d=(d.y||a.xy.y)+f.height/2;f=new THREE.Texture(f);p=a.mesh=new THREE.Mesh(p,new THREE.MeshBasicMaterial({map:f,blending:THREE.BillboardBlending}));f.needsUpdate=true;w(p,a,y,d,1)}z(a.mesh,
a);return k(b,c,e)},prepMarker:function(a,b,c,e){if(!a.mesh&&!a.loading){var d=a.size,f;switch(a.markerStyle.toLowerCase()){case "image":var p=g("marker_image_"+a.imageUrl,function(){return[new THREE.MeshBasicMaterial({map:ImageUtils.loadTexture(a.imageUrl)})]});f=a.mesh=new THREE.Mesh(D[a.size]||v(a.size),q[s].concat(p));break;case "model.ascii":a.loading=true;Q.load({model:a.modelUrl,callback:function(y){f=a.mesh=new THREE.Mesh(y,q[s]);w(f,a)}});break;default:f=a.mesh=new THREE.Mesh(D[a.size]||
v(a.size),q[s])}if(f){a.z=d>>1;w(f,a)}}z(a.mesh,a);return k(b,c,e)},prepPoly:function(a,b,c,e,d){if(!a.mesh){d=d.points||a.points;for(var f=new THREE.Geometry,p=a.xy.x,y=a.xy.y,J=d.length;J--;)f.vertices.push(new THREE.Vertex(new THREE.Vector3(d[J].x-p,1,d[J].y-y)));d=a.mesh=new THREE.Line(f,K[s]);a.removeOnReset=true;w(d,a)}z(a.mesh,a);return k(b,c,e)},render:function(){G(H,A);x.render(m,r)},reset:function(){G(N,F);G(H,A,"removeOnReset")},getCamera:function(){return r},getContext:function(){return context},
getDimensions:function(){return{width:t,height:u}}});(function(){for(var a in T5.styles)n(null,a,T5.styles[a]);T5.bind("styleDefined",n)})();COG.info("created three:webgl renderer");return j});
