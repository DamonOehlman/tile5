function ColorParser(h){this.ok=false;if(h.charAt(0)=="#")h=h.substr(1,6);h=h.replace(/ /g,"");h=h.toLowerCase();for(var l=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(f){return[parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10)]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(f){return[parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],
process:function(f){return[parseInt(f[1]+f[1],16),parseInt(f[2]+f[2],16),parseInt(f[3]+f[3],16)]}}],m=0;m<l.length;m++){var s=l[m].process,i=l[m].re.exec(h);if(i){channels=s(i);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r;this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g;this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b;this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toHex=function(){var f=
this.r.toString(16),p=this.g.toString(16),n=this.b.toString(16);if(f.length==1)f="0"+f;if(p.length==1)p="0"+p;if(n.length==1)n="0"+n;return parseInt("0x"+f+p+n,16)}}
T5.Registry.register("renderer","three:webgl",function(h,l,m,s,i){function f(a){var b=a>>1;return C[a]=new Cube(b,b,b)}function p(a,b){if(!D[a]&&b)D[a]=b();return D[a]}function n(a,b,c){a=new ColorParser(c.fill||"#ffffff");var d=new ColorParser(c.stroke||"#ffffff");L[b]=[new THREE.MeshLambertMaterial({color:a.toHex(),shading:THREE.FlatShading})];E[b]=[new THREE.LineBasicMaterial({color:d.toHex(),opacity:c.opacity||1,linewidth:c.lineWidth||2})]}function x(a,b,c){return{draw:c||O,viewport:a,hit:false,
vpX:F,vpY:G}}function P(a){y[a.id]=a;T5.getImage(a.url,function(b){b=new THREE.Texture(b);var c=a.mesh=new THREE.Mesh(M,[new THREE.MeshBasicMaterial({map:b})].concat(N));c.id=a.id;c.rotation.x=-Math.PI/2;b.needsUpdate=true;c.position.x=a.x+a.w/2;c.position.z=a.y+a.h/2;k.addObject(c);h.invalidate()})}function z(a,b,c){var d=[],e;for(e in a){var g=a[e];if(c?g[c]:!b[e]){if(g.mesh){k.removeChild(g.mesh);g.mesh=null}d[d.length]=e}}for(b=d.length;b--;)delete a[d[b]]}function O(a){var b=this.mesh;if(b){var c=
b instanceof THREE.Line?E:L;c=c[t]||c.basic;A[this.id]=this;b.position.x=(a.x||this.xy.x)+this.translateX;b.position.z=a.y||this.xy.y;if(this.materials)c=c.concat(this.materials);b.materials=c}}function u(a,b,c,d,e){b.z=e||b.z||1;a.position.x=(c||b.xy.x)+b.translateX;a.position.y=b.z-b.translateY;a.position.z=d||b.xy.y;if(b.scaling!==1)a.scale=new THREE.Vector3(b.scaling,b.scaling,b.scaling);H[b.id]=b;k.addObject(a)}s=_extend({guides:false},s);var q,k,r,H={},y={},A={},B={},t="basic",Q=new THREE.JSONLoader,
o,M,N=[],v,w,C=[],j=[],L={},E={},F=0,G=0,I=null,D={};(function(){var a,b;if(l){v=l.offsetWidth;w=l.offsetHeight;a=(v/256|0)+1;b=(w/256|0)+1;k=new THREE.Scene;var c;globalLight=c=new THREE.DirectionalLight(16777215,2);c.position.z=1;k.addLight(c);o=new THREE.Mesh(new Plane(a*256,b*256,a,b),new THREE.MeshBasicMaterial({color:14540253,wireframe:true}));if(s.guides){a=new THREE.Geometry;b=new THREE.Geometry;c=new THREE.Geometry;a.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,0)));a.vertices.push(new THREE.Vertex(new THREE.Vector3(128,
0,0)));b.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,0)));b.vertices.push(new THREE.Vertex(new THREE.Vector3(0,128,0)));c.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,0)));c.vertices.push(new THREE.Vertex(new THREE.Vector3(0,0,128)));j.push(new THREE.Line(a,[new THREE.LineBasicMaterial({color:16711680,linewidth:3})]));j.push(new THREE.Line(b,[new THREE.LineBasicMaterial({color:65280,linewidth:3})]));j.push(new THREE.Line(c,[new THREE.LineBasicMaterial({color:255,linewidth:3})]));
for(a=j.length;a--;){j[a].position.y=1;k.addObject(j[a])}}o.rotation.x=-Math.PI/2;o.position.y=-1;k.addObject(o);globalCamera=q=new THREE.Camera(45,v/w,1,2E3,o);M=new Plane(256,256,4,4);N=[];r=new THREE.WebGLRenderer;r.setSize(v,w);r.domElement.style.margin=_formatter("{0}px 0 0 {0}px")(h.padding);m.appendChild(r.domElement)}new Cube(5,5,5)})();i=_extend(i,{fastpan:false,applyStyle:function(a){var b;if(t!==a){b=t;t=a}return b||"basic"},applyTransform:function(a){var b=a.mesh,c=a.translateX!==0||a.translateY!==
0||a.scaling!==1||a.rotation!==0;if(b&&(c||a.transformed)){b.scale.x=b.scale.y=b.scale.z=a.scaling;b.rotation.y=-a.rotation;b.position.x=a.xy.x+a.translateX;b.position.y=a.z-a.translateY;I={undo:function(){I=null},x:a.xy.x,y:a.xy.y}}a.transformed=c;return I},drawTiles:function(a,b){var c,d;for(d=b.length;d--;){c=b[d];!c.mesh&&!y[c.id]&&P(c);B[c.id]=c}},prepare:function(a,b){F=b.x+h.padding;G=b.y+h.padding;for(var c=F+(v>>1),d=G+(w>>1),e=b.scaleFactor,g=j.length;g--;){j[g].position.x=c;j[g].position.z=
d}o.position.x=c;o.position.z=d;q.position.x=c;q.position.y=200/e;q.position.z=d+200/e;z(H,A);A={};z(y,B);B={};return true},prepArc:function(a,b,c){if(!a.mesh){var d=new Sphere(a.size,15,15);d=a.mesh=new THREE.Mesh(d);u(d,a);d.rotation.x=Math.PI/2}return x(b,c)},prepImage:function(a,b,c,d){var e=d.image||a.image;if(e&&!a.mesh){var g=new Plane(e.width,e.height),J=(d.x||a.xy.x)+e.width/2;d=(d.y||a.xy.y)+e.height/2;e=new THREE.Texture(e);g=a.mesh=new THREE.Mesh(g,new THREE.MeshBasicMaterial({map:e,blending:THREE.BillboardBlending}));
e.needsUpdate=true;u(g,a,J,d,1)}return x(b,c)},prepMarker:function(a,b,c){if(!a.mesh&&!a.loading){var d=a.size,e;switch(a.markerStyle.toLowerCase()){case "image":a.materials=p("marker_image_"+a.imageUrl,function(){return[new THREE.MeshBasicMaterial({map:ImageUtils.loadTexture(a.imageUrl)})]});e=a.mesh=new THREE.Mesh(C[a.size]||f(a.size));break;case "model.ascii":a.loading=true;Q.load({model:a.modelUrl,callback:function(g){e=a.mesh=new THREE.Mesh(g);u(e,a)}});break;default:e=a.mesh=new THREE.Mesh(C[a.size]||
f(a.size))}if(e){a.z=d>>1;u(e,a)}}return x(b,c)},prepPoly:function(a,b,c,d){if(!a.mesh){d=d.points||a.points;for(var e=new THREE.Geometry,g=a.xy.x,J=a.xy.y,K=d.length;K--;)e.vertices.push(new THREE.Vertex(new THREE.Vector3(d[K].x-g,1,d[K].y-J)));d=a.mesh=new THREE.Line(e,E[t]);a.removeOnReset=true;u(d,a)}return x(b,c)},getCamera:function(){return q},getContext:function(){return context}});i.bind("detach",function(){m.removeChild(r.domElement)});i.bind("render",function(){r.render(k,q)});i.bind("reset",
function(){z(y,B={});z(H,A,"removeOnReset")});(function(){for(var a in T5.styles)n(null,a,T5.styles[a]);T5.bind("styleDefined",n)})();_log("created three:webgl renderer");return i});
