function ColorParser(h){this.ok=false;if(h.charAt(0)=="#")h=h.substr(1,6);h=h.replace(/ /g,"");h=h.toLowerCase();for(var i=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(e){return[parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10)]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],
process:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}],j=0;j<i.length;j++){var A=i[j].process,s=i[j].re.exec(h);if(s){channels=A(s);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r;this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g;this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b;this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toHex=function(){var e=
this.r.toString(16),m=this.g.toString(16),k=this.b.toString(16);if(e.length==1)e="0"+e;if(m.length==1)m="0"+m;if(k.length==1)k="0"+k;return parseInt("0x"+e+m+k,16)}}
T5.registerRenderer("three:webgl",function(h,i,j,A){function s(a){var b=a>>1;return B[a]=new Cube(b,b,b)}function e(a,b){if(!C[a]&&b)C[a]=b();return C[a]}function m(a,b,c){a=new ColorParser(c.fill||"#ffffff");var g=new ColorParser(c.stroke||"#ffffff");t[b]=[new THREE.MeshLambertMaterial({color:a.toHex(),shading:THREE.FlatShading})];G[b]=[new THREE.LineBasicMaterial({color:g.toHex(),opacity:c.opacity||1,linewidth:c.lineWidth||2})]}function k(a,b,c,g){return{draw:g||M,viewport:a,state:c,hit:false,vpX:a.x,
vpY:a.y}}function y(a,b,c,g,d){b.zOffset=d||b.zOffset||1;a.position.x=(c||b.xy.x)+b.translateX;a.position.y=(g||b.xy.y)*-1;a.position.z=b.zOffset-b.translateY;if(b.scaling!==1)a.scale=new THREE.Vector3(b.scaling,b.scaling,b.scaling);u[b.id]=b;n.addObject(a)}function N(a){a.loading=true;T5.getImage(a.url,function(b){if(l[a.id]){b=new THREE.Texture(b);var c=a.mesh=new THREE.Mesh(H,[new THREE.MeshBasicMaterial({map:b})].concat(I));c.id=a.id;a.loading=false;u[a.id]=a;b.needsUpdate=true;c.position.x=a.x+
a.w/2;c.position.y=-(a.y+a.h/2);n.addObject(c);h.invalidate()}})}function J(){var a=[];for(var b in u){var c=u[b];if(!l[b]){n.removeChild(c.mesh);c.mesh=null;a[a.length]=b}}for(b=a.length;b--;)delete u[a[b]]}j=COG.extend({},j);var o,n,v,u={},l={},w="basic",p,H,I=[],q,r,B=[],t={},G={},K=0,L=0,D=null,C={},z={},M=function(){};(function(){var a,b;if(i){q=h.width=i.offsetWidth;r=h.height=i.offsetHeight;a=(q/256|0)+1;b=(r/256|0)+1;n=new THREE.Scene;var c;c=new THREE.DirectionalLight(16777215,2);c.position.z=
1;n.addLight(c);p=new THREE.Mesh(new Plane(a*256,b*256,a,b),new THREE.MeshBasicMaterial({color:16777215,wireframe:true}));p.position.z=-1;n.addObject(p);o=new THREE.Camera(45,q/r,1,1500,p);o.position.z=150;H=new Plane(256,256,4,4);I=[];v=new THREE.WebGLRenderer;v.setSize(q,r);i.appendChild(v.domElement)}new Cube(5,5,5)})();j=COG.extend(A,{interactTarget:v.domElement,applyStyle:function(a){var b;b=i.id;z[b]||(z[b]=[]);b=z[b].pop()||"basic";if(t[a]){z[i.id].push(a);w=a;return b}},applyTransform:function(a){var b=
a.mesh,c=a.translateX!==0||a.translateY!==0||a.scaling!==1||a.rotation!==0;if(b&&(c||a.transformed)){b.scale.x=b.scale.y=b.scale.z=a.scaling;b.rotation.z=a.rotation;b.position.x=a.xy.x+a.translateX;b.position.z=-a.translateY+a.zOffset;D={undo:function(){D=null},x:a.xy.x,y:a.xy.y}}a.transformed=c;return D},drawTiles:function(a,b){var c,g;for(g=b.length;g--;){c=b[g];l[c.id]=c;!c.mesh&&!c.loading&&N(c)}},prepare:function(a,b){K=b.x;L=b.y;o.position.x=p.position.x=K+q/2;p.position.y=-L-r/2;o.position.y=
p.position.y-200/b.scaleFactor;o.position.z=150/b.scaleFactor;l={};return true},prepArc:function(a,b,c,g){if(!a.mesh){var d=new Sphere(a.size,15,15);d=a.mesh=new THREE.Mesh(d,t[w]);y(d,a);d.rotation.x=Math.PI/2}l[a.id]=a;return k(b,c,g)},prepImage:function(a,b,c,g,d){var f=d.image||a.image;if(f&&!a.mesh){var x=new Plane(f.width,f.height),E=(d.x||a.xy.x)+f.width/2;d=(d.y||a.xy.y)+f.height/2;f=new THREE.Texture(f);x=a.mesh=new THREE.Mesh(x,new THREE.MeshBasicMaterial({map:f,blending:THREE.BillboardBlending}));
f.needsUpdate=true;y(x,a,E,d,1)}l[a.id]=a;return k(b,c,g)},prepMarker:function(a,b,c,g){if(!a.mesh){var d=a.size,f;switch(a.markerStyle.toLowerCase()){case "image":f=e("marker_image_"+a.imageUrl,function(){return[new THREE.MeshBasicMaterial({map:ImageUtils.loadTexture(a.imageUrl)})]});f=a.mesh=new THREE.Mesh(B[a.size]||s(a.size),t[w].concat(f));break;default:f=a.mesh=new THREE.Mesh(B[a.size]||s(a.size),t[w])}if(f){a.zOffset=d>>1;y(f,a)}}l[a.id]=a;return k(b,c,g)},prepPoly:function(a,b,c,g,d){if(!a.mesh){d=
d.points||a.points;for(var f=new THREE.Geometry,x=a.xy.x,E=a.xy.y,F=d.length;F--;)f.vertices.push(new THREE.Vertex(new THREE.Vector3(d[F].x-x,(d[F].y-E)*-1,1)));d=a.mesh=new THREE.Line(f,G[w]);y(d,a)}l[a.id]=a;return k(b,c,g)},render:function(){J();v.render(n,o)},reset:function(){l={};J()},getCamera:function(){return o},getContext:function(){return context},getDimensions:function(){return{width:q,height:r}}});(function(){for(var a in T5.styles)m(null,a,T5.styles[a]);T5.bind("styleDefined",m)})();
COG.info("created three:webgl renderer");return j});
