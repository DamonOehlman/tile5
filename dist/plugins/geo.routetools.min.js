T5.RouteTools=function(){function e(a){if(j.test(a))return"-slight";return""}function f(a,c){var b=new T5.ShapeLayer;c.geometry&&T5.Geo.Position.vectorize(c.geometry,{callback:function(d){b.add(new T5.Line(d,{style:"waypoints",simplify:true}));a.setLayer("route",b)}})}function g(a){for(var c="unknown",b=k||l,d=0;d<b.length;d++){b[d].regex.lastIndex=-1;var h=b[d].regex.exec(a);if(h){c=b[d].customCheck?b[d].customCheck(a,h):b[d].turnType;break}}return c}var k=undefined,j=/bear/i,m=/right/i,l=function(){var a=
[];a.push({regex:/continue/i,turnType:"none"});a.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(c,b){return"turn-left"+e(b[1])}});a.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(c,b){return"turn-right"+e(b[1])}});a.push({regex:/enter\s(roundabout|rotary)/i,turnType:"roundabout"});a.push({regex:/take.*?ramp/i,turnType:"ramp"});a.push({regex:/take.*?exit/i,turnType:"ramp-exit"});a.push({regex:/make(.*?)u\-turn/i,customCheck:function(c,b){return"uturn"+(m.test(b[1])?"-right":
"-left")}});a.push({regex:/proceed/i,turnType:"start"});a.push({regex:/arrive/i,turnType:"arrive"});a.push({regex:/fell\sthrough/i,turnType:"merge"});return a}(),i={calculate:function(a){a=COG.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:false},a);var c=T5.Service.find("routing");c&&c.calculate(a,function(b){if(a.generalize)b.geometry=T5.Geo.Position.generalize(b.geometry,b.getInstructionPositions());if(a.map){f(a.map,b);a.autoFit&&a.map.gotoBounds(b.boundingBox)}a.success&&
a.success(b)})},createMapOverlay:f,parseTurnType:g,Instruction:function(a){var c=a=COG.extend({position:null,description:"",distance:0,distanceTotal:0,time:0,timeTotal:0,turnType:null},a),b=a.description;b=b.replace(/(\w)(\/)(\w)/g,"$1 $2 $3");c.description=b;if(!a.turnType)a.turnType=g(a.description);return a},RouteData:function(a){a=COG.extend({geometry:[],instructions:[],boundingBox:null},a);if(!a.boundingBox)a.boundingBox=T5.Geo.BoundingBox.forPositions(a.geometry);return COG.extend({getInstructionPositions:function(){for(var c=
[],b=0;b<a.instructions.length;b++)a.instructions[b].position&&c.push(a.instructions[b].position);return c}},a)}};COG.observable(i);return i}();
