if(!this.JSON)this.JSON={};
(function(){function e(n){return n<10?"0"+n:n}function h(n){d.lastIndex=0;return d.test(n)?'"'+n.replace(d,function(g){var p=k[g];return typeof p==="string"?p:"\\u"+("0000"+g.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+n+'"'}function a(n,g){var p,t,s,q,u=f,l,r=g[n];if(r&&typeof r==="object"&&typeof r.toJSON==="function")r=r.toJSON(n);if(typeof m==="function")r=m.call(g,n,r);switch(typeof r){case "string":return h(r);case "number":return isFinite(r)?String(r):"null";case "boolean":case "null":return String(r);
case "object":if(!r)return"null";f+=o;l=[];if(Object.prototype.toString.apply(r)==="[object Array]"){q=r.length;for(p=0;p<q;p+=1)l[p]=a(p,r)||"null";s=l.length===0?"[]":f?"[\n"+f+l.join(",\n"+f)+"\n"+u+"]":"["+l.join(",")+"]";f=u;return s}if(m&&typeof m==="object"){q=m.length;for(p=0;p<q;p+=1){t=m[p];if(typeof t==="string")if(s=a(t,r))l.push(h(t)+(f?": ":":")+s)}}else for(t in r)if(Object.hasOwnProperty.call(r,t))if(s=a(t,r))l.push(h(t)+(f?": ":":")+s);s=l.length===0?"{}":f?"{\n"+f+l.join(",\n"+f)+
"\n"+u+"}":"{"+l.join(",")+"}";f=u;return s}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+e(this.getUTCMonth()+1)+"-"+e(this.getUTCDate())+"T"+e(this.getUTCHours())+":"+e(this.getUTCMinutes())+":"+e(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var b=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f,o,k={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;if(typeof JSON.stringify!=="function")JSON.stringify=function(n,g,p){var t;o=f="";if(typeof p==="number")for(t=0;t<p;t+=1)o+=" ";else if(typeof p==="string")o=p;if((m=g)&&typeof g!=="function"&&(typeof g!=="object"||typeof g.length!=="number"))throw Error("JSON.stringify");return a("",
{"":n})};if(typeof JSON.parse!=="function")JSON.parse=function(n,g){function p(s,q){var u,l,r=s[q];if(r&&typeof r==="object")for(u in r)if(Object.hasOwnProperty.call(r,u)){l=p(r,u);if(l!==undefined)r[u]=l;else delete r[u]}return g.call(s,q,r)}var t;n=String(n);b.lastIndex=0;if(b.test(n))n=n.replace(b,function(s){return"\\u"+("0000"+s.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(n.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){t=eval("("+n+")");return typeof g==="function"?p({"":t},""):t}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(e){if(arguments.length<=1)return e;for(var h=arguments.length-2,a=0;a<=h;a++)e=e.replace(RegExp("\\{"+a+"\\}","gi"),arguments[a+1]);return e};
String.prototype.containsWord=function(e){var h="";if(e.toString)e=e.toString();for(var a=0;a<e.length;a++)h+=!/\w/.test(e[a])?"\\"+e[a]:e[a];return RegExp("(^|\\s|\\,)"+h+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GT=function(){var e=Object.prototype.hasOwnProperty,h=0,a={id:"GRUNT.core",extend:function(){var b=arguments[0]||{},d=1,f=arguments.length,o=false,k,m,n,g;if(typeof b==="boolean"){o=b;b=arguments[1]||{};d=2}if(typeof b!=="object"&&!a.isFunction(b))b={};if(f===d){b=this;--d}for(;d<f;d++)if((k=arguments[d])!=null)for(m in k){n=b[m];g=k[m];if(b!==g)if(o&&g&&(a.isPlainObject(g)||a.isArray(g))){n=n&&(a.isPlainObject(n)||a.isArray(n))?n:a.isArray(g)?[]:{};b[m]=a.extend(o,n,g)}else if(g!==undefined)b[m]=
g}return b},isFunction:function(b){return toString.call(b)==="[object Function]"},isArray:function(b){return toString.call(b)==="[object Array]"},isPlainObject:function(b){if(!b||toString.call(b)!=="[object Object]"||b.nodeType||b.setInterval)return false;if(b.constructor&&!e.call(b,"constructor")&&!e.call(b.constructor.prototype,"isPrototypeOf"))return false;var d;for(d in b);return d===undefined||e.call(b,d)},isEmptyObject:function(b){for(var d in b)return false;return true},isXmlDocument:function(b){return toString.call(b)===
"[object Document]"},contains:function(b,d){var f=b,o=arguments,k=1;if(d&&a.isArray(d)){o=d;k=0}for(k=k;k<o;k++)f=f&&typeof foo[o[k]]!=="undefined";return f},newModule:function(b){b=a.extend({id:null,requires:[],parent:null},b);if(b.parent)b=a.extend({},b.parent,b);return b},toID:function(b){return b.replace(/\s/g,"-")},objId:function(b){return(b?b:"obj")+h++}};return a}();
GT.Log=function(){function e(f,o){var k,m=o&&o.length>0?o[0]:"";for(k=1;o&&k<o.length;k++)m+=" "+(a&&GT.isPlainObject(o[k])?JSON.stringify(o[k]):o[k]);typeof console!=="undefined"&&console[f](m);for(k=0;k<h.length;k++)h[k].call(d,m,f)}var h=[],a=typeof JSON!=="undefined",b=window.console&&window.console.markTimeline,d={id:"GRUNT.log",getTraceTicks:function(){return b?(new Date).getTime():null},trace:function(f,o){if(b)console.markTimeline(f+(o?": "+(d.getTraceTicks()-o)+"ms":""))},debug:function(){e("debug",
arguments)},info:function(){e("info",arguments)},warn:function(){e("warn",arguments)},error:function(){e("error",arguments)},exception:function(f){d.error(arguments);for(var o in f)d.info("ERROR DETAIL: "+o+": "+f[o])},watch:function(f,o){try{o()}catch(k){d.exception(k,f)}},throwError:function(f){d.error(f);throw Error(f);},requestUpdates:function(f){h.push(f)}};return d}();
GT.Data=function(){var e={determineObjectMapping:function(a){if(!a)return null;a=a.split("|");for(var b={},d=0;d<a.length;d++)b[a[d]]=d;return b},mapLineToObject:function(a,b){var d=a.split("|"),f={};for(var o in b){var k=b[o];f[o]=d.length>k?d[k]:null}return f},parse:function(a){var b=null,d=[];a=a.split("\n");for(var f=0;f<a.length;f++){var o=a[f];if(b)d.push(e.mapLineToObject(o,b));else b=e.determineObjectMapping(o)}return d}},h={supportedFormats:{JSON:{parse:function(a){return JSON.parse(a)}},
PDON:{parse:function(a){return e.parse(a)}}},parse:function(a){a=GT.extend({data:"",format:"JSON"},a);if(!h.supportedFormats[a.format])throw Error("Unsupported data format: "+a.format+", cannot parse data in javascript object");try{return h.supportedFormats[a.format].parse(a.data)}catch(b){GT.Log.error("ERROR PARSING DATA FROM FORMAT: "+a.format,a.data);GT.Log.exception(b)}return{}}};return h}();
GT.paramTweaker=function(e,h,a){return function(b,d){if(typeof d!=="undefined"){if(b in e)e[b]=d;a&&b in a&&a[b](b,d)}else return h&&b in h?h[b](b):e[b]}};
GT.configurable=function(e,h,a,b){function d(f){e[f]||(e[f]=function(o){return e.configure(f,o)})}if(e){if(!e.configurableSettings){e.configurableId=GT.objId("configurable");e.configurableSettings={};e.configCallbacks=[];if(!GT.configurables)GT.configurables={}}GT.configurables[e.configurableId]=e;e.configCallbacks.push(a);for(a=h.length;a--;){e.configurableSettings[h[a]]=true;b&&d(h[a])}if(!e.configure)e.configure=function(f,o){var k=e.configCallbacks;if(e.configurableSettings[f]){for(var m=k.length;m--;){var n=
k[m](f,o);if(typeof n!=="undefined")return n}return GT.configurables[e.configurableId]}return null}}};GT.Template=function(){var e=/\$\{(.*?)\}/ig;return{parse:function(h,a){for(var b=h,d=e.exec(b);d;){b=b.replace(d[0],GT.XPath.first(d[1],a));e.lastIndex=0;d=e.exec(b)}return b}}}();
(function(){function e(d){var f=document.createElement("script"),o=false;f.src=d;f.async=true;f.onload=f.onreadystatechange=function(){if(!o&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){o=true;f.onload=f.onreadystatechange=null;f&&f.parentNode&&f.parentNode.removeChild(f)}};a||(a=document.getElementsByTagName("head")[0]);a.appendChild(f)}var h=0,a,b=this;GT.jsonp=function(d,f,o){d+=d.indexOf("?")>=0?"&":"?";var k="json"+ ++h;b[k]=function(m){f(m);b[k]=null;try{delete b[k]}catch(n){}};
e(d+(o?o:"callback")+"="+k);return k}})();
(function(){function e(){if(this.readyState===4){var k=null,m=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(m)if(params.handleResponse)params.handleResponse(this);else{var n=params,g=this.getResponseHeader(o.CONTENT_TYPE),p,t=false;for(p in h)if(g&&g.indexOf(h[p])>=0){t=true;break}g=!t;for(t=0;t<b.length;t++)g=g||b[t]==p;if(g)b:{g=p;for(var s in a)for(t=0;t<a[s].length;t++)if(RegExp(a[s][t]+"$","i").test(n.url)){p=
s;break b}p=g?g:"DEFAULT"}try{k=f[p](this,n)}catch(q){k=f.DEFAULT(this,n)}}else params.error&&params.error(this)}catch(u){GT.Log.exception(u,"PROCESSING AJAX RESPONSE")}m&&k&&params.success&&params.success.call(this,k)}}var h={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},a={JSON:["json"],PDON:["pdon.txt"]},b=["TEXT","STREAM"],d=/^(\w+:)?\/\/([^\/?#]+)/,f={XML:function(k){return k.responseXML},JSON:function(k){try{return JSON.parse(k.responseText)}catch(m){GT.Log.error("Error parsing JSON data: ",
k.responseText);GT.Log.exception(m)}return""},PDON:function(k){return GT.Data.parse({data:k.responseText,format:"PDON"})},DEFAULT:function(k){return k.responseText}},o={CONTENT_TYPE:"Content-Type"};GT.xhr=function(k){try{k=GT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},module.ajaxSettings,k);var m=d.exec(k.url),n=m&&(m[1]&&m[1]!==location.protocol||m[2]!==location.host);if(k.data)k.method="POST";if(k.url){m=
null;if(k.xhr)m=k.xhr(k);m||(m=new XMLHttpRequest);m.open(k.method,k.url,k.async);k.data&&m.setRequestHeader("Content-Type",k.contentType);n||m.setRequestHeader("X-Requested-With","XMLHttpRequest");m.onreadystatechange=e;m.send(k.method=="POST"?module.param(k.data):null)}else GT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(g){GT.Log.exception(g)}}})();
GT.XPath=function(){function e(d){for(var f=null,o=0;o<h.length;o++)if(f=h[o](d))break;return f}var h=[],a=[null,function(d){return d.numberValue},function(d){return d.stringValue},function(d){return d.booleanValue},null,null,null,null,function(d){return d.singleNodeValue?d.singleNodeValue.textContent:null},function(d){return d.singleNodeValue?d.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GT.Log.warn("No XPATH support, this is going to cause problems");var b={SearchResult:function(d){return{toString:function(){var f=
null;if(d){var o=null;if(d.resultType>=0&&d.resultType<a.length)o=a[d.resultType];if(o)f=o(d)}return f?f:""}}},first:function(d,f){var o=b.SearchResult,k;var m=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!m)m=XPathResult.ANY_TYPE;try{if(GT.isXmlDocument(f))k=f.evaluate(d,f,e,m,null);else{GT.Log.warn("attempted xpath expression: "+d+" on a non-xml document");k=null}}catch(n){GT.Log.warn("attempted to run invalid xpath expression: "+d+" on node: "+f);k=null}return new o(k)},registerResolver:function(d){h.push(d)}};
return b}();
GT.observable=function(e){if(e){if(!e.observableHandlers)e.observableHandlers={};if(!(e.bind||e.trigger||e.unbind)){e.bind=function(h,a){var b=GT.objId("callback"),d=e.observableHandlers;d[h]||(d[h]=[]);e.observableHandlers[h].push({callback:a,callbackId:b});return b};e.trigger=function(h){var a=e.observableHandlers[h];if(!a)return e;for(var b=a.length;b--;)a[b].callback.apply(self,Array.prototype.slice.call(arguments,1));return e};e.unbind=function(h,a){for(var b=e.observableHandlers[h],d=0;b&&d<
b.length;d++)if(b[d].callbackId===a){b.splice(d,1);break}return e}}}};GT.WaterCooler=function(){var e={},h=[];return{addPipe:function(a){a("pipe.test",{});h.push(a)},listen:function(a,b){e[a]||(e[a]=[]);b&&e[a].push(b)},say:function(a,b){var d;for(d=h.length;d--;)h[d](a,b);if(e[a])for(d=e[a].length;d--;)e[a][d](b)},leave:function(){}}}();
GT.Storage=function(){function e(h){if(h&&h=="session")return sessionStorage;return localStorage}return{get:function(h,a){var b=e(a).getItem(h);return/^(\{|\[).*(\}|\])$/.test(b)?JSON.parse(b):b},set:function(h,a,b){a=jQuery.isArray(a)||jQuery.isPlainObject(a)?JSON.stringify(a):a;e(b).setItem(h,a)},remove:function(h,a){e(a).removeItem(h)}}}();
GT.ParseRules=function(){var e=[];return{add:function(h,a){e.push({regex:h,handler:a})},each:function(h,a,b){function d(){f++;b&&f>=e.length&&b(a)}for(var f=0,o=0;o<e.length;o++){var k=e[o].regex,m=e[o].handler,n=false;if(k){k.lastIndex=-1;if((k=k.exec(h))&&m){n=true;m(k,a,d)&&d()}}n||d()}}}};
T5=function(){var e={ex:GT.extend,newCanvas:function(h,a){var b=document.createElement("canvas");typeof G_vmlCanvasManager!=="undefined"&&G_vmlCanvasManager.initElement(b);b.width=h?h:0;b.height=a?a:0;return b},time:function(){return(new Date).getTime()},Vector:function(h,a){return{x:h?h:0,y:a?a:0}},V:function(){function h(a){if(!a||a.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var b={edges:Array(a.length-1),accrued:Array(a.length-1),total:0},
d=T5.V.diff,f=0;f<a.length-1;f++){var o=d(a[f],a[f+1]);b.edges[f]=Math.sqrt(o.x*o.x+o.y*o.y);b.accrued[f]=b.total+b.edges[f];b.total+=b.edges[f]}return b}return{create:function(a,b){return new e.Vector(a,b)},add:function(){for(var a=new e.Vector,b=arguments.length;b--;){a.x+=arguments[b].x;a.y+=arguments[b].y}return a},absSize:function(a){return Math.max(Math.abs(a.x),Math.abs(a.y))},diff:function(a,b){return new e.Vector(a.x-b.x,a.y-b.y)},copy:function(a){return a?new e.Vector(a.x,a.y):null},invert:function(a){return new T5.Vector(-a.x,
-a.y)},offset:function(a,b,d){return new T5.Vector(a.x+b,a.y+(d?d:b))},edges:h,distance:function(a){return h(a).total},theta:function(a,b,d){d=Math.asin((a.y-b.y)/d);return a.x>b.x?d:Math.PI-d},pointOnEdge:function(a,b,d,f){b=new T5.Vector(Math.cos(d)*f,Math.sin(d)*f);return new T5.Vector(a.x-b.x,a.y-b.y)},getRect:function(a){var b=a.length;if(b>1)return new T5.Rect(Math.min(a[0].x,a[b-1].x),Math.min(a[0].y,a[b-1].y),Math.abs(a[0].x-a[b-1].x),Math.abs(a[0].y-a[b-1].y))},toString:function(a){return a.x+
", "+a.y}}}(),Dimensions:function(h,a){return{width:h?h:0,height:a?a:0}},D:function(){return{getAspectRatio:function(h){return h.height!==0?h.width/h.height:1},getCenter:function(h){return new e.Vector(h.width/2,h.height/2)},getSize:function(h){return Math.sqrt(Math.pow(h.width,2)+Math.pow(h.height,2))}}}(),Rect:function(h,a,b,d){return{origin:new e.Vector(h,a),dimensions:new e.Dimensions(b,d)}},R:function(){return{copy:function(h){return h?new e.Rect(h.origin.x,h.origin.y,h.dimensions.width,h.dimensions.height):
null},getCenter:function(h){return new T5.Vector(h.origin.x+h.dimensions.width/2,h.origin.y+h.dimensions.height/2)}}}()};return e}();
(function(){function e(){for(;g.length>0;){var t=g.shift();document.location=t}n=0}function h(t){for(var s=true,q=p.length;q--;)s=s&&t!=p[q];return s}function a(t,s){var q=[];for(var u in s)u&&q.push(u+"="+escape(s[u]));return"tile5://"+t+"/"+(q.length>0?"?"+q.join("&"):"")}function b(t,s){h(t)&&GT.Log.info("would push url: "+a(t,s))}function d(t,s){if(h(t)){g.push(a(t,s));n||(n=setTimeout(e,100))}}function f(){o={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in document,imageCacheMaxSize:null,
getScaling:function(){return 1},maxImageLoads:null,requireFastDraw:false,bridgeNotify:b,targetFps:null},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:false,bridgeNotify:d,targetFps:25},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:d},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:d},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,supportsTouch:true,getScaling:function(){return 1/
window.devicePixelRatio},bridgeNotify:d},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:d}};k=[o.froyo,o.android,o.ipod,o.iphone,o.ipad]}var o=null,k=[],m=null,n=0,g=[],p=["view.wake","tile.loaded"];T5.getConfig=function(){o||f();if(!m){GT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var t=0;t<k.length;t++){var s=k[t];if(s.regex&&s.regex.test(navigator.userAgent)){m=T5.ex({},o.base,s);GT.Log.info("PLATFORM DETECTED AS: "+
m.name);break}}if(!m){GT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");m=o.base}GT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return m}})();
T5.Resources=function(){var e="",h={},a={getPath:function(b){return/^(file|https?|\/)/.test(b)?b:e+b},setBasePath:function(b){e=b},loadResource:function(b){b=T5.ex({filename:"",cacheable:true,dataType:null,callback:null},b);var d=function(f){b.callback&&GT.Log.watch("CALLING RESOURCE CALLBACK",function(){b.callback(f)})};b.cacheable&&h[b.filename]?d(h[b.filename]):GT.xhr({url:a.getPath(b.filename),dataType:b.dataType,success:function(f){if(b.cacheable)h[b.filename]=f;d(f)},error:function(f,o,k){GT.Log.error("error loading resource ["+
b.filename+"], error = "+k)}})},loadSnippet:function(b,d){/\.\w+$/.test(b)||(b+=".html");a.loadResource({filename:"snippets/"+b,callback:d,dataType:"html"})}};return a}();
T5.Images=function(){function e(){var q=f[this.id];if(q&&q.image.complete&&q.image.width>0){q.loaded=true;q.hitCount=1;for(var u=m.length;u--;)if(m[u].image.src==this.src){m.splice(u,1);break}if(q.background||q.postProcess)if(q.image){u=T5.newCanvas(q.realSize?q.realSize.width:image.width,q.realSize?q.realSize.height:image.height);var l=u.getContext("2d"),r=q.offset?q.offset:new T5.Vector;q.background&&l.drawImage(q.background,0,0);l.drawImage(q.image,r.x,r.y);q.postProcess&&q.postProcess(l,q);q.image=
u}q.loadCallback&&q.loadCallback(this,false);n.push({url:this.src,created:q.requested});delete f[this.id];h()}}function h(){for(var q=T5.getConfig().maxImageLoads;k.length>0&&(!q||m.length<q);){var u=k.shift();if(u.imageLoader){m.push(u);u.imageLoader(u,e)}}}function a(q){for(var u=null,l=g.length;l--&&!u;)u=g[l](q);return u?u:function(r,v){r.image.onload=v;r.image.src=T5.Resources.getPath(r.url);r.requested=T5.time()}}function b(){t=true;try{var q=Math.floor(n.length/2);if(q>0){n.sort(function(l,
r){return l.created-r.created});for(var u=q;u--;)delete d[n[u].url];n.splice(0,q)}}finally{t=false}GT.WaterCooler.say("imagecache.cleared")}var d={},f={},o=0,k=[],m=[],n=[],g=[],p=0,t=false,s={avgImageSize:25,loadTimeout:10,addInterceptor:function(q){g.push(q)},cancelLoad:function(){m=[]},get:function(q){var u=null,l=null;t||(u=d[q]);if((l=u?u.image:null)&&(l.getContext||l.complete&&l.width>0))return l},load:function(q,u,l){var r=d[q];if(r){r.hitCount++;r.image.complete&&u&&u(r.image,true)}else{r=
T5.ex({url:q,image:new Image,loaded:false,imageLoader:a(q),created:T5.time(),requested:null,hitCount:0,loadCallback:u},l);r.image.id="resourceLoaderImage"+o++;d[q]=r;f[r.image.id]=r;k.push(r);h()}return r},stats:function(){return{imageLoadingCount:m.length,queuedImageCount:k.length,imageCacheFullness:p}}};setInterval(function(){for(var q=T5.time(),u=false,l=0,r=T5.getConfig();l<m.length;)if(q-m[l].requested>s.loadTimeout*1E3){m.splice(l,1);u=true}else l++;u&&h();if(r&&r.imageCacheMaxSize){p=n.length*
s.avgImageSize/r.imageCacheMaxSize;p>=1&&b()}},1E3);return s}();
T5.Touch=function(){function e(s,q){var u=s&&s.length>0?s[0]:null;if(u&&q&&q.length>0)return T5.V.diff(u,q[0]);return null}function h(s){s.preventDefault();s.stopPropagation()}function a(s){for(var q=Array(s.length),u=s.length;u--;)q[u]=new T5.Vector(s[u].pageX,s[u].pageY);return q}function b(s){return[new T5.Vector(s.pageX,s.pageY)]}var d=120,f=100,o=250,k={TAP:0,MOVE:1,PINCH:2},m=7,n=0,g=0,p=function(s){function q(x,H,L,K){var T=Math.asin((x.y-H.y)/L);L=Math.min(Math.floor(L*($.duration/K)),$.max);
T=H.x>x.x?T:Math.PI-T;x=new T5.Vector(Math.cos(T)*-L,Math.sin(T)*L);r("inertiaPan",x.x,x.y)}function u(x,H){var L,K;if(C){L=H-W;if(L<o){K=T5.V.distance([D[0],x]);K>s.inertiaTrigger&&q(D[0],x,K,L)}}else{V=x;var T=setInterval(function(){L=T5.time()-H;K=T5.V.distance([x,V]);if(L<f&&K>s.inertiaTrigger){clearInterval(T);q(x,V,K,L)}else L>f&&clearInterval(T)},5)}}function l(x){for(var H=[],L=s.element?-s.element.offsetLeft:0,K=s.element?-s.element.offsetTop:0,T=x.length;T--;)H.push(T5.V.offset(x[T],L,K));
return H}function r(){s.observable&&s.observable.trigger.apply(null,arguments)}function v(x){if(x.target&&x.target===s.element){D=C?a(x.touches):b(x);M=new T5.Vector;Q=new T5.Vector;S=true;y=false;W=T5.time();h(x);x.target.style.cursor="move";r("inertiaCancel");Y.current=W;if(x=D.length>0?D[0]:null){r("touchStart",x.x,x.y);if(Y.current-Y.last<fa.THRESHOLD_DOUBLETAP)if((x=I?T5.V.diff(D[0],I[0]):null)&&Math.abs(x.x)<s.maxDistDoubleTap&&Math.abs(x.y)<s.maxDistDoubleTap)y=true;P=k.TAP;I=[].concat(D)}else GT.Log.warn("Touch start fired, but no touch vector found")}}
function z(x){if(x.target&&x.target===s.element){V=(C?a(x.touches):b(x))[0];if(S){C&&h(x);x=C?a(x.touches):b(x);var H=0;if(x.length>1){if(D.length===1)D=[].concat(x);H=T5.V.distance(D)-T5.V.distance(x)}if(P===k.TAP){var L=e(x,D);if(L&&(Math.abs(L.x)>=m||Math.abs(L.y)>=m))P=k.MOVE}if(P!==k.TAP)if(!H||Math.abs(H)<s.pinchZoomThreshold){if(M=e(x,I)){Q.x-=M.x;Q.y-=M.y;G.x-=M.x;G.y-=M.y}if(T5.V.absSize(G)>s.panEventThreshhold){r("pan",G.x,G.y);G=T5.V.create()}P=k.MOVE}else{r("pinchZoom",l(D),l(x));P=k.PINCH}I=
[].concat(x)}}}function B(x){if(x.target&&x.target===s.element){var H=(C?a(x.changedTouches):b(x))[0];C&&h(x);var L=T5.time();Y.last=Y.current;if(P===k.TAP)E||(E=setTimeout(function(){E=0;var K=y?"doubleTap":"tap",T=D[0],ba=null;if(s.element)ba=T5.V.offset(T,-s.element.offsetLeft,-s.element.offsetTop);r(K,T,ba)},fa.THRESHOLD_DOUBLETAP+50));else if(P==k.MOVE){r("panEnd",Q.x,Q.y);$&&u(H,L)}else P==k.PINCH&&r("pinchZoomEnd",l(D),l(I),L-W);x.target.style.cursor="default";S=false}}function F(x){if(x.target&&
x.target===s.element){var H;if(x.detail){H=-x.detail*d;H=new T5.Vector(x.axis===1?H:0,x.axis===2?H:0)}else H=new T5.Vector(x.wheelDeltaX,x.wheelDeltaY);var L=H.y!==0?Math.abs(H.y/d):0;if(V&&L!==0){var K=T5.V.offset(V,-s.element.offsetLeft,-s.element.offsetTop);r("wheelZoom",K,Math.pow(2,H.y>0?L:-L))}x.preventDefault()}}s=T5.ex({element:null,observable:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,
pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},s);var y=false,E=0,C=T5.getConfig().supportsTouch,D=null,I=null,M=null,Q=null,G=new T5.Vector,P=null,S=false,W=0,X=[],V=null,$=null,Y={current:0,last:0},R=T5.getConfig(),fa={supportsTouch:C,THRESHOLD_DOUBLETAP:300,addListeners:function(x){X.push(x)},decoupleListeners:function(x){for(var H=0;x&&H<X.length;H++)if(X[H].listenerId===x){X.splice(H,1);GT.Log.info("successfully decoupled touch listener: "+x);break}},release:function(){R.eventTarget.removeEventListener(R.supportsTouch?
"touchstart":"mousedown",v,false);R.eventTarget.removeEventListener(R.supportsTouch?"touchmove":"mousemove",z,false);R.eventTarget.removeEventListener(R.supportsTouch?"touchend":"mouseup",B,false);if(!R.supportsTouch){window.removeEventListener("mousewheel",F,false);window.removeEventListener("DOMMouseScroll",F,false)}},inertiaEnable:function(x,H){$={duration:x,max:H?Math.min(H.width,H.height):500}},inertiaDisable:function(){$=null}};R.eventTarget.addEventListener(R.supportsTouch?"touchstart":"mousedown",
v,false);R.eventTarget.addEventListener(R.supportsTouch?"touchmove":"mousemove",z,false);R.eventTarget.addEventListener(R.supportsTouch?"touchend":"mouseup",B,false);if(!R.supportsTouch){window.addEventListener("mousewheel",F,false);window.addEventListener("DOMMouseScroll",F,false)}return fa},t=[];return{capture:function(s,q){if(!s)throw Error("Unable to capture touch of null element");if(!s.id)s.id="touchable_"+n++;var u=t[s.id];if(!u){u=new p(T5.ex({element:s},q));t[s.id]=u;GT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+
u.supportsTouch)}q.listenerId&&u.decoupleListeners(q.listenerId);q.listenerId=++g;u.addListeners(q);return u},resetTouch:function(s){if(s&&s.id&&t[s.id]){t[s.id].release();delete t[s.id]}}}}();
T5.Dispatcher=function(){var e=[],h={execute:function(a){var b=h.findAction(a);b&&b.execute.apply(b,Array.prototype.slice.call(arguments,1))},findAction:function(a){for(var b=e.length;b--;)if(e[b].id==a)return e[b];return null},getRegisteredActions:function(){return[].concat(e)},getRegisteredActionIds:function(){for(var a=[],b=e.length;b--;)e[b].id&&a.push(e[b].id);return a},registerAction:function(a){a&&a.id&&e.push(a)},Action:function(a){a=T5.ex({autoRegister:true,id:"",title:"",icon:"",execute:null},
a);var b={id:a.id,execute:function(){a.execute&&a.execute.apply(this,arguments)},getParam:function(d){return a[d]?a[d]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",b.id,a.title,a.icon)}};a.autoRegister&&h.registerAction(b);return b},Agent:function(a){a=GT.extend({name:"Untitled",translator:null,execute:null},a);var b={getName:function(){return a.name},getParam:function(d){return a[d]},getId:function(){return GT.toID(b.getName())},run:function(d,f){if(a.execute){var o=
a.translator?a.translator(d):d;a.execute.call(b,o,function(k,m){f&&f(k,m,o)})}}};return b},runAgents:function(a,b,d){for(var f=0;f<a.length;f++)a[f].run(b,d)}};return h}();
(function(){var e=1.70158,h={linear:function(a,b,d,f){return d*a/f+b},backin:function(a,b,d,f){return d*(a/=f)*a*((e+1)*a-e)+b},backout:function(a,b,d,f){return d*((a=a/f-1)*a*((e+1)*a+e)+1)+b},backinout:function(a,b,d,f){return(a/=f/2)<1?d/2*a*a*(((e*=1.525)+1)*a-e)+b:d/2*((a-=2)*a*(((e*=1.525)+1)*a+e)+2)+b},bouncein:function(a,b,d,f){return d-h.bounceout(f-a,0,d,f)+b},bounceout:function(a,b,d,f){return(a/=f)<1/2.75?d*7.5625*a*a+b:a<2/2.75?d*(7.5625*(a-=1.5/2.75)*a+0.75)+b:a<2.5/2.75?d*(7.5625*(a-=
2.25/2.75)*a+0.9375)+b:d*(7.5625*(a-=2.625/2.75)*a+0.984375)+b},bounceinout:function(a,b,d,f){return a<f/2?h.bouncein(a*2,0,d,f)/2+b:h.bounceout(a*2-f,0,d,f)/2+d/2+b},cubicin:function(a,b,d,f){return d*(a/=f)*a*a+b},cubicout:function(a,b,d,f){return d*((a=a/f-1)*a*a+1)+b},cubicinout:function(a,b,d,f){if((a/=f/2)<1)return d/2*a*a*a+b;return d/2*((a-=2)*a*a+2)+b},elasticin:function(a,b,d,f,o,k){if(a==0)return b;if((a/=f)==1)return b+d;k||(k=f*0.3);if(!o||o<Math.abs(d)){o=d;d=k/4}else d=k/(2*Math.PI)*
Math.asin(d/o);return-(o*Math.pow(2,10*(a-=1))*Math.sin((a*f-d)*2*Math.PI/k))+b},elasticout:function(a,b,d,f,o,k){var m;if(a==0)return b;if((a/=f)==1)return b+d;k||(k=f*0.3);if(!o||o<Math.abs(d)){o=d;m=k/4}else m=k/(2*Math.PI)*Math.asin(d/o);return o*Math.pow(2,-10*a)*Math.sin((a*f-m)*2*Math.PI/k)+d+b},elasticinout:function(a,b,d,f,o,k){var m;if(a==0)return b;if((a/=f/2)==2)return b+d;k||(k=f*0.3*1.5);if(!o||o<Math.abs(d)){o=d;m=k/4}else m=k/(2*Math.PI)*Math.asin(d/o);if(a<1)return-0.5*o*Math.pow(2,
10*(a-=1))*Math.sin((a*f-m)*2*Math.PI/k)+b;return o*Math.pow(2,-10*(a-=1))*Math.sin((a*f-m)*2*Math.PI/k)*0.5+d+b},quadin:function(a,b,d,f){return d*(a/=f)*a+b},quadout:function(a,b,d,f){return-d*(a/=f)*(a-2)+b},quadinout:function(a,b,d,f){if((a/=f/2)<1)return d/2*a*a+b;return-d/2*(--a*(a-2)-1)+b},sinein:function(a,b,d,f){return-d*Math.cos(a/f*(Math.PI/2))+d+b},sineout:function(a,b,d,f){return d*Math.sin(a/f*(Math.PI/2))+b},sineinout:function(a,b,d,f){return-d/2*(Math.cos(Math.PI*a/f)-1)+b}};T5.easing=
function(a){return h[a.replace(/[\-\_\s\.]/g,"").toLowerCase()]};T5.registerEasingType=function(a,b){h[a.replace(/[\-\_\s\.]/g,"").toLowerCase()]=b}})();
T5.Tween=function(e){e=T5.ex({target:null,property:null,startValue:0,endValue:null,duration:2E3,tweenFn:T5.easing("sine.out"),complete:null,cancelOnInteract:false},e);var h=T5.time(),a=[],b=false,d=0,f=0,o={cancelOnInteract:e.cancelOnInteract,isComplete:function(){return b},triggerComplete:function(k){e.complete&&e.complete(k)},update:function(k){try{var m=e.tweenFn(k-h,d,f,e.duration);if(e.target)e.target[e.property]=m;for(var n=a.length;n--;)a[n](m,void 0);if(b=h+e.duration<=k){if(e.target)e.target[e.property]=
e.tweenFn(e.duration,d,f,e.duration);for(var g=a.length;g--;)a[g](m,true)}}catch(p){GT.Log.exception(p)}},requestUpdates:function(k){a.push(k)}};d=e.target&&e.property&&e.target[e.property]?e.target[e.property]:e.startValue;if(typeof e.endValue!=="undefined")f=e.endValue-d;if(f==0)b=true;T5.wakeTweens();return o};
(function(){var e=[],h=false,a=0;T5.tweenValue=function(b,d,f,o,k){b=new T5.Tween({startValue:b,endValue:d,tweenFn:f,complete:o,duration:k});e.push(b);return b};T5.tween=function(b,d,f,o,k,m){b=new T5.Tween({target:b,property:d,endValue:f,tweenFn:o,duration:m,complete:k});e.push(b);return b};T5.tweenVector=function(b,d,f,o,k,m){var n=[];if(b){var g=b.x==d,p=b.y==f;g||n.push(T5.tween(b,"x",d,o,function(){(g=true)&&p&&k()},m));p||n.push(T5.tween(b,"y",f,o,function(){p=true;g&&p&&k()},m))}return n};
T5.cancelAnimation=function(b){if(!h){h=true;try{for(var d=0;d<e.length;)if(!b||b(e[d])){e[d].triggerComplete(true);e.splice(d,1)}else d++}finally{h=false}}};T5.isTweening=function(){return e.length>0};T5.wakeTweens=function(){if(a===0)a=setInterval(function(){var b;b=T5.time();if(!h){h=true;try{for(var d=0;d<e.length;)if(e[d].isComplete()){e[d].triggerComplete(false);e.splice(d,1)}else{e[d].update(b);d++}}finally{h=false}}b=e.length;if(b===0){clearInterval(a);a=0}},20)}})();
(function(){var e={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCH:16,FREEZE:128};T5.viewState=function(){for(var h=0,a=arguments.length;a--;){var b=e[arguments[a].toUpperCase()];if(b)h|=b}return h}})();
T5.ViewLayer=function(e){e=T5.ex({id:"",centerOnScale:true,created:T5.time(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:T5.viewState("ACTIVE","ANIMATING","PAN","PINCH")},e);var h=null,a=e.id,b=T5.viewState("ACTIVE"),d=T5.ex({addToView:function(f){f.setLayer(a,d)},shouldDraw:function(f){var o=h?h.fastDraw&&f!==b:false;return(f&e.validStates)!==0&&(o?e.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GT.WaterCooler.say("layer.remove",{id:a})},
wakeParent:function(){h&&h.trigger("wake")},getId:function(){return a},setId:function(f){a=f},getParent:function(){return h},setParent:function(f){h=f}},e);GT.observable(d);return d};
T5.View=function(e){function h(w,A,J,N){S=typeof J!=="undefined";Z=ja;l();O.updateOffset(B.x+w,B.y+A,J,N)}function a(w,A){e.inertia&&h(w,A,e.panAnimationEasing,e.panAnimationDuration)}function b(){Z=ia;S=false;setTimeout(l,50)}function d(w,A){H=T5.V.getRect(w);L=T5.V.getRect(A);var J=T5.D.getSize(H.dimensions),N=T5.D.getSize(L.dimensions);ea=T5.R.getCenter(H);G=T5.R.getCenter(L);K=H&&J!==0?N/J:1}function f(w,A){d(w,A);if(x=K!==1){Z=ga;l()}}function o(w,A,J){d(w,A);if(e.adjustScaleFactor){K=e.adjustScaleFactor(K);
GT.Log.info("scale factor adjusted to: "+K)}if(J<e.pinchZoomAnimateTrigger){p(T,K,ea,t(),T5.easing("sine.out"),function(){m();K=1},300);K=T}else{m();K=1}}function k(w,A){O.zoom(w,Math.min(Math.pow(2,Math.round(Math.log(A))),8),500)}function m(){x=false;O.trigger("scale",K,H?t():G);Z=ia;l()}function n(){if(v){T5.Touch.resetTouch(v);if(e.autoSize){v.height=window.innerHeight-v.offsetTop;v.width=window.innerWidth-v.offsetLeft}try{z=v.getContext("2d");z.globalCompositeOperation=e.initialDrawMode;z.clearRect(0,
0,v.width,v.height)}catch(w){GT.Log.exception(w);throw Error("Could not initialise canvas on specified view element");}ka=T5.Touch.capture(v,{observable:O});e.inertia&&ka.inertiaEnable(e.panAnimationDuration,D);D=O.getDimensions();I=T5.D.getCenter(D);l()}}function g(w,A){A.setId(w);A.setParent(O);r.push(A);r.sort(function(J,N){var U=N.zindex-J.zindex;if(U===0)U=N.created-J.created;return U})}function p(w,A,J,N,U,aa,ca){function ha(){aa&&aa();m();K=1;ba=null}x=true;ea=T5.V.copy(J);G=T5.V.copy(N);H=
null;if(U)T5.tweenValue(0,A-w,U,ha,ca?ca:1E3).requestUpdates(function(da){ba=da/(A-w);K=w+da;Z=ga;l();O.trigger("animate")});else{K=targetScaleFactor;ha()}}function t(){var w=T5.D.getCenter(D),A=T5.V.distance([G,w]),J=T5.V.theta(G,w,A),N=T5.V.diff(ea,G);w=T5.V.pointOnEdge(G,w,J,A/K);w.x+=N.x;w.y+=N.y;return w}function s(){O.trigger("idle");P=true;V=0}function q(w,A){var J=0,N=E?T5.viewState("FROZEN"):Z,U=T5.time(),aa=(N&ga)!==0,ca=0;if(F||aa){w.clearRect(0,0,v.width,v.height);F=false}if(aa){T5.D.getCenter(D);
var ha=(ba?ba:1)/2,da=T5.V.diff(ea,G);if(Y=H?new T5.Vector(G.x+da.x,G.y+da.y):new T5.Vector(G.x-da.x*ha,G.y-da.y*ha))A=T5.V.offset(A,Y.x,Y.y)}w.save();try{T=K;if(C!==1)w.scale(C,C);else if(aa){w.translate(G.x,G.y);w.scale(K,K)}for(ca=r.length;ca--;)if(r[ca].shouldDraw(N)){var la=r[ca].draw(w,A,D,N,O);J+=la?la:0}}finally{w.restore()}GT.Log.trace("draw complete",U);X=false;return J}function u(){var w=0,A=!S&&(Z===ga||Z===ja);R=T5.time();B.x=Math.floor(B.x);B.y=Math.floor(B.y);Q&&y&&Q.delays.push(R-
y);if(A){T5.cancelAnimation(function(N){return N.cancelOnInteract});P=false;if(V!==0){clearTimeout(V);V=0}}for(A=r.length;A--;){var J=r[A].cycle(R,B,Z);w+=J?J:0}if(y+fa<R){w+=q(z,B);y=R}W=0;if(M+w>0)l();else if(!P&&V===0)V=setTimeout(s,500);GT.Log.trace("Completed draw cycle",R)}function l(){M++;if(!(E||W!==0)){M=0;W=setTimeout(u,0)}}e=T5.ex({id:GT.objId("view"),container:"",clearOnDraw:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,
defaultFreezeDelay:500,inertia:true,pannable:true,scalable:true,panAnimationEasing:T5.easing("sine.out"),panAnimationDuration:750,pinchZoomAnimateTrigger:400,adjustScaleFactor:null,autoSize:false},e);var r=[],v=document.getElementById(e.container),z=null,B=new T5.Vector,F=false,y=null,E=false,C=1,D=null,I=null,M=0,Q=null,G=null,P=false,S=false,W=0,X=false,V=0,$=0,Y=null,R=0;T5.getConfig();var fa=0,x=false,H=null,L=null,K=1,T=1,ba=null,ea=null,ka=null,ia=T5.viewState("ACTIVE"),ja=T5.viewState("PAN"),
ga=T5.viewState("PINCH"),Z=ia,O={id:e.id,deviceScaling:C,fastDraw:e.fastDraw||T5.getConfig().requireFastDraw,animate:function(w,A,J,N,U){p(K,w,A,J,N,U)},centerOn:function(w){O.setOffset(w.x-v.width/2,w.y-v.height/2)},getDimensions:function(){if(v)return new T5.Dimensions(v.width,v.height)},getZoomCenter:function(){return Y},getLayer:function(w){for(var A=0;A<r.length;A++)if(r[A].getId()==w)return r[A];return null},setLayer:function(w,A){for(var J=0;J<r.length;J++)if(r[J].getId()===w){r.splice(J,1);
break}A&&g(w,A);l()},eachLayer:function(w){for(var A=0;A<r.length;A++)w(r[A])},clearBackground:function(){F=true},freeze:function(){E=true},unfreeze:function(){E=false;l()},needRepaint:function(){return X},snapshot:function(){},scale:function(w,A,J,N,U){N||(N=T5.D.getCenter(D));U||(U=T5.D.getCenter(D));O.animate(w,N,U,A,J);return O},removeLayer:function(w){a:{for(var A=r.length;A--;)if(r[A].getId()==w){w=A;break a}w=-1}if(w>=0&&w<r.length){GT.WaterCooler.say("layer.removed",{layer:r[w]});r.splice(w,
1)}},getOffset:function(){return T5.V.copy(B)},setOffset:function(w,A){B.x=w;B.y=A},updateOffset:function(w,A,J,N,U){function aa(){b(0,0);U&&U()}if(J){w=new T5.Vector(w,A);J=T5.tweenVector(B,w.x,w.y,J,aa,N);for(N=J.length;N--;){J[N].cancelOnInteract=true;J[N].requestUpdates(l)}}else O.setOffset(w,A)},zoom:function(w,A,J){S=false;K=A;x=K!==1;ea=T5.D.getCenter(O.getDimensions());G=K>1?T5.V.copy(w):T5.D.getCenter(O.getDimensions());H=null;clearTimeout($);if(x){Z=ga;l();if(J)$=setTimeout(function(){m();
K=1},parseInt(J,10))}}};GT.WaterCooler.listen("layer.remove",function(w){w.id&&O.removeLayer(w.id)});C=T5.getConfig().getScaling();GT.observable(O);O.bind("wake",l);O.bind("invalidate",function(){X=true});if(e.pannable){O.bind("pan",h);O.bind("panEnd",b);O.bind("inertiaPan",a);O.bind("inertiaCancel",function(){S=false;l()})}if(e.scalable){O.bind("pinchZoom",f);O.bind("pinchZoomEnd",o);O.bind("wheelZoom",k)}GT.configurable(O,["inertia","container"],GT.paramTweaker(e,null,{container:function(w,A){v=
document.getElementById(A);n()}}),true);n();return O};
T5.AnimatedPathLayer=function(e){function h(k,m,n){k.fillStyle="#FFFFFF";k.strokeStyle="#222222";k.beginPath();k.arc(n.x,n.y,4,0,Math.PI*2,false);k.stroke();k.fill()}e=T5.ex({path:[],id:GT.objId("pathAni"),easing:T5.easing("sine.inout"),validStates:T5.viewState("ACTIVE","PAN","PINCH"),drawIndicator:null,duration:2E3,autoCenter:false},e);var a=T5.V.edges(e.path),b,d=null,f=0;T5.tweenValue(0,a.total,e.easing,function(){o.remove()},e.duration).requestUpdates(function(k,m){f=k;m&&o.remove()});var o=T5.ex(new T5.ViewLayer(e),
{cycle:function(){for(var k=0;k<a.accrued.length&&a.accrued[k]<f;)k++;d=null;if(k<e.path.length-1){var m=f-(k>0?a.accrued[k-1]:0),n=e.path[k],g=e.path[k+1];b=T5.V.theta(n,g,a.edges[k]);d=T5.V.pointOnEdge(n,g,b,m);if(e.autoCenter)(k=o.getParent())&&k.centerOn(d)}return d?1:0},draw:function(k,m){if(d)(e.drawIndicator?e.drawIndicator:h)(k,m,new T5.Vector(d.x-m.x,d.y-m.y),b)}});return o};
(function(){T5.tileSize=256;T5.Tile=function(e){return e=T5.ex({x:0,y:0,gridX:0,gridY:0,dirty:false},e)};T5.ImageTile=function(e){e=T5.ex({url:"",sessionParamRegex:null,loaded:false},e);return new T5.Tile(e)}})();
T5.TileGrid=function(e){function h(y,E){var C=T5.Vector(y*k-g.x,E*k-g.y);return new T5.ImageTile({gridX:C.x,gridY:C.y})}function a(y,E,C,D){var I=Math.floor(e.gridSize*0.2),M=new T5.Vector;if(y<0||y+C>e.gridSize)M.x=y<0?-I:I;if(E<0||E+D>e.gridSize)M.y=E<0?-I:I;return M}function b(y,E,C){var D=GT.Log.getTraceTicks(),I=0,M=e.gridSize,Q=e.tileSize;new T5.Vector(M/2,M/2);if(C)f=[];if(y)for(C=0;C<M;C++)for(var G=0;G<M;G++){if(!f[I]){var P=y(G,C,m,M);P.gridX=G*Q-g.x;P.gridY=C*Q-g.y;f[I]=P}I++}n=y;p=E;GT.Log.trace("tile grid populated",
D);F.dirty=true;F.wakeParent()}function d(y,E){if(B){var C,D=[],I=new T5.Vector(Math.floor((y.x+g.x)*s),Math.floor((y.y+g.y)*s));tilesNeeded=false;for(var M=z;M--;)for(var Q=v;Q--;){C=Q+I.x>=0&&Q+I.x<e.gridSize?f[(M+I.y)*e.gridSize+(Q+I.x)]:null;var G=new T5.Vector(Q-B.x,M-B.y);if(!C){r=a(I.x,I.y,v,z);C=h(Q+I.x,M+I.y)}D.push({tile:C,centerness:T5.V.absSize(G)})}D.sort(function(P,S){return S.centerness-P.centerness});u||(u=Array(D.length));for(C=D.length;C--;){u[C]=D[C].tile;F.prepTile(u[C],E)}}}e=
T5.ex({tileSize:T5.tileSize,drawGrid:false,center:new T5.Vector,gridSize:25,shiftOrigin:null,supportFastDraw:true},e);var f=Array(Math.pow(e.gridSize,2)),o=e.gridSize,k=e.tileSize,m=T5.V.offset(e.center,-Math.ceil(e.gridSize>>1)),n=null,g=new T5.Vector,p=null,t=Math.round(e.tileSize/2),s=e.tileSize?1/e.tileSize:0,q=true,u=null,l=false;new T5.Vector;var r=new T5.Vector;T5.getConfig();o=o*e.tileSize;var v,z,B,F=T5.ex(new T5.ViewLayer(e),{gridDimensions:new T5.Dimensions(o,o),dirty:false,cycle:function(y,
E,C){y=0;if(r.x!==0||r.y!==0){var D=r,I=e.shiftOrigin;if(!(D.x===0&&D.y===0)){var M=GT.Log.getTraceTicks(),Q=Array(f.length);Q.length=f.length;for(var G=0;G<e.gridSize;G++)for(var P=0;P<e.gridSize;P++)Q[P*e.gridSize+G]=G+D.x>=0&&G+D.x<e.gridSize?f[(P+D.y)*e.gridSize+(G+D.x)]:null;f=Q;m=I?I(m,D):T5.V.add(m,D);g.x+=-D.x*e.tileSize;g.y+=-D.y*e.tileSize;GT.Log.trace("tile storage shifted",M);b(n,p)}r=new T5.Vector;y++}C!==T5.viewState("PINCH")&&d(E,C);return y+F.dirty?1:0},deactivate:function(){q=false},
find:function(y){if(!y)return null;for(var E=f.length;E--;){var C=f[E];if(C&&y(C))return C}return null},prepTile:function(){},drawTile:function(){return false},getTileSize:function(){return e.tileSize},draw:function(y,E,C,D,I){if(q){var M=T5.time(),Q=E.x;E=E.y;var G=true,P=I.needRepaint()||D===T5.viewState("PAN")||D===T5.viewState("PINCH")||T5.isTweening();if(!B){v=Math.ceil(C.width*s)+1;z=Math.ceil(C.height*s)+1;B=new T5.Vector(Math.floor((v-1)/2),Math.floor((z-1)/2))}if(u){if(e.drawGrid)y.strokeStyle=
"rgba(50, 50, 50, 0.3)";y.beginPath();for(C=u.length;C--;){var S=u[C];if(S){var W=S.gridX-Q,X=S.gridY-E;if(!(P?false:!S.dirty)){G=F.drawTile(y,S,W,X,D)&&G;S.x=W;S.y=X}}else G=false;e.drawGrid&&y.rect(W,X,e.tileSize,e.tileSize)}y.stroke();GT.Log.trace("drawn tiles",M);G&&!l&&I.trigger("tileDrawComplete");l=G;F.dirty=false}}},getTileAtXY:function(y,E){for(var C=e.tileSize,D=u?u.length:0;D--;){var I=u[D];if(I&&y>=I.x&&E>=I.y)if(y<=I.x+C&&E<=I.y+C)return I}return null},getTileVirtualXY:function(y,E,C){y=
T5.V.add(new T5.Vector(y,E),T5.V.invert(m),g);y=new T5.Vector(y.x*e.tileSize,y.y*e.tileSize);if(C){y.x+=t;y.y+=t}return y},populate:function(y){b(y,null,true)}});GT.WaterCooler.listen("imagecache.cleared",function(){for(var y=f.length;y--;)if(f[y])f[y].loaded=false});GT.WaterCooler.listen("tiler.repaint",function(){for(var y=f.length;y--;)if(f[y]){f[y].x=null;f[y].y=null}});return F};
T5.ImageTileGrid=function(e){function h(){n.getParent().trigger("invalidate");n.dirty=true;n.wakeParent()}e=T5.ex({emptyTile:function(g){if(!a||g!==a.width){a=T5.newCanvas(g,g);g=a.getContext("2d");g.fillStyle="rgba(150, 150, 150, 0.01)";g.fillRect(0,0,a.width,a.height)}return a}(T5.tileSize),panningTile:function(g){function p(){var t=T5.newCanvas(32,32),s=t.getContext("2d");s.fillStyle="#BBBBBB";s.fillRect(0,0,32,32);s.fillStyle="#C3C3C3";s.fillRect(0,0,16,16);s.fillRect(16,16,16,16);return t}if(!b||
g!==b.width){b=T5.newCanvas(g,g);g=b.getContext("2d");g.fillStyle=g.createPattern(p(),"repeat");g.fillRect(0,0,b.width,b.height)}return b}(T5.tileSize),tileOffset:new T5.Vector,tileDrawArgs:{}},e);var a=e.emptyTile,b=e.panningTile,d=T5.viewState("ACTIVE"),f=T5.viewState("PAN"),o=T5.getConfig().requireFastDraw,k=e.tileSize?e.tileSize:T5.tileSize,m=T5.ex({background:null,overlay:null,offset:new T5.Vector,realSize:new T5.Dimensions(k,k)},e.tileDrawArgs),n=T5.ex(new T5.TileGrid(e),{drawTile:function(g,
p,t,s,q){var u=p.url?T5.Images.get(p.url):null,l=false;if(u){g.drawImage(u,t,s);p.dirty=false;l=true}else if(q===f)b&&g.drawImage(b,t,s);else a&&g.drawImage(a,t,s);return l},prepTile:function(g,p){if(g)g.dirty=true;if(g&&(!o||p===d))T5.Images.get(g.url)||T5.Images.load(g.url,h,m)}});return n};
T5.Tiler=function(e){e=T5.ex({container:"",drawCenter:false,datasources:{},tileLoadThreshold:"first"},e);var h=T5.ex(new T5.View(e),{getTileLayer:function(){return h.getLayer("grid0")},setTileLayer:function(a){h.setLayer("grid0",a);GT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(a){var b=h.getOffset();return new T5.Vector(a.x+b.x,a.y+b.y)},centerOn:function(a,b,d,f){var o=h.getTileLayer(),k=h.getDimensions();(o=o?o.getTileSize():0)&&h.updateOffset(a.gridX-Math.floor((k.width-
o)*0.5),a.gridY-Math.floor((k.height-o)*0.5),b,d,f)},cleanup:function(){h.removeLayer("grid0")},repaint:function(){GT.WaterCooler.say("tiler.repaint");h.trigger("wake")},select:function(a){h.trigger("selectTile",a)}});h.bind("tap",function(a,b){var d=h.getTileLayer();if(d)(d=d.getTileAtXY(b.x,b.y))&&h.trigger("selectTile",d)});return h};
T5.Geo=function(){function e(n,g){var p=null;for(var t in k)if(g){if(t==g&&k[t][n]){p=k[t];break}}else if(k[t][n]){p=k[t];break}return p}function h(n,g,p,t){var s=0;n=n.toUpperCase();for(var q in t){var u=g[q];if(u){var l=p[q];u=l?l(n,u):n.containsWord(u)?1:0;s+=u*t[q]}}return s}var a=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],b=Math.PI/180,d=180/Math.PI,f=null,o={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},k={},m={Engine:function(n){if(!n.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var g=T5.ex({remove:function(){delete k[g.id]}},n);return k[g.id]=g},Radius:function(n,g){return{distance:parseInt(n,10),uom:g}},Position:function(n,g){return{lat:parseFloat(n?n:0),lon:parseFloat(g?g:0)}},BoundingBox:function(n,g){return{min:m.P.parse(n),max:m.P.parse(g)}},Address:function(n){return n=T5.ex({streetDetails:"",location:"",country:"",postalCode:"",pos:null,boundingBox:null},
n)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var n={dist2rad:function(g){return g/6371},lat2pix:function(g,p){var t=parseFloat(g)*2*Math.PI/360;t=Math.sin(t);var s=0.08181919084262157*t;return Math.log((1+t)/(1-t)*Math.pow((1-s)/(1+s),0.08181919084262157))/2/p},lon2pix:function(g,p){return parseFloat(g)/180*Math.PI/p},pix2lon:function(g,p){return n.normalizeLon(g*p*180/Math.PI)},pix2lat:function(g,p){for(var t=Math.pow(Math.E,-g*p),s=n.mercatorUnproject(t),
q=n.findRadPhi(s,t),u=0;u<12&&Math.abs(s-q)>1.0E-7;){s=q;q=n.findRadPhi(s,t);u++}return q*180/Math.PI},mercatorUnproject:function(g){return Math.PI/2-2*Math.atan(g)},findRadPhi:function(g,p){var t=0.08181919084262157*Math.sin(g);return Math.PI/2-2*Math.atan(p*Math.pow((1-t)/(1+t),0.040909595421310785))},normalizeLon:function(g){for(;g<-180;)g+=360;for(;g>180;)g-=360;return g}};return n}(),GeoSearchResult:function(n){n=T5.ex({id:null,caption:"",resultType:"",data:null,pos:null,matchWeight:0},n);return T5.ex(n,
{toString:function(){return n.caption+(n.matchWeight?" ("+n.matchWeight+")":"")}})},GeoSearchAgent:function(n){return new T5.Dispatcher.Agent(n)},GeocodingAgent:function(n){n=T5.ex({name:"Geocoding Search Agent",paramTranslator:null,execute:function(g,p){try{if(!g.reverse&&!g.freeform)address=new m.Address(g);var t=m.getEngine("geocode");if(t)t.geocode({addresses:[g.freeform?g.freeform:address],complete:function(q,u){if(p){var l=u;if(g.freeform)l=m.rankGeocodeResponses(g.freeform,l,m.getEngine("geocode"));
p(l,n)}}})}catch(s){GT.Log.exception(s)}}},n);return new m.GeoSearchAgent(n)},PointOfInterest:function(n){n=T5.ex({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},n);if(!n.pos&&n.lat&&n.lon)n.pos=new T5.Geo.Position(n.lat,n.lon);return T5.ex({toString:function(){return n.id+": '"+n.title+"'"}},n)},POIStorage:function(n){function g(l){l=l?l:"default";s[l]||(s[l]=[]);return s[l]}function p(l){var r=[];for(var v in s)for(var z=0;z<s[v].length;z++)if(!l||l(s[v][z]))r.push(s[v][z]);
return r}function t(){GT.WaterCooler.say("geo.pois-updated",{srcID:u.id,pois:u.getPOIs()})}n=T5.ex({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},n);var s={},q=true,u={id:GT.objId(),getPOIs:function(){return p()},getOldPOIs:function(l,r){return p(function(v){return v.group==l&&v.retrieved<r})},getVisible:function(){return q},setVisible:function(l){if(l!=q){q=l;n.visibilityChange&&n.visibilityChange()}},findById:function(l){var r=p(function(v){return v.id==l});return r.length>0?r[0]:null},
findByBounds:function(l){return p(function(r){return T5.Geo.P.inBounds(r.pos,l)})},addPOIs:function(l,r){if(r)s={};for(var v=0;l&&v<l.length;v++){l[v].retrieved=T5.time();var z=l[v];g(z.group).push(z)}},removeGroup:function(l){if(s[l]){delete s[l];t()}},update:function(l){var r=[],v=0,z=l.length>0?l[0].group:"",B=T5.time();for(v=0;v<l.length;v++){var F;a:{if(F=l[v])for(var y=g(F.group),E=0;E<y.length;E++)if(y[E].id==F.id){F=y[E];break a}F=null}if(F){F.retrieved=B;F.isNew=false}else r.push(l[v])}l=
u.getOldPOIs(z,B);u.addPOIs(r);for(v=0;n.onPOIAdded&&v<r.length;v++)n.onPOIAdded(r[v]);for(v=0;v<l.length;v++){n.onPOIDeleted&&n.onPOIDeleted(l[v]);z=l[v];B=g(z.group);for(F=0;F<B.length;F++)if(B[F].id==z.id){B.splice(F,1);break}}r.length+l.length>0&&t()}};return u},MapProvider:function(){var n=1,g=20;return{zoomLevel:0,checkZoomLevel:function(p){return Math.min(Math.max(p,n),g)},getCopyright:function(){},getLogoUrl:function(){},getMapTiles:function(){},getZoomRange:function(){return{min:n,max:g}},
setZoomRange:function(p,t){n=p;g=t}}},P:function(){var n={calcDistance:function(g,p){if(n.empty(g)||n.empty(p))return 0;var t=(p.lat-g.lat).toRad()/2,s=(p.lon-g.lon).toRad()/2;t=Math.sin(t)*Math.sin(t)+Math.cos(g.lat.toRad())*Math.cos(p.lat.toRad())*Math.sin(s)*Math.sin(s);return 6371*2*Math.atan2(Math.sqrt(t),Math.sqrt(1-t))},copy:function(g){return g?new m.Position(g.lat,g.lon):null},empty:function(g){return!g||g.lat===0&&g.lon===0},equal:function(g,p){return g&&p&&g.lat==p.lat&&g.lon==p.lon},almostEqual:function(g,
p){return g&&p&&Math.floor(g.lat*1E3)===Math.floor(p.lat*1E3)&&Math.floor(g.lon*1E3)===Math.floor(p.lon*1E3)},inArray:function(g,p){for(var t=m.P.equal,s=p.length;s--;)if(t(g,p[s]))return true;return false},inBounds:function(g,p){var t=!(m.P.empty(g)||m.P.empty(p));return t=(t=t&&g.lat>=p.min.lat&&g.lat<=p.max.lat)&&g.lon>=p.min.lon&&g.lon<=p.max.lon},parse:function(g){if(g)if(typeof g.lat!=="undefined")return n.copy(g);else{if(g.split)for(var p=[" ",","],t=0;t<p.length;t++){var s=g.split(p[t]);if(s.length===
2)return new m.Position(s[0],s[1])}}else return new m.Position;return null},parseArray:function(g){var p=g.length,t=Array(p);for(p=p;p--;)t[p]=n.parse(g[p]);GT.Log.info("parsed "+t.length+" positions");return t},fromMercatorPixels:function(g,p,t){return new m.Position(T5.Geo.Utilities.pix2lat(p,t),T5.Geo.Utilities.normalizeLon(T5.Geo.Utilities.pix2lon(g,t)))},toMercatorPixels:function(g,p){return new T5.Vector(T5.Geo.Utilities.lon2pix(g.lon,p),T5.Geo.Utilities.lat2pix(g.lat,p))},generalize:function(g,
p,t){var s=g.length,q=[],u=null;t||(t=250);t/=1E3;GT.Log.info("generalizing positions, must include "+p.length+" positions");for(var l=s;l--;)if(l===0)q.unshift(g[l]);else{var r=!u||m.P.inArray(g[l],p)?t:m.P.calcDistance(u,g[l]);if(g[l]&&r>=t){q.unshift(g[l]);u=g[l]}}GT.Log.info("generalized "+s+" positions into "+q.length+" positions");return q},toString:function(g){return g?g.lat+" "+g.lon:""}};return n}(),B:function(){var n=-(Math.PI/2),g=Math.PI/2,p=-Math.PI*2,t=Math.PI*2,s={calcSize:function(q,
u,l){var r=new T5.Vector(0,u.lat-q.lat);if(typeof l==="undefined")l=true;r.x=l&&q.lon>u.lon?360-q.lon+u.lon:u.lon-q.lon;return r},createBoundsFromCenter:function(q,u){var l=u/6371,r=q.lat*b,v=q.lon*b,z=r-l,B=r+l;if(z>n&&B<g){r=Math.asin(Math.sin(l)/Math.cos(r));l=v-r;if(l<p)l+=2*Math.PI;v=v+r;if(v>t)v-=2*Math.PI}else{z=Math.max(z,n);B=Math.min(B,g);l=p;v=t}return new m.BoundingBox(new m.Position(z*d,l*d),new m.Position(B*d,v*d))},expand:function(q,u){return new m.BoundingBox(new m.Position(q.min.lat-
u,q.min.lon-m.Utilities.normalizeLon(u)),new m.Position(q.max.lat+u,q.max.lon+m.Utilities.normalizeLon(u)))},forPositions:function(q,u){var l=null,r=T5.time();u||(u="auto");for(var v=q.length;v--;)if(l){var z=s.calcSize(l.min,q[v],false),B=s.calcSize(q[v],l.max,false);if(z.x<0)l.min.lon=q[v].lon;if(z.y<0)l.min.lat=q[v].lat;if(B.x<0)l.max.lon=q[v].lon;if(B.y<0)l.max.lat=q[v].lat}else l=new T5.Geo.BoundingBox(q[v],q[v]);if(u){if(u=="auto"){v=s.calcSize(l.min,l.max);u=Math.max(v.x,v.y)*0.3}l=s.expand(l,
u)}GT.Log.trace("calculated bounds for "+q.length+" positions",r);return l},getCenter:function(q){var u=m.B.calcSize(q.min,q.max);return new T5.Geo.Position(q.min.lat+u.y/2,q.min.lon+u.x/2)},getGeoHash:function(q){var u=T5.Geo.GeoHash.encode(q.min.lat,q.min.lon);q=T5.Geo.GeoHash.encode(q.max.lat,q.max.lon);GT.Log.info("min hash = "+u+", max hash = "+q)},getZoomLevel:function(q,u){var l=s.getCenter(q),r=a[Math.min(Math.round(Math.abs(l.lat)*0.05),a.length)],v=s.calcSize(q.min,q.max);l=Math.ceil(Math.log(a[3]*
u.height/v.y)/Math.log(2));r=Math.ceil(Math.log(r*u.width/v.x)/Math.log(2));return Math.min(isNaN(l)?1E3:l,isNaN(r)?1E3:r)},isEmpty:function(q){return!q||m.P.empty(q.min)||m.P.empty(q.max)},toString:function(q){return"min: "+m.P.toString(q.min)+", max: "+m.P.toString(q.max)}};return s}(),A:function(){var n=/^(\d+).*$/,g=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(p,t){n.lastIndex=-1;if(n.test(p))for(var s=p.replace(n,"$1"),q=t.split(","),u=0;u<q.length;u++){g.lastIndex=-1;if(g.test(q[u])){var l=
g.exec(q[u]);if(s>=parseInt(l[1],10)&&s<=parseInt(l[2],10))return true}else if(s==q[u])return true}return false},normalize:function(p){if(!p)return"";p=p.toUpperCase();if(!f){var t=[];for(var s in o)t.push(s);f=RegExp("(\\s)("+t.join("|")+")(\\s|$)","i")}f.lastIndex=-1;if(t=f.exec(p))p=p.replace(f,"$1"+o[t[2]]);return p},toString:function(p){return p.streetDetails+" "+p.location}}}(),getEngine:function(n){for(var g=null,p=1;!g&&p<arguments.length;p++)g=e(n,arguments[p]);g=g?g:e(n);if(!g)throw Error("Unable to find GEO engine with "+
n+" capability");return g},rankGeocodeResponses:function(n,g,p){var t=[],s=m.AddressCompareFns;if(p&&p.compareFns)s=T5.ex({},s,p.compareFns);for(p=0;p<g.length;p++)t.push(new m.GeoSearchResult({caption:m.A.toString(g[p]),data:g[p],pos:g[p].pos,matchWeight:h(n,g[p],s,m.GeocodeFieldWeights)}));t.sort(function(q,u){return u.matchWeight-q.matchWeight});return t}};return m}();
T5.Geo.GeoHash=function(){function e(h,a,b){if(a&b)h[0]=(h[0]+h[1])/2;else h[1]=(h[0]+h[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(h){var a=1,b=[],d=[];b[0]=-90;b[1]=90;d[0]=-180;d[1]=180;lat_err=90;lon_err=180;for(i=0;i<h.length;i++){c=h[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(a){lon_err/=2;e(d,cd,mask)}else{lat_err/=2;e(b,cd,mask)}a=!a}}b[2]=(b[0]+
b[1])/2;d[2]=(d[0]+d[1])/2;return{latitude:b,longitude:d}},encode:function(h,a,b){var d=1,f=[],o=[],k=0,m=0;b=b?b:12;geohash="";f[0]=-90;f[1]=90;o[0]=-180;for(o[1]=180;geohash.length<b;){if(d){mid=(o[0]+o[1])/2;if(a>mid){m|=BITS[k];o[0]=mid}else o[1]=mid}else{mid=(f[0]+f[1])/2;if(h>mid){m|=BITS[k];f[0]=mid}else f[1]=mid}d=!d;if(k<4)k++;else{geohash+=BASE32[m];m=k=0}}return geohash}}}();
T5.Geo.Search=function(){return{bestResults:function(e,h){h||(h=20);for(var a=e.length>0?e[0]:null,b=[],d=0;d<e.length;d++)if(a&&e[d]&&a.matchWeight-e[d].matchWeight<=h)b.push(e[d]);else break;return b}}}();
T5.Geo.Routing=function(){var e={calculate:function(h){h=T5.ex({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:false},h);GT.Log.info("attempting to calculate route");var a=T5.Geo.getEngine("route");a&&a.route(h,function(b){if(h.generalize)b.geometry=T5.Geo.P.generalize(b.geometry,b.getInstructionPositions());if(h.map){e.createMapOverlay(h.map,b);if(h.autoFit){GT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+b.boundingBox);h.map.gotoBounds(b.boundingBox)}}h.success&&
h.success(b)})},createMapOverlay:function(h,a){var b=h.getDimensions();b=new T5.Geo.UI.RouteOverlay({data:a,width:b.width,height:b.height});h.setLayer("route",b)},parseTurnType:function(h){for(var a=e.TurnType.Unknown,b=T5.Geo.Routing.TurnTypeRules,d=0;d<b.length;d++){b[d].regex.lastIndex=-1;var f=b[d].regex.exec(h);if(f){a=b[d].customCheck?b[d].customCheck(h,f):b[d].turnType;break}}return a},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",TurnLeft:"turn-left",
TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(h){h=T5.ex({position:null,description:"",turnType:null},h);if(!h.turnType)h.turnType=e.parseTurnType(h.description);return h},RouteData:function(h){h=T5.ex({geometry:[],instructions:[],boundingBox:null},
h);if(!h.boundingBox)h.boundingBox=T5.Geo.B.forPositions(h.geometry);return T5.ex({getInstructionPositions:function(){for(var a=[],b=0;b<h.instructions.length;b++)h.instructions[b].position&&a.push(h.instructions[b].position);return a}},h)}};return e}();
T5.Geo.Routing.TurnTypeRules=function(){var e=T5.Geo.Routing.TurnType,h=[];h.push({regex:/continue/i,turnType:e.Continue});h.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(a,b){return/bear/i.test(b[1])?e.TurnLeftSlight:e.TurnLeft}});h.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(a,b){return/bear/i.test(b[1])?e.TurnRightSlight:e.TurnRight}});h.push({regex:/enter\s(roundabout|rotaty)/i,turnType:e.EnterRoundabout});h.push({regex:/take.*?ramp/i,turnType:e.Ramp});h.push({regex:/take.*?exit/i,
turnType:e.RampExit});h.push({regex:/make(.*?)u\-turn/i,customCheck:function(a,b){return/right/i.test(b[1])?e.UTurnRight:e.UTurnLeft}});h.push({regex:/proceed/i,turnType:e.Start});h.push({regex:/arrive/i,turnType:e.Arrive});h.push({regex:/fell\sthrough/i,turnType:e.Merge});return h}();
T5.Geo.UI=function(){var e=0,h={AnnotationTween:null,GeoTileGrid:function(a){a=T5.ex({grid:null,centerPos:new T5.Geo.Position,centerXY:new T5.Vector,radsPerPixel:0},a);var b=T5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),d=b.x-a.centerXY.x,f=b.y-a.centerXY.y,o=T5.ex({},a.grid,{getBoundingBox:function(k,m,n,g){return new T5.Geo.BoundingBox(o.pixelsToPos(new T5.Vector(k,m+g)),o.pixelsToPos(new T5.Vector(k+n,m)))},getGridXYForPosition:function(k){k=T5.Geo.P.toMercatorPixels(k,a.radsPerPixel);
return new T5.Vector(k.x-d,o.gridDimensions.height-(k.y-f))},getPixelDistance:function(k){k=T5.Geo.Utilities.dist2rad(k);return Math.floor(k/a.radsPerPixel)},pixelsToPos:function(k){return T5.Geo.P.fromMercatorPixels(d+k.x,f+o.gridDimensions.height-k.y,a.radsPerPixel)}});return o},RouteOverlay:function(a){a=T5.ex({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var b=true,d=null,f=
[],o=0,k=[],m=[],n=T5.ex(new T5.ViewLayer(a),{getAnimation:function(g,p,t,s){if(b)return null;var q="routeAnimation"+e++;m.push(q);return new T5.AnimatedPathLayer({id:q,path:f,zindex:a.zindex+1,easing:g?g:T5.T5.easing("sine.inout"),duration:p?p:5E3,drawIndicator:t,autoCenter:s?s:false})},draw:function(g,p,t,s,q){t=0;s=a.data?a.data.geometry:null;if(b){b=false;d=null;f=[];o=0}if(s&&o<s.length){a:{q=q.getTileLayer();k=[];if(q){s=GT.Log.getTraceTicks();var u,l,r,v=a.data?a.data.geometry:[],z=v.length,
B=a.data?a.data.instructions:[],F=B.length,y=a.calculationsPerCycle,E=0;for(u=o;u<z;u++){l=q.getGridXYForPosition(v[u]);if(r=!d||u===0||Math.abs(l.x-d.x)+Math.abs(l.y-d.y)>a.pixelGeneralization){f.push(l);d=l}E++;if(E>=y){o=u;break a}}o=z;GT.Log.trace(z+" geometry points generalized to "+f.length+" coordinates",s);d=null;for(u=F;u--;)if(B[u].position){l=q.getGridXYForPosition(B[u].position);if(r=!d||u===0||Math.abs(l.x-d.x)+Math.abs(l.y-d.y)>a.pixelGeneralization){k.push(l);d=l}}}}t++}q=f.length;
if(q>0&&(!t||a.partialDraw)){g.strokeStyle=a.strokeStyle;g.lineWidth=a.lineWidth;g.beginPath();g.moveTo(f[q-1].x-p.x,f[q-1].y-p.y);for(q=q;q--;)g.lineTo(f[q].x-p.x,f[q].y-p.y);g.stroke();g.fillStyle=a.waypointFillStyle;for(q=k.length;q--;){g.beginPath();g.arc(k[q].x-p.x,k[q].y-p.y,2,0,Math.PI*2,false);g.stroke();g.fill()}}return t}});GT.WaterCooler.listen("grid.updated",function(){for(var g=m.length;g--;)GT.WaterCooler.say("layer.remove",{id:m[g]});m=[];b=true;n.wakeParent()});return n},Annotation:function(a){a=
T5.ex({xy:null,pos:null,draw:null,calcXY:null,tweenIn:h.AnnotationTween,animationSpeed:null},a);var b=false,d={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return b},calcXY:function(f){d.xy=f.getGridXYForPosition(d.pos);a.calcXY&&a.calcXY(f)},draw:function(f,o,k,m,n){if(d.xy){if(d.isNew&&a.tweenIn){var g=d.xy.y;d.xy.y=o.y-20;b=true;T5.tween(d.xy,"y",g,a.tweenIn,function(){d.xy.y=g;b=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(f,o,new T5.Vector(d.xy.x-o.x,
d.xy.y-o.y),k,m,n);else{f.beginPath();f.arc(d.xy.x-o.x,d.xy.y-o.y,4,0,Math.PI*2,false);f.fill()}d.isNew=false}}};return d},ImageAnnotation:function(a){a=T5.ex({imageUrl:null,animatingImageUrl:null,imageAnchor:null},a);var b=a.imageAnchor?T5.V.invert(a.imageAnchor):null;a.draw=function(f,o,k,m,n){if(a.animatingImageUrl&&d.isAnimating()){T5.Images.load(a.imageUrl);m=a.animatingImageUrl}else m=a.imageUrl;if(o=T5.Images.get(m)){if(o.complete&&o.width>0){b||(b=new T5.Vector(-o.width>>1,-o.height>>1));
k=T5.V.offset(k,b.x,b.y);f.drawImage(o,k.x,k.y,o.width,o.height)}}else T5.Images.load(m,function(){n.wakeParent()})};var d=new h.Annotation(a);return d},LocationAnnotation:function(a){a=T5.ex({accuracy:null},a);var b=new Image,d=new T5.Vector,f=null;b.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAACIQAAAiEBPhEQkwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAG+SURBVCiRlZHNahNRAIW/O7mTTJPahLZBA1YUyriINRAE3bQIKm40m8K8gLj0CRQkO32ELHUlKbgoIu4EqeJPgtCaoBuNtjXt5LeTMZk0mbmuWiuuPLsD3+HAOUIpxf9IHjWmaUbEyWv5ROrsVULhcHP761rUfnN3Y2Otc8CIg4YT85lzuVsPP+Qupw1vpPjRCvhS9ymvV0e77x7nNj+uvADQAIQQ+uLyvdfLV9JGZi7EdEwQlqBpEJ019f0z1mo2u5Q8DMydv25lshemmj1FueZTawbs7inarqLbV7Qjab1upB9YlhWSAHLavLHZCvg1VEhN0PMU9W7At4bPVidg7CtkLLXkut+lBPD6/Ub155jJiADAHSpaLmx3ApyBQoYEUd0PBoOBkAC6+3llvda/YxgGgYL+UNHf/zN3KiExGlsvTdP0NYDkhPdWrz35ZDsBzV5wCMuQwEyFmXFeeadjzfuFQmGkAZRKpdGC/n7x+M6jqvA9Zo6FWDhlcHE+wqT93J1tP7vpOE7rrx8ALMuasPf8S12St4WmJ6bYWTUC52k8Hm8Vi0X/nwBAPp/XKpWKdF1X2LYdlMvlsToC/QYTls7DLFr/PAAAAABJRU5ErkJggg%3D%3D";
b.onload=function(){d=new T5.Vector(b.width/2,b.height/2)};var o=new h.Annotation(T5.ex({calcXY:function(k){f=Math.floor(k.getPixelDistance(o.accuracy)*0.5)},draw:function(k,m,n,g,p,t){m=n.x-d.x;g=n.y-d.y;if(f&&o.drawAccuracyIndicator){k.fillStyle="rgba(30, 30, 30, 0.2)";k.beginPath();k.arc(n.x,n.y,f,0,Math.PI*2,false);k.fill()}b.complete&&b.width>0&&k.drawImage(b,m,g,b.width,b.height);t.trigger("invalidate")}},a));o.accuracy=a.accuracy;o.drawAccuracyIndicator=false;return o},AnnotationsOverlay:function(a){function b(m){var n=
a.map?a.map.getTileLayer():null,g=m.length;if(n)for(g=g;g--;)m[g].calcXY(n);m.sort(function(p,t){var s=t.xy.y-p.xy.y;if(s===0)s=t.xy.x-p.xy.x;return s})}a=T5.ex({pois:null,map:null,zindex:100},a);var d=[],f=false,o=[],k=T5.ex(new T5.ViewLayer(a),{cycle:function(){return f?1:0},draw:function(m,n,g,p,t){f=false;m.fillStyle="rgba(255, 0, 0, 0.75)";m.globalCompositeOperation="source-over";for(g=d.length;g--;){d[g].draw(m,n,p,k,t);f=f||d[g].isAnimating()}for(g=o.length;g--;){o[g].draw(m,n,p,k,t);f=f||
o[g].isAnimating()}return f?1:0},add:function(m){o.push(m);b(o);k.wakeParent()},clear:function(m){o=[];b(o);if(m){d=[];b(d)}k.wakeParent()}});GT.WaterCooler.listen("geo.pois-updated",function(m){if(a.pois&&a.pois.id==m.srcID){m=m.pois;try{d=[];for(var n=0;n<m.length;n++)if(m[n].pos){var g;var p=m[n];if(p&&p.pos){var t={poi:p,annotation:null};a.map&&a.map.trigger("getAnnotationForPOI",t);if(!t.annotation)t.annotation=new h.Annotation({pos:p.pos});if(t.annotation){t.annotation.isNew=p.isNew;p.isNew=
false}g=t.annotation}else g=void 0;g&&d.push(g)}b(d)}catch(s){GT.Log.exception(s)}k.wakeParent()}});GT.WaterCooler.listen("grid.updated",function(){b(d);b(o);k.wakeParent()});return k}};return h}();
T5.Map=function(e){function h(r){try{var v=new T5.Geo.Position(r.coords.latitude,r.coords.longitude),z=r.coords.accuracy/1E3;l.trigger("locationUpdate",r,z);if(q){if(!p){p=new T5.Geo.UI.LocationAnnotation({pos:v,accuracy:z});l.bind("tileDrawComplete",function(){p.drawAccuracyIndicator=true})}e.displayLocationAnnotation&&m.add(p);var B=T5.Geo.B.createBoundsFromCenter(v,Math.max(z,1));l.gotoBounds(B)}else{p.pos=v;p.accuracy=z;p.calcXY(l.getTileLayer());l.panToPosition(v,null,T5.easing("sine.out"))}q=
false}catch(F){GT.Log.exception(F)}}function a(r){GT.Log.info("caught location tracking error:",r)}e=T5.ex({tapExtent:10,provider:null,crosshair:false,zoomLevel:0,boundsChangeThreshold:30,pois:new T5.Geo.POIStorage,displayLocationAnnotation:true,zoomAnimation:T5.easing("quad.out")},e);var b={NONE:0,SINGLE:1,WATCH:2},d=new T5.Vector,f=b.NONE,o=false,k=[],m=null,n=null,g=null,p=null,t=0,s=false,q=true,u=e.zoomLevel;if(!e.provider)e.provider=new T5.Geo.MapProvider;e.adjustScaleFactor=function(r){return Math.pow(2,
(r<1?Math.floor:Math.ceil)(Math.log(r)))};var l=T5.ex({},new T5.Tiler(e),{pois:e.pois,annotations:null,getBoundingBox:function(){var r=l.getTileLayer(),v=l.getOffset(),z=l.getDimensions();if(r)return r.getBoundingBox(v.x,v.y,z.width,z.height);return null},getCenterPosition:function(){return l.getXYPosition(T5.D.getCenter(l.getDimensions()))},getXYPosition:function(r){return l.getTileLayer().pixelsToPos(l.viewPixToGridPix(r))},gotoBounds:function(r,v){var z=T5.Geo.B.getZoomLevel(r,l.getDimensions());
l.gotoPosition(T5.Geo.B.getCenter(r),z,v)},gotoPosition:function(r,v,z){function B(C){l.setTileLayer(C);g=C.getId();l.panToPosition(r,function(){l.unfreeze();l.trigger("zoomLevelChange",u);z&&z()});o=true;s=false}var F=u,y=!o,E=l.getBoundingBox();if(E)y=y||!T5.Geo.P.inBounds(r,E);u=v?v:u;if(!u)throw Error("Zoom level required to goto a position.");if(e.provider)u=e.provider.checkZoomLevel(u);if(y||u!==F)if(s)GT.Log.warn("Tile request in progress, aborting");else{T5.Images.cancelLoad();if(p)p.drawAccuracyIndicator=
false;(v=l.getTileLayer())&&v.deactivate();T5.cancelAnimation();o&&l.freeze();s=true;e.provider.zoomLevel=u;e.provider.getMapTiles(l,r,B)}else l.panToPosition(r,z)},panToPosition:function(r,v,z){var B=l.getTileLayer();if(B){r=B.getGridXYForPosition(r);B=l.getDimensions();r.x-=B.width/2;r.y-=B.height/2;if(n)n=null;l.updateOffset(r.x,r.y,z);l.trigger("wake");e.boundsChange&&e.boundsChange(l.getBoundingBox());v&&v(l)}},locate:function(){l.trackStart(b.SINGLE);setTimeout(l.trackCancel,1E4)},trackStart:function(r){if(navigator.geolocation&&
!t){f=r?r:b.WATCH;q=true;t=navigator.geolocation.watchPosition(h,a,{enableHighAccuracy:true,timeout:1E4,maximumAge:5E3})}},trackCancel:function(){t&&navigator.geolocation&&navigator.geolocation.clearWatch(t);f===b.WATCH&&m.clear();f=b.NONE;t=0},getZoomLevel:function(){return u},setZoomLevel:function(r){try{l.gotoPosition(l.getCenterPosition(),r)}catch(v){GT.Log.exception(v)}},zoomIn:function(){l.scale(2,T5.easing("sine.out"))||l.setZoomLevel(u+1)},zoomOut:function(){l.scale(0.5,T5.easing("sine.out"))||
l.setZoomLevel(u-1)},animateRoute:function(r,v,z,B){var F=l.getLayer("route");if(F)(r=F.getAnimation(r,v,z,B))&&r.addToView(l)}});l.bind("pan",function(){f===b.SINGLE&&l.trackCancel()});l.bind("tap",function(r,v){var z=l.getTileLayer(),B=null;if(z){var F=l.viewPixToGridPix(new T5.Vector(v.x,v.y)),y=z.pixelsToPos(F);B=z.pixelsToPos(T5.V.offset(F,-e.tapExtent,e.tapExtent));z=z.pixelsToPos(T5.V.offset(F,e.tapExtent,-e.tapExtent));B=new T5.Geo.BoundingBox(B,z);k=l.pois.findByBounds(B);l.trigger("geotap",
r,v,y,B);l.trigger("tapPOI",k)}});l.bind("doubleTap",function(r,v){l.animate(2,T5.D.getCenter(l.getDimensions()),new T5.Vector(v.x,v.y),e.zoomAnimation)});l.bind("scale",function(r,v){var z=0;r=Math.sqrt(r);if(r<1)z=-(0.5/r);else if(r>1)z=r;l.gotoPosition(l.getXYPosition(v),u+Math.floor(z))});m=new T5.Geo.UI.AnnotationsOverlay({pois:l.pois,map:l});l.annotations=m;l.setLayer("annotations",m);e.crosshair&&l.setLayer("crosshair",new CrosshairOverlay);l.bind("idle",function(){if(T5.V.absSize(T5.V.diff(d,
l.getOffset()))>e.boundsChangeThreshold){d=l.getOffset();l.trigger("boundsChange",l.getBoundingBox())}});GT.configurable(l,["provider"],GT.paramTweaker(e,null,{provider:function(){l.cleanup();o=false}}),true);return l};
