if(!this.JSON)this.JSON={};
(function(){function s(b){return b<10?"0"+b:b}function r(b){i.lastIndex=0;return i.test(b)?'"'+b.replace(i,function(d){var g=f[d];return typeof g==="string"?g:"\\u"+("0000"+d.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+b+'"'}function k(b,d){var g,j,o,m,n=c,l,p=d[b];if(p&&typeof p==="object"&&typeof p.toJSON==="function")p=p.toJSON(b);if(typeof h==="function")p=h.call(d,b,p);switch(typeof p){case "string":return r(p);case "number":return isFinite(p)?String(p):"null";case "boolean":case "null":return String(p);
case "object":if(!p)return"null";c+=e;l=[];if(Object.prototype.toString.apply(p)==="[object Array]"){m=p.length;for(g=0;g<m;g+=1)l[g]=k(g,p)||"null";o=l.length===0?"[]":c?"[\n"+c+l.join(",\n"+c)+"\n"+n+"]":"["+l.join(",")+"]";c=n;return o}if(h&&typeof h==="object"){m=h.length;for(g=0;g<m;g+=1){j=h[g];if(typeof j==="string")if(o=k(j,p))l.push(r(j)+(c?": ":":")+o)}}else for(j in p)if(Object.hasOwnProperty.call(p,j))if(o=k(j,p))l.push(r(j)+(c?": ":":")+o);o=l.length===0?"{}":c?"{\n"+c+l.join(",\n"+c)+
"\n"+n+"}":"{"+l.join(",")+"}";c=n;return o}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+s(this.getUTCMonth()+1)+"-"+s(this.getUTCDate())+"T"+s(this.getUTCHours())+":"+s(this.getUTCMinutes())+":"+s(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var a=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
i=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,c,e,f={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},h;if(typeof JSON.stringify!=="function")JSON.stringify=function(b,d,g){var j;e=c="";if(typeof g==="number")for(j=0;j<g;j+=1)e+=" ";else if(typeof g==="string")e=g;if((h=d)&&typeof d!=="function"&&(typeof d!=="object"||typeof d.length!=="number"))throw Error("JSON.stringify");return k("",
{"":b})};if(typeof JSON.parse!=="function")JSON.parse=function(b,d){function g(o,m){var n,l,p=o[m];if(p&&typeof p==="object")for(n in p)if(Object.hasOwnProperty.call(p,n)){l=g(p,n);if(l!==undefined)p[n]=l;else delete p[n]}return d.call(o,m,p)}var j;b=String(b);a.lastIndex=0;if(a.test(b))b=b.replace(a,function(o){return"\\u"+("0000"+o.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(b.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+b+")");return typeof d==="function"?g({"":j},""):j}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(s){if(arguments.length<=1)return s;for(var r=arguments.length-2,k=0;k<=r;k++)s=s.replace(RegExp("\\{"+k+"\\}","gi"),arguments[k+1]);return s};
String.prototype.containsWord=function(s){var r="";if(s.toString)s=s.toString();for(var k=0;k<s.length;k++)r+=!/\w/.test(s[k])?"\\"+s[k]:s[k];return RegExp("(^|\\s|\\,)"+r+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var s=Object.prototype.hasOwnProperty,r=0,k={id:"GRUNT.core",extend:function(){var a=arguments[0]||{},i=1,c=arguments.length,e=false,f,h,b,d;if(typeof a==="boolean"){e=a;a=arguments[1]||{};i=2}if(typeof a!=="object"&&!k.isFunction(a))a={};if(c===i){a=this;--i}for(;i<c;i++)if((f=arguments[i])!=null)for(h in f){b=a[h];d=f[h];if(a!==d)if(e&&d&&(k.isPlainObject(d)||k.isArray(d))){b=b&&(k.isPlainObject(b)||k.isArray(b))?b:k.isArray(d)?[]:{};a[h]=k.extend(e,b,d)}else if(d!==undefined)a[h]=
d}return a},isFunction:function(a){return toString.call(a)==="[object Function]"},isArray:function(a){return toString.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||toString.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!s.call(a,"constructor")&&!s.call(a.constructor.prototype,"isPrototypeOf"))return false;var i;for(i in a);return i===undefined||s.call(a,i)},isEmptyObject:function(a){for(var i in a)return false;return true},isXmlDocument:function(a){return toString.call(a)===
"[object Document]"},contains:function(a,i){var c=a,e=arguments,f=1;if(i&&k.isArray(i)){e=i;f=0}for(f=f;f<e;f++)c=c&&typeof foo[e[f]]!=="undefined";return c},newModule:function(a){a=k.extend({id:null,requires:[],parent:null},a);if(a.parent)a=k.extend({},a.parent,a);return a},toID:function(a){return a.replace(/\s/g,"-")},generateObjectID:function(a){return(a?a:"obj")+r++}};return k}();
GRUNT.Log=function(){function s(c,e){var f,h=e&&e.length>0?e[0]:"";for(f=1;e&&f<e.length;f++)h+=" "+(k&&GRUNT.isPlainObject(e[f])?JSON.stringify(e[f]):e[f]);typeof console!=="undefined"&&console[c](h);for(f=0;f<r.length;f++)r[f].call(i,h,c)}var r=[],k=typeof JSON!=="undefined",a=window.console&&window.console.markTimeline,i={id:"GRUNT.log",getTraceTicks:function(){return a?(new Date).getTime():null},trace:function(c,e){if(a)console.markTimeline(c+(e?": "+(i.getTraceTicks()-e)+"ms":""))},debug:function(){s("debug",
arguments)},info:function(){s("info",arguments)},warn:function(){s("warn",arguments)},error:function(){s("error",arguments)},exception:function(c){i.error(arguments);for(var e in c)i.info("ERROR DETAIL: "+e+": "+c[e])},watch:function(c,e){try{e()}catch(f){i.exception(f,c)}},throwError:function(c){i.error(c);throw Error(c);},requestUpdates:function(c){r.push(c)}};return i}();
GRUNT.Data=function(){var s={determineObjectMapping:function(k){if(!k)return null;k=k.split("|");for(var a={},i=0;i<k.length;i++)a[k[i]]=i;return a},mapLineToObject:function(k,a){var i=k.split("|"),c={};for(var e in a){var f=a[e];c[e]=i.length>f?i[f]:null}return c},parse:function(k){var a=null,i=[];k=k.split("\n");for(var c=0;c<k.length;c++){var e=k[c];if(a)i.push(s.mapLineToObject(e,a));else a=s.determineObjectMapping(e)}return i}},r={supportedFormats:{JSON:{parse:function(k){return JSON.parse(k)}},
PDON:{parse:function(k){return s.parse(k)}}},parse:function(k){k=GRUNT.extend({data:"",format:"JSON"},k);if(!r.supportedFormats[k.format])throw Error("Unsupported data format: "+k.format+", cannot parse data in javascript object");try{return r.supportedFormats[k.format].parse(k.data)}catch(a){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+k.format,k.data);GRUNT.Log.exception(a)}return{}}};return r}();
GRUNT.Template=function(){var s=/\$\{(.*?)\}/ig;return{parse:function(r,k){for(var a=r,i=s.exec(a);i;){a=a.replace(i[0],GRUNT.XPath.first(i[1],k));s.lastIndex=0;i=s.exec(a)}return a}}}();
GRUNT.JSONP=function(){function s(i){var c=document.createElement("script"),e=false;c.src=i;c.async=true;c.onload=c.onreadystatechange=function(){if(!e&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){e=true;c.onload=c.onreadystatechange=null;c&&c.parentNode&&c.parentNode.removeChild(c)}};k||(k=document.getElementsByTagName("head")[0]);k.appendChild(c)}var r=0,k,a=this;return{get:function(i,c){i+=i.indexOf("?")>=0?"&":"?";var e="json"+ ++r;a[e]=function(f){c(f);a[e]=
null;try{delete a[e]}catch(h){}};s(i+"callback="+e);return e}}}();
GRUNT.XHR=function(){var s={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},r={JSON:["json"],PDON:["pdon.txt"]},k=["TEXT","STREAM"],a=/^(\w+:)?\/\/([^\/?#]+)/,i={XML:function(f){return f.responseXML},JSON:function(f){try{return JSON.parse(f.responseText)}catch(h){GRUNT.Log.error("Error parsing JSON data: ",f.responseText);GRUNT.Log.exception(h)}return""},PDON:function(f){return GRUNT.Data.parse({data:f.responseText,format:"PDON"})},DEFAULT:function(f){return f.responseText}},
c={CONTENT_TYPE:"Content-Type"},e=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(f){try{f=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},e.ajaxSettings,f);var h=a.exec(f.url),b=h&&(h[1]&&h[1]!==location.protocol||h[2]!==location.host);if(f.data)f.method="POST";if(f.url){h=null;if(f.xhr)h=f.xhr(f);h||(h=new XMLHttpRequest);h.open(f.method,f.url,f.async);f.data&&h.setRequestHeader("Content-Type",
f.contentType);b||h.setRequestHeader("X-Requested-With","XMLHttpRequest");h.onreadystatechange=function(){if(this.readyState===4){var g=null,j=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(j)if(f.handleResponse)f.handleResponse(this);else{var o=f,m=this.getResponseHeader(c.CONTENT_TYPE),n,l=false;for(n in s)if(m&&m.indexOf(s[n])>=0){l=true;break}m=!l;for(l=0;l<k.length;l++)m=m||k[l]==n;if(m)b:{m=n;for(var p in r)for(l=
0;l<r[p].length;l++)if(RegExp(r[p][l]+"$","i").test(o.url)){n=p;break b}n=m?m:"DEFAULT"}try{g=i[n](this,o)}catch(q){GRUNT.Log.warn("error applying processor '"+n+"' to response type, falling back to default");g=i.DEFAULT(this,o)}}else f.error&&f.error(this)}catch(t){GRUNT.Log.exception(t,"PROCESSING AJAX RESPONSE")}j&&g&&f.success&&f.success.call(this,g)}};h.send(f.method=="POST"?e.param(f.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(d){GRUNT.Log.exception(d)}},
param:function(f){var h=[],b=function(g,j){j=GRUNT.isFunction(j)?j():j;h[h.length]=encodeURIComponent(g)+"="+encodeURIComponent(j)};if(GRUNT.isArray(f))for(var d=0;d<f.length;d++)b(f[d].name,f[d].value);else for(d in f)b(d,f[d]);return h.join("&").replace(/%20/g,"+")}});return e}();
GRUNT.XPath=function(){function s(i){for(var c=null,e=0;e<r.length;e++)if(c=r[e](i))break;return c}var r=[],k=[null,function(i){return i.numberValue},function(i){return i.stringValue},function(i){return i.booleanValue},null,null,null,null,function(i){return i.singleNodeValue?i.singleNodeValue.textContent:null},function(i){return i.singleNodeValue?i.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var a={SearchResult:function(i){return{toString:function(){var c=
null;if(i){var e=null;if(i.resultType>=0&&i.resultType<k.length)e=k[i.resultType];if(e){GRUNT.Log.info("invoking match handler for result type: "+i.resultType);c=e(i)}}return c?c:""}}},first:function(i,c){var e=a.SearchResult,f;var h=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!h)h=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(c))f=c.evaluate(i,c,s,h,null);else{GRUNT.Log.warn("attempted xpath expression: "+i+" on a non-xml document");f=null}}catch(b){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
i+" on node: "+c);f=null}return new e(f)},registerResolver:function(i){r.push(i)}};return a}();GRUNT.WaterCooler=function(){var s={},r=[];return{addPipe:function(k){k("pipe.test",{});r.push(k)},listen:function(k,a){s[k]||(s[k]=[]);a&&s[k].push(a)},say:function(k,a){var i;for(i=r.length;i--;)r[i](k,a);if(s[k])for(i=s[k].length;i--;)s[k][i](a)},leave:function(){}}}();
TILE5=function(){var s={Settings:function(){var r={};return{get:function(k){return r[k]},set:function(k,a){r[k]=a},extend:function(k){GRUNT.extend(r,k)}}}(),Clock:function(){var r=null;return{getTime:function(k){return k&&r?r:r=(new Date).getTime()}}}(),Vector:function(r,k){return{x:r?r:0,y:k?k:0}},V:function(){function r(k){if(!k||k.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var a={edges:Array(k.length-1),accrued:Array(k.length-1),total:0},
i=TILE5.V.diff,c=0;c<k.length-1;c++){var e=i(k[c],k[c+1]);a.edges[c]=Math.sqrt(e.x*e.x+e.y*e.y);a.accrued[c]=a.total+a.edges[c];a.total+=a.edges[c]}return a}return{create:function(k,a){return new s.Vector(k,a)},add:function(){for(var k=new s.Vector,a=arguments.length;a--;){k.x+=arguments[a].x;k.y+=arguments[a].y}return k},absSize:function(k){return Math.max(Math.abs(k.x),Math.abs(k.y))},diff:function(k,a){return new s.Vector(k.x-a.x,k.y-a.y)},copy:function(k){return k?new s.Vector(k.x,k.y):null},
invert:function(k){return new TILE5.Vector(-k.x,-k.y)},offset:function(k,a,i){return new TILE5.Vector(k.x+a,k.y+(i?i:a))},edges:r,distance:function(k){return r(k).total},theta:function(k,a,i){i=Math.asin((k.y-a.y)/i);return k.x>a.x?i:Math.PI-i},pointOnEdge:function(k,a,i,c){a=new TILE5.Vector(Math.cos(i)*c,Math.sin(i)*c);return new TILE5.Vector(k.x-a.x,k.y-a.y)},getRect:function(k){var a=k.length;if(a>1)return new TILE5.Rect(Math.min(k[0].x,k[a-1].x),Math.min(k[0].y,k[a-1].y),Math.abs(k[0].x-k[a-
1].x),Math.abs(k[0].y-k[a-1].y))}}}(),Dimensions:function(r,k){return{width:r?r:0,height:k?k:0}},D:function(){return{getAspectRatio:function(r){return r.height!==0?r.width/r.height:1},getCenter:function(r){return new s.Vector(r.width/2,r.height/2)},getSize:function(r){return Math.sqrt(Math.pow(r.width,2)+Math.pow(r.height,2))}}}(),Rect:function(r,k,a,i){return{origin:new s.Vector(r,k),dimensions:new s.Dimensions(a,i)}},R:function(){return{copy:function(r){return r?new s.Rect(r.origin.x,r.origin.y,
r.dimensions.width,r.dimensions.height):null},getCenter:function(r){return new TILE5.Vector(r.origin.x+r.dimensions.width/2,r.origin.y+r.dimensions.height/2)}}}()};return s}();
TILE5.Device=function(){function s(){for(;d.length>0;){var j=d.shift();document.location=j}b=0}function r(j){for(var o=true,m=g.length;m--;)o=o&&j!=g[m];return o}function k(j,o){var m=[];for(var n in o)n&&m.push(n+"="+escape(o[n]));return"tile5://"+j+"/"+(m.length>0?"?"+m.join("&"):"")}function a(j,o){r(j)&&GRUNT.Log.info("would push url: "+k(j,o))}function i(j,o){if(r(j)){d.push(k(j,o));b||setTimeout(s,100)}}function c(){e={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in document,
imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:4,requireFastDraw:false,bridgeNotify:a},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true,bridgeNotify:i},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:i},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:i},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,supportsTouch:true,getScaling:function(){return 1/
window.devicePixelRatio},bridgeNotify:i},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:i}};f=[e.froyo,e.android,e.ipod,e.iphone,e.ipad]}var e=null,f=[],h=null,b=0,d=[],g=["view.wake","tile.loaded"];return{getConfig:function(){e||c();if(!h){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var j=0;j<f.length;j++){var o=f[j];if(o.regex&&o.regex.test(navigator.userAgent)){h=GRUNT.extend({},e.base,o);GRUNT.Log.info("PLATFORM DETECTED AS: "+
h.name);break}}if(!h){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");h=e.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return h}}}();
TILE5.Resources=function(){var s="",r={},k=function(){function i(){var l=h[this.id];if(l){l.loaded=true;l.hitCount=1;for(var p=g.length;p--;)if(g[p].image.src==this.src){g.splice(p,1);break}l.loadCallback&&l.loadCallback(this,false);j.push({url:this.src,created:l.requested});delete h[this.id];c()}}function c(){for(var l=TILE5.Device.getConfig().maxImageLoads;d.length>0&&(!l||g.length<l);){var p=d.shift();g.push(p);p.image.onload=i;p.image.src=p.url;p.requested=(new Date).getTime()}}function e(){m=
true;try{var l=Math.floor(j.length/2);if(l>0){j.sort(function(q,t){return q.created-t.created});for(var p=l;p--;)delete f[j[p].url];j.splice(0,l)}}finally{m=false}GRUNT.WaterCooler.say("imagecache.cleared")}var f={},h={},b=0,d=[],g=[],j=[],o=0,m=false,n={loadingImages:g,queuedImages:d,getCacheFullness:function(){return o},getImage:function(l){var p=null;m||(p=f[l]);return p?p.image:null},loadImage:function(l,p){var q=f[l];if(q){q.hitCount++;q.image.complete&&p&&p(q.image,true)}else{q={url:a.getPath(l),
image:new Image,loaded:false,created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:p};q.image.id="resourceLoaderImage"+b++;f[l]=q;h[q.image.id]=q;d.push(q);c()}return q},resetLoadingQueue:function(){g=[]}};setInterval(function(){for(var l=(new Date).getTime(),p=false,q=0,t=TILE5.Device.getConfig();q<g.length;)if(l-g[q].requested>a.loadTimeout*1E3){g.splice(q,1);p=true}else q++;p&&c();if(t&&t.imageCacheMaxSize){o=j.length*a.avgImageSize/t.imageCacheMaxSize;o>=1&&e()}},1E3);return n}(),
a={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(i,c){for(var e=(i?i.replace(/^.*\?/,""):"").split("&"),f=i?i.replace(/\?.*$/,"?"):"",h=0;h<e.length;h++){var b=e[h].split("=");if(!c||!c.test(b[0]))f+=e[h]+"&"}return f.replace(/\W/g,"")},isValidCacheKey:function(i){GRUNT.Log.info("cache key = "+i);return false}}}(),getPath:function(i){return/^(https?|\/)/.test(i)?i:s+i},setBasePath:function(i){s=i},getImage:function(i){return k.getImage(i)},
loadImage:function(i,c){k.loadImage(i,c)},resetImageLoadQueue:function(){k.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:k.loadingImages.length,queuedImageCount:k.queuedImages.length,imageCacheFullness:k.getCacheFullness()}},loadResource:function(i){i=GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},i);var c=function(e){i.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){i.callback(e)})};i.cacheable&&r[i.filename]?c(r[i.filename]):GRUNT.XHR.ajax({url:a.getPath(i.filename),
dataType:i.dataType,success:function(e){if(i.cacheable)r[i.filename]=e;c(e)},error:function(e,f,h){GRUNT.Log.error("error loading resource ["+i.filename+"], error = "+h)}})},loadSnippet:function(i,c){/\.\w+$/.test(i)||(i+=".html");a.loadResource({filename:"snippets/"+i,callback:c,dataType:"html"})}};return a}();
TILE5.Touch=function(){function s(b,d){var g=b&&b.length>0?b[0]:null;if(g&&d&&d.length>0)return TILE5.V.diff(g,d[0]);return null}function r(b){b.preventDefault();b.stopPropagation()}function k(b){for(var d=Array(b.length),g=b.length;g--;)d[g]=new TILE5.Vector(b[g].pageX,b[g].pageY);return d}var a={TAP:0,MOVE:1,PINCHZOOM:2},i=7,c=0,e=0,f={TouchHelper:function(b){function d(u){for(var A=[],C=b.element?-b.element.offsetLeft:0,H=b.element?-b.element.offsetTop:0,O=u.length;O--;)A.push(TILE5.V.offset(u[O],
C,H));return A}function g(u){var A=Array(arguments.length-1),C=0;for(C=1;C<arguments.length;C++)A[C-1]=arguments[C];for(C=F.length;C--;)F[C][u]&&F[C][u].apply(M,A)}function j(u){if(u.target&&u.target===b.element){q=p?k(u.touches):[new TILE5.Vector(u.pageX,u.pageY)];w=new TILE5.Vector;v=new TILE5.Vector;D=true;n=false;p&&r(u);G.current=TILE5.Clock.getTime();if(u=q.length>0?q[0]:null){g("touchStartHandler",u.x,u.y);if(G.current-G.last<M.THRESHOLD_DOUBLETAP)if((u=t?TILE5.V.diff(q[0],t[0]):null)&&Math.abs(u.x)<
b.maxDistDoubleTap&&Math.abs(u.y)<b.maxDistDoubleTap)n=true;B=a.TAP;t=[].concat(q)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function o(u){if(u.target&&u.target===b.element)if(D)try{p&&r(u);var A=p?k(u.touches):[new TILE5.Vector(u.pageX,u.pageY)];u=0;if(A.length>1){if(q.length===1)q=[].concat(A);u=TILE5.V.distance(q)-TILE5.V.distance(t)}if(B===a.TAP){var C=s(A,q);if(C&&(Math.abs(C.x)>=i||Math.abs(C.y)>=i))B=a.MOVE}if(B!==a.TAP)if(!u||Math.abs(u)<b.pinchZoomThreshold){if(w=
s(A,t)){v.x+=w.x;v.y+=w.y;y.x+=w.x;y.y+=w.y}if(TILE5.V.absSize(y)>b.panEventThreshhold){g("moveHandler",y.x,y.y);y=TILE5.V.create()}B=a.MOVE}else{g("pinchZoomHandler",d(q),d(A));B=a.PINCHZOOM}t=[].concat(A)}catch(H){GRUNT.Log.exception(H)}}function m(u){if(u.target&&u.target===b.element)try{p&&r(u);TILE5.Clock.getTime();G.last=G.current;if(B===a.TAP)l||(l=setTimeout(function(){l=0;var C=n?"doubleTapHandler":"tapHandler",H=q[0],O=null;if(b.element)O=TILE5.V.offset(H,-b.element.offsetLeft,-b.element.offsetTop);
g(C,H,O)},M.THRESHOLD_DOUBLETAP+50));else if(B==a.MOVE)g("moveEndHandler",v.x,v.y);else B==a.PINCHZOOM&&g("pinchZoomEndHandler",d(q),d(t))}catch(A){GRUNT.Log.exception(A)}D=false}b=GRUNT.extend({element:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},b);var n=false,l=0,p=TILE5.Device.getConfig().supportsTouch,
q=null,t=null,w=null,v=null,y=new TILE5.Vector,B=null,D=false,F=[],G={current:0,last:0},E=TILE5.Device.getConfig(),M={supportsTouch:p,THRESHOLD_DOUBLETAP:300,addListeners:function(u){F.push(u)},decoupleListeners:function(u){for(var A=0;u&&A<F.length;A++)if(F[A].listenerId===u){F.splice(A,1);GRUNT.Log.info("successfully decoupled touch listener: "+u);break}},release:function(){E.eventTarget.removeEventListener(E.supportsTouch?"touchstart":"mousedown",j,false);E.eventTarget.removeEventListener(E.supportsTouch?
"touchmove":"mousemove",o,false);E.eventTarget.removeEventListener(E.supportsTouch?"touchend":"mouseup",m,false)},wheelie:function(u){var A=new TILE5.Vector(u.wheelDeltaX,u.wheelDeltaY);u=new TILE5.Vector(u.clientX,u.clientY);var C=A.y!==0?Math.abs(A.y/120):0;if(C!==0)g("wheelZoomHandler",u,A.y>0?C+0.5:0.5/C);GRUNT.Log.info("capture mouse wheel event, delta = "+A+", position = "+u)}};E.eventTarget.addEventListener(E.supportsTouch?"touchstart":"mousedown",j,false);E.eventTarget.addEventListener(E.supportsTouch?
"touchmove":"mousemove",o,false);E.eventTarget.addEventListener(E.supportsTouch?"touchend":"mouseup",m,false);return M}},h=[];return{captureTouch:function(b,d){try{if(!b)throw Error("Unable to capture touch of null element");if(!b.id)b.id="touchable_"+c++;var g=h[b.id];if(!g){g=f.TouchHelper(GRUNT.extend({element:b},d));h[b.id]=g;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+g.supportsTouch)}d.listenerId&&g.decoupleListeners(d.listenerId);d.listenerId=++e;g.addListeners(d)}catch(j){GRUNT.Log.exception(j)}},
resetTouch:function(b){if(b&&b.id&&h[b.id]){h[b.id].release();delete h[b.id]}},Pannable:function(b){b=GRUNT.extend({container:null,onPan:null,onPanEnd:null,onAnimate:null,checkOffset:null},b);var d=false,g=new TILE5.Vector,j={pannable:true,getOffset:function(){return new TILE5.Vector(g.x,g.y)},setOffset:function(m,n){g.x=m;g.y=n},pan:function(m,n,l){if(l)j.updateOffset(g.x+m,g.y+n,l);else{j.updateOffset(g.x+m,g.y+n);b.onPan&&b.onPan(m,n)}},isAnimating:function(){return d},panEnd:function(m,n){b.onPanEnd&&
b.onPanEnd(m,n)},updateOffset:function(m,n,l){if(l){m=new TILE5.Vector(m,n);d=true;l=TILE5.Animation.tweenVector(g,m.x,m.y,l,function(){d=false;j.panEnd(0,0)});for(m=l.length;m--;){l[m].cancelOnInteract=true;l[m].requestUpdates(function(){b.onAnimate&&b.onAnimate(g.x,g.y)})}}else j.setOffset(m,n)}},o=document.getElementById(b.container);o&&TILE5.Touch.captureTouch(o,{moveHandler:function(m,n){j.pan(-m,-n)},moveEndHandler:function(m,n){j.panEnd(m,n)}});return j},Scalable:function(b){function d(v,y){j=
TILE5.V.getRect(v);o=TILE5.V.getRect(y);var B=TILE5.D.getSize(j.dimensions),D=TILE5.D.getSize(o.dimensions);q=TILE5.R.getCenter(o);m=j&&B!==0?D/B:1}b=GRUNT.extend({container:null,onAnimate:null,onPinchZoom:null,onScale:null,scaleDamping:false},b);var g=false,j=null,o=null,m=1,n=null,l=null,p=null,q=null,t={scalable:true,animate:function(v,y,B,D,F){function G(){F&&F();g=false;b.onScale&&b.onScale(m,q);m=1;n=null}g=true;p=TILE5.V.copy(y);q=TILE5.V.copy(B);j=null;if(D){l=m;TILE5.Animation.tweenValue(0,
v-l,D,G,1E3).requestUpdates(function(E){n=E/(v-l);m=l+E;b.onAnimate&&b.onAnimate()})}else{m=v;G()}},getScaleInfo:function(){return{factor:m,startRect:TILE5.R.copy(j),endRect:TILE5.R.copy(o),start:p,center:q,progress:n}},getScaling:function(){return g},getScaleFactor:function(){return m}},w=document.getElementById(b.container);w&&TILE5.Touch.captureTouch(w,{pinchZoomHandler:function(v,y){d(v,y);(g=m!==1)&&b.onPinchZoom&&b.onPinchZoom(v,y)},pinchZoomEndHandler:function(v,y){d(v,y);g=false;b.onScale&&
b.onScale(m,q,true);m=1},wheelZoomHandler:function(v){j=o=null;q=TILE5.V.copy(v)}});return t}}}();if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(s){return this.each(function(){TILE5.Touch.captureTouch(this,s)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(s){s.preventDefault()})}}
TILE5.Dispatcher=function(){var s=[],r={execute:function(k){var a=r.findAction(k);GRUNT.Log.info("looking for action id: "+k+", found: "+a);if(a){var i=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+k,function(){a.execute(i)})}},findAction:function(k){for(var a=s.length;a--;)if(s[a].id==k)return s[a];return null},getRegisteredActions:function(){return[].concat(s)},getRegisteredActionIds:function(){for(var k=[],a=s.length;a--;)s[a].id&&k.push(s[a].id);return k},registerAction:function(k){k&&
k.id&&s.push(k)},Action:function(k){k=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},k);var a={id:k.id,execute:function(){k.execute&&k.execute.apply(this,arguments)},getParam:function(i){return k[i]?k[i]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",a.id,k.title,k.icon)}};k.autoRegister&&r.registerAction(a);return a},createAgent:function(k){k=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},k);var a=null,i={getName:function(){return k.name},
getParam:function(c){return k[c]},getId:function(){return GRUNT.toID(i.getName())},run:function(c,e){if(k.execute){var f=a=TILE5.Clock.getTime(true),h=k.translator?k.translator(c):c;k.execute.call(i,h,function(b,d){if(!k.trashOrphanedResults||f==a)e&&e(b,d,h)})}}};return i},runAgents:function(k,a,i){for(var c=0;c<k.length;c++)k[c].run(a,i)}};return r}();
TILE5.Animation=function(){function s(){if(a===0)a=setInterval(function(){var c;c=TILE5.Clock.getTime();if(!k){k=true;try{for(var e=0;e<r.length;)if(r[e].isComplete()){r[e].triggerComplete(false);r.splice(e,1);GRUNT.WaterCooler.say("animation.complete")}else{r[e].update(c);e++}}finally{k=false}}c=r.length;if(c===0){clearInterval(a);a=0}},20)}var r=[],k=false,a=0,i={DURATION:2E3,tweenValue:function(c,e,f,h,b){c=new i.Tween({startValue:c,endValue:e,tweenFn:f,complete:h,duration:b});r.push(c);return c},
tween:function(c,e,f,h,b,d){c=new i.Tween({target:c,property:e,endValue:f,tweenFn:h,duration:d,complete:b});r.push(c);return c},tweenVector:function(c,e,f,h,b,d){var g=[];if(c){var j=c.x==e,o=c.y==f;j||g.push(i.tween(c,"x",e,h,function(){(j=true)&&o&&b()},d));o||g.push(i.tween(c,"y",f,h,function(){o=true;j&&o&&b()},d))}return g},cancel:function(c){if(!k){k=true;try{for(var e=0;e<r.length;)if(!c||c(r[e])){GRUNT.Log.info("CANCELLING ANIMATION");r[e].triggerComplete(true);r.splice(e,1)}else e++}finally{k=
false}}},isTweening:function(){return r.length>0},Tween:function(c){c=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:i.DURATION,tweenFn:i.DEFAULT,complete:null,cancelOnInteract:false},c);var e=TILE5.Clock.getTime(),f=[],h=false,b=0,d=0,g={cancelOnInteract:c.cancelOnInteract,isComplete:function(){return h},triggerComplete:function(j){c.complete&&c.complete(j)},update:function(j){try{var o=c.tweenFn(j-e,b,d,c.duration);if(c.target)c.target[c.property]=o;for(var m=f.length;m--;)f[m](o,
void 0);if(h=e+c.duration<=j){if(c.target)c.target[c.property]=c.tweenFn(c.duration,b,d,c.duration);for(var n=f.length;n--;)f[n](o,true)}}catch(l){GRUNT.Log.exception(l)}},requestUpdates:function(j){f.push(j)}};b=c.target&&c.property&&c.target[c.property]?c.target[c.property]:c.startValue;if(typeof c.endValue!=="undefined")d=c.endValue-b;if(d==0)h=true;s();return g},Easing:function(){var c=1.70158;return{Linear:function(e,f,h,b){return h*e/b+f},Back:{In:function(e,f,h,b){return h*(e/=b)*e*((c+1)*
e-c)+f},Out:function(e,f,h,b){return h*((e=e/b-1)*e*((c+1)*e+c)+1)+f},InOut:function(e,f,h,b){return(e/=b/2)<1?h/2*e*e*(((c*=1.525)+1)*e-c)+f:h/2*((e-=2)*e*(((c*=1.525)+1)*e+c)+2)+f}},Bounce:{In:function(e,f,h,b){return h-i.Easing.Bounce.Out(b-e,0,h,b)+f},Out:function(e,f,h,b){return(e/=b)<1/2.75?h*7.5625*e*e+f:e<2/2.75?h*(7.5625*(e-=1.5/2.75)*e+0.75)+f:e<2.5/2.75?h*(7.5625*(e-=2.25/2.75)*e+0.9375)+f:h*(7.5625*(e-=2.625/2.75)*e+0.984375)+f},InOut:function(e,f,h,b){return e<b/2?i.Easing.Bounce.In(e*
2,0,h,b)/2+f:i.Easing.Bounce.Out(e*2-b,0,h,b)/2+h/2+f}},Cubic:{In:function(e,f,h,b){return h*(e/=b)*e*e+f},Out:function(e,f,h,b){return h*((e=e/b-1)*e*e+1)+f},InOut:function(e,f,h,b){if((e/=b/2)<1)return h/2*e*e*e+f;return h/2*((e-=2)*e*e+2)+f}},Elastic:{In:function(e,f,h,b,d,g){if(e==0)return f;if((e/=b)==1)return f+h;g||(g=b*0.3);if(!d||d<Math.abs(h)){d=h;h=g/4}else h=g/(2*Math.PI)*Math.asin(h/d);return-(d*Math.pow(2,10*(e-=1))*Math.sin((e*b-h)*2*Math.PI/g))+f},Out:function(e,f,h,b,d,g){var j;if(e==
0)return f;if((e/=b)==1)return f+h;g||(g=b*0.3);if(!d||d<Math.abs(h)){d=h;j=g/4}else j=g/(2*Math.PI)*Math.asin(h/d);return d*Math.pow(2,-10*e)*Math.sin((e*b-j)*2*Math.PI/g)+h+f},InOut:function(e,f,h,b,d,g){var j;if(e==0)return f;if((e/=b/2)==2)return f+h;g||(g=b*0.3*1.5);if(!d||d<Math.abs(h)){d=h;j=g/4}else j=g/(2*Math.PI)*Math.asin(h/d);if(e<1)return-0.5*d*Math.pow(2,10*(e-=1))*Math.sin((e*b-j)*2*Math.PI/g)+f;return d*Math.pow(2,-10*(e-=1))*Math.sin((e*b-j)*2*Math.PI/g)*0.5+h+f}},Quad:{In:function(e,
f,h,b){return h*(e/=b)*e+f},Out:function(e,f,h,b){return-h*(e/=b)*(e-2)+f},InOut:function(e,f,h,b){if((e/=b/2)<1)return h/2*e*e+f;return-h/2*(--e*(e-2)-1)+f}},Sine:{In:function(e,f,h,b){return-h*Math.cos(e/b*(Math.PI/2))+h+f},Out:function(e,f,h,b){return h*Math.sin(e/b*(Math.PI/2))+f},InOut:function(e,f,h,b){return-h/2*(Math.cos(Math.PI*e/b)-1)+f}}}}()};return GRUNT.extend(i,{DEFAULT:i.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var s={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},r=0,k={DisplayState:s,AnyDisplayState:255,ActiveDisplayStates:s.ACTIVE|s.ANIMATING,DefaultDisplayStates:s.ACTIVE|s.ANIMATING|s.PAN|s.PINCHZOOM,ViewLayer:function(a){a=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:k.DefaultDisplayStates},a);var i=null,c=a.id,e=GRUNT.extend({addToView:function(f){f.setLayer(c,e)},shouldDraw:function(f){var h=
i?i.fastDraw&&f!==s.ACTIVE:false;return(f&a.validStates)!==0&&(h?a.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:c})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:i?i.id:null})},getId:function(){return c},setId:function(f){c=f},getParent:function(){return i},setParent:function(f){i=f}},a);return e},AnimatedPathLayer:function(a){function i(d,g,j){d.fillStyle="#FFFFFF";d.strokeStyle="#222222";d.beginPath();
d.arc(j.x,j.y,4,0,Math.PI*2,false);d.stroke();d.fill()}a=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,validStates:k.ActiveDisplayStates|s.PAN|s.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},a);var c=TILE5.V.edges(a.path),e,f=null,h=0;TILE5.Animation.tweenValue(0,c.total,a.easing,function(){b.remove()},a.duration).requestUpdates(function(d,g){h=d;g&&b.remove()});var b=GRUNT.extend(new k.ViewLayer(a),{cycle:function(){for(var d=
0;d<c.accrued.length&&c.accrued[d]<h;)d++;f=null;if(d<a.path.length-1){var g=h-(d>0?c.accrued[d-1]:0),j=a.path[d],o=a.path[d+1];e=TILE5.V.theta(j,o,c.edges[d]);f=TILE5.V.pointOnEdge(j,o,e,g);if(a.autoCenter)(d=b.getParent())&&d.centerOn(f)}return f?1:0},draw:function(d,g){if(f)(a.drawIndicator?a.drawIndicator:i)(d,g,new TILE5.Vector(f.x-g.x,f.y-g.y),e)}});return b},FPSLayer:function(a){a=GRUNT.extend({zindex:1E3,scalePosition:false},a);var i=null,c=GRUNT.extend(new k.ViewLayer(a),{delays:[],draw:function(e,
f,h){e.font="bold 8pt Arial";e.textAlign="right";e.fillStyle="rgba(0, 0, 0, 0.8)";e.fillText((i?i:"?")+" fps",h.width-20,20)}});setInterval(function(){for(var e=0,f=c.delays.length,h=f;h--;)e+=c.delays[h];if(f!==0)i=Math.floor(1E3/(e/f))},1E3);return c},ResourceStatsLayer:function(a){a=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:s.ACTIVE|s.PAN},a);return GRUNT.extend(new k.ViewLayer(a),{fps:null,draw:function(i){var c=TILE5.Resources.getStats(),e=a.indicatorSize,f=10,
h;if(c.imageCacheFullness){i.strokeStyle="rgba(0, 0, 255, 1)";i.beginPath();i.arc(15,15,5,0,Math.PI*2*c.imageCacheFullness,false);i.stroke();f=30}if(c.imageLoadingCount>=0){i.fillStyle="rgba(0, 255, 0, 0.7)";for(h=c.imageLoadingCount;h--;)i.fillRect(f+h*(e+2),10,e,e)}if(c.queuedImageCount>=0){i.fillStyle="rgba(255, 0, 0, 0.7)";for(h=c.queuedImageCount;h--;)i.fillRect(f+h*(e+2),10+e+2,e,e)}}})},LoadingLayer:function(a){GRUNT.extend({},a)},View:function(a){function i(x,z){z.setId(x);z.setParent(J);
b.push(z);b.sort(function(I,K){var L=K.zindex-I.zindex;if(L===0)L=K.created-I.created;return L})}function c(){GRUNT.WaterCooler.say("view.idle",{id:J.id});E=true;u=0}function e(x,z){var I=0,K=J.getScaleFactor(),L=J.getDisplayState(),T=(new Date).getTime(),R=(L&s.PINCHZOOM)!==0;m=J.getScaleFactor();var Q=0;if(o||R){x.clearRect(0,0,d.width,d.height);o=false}if(R){var N=G.getScaleInfo();TILE5.D.getCenter(w);var P=(N.progress?N.progress:1)/2;D=N.center;if(N.startRect){P=TILE5.R.getCenter(N.startRect);
P=TILE5.V.diff(P,D);A=new TILE5.Vector(D.x+P.x,D.y+P.y)}else{N=TILE5.V.diff(N.start,D);A=new TILE5.Vector(D.x-N.x*P,D.y-N.y*P)}if(A)z=TILE5.V.offset(z,A.x,A.y)}x.save();try{if(q!==1)x.scale(q,q);else if(R){x.translate(D.x,D.y);x.scale(K,K)}for(Q=b.length;Q--;)if(b[Q].shouldDraw(L)){var S=b[Q].draw(x,z,w,L,J);I+=S?S:0}}finally{x.restore()}GRUNT.Log.trace("draw complete",T);return I}function f(){var x=0,z=H===s.PINCHZOOM||H===s.PAN;C=(new Date).getTime();j=F?F.getOffset():new TILE5.Vector;j.x=Math.floor(j.x);
j.y=Math.floor(j.y);B&&n&&B.delays.push(C-n);if(z){TILE5.Animation.cancel(function(K){return K.cancelOnInteract});E=false;if(u!==0){clearTimeout(u);u=0}}for(z=b.length;z--;){var I=b[z].cycle(C,j);x+=I?I:0}x+=e(g,j);n=C;M=0;if(y+x>0)h();else if(!E&&u===0)u=setTimeout(c,500);GRUNT.Log.trace("Completed draw cycle",C)}function h(){y++;if(!(p||M!==0)){y=0;M=setTimeout(f,0)}}a=GRUNT.extend({id:"view_"+r++,container:"",pannable:false,scalable:false,clearOnDraw:false,displayFPS:false,displayResourceStats:false,
scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,onPan:null,onPinchZoom:null,onScale:null,onDraw:null,autoSize:false},a);var b=[],d=document.getElementById(a.container),g=null,j=new TILE5.Vector,o=false,m=1,n=null,l=0,p=false,q=1,t=new TILE5.Vector,w=null,v=null,y=0,B=null,D=null,F=null,G=null,E=false,M=0,u=0,A=null,C=0,H=k.DisplayState.ACTIVE;GRUNT.Log.info("Creating a new view instance, attached to container: "+
a.container+", canvas = ",d);if(d){TILE5.Touch.resetTouch(d);if(a.autoSize){GRUNT.Log.info("autosizing view: window.height = "+window.innerHeight+", width = "+window.innerWidth);d.height=window.innerHeight-d.offsetTop;d.width=window.innerWidth-d.offsetLeft}try{g=d.getContext("2d");g.globalCompositeOperation=a.initialDrawMode;g.clearRect(0,0,d.width,d.height)}catch(O){GRUNT.Log.exception(O);throw Error("Could not initialise canvas on specified view element");}}if(a.pannable)F=new TILE5.Touch.Pannable({container:a.container,
onAnimate:function(){h()},onPan:function(x,z){l=TILE5.Clock.getTime(true);h();t=TILE5.V.offset(t,x,z);a.onPan&&a.onPan(x,z);H=s.PAN},onPanEnd:function(){h();H=s.ACTIVE}});if(a.scalable)G=new TILE5.Touch.Scalable({scaleDamping:a.scaleDamping,container:a.container,onAnimate:function(){H=k.DisplayState.PINCHZOOM;h()},onPinchZoom:function(x,z){l=TILE5.Clock.getTime(true);h();a.onPinchZoom&&a.onPinchZoom(x,z);H=k.DisplayState.PINCHZOOM},onScale:function(x,z){GRUNT.WaterCooler.say("view.scale",{id:J.id});
H=k.DisplayState.ACTIVE;h();a.onScale&&a.onScale(x,z)}});var J=GRUNT.extend({},a,F,G,{id:a.id,deviceScaling:q,fastDraw:a.fastDraw||TILE5.Device.getConfig().requireFastDraw,centerOn:function(x){F.setOffset(x.x-d.width/2,x.y-d.height/2)},getDimensions:function(){if(d)return new TILE5.Dimensions(d.width,d.height)},getZoomCenter:function(){return A},getLayer:function(x){for(var z=0;z<b.length;z++)if(b[z].getId()==x)return b[z];return null},setLayer:function(x,z){for(var I=0;I<b.length;I++)if(b[I].getId()===
x){b.splice(I,1);break}z&&i(x,z);GRUNT.WaterCooler.say("layer.update",{id:x});h()},eachLayer:function(x){for(var z=0;z<b.length;z++)x(b[z])},clearBackground:function(){o=true},freeze:function(){p=true},unfreeze:function(){p=false;h()},snapshot:function(){},getDisplayState:function(){return p?s.FROZEN:H},scale:function(x,z,I,K,L){K||(K=TILE5.D.getCenter(w));L||(L=TILE5.D.getCenter(w));G&&G.animate(x,K,L,z,I);return G},removeLayer:function(x){a:{for(var z=b.length;z--;)if(b[z].getId()==x){x=z;break a}x=
-1}if(x>=0&&x<b.length){GRUNT.WaterCooler.say("layer.removed",{layer:b[x]});b.splice(x,1)}}});w=J.getDimensions();v=TILE5.D.getCenter(w);GRUNT.WaterCooler.listen("layer.remove",function(x){x.id&&J.removeLayer(x.id)});GRUNT.WaterCooler.listen("view.wake",function(x){if(!x.id||x.id===J.id)h()});q=TILE5.Device.getConfig().getScaling();if(a.displayFPS){B=new k.FPSLayer;J.setLayer("fps",B)}a.displayResourceStats&&J.setLayer("resourceStats",new k.ResourceStatsLayer);h();return J}};return k}();
TILE5.Tiling=function(){function s(){if(!k){k=document.createElement("canvas");k.width=i.Config.TILESIZE;k.height=i.Config.TILESIZE;var c=k.getContext("2d");c.fillStyle="rgba(150, 150, 150, 0.025)";c.fillRect(0,0,k.width,k.height)}return k}function r(){if(!a){a=document.createElement("canvas");a.width=i.Config.TILESIZE;a.height=i.Config.TILESIZE;var c=a.getContext("2d"),e=Math.floor(Math.sqrt(i.Config.TILESIZE));c.fillStyle="rgba(200, 200, 200, 1)";c.strokeStyle="rgb(190, 190, 190)";c.lineWidth=0.5;
c.fillRect(0,0,a.width,a.height);c.beginPath();for(var f=0;f<a.width;f+=e){c.moveTo(f,0);c.lineTo(f,a.height);for(var h=0;h<a.height;h+=e){c.moveTo(0,h);c.lineTo(a.width,h)}}c.stroke()}return a}TileStore=function(c){c=GRUNT.extend({gridSize:20,center:new TILE5.Vector,onPopulate:null},c);var e=Array(Math.pow(c.gridSize,2)),f=TILE5.V.offset(c.center,-Math.ceil(c.gridSize>>1)),h=null,b=new TILE5.Vector,d=null,g={getGridSize:function(){return c.gridSize},getNormalizedPos:function(j,o){return TILE5.V.add(new TILE5.Vector(j,
o),TILE5.V.invert(f),b)},getTileShift:function(){return TILE5.V.copy(b)},getTile:function(j,o){return j>=0&&j<c.gridSize?e[o*c.gridSize+j]:null},setTile:function(j,o,m){e[o*c.gridSize+j]=m},populate:function(j,o){var m=GRUNT.Log.getTraceTicks(),n=0;new TILE5.Vector(c.gridSize/2,c.gridSize/2);if(j)for(var l=0;l<c.gridSize;l++)for(var p=0;p<c.gridSize;p++){if(!e[n]){var q=j(p,l,f,c.gridSize);e[n]=q}n++}h=j;d=o;GRUNT.Log.trace("tile grid populated",m);c.onPopulate&&c.onPopulate()},getShiftDelta:function(j,
o,m,n){var l=Math.floor(c.gridSize*0.2),p=new TILE5.Vector;if(j<0||j+m>c.gridSize)p.x=j<0?-l:l;if(o<0||o+n>c.gridSize)p.y=o<0?-l:l;return p},shift:function(j,o){if(!(j.x===0&&j.y===0)){var m=GRUNT.Log.getTraceTicks(),n=Array(e.length);n.length=e.length;for(var l=0;l<c.gridSize;l++)for(var p=0;p<c.gridSize;p++)n[p*c.gridSize+l]=g.getTile(l+j.x,p+j.y);e=n;f=o?o(f,j):TILE5.V.add(f,j);b.x+=-j.x*c.tileSize;b.y+=-j.y*c.tileSize;GRUNT.Log.trace("tile storage shifted",m);g.populate(h,d)}},setOrigin:function(j,
o){if(tileOrigin)shiftOrigin(j,o);else f=TILE5.V.offset(new TILE5.Vector(j,o),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var j=e.length;j--;)if(e[j])e[j].loaded=false});return g};var k=null,a=null,i={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(c){return c=GRUNT.extend({x:0,y:0,size:256},c)},ImageTile:function(c){c=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},c);return new i.Tile(c)},TileGrid:function(c){function e(q,t,w,
v){if((d?TILE5.V.absSize(TILE5.V.diff(d,t)):h)>=20){q=f.getTileShift();q=new TILE5.Vector(Math.floor((t.x+q.x)*b),Math.floor((t.y+q.y)*b));var y=Math.ceil(w.width*b)+1;w=Math.ceil(w.height*b)+1;var B=new TILE5.Vector(Math.floor((y-1)/2),Math.floor((w-1)/2)),D=new TILE5.Vector(q.x*c.tileSize,q.y*c.tileSize);v.isAnimating();o=[];tilesNeeded=false;for(var F=w;F--;)for(var G=F*c.tileSize+D.y,E=y;E--;){v=f.getTile(E+q.x,F+q.y);var M=E*c.tileSize+D.x,u=new TILE5.Vector(E-B.x,F-B.y);v||(n=f.getShiftDelta(q.x,
q.y,y,w));o.push({tile:v,coordinates:new TILE5.Vector(M,G),centerness:TILE5.V.absSize(u)})}o.sort(function(A,C){return C.centerness-A.centerness});d=TILE5.V.copy(t)}}c=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},c);var f=new TileStore(GRUNT.extend({onPopulate:function(){g=true;p.wakeParent()}},c)),h=Math.round(c.tileSize/2),b=c.tileSize?1/c.tileSize:0,d=null,g=false,j=true,o=[],m=false;new TILE5.Vector;var n=new TILE5.Vector,
l=f.getGridSize()*c.tileSize,p=GRUNT.extend(new TILE5.Graphics.ViewLayer(c),{gridDimensions:new TILE5.Dimensions(l,l),cycle:function(){var q=0;if(n.x+n.y!==0){f.shift(n,c.shiftOrigin);n=new TILE5.Vector;q++}return q+g?1:0},deactivate:function(){j=false},drawTile:function(){return false},draw:function(q,t,w,v,y){if(j){var B=GRUNT.Log.getTraceTicks(),D=f.getTileShift(),F=t.x+D.x;D=t.y+D.y;var G=true;if(v!==TILE5.Graphics.DisplayState.PINCHZOOM){e(q,t,w,y);GRUNT.Log.trace("updated draw queue",B)}if(c.drawGrid)q.strokeStyle=
"rgba(50, 50, 50, 0.3)";q.beginPath();for(t=o.length;t--;){w=o[t].tile;y=o[t].coordinates.x-F;var E=o[t].coordinates.y-D;G=w?p.drawTile(q,w,y,E,v)&&G:false;c.drawGrid&&q.rect(y,E,c.tileSize,c.tileSize)}q.stroke();GRUNT.Log.trace("drawn tiles",B);G&&!m&&GRUNT.WaterCooler.say("tiles.drawn",{id:p.getId()});m=G;g=false}},getTileVirtualXY:function(q,t,w){q=f.getNormalizedPos(q,t);q=new TILE5.Vector(q.x*c.tileSize,q.y*c.tileSize);if(w){q.x+=h;q.y+=h}return q},populate:function(q){f.populate(q,function(){})}});
GRUNT.WaterCooler.listen("tile.loaded",function(){g=true;p.wakeParent()});return p},ImageTileGrid:function(c){function e(){GRUNT.WaterCooler.say("tile.loaded")}c=GRUNT.extend({},c);return GRUNT.extend(new i.TileGrid(c),{drawTile:function(f,h,b,d,g){var j=TILE5.Resources.getImage(h.url),o=false;g===TILE5.Graphics.DisplayState.PAN&&f.drawImage(r(),b,d);if(j&&j.complete&&j.width>0){f.drawImage(j,b,d);o=true}else{f.drawImage(s(),b,d);j||TILE5.Resources.loadImage(h.url,e)}return o}})},Tiler:function(c){c=
GRUNT.extend({container:"",drawCenter:false,onPan:null,onPanEnd:null,tapHandler:null,doubleTapHandler:null,zoomHandler:null,onDraw:null,datasources:{},tileLoadThreshold:"first"},c);var e=new TILE5.Graphics.View(GRUNT.extend({},c,{pannable:true,scalable:true,scaleDamping:true}));TILE5.Touch.captureTouch(document.getElementById(c.container),c);GRUNT.extend(e,{getTileLayer:function(){return e.getLayer("grid0")},setTileLayer:function(f){e.setLayer("grid0",f);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},
viewPixToGridPix:function(f){var h=e.getOffset();return new TILE5.Vector(f.x+h.x,f.y+h.y)},cleanup:function(){e.removeLayer("grid0")}});return e}};return i}();
TILE5.Geo=function(){function s(b,d){var g=null;for(var j in f)if(d){if(j==d&&f[j][b]){g=f[j];break}}else if(f[j][b]){g=f[j];break}return g}function r(b,d,g,j){var o=0;b=b.toUpperCase();for(var m in j){var n=d[m];if(n){var l=g[m];n=l?l(b,n):b.containsWord(n)?1:0;o+=n*j[m]}}return o}var k=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],a=Math.PI/180,i=180/Math.PI,c=null,e={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},f={},h={Engine:function(b){if(!b.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var d=GRUNT.extend({remove:function(){delete f[d.id]}},b);return f[d.id]=d},Radius:function(b,d){return{distance:parseInt(b,10),uom:d}},Position:function(b,d){return{lat:parseFloat(b?b:0),lon:parseFloat(d?d:0)}},BoundingBox:function(b,d){return{min:h.P.parse(b),max:h.P.parse(d)}},Address:function(b){return b=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},b)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var b={lat2pix:function(d,g){var j=parseFloat(d)*2*Math.PI/360;j=Math.sin(j);var o=0.08181919084262157*j;return Math.log((1+j)/(1-j)*Math.pow((1-o)/(1+o),0.08181919084262157))/2/g},lon2pix:function(d,g){return parseFloat(d)/180*Math.PI/g},pix2lon:function(d,g){return b.normalizeLon(d*g*180/Math.PI)},pix2lat:function(d,g){for(var j=Math.pow(Math.E,-d*g),o=b.mercatorUnproject(j),
m=b.findRadPhi(o,j),n=0;n<12&&Math.abs(o-m)>1.0E-7;){o=m;m=b.findRadPhi(o,j);n++}return m*180/Math.PI},mercatorUnproject:function(d){return Math.PI/2-2*Math.atan(d)},findRadPhi:function(d,g){var j=0.08181919084262157*Math.sin(d);return Math.PI/2-2*Math.atan(g*Math.pow((1-j)/(1+j),0.040909595421310785))},normalizeLon:function(d){for(;d<-180;)d+=360;for(;d>180;)d-=360;return d}};return b}(),GeoSearchResult:function(b){b=GRUNT.extend({id:null,caption:"",resultType:"",data:null,pos:null,matchWeight:0},
b);return GRUNT.extend(b,{toString:function(){return b.caption+(b.matchWeight?" ("+b.matchWeight+")":"")}})},GeoSearchAgent:function(b){b=GRUNT.extend({},b);return GRUNT.extend({},TILE5.Dispatcher.createAgent(b))},GeocodingAgent:function(b){b=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(d,g){try{if(!d.reverse&&!d.freeform)address=new h.Address(d);var j=h.getEngine("geocode");if(j)j.geocode({addresses:[d.freeform?d.freeform:address],complete:function(m,n){if(g){var l=
n;if(d.freeform)l=h.rankGeocodeResponses(d.freeform,l,h.getEngine("geocode"));g(l,b)}}})}catch(o){GRUNT.Log.exception(o)}}},b);return new h.GeoSearchAgent(b)},PointOfInterest:function(b){b=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},b);if(!b.pos&&b.lat&&b.lon)b.pos=new TILE5.Geo.Position(b.lat,b.lon);return GRUNT.extend({toString:function(){return b.id+": '"+b.title+"'"}},b)},POIStorage:function(b){function d(l){l=l?l:"default";o[l]||(o[l]=[]);return o[l]}function g(l){var p=
[];for(var q in o)for(var t=0;t<o[q].length;t++)if(!l||l(o[q][t]))p.push(o[q][t]);return p}function j(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:n.id,pois:n.getPOIs()})}b=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},b);var o={},m=true,n={id:GRUNT.generateObjectID(),getPOIs:function(){return g()},getOldPOIs:function(l,p){return g(function(q){return q.group==l&&q.retrieved<p})},getVisible:function(){return m},setVisible:function(l){if(l!=m){m=l;b.visibilityChange&&b.visibilityChange()}},
findById:function(l){var p=g(function(q){return q.id==l});return p.length>0?p[0]:null},findByBounds:function(l){return g(function(p){return TILE5.Geo.P.inBounds(p.pos,l)})},addPOIs:function(l,p){if(p)o={};for(var q=0;l&&q<l.length;q++){l[q].retrieved=TILE5.Clock.getTime(true);var t=l[q];d(t.group).push(t)}},removeGroup:function(l){if(o[l]){delete o[l];j()}},update:function(l){var p=[],q=0,t=l.length>0?l[0].group:"",w=TILE5.Clock.getTime(true);for(q=0;q<l.length;q++){var v;a:{if(v=l[q])for(var y=d(v.group),
B=0;B<y.length;B++)if(y[B].id==v.id){v=y[B];break a}v=null}if(v){v.retrieved=w;v.isNew=false}else p.push(l[q])}l=n.getOldPOIs(t,w);n.addPOIs(p);for(q=0;b.onPOIAdded&&q<p.length;q++)b.onPOIAdded(p[q]);for(q=0;q<l.length;q++){b.onPOIDeleted&&b.onPOIDeleted(l[q]);t=l[q];w=d(t.group);for(v=0;v<w.length;v++)if(w[v].id==t.id){w.splice(v,1);break}}p.length+l.length>0&&j()}};return n},MapProvider:function(){return{zoomLevel:0,checkZoomLevel:function(b){return b},getCopyright:function(){},getMapTiles:function(){},
getPositionForXY:function(){return null}}},P:function(){var b={calcDistance:function(d,g){if(b.empty(d)||b.empty(g))return 0;var j=(g.lat-d.lat).toRad()/2,o=(g.lon-d.lon).toRad()/2;j=Math.sin(j)*Math.sin(j)+Math.cos(d.lat.toRad())*Math.cos(g.lat.toRad())*Math.sin(o)*Math.sin(o);return 6371*2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j))},copy:function(d){return d?new h.Position(d.lat,d.lon):null},empty:function(d){return!d||d.lat===0&&d.lon===0},equal:function(d,g){return d&&g&&d.lat==g.lat&&d.lon==g.lon},
almostEqual:function(d,g){return d&&g&&Math.floor(d.lat*1E3)===Math.floor(g.lat*1E3)&&Math.floor(d.lon*1E3)===Math.floor(g.lon*1E3)},inArray:function(d,g){for(var j=h.P.equal,o=g.length;o--;)if(j(d,g[o]))return true;return false},inBounds:function(d,g){var j=!(h.P.empty(d)||h.P.empty(g));return j=(j=j&&d.lat>=g.min.lat&&d.lat<=g.max.lat)&&d.lon>=g.min.lon&&d.lon<=g.max.lon},parse:function(d){if(d)if(typeof d.lat!=="undefined")return b.copy(d);else{if(d.split)for(var g=[" ",","],j=0;j<g.length;j++){var o=
d.split(g[j]);if(o.length===2)return new h.Position(o[0],o[1])}}else return new h.Position;return null},parseArray:function(d){var g=d.length,j=Array(g);for(g=g;g--;)j[g]=b.parse(d[g]);GRUNT.Log.info("parsed "+j.length+" positions");return j},fromMercatorPixels:function(d,g,j){return new h.Position(TILE5.Geo.Utilities.pix2lat(g,j),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(d,j)))},toMercatorPixels:function(d,g){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(d.lon,g),TILE5.Geo.Utilities.lat2pix(d.lat,
g))},generalize:function(d,g,j){var o=d.length,m=[],n=null;j||(j=250);j/=1E3;GRUNT.Log.info("generalizing positions, must include "+g.length+" positions");for(var l=o;l--;)if(l===0)m.unshift(d[l]);else{var p=!n||h.P.inArray(d[l],g)?j:h.P.calcDistance(n,d[l]);if(d[l]&&p>=j){m.unshift(d[l]);n=d[l]}}GRUNT.Log.info("generalized "+o+" positions into "+m.length+" positions");return m},toString:function(d){return d?d.lat+" "+d.lon:""}};return b}(),B:function(){var b=-(Math.PI/2),d=Math.PI/2,g=-Math.PI*2,
j=Math.PI*2,o={calcSize:function(m,n,l){var p=new TILE5.Vector(0,n.lat-m.lat);if(typeof l==="undefined")l=true;p.x=l&&m.lon>n.lon?360-m.lon+n.lon:n.lon-m.lon;return p},createBoundsFromCenter:function(m,n){var l=n/6371,p=m.lat*a,q=m.lon*a,t=p-l,w=p+l;if(t>b&&w<d){p=Math.asin(Math.sin(l)/Math.cos(p));l=q-p;if(l<g)l+=2*Math.PI;q=q+p;if(q>j)q-=2*Math.PI}else{t=Math.max(t,b);w=Math.min(w,d);l=g;q=j}return new h.BoundingBox(new h.Position(t*i,l*i),new h.Position(w*i,q*i))},expand:function(m,n){return new h.BoundingBox(new h.Position(m.min.lat-
n,m.min.lon-h.Utilities.normalizeLon(n)),new h.Position(m.max.lat+n,m.max.lon+h.Utilities.normalizeLon(n)))},forPositions:function(m,n){var l=null,p=TILE5.Clock.getTime();n||(n="auto");for(var q=m.length;q--;)if(l){var t=o.calcSize(l.min,m[q],false),w=o.calcSize(m[q],l.max,false);if(t.x<0)l.min.lon=m[q].lon;if(t.y<0)l.min.lat=m[q].lat;if(w.x<0)l.max.lon=m[q].lon;if(w.y<0)l.max.lat=m[q].lat}else l=new TILE5.Geo.BoundingBox(m[q],m[q]);if(n){if(n=="auto"){q=o.calcSize(l.min,l.max);n=Math.max(q.x,q.y)*
0.3}l=o.expand(l,n)}GRUNT.Log.trace("calculated bounds for "+m.length+" positions",p);return l},getCenter:function(m){var n=h.B.calcSize(m.min,m.max);return new TILE5.Geo.Position(m.min.lat+n.y/2,m.min.lon+n.x/2)},getZoomLevel:function(m,n){var l=o.getCenter(m);l=k[Math.min(Math.round(Math.abs(l.lat)*0.05),k.length)];var p=o.calcSize(m.min,m.max);return Math.min(Math.ceil(Math.log(k[3]*n.height/p.y)/Math.log(2)),Math.ceil(Math.log(l*n.width/p.x)/Math.log(2)))},isEmpty:function(m){return!m||h.P.empty(m.min)||
h.P.empty(m.max)},toString:function(m){return"min: "+h.P.toString(m.min)+", max: "+h.P.toString(m.max)}};return o}(),A:function(){var b=/^(\d+).*$/,d=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(g,j){b.lastIndex=-1;if(b.test(g))for(var o=g.replace(b,"$1"),m=j.split(","),n=0;n<m.length;n++){d.lastIndex=-1;if(d.test(m[n])){var l=d.exec(m[n]);if(o>=parseInt(l[1],10)&&o<=parseInt(l[2],10))return true}else if(o==m[n])return true}return false},normalize:function(g){if(!g)return"";g=g.toUpperCase();
if(!c){var j=[];for(var o in e)j.push(o);c=RegExp("(\\s)("+j.join("|")+")(\\s|$)","i")}c.lastIndex=-1;if(j=c.exec(g))g=g.replace(c,"$1"+e[j[2]]);return g},toString:function(g){return g.streetDetails+" "+g.location}}}(),getEngine:function(b){for(var d=null,g=1;!d&&g<arguments.length;g++)d=s(b,arguments[g]);d=d?d:s(b);if(!d)throw Error("Unable to find GEO engine with "+b+" capability");return d},rankGeocodeResponses:function(b,d,g){var j=[],o=h.AddressCompareFns;if(g&&g.compareFns)o=GRUNT.extend({},
o,g.compareFns);for(g=0;g<d.length;g++)j.push(new h.GeoSearchResult({caption:d[g].toString(),data:d[g],pos:d[g].pos,matchWeight:r(b,d[g],o,h.GeocodeFieldWeights)}));j.sort(function(m,n){return n.matchWeight-m.matchWeight});return j}};return h}();
TILE5.Geo.Location=function(){function s(a){function i(d){try{var g=new TILE5.Geo.Position(d.coords.latitude,d.coords.longitude),j=GRUNT.isPlainObject(d.coords.accuracy)&&d.coords.accuracy.horizontal?d.coords.accuracy.horizontal:d.coords.accuracy;GRUNT.Log.info("got position coordinates: "+g+", accuracy = "+j);if(a.successCallback&&(!h||j<b))a.successCallback(g,f,d);if(j>a.highAccuracyCutoff&&f<2){f=2;a.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");
e()}h=d;b=j}catch(o){GRUNT.Log.exception(o)}}function c(d){if(d.code===d.PERMISSION_DENIED)a.errorCallback&&a.errorCallback(d);else if(d.code===d.POSITION_UNAVAILABLE)a.errorCallback&&a.errorCallback(d);else if(d.code===d.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(a.timeout===0&&a.autoPhasing){f=1;a.timeout=r;a.enableHighAccuracy=false;e()}}}function e(){navigator.geolocation.getCurrentPosition(i,c,a)}a=GRUNT.extend({autoPhasing:true,maximumAge:3E5,timeout:0,
highAccuracyCutoff:10,enableHighAccuracy:true,successCallback:null,errorCallback:null},a);var f=0,h=null,b=1E6;e()}var r=3E3,k={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)k.get=s;return k}();TILE5.Geo.Search=function(){return{bestResults:function(s,r){r||(r=20);for(var k=s.length>0?s[0]:null,a=[],i=0;i<s.length;i++)if(k.matchWeight-s[i].matchWeight<=r)a.push(s[i]);else break;return a}}}();
TILE5.Geo.Routing=function(){var s={calculate:function(r){r=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},r);GRUNT.Log.info("attempting to calculate route");var k=TILE5.Geo.getEngine("route");k&&k.route(r,function(a){if(r.generalize)a.geometry=TILE5.Geo.P.generalize(a.geometry,a.getInstructionPositions());if(r.map){s.createMapOverlay(r.map,a);if(r.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+a.boundingBox);r.map.gotoBounds(a.boundingBox)}}r.success&&
r.success(a)})},createMapOverlay:function(r,k){var a=r.getDimensions();a=new TILE5.Geo.UI.RouteOverlay({data:k,width:a.width,height:a.height});r.setLayer("route",a)},Maneuver:{None:0,Continue:1,TurnLeft:100,TurnLeftSlight:101,TurnLeftSharp:102,TurnRight:110,TurnRightSlight:111,TurnRightSharp:112,TurnAround:190,EnterRoundabout:200,ExitRamp:300},Instruction:function(r){r=GRUNT.extend({position:null,description:"",manuever:s.Maneuver.None},r);return GRUNT.extend(r,{})},RouteData:function(r){r=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},r);if(!r.boundingBox)r.boundingBox=TILE5.Geo.B.forPositions(r.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var k=[],a=0;a<r.instructions.length;a++)r.instructions[a].position&&k.push(r.instructions[a].position);return k}},r)}};return s}();
TILE5.Geo.UI=function(){function s(a){a=GRUNT.extend({size:12,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},a);var i=null,c=function(){var e=document.createElement("canvas");e.width=a.size*4;e.height=a.size*4;var f=e.getContext("2d"),h=new TILE5.Vector(e.width/2,e.height/2),b=a.size,d=["#FFFFFF","#333333"],g=[3,1.5];f.shadowBlur=2;f.shadowColor="rgba(50, 50, 50, 0.5)";f.lineCap="round";for(var j=
0;j<d.length;j++){var o=b;f.lineWidth=g[j];f.strokeStyle=d[j];f.beginPath();f.moveTo(h.x,h.y-o);f.lineTo(h.x,h.y+o);f.moveTo(h.x-o,h.y);f.lineTo(h.x+o,h.y);f.arc(h.x,h.y,b*0.6666,0,2*Math.PI,false);f.stroke();f.shadowBlur=0;f.shadowColor="rgba(0,0,0,0)"}return e}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(e,f,h){if(!i){i=TILE5.D.getCenter(h);i=new TILE5.Vector(Math.round(i.x-c.width/2),Math.round(i.y-c.height/2))}e.drawImage(c,i.x,i.y)}})}var r=0,k={AnnotationTween:null,
GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,radsPerPixel:0},a);var i=TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),c=i.x-a.centerXY.x,e=i.y-a.centerXY.y,f=GRUNT.extend({},a.grid,{getBoundingBox:function(h,b,d,g){return new TILE5.Geo.BoundingBox(f.pixelsToPos(new TILE5.Vector(h,b+g)),f.pixelsToPos(new TILE5.Vector(h+d,b)))},getGridXYForPosition:function(h){h=TILE5.Geo.P.toMercatorPixels(h,a.radsPerPixel);return new TILE5.Vector(h.x-
c,f.gridDimensions.height-(h.y-e))},pixelsToPos:function(h){return TILE5.Geo.P.fromMercatorPixels(c+h.x,e+f.gridDimensions.height-h.y,a.radsPerPixel)}});return f},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var i=true,c=null,e=[],f=0,h=[],b=[],d=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(g,j,o,m){if(i)return null;
var n="routeAnimation"+r++;b.push(n);return new TILE5.Graphics.AnimatedPathLayer({id:n,path:e,zindex:a.zindex+1,easing:g?g:TILE5.Animation.Easing.Sine.InOut,duration:j?j:5E3,drawIndicator:o,autoCenter:m?m:false})},draw:function(g,j,o,m,n){o=0;m=a.data?a.data.geometry:null;if(i){i=false;c=null;e=[];f=0}if(m&&f<m.length){a:{n=n.getTileLayer();h=[];m=GRUNT.Log.getTraceTicks();var l,p,q,t=a.data?a.data.geometry:[],w=t.length,v=a.data?a.data.instructions:[],y=v.length,B=a.calculationsPerCycle,D=0;for(l=
f;l<w;l++){p=n.getGridXYForPosition(t[l]);if(q=!c||l===0||Math.abs(p.x-c.x)+Math.abs(p.y-c.y)>a.pixelGeneralization){e.push(p);c=p}D++;if(D>=B){f=l;break a}}f=w;GRUNT.Log.trace(w+" geometry points generalized to "+e.length+" coordinates",m);c=null;for(l=y;l--;)if(v[l].position){p=n.getGridXYForPosition(v[l].position);if(q=!c||l===0||Math.abs(p.x-c.x)+Math.abs(p.y-c.y)>a.pixelGeneralization){h.push(p);c=p}}}o++}n=e.length;if(n>0&&(!o||a.partialDraw)){g.strokeStyle=a.strokeStyle;g.lineWidth=a.lineWidth;
g.beginPath();g.moveTo(e[n-1].x-j.x,e[n-1].y-j.y);for(n=n;n--;)g.lineTo(e[n].x-j.x,e[n].y-j.y);g.stroke();g.fillStyle=a.waypointFillStyle;for(n=h.length;n--;){g.beginPath();g.arc(h[n].x-j.x,h[n].y-j.y,2,0,Math.PI*2,false);g.stroke();g.fill()}}return o}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var g=b.length;g--;)GRUNT.WaterCooler.say("layer.remove",{id:b[g]});b=[];i=true;d.wakeParent()});return d},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:k.AnnotationTween,
animationSpeed:null},a);var i=false,c={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return i},draw:function(e,f,h,b){if(c.xy){if(c.isNew&&a.tweenIn){var d=c.xy.y;c.xy.y=f.y-20;i=true;TILE5.Animation.tween(c.xy,"y",d,a.tweenIn,function(){c.xy.y=d;i=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(e,f,new TILE5.Vector(c.xy.x-f.x,c.xy.y-f.y),h,b);else{e.beginPath();e.arc(c.xy.x-f.x,c.xy.y-f.y,4,0,Math.PI*2,false);e.fill()}c.isNew=false}}};return c},ImageAnnotation:function(a){a=
GRUNT.extend({imageUrl:null,animatingImageUrl:null,imageAnchor:null},a);var i=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;a.draw=function(e,f,h,b,d){if(a.animatingImageUrl&&c.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);b=a.animatingImageUrl}else b=a.imageUrl;if(f=TILE5.Resources.getImage(b)){if(f.complete&&f.width>0){i||(i=new TILE5.Vector(-f.width>>1,-f.height>>1));h=TILE5.V.offset(h,i.x,i.y);e.drawImage(f,h.x,h.y,f.width,f.height)}}else TILE5.Resources.loadImage(b,function(){d.wakeParent()})};
var c=new k.Annotation(a);return c},AnnotationsOverlay:function(a){function i(b){for(var d=a.map?a.map.getTileLayer():null,g=0;d&&g<b.length;g++)b[g].xy=d.getGridXYForPosition(b[g].pos)}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var c=[],e=false,f=[],h=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(b,d,g,j){b.save();try{var o;e=false;b.fillStyle="rgba(255, 0, 0, 0.75)";b.globalCompositeOperation="source-over";for(o=c.length;o--;){c[o].draw(b,d,j,h);
e=e||c[o].isAnimating()}for(o=f.length;o--;){f[o].draw(b,d,j,h);e=e||f[o].isAnimating()}}finally{b.restore()}return e?1:0},add:function(b){f.push(b);i(f);h.wakeParent()},clear:function(b){f=[];i(f);if(b){c=[];i(c)}h.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(b){if(a.pois&&a.pois.id==b.srcID){b=b.pois;try{c=[];for(var d=0;d<b.length;d++)if(b[d].pos){var g;var j=b[d];if(j&&j.pos){var o=null;if(o=a.createAnnotationForPOI?a.createAnnotationForPOI(j):new k.Annotation({pos:j.pos})){o.isNew=
j.isNew;j.isNew=false}g=o}else g=void 0;g&&c.push(g)}i(c)}catch(m){GRUNT.Log.exception(m)}h.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){i(c);i(f);h.wakeParent()});return h},Tiler:function(a){a=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,copyright:undefined,zoomLevel:0,boundsChange:null,tapPOI:null,tapHandler:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,onTilesLoaded:null},a);if(typeof a.copyright==="undefined")a.copyright=
a.provider?a.provider.getCopyright():"";var i=new TILE5.Vector,c=a.copyright,e=false,f=[],h=0,b=null,d=null,g=a.zoomLevel,j=a.tapHandler;if(!a.provider)a.provider=new TILE5.Geo.MapProvider;var o=new TILE5.Tiling.Tiler(GRUNT.extend({},a,{tapHandler:function(n,l){var p=m.getTileLayer(),q=null;if(p){q=m.viewPixToGridPix(new TILE5.Vector(l.x,l.y));var t=p.pixelsToPos(q),w=p.pixelsToPos(TILE5.V.offset(q,-a.tapExtent,a.tapExtent)),v=p.pixelsToPos(TILE5.V.offset(q,a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+
TILE5.Geo.P.toString(p.pixelsToPos(q)));q=new TILE5.Geo.BoundingBox(w,v);f=m.pois.findByBounds(q);a.tapPOI&&a.tapPOI(f)}j&&j(n,l,t,q)},doubleTapHandler:function(n,l){m.animate(2,TILE5.D.getCenter(m.getDimensions()),new TILE5.Vector(l.x,l.y),TILE5.Animation.Easing.Sine.Out)},onScale:function(n,l){var p=0;n=Math.sqrt(n);if(n<1)p=-(0.5/n);else if(n>1)p=n;m.gotoPosition(m.getXYPosition(l),g+Math.floor(p))}})),m=GRUNT.extend({},o,{pois:a.pois,annotations:null,getBoundingBox:function(){var n=m.getTileLayer(),
l=m.getOffset(),p=m.getDimensions();if(n)return n.getBoundingBox(l.x,l.y,p.width,p.height);return null},getCenterPosition:function(){return m.getXYPosition(TILE5.D.getCenter(m.gridDimensions))},getXYPosition:function(n){return m.getTileLayer().pixelsToPos(m.viewPixToGridPix(n))},gotoBounds:function(n,l){var p=TILE5.Geo.B.getZoomLevel(n,m.getDimensions());m.gotoPosition(TILE5.Geo.B.getCenter(n),p,l)},gotoCurrentPosition:function(n){TILE5.Geo.Location.get({successCallback:function(l){m.clearBackground();
m.gotoPosition(l,15,n)},errorCallback:function(){}})},gotoPosition:function(n,l,p){var q=g,t=(new Date).getTime(),w=false,v=m.getBoundingBox();if(v){v=TILE5.Geo.B.getCenter(v);v=TILE5.Geo.P.calcDistance(v,n);GRUNT.Log.info("distance between current position and new position = "+v);if(v>100){w=true;m.clearBackground()}}g=l?l:g;if(!g)throw"Zoom level required to goto a position.";if(a.provider)g=a.provider.checkZoomLevel(g);if(w||!e||g!==q){TILE5.Resources.resetImageLoadQueue();(l=m.getTileLayer())&&
l.deactivate();TILE5.Animation.cancel();e&&m.freeze();h=t;a.provider.zoomLevel=g;a.provider.getMapTiles(m,n,function(y){if(t===h){m.setTileLayer(y);d=y.getId();m.panToPosition(n,function(){m.unfreeze();p&&p()})}else GRUNT.Log.info("request time mismatch - ignoring update")});e=true}else m.panToPosition(n,p)},panToPosition:function(n,l,p){var q=m.getTileLayer();if(q){n=q.getGridXYForPosition(n);q=m.getDimensions();n.x-=q.width/2;n.y-=q.height/2;if(b)b=null;m.updateOffset(n.x,n.y,p);GRUNT.WaterCooler.say("view.wake",
{id:m.id});a.boundsChange&&a.boundsChange(m.getBoundingBox());l&&l(m)}},setZoomLevel:function(n){m.gotoPosition(m.getCenterPosition(),n)},zoomIn:function(){m.scale(2,TILE5.Animation.Easing.Sine.Out)||m.setZoomLevel(g+1)},zoomOut:function(){m.scale(0.5,TILE5.Animation.Easing.Sine.Out)||m.setZoomLevel(g-1)},animateRoute:function(n,l,p,q){var t=m.getLayer("route");if(t)(n=t.getAnimation(n,l,p,q))&&n.addToView(m)}},o);o=new TILE5.Geo.UI.AnnotationsOverlay({pois:m.pois,map:m,createAnnotationForPOI:a.createAnnotationForPOI});
m.annotations=o;m.setLayer("annotations",o);a.crosshair&&m.setLayer("crosshair",new s);c&&m.setLayer("copyright",new TILE5.Graphics.ViewLayer({zindex:999,draw:function(n,l,p){n.lineWidth=2.5;n.fillStyle="rgb(50, 50, 50)";n.strokeStyle="rgba(255, 255, 255, 0.8)";n.font="bold 10px sans";n.textBaseline="bottom";n.strokeText(c,10,p.height-10);n.fillText(c,10,p.height-10)}}));GRUNT.WaterCooler.listen("view.idle",function(n){if(n.id&&n.id==m.id)if(TILE5.V.absSize(TILE5.V.diff(i,m.getOffset()))>a.boundsChangeThreshold&&
a.boundsChange){i=m.getOffset();a.boundsChange(m.getBoundingBox())}});GRUNT.WaterCooler.listen("tiles.drawn",function(n){n.id&&n.id==d&&a.onTilesLoaded&&a.onTilesLoaded()});return m}};return k}();
