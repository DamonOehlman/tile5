if(!this.JSON)this.JSON={};
(function(){function p(q){return q<10?"0"+q:q}function f(q){d.lastIndex=0;return d.test(q)?'"'+q.replace(d,function(g){var o=h[g];return typeof o==="string"?o:"\\u"+("0000"+g.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+q+'"'}function a(q,g){var o,l,n,s,t=e,m,u=g[q];if(u&&typeof u==="object"&&typeof u.toJSON==="function")u=u.toJSON(q);if(typeof r==="function")u=r.call(g,q,u);switch(typeof u){case "string":return f(u);case "number":return isFinite(u)?String(u):"null";case "boolean":case "null":return String(u);
case "object":if(!u)return"null";e+=k;m=[];if(Object.prototype.toString.apply(u)==="[object Array]"){s=u.length;for(o=0;o<s;o+=1)m[o]=a(o,u)||"null";n=m.length===0?"[]":e?"[\n"+e+m.join(",\n"+e)+"\n"+t+"]":"["+m.join(",")+"]";e=t;return n}if(r&&typeof r==="object"){s=r.length;for(o=0;o<s;o+=1){l=r[o];if(typeof l==="string")if(n=a(l,u))m.push(f(l)+(e?": ":":")+n)}}else for(l in u)if(Object.hasOwnProperty.call(u,l))if(n=a(l,u))m.push(f(l)+(e?": ":":")+n);n=m.length===0?"{}":e?"{\n"+e+m.join(",\n"+e)+
"\n"+t+"}":"{"+m.join(",")+"}";e=t;return n}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+p(this.getUTCMonth()+1)+"-"+p(this.getUTCDate())+"T"+p(this.getUTCHours())+":"+p(this.getUTCMinutes())+":"+p(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var b=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e,k,h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},r;if(typeof JSON.stringify!=="function")JSON.stringify=function(q,g,o){var l;k=e="";if(typeof o==="number")for(l=0;l<o;l+=1)k+=" ";else if(typeof o==="string")k=o;if((r=g)&&typeof g!=="function"&&(typeof g!=="object"||typeof g.length!=="number"))throw Error("JSON.stringify");return a("",
{"":q})};if(typeof JSON.parse!=="function")JSON.parse=function(q,g){function o(n,s){var t,m,u=n[s];if(u&&typeof u==="object")for(t in u)if(Object.hasOwnProperty.call(u,t)){m=o(u,t);if(m!==undefined)u[t]=m;else delete u[t]}return g.call(n,s,u)}var l;q=String(q);b.lastIndex=0;if(b.test(q))q=q.replace(b,function(n){return"\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(q.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){l=eval("("+q+")");return typeof g==="function"?o({"":l},""):l}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(p){if(arguments.length<=1)return p;for(var f=arguments.length-2,a=0;a<=f;a++)p=p.replace(RegExp("\\{"+a+"\\}","gi"),arguments[a+1]);return p};
String.prototype.containsWord=function(p){var f="";if(p.toString)p=p.toString();for(var a=0;a<p.length;a++)f+=!/\w/.test(p[a])?"\\"+p[a]:p[a];return RegExp("(^|\\s|\\,)"+f+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var p=Object.prototype.hasOwnProperty,f=0,a={id:"GRUNT.core",extend:function(){var b=arguments[0]||{},d=1,e=arguments.length,k=false,h,r,q,g;if(typeof b==="boolean"){k=b;b=arguments[1]||{};d=2}if(typeof b!=="object"&&!a.isFunction(b))b={};if(e===d){b=this;--d}for(;d<e;d++)if((h=arguments[d])!=null)for(r in h){q=b[r];g=h[r];if(b!==g)if(k&&g&&(a.isPlainObject(g)||a.isArray(g))){q=q&&(a.isPlainObject(q)||a.isArray(q))?q:a.isArray(g)?[]:{};b[r]=a.extend(k,q,g)}else if(g!==undefined)b[r]=
g}return b},isFunction:function(b){return toString.call(b)==="[object Function]"},isArray:function(b){return toString.call(b)==="[object Array]"},isPlainObject:function(b){if(!b||toString.call(b)!=="[object Object]"||b.nodeType||b.setInterval)return false;if(b.constructor&&!p.call(b,"constructor")&&!p.call(b.constructor.prototype,"isPrototypeOf"))return false;var d;for(d in b);return d===undefined||p.call(b,d)},isEmptyObject:function(b){for(var d in b)return false;return true},isXmlDocument:function(b){return toString.call(b)===
"[object Document]"},contains:function(b,d){var e=b,k=arguments,h=1;if(d&&a.isArray(d)){k=d;h=0}for(h=h;h<k;h++)e=e&&typeof foo[k[h]]!=="undefined";return e},newModule:function(b){b=a.extend({id:null,requires:[],parent:null},b);if(b.parent)b=a.extend({},b.parent,b);return b},toID:function(b){return b.replace(/\s/g,"-")},generateObjectID:function(b){return(b?b:"obj")+f++}};return a}();
GRUNT.Log=function(){function p(e,k){var h,r=k&&k.length>0?k[0]:"";for(h=1;k&&h<k.length;h++)r+=" "+(a&&GRUNT.isPlainObject(k[h])?JSON.stringify(k[h]):k[h]);typeof console!=="undefined"&&console[e](r);for(h=0;h<f.length;h++)f[h].call(d,r,e)}var f=[],a=typeof JSON!=="undefined",b=window.console&&window.console.markTimeline,d={id:"GRUNT.log",getTraceTicks:function(){return b?(new Date).getTime():null},trace:function(e,k){if(b)console.markTimeline(e+(k?": "+(d.getTraceTicks()-k)+"ms":""))},debug:function(){p("debug",
arguments)},info:function(){p("info",arguments)},warn:function(){p("warn",arguments)},error:function(){p("error",arguments)},exception:function(e){d.error(arguments);for(var k in e)d.info("ERROR DETAIL: "+k+": "+e[k])},watch:function(e,k){try{k()}catch(h){d.exception(h,e)}},throwError:function(e){d.error(e);throw Error(e);},requestUpdates:function(e){f.push(e)}};return d}();
GRUNT.Data=function(){var p={determineObjectMapping:function(a){if(!a)return null;a=a.split("|");for(var b={},d=0;d<a.length;d++)b[a[d]]=d;return b},mapLineToObject:function(a,b){var d=a.split("|"),e={};for(var k in b){var h=b[k];e[k]=d.length>h?d[h]:null}return e},parse:function(a){var b=null,d=[];a=a.split("\n");for(var e=0;e<a.length;e++){var k=a[e];if(b)d.push(p.mapLineToObject(k,b));else b=p.determineObjectMapping(k)}return d}},f={supportedFormats:{JSON:{parse:function(a){return JSON.parse(a)}},
PDON:{parse:function(a){return p.parse(a)}}},parse:function(a){a=GRUNT.extend({data:"",format:"JSON"},a);if(!f.supportedFormats[a.format])throw Error("Unsupported data format: "+a.format+", cannot parse data in javascript object");try{return f.supportedFormats[a.format].parse(a.data)}catch(b){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+a.format,a.data);GRUNT.Log.exception(b)}return{}}};return f}();
GRUNT.Template=function(){var p=/\$\{(.*?)\}/ig;return{parse:function(f,a){for(var b=f,d=p.exec(b);d;){b=b.replace(d[0],GRUNT.XPath.first(d[1],a));p.lastIndex=0;d=p.exec(b)}return b}}}();
GRUNT.JSONP=function(){function p(d){var e=document.createElement("script"),k=false;e.src=d;e.async=true;e.onload=e.onreadystatechange=function(){if(!k&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){k=true;e.onload=e.onreadystatechange=null;e&&e.parentNode&&e.parentNode.removeChild(e)}};a||(a=document.getElementsByTagName("head")[0]);a.appendChild(e)}var f=0,a,b=this;return{get:function(d,e,k){d+=d.indexOf("?")>=0?"&":"?";var h="json"+ ++f;b[h]=function(r){e(r);b[h]=
null;try{delete b[h]}catch(q){}};p(d+(k?k:"callback")+"="+h);return h}}}();
GRUNT.XHR=function(){var p={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},f={JSON:["json"],PDON:["pdon.txt"]},a=["TEXT","STREAM"],b=/^(\w+:)?\/\/([^\/?#]+)/,d={XML:function(h){return h.responseXML},JSON:function(h){try{return JSON.parse(h.responseText)}catch(r){GRUNT.Log.error("Error parsing JSON data: ",h.responseText);GRUNT.Log.exception(r)}return""},PDON:function(h){return GRUNT.Data.parse({data:h.responseText,format:"PDON"})},DEFAULT:function(h){return h.responseText}},
e={CONTENT_TYPE:"Content-Type"},k=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(h){try{h=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},k.ajaxSettings,h);var r=b.exec(h.url),q=r&&(r[1]&&r[1]!==location.protocol||r[2]!==location.host);if(h.data)h.method="POST";if(h.url){r=null;if(h.xhr)r=h.xhr(h);r||(r=new XMLHttpRequest);r.open(h.method,h.url,h.async);h.data&&r.setRequestHeader("Content-Type",
h.contentType);q||r.setRequestHeader("X-Requested-With","XMLHttpRequest");r.onreadystatechange=function(){if(this.readyState===4){var o=null,l=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(l)if(h.handleResponse)h.handleResponse(this);else{var n=h,s=this.getResponseHeader(e.CONTENT_TYPE),t,m=false;for(t in p)if(s&&s.indexOf(p[t])>=0){m=true;break}s=!m;for(m=0;m<a.length;m++)s=s||a[m]==t;if(s)b:{s=t;for(var u in f)for(m=
0;m<f[u].length;m++)if(RegExp(f[u][m]+"$","i").test(n.url)){t=u;break b}t=s?s:"DEFAULT"}try{o=d[t](this,n)}catch(v){GRUNT.Log.warn("error applying processor '"+t+"' to response type, falling back to default");o=d.DEFAULT(this,n)}}else h.error&&h.error(this)}catch(w){GRUNT.Log.exception(w,"PROCESSING AJAX RESPONSE")}l&&o&&h.success&&h.success.call(this,o)}};r.send(h.method=="POST"?k.param(h.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(g){GRUNT.Log.exception(g)}},
param:function(h){var r=[],q=function(o,l){l=GRUNT.isFunction(l)?l():l;r[r.length]=encodeURIComponent(o)+"="+encodeURIComponent(l)};if(GRUNT.isArray(h))for(var g=0;g<h.length;g++)q(h[g].name,h[g].value);else for(g in h)q(g,h[g]);return r.join("&").replace(/%20/g,"+")}});return k}();
GRUNT.XPath=function(){function p(d){for(var e=null,k=0;k<f.length;k++)if(e=f[k](d))break;return e}var f=[],a=[null,function(d){return d.numberValue},function(d){return d.stringValue},function(d){return d.booleanValue},null,null,null,null,function(d){return d.singleNodeValue?d.singleNodeValue.textContent:null},function(d){return d.singleNodeValue?d.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var b={SearchResult:function(d){return{toString:function(){var e=
null;if(d){var k=null;if(d.resultType>=0&&d.resultType<a.length)k=a[d.resultType];if(k){GRUNT.Log.info("invoking match handler for result type: "+d.resultType);e=k(d)}}return e?e:""}}},first:function(d,e){var k=b.SearchResult,h;var r=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!r)r=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(e))h=e.evaluate(d,e,p,r,null);else{GRUNT.Log.warn("attempted xpath expression: "+d+" on a non-xml document");h=null}}catch(q){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
d+" on node: "+e);h=null}return new k(h)},registerResolver:function(d){f.push(d)}};return b}();GRUNT.Observable=function(){var p={},f=0,a={bind:function(b,d){p[b]||(p[b]=[]);f+=1;p[b].push({callback:d,callbackId:f});return f},trigger:function(b){var d=p[b];if(d)for(var e=d.length;e--;)d[e].callback.apply(a,Array.prototype.slice.call(arguments,1))},unbind:function(b,d){for(var e=p[b],k=0;e&&k<e.length;k++)if(e[k].callbackId===d){e.splice(k,1);break}}};return a};
GRUNT.WaterCooler=function(){var p={},f=[];return{addPipe:function(a){a("pipe.test",{});f.push(a)},listen:function(a,b){p[a]||(p[a]=[]);b&&p[a].push(b)},say:function(a,b){var d;for(d=f.length;d--;)f[d](a,b);if(p[a])for(d=p[a].length;d--;)p[a][d](b)},leave:function(){}}}();
T5=function(){var p={newCanvas:function(f,a){var b=document.createElement("canvas");typeof G_vmlCanvasManager!=="undefined"&&G_vmlCanvasManager.initElement(b);b.width=f?f:0;b.height=a?a:0;return b},time:function(){return(new Date).getTime()},Settings:function(){var f={};return{get:function(a){return f[a]},set:function(a,b){f[a]=b},extend:function(a){GRUNT.extend(f,a)}}}(),Vector:function(f,a){return{x:f?f:0,y:a?a:0}},V:function(){function f(a){if(!a||a.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");
for(var b={edges:Array(a.length-1),accrued:Array(a.length-1),total:0},d=T5.V.diff,e=0;e<a.length-1;e++){var k=d(a[e],a[e+1]);b.edges[e]=Math.sqrt(k.x*k.x+k.y*k.y);b.accrued[e]=b.total+b.edges[e];b.total+=b.edges[e]}return b}return{create:function(a,b){return new p.Vector(a,b)},add:function(){for(var a=new p.Vector,b=arguments.length;b--;){a.x+=arguments[b].x;a.y+=arguments[b].y}return a},absSize:function(a){return Math.max(Math.abs(a.x),Math.abs(a.y))},diff:function(a,b){return new p.Vector(a.x-b.x,
a.y-b.y)},copy:function(a){return a?new p.Vector(a.x,a.y):null},invert:function(a){return new T5.Vector(-a.x,-a.y)},offset:function(a,b,d){return new T5.Vector(a.x+b,a.y+(d?d:b))},edges:f,distance:function(a){return f(a).total},theta:function(a,b,d){d=Math.asin((a.y-b.y)/d);return a.x>b.x?d:Math.PI-d},pointOnEdge:function(a,b,d,e){b=new T5.Vector(Math.cos(d)*e,Math.sin(d)*e);return new T5.Vector(a.x-b.x,a.y-b.y)},getRect:function(a){var b=a.length;if(b>1)return new T5.Rect(Math.min(a[0].x,a[b-1].x),
Math.min(a[0].y,a[b-1].y),Math.abs(a[0].x-a[b-1].x),Math.abs(a[0].y-a[b-1].y))},toString:function(a){return a.x+", "+a.y}}}(),Dimensions:function(f,a){return{width:f?f:0,height:a?a:0}},D:function(){return{getAspectRatio:function(f){return f.height!==0?f.width/f.height:1},getCenter:function(f){return new p.Vector(f.width/2,f.height/2)},getSize:function(f){return Math.sqrt(Math.pow(f.width,2)+Math.pow(f.height,2))}}}(),Rect:function(f,a,b,d){return{origin:new p.Vector(f,a),dimensions:new p.Dimensions(b,
d)}},R:function(){return{copy:function(f){return f?new p.Rect(f.origin.x,f.origin.y,f.dimensions.width,f.dimensions.height):null},getCenter:function(f){return new T5.Vector(f.origin.x+f.dimensions.width/2,f.origin.y+f.dimensions.height/2)}}}()};return p}();
T5.Device=function(){function p(){for(;g.length>0;){var l=g.shift();document.location=l}q=0}function f(l){for(var n=true,s=o.length;s--;)n=n&&l!=o[s];return n}function a(l,n){var s=[];for(var t in n)t&&s.push(t+"="+escape(n[t]));return"tile5://"+l+"/"+(s.length>0?"?"+s.join("&"):"")}function b(l,n){f(l)&&GRUNT.Log.info("would push url: "+a(l,n))}function d(l,n){if(f(l)){g.push(a(l,n));q||(q=setTimeout(p,100))}}function e(){k={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:null,requireFastDraw:false,bridgeNotify:b,targetFps:null},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:false,bridgeNotify:d,targetFps:25},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:d},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:d},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,
supportsTouch:true,getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:d},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:d}};h=[k.froyo,k.android,k.ipod,k.iphone,k.ipad]}var k=null,h=[],r=null,q=0,g=[],o=["view.wake","tile.loaded"];return{getConfig:function(){k||e();if(!r){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var l=0;l<h.length;l++){var n=h[l];if(n.regex&&n.regex.test(navigator.userAgent)){r=
GRUNT.extend({},k.base,n);GRUNT.Log.info("PLATFORM DETECTED AS: "+r.name);break}}if(!r){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");r=k.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return r}}}();
T5.Resources=function(){var p="",f={},a=function(){function d(){var v=q[this.id];if(v&&v.image.complete&&v.image.width>0){v.loaded=true;v.hitCount=1;for(var w=l.length;w--;)if(l[w].image.src==this.src){l.splice(w,1);break}v.loadCallback&&v.loadCallback(this,false);n.push({url:this.src,created:v.requested});delete q[this.id];e()}}function e(){for(var v=T5.Device.getConfig().maxImageLoads;o.length>0&&(!v||l.length<v);){var w=o.shift();if(w.imageLoader){l.push(w);w.imageLoader(w,d)}}}function k(v){for(var w=
null,x=s.length;x--&&!w;)w=s[x](v);return w?w:function(A,C){A.image.onload=C;A.image.src=b.getPath(A.url);A.requested=T5.time()}}function h(){m=true;try{var v=Math.floor(n.length/2);if(v>0){n.sort(function(x,A){return x.created-A.created});for(var w=v;w--;)delete r[n[w].url];n.splice(0,v)}}finally{m=false}GRUNT.WaterCooler.say("imagecache.cleared")}var r={},q={},g=0,o=[],l=[],n=[],s=[],t=0,m=false,u={loadingImages:l,queuedImages:o,addInterceptor:function(v){s.push(v)},getCacheFullness:function(){return t},
getImage:function(v){var w=null;m||(w=r[v]);return w?w.image:null},loadImage:function(v,w){var x=r[v];if(x){x.hitCount++;x.image.complete&&w&&w(x.image,true)}else{x={url:v,image:new Image,loaded:false,imageLoader:k(v),created:T5.time(),requested:null,hitCount:0,loadCallback:w};x.image.id="resourceLoaderImage"+g++;r[v]=x;q[x.image.id]=x;o.push(x);e()}return x},resetLoadingQueue:function(){l=[]}};setInterval(function(){for(var v=T5.time(),w=false,x=0,A=T5.Device.getConfig();x<l.length;)if(v-l[x].requested>
b.loadTimeout*1E3){l.splice(x,1);w=true}else x++;w&&e();if(A&&A.imageCacheMaxSize){t=n.length*b.avgImageSize/A.imageCacheMaxSize;t>=1&&h()}},1E3);return u}(),b={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(d,e){for(var k=(d?d.replace(/^.*\?/,""):"").split("&"),h=d?d.replace(/\?.*$/,"?"):"",r=0;r<k.length;r++){var q=k[r].split("=");if(!e||!e.test(q[0]))h+=k[r]+"&"}return h.replace(/\W/g,"")},isValidCacheKey:function(d){GRUNT.Log.info("cache key = "+
d);return false}}}(),addInterceptor:a.addInterceptor,getPath:function(d){return/^(file|https?|\/)/.test(d)?d:p+d},setBasePath:function(d){p=d},getImage:function(d){return a.getImage(d)},loadImage:function(d,e){a.loadImage(d,e)},resetImageLoadQueue:function(){a.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:a.loadingImages.length,queuedImageCount:a.queuedImages.length,imageCacheFullness:a.getCacheFullness()}},loadResource:function(d){d=GRUNT.extend({filename:"",cacheable:true,dataType:null,
callback:null},d);var e=function(k){d.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){d.callback(k)})};d.cacheable&&f[d.filename]?e(f[d.filename]):GRUNT.XHR.ajax({url:b.getPath(d.filename),dataType:d.dataType,success:function(k){if(d.cacheable)f[d.filename]=k;e(k)},error:function(k,h,r){GRUNT.Log.error("error loading resource ["+d.filename+"], error = "+r)}})},loadSnippet:function(d,e){/\.\w+$/.test(d)||(d+=".html");b.loadResource({filename:"snippets/"+d,callback:e,dataType:"html"})}};
return b}();
T5.Touch=function(){function p(n,s){var t=n&&n.length>0?n[0]:null;if(t&&s&&s.length>0)return T5.V.diff(t,s[0]);return null}function f(n){n.preventDefault();n.stopPropagation()}function a(n){for(var s=Array(n.length),t=n.length;t--;)s[t]=new T5.Vector(n[t].pageX,n[t].pageY);return s}function b(n){return[new T5.Vector(n.pageX,n.pageY)]}var d=120,e=100,k=250,h={TAP:0,MOVE:1,PINCHZOOM:2},r=7,q=0,g=0,o={TouchHelper:function(n){function s(z,D,G,J){var S=Math.asin((z.y-D.y)/G);G=Math.min(Math.floor(G*(W.duration/
J)),W.max);S=D.x>z.x?S:Math.PI-S;z=new T5.Vector(Math.cos(S)*-G,Math.sin(S)*G);u("inertiaPan",z.x,z.y)}function t(z,D){var G,J;if(F){G=D-X;if(G<k){J=T5.V.distance([M[0],z]);J>n.inertiaTrigger&&s(M[0],z,J,G)}}else{Z=z;var S=setInterval(function(){G=T5.time()-D;J=T5.V.distance([z,Z]);if(G<e&&J>n.inertiaTrigger){clearInterval(S);s(z,Z,J,G)}else G>e&&clearInterval(S)},5)}}function m(z){for(var D=[],G=n.element?-n.element.offsetLeft:0,J=n.element?-n.element.offsetTop:0,S=z.length;S--;)D.push(T5.V.offset(z[S],
G,J));return D}function u(){n.observable&&n.observable.trigger.apply(null,arguments)}function v(z){if(z.target&&z.target===n.element){M=F?a(z.touches):b(z);O=new T5.Vector;V=new T5.Vector;Y=true;C=false;X=T5.time();F&&f(z);u("inertiaCancel");U.current=X;if(z=M.length>0?M[0]:null){u("touchStart",z.x,z.y);if(U.current-U.last<L.THRESHOLD_DOUBLETAP)if((z=P?T5.V.diff(M[0],P[0]):null)&&Math.abs(z.x)<n.maxDistDoubleTap&&Math.abs(z.y)<n.maxDistDoubleTap)C=true;T=h.TAP;P=[].concat(M)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}
function w(z){if(z.target&&z.target===n.element){Z=(F?a(z.touches):b(z))[0];if(Y)try{F&&f(z);var D=F?a(z.touches):b(z);z=0;if(D.length>1){if(M.length===1)M=[].concat(D);z=T5.V.distance(M)-T5.V.distance(D)}if(T===h.TAP){var G=p(D,M);if(G&&(Math.abs(G.x)>=r||Math.abs(G.y)>=r))T=h.MOVE}if(T!==h.TAP)if(!z||Math.abs(z)<n.pinchZoomThreshold){if(O=p(D,P)){V.x-=O.x;V.y-=O.y;N.x-=O.x;N.y-=O.y}if(T5.V.absSize(N)>n.panEventThreshhold){u("pan",N.x,N.y);N=T5.V.create()}T=h.MOVE}else{u("pinchZoom",m(M),m(D));T=
h.PINCHZOOM}P=[].concat(D)}catch(J){GRUNT.Log.exception(J)}}}function x(z){if(z.target&&z.target===n.element){var D=(F?a(z.changedTouches):b(z))[0];try{F&&f(z);var G=T5.time();U.last=U.current;if(T===h.TAP)K||(K=setTimeout(function(){K=0;var S=C?"doubleTap":"tap",H=M[0],y=null;if(n.element)y=T5.V.offset(H,-n.element.offsetLeft,-n.element.offsetTop);u(S,H,y)},L.THRESHOLD_DOUBLETAP+50));else if(T==h.MOVE){u("panEnd",V.x,V.y);W&&t(D,G)}else T==h.PINCHZOOM&&u("pinchZoomEnd",m(M),m(P),G-X)}catch(J){GRUNT.Log.exception(J)}}Y=
false}function A(z){if(z.target&&z.target===n.element){var D;if(z.detail){D=-z.detail*d;D=new T5.Vector(z.axis===1?D:0,z.axis===2?D:0)}else D=new T5.Vector(z.wheelDeltaX,z.wheelDeltaY);var G=D.y!==0?Math.abs(D.y/d):0;if(Z&&G!==0){var J=T5.V.offset(Z,-n.element.offsetLeft,-n.element.offsetTop);u("wheelZoom",J,Math.pow(2,D.y>0?G:-G))}z.preventDefault()}}n=GRUNT.extend({element:null,observable:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,
moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},n);var C=false,K=0,F=T5.Device.getConfig().supportsTouch,M=null,P=null,O=null,V=null,N=new T5.Vector,T=null,Y=false,X=0,$=[],Z=null,W=null,U={current:0,last:0},Q=T5.Device.getConfig(),L={supportsTouch:F,THRESHOLD_DOUBLETAP:300,addListeners:function(z){$.push(z)},decoupleListeners:function(z){for(var D=0;z&&D<$.length;D++)if($[D].listenerId===z){$.splice(D,
1);GRUNT.Log.info("successfully decoupled touch listener: "+z);break}},release:function(){Q.eventTarget.removeEventListener(Q.supportsTouch?"touchstart":"mousedown",v,false);Q.eventTarget.removeEventListener(Q.supportsTouch?"touchmove":"mousemove",w,false);Q.eventTarget.removeEventListener(Q.supportsTouch?"touchend":"mouseup",x,false);if(!Q.supportsTouch){window.removeEventListener("mousewheel",A,false);window.removeEventListener("DOMMouseScroll",A,false)}},inertiaEnable:function(z,D){W={duration:z,
max:D?Math.min(D.width,D.height):500}},inertiaDisable:function(){W=null}};Q.eventTarget.addEventListener(Q.supportsTouch?"touchstart":"mousedown",v,false);Q.eventTarget.addEventListener(Q.supportsTouch?"touchmove":"mousemove",w,false);Q.eventTarget.addEventListener(Q.supportsTouch?"touchend":"mouseup",x,false);if(!Q.supportsTouch){window.addEventListener("mousewheel",A,false);window.addEventListener("DOMMouseScroll",A,false)}return L}},l=[];return{captureTouch:function(n,s){if(!n)throw Error("Unable to capture touch of null element");
if(!n.id)n.id="touchable_"+q++;var t=l[n.id];if(!t){t=o.TouchHelper(GRUNT.extend({element:n},s));l[n.id]=t;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+t.supportsTouch)}s.listenerId&&t.decoupleListeners(s.listenerId);s.listenerId=++g;t.addListeners(s);return t},resetTouch:function(n){if(n&&n.id&&l[n.id]){l[n.id].release();delete l[n.id]}}}}();
if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(p){return this.each(function(){T5.Touch.captureTouch(this,p)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(p){p.preventDefault()})}}
T5.Dispatcher=function(){var p=[],f={execute:function(a){var b=f.findAction(a);GRUNT.Log.info("looking for action id: "+a+", found: "+b);if(b){var d=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+a,function(){b.execute(d)})}},findAction:function(a){for(var b=p.length;b--;)if(p[b].id==a)return p[b];return null},getRegisteredActions:function(){return[].concat(p)},getRegisteredActionIds:function(){for(var a=[],b=p.length;b--;)p[b].id&&a.push(p[b].id);return a},registerAction:function(a){a&&
a.id&&p.push(a)},Action:function(a){a=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},a);var b={id:a.id,execute:function(){a.execute&&a.execute.apply(this,arguments)},getParam:function(d){return a[d]?a[d]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",b.id,a.title,a.icon)}};a.autoRegister&&f.registerAction(b);return b},createAgent:function(a){a=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},a);var b=null,d={getName:function(){return a.name},
getParam:function(e){return a[e]},getId:function(){return GRUNT.toID(d.getName())},run:function(e,k){if(a.execute){var h=b=T5.time(),r=a.translator?a.translator(e):e;a.execute.call(d,r,function(q,g){if(!a.trashOrphanedResults||h==b)k&&k(q,g,r)})}}};return d},runAgents:function(a,b,d){for(var e=0;e<a.length;e++)a[e].run(b,d)}};return f}();
T5.Easing=function(){var p=1.70158;return{Linear:function(f,a,b,d){return b*f/d+a},Back:{In:function(f,a,b,d){return b*(f/=d)*f*((p+1)*f-p)+a},Out:function(f,a,b,d){return b*((f=f/d-1)*f*((p+1)*f+p)+1)+a},InOut:function(f,a,b,d){return(f/=d/2)<1?b/2*f*f*(((p*=1.525)+1)*f-p)+a:b/2*((f-=2)*f*(((p*=1.525)+1)*f+p)+2)+a}},Bounce:{In:function(f,a,b,d){return b-module.Easing.Bounce.Out(d-f,0,b,d)+a},Out:function(f,a,b,d){return(f/=d)<1/2.75?b*7.5625*f*f+a:f<2/2.75?b*(7.5625*(f-=1.5/2.75)*f+0.75)+a:f<2.5/
2.75?b*(7.5625*(f-=2.25/2.75)*f+0.9375)+a:b*(7.5625*(f-=2.625/2.75)*f+0.984375)+a},InOut:function(f,a,b,d){return f<d/2?module.Easing.Bounce.In(f*2,0,b,d)/2+a:module.Easing.Bounce.Out(f*2-d,0,b,d)/2+b/2+a}},Cubic:{In:function(f,a,b,d){return b*(f/=d)*f*f+a},Out:function(f,a,b,d){return b*((f=f/d-1)*f*f+1)+a},InOut:function(f,a,b,d){if((f/=d/2)<1)return b/2*f*f*f+a;return b/2*((f-=2)*f*f+2)+a}},Elastic:{In:function(f,a,b,d,e,k){if(f==0)return a;if((f/=d)==1)return a+b;k||(k=d*0.3);if(!e||e<Math.abs(b)){e=
b;b=k/4}else b=k/(2*Math.PI)*Math.asin(b/e);return-(e*Math.pow(2,10*(f-=1))*Math.sin((f*d-b)*2*Math.PI/k))+a},Out:function(f,a,b,d,e,k){var h;if(f==0)return a;if((f/=d)==1)return a+b;k||(k=d*0.3);if(!e||e<Math.abs(b)){e=b;h=k/4}else h=k/(2*Math.PI)*Math.asin(b/e);return e*Math.pow(2,-10*f)*Math.sin((f*d-h)*2*Math.PI/k)+b+a},InOut:function(f,a,b,d,e,k){var h;if(f==0)return a;if((f/=d/2)==2)return a+b;k||(k=d*0.3*1.5);if(!e||e<Math.abs(b)){e=b;h=k/4}else h=k/(2*Math.PI)*Math.asin(b/e);if(f<1)return-0.5*
e*Math.pow(2,10*(f-=1))*Math.sin((f*d-h)*2*Math.PI/k)+a;return e*Math.pow(2,-10*(f-=1))*Math.sin((f*d-h)*2*Math.PI/k)*0.5+b+a}},Quad:{In:function(f,a,b,d){return b*(f/=d)*f+a},Out:function(f,a,b,d){return-b*(f/=d)*(f-2)+a},InOut:function(f,a,b,d){if((f/=d/2)<1)return b/2*f*f+a;return-b/2*(--f*(f-2)-1)+a}},Sine:{In:function(f,a,b,d){return-b*Math.cos(f/d*(Math.PI/2))+b+a},Out:function(f,a,b,d){return b*Math.sin(f/d*(Math.PI/2))+a},InOut:function(f,a,b,d){return-b/2*(Math.cos(Math.PI*f/d)-1)+a}}}}();
T5.Animation=function(){function p(){if(b===0)b=setInterval(function(){var e;e=T5.time();if(!a){a=true;try{for(var k=0;k<f.length;)if(f[k].isComplete()){f[k].triggerComplete(false);f.splice(k,1)}else{f[k].update(e);k++}}finally{a=false}}e=f.length;if(e===0){clearInterval(b);b=0}},20)}var f=[],a=false,b=0,d={DURATION:2E3,tweenValue:function(e,k,h,r,q){e=new d.Tween({startValue:e,endValue:k,tweenFn:h,complete:r,duration:q});f.push(e);return e},tween:function(e,k,h,r,q,g){e=new d.Tween({target:e,property:k,
endValue:h,tweenFn:r,duration:g,complete:q});f.push(e);return e},tweenVector:function(e,k,h,r,q,g){var o=[];if(e){var l=e.x==k,n=e.y==h;l||o.push(d.tween(e,"x",k,r,function(){(l=true)&&n&&q()},g));n||o.push(d.tween(e,"y",h,r,function(){n=true;l&&n&&q()},g))}return o},cancel:function(e){if(!a){a=true;try{for(var k=0;k<f.length;)if(!e||e(f[k])){f[k].triggerComplete(true);f.splice(k,1)}else k++}finally{a=false}}},isTweening:function(){return f.length>0},Tween:function(e){e=GRUNT.extend({target:null,
property:null,startValue:0,endValue:null,duration:d.DURATION,tweenFn:d.DEFAULT,complete:null,cancelOnInteract:false},e);var k=T5.time(),h=[],r=false,q=0,g=0,o={cancelOnInteract:e.cancelOnInteract,isComplete:function(){return r},triggerComplete:function(l){e.complete&&e.complete(l)},update:function(l){try{var n=e.tweenFn(l-k,q,g,e.duration);if(e.target)e.target[e.property]=n;for(var s=h.length;s--;)h[s](n,void 0);if(r=k+e.duration<=l){if(e.target)e.target[e.property]=e.tweenFn(e.duration,q,g,e.duration);
for(var t=h.length;t--;)h[t](n,true)}}catch(m){GRUNT.Log.exception(m)}},requestUpdates:function(l){h.push(l)}};q=e.target&&e.property&&e.target[e.property]?e.target[e.property]:e.startValue;if(typeof e.endValue!=="undefined")g=e.endValue-q;if(g==0)r=true;p();return o}};return GRUNT.extend(d,{DEFAULT:T5.Easing.Back.Out})}();
T5.ViewState=function(){var p={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128,get:function(){for(var f=0,a=arguments.length;a--;){var b=p[arguments[a]];if(b)f|=b}return f}};return p}();
T5.ViewLayer=function(p){p=GRUNT.extend({id:"",centerOnScale:true,created:T5.time(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:T5.ViewState.get("ACTIVE","ANIMATING","PAN","PINCHZOOM")},p);var f=null,a=p.id,b=T5.ViewState.get("ACTIVE"),d=GRUNT.extend({addToView:function(e){e.setLayer(a,d)},shouldDraw:function(e){var k=f?f.fastDraw&&e!==b:false;return(e&p.validStates)!==0&&(k?p.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",
{id:a})},wakeParent:function(){f&&f.trigger("wake")},getId:function(){return a},setId:function(e){a=e},getParent:function(){return f},setParent:function(e){f=e}},p);return d};
T5.View=function(p){function f(y,B,E,I){P=typeof E!=="undefined";H.updateOffset(t.x+y,t.y+B,E,I);o();J=T5.ViewState.PAN}function a(){J=T5.ViewState.ACTIVE;P=false;setTimeout(o,50)}function b(y,B){U=T5.V.getRect(y);Q=T5.V.getRect(B);var E=T5.D.getSize(U.dimensions),I=T5.D.getSize(Q.dimensions);G=T5.R.getCenter(U);F=T5.R.getCenter(Q);L=U&&E!==0?I/E:1}function d(){GRUNT.WaterCooler.say("view.scale",{id:H.id});W=false;H.trigger("scale",L,U?h():F);J=T5.ViewState.ACTIVE;o()}function e(y,B){B.setId(y);B.setParent(H);
l.push(B);l.sort(function(E,I){var R=I.zindex-E.zindex;if(R===0)R=I.created-E.created;return R})}function k(y,B,E,I,R,ca,aa){function da(){ca&&ca();d();L=1;D=null}W=true;G=T5.V.copy(E);F=T5.V.copy(I);U=null;if(R)T5.Animation.tweenValue(0,B-y,R,da,aa?aa:1E3).requestUpdates(function(ba){D=ba/(B-y);L=y+ba;J=T5.ViewState.PINCHZOOM;o();H.trigger("animate")});else{L=targetScaleFactor;da()}}function h(){var y=T5.D.getCenter(x),B=T5.V.distance([F,y]),E=T5.V.theta(F,y,B),I=T5.V.diff(G,F);y=T5.V.pointOnEdge(F,
y,E,B/L);y.x+=I.x;y.y+=I.y;return y}function r(){H.trigger("idle");M=true;N=0}function q(y,B){var E=0,I=H.getDisplayState(),R=T5.time(),ca=(I&T5.ViewState.PINCHZOOM)!==0,aa=0;if(m||ca){y.clearRect(0,0,n.width,n.height);m=false}if(ca){T5.D.getCenter(x);var da=(D?D:1)/2,ba=T5.V.diff(G,F);if(Y=U?new T5.Vector(F.x+ba.x,F.y+ba.y):new T5.Vector(F.x-ba.x*da,F.y-ba.y*da))B=T5.V.offset(B,Y.x,Y.y)}y.save();try{z=L;if(w!==1)y.scale(w,w);else if(ca){y.translate(F.x,F.y);y.scale(L,L)}for(aa=l.length;aa--;)if(l[aa].shouldDraw(I)){var ea=
l[aa].draw(y,B,x,I,H);E+=ea?ea:0}}finally{y.restore()}GRUNT.Log.trace("draw complete",R);V=false;return E}function g(){var y=0,B=!P&&(J===T5.ViewState.PINCHZOOM||J===T5.ViewState.PAN);X=T5.time();t.x=Math.floor(t.x);t.y=Math.floor(t.y);K&&u&&K.delays.push(X-u);if(B){T5.Animation.cancel(function(I){return I.cancelOnInteract});M=false;if(N!==0){clearTimeout(N);N=0}}for(B=l.length;B--;){var E=l[B].cycle(X,t,J);y+=E?E:0}if(u+Z<X){y+=q(s,t);u=X}O=0;if(C+y>0)o();else if(!M&&N===0)N=setTimeout(r,500);GRUNT.Log.trace("Completed draw cycle",
X)}function o(){C++;if(!(v||O!==0)){C=0;O=setTimeout(g,0)}}p=GRUNT.extend({id:GRUNT.generateObjectID("view"),container:"",clearOnDraw:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,inertialScroll:true,panAnimationEasing:T5.Easing.Sine.Out,panAnimationDuration:750,pinchZoomAnimateTrigger:400,adjustScaleFactor:null,autoSize:false},p);var l=[],n=document.getElementById(p.container),s=null,t=new T5.Vector,m=
false,u=null,v=false,w=1,x=null,A=null,C=0,K=null,F=null,M=false,P=false,O=0,V=false,N=0,T=0,Y=null,X=0,$=T5.Device.getConfig().targetFps,Z=0,W=false,U=null,Q=null,L=1,z=1,D=null,G=null;A=null;var J=T5.ViewState.ACTIVE;if(n){T5.Touch.resetTouch(n);if(p.autoSize){n.height=window.innerHeight-n.offsetTop;n.width=window.innerWidth-n.offsetLeft}try{s=n.getContext("2d");s.globalCompositeOperation=p.initialDrawMode;s.clearRect(0,0,n.width,n.height)}catch(S){GRUNT.Log.exception(S);throw Error("Could not initialise canvas on specified view element");
}}var H=GRUNT.extend({},p,new GRUNT.Observable,{id:p.id,deviceScaling:w,fastDraw:p.fastDraw||T5.Device.getConfig().requireFastDraw,animate:function(y,B,E,I,R){k(L,y,B,E,I,R)},centerOn:function(y){H.setOffset(y.x-n.width/2,y.y-n.height/2)},getDimensions:function(){if(n)return new T5.Dimensions(n.width,n.height)},getZoomCenter:function(){return Y},getLayer:function(y){for(var B=0;B<l.length;B++)if(l[B].getId()==y)return l[B];return null},setLayer:function(y,B){for(var E=0;E<l.length;E++)if(l[E].getId()===
y){l.splice(E,1);break}B&&e(y,B);GRUNT.WaterCooler.say("layer.update",{id:y});o()},eachLayer:function(y){for(var B=0;B<l.length;B++)y(l[B])},clearBackground:function(){m=true},freeze:function(){v=true},unfreeze:function(){v=false;o()},needRepaint:function(){return V},snapshot:function(){},getDisplayState:function(){return v?T5.ViewState.FROZEN:J},scale:function(y,B,E,I,R){I||(I=T5.D.getCenter(x));R||(R=T5.D.getCenter(x));H.animate(y,I,R,B,E);return H},removeLayer:function(y){a:{for(var B=l.length;B--;)if(l[B].getId()==
y){y=B;break a}y=-1}if(y>=0&&y<l.length){GRUNT.WaterCooler.say("layer.removed",{layer:l[y]});l.splice(y,1)}},getOffset:function(){return T5.V.copy(t)},setOffset:function(y,B){t.x=y;t.y=B},updateOffset:function(y,B,E,I){function R(){a(0,0)}if(E){y=new T5.Vector(y,B);E=T5.Animation.tweenVector(t,y.x,y.y,E,R,I);for(I=E.length;I--;){E[I].cancelOnInteract=true;E[I].requestUpdates(function(){o();p.onAnimate&&p.onAnimate(t.x,t.y)})}}else H.setOffset(y,B)},zoom:function(y,B,E){P=false;L=B;W=L!==1;G=T5.D.getCenter(H.getDimensions());
F=L>1?T5.V.copy(y):T5.D.getCenter(H.getDimensions());U=null;clearTimeout(T);if(W){J=T5.ViewState.PINCHZOOM;o();if(E)T=setTimeout(function(){d();L=1},parseInt(E,10))}}});x=H.getDimensions();A=T5.D.getCenter(x);if($)Z=Math.ceil(1E3/$);GRUNT.WaterCooler.listen("layer.remove",function(y){y.id&&H.removeLayer(y.id)});w=T5.Device.getConfig().getScaling();H.bind("wake",o);H.bind("invalidate",function(){V=true});A=T5.Touch.captureTouch(n,{observable:H});H.bind("pan",f);H.bind("panEnd",a);H.bind("pinchZoom",
function(y,B){b(y,B);if(W=L!==1){J=T5.ViewState.PINCHZOOM;o()}});H.bind("pinchZoomEnd",function(y,B,E){b(y,B);if(p.adjustScaleFactor){L=p.adjustScaleFactor(L);GRUNT.Log.info("scale factor adjusted to: "+L)}if(E<p.pinchZoomAnimateTrigger){k(z,L,G,h(),T5.Easing.Sine.Out,function(){d();L=1},300);L=z}else{d();L=1}});H.bind("wheelZoom",function(y,B){H.zoom(y,Math.min(Math.pow(2,Math.round(Math.log(B))),8),500)});p.inertialScroll&&A.inertiaEnable(p.panAnimationDuration,x);H.bind("inertiaPan",function(y,
B){p.inertialScroll&&f(y,B,p.panAnimationEasing,p.panAnimationDuration)});H.bind("inertiaCancel",function(){P=false;o()});o();return H};
T5.AnimatedPathLayer=function(p){function f(h,r,q){h.fillStyle="#FFFFFF";h.strokeStyle="#222222";h.beginPath();h.arc(q.x,q.y,4,0,Math.PI*2,false);h.stroke();h.fill()}p=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:T5.Easing.Sine.InOut,validStates:T5.ViewState.get("ACTIVE","PAN","PINCHZOOM"),drawIndicator:null,duration:2E3,autoCenter:false},p);var a=T5.V.edges(p.path),b,d=null,e=0;T5.Animation.tweenValue(0,a.total,p.easing,function(){k.remove()},p.duration).requestUpdates(function(h,
r){e=h;r&&k.remove()});var k=GRUNT.extend(new T5.ViewLayer(p),{cycle:function(){for(var h=0;h<a.accrued.length&&a.accrued[h]<e;)h++;d=null;if(h<p.path.length-1){var r=e-(h>0?a.accrued[h-1]:0),q=p.path[h],g=p.path[h+1];b=T5.V.theta(q,g,a.edges[h]);d=T5.V.pointOnEdge(q,g,b,r);if(p.autoCenter)(h=k.getParent())&&h.centerOn(d)}return d?1:0},draw:function(h,r){if(d)(p.drawIndicator?p.drawIndicator:f)(h,r,new T5.Vector(d.x-r.x,d.y-r.y),b)}});return k};
T5.Tiling=function(){function p(){if(!a){a=T5.newCanvas(d.Config.TILESIZE,d.Config.TILESIZE);var e=a.getContext("2d");e.fillStyle="rgba(150, 150, 150, 0.01)";e.fillRect(0,0,a.width,a.height)}return a}function f(){function e(){var h=T5.newCanvas(32,32),r=h.getContext("2d");r.fillStyle="#BBBBBB";r.fillRect(0,0,32,32);r.fillStyle="#C3C3C3";r.fillRect(0,0,16,16);r.fillRect(16,16,16,16);return h}if(!b){b=T5.newCanvas(d.Config.TILESIZE,d.Config.TILESIZE);var k=b.getContext("2d");k.fillStyle=k.createPattern(e(),
"repeat");k.fillRect(0,0,b.width,b.height)}return b}TileStore=function(e){e=GRUNT.extend({tileSize:null,gridSize:25,center:new T5.Vector,onPopulate:null},e);if(!e.tileSize)throw Error("Cannot create TileStore with an empty tile size");var k=Array(Math.pow(e.gridSize,2)),h=T5.V.offset(e.center,-Math.ceil(e.gridSize>>1)),r=null,q=new T5.Vector,g=null,o={getGridSize:function(){return e.gridSize},getNormalizedPos:function(l,n){return T5.V.add(new T5.Vector(l,n),T5.V.invert(h),q)},getTileShift:function(){return T5.V.copy(q)},
getTile:function(l,n){return l>=0&&l<e.gridSize?k[n*e.gridSize+l]:null},setTile:function(l,n,s){k[n*e.gridSize+l]=s},populate:function(l,n){var s=GRUNT.Log.getTraceTicks(),t=0,m=e.gridSize,u=e.tileSize;new T5.Vector(m/2,m/2);if(l)for(var v=0;v<m;v++)for(var w=0;w<m;w++){if(!k[t]){var x=l(w,v,h,m);x.gridX=w*u-q.x;x.gridY=v*u-q.y;k[t]=x}t++}r=l;g=n;GRUNT.Log.trace("tile grid populated",s);e.onPopulate&&e.onPopulate()},getShiftDelta:function(l,n,s,t){var m=Math.floor(e.gridSize*0.2),u=new T5.Vector;
if(l<0||l+s>e.gridSize)u.x=l<0?-m:m;if(n<0||n+t>e.gridSize)u.y=n<0?-m:m;return u},shift:function(l,n){if(!(l.x===0&&l.y===0)){var s=GRUNT.Log.getTraceTicks(),t=Array(k.length);t.length=k.length;for(var m=0;m<e.gridSize;m++)for(var u=0;u<e.gridSize;u++)t[u*e.gridSize+m]=o.getTile(m+l.x,u+l.y);k=t;h=n?n(h,l):T5.V.add(h,l);q.x+=-l.x*e.tileSize;q.y+=-l.y*e.tileSize;GRUNT.Log.trace("tile storage shifted",s);o.populate(r,g)}},setOrigin:function(l,n){if(tileOrigin)shiftOrigin(l,n);else h=T5.V.offset(new T5.Vector(l,
n),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var l=k.length;l--;)if(k[l])k[l].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var l=k.length;l--;)if(k[l]){k[l].x=null;k[l].y=null}});return o};var a=null,b=null,d={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(e){return e=GRUNT.extend({gridX:0,gridY:0,size:256,dirty:false},e)},ImageTile:function(e){e=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},e);return new d.Tile(e)},
TileGrid:function(e){function k(x,A){if(v){var C,K=[],F=new T5.Vector(Math.floor((x.x+s.x)*q),Math.floor((x.y+s.y)*q));tilesNeeded=false;for(var M=u;M--;)for(var P=m;P--;){C=h.getTile(P+F.x,M+F.y);var O=new T5.Vector(P-v.x,M-v.y);C||(n=h.getShiftDelta(F.x,F.y,m,u));K.push({tile:C,centerness:T5.V.absSize(O)})}K.sort(function(V,N){return N.centerness-V.centerness});o||(o=Array(K.length));for(C=K.length;C--;){o[C]=K[C].tile;w.prepTile(o[C],A)}}}e=GRUNT.extend({tileSize:T5.Tiling.Config.TILESIZE,drawGrid:false,
center:new T5.Vector,shiftOrigin:null,supportFastDraw:true},e);var h=new TileStore(GRUNT.extend({tileSize:e.tileSize,onPopulate:function(){w.dirty=true;w.wakeParent()}},e)),r=Math.round(e.tileSize/2),q=e.tileSize?1/e.tileSize:0,g=true,o=null,l=false;new T5.Vector;var n=new T5.Vector,s=new T5.Vector;T5.Device.getConfig();var t=h.getGridSize()*e.tileSize,m,u,v,w=GRUNT.extend(new T5.ViewLayer(e),{gridDimensions:new T5.Dimensions(t,t),dirty:false,cycle:function(x,A,C){x=0;if(n.x+n.y!==0){h.shift(n,e.shiftOrigin);
s=h.getTileShift();n=new T5.Vector;x++}C!==T5.ViewState.PINCHZOOM&&k(A,C);return x+w.dirty?1:0},deactivate:function(){g=false},prepTile:function(){},drawTile:function(){return false},draw:function(x,A,C,K,F){if(g){var M=T5.time(),P=A.x;A=A.y;var O=true,V=F.needRepaint()||K===T5.ViewState.PANNING||K===T5.ViewState.PINCHZOOM||T5.Animation.isTweening();if(!v){m=Math.ceil(C.width*q)+1;u=Math.ceil(C.height*q)+1;v=new T5.Vector(Math.floor((m-1)/2),Math.floor((u-1)/2))}if(o){if(e.drawGrid)x.strokeStyle=
"rgba(50, 50, 50, 0.3)";x.beginPath();for(C=o.length;C--;){var N=o[C];if(N){var T=N.gridX-P,Y=N.gridY-A;O=((V?false:!N.dirty)?true:w.drawTile(x,N,T,Y,K))&&O}else O=false;e.drawGrid&&x.rect(T,Y,e.tileSize,e.tileSize)}x.stroke();GRUNT.Log.trace("drawn tiles",M);O&&!l&&F.trigger("tileDrawComplete");l=O;w.dirty=false}}},getTileVirtualXY:function(x,A,C){x=h.getNormalizedPos(x,A);x=new T5.Vector(x.x*e.tileSize,x.y*e.tileSize);if(C){x.x+=r;x.y+=r}return x},populate:function(x){h.populate(x,function(){})}});
return w},ImageTileGrid:function(e){function k(){l.getParent().trigger("invalidate");l.dirty=true;l.wakeParent()}e=GRUNT.extend({},e);var h=p(),r=f(),q=T5.ViewState.ACTIVE,g=T5.ViewState.PAN,o=T5.Device.getConfig().requireFastDraw,l=GRUNT.extend(new d.TileGrid(e),{drawTile:function(n,s,t,m,u){var v=T5.Resources.getImage(s.url),w=false;if(v&&v.complete&&v.width>0){n.drawImage(v,t,m);s.dirty=false;w=true}else u===g?n.drawImage(r,t,m):n.drawImage(h,t,m);return w},prepTile:function(n,s){if(n)n.dirty=
true;if(n&&(!o||s===q))T5.Resources.getImage(n.url)||T5.Resources.loadImage(n.url,k)}});return l},Tiler:function(e){e=GRUNT.extend({container:"",drawCenter:false,datasources:{},tileLoadThreshold:"first"},e);var k=new T5.View(GRUNT.extend({},e,{pannable:true,scalable:true,scaleDamping:true}));GRUNT.extend(k,{getTileLayer:function(){return k.getLayer("grid0")},setTileLayer:function(h){k.setLayer("grid0",h);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(h){var r=k.getOffset();
return new T5.Vector(h.x+r.x,h.y+r.y)},cleanup:function(){k.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");k.trigger("wake")}});return k}};return d}();
T5.Geo=function(){function p(q,g){var o=null;for(var l in h)if(g){if(l==g&&h[l][q]){o=h[l];break}}else if(h[l][q]){o=h[l];break}return o}function f(q,g,o,l){var n=0;q=q.toUpperCase();for(var s in l){var t=g[s];if(t){var m=o[s];t=m?m(q,t):q.containsWord(t)?1:0;n+=t*l[s]}}return n}var a=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],b=Math.PI/180,d=180/Math.PI,e=null,k={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},h={},r={Engine:function(q){if(!q.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var g=GRUNT.extend({remove:function(){delete h[g.id]}},q);return h[g.id]=g},Radius:function(q,g){return{distance:parseInt(q,10),uom:g}},Position:function(q,g){return{lat:parseFloat(q?q:0),lon:parseFloat(g?g:0)}},BoundingBox:function(q,g){return{min:r.P.parse(q),max:r.P.parse(g)}},Address:function(q){return q=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},q)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var q={dist2rad:function(g){return g/6371},lat2pix:function(g,o){var l=parseFloat(g)*2*Math.PI/360;l=Math.sin(l);var n=0.08181919084262157*l;return Math.log((1+l)/(1-l)*Math.pow((1-n)/(1+n),0.08181919084262157))/2/o},lon2pix:function(g,o){return parseFloat(g)/180*Math.PI/o},pix2lon:function(g,o){return q.normalizeLon(g*o*180/Math.PI)},pix2lat:function(g,o){for(var l=Math.pow(Math.E,
-g*o),n=q.mercatorUnproject(l),s=q.findRadPhi(n,l),t=0;t<12&&Math.abs(n-s)>1.0E-7;){n=s;s=q.findRadPhi(n,l);t++}return s*180/Math.PI},mercatorUnproject:function(g){return Math.PI/2-2*Math.atan(g)},findRadPhi:function(g,o){var l=0.08181919084262157*Math.sin(g);return Math.PI/2-2*Math.atan(o*Math.pow((1-l)/(1+l),0.040909595421310785))},normalizeLon:function(g){for(;g<-180;)g+=360;for(;g>180;)g-=360;return g}};return q}(),GeoSearchResult:function(q){q=GRUNT.extend({id:null,caption:"",resultType:"",data:null,
pos:null,matchWeight:0},q);return GRUNT.extend(q,{toString:function(){return q.caption+(q.matchWeight?" ("+q.matchWeight+")":"")}})},GeoSearchAgent:function(q){return T5.Dispatcher.createAgent(q)},GeocodingAgent:function(q){q=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(g,o){try{if(!g.reverse&&!g.freeform)address=new r.Address(g);var l=r.getEngine("geocode");if(l)l.geocode({addresses:[g.freeform?g.freeform:address],complete:function(s,t){if(o){var m=t;if(g.freeform)m=
r.rankGeocodeResponses(g.freeform,m,r.getEngine("geocode"));o(m,q)}}})}catch(n){GRUNT.Log.exception(n)}}},q);return new r.GeoSearchAgent(q)},PointOfInterest:function(q){q=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},q);if(!q.pos&&q.lat&&q.lon)q.pos=new T5.Geo.Position(q.lat,q.lon);return GRUNT.extend({toString:function(){return q.id+": '"+q.title+"'"}},q)},POIStorage:function(q){function g(m){m=m?m:"default";n[m]||(n[m]=[]);return n[m]}function o(m){var u=[];
for(var v in n)for(var w=0;w<n[v].length;w++)if(!m||m(n[v][w]))u.push(n[v][w]);return u}function l(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:t.id,pois:t.getPOIs()})}q=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},q);var n={},s=true,t={id:GRUNT.generateObjectID(),getPOIs:function(){return o()},getOldPOIs:function(m,u){return o(function(v){return v.group==m&&v.retrieved<u})},getVisible:function(){return s},setVisible:function(m){if(m!=s){s=m;q.visibilityChange&&q.visibilityChange()}},
findById:function(m){var u=o(function(v){return v.id==m});return u.length>0?u[0]:null},findByBounds:function(m){return o(function(u){return T5.Geo.P.inBounds(u.pos,m)})},addPOIs:function(m,u){if(u)n={};for(var v=0;m&&v<m.length;v++){m[v].retrieved=T5.time();var w=m[v];g(w.group).push(w)}},removeGroup:function(m){if(n[m]){delete n[m];l()}},update:function(m){var u=[],v=0,w=m.length>0?m[0].group:"",x=T5.time();for(v=0;v<m.length;v++){var A;a:{if(A=m[v])for(var C=g(A.group),K=0;K<C.length;K++)if(C[K].id==
A.id){A=C[K];break a}A=null}if(A){A.retrieved=x;A.isNew=false}else u.push(m[v])}m=t.getOldPOIs(w,x);t.addPOIs(u);for(v=0;q.onPOIAdded&&v<u.length;v++)q.onPOIAdded(u[v]);for(v=0;v<m.length;v++){q.onPOIDeleted&&q.onPOIDeleted(m[v]);w=m[v];x=g(w.group);for(A=0;A<x.length;A++)if(x[A].id==w.id){x.splice(A,1);break}}u.length+m.length>0&&l()}};return t},MapProvider:function(){var q=1,g=20;return{zoomLevel:0,checkZoomLevel:function(o){return Math.min(Math.max(o,q),g)},getCopyright:function(){},getLogoUrl:function(){},
getMapTiles:function(){},getPositionForXY:function(){return null},getZoomRange:function(){return{min:q,max:g}},setZoomRange:function(o,l){q=o;g=l}}},P:function(){var q={calcDistance:function(g,o){if(q.empty(g)||q.empty(o))return 0;var l=(o.lat-g.lat).toRad()/2,n=(o.lon-g.lon).toRad()/2;l=Math.sin(l)*Math.sin(l)+Math.cos(g.lat.toRad())*Math.cos(o.lat.toRad())*Math.sin(n)*Math.sin(n);return 6371*2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))},copy:function(g){return g?new r.Position(g.lat,g.lon):null},empty:function(g){return!g||
g.lat===0&&g.lon===0},equal:function(g,o){return g&&o&&g.lat==o.lat&&g.lon==o.lon},almostEqual:function(g,o){return g&&o&&Math.floor(g.lat*1E3)===Math.floor(o.lat*1E3)&&Math.floor(g.lon*1E3)===Math.floor(o.lon*1E3)},inArray:function(g,o){for(var l=r.P.equal,n=o.length;n--;)if(l(g,o[n]))return true;return false},inBounds:function(g,o){var l=!(r.P.empty(g)||r.P.empty(o));return l=(l=l&&g.lat>=o.min.lat&&g.lat<=o.max.lat)&&g.lon>=o.min.lon&&g.lon<=o.max.lon},parse:function(g){if(g)if(typeof g.lat!==
"undefined")return q.copy(g);else{if(g.split)for(var o=[" ",","],l=0;l<o.length;l++){var n=g.split(o[l]);if(n.length===2)return new r.Position(n[0],n[1])}}else return new r.Position;return null},parseArray:function(g){var o=g.length,l=Array(o);for(o=o;o--;)l[o]=q.parse(g[o]);GRUNT.Log.info("parsed "+l.length+" positions");return l},fromMercatorPixels:function(g,o,l){return new r.Position(T5.Geo.Utilities.pix2lat(o,l),T5.Geo.Utilities.normalizeLon(T5.Geo.Utilities.pix2lon(g,l)))},toMercatorPixels:function(g,
o){return new T5.Vector(T5.Geo.Utilities.lon2pix(g.lon,o),T5.Geo.Utilities.lat2pix(g.lat,o))},generalize:function(g,o,l){var n=g.length,s=[],t=null;l||(l=250);l/=1E3;GRUNT.Log.info("generalizing positions, must include "+o.length+" positions");for(var m=n;m--;)if(m===0)s.unshift(g[m]);else{var u=!t||r.P.inArray(g[m],o)?l:r.P.calcDistance(t,g[m]);if(g[m]&&u>=l){s.unshift(g[m]);t=g[m]}}GRUNT.Log.info("generalized "+n+" positions into "+s.length+" positions");return s},toString:function(g){return g?
g.lat+" "+g.lon:""}};return q}(),B:function(){var q=-(Math.PI/2),g=Math.PI/2,o=-Math.PI*2,l=Math.PI*2,n={calcSize:function(s,t,m){var u=new T5.Vector(0,t.lat-s.lat);if(typeof m==="undefined")m=true;u.x=m&&s.lon>t.lon?360-s.lon+t.lon:t.lon-s.lon;return u},createBoundsFromCenter:function(s,t){var m=t/6371,u=s.lat*b,v=s.lon*b,w=u-m,x=u+m;if(w>q&&x<g){u=Math.asin(Math.sin(m)/Math.cos(u));m=v-u;if(m<o)m+=2*Math.PI;v=v+u;if(v>l)v-=2*Math.PI}else{w=Math.max(w,q);x=Math.min(x,g);m=o;v=l}return new r.BoundingBox(new r.Position(w*
d,m*d),new r.Position(x*d,v*d))},expand:function(s,t){return new r.BoundingBox(new r.Position(s.min.lat-t,s.min.lon-r.Utilities.normalizeLon(t)),new r.Position(s.max.lat+t,s.max.lon+r.Utilities.normalizeLon(t)))},forPositions:function(s,t){var m=null,u=T5.time();t||(t="auto");for(var v=s.length;v--;)if(m){var w=n.calcSize(m.min,s[v],false),x=n.calcSize(s[v],m.max,false);if(w.x<0)m.min.lon=s[v].lon;if(w.y<0)m.min.lat=s[v].lat;if(x.x<0)m.max.lon=s[v].lon;if(x.y<0)m.max.lat=s[v].lat}else m=new T5.Geo.BoundingBox(s[v],
s[v]);if(t){if(t=="auto"){v=n.calcSize(m.min,m.max);t=Math.max(v.x,v.y)*0.3}m=n.expand(m,t)}GRUNT.Log.trace("calculated bounds for "+s.length+" positions",u);return m},getCenter:function(s){var t=r.B.calcSize(s.min,s.max);return new T5.Geo.Position(s.min.lat+t.y/2,s.min.lon+t.x/2)},getGeoHash:function(s){var t=T5.Geo.GeoHash.encode(s.min.lat,s.min.lon);s=T5.Geo.GeoHash.encode(s.max.lat,s.max.lon);GRUNT.Log.info("min hash = "+t+", max hash = "+s)},getZoomLevel:function(s,t){var m=n.getCenter(s),u=
a[Math.min(Math.round(Math.abs(m.lat)*0.05),a.length)],v=n.calcSize(s.min,s.max);m=Math.ceil(Math.log(a[3]*t.height/v.y)/Math.log(2));u=Math.ceil(Math.log(u*t.width/v.x)/Math.log(2));return Math.min(isNaN(m)?1E3:m,isNaN(u)?1E3:u)},isEmpty:function(s){return!s||r.P.empty(s.min)||r.P.empty(s.max)},toString:function(s){return"min: "+r.P.toString(s.min)+", max: "+r.P.toString(s.max)}};return n}(),A:function(){var q=/^(\d+).*$/,g=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(o,l){q.lastIndex=-1;if(q.test(o))for(var n=
o.replace(q,"$1"),s=l.split(","),t=0;t<s.length;t++){g.lastIndex=-1;if(g.test(s[t])){var m=g.exec(s[t]);if(n>=parseInt(m[1],10)&&n<=parseInt(m[2],10))return true}else if(n==s[t])return true}return false},normalize:function(o){if(!o)return"";o=o.toUpperCase();if(!e){var l=[];for(var n in k)l.push(n);e=RegExp("(\\s)("+l.join("|")+")(\\s|$)","i")}e.lastIndex=-1;if(l=e.exec(o))o=o.replace(e,"$1"+k[l[2]]);return o},toString:function(o){return o.streetDetails+" "+o.location}}}(),getEngine:function(q){for(var g=
null,o=1;!g&&o<arguments.length;o++)g=p(q,arguments[o]);g=g?g:p(q);if(!g)throw Error("Unable to find GEO engine with "+q+" capability");return g},rankGeocodeResponses:function(q,g,o){var l=[],n=r.AddressCompareFns;if(o&&o.compareFns)n=GRUNT.extend({},n,o.compareFns);for(o=0;o<g.length;o++)l.push(new r.GeoSearchResult({caption:r.A.toString(g[o]),data:g[o],pos:g[o].pos,matchWeight:f(q,g[o],n,r.GeocodeFieldWeights)}));l.sort(function(s,t){return t.matchWeight-s.matchWeight});return l}};return r}();
T5.Geo.GeoHash=function(){function p(f,a,b){if(a&b)f[0]=(f[0]+f[1])/2;else f[1]=(f[0]+f[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(f){var a=1,b=[],d=[];b[0]=-90;b[1]=90;d[0]=-180;d[1]=180;lat_err=90;lon_err=180;for(i=0;i<f.length;i++){c=f[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(a){lon_err/=2;p(d,cd,mask)}else{lat_err/=2;p(b,cd,mask)}a=!a}}b[2]=(b[0]+
b[1])/2;d[2]=(d[0]+d[1])/2;return{latitude:b,longitude:d}},encode:function(f,a,b){var d=1,e=[],k=[],h=0,r=0;b=b?b:12;geohash="";e[0]=-90;e[1]=90;k[0]=-180;for(k[1]=180;geohash.length<b;){if(d){mid=(k[0]+k[1])/2;if(a>mid){r|=BITS[h];k[0]=mid}else k[1]=mid}else{mid=(e[0]+e[1])/2;if(f>mid){r|=BITS[h];e[0]=mid}else e[1]=mid}d=!d;if(h<4)h++;else{geohash+=BASE32[r];r=h=0}}return geohash}}}();
T5.Geo.Search=function(){return{bestResults:function(p,f){f||(f=20);for(var a=p.length>0?p[0]:null,b=[],d=0;d<p.length;d++)if(a.matchWeight-p[d].matchWeight<=f)b.push(p[d]);else break;return b}}}();
T5.Geo.Routing=function(){var p={calculate:function(f){f=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},f);GRUNT.Log.info("attempting to calculate route");var a=T5.Geo.getEngine("route");a&&a.route(f,function(b){if(f.generalize)b.geometry=T5.Geo.P.generalize(b.geometry,b.getInstructionPositions());if(f.map){p.createMapOverlay(f.map,b);if(f.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+b.boundingBox);f.map.gotoBounds(b.boundingBox)}}f.success&&
f.success(b)})},createMapOverlay:function(f,a){var b=f.getDimensions();b=new T5.Geo.UI.RouteOverlay({data:a,width:b.width,height:b.height});f.setLayer("route",b)},parseTurnType:function(f){for(var a=p.TurnType.Unknown,b=T5.Geo.Routing.TurnTypeRules,d=0;d<b.length;d++){b[d].regex.lastIndex=-1;var e=b[d].regex.exec(f);if(e){a=b[d].customCheck?b[d].customCheck(f,e):b[d].turnType;break}}return a},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",TurnLeft:"turn-left",
TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(f){f=GRUNT.extend({position:null,description:"",turnType:null},f);if(!f.turnType)f.turnType=p.parseTurnType(f.description);return f},RouteData:function(f){f=GRUNT.extend({geometry:[],instructions:[],
boundingBox:null},f);if(!f.boundingBox)f.boundingBox=T5.Geo.B.forPositions(f.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var a=[],b=0;b<f.instructions.length;b++)f.instructions[b].position&&a.push(f.instructions[b].position);return a}},f)}};return p}();
T5.Geo.Routing.TurnTypeRules=function(){var p=T5.Geo.Routing.TurnType,f=[];f.push({regex:/continue/i,turnType:p.Continue});f.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(a,b){return/bear/i.test(b[1])?p.TurnLeftSlight:p.TurnLeft}});f.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(a,b){return/bear/i.test(b[1])?p.TurnRightSlight:p.TurnRight}});f.push({regex:/enter\s(roundabout|rotaty)/i,turnType:p.EnterRoundabout});f.push({regex:/take.*?ramp/i,turnType:p.Ramp});f.push({regex:/take.*?exit/i,
turnType:p.RampExit});f.push({regex:/make(.*?)u\-turn/i,customCheck:function(a,b){return/right/i.test(b[1])?p.UTurnRight:p.UTurnLeft}});f.push({regex:/proceed/i,turnType:p.Start});f.push({regex:/arrive/i,turnType:p.Arrive});f.push({regex:/fell\sthrough/i,turnType:p.Merge});return f}();
T5.Geo.UI=function(){var p=0,f={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new T5.Geo.Position,centerXY:new T5.Vector,radsPerPixel:0},a);var b=T5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),d=b.x-a.centerXY.x,e=b.y-a.centerXY.y,k=GRUNT.extend({},a.grid,{getBoundingBox:function(h,r,q,g){return new T5.Geo.BoundingBox(k.pixelsToPos(new T5.Vector(h,r+g)),k.pixelsToPos(new T5.Vector(h+q,r)))},getGridXYForPosition:function(h){h=T5.Geo.P.toMercatorPixels(h,a.radsPerPixel);
return new T5.Vector(h.x-d,k.gridDimensions.height-(h.y-e))},getPixelDistance:function(h){h=T5.Geo.Utilities.dist2rad(h);return Math.floor(h/a.radsPerPixel)},pixelsToPos:function(h){return T5.Geo.P.fromMercatorPixels(d+h.x,e+k.gridDimensions.height-h.y,a.radsPerPixel)}});return k},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var b=true,d=
null,e=[],k=0,h=[],r=[],q=GRUNT.extend(new T5.ViewLayer(a),{getAnimation:function(g,o,l,n){if(b)return null;var s="routeAnimation"+p++;r.push(s);return new T5.AnimatedPathLayer({id:s,path:e,zindex:a.zindex+1,easing:g?g:T5.Easing.Sine.InOut,duration:o?o:5E3,drawIndicator:l,autoCenter:n?n:false})},draw:function(g,o,l,n,s){l=0;n=a.data?a.data.geometry:null;if(b){b=false;d=null;e=[];k=0}if(n&&k<n.length){a:{s=s.getTileLayer();h=[];if(s){n=GRUNT.Log.getTraceTicks();var t,m,u,v=a.data?a.data.geometry:[],
w=v.length,x=a.data?a.data.instructions:[],A=x.length,C=a.calculationsPerCycle,K=0;for(t=k;t<w;t++){m=s.getGridXYForPosition(v[t]);if(u=!d||t===0||Math.abs(m.x-d.x)+Math.abs(m.y-d.y)>a.pixelGeneralization){e.push(m);d=m}K++;if(K>=C){k=t;break a}}k=w;GRUNT.Log.trace(w+" geometry points generalized to "+e.length+" coordinates",n);d=null;for(t=A;t--;)if(x[t].position){m=s.getGridXYForPosition(x[t].position);if(u=!d||t===0||Math.abs(m.x-d.x)+Math.abs(m.y-d.y)>a.pixelGeneralization){h.push(m);d=m}}}}l++}s=
e.length;if(s>0&&(!l||a.partialDraw)){g.strokeStyle=a.strokeStyle;g.lineWidth=a.lineWidth;g.beginPath();g.moveTo(e[s-1].x-o.x,e[s-1].y-o.y);for(s=s;s--;)g.lineTo(e[s].x-o.x,e[s].y-o.y);g.stroke();g.fillStyle=a.waypointFillStyle;for(s=h.length;s--;){g.beginPath();g.arc(h[s].x-o.x,h[s].y-o.y,2,0,Math.PI*2,false);g.stroke();g.fill()}}return l}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var g=r.length;g--;)GRUNT.WaterCooler.say("layer.remove",{id:r[g]});r=[];b=true;q.wakeParent()});return q},
Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,calcXY:null,tweenIn:f.AnnotationTween,animationSpeed:null},a);var b=false,d={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return b},calcXY:function(e){d.xy=e.getGridXYForPosition(d.pos);a.calcXY&&a.calcXY(e)},draw:function(e,k,h,r,q){if(d.xy){if(d.isNew&&a.tweenIn){var g=d.xy.y;d.xy.y=k.y-20;b=true;T5.Animation.tween(d.xy,"y",g,a.tweenIn,function(){d.xy.y=g;b=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(e,
k,new T5.Vector(d.xy.x-k.x,d.xy.y-k.y),h,r,q);else{e.beginPath();e.arc(d.xy.x-k.x,d.xy.y-k.y,4,0,Math.PI*2,false);e.fill()}d.isNew=false}}};return d},ImageAnnotation:function(a){a=GRUNT.extend({imageUrl:null,animatingImageUrl:null,imageAnchor:null},a);var b=a.imageAnchor?T5.V.invert(a.imageAnchor):null;a.draw=function(e,k,h,r,q){if(a.animatingImageUrl&&d.isAnimating()){T5.Resources.loadImage(a.imageUrl);r=a.animatingImageUrl}else r=a.imageUrl;if(k=T5.Resources.getImage(r)){if(k.complete&&k.width>
0){b||(b=new T5.Vector(-k.width>>1,-k.height>>1));h=T5.V.offset(h,b.x,b.y);e.drawImage(k,h.x,h.y,k.width,k.height)}}else T5.Resources.loadImage(r,function(){q.wakeParent()})};var d=new f.Annotation(a);return d},LocationAnnotation:function(a){a=GRUNT.extend({accuracy:null},a);var b=new Image,d=new T5.Vector,e=null;b.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAACIQAAAiEBPhEQkwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAG+SURBVCiRlZHNahNRAIW/O7mTTJPahLZBA1YUyriINRAE3bQIKm40m8K8gLj0CRQkO32ELHUlKbgoIu4EqeJPgtCaoBuNtjXt5LeTMZk0mbmuWiuuPLsD3+HAOUIpxf9IHjWmaUbEyWv5ROrsVULhcHP761rUfnN3Y2Otc8CIg4YT85lzuVsPP+Qupw1vpPjRCvhS9ymvV0e77x7nNj+uvADQAIQQ+uLyvdfLV9JGZi7EdEwQlqBpEJ019f0z1mo2u5Q8DMydv25lshemmj1FueZTawbs7inarqLbV7Qjab1upB9YlhWSAHLavLHZCvg1VEhN0PMU9W7At4bPVidg7CtkLLXkut+lBPD6/Ub155jJiADAHSpaLmx3ApyBQoYEUd0PBoOBkAC6+3llvda/YxgGgYL+UNHf/zN3KiExGlsvTdP0NYDkhPdWrz35ZDsBzV5wCMuQwEyFmXFeeadjzfuFQmGkAZRKpdGC/n7x+M6jqvA9Zo6FWDhlcHE+wqT93J1tP7vpOE7rrx8ALMuasPf8S12St4WmJ6bYWTUC52k8Hm8Vi0X/nwBAPp/XKpWKdF1X2LYdlMvlsToC/QYTls7DLFr/PAAAAABJRU5ErkJggg%3D%3D";
b.onload=function(){d=new T5.Vector(b.width/2,b.height/2)};var k=new f.Annotation(GRUNT.extend({calcXY:function(h){e=Math.floor(h.getPixelDistance(k.accuracy)*0.5)},draw:function(h,r,q,g,o,l){r=q.x-d.x;g=q.y-d.y;if(e&&k.drawAccuracyIndicator){h.fillStyle="rgba(30, 30, 30, 0.2)";h.beginPath();h.arc(q.x,q.y,e,0,Math.PI*2,false);h.fill()}b.complete&&b.width>0&&h.drawImage(b,r,g,b.width,b.height);l.trigger("invalidate")}},a));k.accuracy=a.accuracy;k.drawAccuracyIndicator=false;return k},AnnotationsOverlay:function(a){function b(r){var q=
a.map?a.map.getTileLayer():null,g=r.length;if(q)for(g=g;g--;)r[g].calcXY(q);r.sort(function(o,l){var n=l.xy.y-o.xy.y;if(n===0)n=l.xy.x-o.xy.x;return n})}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var d=[],e=false,k=[],h=GRUNT.extend(new T5.ViewLayer(a),{cycle:function(){return e?1:0},draw:function(r,q,g,o,l){e=false;r.fillStyle="rgba(255, 0, 0, 0.75)";r.globalCompositeOperation="source-over";for(g=d.length;g--;){d[g].draw(r,q,o,h,l);e=e||d[g].isAnimating()}for(g=
k.length;g--;){k[g].draw(r,q,o,h,l);e=e||k[g].isAnimating()}return e?1:0},add:function(r){k.push(r);b(k);h.wakeParent()},clear:function(r){k=[];b(k);if(r){d=[];b(d)}h.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(r){if(a.pois&&a.pois.id==r.srcID){r=r.pois;try{d=[];for(var q=0;q<r.length;q++)if(r[q].pos){var g;var o=r[q];if(o&&o.pos){var l=null;if(l=a.createAnnotationForPOI?a.createAnnotationForPOI(o):new f.Annotation({pos:o.pos})){l.isNew=o.isNew;o.isNew=false}g=l}else g=void 0;
g&&d.push(g)}b(d)}catch(n){GRUNT.Log.exception(n)}h.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){b(d);b(k);h.wakeParent()});return h}};return f}();
T5.Map=function(p){function f(u){try{var v=new T5.Geo.Position(u.coords.latitude,u.coords.longitude),w=u.coords.accuracy/1E3;m.trigger("locationUpdate",u,w);if(s){if(!o){o=new module.LocationAnnotation({pos:v,accuracy:w});m.bind("tileDrawComplete",function(){o.drawAccuracyIndicator=true})}p.displayLocationAnnotation&&r.add(o);var x=T5.Geo.B.createBoundsFromCenter(v,Math.max(w,1));m.gotoBounds(x)}else{o.pos=v;o.accuracy=w;o.calcXY(m.getTileLayer());m.panToPosition(v,null,T5.Easing.Sine.Out)}s=false}catch(A){GRUNT.Log.exception(A)}}
function a(u){GRUNT.Log.info("caught location tracking error:",u)}p=GRUNT.extend({tapExtent:10,provider:null,crosshair:false,zoomLevel:0,boundsChange:null,tapPOI:null,boundsChangeThreshold:30,pois:new T5.Geo.POIStorage,createAnnotationForPOI:null,displayLocationAnnotation:true,zoomAnimation:T5.Easing.Quad.Out},p);var b={NONE:0,SINGLE:1,WATCH:2},d=new T5.Vector,e=b.NONE,k=false,h=[],r=null,q=null,g=null,o=null,l=0,n=false,s=true,t=p.zoomLevel;if(!p.provider)p.provider=new T5.Geo.MapProvider;p.adjustScaleFactor=
function(u){return Math.pow(2,(u<1?Math.floor:Math.ceil)(Math.log(u)))};var m=GRUNT.extend({},new T5.Tiling.Tiler(p),{pois:p.pois,annotations:null,getProvider:function(){return p.provider},setProvider:function(u){p.provider=u;k=false},getBoundingBox:function(){var u=m.getTileLayer(),v=m.getOffset(),w=m.getDimensions();if(u)return u.getBoundingBox(v.x,v.y,w.width,w.height);return null},getCenterPosition:function(){return m.getXYPosition(T5.D.getCenter(m.getDimensions()))},getXYPosition:function(u){return m.getTileLayer().pixelsToPos(m.viewPixToGridPix(u))},
gotoBounds:function(u,v){var w=T5.Geo.B.getZoomLevel(u,m.getDimensions());m.gotoPosition(T5.Geo.B.getCenter(u),w,v)},gotoPosition:function(u,v,w){function x(F){m.setTileLayer(F);g=F.getId();m.panToPosition(u,function(){m.unfreeze();m.trigger("zoomLevelChange",t);w&&w()});k=true;n=false}var A=t,C=!k,K=m.getBoundingBox();if(K)C=C||!T5.Geo.P.inBounds(u,K);t=v?v:t;if(!t)throw Error("Zoom level required to goto a position.");if(p.provider)t=p.provider.checkZoomLevel(t);if(C||t!==A)if(n)GRUNT.Log.warn("Tile request in progress, aborting");
else{T5.Resources.resetImageLoadQueue();if(o)o.drawAccuracyIndicator=false;(v=m.getTileLayer())&&v.deactivate();T5.Animation.cancel();k&&m.freeze();n=true;p.provider.zoomLevel=t;p.provider.getMapTiles(m,u,x)}else m.panToPosition(u,w)},panToPosition:function(u,v,w){var x=m.getTileLayer();if(x){u=x.getGridXYForPosition(u);x=m.getDimensions();u.x-=x.width/2;u.y-=x.height/2;if(q)q=null;m.updateOffset(u.x,u.y,w);m.trigger("wake");p.boundsChange&&p.boundsChange(m.getBoundingBox());v&&v(m)}},locate:function(){m.trackStart(b.SINGLE);
setTimeout(m.trackCancel,1E4)},trackStart:function(u){if(navigator.geolocation){e=u?u:b.WATCH;s=true;l=navigator.geolocation.watchPosition(f,a,{enableHighAccuracy:true,timeout:1E4,maximumAge:5E3})}},trackCancel:function(){l&&navigator.geolocation&&navigator.geolocation.clearWatch(l);e===b.WATCH&&r.clear();e=b.NONE;l=0},getZoomLevel:function(){return t},setZoomLevel:function(u){try{m.gotoPosition(m.getCenterPosition(),u)}catch(v){GRUNT.Log.exception(v)}},zoomIn:function(){m.scale(2,T5.Easing.Sine.Out)||
m.setZoomLevel(t+1)},zoomOut:function(){m.scale(0.5,T5.Easing.Sine.Out)||m.setZoomLevel(t-1)},animateRoute:function(u,v,w,x){var A=m.getLayer("route");if(A)(u=A.getAnimation(u,v,w,x))&&u.addToView(m)}});m.bind("pan",function(){e===b.SINGLE&&m.trackCancel()});m.bind("tap",function(u,v){var w=m.getTileLayer(),x=null;if(w){var A=m.viewPixToGridPix(new T5.Vector(v.x,v.y)),C=w.pixelsToPos(A);x=w.pixelsToPos(T5.V.offset(A,-p.tapExtent,p.tapExtent));w=w.pixelsToPos(T5.V.offset(A,p.tapExtent,-p.tapExtent));
x=new T5.Geo.BoundingBox(x,w);h=m.pois.findByBounds(x);m.trigger("geotap",u,v,C,x);p.tapPOI&&p.tapPOI(h)}});m.bind("doubleTap",function(u,v){m.animate(2,T5.D.getCenter(m.getDimensions()),new T5.Vector(v.x,v.y),p.zoomAnimation)});m.bind("scale",function(u,v){var w=0;u=Math.sqrt(u);if(u<1)w=-(0.5/u);else if(u>1)w=u;m.gotoPosition(m.getXYPosition(v),t+Math.floor(w))});r=new T5.Geo.UI.AnnotationsOverlay({pois:m.pois,map:m,createAnnotationForPOI:p.createAnnotationForPOI});m.annotations=r;m.setLayer("annotations",
r);p.crosshair&&m.setLayer("crosshair",new CrosshairOverlay);m.bind("idle",function(){if(T5.V.absSize(T5.V.diff(d,m.getOffset()))>p.boundsChangeThreshold&&p.boundsChange){d=m.getOffset();p.boundsChange(m.getBoundingBox())}});return m};
