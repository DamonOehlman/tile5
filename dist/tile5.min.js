if(!this.JSON)this.JSON={};
(function(){function u(e){return e<10?"0"+e:e}function q(e){a.lastIndex=0;return a.test(e)?'"'+e.replace(a,function(g){var o=h[g];return typeof o==="string"?o:"\\u"+("0000"+g.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function l(e,g){var o,m,n,r,s=b,p,x=g[e];if(x&&typeof x==="object"&&typeof x.toJSON==="function")x=x.toJSON(e);if(typeof k==="function")x=k.call(g,e,x);switch(typeof x){case "string":return q(x);case "number":return isFinite(x)?String(x):"null";case "boolean":case "null":return String(x);
case "object":if(!x)return"null";b+=d;p=[];if(Object.prototype.toString.apply(x)==="[object Array]"){r=x.length;for(o=0;o<r;o+=1)p[o]=l(o,x)||"null";n=p.length===0?"[]":b?"[\n"+b+p.join(",\n"+b)+"\n"+s+"]":"["+p.join(",")+"]";b=s;return n}if(k&&typeof k==="object"){r=k.length;for(o=0;o<r;o+=1){m=k[o];if(typeof m==="string")if(n=l(m,x))p.push(q(m)+(b?": ":":")+n)}}else for(m in x)if(Object.hasOwnProperty.call(x,m))if(n=l(m,x))p.push(q(m)+(b?": ":":")+n);n=p.length===0?"{}":b?"{\n"+b+p.join(",\n"+b)+
"\n"+s+"}":"{"+p.join(",")+"}";b=s;return n}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+u(this.getUTCMonth()+1)+"-"+u(this.getUTCDate())+"T"+u(this.getUTCHours())+":"+u(this.getUTCMinutes())+":"+u(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var f=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
a=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,b,d,h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},k;if(typeof JSON.stringify!=="function")JSON.stringify=function(e,g,o){var m;d=b="";if(typeof o==="number")for(m=0;m<o;m+=1)d+=" ";else if(typeof o==="string")d=o;if((k=g)&&typeof g!=="function"&&(typeof g!=="object"||typeof g.length!=="number"))throw Error("JSON.stringify");return l("",
{"":e})};if(typeof JSON.parse!=="function")JSON.parse=function(e,g){function o(n,r){var s,p,x=n[r];if(x&&typeof x==="object")for(s in x)if(Object.hasOwnProperty.call(x,s)){p=o(x,s);if(p!==undefined)x[s]=p;else delete x[s]}return g.call(n,r,x)}var m;e=String(e);f.lastIndex=0;if(f.test(e))e=e.replace(f,function(n){return"\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(e.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){m=eval("("+e+")");return typeof g==="function"?o({"":m},""):m}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(u){if(arguments.length<=1)return u;for(var q=arguments.length-2,l=0;l<=q;l++)u=u.replace(RegExp("\\{"+l+"\\}","gi"),arguments[l+1]);return u};
String.prototype.containsWord=function(u){var q="";if(u.toString)u=u.toString();for(var l=0;l<u.length;l++)q+=!/\w/.test(u[l])?"\\"+u[l]:u[l];return RegExp("(^|\\s|\\,)"+q+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var u=Object.prototype.hasOwnProperty,q=0,l={id:"GRUNT.core",extend:function(){var f=arguments[0]||{},a=1,b=arguments.length,d=false,h,k,e,g;if(typeof f==="boolean"){d=f;f=arguments[1]||{};a=2}if(typeof f!=="object"&&!l.isFunction(f))f={};if(b===a){f=this;--a}for(;a<b;a++)if((h=arguments[a])!=null)for(k in h){e=f[k];g=h[k];if(f!==g)if(d&&g&&(l.isPlainObject(g)||l.isArray(g))){e=e&&(l.isPlainObject(e)||l.isArray(e))?e:l.isArray(g)?[]:{};f[k]=l.extend(d,e,g)}else if(g!==undefined)f[k]=
g}return f},isFunction:function(f){return toString.call(f)==="[object Function]"},isArray:function(f){return toString.call(f)==="[object Array]"},isPlainObject:function(f){if(!f||toString.call(f)!=="[object Object]"||f.nodeType||f.setInterval)return false;if(f.constructor&&!u.call(f,"constructor")&&!u.call(f.constructor.prototype,"isPrototypeOf"))return false;var a;for(a in f);return a===undefined||u.call(f,a)},isEmptyObject:function(f){for(var a in f)return false;return true},isXmlDocument:function(f){return toString.call(f)===
"[object Document]"},contains:function(f,a){var b=f,d=arguments,h=1;if(a&&l.isArray(a)){d=a;h=0}for(h=h;h<d;h++)b=b&&typeof foo[d[h]]!=="undefined";return b},newModule:function(f){f=l.extend({id:null,requires:[],parent:null},f);if(f.parent)f=l.extend({},f.parent,f);return f},toID:function(f){return f.replace(/\s/g,"-")},generateObjectID:function(f){return(f?f:"obj")+q++}};return l}();
GRUNT.Log=function(){function u(b,d){var h,k=d&&d.length>0?d[0]:"";for(h=1;d&&h<d.length;h++)k+=" "+(l&&GRUNT.isPlainObject(d[h])?JSON.stringify(d[h]):d[h]);typeof console!=="undefined"&&console[b](k);for(h=0;h<q.length;h++)q[h].call(a,k,b)}var q=[],l=typeof JSON!=="undefined",f=window.console&&window.console.markTimeline,a={id:"GRUNT.log",getTraceTicks:function(){return f?(new Date).getTime():null},trace:function(b,d){if(f)console.markTimeline(b+(d?": "+(a.getTraceTicks()-d)+"ms":""))},debug:function(){u("debug",
arguments)},info:function(){u("info",arguments)},warn:function(){u("warn",arguments)},error:function(){u("error",arguments)},exception:function(b){a.error(arguments);for(var d in b)a.info("ERROR DETAIL: "+d+": "+b[d])},watch:function(b,d){try{d()}catch(h){a.exception(h,b)}},throwError:function(b){a.error(b);throw Error(b);},requestUpdates:function(b){q.push(b)}};return a}();
GRUNT.Data=function(){var u={determineObjectMapping:function(l){if(!l)return null;l=l.split("|");for(var f={},a=0;a<l.length;a++)f[l[a]]=a;return f},mapLineToObject:function(l,f){var a=l.split("|"),b={};for(var d in f){var h=f[d];b[d]=a.length>h?a[h]:null}return b},parse:function(l){var f=null,a=[];l=l.split("\n");for(var b=0;b<l.length;b++){var d=l[b];if(f)a.push(u.mapLineToObject(d,f));else f=u.determineObjectMapping(d)}return a}},q={supportedFormats:{JSON:{parse:function(l){return JSON.parse(l)}},
PDON:{parse:function(l){return u.parse(l)}}},parse:function(l){l=GRUNT.extend({data:"",format:"JSON"},l);if(!q.supportedFormats[l.format])throw Error("Unsupported data format: "+l.format+", cannot parse data in javascript object");try{return q.supportedFormats[l.format].parse(l.data)}catch(f){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+l.format,l.data);GRUNT.Log.exception(f)}return{}}};return q}();
GRUNT.Template=function(){var u=/\$\{(.*?)\}/ig;return{parse:function(q,l){for(var f=q,a=u.exec(f);a;){f=f.replace(a[0],GRUNT.XPath.first(a[1],l));u.lastIndex=0;a=u.exec(f)}return f}}}();
GRUNT.JSONP=function(){function u(a){var b=document.createElement("script"),d=false;b.src=a;b.async=true;b.onload=b.onreadystatechange=function(){if(!d&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){d=true;b.onload=b.onreadystatechange=null;b&&b.parentNode&&b.parentNode.removeChild(b)}};l||(l=document.getElementsByTagName("head")[0]);l.appendChild(b)}var q=0,l,f=this;return{get:function(a,b,d){a+=a.indexOf("?")>=0?"&":"?";var h="json"+ ++q;f[h]=function(k){b(k);f[h]=
null;try{delete f[h]}catch(e){}};u(a+(d?d:"callback")+"="+h);return h}}}();
GRUNT.XHR=function(){var u={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},q={JSON:["json"],PDON:["pdon.txt"]},l=["TEXT","STREAM"],f=/^(\w+:)?\/\/([^\/?#]+)/,a={XML:function(h){return h.responseXML},JSON:function(h){try{return JSON.parse(h.responseText)}catch(k){GRUNT.Log.error("Error parsing JSON data: ",h.responseText);GRUNT.Log.exception(k)}return""},PDON:function(h){return GRUNT.Data.parse({data:h.responseText,format:"PDON"})},DEFAULT:function(h){return h.responseText}},
b={CONTENT_TYPE:"Content-Type"},d=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(h){try{h=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},d.ajaxSettings,h);var k=f.exec(h.url),e=k&&(k[1]&&k[1]!==location.protocol||k[2]!==location.host);if(h.data)h.method="POST";if(h.url){k=null;if(h.xhr)k=h.xhr(h);k||(k=new XMLHttpRequest);k.open(h.method,h.url,h.async);h.data&&k.setRequestHeader("Content-Type",
h.contentType);e||k.setRequestHeader("X-Requested-With","XMLHttpRequest");k.onreadystatechange=function(){if(this.readyState===4){var o=null,m=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(m)if(h.handleResponse)h.handleResponse(this);else{var n=h,r=this.getResponseHeader(b.CONTENT_TYPE),s,p=false;for(s in u)if(r&&r.indexOf(u[s])>=0){p=true;break}r=!p;for(p=0;p<l.length;p++)r=r||l[p]==s;if(r)b:{r=s;for(var x in q)for(p=
0;p<q[x].length;p++)if(RegExp(q[x][p]+"$","i").test(n.url)){s=x;break b}s=r?r:"DEFAULT"}try{o=a[s](this,n)}catch(t){GRUNT.Log.warn("error applying processor '"+s+"' to response type, falling back to default");o=a.DEFAULT(this,n)}}else h.error&&h.error(this)}catch(v){GRUNT.Log.exception(v,"PROCESSING AJAX RESPONSE")}m&&o&&h.success&&h.success.call(this,o)}};k.send(h.method=="POST"?d.param(h.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(g){GRUNT.Log.exception(g)}},
param:function(h){var k=[],e=function(o,m){m=GRUNT.isFunction(m)?m():m;k[k.length]=encodeURIComponent(o)+"="+encodeURIComponent(m)};if(GRUNT.isArray(h))for(var g=0;g<h.length;g++)e(h[g].name,h[g].value);else for(g in h)e(g,h[g]);return k.join("&").replace(/%20/g,"+")}});return d}();
GRUNT.XPath=function(){function u(a){for(var b=null,d=0;d<q.length;d++)if(b=q[d](a))break;return b}var q=[],l=[null,function(a){return a.numberValue},function(a){return a.stringValue},function(a){return a.booleanValue},null,null,null,null,function(a){return a.singleNodeValue?a.singleNodeValue.textContent:null},function(a){return a.singleNodeValue?a.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var f={SearchResult:function(a){return{toString:function(){var b=
null;if(a){var d=null;if(a.resultType>=0&&a.resultType<l.length)d=l[a.resultType];if(d){GRUNT.Log.info("invoking match handler for result type: "+a.resultType);b=d(a)}}return b?b:""}}},first:function(a,b){var d=f.SearchResult,h;var k=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!k)k=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(b))h=b.evaluate(a,b,u,k,null);else{GRUNT.Log.warn("attempted xpath expression: "+a+" on a non-xml document");h=null}}catch(e){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
a+" on node: "+b);h=null}return new d(h)},registerResolver:function(a){q.push(a)}};return f}();GRUNT.Observable=function(){var u={},q=0,l={bind:function(f,a){u[f]||(u[f]=[]);q+=1;u[f].push({callback:a,callbackId:q});return q},trigger:function(f){var a=u[f];if(a)for(var b=a.length;b--;)a[b].callback.apply(l,Array.prototype.slice.call(arguments,1))},unbind:function(f,a){for(var b=u[f],d=0;b&&d<b.length;d++)if(b[d].callbackId===a){b.splice(d,1);break}}};return l};
GRUNT.WaterCooler=function(){var u={},q=[];return{addPipe:function(l){l("pipe.test",{});q.push(l)},listen:function(l,f){u[l]||(u[l]=[]);f&&u[l].push(f)},say:function(l,f){var a;for(a=q.length;a--;)q[a](l,f);if(u[l])for(a=u[l].length;a--;)u[l][a](f)},leave:function(){}}}();
TILE5=function(){var u={newCanvas:function(q,l){var f=document.createElement("canvas");typeof G_vmlCanvasManager!=="undefined"&&G_vmlCanvasManager.initElement(f);f.width=q?q:0;f.height=l?l:0;return f},Settings:function(){var q={};return{get:function(l){return q[l]},set:function(l,f){q[l]=f},extend:function(l){GRUNT.extend(q,l)}}}(),Clock:function(){var q=null;return{getTime:function(l){return l&&q?q:q=(new Date).getTime()}}}(),Vector:function(q,l){return{x:q?q:0,y:l?l:0}},V:function(){function q(l){if(!l||
l.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var f={edges:Array(l.length-1),accrued:Array(l.length-1),total:0},a=TILE5.V.diff,b=0;b<l.length-1;b++){var d=a(l[b],l[b+1]);f.edges[b]=Math.sqrt(d.x*d.x+d.y*d.y);f.accrued[b]=f.total+f.edges[b];f.total+=f.edges[b]}return f}return{create:function(l,f){return new u.Vector(l,f)},add:function(){for(var l=new u.Vector,f=arguments.length;f--;){l.x+=arguments[f].x;l.y+=arguments[f].y}return l},absSize:function(l){return Math.max(Math.abs(l.x),
Math.abs(l.y))},diff:function(l,f){return new u.Vector(l.x-f.x,l.y-f.y)},copy:function(l){return l?new u.Vector(l.x,l.y):null},invert:function(l){return new TILE5.Vector(-l.x,-l.y)},offset:function(l,f,a){return new TILE5.Vector(l.x+f,l.y+(a?a:f))},edges:q,distance:function(l){return q(l).total},theta:function(l,f,a){a=Math.asin((l.y-f.y)/a);return l.x>f.x?a:Math.PI-a},pointOnEdge:function(l,f,a,b){f=new TILE5.Vector(Math.cos(a)*b,Math.sin(a)*b);return new TILE5.Vector(l.x-f.x,l.y-f.y)},getRect:function(l){var f=
l.length;if(f>1)return new TILE5.Rect(Math.min(l[0].x,l[f-1].x),Math.min(l[0].y,l[f-1].y),Math.abs(l[0].x-l[f-1].x),Math.abs(l[0].y-l[f-1].y))},toString:function(l){return l.x+", "+l.y}}}(),Dimensions:function(q,l){return{width:q?q:0,height:l?l:0}},D:function(){return{getAspectRatio:function(q){return q.height!==0?q.width/q.height:1},getCenter:function(q){return new u.Vector(q.width/2,q.height/2)},getSize:function(q){return Math.sqrt(Math.pow(q.width,2)+Math.pow(q.height,2))}}}(),Rect:function(q,
l,f,a){return{origin:new u.Vector(q,l),dimensions:new u.Dimensions(f,a)}},R:function(){return{copy:function(q){return q?new u.Rect(q.origin.x,q.origin.y,q.dimensions.width,q.dimensions.height):null},getCenter:function(q){return new TILE5.Vector(q.origin.x+q.dimensions.width/2,q.origin.y+q.dimensions.height/2)}}}()};return u}();
TILE5.Device=function(){function u(){for(;g.length>0;){var m=g.shift();document.location=m}e=0}function q(m){for(var n=true,r=o.length;r--;)n=n&&m!=o[r];return n}function l(m,n){var r=[];for(var s in n)s&&r.push(s+"="+escape(n[s]));return"tile5://"+m+"/"+(r.length>0?"?"+r.join("&"):"")}function f(m,n){q(m)&&GRUNT.Log.info("would push url: "+l(m,n))}function a(m,n){if(q(m)){g.push(l(m,n));e||(e=setTimeout(u,100))}}function b(){d={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:null,requireFastDraw:false,bridgeNotify:f,targetFps:null},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:false,bridgeNotify:a,targetFps:25},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:a},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:a},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,
supportsTouch:true,getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:a},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:a}};h=[d.froyo,d.android,d.ipod,d.iphone,d.ipad]}var d=null,h=[],k=null,e=0,g=[],o=["view.wake","tile.loaded"];return{getConfig:function(){d||b();if(!k){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var m=0;m<h.length;m++){var n=h[m];if(n.regex&&n.regex.test(navigator.userAgent)){k=
GRUNT.extend({},d.base,n);GRUNT.Log.info("PLATFORM DETECTED AS: "+k.name);break}}if(!k){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");k=d.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return k}}}();
TILE5.Resources=function(){var u="",q={},l=function(){function a(){var t=e[this.id];if(t&&t.image.complete&&t.image.width>0){t.loaded=true;t.hitCount=1;for(var v=m.length;v--;)if(m[v].image.src==this.src){m.splice(v,1);break}t.loadCallback&&t.loadCallback(this,false);n.push({url:this.src,created:t.requested});delete e[this.id];b()}}function b(){for(var t=TILE5.Device.getConfig().maxImageLoads;o.length>0&&(!t||m.length<t);){var v=o.shift();if(v.imageLoader){m.push(v);v.imageLoader(v,a)}}}function d(t){for(var v=
null,w=r.length;w--&&!v;)v=r[w](t);return v?v:function(y,B){y.image.onload=B;y.image.src=f.getPath(y.url);y.requested=(new Date).getTime()}}function h(){p=true;try{var t=Math.floor(n.length/2);if(t>0){n.sort(function(w,y){return w.created-y.created});for(var v=t;v--;)delete k[n[v].url];n.splice(0,t)}}finally{p=false}GRUNT.WaterCooler.say("imagecache.cleared")}var k={},e={},g=0,o=[],m=[],n=[],r=[],s=0,p=false,x={loadingImages:m,queuedImages:o,addInterceptor:function(t){r.push(t)},getCacheFullness:function(){return s},
getImage:function(t){var v=null;p||(v=k[t]);return v?v.image:null},loadImage:function(t,v){var w=k[t];if(w){w.hitCount++;w.image.complete&&v&&v(w.image,true)}else{w={url:t,image:new Image,loaded:false,imageLoader:d(t),created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:v};w.image.id="resourceLoaderImage"+g++;k[t]=w;e[w.image.id]=w;o.push(w);b()}return w},resetLoadingQueue:function(){m=[]}};setInterval(function(){for(var t=(new Date).getTime(),v=false,w=0,y=TILE5.Device.getConfig();w<
m.length;)if(t-m[w].requested>f.loadTimeout*1E3){m.splice(w,1);v=true}else w++;v&&b();if(y&&y.imageCacheMaxSize){s=n.length*f.avgImageSize/y.imageCacheMaxSize;s>=1&&h()}},1E3);return x}(),f={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(a,b){for(var d=(a?a.replace(/^.*\?/,""):"").split("&"),h=a?a.replace(/\?.*$/,"?"):"",k=0;k<d.length;k++){var e=d[k].split("=");if(!b||!b.test(e[0]))h+=d[k]+"&"}return h.replace(/\W/g,
"")},isValidCacheKey:function(a){GRUNT.Log.info("cache key = "+a);return false}}}(),addInterceptor:l.addInterceptor,getPath:function(a){return/^(file|https?|\/)/.test(a)?a:u+a},setBasePath:function(a){u=a},getImage:function(a){return l.getImage(a)},loadImage:function(a,b){l.loadImage(a,b)},resetImageLoadQueue:function(){l.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:l.loadingImages.length,queuedImageCount:l.queuedImages.length,imageCacheFullness:l.getCacheFullness()}},loadResource:function(a){a=
GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},a);var b=function(d){a.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){a.callback(d)})};a.cacheable&&q[a.filename]?b(q[a.filename]):GRUNT.XHR.ajax({url:f.getPath(a.filename),dataType:a.dataType,success:function(d){if(a.cacheable)q[a.filename]=d;b(d)},error:function(d,h,k){GRUNT.Log.error("error loading resource ["+a.filename+"], error = "+k)}})},loadSnippet:function(a,b){/\.\w+$/.test(a)||(a+=".html");f.loadResource({filename:"snippets/"+
a,callback:b,dataType:"html"})}};return f}();
TILE5.Touch=function(){function u(n,r){var s=n&&n.length>0?n[0]:null;if(s&&r&&r.length>0)return TILE5.V.diff(s,r[0]);return null}function q(n){n.preventDefault();n.stopPropagation()}function l(n){for(var r=Array(n.length),s=n.length;s--;)r[s]=new TILE5.Vector(n[s].pageX,n[s].pageY);return r}function f(n){return[new TILE5.Vector(n.pageX,n.pageY)]}var a=120,b=100,d=250,h={TAP:0,MOVE:1,PINCHZOOM:2},k=7,e=0,g=0,o={TouchHelper:function(n){function r(A,F,E,M){var P=Math.asin((A.y-F.y)/E);E=Math.min(Math.floor(E*
(V.duration/M)),V.max);P=F.x>A.x?P:Math.PI-P;A=new TILE5.Vector(Math.cos(P)*-E,Math.sin(P)*E);x("inertiaPan",A.x,A.y)}function s(A,F){var E,M;if(H){E=F-W;if(E<d){M=TILE5.V.distance([J[0],A]);M>n.inertiaTrigger&&r(J[0],A,M,E)}}else{X=A;var P=setInterval(function(){E=(new Date).getTime()-F;M=TILE5.V.distance([A,X]);if(E<b&&M>n.inertiaTrigger){clearInterval(P);r(A,X,M,E)}else E>b&&clearInterval(P)},5)}}function p(A){for(var F=[],E=n.element?-n.element.offsetLeft:0,M=n.element?-n.element.offsetTop:0,
P=A.length;P--;)F.push(TILE5.V.offset(A[P],E,M));return F}function x(){n.observable&&n.observable.trigger.apply(null,arguments)}function t(A){if(A.target&&A.target===n.element){J=H?l(A.touches):f(A);I=new TILE5.Vector;T=new TILE5.Vector;Y=true;B=false;W=TILE5.Clock.getTime();H&&q(A);x("inertiaCancel");aa.current=W;if(A=J.length>0?J[0]:null){x("touchStart",A.x,A.y);if(aa.current-aa.last<Z.THRESHOLD_DOUBLETAP)if((A=N?TILE5.V.diff(J[0],N[0]):null)&&Math.abs(A.x)<n.maxDistDoubleTap&&Math.abs(A.y)<n.maxDistDoubleTap)B=
true;R=h.TAP;N=[].concat(J)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function v(A){if(A.target&&A.target===n.element){X=(H?l(A.touches):f(A))[0];if(Y)try{H&&q(A);var F=H?l(A.touches):f(A);A=0;if(F.length>1){if(J.length===1)J=[].concat(F);A=TILE5.V.distance(J)-TILE5.V.distance(F)}if(R===h.TAP){var E=u(F,J);if(E&&(Math.abs(E.x)>=k||Math.abs(E.y)>=k))R=h.MOVE}if(R!==h.TAP)if(!A||Math.abs(A)<n.pinchZoomThreshold){if(I=u(F,N)){T.x-=I.x;T.y-=I.y;O.x-=I.x;O.y-=I.y}if(TILE5.V.absSize(O)>
n.panEventThreshhold){x("pan",O.x,O.y);O=TILE5.V.create()}R=h.MOVE}else{x("pinchZoom",p(J),p(F));R=h.PINCHZOOM}N=[].concat(F)}catch(M){GRUNT.Log.exception(M)}}}function w(A){if(A.target&&A.target===n.element){var F=(H?l(A.changedTouches):f(A))[0];try{H&&q(A);var E=TILE5.Clock.getTime();aa.last=aa.current;if(R===h.TAP)D||(D=setTimeout(function(){D=0;var P=B?"doubleTap":"tap",$=J[0],U=null;if(n.element)U=TILE5.V.offset($,-n.element.offsetLeft,-n.element.offsetTop);x(P,$,U)},Z.THRESHOLD_DOUBLETAP+50));
else if(R==h.MOVE){x("panEnd",T.x,T.y);V&&s(F,E)}else R==h.PINCHZOOM&&x("pinchZoomEnd",p(J),p(N),E-W)}catch(M){GRUNT.Log.exception(M)}}Y=false}function y(A){if(A.target&&A.target===n.element){var F;if(A.detail){F=-A.detail*a;F=new TILE5.Vector(A.axis===1?F:0,A.axis===2?F:0)}else F=new TILE5.Vector(A.wheelDeltaX,A.wheelDeltaY);var E=F.y!==0?Math.abs(F.y/a):0;if(X&&E!==0){var M=TILE5.V.offset(X,-n.element.offsetLeft,-n.element.offsetTop);x("wheelZoom",M,Math.pow(2,F.y>0?E:-E))}A.preventDefault()}}n=
GRUNT.extend({element:null,observable:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},n);var B=false,D=0,H=TILE5.Device.getConfig().supportsTouch,J=null,N=null,I=null,T=null,O=new TILE5.Vector,R=null,Y=false,W=0,ba=[],X=null,V=null,aa={current:0,last:0},Q=TILE5.Device.getConfig(),Z={supportsTouch:H,
THRESHOLD_DOUBLETAP:300,addListeners:function(A){ba.push(A)},decoupleListeners:function(A){for(var F=0;A&&F<ba.length;F++)if(ba[F].listenerId===A){ba.splice(F,1);GRUNT.Log.info("successfully decoupled touch listener: "+A);break}},release:function(){Q.eventTarget.removeEventListener(Q.supportsTouch?"touchstart":"mousedown",t,false);Q.eventTarget.removeEventListener(Q.supportsTouch?"touchmove":"mousemove",v,false);Q.eventTarget.removeEventListener(Q.supportsTouch?"touchend":"mouseup",w,false);if(!Q.supportsTouch){window.removeEventListener("mousewheel",
y,false);window.removeEventListener("DOMMouseScroll",y,false)}},inertiaEnable:function(A,F){V={duration:A,max:F?Math.min(F.width,F.height):500}},inertiaDisable:function(){V=null}};Q.eventTarget.addEventListener(Q.supportsTouch?"touchstart":"mousedown",t,false);Q.eventTarget.addEventListener(Q.supportsTouch?"touchmove":"mousemove",v,false);Q.eventTarget.addEventListener(Q.supportsTouch?"touchend":"mouseup",w,false);if(!Q.supportsTouch){window.addEventListener("mousewheel",y,false);window.addEventListener("DOMMouseScroll",
y,false)}return Z}},m=[];return{captureTouch:function(n,r){if(!n)throw Error("Unable to capture touch of null element");if(!n.id)n.id="touchable_"+e++;var s=m[n.id];if(!s){s=o.TouchHelper(GRUNT.extend({element:n},r));m[n.id]=s;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+s.supportsTouch)}r.listenerId&&s.decoupleListeners(r.listenerId);r.listenerId=++g;s.addListeners(r);return s},resetTouch:function(n){if(n&&n.id&&m[n.id]){m[n.id].release();delete m[n.id]}}}}();
if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(u){return this.each(function(){TILE5.Touch.captureTouch(this,u)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(u){u.preventDefault()})}}
TILE5.Dispatcher=function(){var u=[],q={execute:function(l){var f=q.findAction(l);GRUNT.Log.info("looking for action id: "+l+", found: "+f);if(f){var a=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+l,function(){f.execute(a)})}},findAction:function(l){for(var f=u.length;f--;)if(u[f].id==l)return u[f];return null},getRegisteredActions:function(){return[].concat(u)},getRegisteredActionIds:function(){for(var l=[],f=u.length;f--;)u[f].id&&l.push(u[f].id);return l},registerAction:function(l){l&&
l.id&&u.push(l)},Action:function(l){l=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},l);var f={id:l.id,execute:function(){l.execute&&l.execute.apply(this,arguments)},getParam:function(a){return l[a]?l[a]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",f.id,l.title,l.icon)}};l.autoRegister&&q.registerAction(f);return f},createAgent:function(l){l=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},l);var f=null,a={getName:function(){return l.name},
getParam:function(b){return l[b]},getId:function(){return GRUNT.toID(a.getName())},run:function(b,d){if(l.execute){var h=f=TILE5.Clock.getTime(true),k=l.translator?l.translator(b):b;l.execute.call(a,k,function(e,g){if(!l.trashOrphanedResults||h==f)d&&d(e,g,k)})}}};return a},runAgents:function(l,f,a){for(var b=0;b<l.length;b++)l[b].run(f,a)}};return q}();
TILE5.Animation=function(){function u(){if(f===0)f=setInterval(function(){var b;b=TILE5.Clock.getTime();if(!l){l=true;try{for(var d=0;d<q.length;)if(q[d].isComplete()){q[d].triggerComplete(false);q.splice(d,1);GRUNT.WaterCooler.say("animation.complete")}else{q[d].update(b);d++}}finally{l=false}}b=q.length;if(b===0){clearInterval(f);f=0}},20)}var q=[],l=false,f=0,a={DURATION:2E3,tweenValue:function(b,d,h,k,e){b=new a.Tween({startValue:b,endValue:d,tweenFn:h,complete:k,duration:e});q.push(b);return b},
tween:function(b,d,h,k,e,g){b=new a.Tween({target:b,property:d,endValue:h,tweenFn:k,duration:g,complete:e});q.push(b);return b},tweenVector:function(b,d,h,k,e,g){var o=[];if(b){var m=b.x==d,n=b.y==h;m||o.push(a.tween(b,"x",d,k,function(){(m=true)&&n&&e()},g));n||o.push(a.tween(b,"y",h,k,function(){n=true;m&&n&&e()},g))}return o},cancel:function(b){if(!l){l=true;try{for(var d=0;d<q.length;)if(!b||b(q[d])){q[d].triggerComplete(true);q.splice(d,1)}else d++}finally{l=false}}},isTweening:function(){return q.length>
0},Tween:function(b){b=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:a.DURATION,tweenFn:a.DEFAULT,complete:null,cancelOnInteract:false},b);var d=TILE5.Clock.getTime(),h=[],k=false,e=0,g=0,o={cancelOnInteract:b.cancelOnInteract,isComplete:function(){return k},triggerComplete:function(m){b.complete&&b.complete(m)},update:function(m){try{var n=b.tweenFn(m-d,e,g,b.duration);if(b.target)b.target[b.property]=n;for(var r=h.length;r--;)h[r](n,void 0);if(k=d+b.duration<=m){if(b.target)b.target[b.property]=
b.tweenFn(b.duration,e,g,b.duration);for(var s=h.length;s--;)h[s](n,true)}}catch(p){GRUNT.Log.exception(p)}},requestUpdates:function(m){h.push(m)}};e=b.target&&b.property&&b.target[b.property]?b.target[b.property]:b.startValue;if(typeof b.endValue!=="undefined")g=b.endValue-e;if(g==0)k=true;u();return o},Easing:function(){var b=1.70158;return{Linear:function(d,h,k,e){return k*d/e+h},Back:{In:function(d,h,k,e){return k*(d/=e)*d*((b+1)*d-b)+h},Out:function(d,h,k,e){return k*((d=d/e-1)*d*((b+1)*d+b)+
1)+h},InOut:function(d,h,k,e){return(d/=e/2)<1?k/2*d*d*(((b*=1.525)+1)*d-b)+h:k/2*((d-=2)*d*(((b*=1.525)+1)*d+b)+2)+h}},Bounce:{In:function(d,h,k,e){return k-a.Easing.Bounce.Out(e-d,0,k,e)+h},Out:function(d,h,k,e){return(d/=e)<1/2.75?k*7.5625*d*d+h:d<2/2.75?k*(7.5625*(d-=1.5/2.75)*d+0.75)+h:d<2.5/2.75?k*(7.5625*(d-=2.25/2.75)*d+0.9375)+h:k*(7.5625*(d-=2.625/2.75)*d+0.984375)+h},InOut:function(d,h,k,e){return d<e/2?a.Easing.Bounce.In(d*2,0,k,e)/2+h:a.Easing.Bounce.Out(d*2-e,0,k,e)/2+k/2+h}},Cubic:{In:function(d,
h,k,e){return k*(d/=e)*d*d+h},Out:function(d,h,k,e){return k*((d=d/e-1)*d*d+1)+h},InOut:function(d,h,k,e){if((d/=e/2)<1)return k/2*d*d*d+h;return k/2*((d-=2)*d*d+2)+h}},Elastic:{In:function(d,h,k,e,g,o){if(d==0)return h;if((d/=e)==1)return h+k;o||(o=e*0.3);if(!g||g<Math.abs(k)){g=k;k=o/4}else k=o/(2*Math.PI)*Math.asin(k/g);return-(g*Math.pow(2,10*(d-=1))*Math.sin((d*e-k)*2*Math.PI/o))+h},Out:function(d,h,k,e,g,o){var m;if(d==0)return h;if((d/=e)==1)return h+k;o||(o=e*0.3);if(!g||g<Math.abs(k)){g=
k;m=o/4}else m=o/(2*Math.PI)*Math.asin(k/g);return g*Math.pow(2,-10*d)*Math.sin((d*e-m)*2*Math.PI/o)+k+h},InOut:function(d,h,k,e,g,o){var m;if(d==0)return h;if((d/=e/2)==2)return h+k;o||(o=e*0.3*1.5);if(!g||g<Math.abs(k)){g=k;m=o/4}else m=o/(2*Math.PI)*Math.asin(k/g);if(d<1)return-0.5*g*Math.pow(2,10*(d-=1))*Math.sin((d*e-m)*2*Math.PI/o)+h;return g*Math.pow(2,-10*(d-=1))*Math.sin((d*e-m)*2*Math.PI/o)*0.5+k+h}},Quad:{In:function(d,h,k,e){return k*(d/=e)*d+h},Out:function(d,h,k,e){return-k*(d/=e)*(d-
2)+h},InOut:function(d,h,k,e){if((d/=e/2)<1)return k/2*d*d+h;return-k/2*(--d*(d-2)-1)+h}},Sine:{In:function(d,h,k,e){return-k*Math.cos(d/e*(Math.PI/2))+k+h},Out:function(d,h,k,e){return k*Math.sin(d/e*(Math.PI/2))+h},InOut:function(d,h,k,e){return-k/2*(Math.cos(Math.PI*d/e)-1)+h}}}}()};return GRUNT.extend(a,{DEFAULT:a.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var u={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},q=0,l={DisplayState:u,AnyDisplayState:255,ActiveDisplayStates:u.ACTIVE|u.ANIMATING,DefaultDisplayStates:u.ACTIVE|u.ANIMATING|u.PAN|u.PINCHZOOM,ViewLayer:function(f){f=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:l.DefaultDisplayStates},f);var a=null,b=f.id,d=GRUNT.extend({addToView:function(h){h.setLayer(b,d)},shouldDraw:function(h){var k=
a?a.fastDraw&&h!==u.ACTIVE:false;return(h&f.validStates)!==0&&(k?f.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:b})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:a?a.id:null})},getId:function(){return b},setId:function(h){b=h},getParent:function(){return a},setParent:function(h){a=h}},f);return d},AnimatedPathLayer:function(f){function a(g,o,m){g.fillStyle="#FFFFFF";g.strokeStyle="#222222";g.beginPath();
g.arc(m.x,m.y,4,0,Math.PI*2,false);g.stroke();g.fill()}f=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,validStates:l.ActiveDisplayStates|u.PAN|u.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},f);var b=TILE5.V.edges(f.path),d,h=null,k=0;TILE5.Animation.tweenValue(0,b.total,f.easing,function(){e.remove()},f.duration).requestUpdates(function(g,o){k=g;o&&e.remove()});var e=GRUNT.extend(new l.ViewLayer(f),{cycle:function(){for(var g=
0;g<b.accrued.length&&b.accrued[g]<k;)g++;h=null;if(g<f.path.length-1){var o=k-(g>0?b.accrued[g-1]:0),m=f.path[g],n=f.path[g+1];d=TILE5.V.theta(m,n,b.edges[g]);h=TILE5.V.pointOnEdge(m,n,d,o);if(f.autoCenter)(g=e.getParent())&&g.centerOn(h)}return h?1:0},draw:function(g,o){if(h)(f.drawIndicator?f.drawIndicator:a)(g,o,new TILE5.Vector(h.x-o.x,h.y-o.y),d)}});return e},View:function(f){function a(z,C,G,K){O=typeof G!=="undefined";L.updateOffset(t.x+z,t.y+C,G,K);r();U=u.PAN}function b(){U=u.ACTIVE;O=false;
setTimeout(r,50)}function d(z,C){A=TILE5.V.getRect(z);F=TILE5.V.getRect(C);var G=TILE5.D.getSize(A.dimensions),K=TILE5.D.getSize(F.dimensions);$=TILE5.R.getCenter(A);I=TILE5.R.getCenter(F);E=A&&G!==0?K/G:1}function h(){GRUNT.WaterCooler.say("view.scale",{id:L.id});Z=false;L.trigger("scale",E,A?g():I);U=l.DisplayState.ACTIVE;r()}function k(z,C){C.setId(z);C.setParent(L);s.push(C);s.sort(function(G,K){var S=K.zindex-G.zindex;if(S===0)S=K.created-G.created;return S})}function e(z,C,G,K,S,ea,ca){function fa(){ea&&
ea();h();E=1;P=null}Z=true;$=TILE5.V.copy(G);I=TILE5.V.copy(K);A=null;if(S)TILE5.Animation.tweenValue(0,C-z,S,fa,ca?ca:1E3).requestUpdates(function(da){P=da/(C-z);E=z+da;U=l.DisplayState.PINCHZOOM;r();L.trigger("animate")});else{E=targetScaleFactor;fa()}}function g(){var z=TILE5.D.getCenter(D),C=TILE5.V.distance([I,z]),G=TILE5.V.theta(I,z,C),K=TILE5.V.diff($,I);z=TILE5.V.pointOnEdge(I,z,G,C/E);z.x+=K.x;z.y+=K.y;return z}function o(){GRUNT.WaterCooler.say("view.idle",{id:L.id});T=true;W=0}function m(z,
C){var G=0,K=L.getDisplayState(),S=(new Date).getTime(),ea=(K&u.PINCHZOOM)!==0,ca=0;if(v||ea){z.clearRect(0,0,p.width,p.height);v=false}if(ea){TILE5.D.getCenter(D);var fa=(P?P:1)/2,da=TILE5.V.diff($,I);if(X=A?new TILE5.Vector(I.x+da.x,I.y+da.y):new TILE5.Vector(I.x-da.x*fa,I.y-da.y*fa))C=TILE5.V.offset(C,X.x,X.y)}z.save();try{M=E;if(B!==1)z.scale(B,B);else if(ea){z.translate(I.x,I.y);z.scale(E,E)}for(ca=s.length;ca--;)if(s[ca].shouldDraw(K)){var ga=s[ca].draw(z,C,D,K,L);G+=ga?ga:0}}finally{z.restore()}GRUNT.Log.trace("draw complete",
S);Y=false;return G}function n(){var z=0,C=!O&&(U===u.PINCHZOOM||U===u.PAN);V=(new Date).getTime();t.x=Math.floor(t.x);t.y=Math.floor(t.y);N&&w&&N.delays.push(V-w);if(C){TILE5.Animation.cancel(function(K){return K.cancelOnInteract});T=false;if(W!==0){clearTimeout(W);W=0}}for(C=s.length;C--;){var G=s[C].cycle(V,t,U);z+=G?G:0}if(w+Q<V){z+=m(x,t);w=V}R=0;if(J+z>0)r();else if(!T&&W===0)W=setTimeout(o,500);GRUNT.Log.trace("Completed draw cycle",V)}function r(){J++;if(!(y||R!==0)){J=0;R=setTimeout(n,0)}}
f=GRUNT.extend({id:"view_"+q++,container:"",clearOnDraw:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,inertialScroll:true,panAnimationEasing:TILE5.Animation.Easing.Sine.Out,panAnimationDuration:750,pinchZoomAnimateTrigger:400,adjustScaleFactor:null,autoSize:false},f);var s=[],p=document.getElementById(f.container),x=null,t=new TILE5.Vector,v=false,w=null,y=false,B=1,D=null,H=null,J=0,N=null,I=null,T=false,
O=false,R=0,Y=false,W=0,ba=0,X=null,V=0,aa=TILE5.Device.getConfig().targetFps,Q=0,Z=false,A=null,F=null,E=1,M=1,P=null,$=null;H=null;var U=l.DisplayState.ACTIVE;if(p){TILE5.Touch.resetTouch(p);if(f.autoSize){p.height=window.innerHeight-p.offsetTop;p.width=window.innerWidth-p.offsetLeft}try{x=p.getContext("2d");x.globalCompositeOperation=f.initialDrawMode;x.clearRect(0,0,p.width,p.height)}catch(ha){GRUNT.Log.exception(ha);throw Error("Could not initialise canvas on specified view element");}}var L=
GRUNT.extend({},f,new GRUNT.Observable,{id:f.id,deviceScaling:B,fastDraw:f.fastDraw||TILE5.Device.getConfig().requireFastDraw,animate:function(z,C,G,K,S){e(E,z,C,G,K,S)},centerOn:function(z){L.setOffset(z.x-p.width/2,z.y-p.height/2)},getDimensions:function(){if(p)return new TILE5.Dimensions(p.width,p.height)},getZoomCenter:function(){return X},getLayer:function(z){for(var C=0;C<s.length;C++)if(s[C].getId()==z)return s[C];return null},setLayer:function(z,C){for(var G=0;G<s.length;G++)if(s[G].getId()===
z){s.splice(G,1);break}C&&k(z,C);GRUNT.WaterCooler.say("layer.update",{id:z});r()},eachLayer:function(z){for(var C=0;C<s.length;C++)z(s[C])},clearBackground:function(){v=true},freeze:function(){y=true},unfreeze:function(){y=false;r()},needRepaint:function(){return Y},snapshot:function(){},getDisplayState:function(){return y?u.FROZEN:U},scale:function(z,C,G,K,S){K||(K=TILE5.D.getCenter(D));S||(S=TILE5.D.getCenter(D));L.animate(z,K,S,C,G);return L},removeLayer:function(z){a:{for(var C=s.length;C--;)if(s[C].getId()==
z){z=C;break a}z=-1}if(z>=0&&z<s.length){GRUNT.WaterCooler.say("layer.removed",{layer:s[z]});s.splice(z,1)}},getOffset:function(){return TILE5.V.copy(t)},setOffset:function(z,C){t.x=z;t.y=C},updateOffset:function(z,C,G,K){if(G){z=new TILE5.Vector(z,C);G=TILE5.Animation.tweenVector(t,z.x,z.y,G,function(){b(0,0)},K);for(K=G.length;K--;){G[K].cancelOnInteract=true;G[K].requestUpdates(function(){r();f.onAnimate&&f.onAnimate(t.x,t.y)})}}else L.setOffset(z,C)},zoom:function(z,C,G){O=false;E=C;Z=E!==1;$=
TILE5.D.getCenter(L.getDimensions());I=E>1?TILE5.V.copy(z):TILE5.D.getCenter(L.getDimensions());A=null;clearTimeout(ba);if(Z){U=l.DisplayState.PINCHZOOM;r();if(G)ba=setTimeout(function(){h();E=1},parseInt(G,10))}}});D=L.getDimensions();H=TILE5.D.getCenter(D);if(aa)Q=Math.ceil(1E3/aa);GRUNT.WaterCooler.listen("layer.remove",function(z){z.id&&L.removeLayer(z.id)});GRUNT.WaterCooler.listen("view.wake",function(z){if(!z.id||z.id===L.id)r()});B=TILE5.Device.getConfig().getScaling();L.bind("invalidate",
function(){Y=true});H=TILE5.Touch.captureTouch(p,{observable:L});L.bind("pan",a);L.bind("panEnd",b);L.bind("pinchZoom",function(z,C){d(z,C);if(Z=E!==1){U=l.DisplayState.PINCHZOOM;r()}});L.bind("pinchZoomEnd",function(z,C,G){d(z,C);if(f.adjustScaleFactor){E=f.adjustScaleFactor(E);GRUNT.Log.info("scale factor adjusted to: "+E)}if(G<f.pinchZoomAnimateTrigger){e(M,E,$,g(),TILE5.Animation.Easing.Sine.Out,function(){h();E=1},300);E=M}else{h();E=1}});L.bind("wheelZoom",function(z,C){L.zoom(z,Math.min(Math.pow(2,
Math.round(Math.log(C))),8),500)});f.inertialScroll&&H.inertiaEnable(f.panAnimationDuration,D);L.bind("inertiaPan",function(z,C){f.inertialScroll&&a(z,C,f.panAnimationEasing,f.panAnimationDuration)});L.bind("inertiaCancel",function(){O=false;r()});r();return L}};return l}();
TILE5.Tiling=function(){function u(){if(!l){l=TILE5.newCanvas(a.Config.TILESIZE,a.Config.TILESIZE);var b=l.getContext("2d");b.fillStyle="rgba(150, 150, 150, 0.01)";b.fillRect(0,0,l.width,l.height)}return l}function q(){function b(){var h=TILE5.newCanvas(32,32),k=h.getContext("2d");k.fillStyle="#BBBBBB";k.fillRect(0,0,32,32);k.fillStyle="#C3C3C3";k.fillRect(0,0,16,16);k.fillRect(16,16,16,16);return h}if(!f){f=TILE5.newCanvas(a.Config.TILESIZE,a.Config.TILESIZE);var d=f.getContext("2d");d.fillStyle=
d.createPattern(b(),"repeat");d.fillRect(0,0,f.width,f.height)}return f}TileStore=function(b){b=GRUNT.extend({tileSize:null,gridSize:25,center:new TILE5.Vector,onPopulate:null},b);if(!b.tileSize)throw Error("Cannot create TileStore with an empty tile size");var d=Array(Math.pow(b.gridSize,2)),h=TILE5.V.offset(b.center,-Math.ceil(b.gridSize>>1)),k=null,e=new TILE5.Vector,g=null,o={getGridSize:function(){return b.gridSize},getNormalizedPos:function(m,n){return TILE5.V.add(new TILE5.Vector(m,n),TILE5.V.invert(h),
e)},getTileShift:function(){return TILE5.V.copy(e)},getTile:function(m,n){return m>=0&&m<b.gridSize?d[n*b.gridSize+m]:null},setTile:function(m,n,r){d[n*b.gridSize+m]=r},populate:function(m,n){var r=GRUNT.Log.getTraceTicks(),s=0,p=b.gridSize,x=b.tileSize;new TILE5.Vector(p/2,p/2);if(m)for(var t=0;t<p;t++)for(var v=0;v<p;v++){if(!d[s]){var w=m(v,t,h,p);w.gridX=v*x-e.x;w.gridY=t*x-e.y;d[s]=w}s++}k=m;g=n;GRUNT.Log.trace("tile grid populated",r);b.onPopulate&&b.onPopulate()},getShiftDelta:function(m,n,
r,s){var p=Math.floor(b.gridSize*0.2),x=new TILE5.Vector;if(m<0||m+r>b.gridSize)x.x=m<0?-p:p;if(n<0||n+s>b.gridSize)x.y=n<0?-p:p;return x},shift:function(m,n){if(!(m.x===0&&m.y===0)){var r=GRUNT.Log.getTraceTicks(),s=Array(d.length);s.length=d.length;for(var p=0;p<b.gridSize;p++)for(var x=0;x<b.gridSize;x++)s[x*b.gridSize+p]=o.getTile(p+m.x,x+m.y);d=s;h=n?n(h,m):TILE5.V.add(h,m);e.x+=-m.x*b.tileSize;e.y+=-m.y*b.tileSize;GRUNT.Log.trace("tile storage shifted",r);o.populate(k,g)}},setOrigin:function(m,
n){if(tileOrigin)shiftOrigin(m,n);else h=TILE5.V.offset(new TILE5.Vector(m,n),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var m=d.length;m--;)if(d[m])d[m].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var m=d.length;m--;)if(d[m]){d[m].x=null;d[m].y=null}});return o};var l=null,f=null,a={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(b){return b=GRUNT.extend({gridX:0,gridY:0,size:256,dirty:false},b)},ImageTile:function(b){b=
GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},b);return new a.Tile(b)},TileGrid:function(b){function d(w,y){if(t){var B,D=[],H=new TILE5.Vector(Math.floor((w.x+r.x)*e),Math.floor((w.y+r.y)*e));tilesNeeded=false;for(var J=x;J--;)for(var N=p;N--;){B=h.getTile(N+H.x,J+H.y);var I=new TILE5.Vector(N-t.x,J-t.y);B||(n=h.getShiftDelta(H.x,H.y,p,x));D.push({tile:B,centerness:TILE5.V.absSize(I)})}D.sort(function(T,O){return O.centerness-T.centerness});o||(o=Array(D.length));for(B=D.length;B--;){o[B]=
D[B].tile;v.prepTile(o[B],y)}}}b=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},b);var h=new TileStore(GRUNT.extend({tileSize:b.tileSize,onPopulate:function(){v.dirty=true;v.wakeParent()}},b)),k=Math.round(b.tileSize/2),e=b.tileSize?1/b.tileSize:0,g=true,o=null,m=false;new TILE5.Vector;var n=new TILE5.Vector,r=new TILE5.Vector;TILE5.Device.getConfig();var s=h.getGridSize()*b.tileSize,p,x,t,v=GRUNT.extend(new TILE5.Graphics.ViewLayer(b),
{gridDimensions:new TILE5.Dimensions(s,s),dirty:false,cycle:function(w,y,B){w=0;if(n.x+n.y!==0){h.shift(n,b.shiftOrigin);r=h.getTileShift();n=new TILE5.Vector;w++}B!==TILE5.Graphics.DisplayState.PINCHZOOM&&d(y,B);return w+v.dirty?1:0},deactivate:function(){g=false},prepTile:function(){},drawTile:function(){return false},draw:function(w,y,B,D,H){if(g){var J=(new Date).getTime(),N=y.x;y=y.y;var I=true,T=H.needRepaint()||D===TILE5.Graphics.DisplayState.PANNING||D===TILE5.Graphics.DisplayState.PINCHZOOM||
TILE5.Animation.isTweening();if(!t){p=Math.ceil(B.width*e)+1;x=Math.ceil(B.height*e)+1;t=new TILE5.Vector(Math.floor((p-1)/2),Math.floor((x-1)/2))}if(o){if(b.drawGrid)w.strokeStyle="rgba(50, 50, 50, 0.3)";w.beginPath();for(B=o.length;B--;){var O=o[B];if(O){var R=O.gridX-N,Y=O.gridY-y;I=((T?false:!O.dirty)?true:v.drawTile(w,O,R,Y,D))&&I}else I=false;b.drawGrid&&w.rect(R,Y,b.tileSize,b.tileSize)}w.stroke();GRUNT.Log.trace("drawn tiles",J);I&&!m&&H.trigger("tileDrawComplete");m=I;v.dirty=false}}},getTileVirtualXY:function(w,
y,B){w=h.getNormalizedPos(w,y);w=new TILE5.Vector(w.x*b.tileSize,w.y*b.tileSize);if(B){w.x+=k;w.y+=k}return w},populate:function(w){h.populate(w,function(){})}});return v},ImageTileGrid:function(b){function d(){m.getParent().trigger("invalidate");m.dirty=true;m.wakeParent()}b=GRUNT.extend({},b);var h=u(),k=q(),e=TILE5.Graphics.DisplayState.ACTIVE,g=TILE5.Graphics.DisplayState.PAN,o=TILE5.Device.getConfig().requireFastDraw,m=GRUNT.extend(new a.TileGrid(b),{drawTile:function(n,r,s,p,x){var t=TILE5.Resources.getImage(r.url),
v=false;if(t&&t.complete&&t.width>0){n.drawImage(t,s,p);r.dirty=false;v=true}else x===g?n.drawImage(k,s,p):n.drawImage(h,s,p);return v},prepTile:function(n,r){if(n)n.dirty=true;if(n&&(!o||r===e))TILE5.Resources.getImage(n.url)||TILE5.Resources.loadImage(n.url,d)}});return m},Tiler:function(b){b=GRUNT.extend({container:"",drawCenter:false,datasources:{},tileLoadThreshold:"first"},b);var d=new TILE5.Graphics.View(GRUNT.extend({},b,{pannable:true,scalable:true,scaleDamping:true}));GRUNT.extend(d,{getTileLayer:function(){return d.getLayer("grid0")},
setTileLayer:function(h){d.setLayer("grid0",h);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(h){var k=d.getOffset();return new TILE5.Vector(h.x+k.x,h.y+k.y)},cleanup:function(){d.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");GRUNT.WaterCooler.say("view.wake",{id:d.id})}});return d}};return a}();
TILE5.Geo=function(){function u(e,g){var o=null;for(var m in h)if(g){if(m==g&&h[m][e]){o=h[m];break}}else if(h[m][e]){o=h[m];break}return o}function q(e,g,o,m){var n=0;e=e.toUpperCase();for(var r in m){var s=g[r];if(s){var p=o[r];s=p?p(e,s):e.containsWord(s)?1:0;n+=s*m[r]}}return n}var l=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],f=Math.PI/180,a=180/Math.PI,b=null,d={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},h={},k={Engine:function(e){if(!e.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var g=GRUNT.extend({remove:function(){delete h[g.id]}},e);return h[g.id]=g},Radius:function(e,g){return{distance:parseInt(e,10),uom:g}},Position:function(e,g){return{lat:parseFloat(e?e:0),lon:parseFloat(g?g:0)}},BoundingBox:function(e,g){return{min:k.P.parse(e),max:k.P.parse(g)}},Address:function(e){return e=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},e)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var e={dist2rad:function(g){return g/6371},lat2pix:function(g,o){var m=parseFloat(g)*2*Math.PI/360;m=Math.sin(m);var n=0.08181919084262157*m;return Math.log((1+m)/(1-m)*Math.pow((1-n)/(1+n),0.08181919084262157))/2/o},lon2pix:function(g,o){return parseFloat(g)/180*Math.PI/o},pix2lon:function(g,o){return e.normalizeLon(g*o*180/Math.PI)},pix2lat:function(g,o){for(var m=Math.pow(Math.E,
-g*o),n=e.mercatorUnproject(m),r=e.findRadPhi(n,m),s=0;s<12&&Math.abs(n-r)>1.0E-7;){n=r;r=e.findRadPhi(n,m);s++}return r*180/Math.PI},mercatorUnproject:function(g){return Math.PI/2-2*Math.atan(g)},findRadPhi:function(g,o){var m=0.08181919084262157*Math.sin(g);return Math.PI/2-2*Math.atan(o*Math.pow((1-m)/(1+m),0.040909595421310785))},normalizeLon:function(g){for(;g<-180;)g+=360;for(;g>180;)g-=360;return g}};return e}(),GeoSearchResult:function(e){e=GRUNT.extend({id:null,caption:"",resultType:"",data:null,
pos:null,matchWeight:0},e);return GRUNT.extend(e,{toString:function(){return e.caption+(e.matchWeight?" ("+e.matchWeight+")":"")}})},GeoSearchAgent:function(e){return TILE5.Dispatcher.createAgent(e)},GeocodingAgent:function(e){e=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(g,o){try{if(!g.reverse&&!g.freeform)address=new k.Address(g);var m=k.getEngine("geocode");if(m)m.geocode({addresses:[g.freeform?g.freeform:address],complete:function(r,s){if(o){var p=s;if(g.freeform)p=
k.rankGeocodeResponses(g.freeform,p,k.getEngine("geocode"));o(p,e)}}})}catch(n){GRUNT.Log.exception(n)}}},e);return new k.GeoSearchAgent(e)},PointOfInterest:function(e){e=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},e);if(!e.pos&&e.lat&&e.lon)e.pos=new TILE5.Geo.Position(e.lat,e.lon);return GRUNT.extend({toString:function(){return e.id+": '"+e.title+"'"}},e)},POIStorage:function(e){function g(p){p=p?p:"default";n[p]||(n[p]=[]);return n[p]}function o(p){var x=
[];for(var t in n)for(var v=0;v<n[t].length;v++)if(!p||p(n[t][v]))x.push(n[t][v]);return x}function m(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:s.id,pois:s.getPOIs()})}e=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},e);var n={},r=true,s={id:GRUNT.generateObjectID(),getPOIs:function(){return o()},getOldPOIs:function(p,x){return o(function(t){return t.group==p&&t.retrieved<x})},getVisible:function(){return r},setVisible:function(p){if(p!=r){r=p;e.visibilityChange&&e.visibilityChange()}},
findById:function(p){var x=o(function(t){return t.id==p});return x.length>0?x[0]:null},findByBounds:function(p){return o(function(x){return TILE5.Geo.P.inBounds(x.pos,p)})},addPOIs:function(p,x){if(x)n={};for(var t=0;p&&t<p.length;t++){p[t].retrieved=TILE5.Clock.getTime(true);var v=p[t];g(v.group).push(v)}},removeGroup:function(p){if(n[p]){delete n[p];m()}},update:function(p){var x=[],t=0,v=p.length>0?p[0].group:"",w=TILE5.Clock.getTime(true);for(t=0;t<p.length;t++){var y;a:{if(y=p[t])for(var B=g(y.group),
D=0;D<B.length;D++)if(B[D].id==y.id){y=B[D];break a}y=null}if(y){y.retrieved=w;y.isNew=false}else x.push(p[t])}p=s.getOldPOIs(v,w);s.addPOIs(x);for(t=0;e.onPOIAdded&&t<x.length;t++)e.onPOIAdded(x[t]);for(t=0;t<p.length;t++){e.onPOIDeleted&&e.onPOIDeleted(p[t]);v=p[t];w=g(v.group);for(y=0;y<w.length;y++)if(w[y].id==v.id){w.splice(y,1);break}}x.length+p.length>0&&m()}};return s},MapProvider:function(){var e=1,g=20;return{zoomLevel:0,checkZoomLevel:function(o){return Math.min(Math.max(o,e),g)},getCopyright:function(){},
getLogoUrl:function(){},getMapTiles:function(){},getPositionForXY:function(){return null},getZoomRange:function(){return{min:e,max:g}},setZoomRange:function(o,m){e=o;g=m}}},P:function(){var e={calcDistance:function(g,o){if(e.empty(g)||e.empty(o))return 0;var m=(o.lat-g.lat).toRad()/2,n=(o.lon-g.lon).toRad()/2;m=Math.sin(m)*Math.sin(m)+Math.cos(g.lat.toRad())*Math.cos(o.lat.toRad())*Math.sin(n)*Math.sin(n);return 6371*2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m))},copy:function(g){return g?new k.Position(g.lat,
g.lon):null},empty:function(g){return!g||g.lat===0&&g.lon===0},equal:function(g,o){return g&&o&&g.lat==o.lat&&g.lon==o.lon},almostEqual:function(g,o){return g&&o&&Math.floor(g.lat*1E3)===Math.floor(o.lat*1E3)&&Math.floor(g.lon*1E3)===Math.floor(o.lon*1E3)},inArray:function(g,o){for(var m=k.P.equal,n=o.length;n--;)if(m(g,o[n]))return true;return false},inBounds:function(g,o){var m=!(k.P.empty(g)||k.P.empty(o));return m=(m=m&&g.lat>=o.min.lat&&g.lat<=o.max.lat)&&g.lon>=o.min.lon&&g.lon<=o.max.lon},
parse:function(g){if(g)if(typeof g.lat!=="undefined")return e.copy(g);else{if(g.split)for(var o=[" ",","],m=0;m<o.length;m++){var n=g.split(o[m]);if(n.length===2)return new k.Position(n[0],n[1])}}else return new k.Position;return null},parseArray:function(g){var o=g.length,m=Array(o);for(o=o;o--;)m[o]=e.parse(g[o]);GRUNT.Log.info("parsed "+m.length+" positions");return m},fromMercatorPixels:function(g,o,m){return new k.Position(TILE5.Geo.Utilities.pix2lat(o,m),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(g,
m)))},toMercatorPixels:function(g,o){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(g.lon,o),TILE5.Geo.Utilities.lat2pix(g.lat,o))},generalize:function(g,o,m){var n=g.length,r=[],s=null;m||(m=250);m/=1E3;GRUNT.Log.info("generalizing positions, must include "+o.length+" positions");for(var p=n;p--;)if(p===0)r.unshift(g[p]);else{var x=!s||k.P.inArray(g[p],o)?m:k.P.calcDistance(s,g[p]);if(g[p]&&x>=m){r.unshift(g[p]);s=g[p]}}GRUNT.Log.info("generalized "+n+" positions into "+r.length+" positions");
return r},toString:function(g){return g?g.lat+" "+g.lon:""}};return e}(),B:function(){var e=-(Math.PI/2),g=Math.PI/2,o=-Math.PI*2,m=Math.PI*2,n={calcSize:function(r,s,p){var x=new TILE5.Vector(0,s.lat-r.lat);if(typeof p==="undefined")p=true;x.x=p&&r.lon>s.lon?360-r.lon+s.lon:s.lon-r.lon;return x},createBoundsFromCenter:function(r,s){var p=s/6371,x=r.lat*f,t=r.lon*f,v=x-p,w=x+p;if(v>e&&w<g){x=Math.asin(Math.sin(p)/Math.cos(x));p=t-x;if(p<o)p+=2*Math.PI;t=t+x;if(t>m)t-=2*Math.PI}else{v=Math.max(v,e);
w=Math.min(w,g);p=o;t=m}return new k.BoundingBox(new k.Position(v*a,p*a),new k.Position(w*a,t*a))},expand:function(r,s){return new k.BoundingBox(new k.Position(r.min.lat-s,r.min.lon-k.Utilities.normalizeLon(s)),new k.Position(r.max.lat+s,r.max.lon+k.Utilities.normalizeLon(s)))},forPositions:function(r,s){var p=null,x=TILE5.Clock.getTime();s||(s="auto");for(var t=r.length;t--;)if(p){var v=n.calcSize(p.min,r[t],false),w=n.calcSize(r[t],p.max,false);if(v.x<0)p.min.lon=r[t].lon;if(v.y<0)p.min.lat=r[t].lat;
if(w.x<0)p.max.lon=r[t].lon;if(w.y<0)p.max.lat=r[t].lat}else p=new TILE5.Geo.BoundingBox(r[t],r[t]);if(s){if(s=="auto"){t=n.calcSize(p.min,p.max);s=Math.max(t.x,t.y)*0.3}p=n.expand(p,s)}GRUNT.Log.trace("calculated bounds for "+r.length+" positions",x);return p},getCenter:function(r){var s=k.B.calcSize(r.min,r.max);return new TILE5.Geo.Position(r.min.lat+s.y/2,r.min.lon+s.x/2)},getGeoHash:function(r){var s=TILE5.Geo.GeoHash.encode(r.min.lat,r.min.lon);r=TILE5.Geo.GeoHash.encode(r.max.lat,r.max.lon);
GRUNT.Log.info("min hash = "+s+", max hash = "+r)},getZoomLevel:function(r,s){var p=n.getCenter(r),x=l[Math.min(Math.round(Math.abs(p.lat)*0.05),l.length)],t=n.calcSize(r.min,r.max);p=Math.ceil(Math.log(l[3]*s.height/t.y)/Math.log(2));x=Math.ceil(Math.log(x*s.width/t.x)/Math.log(2));return Math.min(isNaN(p)?1E3:p,isNaN(x)?1E3:x)},isEmpty:function(r){return!r||k.P.empty(r.min)||k.P.empty(r.max)},toString:function(r){return"min: "+k.P.toString(r.min)+", max: "+k.P.toString(r.max)}};return n}(),A:function(){var e=
/^(\d+).*$/,g=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(o,m){e.lastIndex=-1;if(e.test(o))for(var n=o.replace(e,"$1"),r=m.split(","),s=0;s<r.length;s++){g.lastIndex=-1;if(g.test(r[s])){var p=g.exec(r[s]);if(n>=parseInt(p[1],10)&&n<=parseInt(p[2],10))return true}else if(n==r[s])return true}return false},normalize:function(o){if(!o)return"";o=o.toUpperCase();if(!b){var m=[];for(var n in d)m.push(n);b=RegExp("(\\s)("+m.join("|")+")(\\s|$)","i")}b.lastIndex=-1;if(m=b.exec(o))o=o.replace(b,"$1"+
d[m[2]]);return o},toString:function(o){return o.streetDetails+" "+o.location}}}(),getEngine:function(e){for(var g=null,o=1;!g&&o<arguments.length;o++)g=u(e,arguments[o]);g=g?g:u(e);if(!g)throw Error("Unable to find GEO engine with "+e+" capability");return g},rankGeocodeResponses:function(e,g,o){var m=[],n=k.AddressCompareFns;if(o&&o.compareFns)n=GRUNT.extend({},n,o.compareFns);for(o=0;o<g.length;o++)m.push(new k.GeoSearchResult({caption:k.A.toString(g[o]),data:g[o],pos:g[o].pos,matchWeight:q(e,
g[o],n,k.GeocodeFieldWeights)}));m.sort(function(r,s){return s.matchWeight-r.matchWeight});return m}};return k}();
TILE5.Geo.GeoHash=function(){function u(q,l,f){if(l&f)q[0]=(q[0]+q[1])/2;else q[1]=(q[0]+q[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(q){var l=1,f=[],a=[];f[0]=-90;f[1]=90;a[0]=-180;a[1]=180;lat_err=90;lon_err=180;for(i=0;i<q.length;i++){c=q[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(l){lon_err/=2;u(a,cd,mask)}else{lat_err/=2;u(f,cd,mask)}l=!l}}f[2]=(f[0]+
f[1])/2;a[2]=(a[0]+a[1])/2;return{latitude:f,longitude:a}},encode:function(q,l,f){var a=1,b=[],d=[],h=0,k=0;f=f?f:12;geohash="";b[0]=-90;b[1]=90;d[0]=-180;for(d[1]=180;geohash.length<f;){if(a){mid=(d[0]+d[1])/2;if(l>mid){k|=BITS[h];d[0]=mid}else d[1]=mid}else{mid=(b[0]+b[1])/2;if(q>mid){k|=BITS[h];b[0]=mid}else b[1]=mid}a=!a;if(h<4)h++;else{geohash+=BASE32[k];k=h=0}}return geohash}}}();
TILE5.Geo.Search=function(){return{bestResults:function(u,q){q||(q=20);for(var l=u.length>0?u[0]:null,f=[],a=0;a<u.length;a++)if(l.matchWeight-u[a].matchWeight<=q)f.push(u[a]);else break;return f}}}();
TILE5.Geo.Routing=function(){var u={calculate:function(q){q=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},q);GRUNT.Log.info("attempting to calculate route");var l=TILE5.Geo.getEngine("route");l&&l.route(q,function(f){if(q.generalize)f.geometry=TILE5.Geo.P.generalize(f.geometry,f.getInstructionPositions());if(q.map){u.createMapOverlay(q.map,f);if(q.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+f.boundingBox);q.map.gotoBounds(f.boundingBox)}}q.success&&
q.success(f)})},createMapOverlay:function(q,l){var f=q.getDimensions();f=new TILE5.Geo.UI.RouteOverlay({data:l,width:f.width,height:f.height});q.setLayer("route",f)},parseTurnType:function(q){for(var l=u.TurnType.Unknown,f=TILE5.Geo.Routing.TurnTypeRules,a=0;a<f.length;a++){f[a].regex.lastIndex=-1;var b=f[a].regex.exec(q);if(b){l=f[a].customCheck?f[a].customCheck(q,b):f[a].turnType;break}}return l},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",
TurnLeft:"turn-left",TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(q){q=GRUNT.extend({position:null,description:"",turnType:null},q);if(!q.turnType)q.turnType=u.parseTurnType(q.description);return q},RouteData:function(q){q=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},q);if(!q.boundingBox)q.boundingBox=TILE5.Geo.B.forPositions(q.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var l=[],f=0;f<q.instructions.length;f++)q.instructions[f].position&&l.push(q.instructions[f].position);return l}},q)}};return u}();
TILE5.Geo.Routing.TurnTypeRules=function(){var u=TILE5.Geo.Routing.TurnType,q=[];q.push({regex:/continue/i,turnType:u.Continue});q.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(l,f){return/bear/i.test(f[1])?u.TurnLeftSlight:u.TurnLeft}});q.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(l,f){return/bear/i.test(f[1])?u.TurnRightSlight:u.TurnRight}});q.push({regex:/enter\s(roundabout|rotaty)/i,turnType:u.EnterRoundabout});q.push({regex:/take.*?ramp/i,turnType:u.Ramp});
q.push({regex:/take.*?exit/i,turnType:u.RampExit});q.push({regex:/make(.*?)u\-turn/i,customCheck:function(l,f){return/right/i.test(f[1])?u.UTurnRight:u.UTurnLeft}});q.push({regex:/proceed/i,turnType:u.Start});q.push({regex:/arrive/i,turnType:u.Arrive});q.push({regex:/fell\sthrough/i,turnType:u.Merge});return q}();
TILE5.Geo.UI=function(){function u(a){a=GRUNT.extend({size:12,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},a);var b=null,d=function(){var h=TILE5.newCanvas(a.size*4,a.size*4),k=h.getContext("2d"),e=new TILE5.Vector(h.width/2,h.height/2),g=a.size,o=["#FFFFFF","#333333"],m=[3,1.5];k.lineCap="round";for(var n=0;n<o.length;n++){var r=g;k.lineWidth=m[n];k.strokeStyle=o[n];k.beginPath();k.moveTo(e.x,
e.y-r);k.lineTo(e.x,e.y+r);k.moveTo(e.x-r,e.y);k.lineTo(e.x+r,e.y);k.arc(e.x,e.y,g*0.6666,0,2*Math.PI,false);k.stroke()}return h}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(h,k,e){if(!b){b=TILE5.D.getCenter(e);b=new TILE5.Vector(Math.round(b.x-d.width/2),Math.round(b.y-d.height/2))}h.drawImage(d,b.x,b.y)}})}var q=0,l={NONE:0,SINGLE:1,WATCH:2},f={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,
radsPerPixel:0},a);var b=TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),d=b.x-a.centerXY.x,h=b.y-a.centerXY.y,k=GRUNT.extend({},a.grid,{getBoundingBox:function(e,g,o,m){return new TILE5.Geo.BoundingBox(k.pixelsToPos(new TILE5.Vector(e,g+m)),k.pixelsToPos(new TILE5.Vector(e+o,g)))},getGridXYForPosition:function(e){e=TILE5.Geo.P.toMercatorPixels(e,a.radsPerPixel);return new TILE5.Vector(e.x-d,k.gridDimensions.height-(e.y-h))},getPixelDistance:function(e){e=TILE5.Geo.Utilities.dist2rad(e);
return Math.floor(e/a.radsPerPixel)},pixelsToPos:function(e){return TILE5.Geo.P.fromMercatorPixels(d+e.x,h+k.gridDimensions.height-e.y,a.radsPerPixel)}});return k},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var b=true,d=null,h=[],k=0,e=[],g=[],o=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(m,n,r,s){if(b)return null;
var p="routeAnimation"+q++;g.push(p);return new TILE5.Graphics.AnimatedPathLayer({id:p,path:h,zindex:a.zindex+1,easing:m?m:TILE5.Animation.Easing.Sine.InOut,duration:n?n:5E3,drawIndicator:r,autoCenter:s?s:false})},draw:function(m,n,r,s,p){r=0;s=a.data?a.data.geometry:null;if(b){b=false;d=null;h=[];k=0}if(s&&k<s.length){a:{p=p.getTileLayer();e=[];if(p){s=GRUNT.Log.getTraceTicks();var x,t,v,w=a.data?a.data.geometry:[],y=w.length,B=a.data?a.data.instructions:[],D=B.length,H=a.calculationsPerCycle,J=
0;for(x=k;x<y;x++){t=p.getGridXYForPosition(w[x]);if(v=!d||x===0||Math.abs(t.x-d.x)+Math.abs(t.y-d.y)>a.pixelGeneralization){h.push(t);d=t}J++;if(J>=H){k=x;break a}}k=y;GRUNT.Log.trace(y+" geometry points generalized to "+h.length+" coordinates",s);d=null;for(x=D;x--;)if(B[x].position){t=p.getGridXYForPosition(B[x].position);if(v=!d||x===0||Math.abs(t.x-d.x)+Math.abs(t.y-d.y)>a.pixelGeneralization){e.push(t);d=t}}}}r++}p=h.length;if(p>0&&(!r||a.partialDraw)){m.strokeStyle=a.strokeStyle;m.lineWidth=
a.lineWidth;m.beginPath();m.moveTo(h[p-1].x-n.x,h[p-1].y-n.y);for(p=p;p--;)m.lineTo(h[p].x-n.x,h[p].y-n.y);m.stroke();m.fillStyle=a.waypointFillStyle;for(p=e.length;p--;){m.beginPath();m.arc(e[p].x-n.x,e[p].y-n.y,2,0,Math.PI*2,false);m.stroke();m.fill()}}return r}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var m=g.length;m--;)GRUNT.WaterCooler.say("layer.remove",{id:g[m]});g=[];b=true;o.wakeParent()});return o},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,calcXY:null,
tweenIn:f.AnnotationTween,animationSpeed:null},a);var b=false,d={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return b},calcXY:function(h){d.xy=h.getGridXYForPosition(d.pos);a.calcXY&&a.calcXY(h)},draw:function(h,k,e,g,o){if(d.xy){if(d.isNew&&a.tweenIn){var m=d.xy.y;d.xy.y=k.y-20;b=true;TILE5.Animation.tween(d.xy,"y",m,a.tweenIn,function(){d.xy.y=m;b=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(h,k,new TILE5.Vector(d.xy.x-k.x,d.xy.y-k.y),e,g,o);else{h.beginPath();
h.arc(d.xy.x-k.x,d.xy.y-k.y,4,0,Math.PI*2,false);h.fill()}d.isNew=false}}};return d},ImageAnnotation:function(a){a=GRUNT.extend({imageUrl:null,animatingImageUrl:null,imageAnchor:null},a);var b=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;a.draw=function(h,k,e,g,o){if(a.animatingImageUrl&&d.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);g=a.animatingImageUrl}else g=a.imageUrl;if(k=TILE5.Resources.getImage(g)){if(k.complete&&k.width>0){b||(b=new TILE5.Vector(-k.width>>1,-k.height>>1));e=TILE5.V.offset(e,
b.x,b.y);h.drawImage(k,e.x,e.y,k.width,k.height)}}else TILE5.Resources.loadImage(g,function(){o.wakeParent()})};var d=new f.Annotation(a);return d},LocationAnnotation:function(a){a=GRUNT.extend({accuracy:null},a);var b=new Image,d=new TILE5.Vector,h=null;b.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAACIQAAAiEBPhEQkwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAG+SURBVCiRlZHNahNRAIW/O7mTTJPahLZBA1YUyriINRAE3bQIKm40m8K8gLj0CRQkO32ELHUlKbgoIu4EqeJPgtCaoBuNtjXt5LeTMZk0mbmuWiuuPLsD3+HAOUIpxf9IHjWmaUbEyWv5ROrsVULhcHP761rUfnN3Y2Otc8CIg4YT85lzuVsPP+Qupw1vpPjRCvhS9ymvV0e77x7nNj+uvADQAIQQ+uLyvdfLV9JGZi7EdEwQlqBpEJ019f0z1mo2u5Q8DMydv25lshemmj1FueZTawbs7inarqLbV7Qjab1upB9YlhWSAHLavLHZCvg1VEhN0PMU9W7At4bPVidg7CtkLLXkut+lBPD6/Ub155jJiADAHSpaLmx3ApyBQoYEUd0PBoOBkAC6+3llvda/YxgGgYL+UNHf/zN3KiExGlsvTdP0NYDkhPdWrz35ZDsBzV5wCMuQwEyFmXFeeadjzfuFQmGkAZRKpdGC/n7x+M6jqvA9Zo6FWDhlcHE+wqT93J1tP7vpOE7rrx8ALMuasPf8S12St4WmJ6bYWTUC52k8Hm8Vi0X/nwBAPp/XKpWKdF1X2LYdlMvlsToC/QYTls7DLFr/PAAAAABJRU5ErkJggg%3D%3D";
b.onload=function(){d=new TILE5.Vector(b.width/2,b.height/2)};var k=new f.Annotation(GRUNT.extend({calcXY:function(e){h=Math.floor(e.getPixelDistance(k.accuracy)*0.5)},draw:function(e,g,o,m,n,r){g=o.x-d.x;m=o.y-d.y;if(h&&k.drawAccuracyIndicator){e.fillStyle="rgba(30, 30, 30, 0.2)";e.beginPath();e.arc(o.x,o.y,h,0,Math.PI*2,false);e.fill()}b.complete&&b.width>0&&e.drawImage(b,g,m,b.width,b.height);r.trigger("invalidate")}},a));k.accuracy=a.accuracy;k.drawAccuracyIndicator=false;return k},AnnotationsOverlay:function(a){function b(g){var o=
a.map?a.map.getTileLayer():null,m=g.length;if(o)for(m=m;m--;)g[m].calcXY(o);g.sort(function(n,r){var s=r.xy.y-n.xy.y;if(s===0)s=r.xy.x-n.xy.x;return s})}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var d=[],h=false,k=[],e=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){return h?1:0},draw:function(g,o,m,n,r){h=false;g.fillStyle="rgba(255, 0, 0, 0.75)";g.globalCompositeOperation="source-over";for(m=d.length;m--;){d[m].draw(g,o,n,e,r);h=h||d[m].isAnimating()}for(m=
k.length;m--;){k[m].draw(g,o,n,e,r);h=h||k[m].isAnimating()}return h?1:0},add:function(g){k.push(g);b(k);e.wakeParent()},clear:function(g){k=[];b(k);if(g){d=[];b(d)}e.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(g){if(a.pois&&a.pois.id==g.srcID){g=g.pois;try{d=[];for(var o=0;o<g.length;o++)if(g[o].pos){var m;var n=g[o];if(n&&n.pos){var r=null;if(r=a.createAnnotationForPOI?a.createAnnotationForPOI(n):new f.Annotation({pos:n.pos})){r.isNew=n.isNew;n.isNew=false}m=r}else m=void 0;
m&&d.push(m)}b(d)}catch(s){GRUNT.Log.exception(s)}e.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){b(d);b(k);e.wakeParent()});return e},Tiler:function(a){function b(w){try{var y=new TILE5.Geo.Position(w.coords.latitude,w.coords.longitude),B=w.coords.accuracy/1E3;v.trigger("locationUpdate",w,B);if(x){if(!s){s=new f.LocationAnnotation({pos:y,accuracy:B});v.bind("tileDrawComplete",function(){s.drawAccuracyIndicator=true})}a.displayLocationAnnotation&&o.add(s);var D=TILE5.Geo.B.createBoundsFromCenter(y,
Math.max(B,1));v.gotoBounds(D)}else{s.pos=y;s.accuracy=B;s.calcXY(v.getTileLayer());v.panToPosition(y,null,TILE5.Animation.Easing.Sine.Out)}x=false}catch(H){GRUNT.Log.exception(H)}}function d(w){GRUNT.Log.info("caught location tracking error:",w)}a=GRUNT.extend({tapExtent:10,provider:null,crosshair:false,zoomLevel:0,boundsChange:null,tapPOI:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,displayLocationAnnotation:true,zoomAnimation:TILE5.Animation.Easing.Quad.Out},
a);var h=new TILE5.Vector,k=l.NONE,e=false,g=[],o=null,m=0,n=null,r=null,s=null,p=0,x=true,t=a.zoomLevel;if(!a.provider)a.provider=new TILE5.Geo.MapProvider;a.adjustScaleFactor=function(w){return Math.pow(2,(w<1?Math.floor:Math.ceil)(Math.log(w)))};var v=GRUNT.extend({},new TILE5.Tiling.Tiler(a),{pois:a.pois,annotations:null,getProvider:function(){return a.provider},setProvider:function(w){a.provider=w;e=false},getBoundingBox:function(){var w=v.getTileLayer(),y=v.getOffset(),B=v.getDimensions();if(w)return w.getBoundingBox(y.x,
y.y,B.width,B.height);return null},getCenterPosition:function(){return v.getXYPosition(TILE5.D.getCenter(v.getDimensions()))},getXYPosition:function(w){return v.getTileLayer().pixelsToPos(v.viewPixToGridPix(w))},gotoBounds:function(w,y){var B=TILE5.Geo.B.getZoomLevel(w,v.getDimensions());v.gotoPosition(TILE5.Geo.B.getCenter(w),B,y)},gotoPosition:function(w,y,B){var D=t,H=(new Date).getTime(),J=false,N=v.getBoundingBox();if(N)J=!TILE5.Geo.P.inBounds(w,N);t=y?y:t;if(!t)throw Error("Zoom level required to goto a position.");
if(a.provider)t=a.provider.checkZoomLevel(t);if(J||!e||t!==D){TILE5.Resources.resetImageLoadQueue();if(s)s.drawAccuracyIndicator=false;(y=v.getTileLayer())&&y.deactivate();TILE5.Animation.cancel();e&&v.freeze();m=H;a.provider.zoomLevel=t;a.provider.getMapTiles(v,w,function(I){if(H===m){v.setTileLayer(I);r=I.getId();v.panToPosition(w,function(){v.unfreeze();v.trigger("zoomLevelChange",t);B&&B()})}else GRUNT.Log.info("request time mismatch - ignoring update")});e=true}else v.panToPosition(w,B)},panToPosition:function(w,
y,B){var D=v.getTileLayer();if(D){w=D.getGridXYForPosition(w);D=v.getDimensions();w.x-=D.width/2;w.y-=D.height/2;if(n)n=null;v.updateOffset(w.x,w.y,B);GRUNT.WaterCooler.say("view.wake",{id:v.id});a.boundsChange&&a.boundsChange(v.getBoundingBox());y&&y(v)}},locate:function(){v.trackStart(l.SINGLE);setTimeout(v.trackCancel,1E4)},trackStart:function(w){if(navigator.geolocation){k=w?w:l.WATCH;x=true;p=navigator.geolocation.watchPosition(b,d,{enableHighAccuracy:true,timeout:1E4,maximumAge:5E3})}},trackCancel:function(){p&&
navigator.geolocation&&navigator.geolocation.clearWatch(p);k===l.WATCH&&o.clear();k=l.NONE;p=0},getZoomLevel:function(){return t},setZoomLevel:function(w){try{v.gotoPosition(v.getCenterPosition(),w)}catch(y){GRUNT.Log.exception(y)}},zoomIn:function(){v.scale(2,TILE5.Animation.Easing.Sine.Out)||v.setZoomLevel(t+1)},zoomOut:function(){v.scale(0.5,TILE5.Animation.Easing.Sine.Out)||v.setZoomLevel(t-1)},animateRoute:function(w,y,B,D){var H=v.getLayer("route");if(H)(w=H.getAnimation(w,y,B,D))&&w.addToView(v)}});
v.bind("pan",function(){k===l.SINGLE&&v.trackCancel()});v.bind("tap",function(w,y){var B=v.getTileLayer(),D=null;if(B){D=v.viewPixToGridPix(new TILE5.Vector(y.x,y.y));var H=B.pixelsToPos(D),J=B.pixelsToPos(TILE5.V.offset(D,-a.tapExtent,a.tapExtent)),N=B.pixelsToPos(TILE5.V.offset(D,a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(B.pixelsToPos(D)));D=new TILE5.Geo.BoundingBox(J,N);g=v.pois.findByBounds(D);v.trigger("geotap",w,y,H,D);a.tapPOI&&a.tapPOI(g)}});v.bind("doubleTap",
function(w,y){v.animate(2,TILE5.D.getCenter(v.getDimensions()),new TILE5.Vector(y.x,y.y),a.zoomAnimation)});v.bind("scale",function(w,y){var B=0;w=Math.sqrt(w);if(w<1)B=-(0.5/w);else if(w>1)B=w;v.gotoPosition(v.getXYPosition(y),t+Math.floor(B))});o=new TILE5.Geo.UI.AnnotationsOverlay({pois:v.pois,map:v,createAnnotationForPOI:a.createAnnotationForPOI});v.annotations=o;v.setLayer("annotations",o);a.crosshair&&v.setLayer("crosshair",new u);GRUNT.WaterCooler.listen("view.idle",function(w){if(w.id&&w.id==
v.id)if(TILE5.V.absSize(TILE5.V.diff(h,v.getOffset()))>a.boundsChangeThreshold&&a.boundsChange){h=v.getOffset();a.boundsChange(v.getBoundingBox())}});return v}};return f}();
