if(!this.JSON)this.JSON={};
(function(){function t(m){return m<10?"0"+m:m}function r(m){h.lastIndex=0;return h.test(m)?'"'+m.replace(h,function(g){var b=f[g];return typeof b==="string"?b:"\\u"+("0000"+g.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+m+'"'}function l(m,g){var b,n,o,p,s=d,q,u=g[m];if(u&&typeof u==="object"&&typeof u.toJSON==="function")u=u.toJSON(m);if(typeof k==="function")u=k.call(g,m,u);switch(typeof u){case "string":return r(u);case "number":return isFinite(u)?String(u):"null";case "boolean":case "null":return String(u);
case "object":if(!u)return"null";d+=e;q=[];if(Object.prototype.toString.apply(u)==="[object Array]"){p=u.length;for(b=0;b<p;b+=1)q[b]=l(b,u)||"null";o=q.length===0?"[]":d?"[\n"+d+q.join(",\n"+d)+"\n"+s+"]":"["+q.join(",")+"]";d=s;return o}if(k&&typeof k==="object"){p=k.length;for(b=0;b<p;b+=1){n=k[b];if(typeof n==="string")if(o=l(n,u))q.push(r(n)+(d?": ":":")+o)}}else for(n in u)if(Object.hasOwnProperty.call(u,n))if(o=l(n,u))q.push(r(n)+(d?": ":":")+o);o=q.length===0?"{}":d?"{\n"+d+q.join(",\n"+d)+
"\n"+s+"}":"{"+q.join(",")+"}";d=s;return o}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+t(this.getUTCMonth()+1)+"-"+t(this.getUTCDate())+"T"+t(this.getUTCHours())+":"+t(this.getUTCMinutes())+":"+t(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var a=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
h=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,d,e,f={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},k;if(typeof JSON.stringify!=="function")JSON.stringify=function(m,g,b){var n;e=d="";if(typeof b==="number")for(n=0;n<b;n+=1)e+=" ";else if(typeof b==="string")e=b;if((k=g)&&typeof g!=="function"&&(typeof g!=="object"||typeof g.length!=="number"))throw Error("JSON.stringify");return l("",
{"":m})};if(typeof JSON.parse!=="function")JSON.parse=function(m,g){function b(o,p){var s,q,u=o[p];if(u&&typeof u==="object")for(s in u)if(Object.hasOwnProperty.call(u,s)){q=b(u,s);if(q!==undefined)u[s]=q;else delete u[s]}return g.call(o,p,u)}var n;m=String(m);a.lastIndex=0;if(a.test(m))m=m.replace(a,function(o){return"\\u"+("0000"+o.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(m.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){n=eval("("+m+")");return typeof g==="function"?b({"":n},""):n}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(t){if(arguments.length<=1)return t;for(var r=arguments.length-2,l=0;l<=r;l++)t=t.replace(RegExp("\\{"+l+"\\}","gi"),arguments[l+1]);return t};
String.prototype.containsWord=function(t){var r="";if(t.toString)t=t.toString();for(var l=0;l<t.length;l++)r+=!/\w/.test(t[l])?"\\"+t[l]:t[l];return RegExp("(^|\\s|\\,)"+r+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var t=Object.prototype.hasOwnProperty,r=0,l={id:"GRUNT.core",extend:function(){var a=arguments[0]||{},h=1,d=arguments.length,e=false,f,k,m,g;if(typeof a==="boolean"){e=a;a=arguments[1]||{};h=2}if(typeof a!=="object"&&!l.isFunction(a))a={};if(d===h){a=this;--h}for(;h<d;h++)if((f=arguments[h])!=null)for(k in f){m=a[k];g=f[k];if(a!==g)if(e&&g&&(l.isPlainObject(g)||l.isArray(g))){m=m&&(l.isPlainObject(m)||l.isArray(m))?m:l.isArray(g)?[]:{};a[k]=l.extend(e,m,g)}else if(g!==undefined)a[k]=
g}return a},isFunction:function(a){return toString.call(a)==="[object Function]"},isArray:function(a){return toString.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||toString.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!t.call(a,"constructor")&&!t.call(a.constructor.prototype,"isPrototypeOf"))return false;var h;for(h in a);return h===undefined||t.call(a,h)},isEmptyObject:function(a){for(var h in a)return false;return true},isXmlDocument:function(a){return toString.call(a)===
"[object Document]"},contains:function(a,h){var d=a,e=arguments,f=1;if(h&&l.isArray(h)){e=h;f=0}for(f=f;f<e;f++)d=d&&typeof foo[e[f]]!=="undefined";return d},newModule:function(a){a=l.extend({id:null,requires:[],parent:null},a);if(a.parent)a=l.extend({},a.parent,a);return a},toID:function(a){return a.replace(/\s/g,"-")},generateObjectID:function(a){return(a?a:"obj")+r++}};return l}();
GRUNT.Log=function(){function t(d,e){var f,k=e&&e.length>0?e[0]:"";for(f=1;e&&f<e.length;f++)k+=" "+(l&&GRUNT.isPlainObject(e[f])?JSON.stringify(e[f]):e[f]);typeof console!=="undefined"&&console[d](k);for(f=0;f<r.length;f++)r[f].call(h,k,d)}var r=[],l=typeof JSON!=="undefined",a=window.console&&window.console.markTimeline,h={id:"GRUNT.log",getTraceTicks:function(){return a?(new Date).getTime():null},trace:function(d,e){if(a)console.markTimeline(d+(e?": "+(h.getTraceTicks()-e)+"ms":""))},debug:function(){t("debug",
arguments)},info:function(){t("info",arguments)},warn:function(){t("warn",arguments)},error:function(){t("error",arguments)},exception:function(d){h.error(arguments);for(var e in d)h.info("ERROR DETAIL: "+e+": "+d[e])},watch:function(d,e){try{e()}catch(f){h.exception(f,d)}},throwError:function(d){h.error(d);throw Error(d);},requestUpdates:function(d){r.push(d)}};return h}();
GRUNT.Data=function(){var t={determineObjectMapping:function(l){if(!l)return null;l=l.split("|");for(var a={},h=0;h<l.length;h++)a[l[h]]=h;return a},mapLineToObject:function(l,a){var h=l.split("|"),d={};for(var e in a){var f=a[e];d[e]=h.length>f?h[f]:null}return d},parse:function(l){var a=null,h=[];l=l.split("\n");for(var d=0;d<l.length;d++){var e=l[d];if(a)h.push(t.mapLineToObject(e,a));else a=t.determineObjectMapping(e)}return h}},r={supportedFormats:{JSON:{parse:function(l){return JSON.parse(l)}},
PDON:{parse:function(l){return t.parse(l)}}},parse:function(l){l=GRUNT.extend({data:"",format:"JSON"},l);if(!r.supportedFormats[l.format])throw Error("Unsupported data format: "+l.format+", cannot parse data in javascript object");try{return r.supportedFormats[l.format].parse(l.data)}catch(a){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+l.format,l.data);GRUNT.Log.exception(a)}return{}}};return r}();
GRUNT.Template=function(){var t=/\$\{(.*?)\}/ig;return{parse:function(r,l){for(var a=r,h=t.exec(a);h;){a=a.replace(h[0],GRUNT.XPath.first(h[1],l));t.lastIndex=0;h=t.exec(a)}return a}}}();
GRUNT.JSONP=function(){function t(h){var d=document.createElement("script"),e=false;d.src=h;d.async=true;d.onload=d.onreadystatechange=function(){if(!e&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){e=true;d.onload=d.onreadystatechange=null;d&&d.parentNode&&d.parentNode.removeChild(d)}};l||(l=document.getElementsByTagName("head")[0]);l.appendChild(d)}var r=0,l,a=this;return{get:function(h,d,e){h+=h.indexOf("?")>=0?"&":"?";var f="json"+ ++r;a[f]=function(k){d(k);a[f]=
null;try{delete a[f]}catch(m){}};t(h+(e?e:"callback")+"="+f);return f}}}();
GRUNT.XHR=function(){var t={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},r={JSON:["json"],PDON:["pdon.txt"]},l=["TEXT","STREAM"],a=/^(\w+:)?\/\/([^\/?#]+)/,h={XML:function(f){return f.responseXML},JSON:function(f){try{return JSON.parse(f.responseText)}catch(k){GRUNT.Log.error("Error parsing JSON data: ",f.responseText);GRUNT.Log.exception(k)}return""},PDON:function(f){return GRUNT.Data.parse({data:f.responseText,format:"PDON"})},DEFAULT:function(f){return f.responseText}},
d={CONTENT_TYPE:"Content-Type"},e=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(f){try{f=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},e.ajaxSettings,f);var k=a.exec(f.url),m=k&&(k[1]&&k[1]!==location.protocol||k[2]!==location.host);if(f.data)f.method="POST";if(f.url){k=null;if(f.xhr)k=f.xhr(f);k||(k=new XMLHttpRequest);k.open(f.method,f.url,f.async);f.data&&k.setRequestHeader("Content-Type",
f.contentType);m||k.setRequestHeader("X-Requested-With","XMLHttpRequest");k.onreadystatechange=function(){if(this.readyState===4){var b=null,n=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(n)if(f.handleResponse)f.handleResponse(this);else{var o=f,p=this.getResponseHeader(d.CONTENT_TYPE),s,q=false;for(s in t)if(p&&p.indexOf(t[s])>=0){q=true;break}p=!q;for(q=0;q<l.length;q++)p=p||l[q]==s;if(p)b:{p=s;for(var u in r)for(q=
0;q<r[u].length;q++)if(RegExp(r[u][q]+"$","i").test(o.url)){s=u;break b}s=p?p:"DEFAULT"}try{b=h[s](this,o)}catch(v){GRUNT.Log.warn("error applying processor '"+s+"' to response type, falling back to default");b=h.DEFAULT(this,o)}}else f.error&&f.error(this)}catch(x){GRUNT.Log.exception(x,"PROCESSING AJAX RESPONSE")}n&&b&&f.success&&f.success.call(this,b)}};k.send(f.method=="POST"?e.param(f.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(g){GRUNT.Log.exception(g)}},
param:function(f){var k=[],m=function(b,n){n=GRUNT.isFunction(n)?n():n;k[k.length]=encodeURIComponent(b)+"="+encodeURIComponent(n)};if(GRUNT.isArray(f))for(var g=0;g<f.length;g++)m(f[g].name,f[g].value);else for(g in f)m(g,f[g]);return k.join("&").replace(/%20/g,"+")}});return e}();
GRUNT.XPath=function(){function t(h){for(var d=null,e=0;e<r.length;e++)if(d=r[e](h))break;return d}var r=[],l=[null,function(h){return h.numberValue},function(h){return h.stringValue},function(h){return h.booleanValue},null,null,null,null,function(h){return h.singleNodeValue?h.singleNodeValue.textContent:null},function(h){return h.singleNodeValue?h.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var a={SearchResult:function(h){return{toString:function(){var d=
null;if(h){var e=null;if(h.resultType>=0&&h.resultType<l.length)e=l[h.resultType];if(e){GRUNT.Log.info("invoking match handler for result type: "+h.resultType);d=e(h)}}return d?d:""}}},first:function(h,d){var e=a.SearchResult,f;var k=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!k)k=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(d))f=d.evaluate(h,d,t,k,null);else{GRUNT.Log.warn("attempted xpath expression: "+h+" on a non-xml document");f=null}}catch(m){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
h+" on node: "+d);f=null}return new e(f)},registerResolver:function(h){r.push(h)}};return a}();GRUNT.Observable=function(){var t={},r=0,l={bind:function(a,h){t[a]||(t[a]=[]);r+=1;t[a].push({callback:h,callbackId:r});return r},trigger:function(a){var h=t[a];if(h)for(var d=h.length;d--;)h[d].callback.apply(l,Array.prototype.slice.call(arguments,1))},unbind:function(a,h){for(var d=t[a],e=0;d&&e<d.length;e++)if(d[e].callbackId===h){d.splice(e,1);break}}};return l};
GRUNT.WaterCooler=function(){var t={},r=[];return{addPipe:function(l){l("pipe.test",{});r.push(l)},listen:function(l,a){t[l]||(t[l]=[]);a&&t[l].push(a)},say:function(l,a){var h;for(h=r.length;h--;)r[h](l,a);if(t[l])for(h=t[l].length;h--;)t[l][h](a)},leave:function(){}}}();
TILE5=function(){var t={newCanvas:function(r,l){var a=document.createElement("canvas");typeof G_vmlCanvasManager!=="undefined"&&G_vmlCanvasManager.initElement(a);a.width=r?r:0;a.height=l?l:0;return a},Settings:function(){var r={};return{get:function(l){return r[l]},set:function(l,a){r[l]=a},extend:function(l){GRUNT.extend(r,l)}}}(),Clock:function(){var r=null;return{getTime:function(l){return l&&r?r:r=(new Date).getTime()}}}(),Vector:function(r,l){return{x:r?r:0,y:l?l:0}},V:function(){function r(l){if(!l||
l.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var a={edges:Array(l.length-1),accrued:Array(l.length-1),total:0},h=TILE5.V.diff,d=0;d<l.length-1;d++){var e=h(l[d],l[d+1]);a.edges[d]=Math.sqrt(e.x*e.x+e.y*e.y);a.accrued[d]=a.total+a.edges[d];a.total+=a.edges[d]}return a}return{create:function(l,a){return new t.Vector(l,a)},add:function(){for(var l=new t.Vector,a=arguments.length;a--;){l.x+=arguments[a].x;l.y+=arguments[a].y}return l},absSize:function(l){return Math.max(Math.abs(l.x),
Math.abs(l.y))},diff:function(l,a){return new t.Vector(l.x-a.x,l.y-a.y)},copy:function(l){return l?new t.Vector(l.x,l.y):null},invert:function(l){return new TILE5.Vector(-l.x,-l.y)},offset:function(l,a,h){return new TILE5.Vector(l.x+a,l.y+(h?h:a))},edges:r,distance:function(l){return r(l).total},theta:function(l,a,h){h=Math.asin((l.y-a.y)/h);return l.x>a.x?h:Math.PI-h},pointOnEdge:function(l,a,h,d){a=new TILE5.Vector(Math.cos(h)*d,Math.sin(h)*d);return new TILE5.Vector(l.x-a.x,l.y-a.y)},getRect:function(l){var a=
l.length;if(a>1)return new TILE5.Rect(Math.min(l[0].x,l[a-1].x),Math.min(l[0].y,l[a-1].y),Math.abs(l[0].x-l[a-1].x),Math.abs(l[0].y-l[a-1].y))},toString:function(l){return l.x+", "+l.y}}}(),Dimensions:function(r,l){return{width:r?r:0,height:l?l:0}},D:function(){return{getAspectRatio:function(r){return r.height!==0?r.width/r.height:1},getCenter:function(r){return new t.Vector(r.width/2,r.height/2)},getSize:function(r){return Math.sqrt(Math.pow(r.width,2)+Math.pow(r.height,2))}}}(),Rect:function(r,
l,a,h){return{origin:new t.Vector(r,l),dimensions:new t.Dimensions(a,h)}},R:function(){return{copy:function(r){return r?new t.Rect(r.origin.x,r.origin.y,r.dimensions.width,r.dimensions.height):null},getCenter:function(r){return new TILE5.Vector(r.origin.x+r.dimensions.width/2,r.origin.y+r.dimensions.height/2)}}}()};return t}();
TILE5.Device=function(){function t(){for(;g.length>0;){var n=g.shift();document.location=n}m=0}function r(n){for(var o=true,p=b.length;p--;)o=o&&n!=b[p];return o}function l(n,o){var p=[];for(var s in o)s&&p.push(s+"="+escape(o[s]));return"tile5://"+n+"/"+(p.length>0?"?"+p.join("&"):"")}function a(n,o){r(n)&&GRUNT.Log.info("would push url: "+l(n,o))}function h(n,o){if(r(n)){g.push(l(n,o));m||(m=setTimeout(t,100))}}function d(){e={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:null,requireFastDraw:false,bridgeNotify:a,targetFps:null},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true,bridgeNotify:h,targetFps:10},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:h},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:h},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,
supportsTouch:true,getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:h},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:h}};f=[e.froyo,e.android,e.ipod,e.iphone,e.ipad]}var e=null,f=[],k=null,m=0,g=[],b=["view.wake","tile.loaded"];return{getConfig:function(){e||d();if(!k){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var n=0;n<f.length;n++){var o=f[n];if(o.regex&&o.regex.test(navigator.userAgent)){k=
GRUNT.extend({},e.base,o);GRUNT.Log.info("PLATFORM DETECTED AS: "+k.name);break}}if(!k){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");k=e.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return k}}}();
TILE5.Resources=function(){var t="",r={},l=function(){function h(){var v=m[this.id];if(v&&v.image.complete&&v.image.width>0){v.loaded=true;v.hitCount=1;for(var x=n.length;x--;)if(n[x].image.src==this.src){n.splice(x,1);break}v.loadCallback&&v.loadCallback(this,false);o.push({url:this.src,created:v.requested});delete m[this.id];d()}}function d(){for(var v=TILE5.Device.getConfig().maxImageLoads;b.length>0&&(!v||n.length<v);){var x=b.shift();if(x.imageLoader){n.push(x);x.imageLoader(x,h)}}}function e(v){for(var x=
null,y=p.length;y--&&!x;)x=p[y](v);return x?x:function(C,z){C.image.onload=z;C.image.src=a.getPath(C.url);C.requested=(new Date).getTime()}}function f(){q=true;try{var v=Math.floor(o.length/2);if(v>0){o.sort(function(y,C){return y.created-C.created});for(var x=v;x--;)delete k[o[x].url];o.splice(0,v)}}finally{q=false}GRUNT.WaterCooler.say("imagecache.cleared")}var k={},m={},g=0,b=[],n=[],o=[],p=[],s=0,q=false,u={loadingImages:n,queuedImages:b,addInterceptor:function(v){p.push(v)},getCacheFullness:function(){return s},
getImage:function(v){var x=null;q||(x=k[v]);return x?x.image:null},loadImage:function(v,x){var y=k[v];if(y){y.hitCount++;y.image.complete&&x&&x(y.image,true)}else{y={url:v,image:new Image,loaded:false,imageLoader:e(v),created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:x};y.image.id="resourceLoaderImage"+g++;k[v]=y;m[y.image.id]=y;b.push(y);d()}return y},resetLoadingQueue:function(){n=[]}};setInterval(function(){for(var v=(new Date).getTime(),x=false,y=0,C=TILE5.Device.getConfig();y<
n.length;)if(v-n[y].requested>a.loadTimeout*1E3){n.splice(y,1);x=true}else y++;x&&d();if(C&&C.imageCacheMaxSize){s=o.length*a.avgImageSize/C.imageCacheMaxSize;s>=1&&f()}},1E3);return u}(),a={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(h,d){for(var e=(h?h.replace(/^.*\?/,""):"").split("&"),f=h?h.replace(/\?.*$/,"?"):"",k=0;k<e.length;k++){var m=e[k].split("=");if(!d||!d.test(m[0]))f+=e[k]+"&"}return f.replace(/\W/g,
"")},isValidCacheKey:function(h){GRUNT.Log.info("cache key = "+h);return false}}}(),addInterceptor:l.addInterceptor,getPath:function(h){return/^(file|https?|\/)/.test(h)?h:t+h},setBasePath:function(h){t=h},getImage:function(h){return l.getImage(h)},loadImage:function(h,d){l.loadImage(h,d)},resetImageLoadQueue:function(){l.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:l.loadingImages.length,queuedImageCount:l.queuedImages.length,imageCacheFullness:l.getCacheFullness()}},loadResource:function(h){h=
GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},h);var d=function(e){h.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){h.callback(e)})};h.cacheable&&r[h.filename]?d(r[h.filename]):GRUNT.XHR.ajax({url:a.getPath(h.filename),dataType:h.dataType,success:function(e){if(h.cacheable)r[h.filename]=e;d(e)},error:function(e,f,k){GRUNT.Log.error("error loading resource ["+h.filename+"], error = "+k)}})},loadSnippet:function(h,d){/\.\w+$/.test(h)||(h+=".html");a.loadResource({filename:"snippets/"+
h,callback:d,dataType:"html"})}};return a}();
TILE5.Touch=function(){function t(b,n){var o=b&&b.length>0?b[0]:null;if(o&&n&&n.length>0)return TILE5.V.diff(o,n[0]);return null}function r(b){b.preventDefault();b.stopPropagation()}function l(b){for(var n=Array(b.length),o=b.length;o--;)n[o]=new TILE5.Vector(b[o].pageX,b[o].pageY);return n}function a(b){return[new TILE5.Vector(b.pageX,b.pageY)]}var h=500,d={TAP:0,MOVE:1,PINCHZOOM:2},e=7,f=0,k=0,m={TouchHelper:function(b){function n(A,F,G,Q){var H=Math.asin((A.y-F.y)/G);G=Math.min(Math.floor(G*(1E3/
Q)),500);H=F.x>A.x?H:Math.PI-H;A=new TILE5.Vector(Math.cos(H)*-G,Math.sin(H)*G);p("moveInertia",A.x,A.y)}function o(A){for(var F=[],G=b.element?-b.element.offsetLeft:0,Q=b.element?-b.element.offsetTop:0,H=A.length;H--;)F.push(TILE5.V.offset(A[H],G,Q));return F}function p(){b.observable&&b.observable.trigger.apply(null,arguments)}function s(A){if(A.target&&A.target===b.element){z=C?l(A.touches):a(A);E=new TILE5.Vector;N=new TILE5.Vector;R=true;x=false;S=TILE5.Clock.getTime();C&&r(A);p("cancelInertia");
U.current=S;if(A=z.length>0?z[0]:null){p("touchStart",A.x,A.y);if(U.current-U.last<$.THRESHOLD_DOUBLETAP)if((A=L?TILE5.V.diff(z[0],L[0]):null)&&Math.abs(A.x)<b.maxDistDoubleTap&&Math.abs(A.y)<b.maxDistDoubleTap)x=true;O=d.TAP;L=[].concat(z)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function q(A){if(A.target&&A.target===b.element){P=(C?l(A.touches):a(A))[0];if(R)try{C&&r(A);var F=C?l(A.touches):a(A);A=0;if(F.length>1){if(z.length===1)z=[].concat(F);A=TILE5.V.distance(z)-
TILE5.V.distance(F)}if(O===d.TAP){var G=t(F,z);if(G&&(Math.abs(G.x)>=e||Math.abs(G.y)>=e))O=d.MOVE}if(O!==d.TAP)if(!A||Math.abs(A)<b.pinchZoomThreshold){if(E=t(F,L)){N.x-=E.x;N.y-=E.y;I.x-=E.x;I.y-=E.y}if(TILE5.V.absSize(I)>b.panEventThreshhold){p("move",I.x,I.y);I=TILE5.V.create()}O=d.MOVE}else{p("pinchZoom",o(z),o(F));O=d.PINCHZOOM}L=[].concat(F)}catch(Q){GRUNT.Log.exception(Q)}}}function u(A){if(A.target&&A.target===b.element)try{C&&r(A);var F=TILE5.Clock.getTime();U.last=U.current;if(O===d.TAP)y||
(y=setTimeout(function(){y=0;var X=x?"doubleTap":"tap",V=z[0],ca=null;if(b.element)ca=TILE5.V.offset(V,-b.element.offsetLeft,-b.element.offsetTop);p(X,V,ca)},$.THRESHOLD_DOUBLETAP+50));else if(O==d.MOVE){p("moveEnd",N.x,N.y);var G,Q,H=(C?l(A.changedTouches):a(A))[0];if(C){G=F-S;if(G<h){Q=TILE5.V.distance([z[0],H]);Q>b.inertiaTrigger&&n(z[0],H,Q,G)}}else{P=H;var Y=setInterval(function(){G=(new Date).getTime()-F;Q=TILE5.V.distance([H,P]);if(G<h&&Q>b.inertiaTrigger){clearInterval(Y);n(H,P,Q,G)}else G>
h&&clearInterval(Y)},5)}}else O==d.PINCHZOOM&&p("pinchZoomEnd",o(z),o(L))}catch(aa){GRUNT.Log.exception(aa)}R=false}function v(A){A=new TILE5.Vector(A.wheelDeltaX,A.wheelDeltaY);var F=A.y!==0?Math.abs(A.y/120):0;if(P&&F!==0){var G=TILE5.V.offset(P,-b.element.offsetLeft,-b.element.offsetTop);p("wheelZoom",G,Math.pow(2,A.y>0?F:-F))}}b=GRUNT.extend({element:null,observable:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,
pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},b);var x=false,y=0,C=TILE5.Device.getConfig().supportsTouch,z=null,L=null,E=null,N=null,I=new TILE5.Vector,O=null,R=false,S=0,T=[],P=null,U={current:0,last:0},K=TILE5.Device.getConfig(),$={supportsTouch:C,THRESHOLD_DOUBLETAP:300,addListeners:function(A){T.push(A)},decoupleListeners:function(A){for(var F=0;A&&F<T.length;F++)if(T[F].listenerId===A){T.splice(F,1);GRUNT.Log.info("successfully decoupled touch listener: "+
A);break}},release:function(){K.eventTarget.removeEventListener(K.supportsTouch?"touchstart":"mousedown",s,false);K.eventTarget.removeEventListener(K.supportsTouch?"touchmove":"mousemove",q,false);K.eventTarget.removeEventListener(K.supportsTouch?"touchend":"mouseup",u,false);K.supportsTouch||K.eventTarget.removeEventListener("mousewheel",v,false)}};K.eventTarget.addEventListener(K.supportsTouch?"touchstart":"mousedown",s,false);K.eventTarget.addEventListener(K.supportsTouch?"touchmove":"mousemove",
q,false);K.eventTarget.addEventListener(K.supportsTouch?"touchend":"mouseup",u,false);K.supportsTouch||K.eventTarget.addEventListener("mousewheel",v,false);return $}},g=[];return{captureTouch:function(b,n){try{if(!b)throw Error("Unable to capture touch of null element");if(!b.id)b.id="touchable_"+f++;var o=g[b.id];if(!o){o=m.TouchHelper(GRUNT.extend({element:b},n));g[b.id]=o;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+o.supportsTouch)}n.listenerId&&o.decoupleListeners(n.listenerId);n.listenerId=
++k;o.addListeners(n)}catch(p){GRUNT.Log.exception(p)}},resetTouch:function(b){if(b&&b.id&&g[b.id]){g[b.id].release();delete g[b.id]}}}}();if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(t){return this.each(function(){TILE5.Touch.captureTouch(this,t)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(t){t.preventDefault()})}}
TILE5.Dispatcher=function(){var t=[],r={execute:function(l){var a=r.findAction(l);GRUNT.Log.info("looking for action id: "+l+", found: "+a);if(a){var h=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+l,function(){a.execute(h)})}},findAction:function(l){for(var a=t.length;a--;)if(t[a].id==l)return t[a];return null},getRegisteredActions:function(){return[].concat(t)},getRegisteredActionIds:function(){for(var l=[],a=t.length;a--;)t[a].id&&l.push(t[a].id);return l},registerAction:function(l){l&&
l.id&&t.push(l)},Action:function(l){l=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},l);var a={id:l.id,execute:function(){l.execute&&l.execute.apply(this,arguments)},getParam:function(h){return l[h]?l[h]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",a.id,l.title,l.icon)}};l.autoRegister&&r.registerAction(a);return a},createAgent:function(l){l=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},l);var a=null,h={getName:function(){return l.name},
getParam:function(d){return l[d]},getId:function(){return GRUNT.toID(h.getName())},run:function(d,e){if(l.execute){var f=a=TILE5.Clock.getTime(true),k=l.translator?l.translator(d):d;l.execute.call(h,k,function(m,g){if(!l.trashOrphanedResults||f==a)e&&e(m,g,k)})}}};return h},runAgents:function(l,a,h){for(var d=0;d<l.length;d++)l[d].run(a,h)}};return r}();
TILE5.Animation=function(){function t(){if(a===0)a=setInterval(function(){var d;d=TILE5.Clock.getTime();if(!l){l=true;try{for(var e=0;e<r.length;)if(r[e].isComplete()){r[e].triggerComplete(false);r.splice(e,1);GRUNT.WaterCooler.say("animation.complete")}else{r[e].update(d);e++}}finally{l=false}}d=r.length;if(d===0){clearInterval(a);a=0}},20)}var r=[],l=false,a=0,h={DURATION:2E3,tweenValue:function(d,e,f,k,m){d=new h.Tween({startValue:d,endValue:e,tweenFn:f,complete:k,duration:m});r.push(d);return d},
tween:function(d,e,f,k,m,g){d=new h.Tween({target:d,property:e,endValue:f,tweenFn:k,duration:g,complete:m});r.push(d);return d},tweenVector:function(d,e,f,k,m,g){var b=[];if(d){var n=d.x==e,o=d.y==f;n||b.push(h.tween(d,"x",e,k,function(){(n=true)&&o&&m()},g));o||b.push(h.tween(d,"y",f,k,function(){o=true;n&&o&&m()},g))}return b},cancel:function(d){if(!l){l=true;try{for(var e=0;e<r.length;)if(!d||d(r[e])){r[e].triggerComplete(true);r.splice(e,1)}else e++}finally{l=false}}},isTweening:function(){return r.length>
0},Tween:function(d){d=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:h.DURATION,tweenFn:h.DEFAULT,complete:null,cancelOnInteract:false},d);var e=TILE5.Clock.getTime(),f=[],k=false,m=0,g=0,b={cancelOnInteract:d.cancelOnInteract,isComplete:function(){return k},triggerComplete:function(n){d.complete&&d.complete(n)},update:function(n){try{var o=d.tweenFn(n-e,m,g,d.duration);if(d.target)d.target[d.property]=o;for(var p=f.length;p--;)f[p](o,void 0);if(k=e+d.duration<=n){if(d.target)d.target[d.property]=
d.tweenFn(d.duration,m,g,d.duration);for(var s=f.length;s--;)f[s](o,true)}}catch(q){GRUNT.Log.exception(q)}},requestUpdates:function(n){f.push(n)}};m=d.target&&d.property&&d.target[d.property]?d.target[d.property]:d.startValue;if(typeof d.endValue!=="undefined")g=d.endValue-m;if(g==0)k=true;t();return b},Easing:function(){var d=1.70158;return{Linear:function(e,f,k,m){return k*e/m+f},Back:{In:function(e,f,k,m){return k*(e/=m)*e*((d+1)*e-d)+f},Out:function(e,f,k,m){return k*((e=e/m-1)*e*((d+1)*e+d)+
1)+f},InOut:function(e,f,k,m){return(e/=m/2)<1?k/2*e*e*(((d*=1.525)+1)*e-d)+f:k/2*((e-=2)*e*(((d*=1.525)+1)*e+d)+2)+f}},Bounce:{In:function(e,f,k,m){return k-h.Easing.Bounce.Out(m-e,0,k,m)+f},Out:function(e,f,k,m){return(e/=m)<1/2.75?k*7.5625*e*e+f:e<2/2.75?k*(7.5625*(e-=1.5/2.75)*e+0.75)+f:e<2.5/2.75?k*(7.5625*(e-=2.25/2.75)*e+0.9375)+f:k*(7.5625*(e-=2.625/2.75)*e+0.984375)+f},InOut:function(e,f,k,m){return e<m/2?h.Easing.Bounce.In(e*2,0,k,m)/2+f:h.Easing.Bounce.Out(e*2-m,0,k,m)/2+k/2+f}},Cubic:{In:function(e,
f,k,m){return k*(e/=m)*e*e+f},Out:function(e,f,k,m){return k*((e=e/m-1)*e*e+1)+f},InOut:function(e,f,k,m){if((e/=m/2)<1)return k/2*e*e*e+f;return k/2*((e-=2)*e*e+2)+f}},Elastic:{In:function(e,f,k,m,g,b){if(e==0)return f;if((e/=m)==1)return f+k;b||(b=m*0.3);if(!g||g<Math.abs(k)){g=k;k=b/4}else k=b/(2*Math.PI)*Math.asin(k/g);return-(g*Math.pow(2,10*(e-=1))*Math.sin((e*m-k)*2*Math.PI/b))+f},Out:function(e,f,k,m,g,b){var n;if(e==0)return f;if((e/=m)==1)return f+k;b||(b=m*0.3);if(!g||g<Math.abs(k)){g=
k;n=b/4}else n=b/(2*Math.PI)*Math.asin(k/g);return g*Math.pow(2,-10*e)*Math.sin((e*m-n)*2*Math.PI/b)+k+f},InOut:function(e,f,k,m,g,b){var n;if(e==0)return f;if((e/=m/2)==2)return f+k;b||(b=m*0.3*1.5);if(!g||g<Math.abs(k)){g=k;n=b/4}else n=b/(2*Math.PI)*Math.asin(k/g);if(e<1)return-0.5*g*Math.pow(2,10*(e-=1))*Math.sin((e*m-n)*2*Math.PI/b)+f;return g*Math.pow(2,-10*(e-=1))*Math.sin((e*m-n)*2*Math.PI/b)*0.5+k+f}},Quad:{In:function(e,f,k,m){return k*(e/=m)*e+f},Out:function(e,f,k,m){return-k*(e/=m)*(e-
2)+f},InOut:function(e,f,k,m){if((e/=m/2)<1)return k/2*e*e+f;return-k/2*(--e*(e-2)-1)+f}},Sine:{In:function(e,f,k,m){return-k*Math.cos(e/m*(Math.PI/2))+k+f},Out:function(e,f,k,m){return k*Math.sin(e/m*(Math.PI/2))+f},InOut:function(e,f,k,m){return-k/2*(Math.cos(Math.PI*e/m)-1)+f}}}}()};return GRUNT.extend(h,{DEFAULT:h.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var t={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},r=0,l={DisplayState:t,AnyDisplayState:255,ActiveDisplayStates:t.ACTIVE|t.ANIMATING,DefaultDisplayStates:t.ACTIVE|t.ANIMATING|t.PAN|t.PINCHZOOM,ViewLayer:function(a){a=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:l.DefaultDisplayStates},a);var h=null,d=a.id,e=GRUNT.extend({addToView:function(f){f.setLayer(d,e)},shouldDraw:function(f){var k=
h?h.fastDraw&&f!==t.ACTIVE:false;return(f&a.validStates)!==0&&(k?a.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:d})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:h?h.id:null})},getId:function(){return d},setId:function(f){d=f},getParent:function(){return h},setParent:function(f){h=f}},a);return e},AnimatedPathLayer:function(a){function h(g,b,n){g.fillStyle="#FFFFFF";g.strokeStyle="#222222";g.beginPath();
g.arc(n.x,n.y,4,0,Math.PI*2,false);g.stroke();g.fill()}a=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,validStates:l.ActiveDisplayStates|t.PAN|t.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},a);var d=TILE5.V.edges(a.path),e,f=null,k=0;TILE5.Animation.tweenValue(0,d.total,a.easing,function(){m.remove()},a.duration).requestUpdates(function(g,b){k=g;b&&m.remove()});var m=GRUNT.extend(new l.ViewLayer(a),{cycle:function(){for(var g=
0;g<d.accrued.length&&d.accrued[g]<k;)g++;f=null;if(g<a.path.length-1){var b=k-(g>0?d.accrued[g-1]:0),n=a.path[g],o=a.path[g+1];e=TILE5.V.theta(n,o,d.edges[g]);f=TILE5.V.pointOnEdge(n,o,e,b);if(a.autoCenter)(g=m.getParent())&&g.centerOn(f)}return f?1:0},draw:function(g,b){if(f)(a.drawIndicator?a.drawIndicator:h)(g,b,new TILE5.Vector(f.x-b.x,f.y-b.y),e)}});return m},FPSLayer:function(a){a=GRUNT.extend({zindex:1E3,scalePosition:false},a);var h=null,d=GRUNT.extend(new l.ViewLayer(a),{delays:[],draw:function(e,
f,k){e.font="bold 8pt Arial";e.textAlign="right";e.fillStyle="rgba(0, 0, 0, 0.8)";e.fillText((h?h:"?")+" fps",k.width-20,20)}});setInterval(function(){for(var e=0,f=d.delays.length,k=f;k--;)e+=d.delays[k];if(f!==0)h=Math.floor(1E3/(e/f))},1E3);return d},ResourceStatsLayer:function(a){a=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:t.ACTIVE|t.PAN},a);return GRUNT.extend(new l.ViewLayer(a),{fps:null,draw:function(h){var d=TILE5.Resources.getStats(),e=a.indicatorSize,f=10,
k;if(d.imageCacheFullness){h.strokeStyle="rgba(0, 0, 255, 1)";h.beginPath();h.arc(15,15,5,0,Math.PI*2*d.imageCacheFullness,false);h.stroke();f=30}if(d.imageLoadingCount>=0){h.fillStyle="rgba(0, 255, 0, 0.7)";for(k=d.imageLoadingCount;k--;)h.fillRect(f+k*(e+2),10,e,e)}if(d.queuedImageCount>=0){h.fillStyle="rgba(255, 0, 0, 0.7)";for(k=d.queuedImageCount;k--;)h.fillRect(f+k*(e+2),10+e+2,e,e)}}})},LoadingLayer:function(a){GRUNT.extend({},a)},View:function(a){function h(w,B,D){R=typeof D!=="undefined";
J.updateOffset(u.x+w,u.y+B,D);o();V=t.PAN}function d(){V=t.ACTIVE;R=false;setTimeout(o,50)}function e(w,B){G=TILE5.V.getRect(w);Q=TILE5.V.getRect(B);var D=TILE5.D.getSize(G.dimensions),M=TILE5.D.getSize(Q.dimensions);X=TILE5.R.getCenter(G);I=TILE5.R.getCenter(Q);H=G&&D!==0?M/D:1}function f(){GRUNT.WaterCooler.say("view.scale",{id:J.id});F=false;J.trigger("scale",H,G?m():I);V=l.DisplayState.ACTIVE;H=1;o()}function k(w,B){B.setId(w);B.setParent(J);p.push(B);p.sort(function(D,M){var W=M.zindex-D.zindex;
if(W===0)W=M.created-D.created;return W})}function m(){var w=TILE5.D.getCenter(z),B=TILE5.V.distance([I,w]),D=TILE5.V.theta(I,w,B),M=TILE5.V.diff(X,I);w=TILE5.V.pointOnEdge(I,w,D,B/H);w.x+=M.x;w.y+=M.y;return w}function g(){GRUNT.WaterCooler.say("view.idle",{id:J.id});O=true;T=0}function b(w,B){var D=0,M=J.getDisplayState(),W=(new Date).getTime(),ba=(M&t.PINCHZOOM)!==0,Z=0;if(v||ba){w.clearRect(0,0,s.width,s.height);v=false}if(ba){TILE5.D.getCenter(z);var ea=(Y?Y:1)/2,da=TILE5.V.diff(X,I);if(U=G?
new TILE5.Vector(I.x+da.x,I.y+da.y):new TILE5.Vector(I.x-da.x*ea,I.y-da.y*ea))B=TILE5.V.offset(B,U.x,U.y)}w.save();try{if(C!==1)w.scale(C,C);else if(ba){w.translate(I.x,I.y);w.scale(H,H)}for(Z=p.length;Z--;)if(p[Z].shouldDraw(M)){var fa=p[Z].draw(w,B,z,M,J);D+=fa?fa:0}}finally{w.restore()}GRUNT.Log.trace("draw complete",W);return D}function n(){var w=0,B=!R&&(V===t.PINCHZOOM||V===t.PAN);K=(new Date).getTime();u.x=Math.floor(u.x);u.y=Math.floor(u.y);N&&x&&N.delays.push(K-x);if(B){TILE5.Animation.cancel(function(M){return M.cancelOnInteract});
O=false;if(T!==0){clearTimeout(T);T=0}}for(B=p.length;B--;){var D=p[B].cycle(K,u,V);w+=D?D:0}if(x+A<K){w+=b(q,u);x=K}S=0;if(E+w>0)o();else if(!O&&T===0)T=setTimeout(g,500);GRUNT.Log.trace("Completed draw cycle",K)}function o(){E++;if(!(y||S!==0)){E=0;S=setTimeout(n,0)}}a=GRUNT.extend({id:"view_"+r++,container:"",clearOnDraw:false,displayFPS:false,displayResourceStats:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,
autoSize:false},a);var p=[],s=document.getElementById(a.container),q=null,u=new TILE5.Vector,v=false,x=null,y=false,C=1,z=null,L=null,E=0,N=null,I=null,O=false,R=false,S=0,T=0,P=0,U=null,K=0,$=TILE5.Device.getConfig().targetFps,A=0,F=false,G=null,Q=null,H=1,Y=null,aa=null,X=null,V=l.DisplayState.ACTIVE;if(s){TILE5.Touch.resetTouch(s);if(a.autoSize){s.height=window.innerHeight-s.offsetTop;s.width=window.innerWidth-s.offsetLeft}try{q=s.getContext("2d");q.globalCompositeOperation=a.initialDrawMode;q.clearRect(0,
0,s.width,s.height)}catch(ca){GRUNT.Log.exception(ca);throw Error("Could not initialise canvas on specified view element");}}var J=GRUNT.extend({},a,new GRUNT.Observable,{id:a.id,deviceScaling:C,fastDraw:a.fastDraw||TILE5.Device.getConfig().requireFastDraw,animate:function(w,B,D,M,W){function ba(){W&&W();f();H=1;Y=null}F=true;X=TILE5.V.copy(B);I=TILE5.V.copy(D);G=null;if(M){aa=H;TILE5.Animation.tweenValue(0,w-aa,M,ba,1E3).requestUpdates(function(Z){Y=Z/(w-aa);H=aa+Z;V=l.DisplayState.PINCHZOOM;o();
J.trigger("animate")})}else{H=w;ba()}},centerOn:function(w){J.setOffset(w.x-s.width/2,w.y-s.height/2)},getDimensions:function(){if(s)return new TILE5.Dimensions(s.width,s.height)},getZoomCenter:function(){return U},getLayer:function(w){for(var B=0;B<p.length;B++)if(p[B].getId()==w)return p[B];return null},setLayer:function(w,B){for(var D=0;D<p.length;D++)if(p[D].getId()===w){p.splice(D,1);break}B&&k(w,B);GRUNT.WaterCooler.say("layer.update",{id:w});o()},eachLayer:function(w){for(var B=0;B<p.length;B++)w(p[B])},
clearBackground:function(){v=true},freeze:function(){y=true},unfreeze:function(){y=false;o()},snapshot:function(){},getDisplayState:function(){return y?t.FROZEN:V},scale:function(w,B,D,M,W){M||(M=TILE5.D.getCenter(z));W||(W=TILE5.D.getCenter(z));J.animate(w,M,W,B,D);return J},removeLayer:function(w){a:{for(var B=p.length;B--;)if(p[B].getId()==w){w=B;break a}w=-1}if(w>=0&&w<p.length){GRUNT.WaterCooler.say("layer.removed",{layer:p[w]});p.splice(w,1)}},getOffset:function(){return TILE5.V.copy(u)},setOffset:function(w,
B){u.x=w;u.y=B},updateOffset:function(w,B,D){if(D){w=new TILE5.Vector(w,B);animating=true;D=TILE5.Animation.tweenVector(u,w.x,w.y,D,function(){animating=false;d(0,0)});for(w=D.length;w--;){D[w].cancelOnInteract=true;D[w].requestUpdates(function(){o();a.onAnimate&&a.onAnimate(u.x,u.y)})}}else J.setOffset(w,B)},zoom:function(w,B,D){R=false;H=B;F=H!==1;X=TILE5.D.getCenter(J.getDimensions());I=H>1?TILE5.V.copy(w):TILE5.D.getCenter(J.getDimensions());G=null;clearTimeout(P);if(F){V=l.DisplayState.PINCHZOOM;
o();if(D)P=setTimeout(f,parseInt(D,10))}}});z=J.getDimensions();L=TILE5.D.getCenter(z);if($)A=Math.ceil(1E3/$);GRUNT.WaterCooler.listen("layer.remove",function(w){w.id&&J.removeLayer(w.id)});GRUNT.WaterCooler.listen("view.wake",function(w){if(!w.id||w.id===J.id)o()});C=TILE5.Device.getConfig().getScaling();if(a.displayFPS){N=new l.FPSLayer;J.setLayer("fps",N)}a.displayResourceStats&&J.setLayer("resourceStats",new l.ResourceStatsLayer);TILE5.Touch.captureTouch(s,{observable:J});J.bind("move",h);J.bind("moveEnd",
d);J.bind("pinchZoom",function(w,B){e(w,B);if(F=H!==1){V=l.DisplayState.PINCHZOOM;o()}});J.bind("pinchZoomEnd",function(w,B){e(w,B);f();H=1});J.bind("wheelZoom",function(w,B){J.zoom(w,Math.min(Math.pow(2,Math.round(Math.log(B))),8),500)});J.bind("moveInertia",function(w,B){h(w,B,TILE5.Animation.Easing.Sine.Out)});J.bind("cancelInertia",function(){R=false;o()});o();return J}};return l}();
TILE5.Tiling=function(){function t(){if(!l){l=TILE5.newCanvas(h.Config.TILESIZE,h.Config.TILESIZE);var d=l.getContext("2d");d.fillStyle="rgba(150, 150, 150, 0.025)";d.fillRect(0,0,l.width,l.height)}return l}function r(){function d(){var f=TILE5.newCanvas(32,32),k=f.getContext("2d");k.fillStyle="#BBBBBB";k.fillRect(0,0,32,32);k.fillStyle="#C3C3C3";k.fillRect(0,0,16,16);k.fillRect(16,16,16,16);return f}if(!a){a=TILE5.newCanvas(h.Config.TILESIZE,h.Config.TILESIZE);var e=a.getContext("2d");e.fillStyle=
e.createPattern(d(),"repeat");e.fillRect(0,0,a.width,a.height)}return a}TileStore=function(d){d=GRUNT.extend({tileSize:null,gridSize:25,center:new TILE5.Vector,onPopulate:null},d);if(!d.tileSize)throw Error("Cannot create TileStore with an empty tile size");var e=Array(Math.pow(d.gridSize,2)),f=TILE5.V.offset(d.center,-Math.ceil(d.gridSize>>1)),k=null,m=new TILE5.Vector,g=null,b={getGridSize:function(){return d.gridSize},getNormalizedPos:function(n,o){return TILE5.V.add(new TILE5.Vector(n,o),TILE5.V.invert(f),
m)},getTileShift:function(){return TILE5.V.copy(m)},getTile:function(n,o){return n>=0&&n<d.gridSize?e[o*d.gridSize+n]:null},setTile:function(n,o,p){e[o*d.gridSize+n]=p},populate:function(n,o){var p=GRUNT.Log.getTraceTicks(),s=0,q=d.gridSize,u=d.tileSize;new TILE5.Vector(q/2,q/2);if(n)for(var v=0;v<q;v++)for(var x=0;x<q;x++){if(!e[s]){var y=n(x,v,f,q);y.gridX=x*u-m.x;y.gridY=v*u-m.y;e[s]=y}s++}k=n;g=o;GRUNT.Log.trace("tile grid populated",p);d.onPopulate&&d.onPopulate()},getShiftDelta:function(n,o,
p,s){var q=Math.floor(d.gridSize*0.2),u=new TILE5.Vector;if(n<0||n+p>d.gridSize)u.x=n<0?-q:q;if(o<0||o+s>d.gridSize)u.y=o<0?-q:q;return u},shift:function(n,o){if(!(n.x===0&&n.y===0)){var p=GRUNT.Log.getTraceTicks();GRUNT.Log.info("need to shift tile store grid, "+n.x+" cols and "+n.y+" rows.");var s=Array(e.length);s.length=e.length;for(var q=0;q<d.gridSize;q++)for(var u=0;u<d.gridSize;u++)s[u*d.gridSize+q]=b.getTile(q+n.x,u+n.y);e=s;f=o?o(f,n):TILE5.V.add(f,n);m.x+=-n.x*d.tileSize;m.y+=-n.y*d.tileSize;
GRUNT.Log.trace("tile storage shifted",p);b.populate(k,g)}},setOrigin:function(n,o){if(tileOrigin)shiftOrigin(n,o);else f=TILE5.V.offset(new TILE5.Vector(n,o),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var n=e.length;n--;)if(e[n])e[n].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var n=e.length;n--;)if(e[n]){e[n].x=null;e[n].y=null}});return b};var l=null,a=null,h={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(d){return d=
GRUNT.extend({x:0,y:0,gridX:0,gridY:0,size:256},d)},ImageTile:function(d){d=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},d);return new h.Tile(d)},TileGrid:function(d){function e(z,L){if(y){var E,N=[],I=new TILE5.Vector(Math.floor((z.x+q.x)*m),Math.floor((z.y+q.y)*m));tilesNeeded=false;for(var O=x;O--;)for(var R=v;R--;){E=f.getTile(R+I.x,O+I.y);var S=new TILE5.Vector(R-y.x,O-y.y);E||(s=f.getShiftDelta(I.x,I.y,v,x));N.push({tile:E,centerness:TILE5.V.absSize(S)})}N.sort(function(T,P){return P.centerness-
T.centerness});n||(n=Array(N.length));for(E=N.length;E--;){n[E]=N[E].tile;C.prepTile(n[E],L)}}}d=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},d);var f=new TileStore(GRUNT.extend({tileSize:d.tileSize,onPopulate:function(){g=true;C.wakeParent()}},d)),k=Math.round(d.tileSize/2),m=d.tileSize?1/d.tileSize:0,g=false,b=true,n=null,o=false,p=false;new TILE5.Vector;var s=new TILE5.Vector,q=new TILE5.Vector;TILE5.Device.getConfig();
var u=f.getGridSize()*d.tileSize,v,x,y,C=GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{gridDimensions:new TILE5.Dimensions(u,u),cycle:function(z,L,E){z=0;if(s.x+s.y!==0){f.shift(s,d.shiftOrigin);q=f.getTileShift();s=new TILE5.Vector;z++}E!==TILE5.Graphics.DisplayState.PINCHZOOM&&e(L,E);return z+g?1:0},deactivate:function(){b=false},prepTile:function(){},drawTile:function(){return false},draw:function(z,L,E,N,I){if(b){var O=(new Date).getTime(),R=L.x;L=L.y;var S=true,T=o||N===TILE5.Graphics.DisplayState.PINCHZOOM||
TILE5.Animation.isTweening();if(!y){v=Math.ceil(E.width*m)+1;x=Math.ceil(E.height*m)+1;y=new TILE5.Vector(Math.floor((v-1)/2),Math.floor((x-1)/2))}if(n){if(d.drawGrid)z.strokeStyle="rgba(50, 50, 50, 0.3)";z.beginPath();for(E=n.length;E--;){var P=n[E];if(P){var U=P.gridX-R,K=P.gridY-L;S=((T?false:P.x===U&&P.y===K)?true:C.drawTile(z,P,U,K,N))&&S}else S=false;d.drawGrid&&z.rect(U,K,d.tileSize,d.tileSize)}z.stroke();GRUNT.Log.trace("drawn tiles",O);S&&!p&&I.trigger("tileDrawComplete");p=S;o=g=false}}},
getTileVirtualXY:function(z,L,E){z=f.getNormalizedPos(z,L);z=new TILE5.Vector(z.x*d.tileSize,z.y*d.tileSize);if(E){z.x+=k;z.y+=k}return z},populate:function(z){f.populate(z,function(){})}});GRUNT.WaterCooler.listen("tile.loaded",function(){g=true;C.wakeParent()});GRUNT.WaterCooler.listen("grid.invalidate",function(){o=true});return C},ImageTileGrid:function(d){function e(){GRUNT.WaterCooler.say("tile.loaded")}d=GRUNT.extend({},d);var f=t(),k=r(),m=TILE5.Graphics.DisplayState.ACTIVE,g=TILE5.Graphics.DisplayState.PAN,
b=TILE5.Device.getConfig().requireFastDraw;return GRUNT.extend(new h.TileGrid(d),{drawTile:function(n,o,p,s,q){var u=TILE5.Resources.getImage(o.url),v=false;if(u&&u.complete&&u.width>0){n.drawImage(u,p,s);v=true;o.x=p;o.y=s}else q===g?n.drawImage(k,p,s):n.drawImage(f,p,s);return v},prepTile:function(n,o){if(n&&(!b||o===m))TILE5.Resources.getImage(n.url)||TILE5.Resources.loadImage(n.url,e)}})},Tiler:function(d){d=GRUNT.extend({container:"",drawCenter:false,datasources:{},tileLoadThreshold:"first"},
d);var e=new TILE5.Graphics.View(GRUNT.extend({},d,{pannable:true,scalable:true,scaleDamping:true}));GRUNT.extend(e,{getTileLayer:function(){return e.getLayer("grid0")},setTileLayer:function(f){e.setLayer("grid0",f);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(f){var k=e.getOffset();return new TILE5.Vector(f.x+k.x,f.y+k.y)},cleanup:function(){e.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");GRUNT.WaterCooler.say("view.wake",{id:e.id})}});
return e}};return h}();
TILE5.Geo=function(){function t(m,g){var b=null;for(var n in f)if(g){if(n==g&&f[n][m]){b=f[n];break}}else if(f[n][m]){b=f[n];break}return b}function r(m,g,b,n){var o=0;m=m.toUpperCase();for(var p in n){var s=g[p];if(s){var q=b[p];s=q?q(m,s):m.containsWord(s)?1:0;o+=s*n[p]}}return o}var l=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],a=Math.PI/180,h=180/Math.PI,d=null,e={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},f={},k={Engine:function(m){if(!m.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var g=GRUNT.extend({remove:function(){delete f[g.id]}},m);return f[g.id]=g},Radius:function(m,g){return{distance:parseInt(m,10),uom:g}},Position:function(m,g){return{lat:parseFloat(m?m:0),lon:parseFloat(g?g:0)}},BoundingBox:function(m,g){return{min:k.P.parse(m),max:k.P.parse(g)}},Address:function(m){return m=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},m)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var m={dist2rad:function(g){return g/6371},lat2pix:function(g,b){var n=parseFloat(g)*2*Math.PI/360;n=Math.sin(n);var o=0.08181919084262157*n;return Math.log((1+n)/(1-n)*Math.pow((1-o)/(1+o),0.08181919084262157))/2/b},lon2pix:function(g,b){return parseFloat(g)/180*Math.PI/b},pix2lon:function(g,b){return m.normalizeLon(g*b*180/Math.PI)},pix2lat:function(g,b){for(var n=Math.pow(Math.E,
-g*b),o=m.mercatorUnproject(n),p=m.findRadPhi(o,n),s=0;s<12&&Math.abs(o-p)>1.0E-7;){o=p;p=m.findRadPhi(o,n);s++}return p*180/Math.PI},mercatorUnproject:function(g){return Math.PI/2-2*Math.atan(g)},findRadPhi:function(g,b){var n=0.08181919084262157*Math.sin(g);return Math.PI/2-2*Math.atan(b*Math.pow((1-n)/(1+n),0.040909595421310785))},normalizeLon:function(g){for(;g<-180;)g+=360;for(;g>180;)g-=360;return g}};return m}(),GeoSearchResult:function(m){m=GRUNT.extend({id:null,caption:"",resultType:"",data:null,
pos:null,matchWeight:0},m);return GRUNT.extend(m,{toString:function(){return m.caption+(m.matchWeight?" ("+m.matchWeight+")":"")}})},GeoSearchAgent:function(m){return TILE5.Dispatcher.createAgent(m)},GeocodingAgent:function(m){m=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(g,b){try{if(!g.reverse&&!g.freeform)address=new k.Address(g);var n=k.getEngine("geocode");if(n)n.geocode({addresses:[g.freeform?g.freeform:address],complete:function(p,s){if(b){var q=s;if(g.freeform)q=
k.rankGeocodeResponses(g.freeform,q,k.getEngine("geocode"));b(q,m)}}})}catch(o){GRUNT.Log.exception(o)}}},m);return new k.GeoSearchAgent(m)},PointOfInterest:function(m){m=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},m);if(!m.pos&&m.lat&&m.lon)m.pos=new TILE5.Geo.Position(m.lat,m.lon);return GRUNT.extend({toString:function(){return m.id+": '"+m.title+"'"}},m)},POIStorage:function(m){function g(q){q=q?q:"default";o[q]||(o[q]=[]);return o[q]}function b(q){var u=
[];for(var v in o)for(var x=0;x<o[v].length;x++)if(!q||q(o[v][x]))u.push(o[v][x]);return u}function n(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:s.id,pois:s.getPOIs()})}m=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},m);var o={},p=true,s={id:GRUNT.generateObjectID(),getPOIs:function(){return b()},getOldPOIs:function(q,u){return b(function(v){return v.group==q&&v.retrieved<u})},getVisible:function(){return p},setVisible:function(q){if(q!=p){p=q;m.visibilityChange&&m.visibilityChange()}},
findById:function(q){var u=b(function(v){return v.id==q});return u.length>0?u[0]:null},findByBounds:function(q){return b(function(u){return TILE5.Geo.P.inBounds(u.pos,q)})},addPOIs:function(q,u){if(u)o={};for(var v=0;q&&v<q.length;v++){q[v].retrieved=TILE5.Clock.getTime(true);var x=q[v];g(x.group).push(x)}},removeGroup:function(q){if(o[q]){delete o[q];n()}},update:function(q){var u=[],v=0,x=q.length>0?q[0].group:"",y=TILE5.Clock.getTime(true);for(v=0;v<q.length;v++){var C;a:{if(C=q[v])for(var z=g(C.group),
L=0;L<z.length;L++)if(z[L].id==C.id){C=z[L];break a}C=null}if(C){C.retrieved=y;C.isNew=false}else u.push(q[v])}q=s.getOldPOIs(x,y);s.addPOIs(u);for(v=0;m.onPOIAdded&&v<u.length;v++)m.onPOIAdded(u[v]);for(v=0;v<q.length;v++){m.onPOIDeleted&&m.onPOIDeleted(q[v]);x=q[v];y=g(x.group);for(C=0;C<y.length;C++)if(y[C].id==x.id){y.splice(C,1);break}}u.length+q.length>0&&n()}};return s},MapProvider:function(){var m=1,g=20;return{zoomLevel:0,checkZoomLevel:function(b){return Math.min(Math.max(b,m),g)},getCopyright:function(){},
getLogoUrl:function(){},getMapTiles:function(){},getPositionForXY:function(){return null},getZoomRange:function(){return{min:m,max:g}},setZoomRange:function(b,n){m=b;g=n}}},P:function(){var m={calcDistance:function(g,b){if(m.empty(g)||m.empty(b))return 0;var n=(b.lat-g.lat).toRad()/2,o=(b.lon-g.lon).toRad()/2;n=Math.sin(n)*Math.sin(n)+Math.cos(g.lat.toRad())*Math.cos(b.lat.toRad())*Math.sin(o)*Math.sin(o);return 6371*2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n))},copy:function(g){return g?new k.Position(g.lat,
g.lon):null},empty:function(g){return!g||g.lat===0&&g.lon===0},equal:function(g,b){return g&&b&&g.lat==b.lat&&g.lon==b.lon},almostEqual:function(g,b){return g&&b&&Math.floor(g.lat*1E3)===Math.floor(b.lat*1E3)&&Math.floor(g.lon*1E3)===Math.floor(b.lon*1E3)},inArray:function(g,b){for(var n=k.P.equal,o=b.length;o--;)if(n(g,b[o]))return true;return false},inBounds:function(g,b){var n=!(k.P.empty(g)||k.P.empty(b));return n=(n=n&&g.lat>=b.min.lat&&g.lat<=b.max.lat)&&g.lon>=b.min.lon&&g.lon<=b.max.lon},
parse:function(g){if(g)if(typeof g.lat!=="undefined")return m.copy(g);else{if(g.split)for(var b=[" ",","],n=0;n<b.length;n++){var o=g.split(b[n]);if(o.length===2)return new k.Position(o[0],o[1])}}else return new k.Position;return null},parseArray:function(g){var b=g.length,n=Array(b);for(b=b;b--;)n[b]=m.parse(g[b]);GRUNT.Log.info("parsed "+n.length+" positions");return n},fromMercatorPixels:function(g,b,n){return new k.Position(TILE5.Geo.Utilities.pix2lat(b,n),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(g,
n)))},toMercatorPixels:function(g,b){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(g.lon,b),TILE5.Geo.Utilities.lat2pix(g.lat,b))},generalize:function(g,b,n){var o=g.length,p=[],s=null;n||(n=250);n/=1E3;GRUNT.Log.info("generalizing positions, must include "+b.length+" positions");for(var q=o;q--;)if(q===0)p.unshift(g[q]);else{var u=!s||k.P.inArray(g[q],b)?n:k.P.calcDistance(s,g[q]);if(g[q]&&u>=n){p.unshift(g[q]);s=g[q]}}GRUNT.Log.info("generalized "+o+" positions into "+p.length+" positions");
return p},toString:function(g){return g?g.lat+" "+g.lon:""}};return m}(),B:function(){var m=-(Math.PI/2),g=Math.PI/2,b=-Math.PI*2,n=Math.PI*2,o={calcSize:function(p,s,q){var u=new TILE5.Vector(0,s.lat-p.lat);if(typeof q==="undefined")q=true;u.x=q&&p.lon>s.lon?360-p.lon+s.lon:s.lon-p.lon;return u},createBoundsFromCenter:function(p,s){var q=s/6371,u=p.lat*a,v=p.lon*a,x=u-q,y=u+q;if(x>m&&y<g){u=Math.asin(Math.sin(q)/Math.cos(u));q=v-u;if(q<b)q+=2*Math.PI;v=v+u;if(v>n)v-=2*Math.PI}else{x=Math.max(x,m);
y=Math.min(y,g);q=b;v=n}return new k.BoundingBox(new k.Position(x*h,q*h),new k.Position(y*h,v*h))},expand:function(p,s){return new k.BoundingBox(new k.Position(p.min.lat-s,p.min.lon-k.Utilities.normalizeLon(s)),new k.Position(p.max.lat+s,p.max.lon+k.Utilities.normalizeLon(s)))},forPositions:function(p,s){var q=null,u=TILE5.Clock.getTime();s||(s="auto");for(var v=p.length;v--;)if(q){var x=o.calcSize(q.min,p[v],false),y=o.calcSize(p[v],q.max,false);if(x.x<0)q.min.lon=p[v].lon;if(x.y<0)q.min.lat=p[v].lat;
if(y.x<0)q.max.lon=p[v].lon;if(y.y<0)q.max.lat=p[v].lat}else q=new TILE5.Geo.BoundingBox(p[v],p[v]);if(s){if(s=="auto"){v=o.calcSize(q.min,q.max);s=Math.max(v.x,v.y)*0.3}q=o.expand(q,s)}GRUNT.Log.trace("calculated bounds for "+p.length+" positions",u);return q},getCenter:function(p){var s=k.B.calcSize(p.min,p.max);return new TILE5.Geo.Position(p.min.lat+s.y/2,p.min.lon+s.x/2)},getGeoHash:function(p){var s=TILE5.Geo.GeoHash.encode(p.min.lat,p.min.lon);p=TILE5.Geo.GeoHash.encode(p.max.lat,p.max.lon);
GRUNT.Log.info("min hash = "+s+", max hash = "+p)},getZoomLevel:function(p,s){var q=o.getCenter(p),u=l[Math.min(Math.round(Math.abs(q.lat)*0.05),l.length)],v=o.calcSize(p.min,p.max);q=Math.ceil(Math.log(l[3]*s.height/v.y)/Math.log(2));u=Math.ceil(Math.log(u*s.width/v.x)/Math.log(2));return Math.min(isNaN(q)?1E3:q,isNaN(u)?1E3:u)},isEmpty:function(p){return!p||k.P.empty(p.min)||k.P.empty(p.max)},toString:function(p){return"min: "+k.P.toString(p.min)+", max: "+k.P.toString(p.max)}};return o}(),A:function(){var m=
/^(\d+).*$/,g=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(b,n){m.lastIndex=-1;if(m.test(b))for(var o=b.replace(m,"$1"),p=n.split(","),s=0;s<p.length;s++){g.lastIndex=-1;if(g.test(p[s])){var q=g.exec(p[s]);if(o>=parseInt(q[1],10)&&o<=parseInt(q[2],10))return true}else if(o==p[s])return true}return false},normalize:function(b){if(!b)return"";b=b.toUpperCase();if(!d){var n=[];for(var o in e)n.push(o);d=RegExp("(\\s)("+n.join("|")+")(\\s|$)","i")}d.lastIndex=-1;if(n=d.exec(b))b=b.replace(d,"$1"+
e[n[2]]);return b},toString:function(b){return b.streetDetails+" "+b.location}}}(),getEngine:function(m){for(var g=null,b=1;!g&&b<arguments.length;b++)g=t(m,arguments[b]);g=g?g:t(m);if(!g)throw Error("Unable to find GEO engine with "+m+" capability");return g},rankGeocodeResponses:function(m,g,b){var n=[],o=k.AddressCompareFns;if(b&&b.compareFns)o=GRUNT.extend({},o,b.compareFns);for(b=0;b<g.length;b++)n.push(new k.GeoSearchResult({caption:k.A.toString(g[b]),data:g[b],pos:g[b].pos,matchWeight:r(m,
g[b],o,k.GeocodeFieldWeights)}));n.sort(function(p,s){return s.matchWeight-p.matchWeight});return n}};return k}();
TILE5.Geo.Location=function(){function t(a){function h(b){try{var n=new TILE5.Geo.Position(b.coords.latitude,b.coords.longitude),o=GRUNT.isPlainObject(b.coords.accuracy)&&b.coords.accuracy.horizontal?b.coords.accuracy.horizontal:b.coords.accuracy;GRUNT.Log.info("position success, accuracy = "+o);if(a.successCallback&&(!k||o<m))a.successCallback(n,o,f,b);if(o>a.highAccuracyCutoff&&f<2){f=2;a.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");
a.watch||e()}k=b;m=o}catch(p){GRUNT.Log.exception(p)}}function d(b){if(b.code===b.PERMISSION_DENIED)a.errorCallback&&a.errorCallback(b);else if(b.code===b.POSITION_UNAVAILABLE)a.errorCallback&&a.errorCallback(b);else if(b.code===b.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(a.timeout===0&&a.autoPhasing){f=1;a.timeout=r;a.enableHighAccuracy=false;e()}}}function e(){navigator.geolocation.getCurrentPosition(h,d,GRUNT.extend({},a,{enableHighAccuracy:false}))}a=GRUNT.extend({autoPhasing:true,
maximumAge:3E5,timeout:0,highAccuracyCutoff:10,watch:false,enableHighAccuracy:true,successCallback:null,errorCallback:null},a);var f=0,k=null,m=1E6,g;if(a.watch){navigator.geolocation.watchPosition(h,d,a);g=void 0}else g=e();return g}var r=3E3,l={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)l.get=t;return l}();
TILE5.Geo.GeoHash=function(){function t(r,l,a){if(l&a)r[0]=(r[0]+r[1])/2;else r[1]=(r[0]+r[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(r){var l=1,a=[],h=[];a[0]=-90;a[1]=90;h[0]=-180;h[1]=180;lat_err=90;lon_err=180;for(i=0;i<r.length;i++){c=r[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(l){lon_err/=2;t(h,cd,mask)}else{lat_err/=2;t(a,cd,mask)}l=!l}}a[2]=(a[0]+
a[1])/2;h[2]=(h[0]+h[1])/2;return{latitude:a,longitude:h}},encode:function(r,l,a){var h=1,d=[],e=[],f=0,k=0;a=a?a:12;geohash="";d[0]=-90;d[1]=90;e[0]=-180;for(e[1]=180;geohash.length<a;){if(h){mid=(e[0]+e[1])/2;if(l>mid){k|=BITS[f];e[0]=mid}else e[1]=mid}else{mid=(d[0]+d[1])/2;if(r>mid){k|=BITS[f];d[0]=mid}else d[1]=mid}h=!h;if(f<4)f++;else{geohash+=BASE32[k];k=f=0}}return geohash}}}();
TILE5.Geo.Search=function(){return{bestResults:function(t,r){r||(r=20);for(var l=t.length>0?t[0]:null,a=[],h=0;h<t.length;h++)if(l.matchWeight-t[h].matchWeight<=r)a.push(t[h]);else break;return a}}}();
TILE5.Geo.Routing=function(){var t={calculate:function(r){r=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},r);GRUNT.Log.info("attempting to calculate route");var l=TILE5.Geo.getEngine("route");l&&l.route(r,function(a){if(r.generalize)a.geometry=TILE5.Geo.P.generalize(a.geometry,a.getInstructionPositions());if(r.map){t.createMapOverlay(r.map,a);if(r.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+a.boundingBox);r.map.gotoBounds(a.boundingBox)}}r.success&&
r.success(a)})},createMapOverlay:function(r,l){var a=r.getDimensions();a=new TILE5.Geo.UI.RouteOverlay({data:l,width:a.width,height:a.height});r.setLayer("route",a)},parseTurnType:function(r){for(var l=t.TurnType.Unknown,a=TILE5.Geo.Routing.TurnTypeRules,h=0;h<a.length;h++){a[h].regex.lastIndex=-1;var d=a[h].regex.exec(r);if(d){l=a[h].customCheck?a[h].customCheck(r,d):a[h].turnType;break}}return l},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",
TurnLeft:"turn-left",TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(r){r=GRUNT.extend({position:null,description:"",turnType:null},r);if(!r.turnType)r.turnType=t.parseTurnType(r.description);return r},RouteData:function(r){r=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},r);if(!r.boundingBox)r.boundingBox=TILE5.Geo.B.forPositions(r.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var l=[],a=0;a<r.instructions.length;a++)r.instructions[a].position&&l.push(r.instructions[a].position);return l}},r)}};return t}();
TILE5.Geo.Routing.TurnTypeRules=function(){var t=TILE5.Geo.Routing.TurnType,r=[];r.push({regex:/continue/i,turnType:t.Continue});r.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(l,a){return/bear/i.test(a[1])?t.TurnLeftSlight:t.TurnLeft}});r.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(l,a){return/bear/i.test(a[1])?t.TurnRightSlight:t.TurnRight}});r.push({regex:/enter\s(roundabout|rotaty)/i,turnType:t.EnterRoundabout});r.push({regex:/take.*?ramp/i,turnType:t.Ramp});
r.push({regex:/take.*?exit/i,turnType:t.RampExit});r.push({regex:/make(.*?)u\-turn/i,customCheck:function(l,a){return/right/i.test(a[1])?t.UTurnRight:t.UTurnLeft}});r.push({regex:/proceed/i,turnType:t.Start});r.push({regex:/arrive/i,turnType:t.Arrive});r.push({regex:/fell\sthrough/i,turnType:t.Merge});return r}();
TILE5.Geo.UI=function(){function t(a){a=GRUNT.extend({size:12,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},a);var h=null,d=function(){var e=TILE5.newCanvas(a.size*4,a.size*4),f=e.getContext("2d"),k=new TILE5.Vector(e.width/2,e.height/2),m=a.size,g=["#FFFFFF","#333333"],b=[3,1.5];f.lineCap="round";for(var n=0;n<g.length;n++){var o=m;f.lineWidth=b[n];f.strokeStyle=g[n];f.beginPath();f.moveTo(k.x,
k.y-o);f.lineTo(k.x,k.y+o);f.moveTo(k.x-o,k.y);f.lineTo(k.x+o,k.y);f.arc(k.x,k.y,m*0.6666,0,2*Math.PI,false);f.stroke()}return e}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(e,f,k){if(!h){h=TILE5.D.getCenter(k);h=new TILE5.Vector(Math.round(h.x-d.width/2),Math.round(h.y-d.height/2))}e.drawImage(d,h.x,h.y)}})}var r=0,l={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,radsPerPixel:0},a);var h=
TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),d=h.x-a.centerXY.x,e=h.y-a.centerXY.y,f=GRUNT.extend({},a.grid,{getBoundingBox:function(k,m,g,b){return new TILE5.Geo.BoundingBox(f.pixelsToPos(new TILE5.Vector(k,m+b)),f.pixelsToPos(new TILE5.Vector(k+g,m)))},getGridXYForPosition:function(k){k=TILE5.Geo.P.toMercatorPixels(k,a.radsPerPixel);return new TILE5.Vector(k.x-d,f.gridDimensions.height-(k.y-e))},getPixelDistance:function(k){k=TILE5.Geo.Utilities.dist2rad(k);return Math.floor(k/a.radsPerPixel)},
pixelsToPos:function(k){return TILE5.Geo.P.fromMercatorPixels(d+k.x,e+f.gridDimensions.height-k.y,a.radsPerPixel)}});return f},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var h=true,d=null,e=[],f=0,k=[],m=[],g=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(b,n,o,p){if(h)return null;var s="routeAnimation"+r++;m.push(s);
return new TILE5.Graphics.AnimatedPathLayer({id:s,path:e,zindex:a.zindex+1,easing:b?b:TILE5.Animation.Easing.Sine.InOut,duration:n?n:5E3,drawIndicator:o,autoCenter:p?p:false})},draw:function(b,n,o,p,s){o=0;p=a.data?a.data.geometry:null;if(h){h=false;d=null;e=[];f=0}if(p&&f<p.length){a:{s=s.getTileLayer();k=[];if(s){p=GRUNT.Log.getTraceTicks();var q,u,v,x=a.data?a.data.geometry:[],y=x.length,C=a.data?a.data.instructions:[],z=C.length,L=a.calculationsPerCycle,E=0;for(q=f;q<y;q++){u=s.getGridXYForPosition(x[q]);
if(v=!d||q===0||Math.abs(u.x-d.x)+Math.abs(u.y-d.y)>a.pixelGeneralization){e.push(u);d=u}E++;if(E>=L){f=q;break a}}f=y;GRUNT.Log.trace(y+" geometry points generalized to "+e.length+" coordinates",p);d=null;for(q=z;q--;)if(C[q].position){u=s.getGridXYForPosition(C[q].position);if(v=!d||q===0||Math.abs(u.x-d.x)+Math.abs(u.y-d.y)>a.pixelGeneralization){k.push(u);d=u}}}}o++}s=e.length;if(s>0&&(!o||a.partialDraw)){b.strokeStyle=a.strokeStyle;b.lineWidth=a.lineWidth;b.beginPath();b.moveTo(e[s-1].x-n.x,
e[s-1].y-n.y);for(s=s;s--;)b.lineTo(e[s].x-n.x,e[s].y-n.y);b.stroke();b.fillStyle=a.waypointFillStyle;for(s=k.length;s--;){b.beginPath();b.arc(k[s].x-n.x,k[s].y-n.y,2,0,Math.PI*2,false);b.stroke();b.fill()}}return o}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var b=m.length;b--;)GRUNT.WaterCooler.say("layer.remove",{id:m[b]});m=[];h=true;g.wakeParent()});return g},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:l.AnnotationTween,animationSpeed:null},a);var h=
false,d={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return h},draw:function(e,f,k,m){if(d.xy){if(d.isNew&&a.tweenIn){var g=d.xy.y;d.xy.y=f.y-20;h=true;TILE5.Animation.tween(d.xy,"y",g,a.tweenIn,function(){d.xy.y=g;h=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(e,f,new TILE5.Vector(d.xy.x-f.x,d.xy.y-f.y),k,m);else{e.beginPath();e.arc(d.xy.x-f.x,d.xy.y-f.y,4,0,Math.PI*2,false);e.fill()}d.isNew=false}}};return d},ImageAnnotation:function(a){a=GRUNT.extend({imageUrl:null,
animatingImageUrl:null,imageAnchor:null},a);var h=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;a.draw=function(e,f,k,m,g){if(a.animatingImageUrl&&d.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);m=a.animatingImageUrl}else m=a.imageUrl;if(f=TILE5.Resources.getImage(m)){if(f.complete&&f.width>0){h||(h=new TILE5.Vector(-f.width>>1,-f.height>>1));k=TILE5.V.offset(k,h.x,h.y);e.drawImage(f,k.x,k.y,f.width,f.height)}}else TILE5.Resources.loadImage(m,function(){g.wakeParent()})};var d=new l.Annotation(a);
return d},AnnotationsOverlay:function(a){function h(m){for(var g=a.map?a.map.getTileLayer():null,b=0;g&&b<m.length;b++)m[b].xy=g.getGridXYForPosition(m[b].pos)}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var d=[],e=false,f=[],k=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){return e?1:0},draw:function(m,g,b,n){e=false;m.fillStyle="rgba(255, 0, 0, 0.75)";m.globalCompositeOperation="source-over";for(b=d.length;b--;){d[b].draw(m,g,n,k);e=e||d[b].isAnimating()}for(b=
f.length;b--;){f[b].draw(m,g,n,k);e=e||f[b].isAnimating()}return e?1:0},add:function(m){f.push(m);h(f);k.wakeParent()},clear:function(m){f=[];h(f);if(m){d=[];h(d)}k.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(m){if(a.pois&&a.pois.id==m.srcID){m=m.pois;try{d=[];for(var g=0;g<m.length;g++)if(m[g].pos){var b;var n=m[g];if(n&&n.pos){var o=null;if(o=a.createAnnotationForPOI?a.createAnnotationForPOI(n):new l.Annotation({pos:n.pos})){o.isNew=n.isNew;n.isNew=false}b=o}else b=void 0;
b&&d.push(b)}h(d)}catch(p){GRUNT.Log.exception(p)}k.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){h(d);h(f);k.wakeParent()});return k},GeoLocationOverlay:function(a){function h(){var b=a.map?a.map.getTileLayer():null;e=null;if(k&&b)e=b.getGridXYForPosition(k);f=0;if(m&&b)f=b.getPixelDistance(m/1E3)}a=GRUNT.extend({fillStyle:"rgba(0, 221, 238, 0.1)",strokeStyle:"rgba(0, 102, 136, 0.3)",originFillStyle:"rgba(0, 102, 136, 0.7)",zindex:100,map:null,watch:true,onUpdate:null},a);var d=
0,e=null,f=0,k=null,m=0,g=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){},draw:function(b,n){if(e&&f){var o=e.x-n.x,p=e.y-n.y;b.fillStyle=a.fillStyle;b.lineWidth=1;b.strokeStyle=a.strokeStyle;b.beginPath();b.arc(o,p,f,0,Math.PI*2,false);b.fill();b.stroke();b.fillStyle=a.originFillStyle;b.beginPath();b.arc(o,p,3,0,Math.PI*2,false);b.fill();GRUNT.WaterCooler.say("grid.invalidate")}},getPosition:function(){return k},getAccuracy:function(){return m}});GRUNT.WaterCooler.listen("grid.updated",
function(){h();g.wakeParent()});(function(){d=TILE5.Geo.Location.get({watch:a.watch,successCallback:function(b,n){a.onUpdate&&a.onUpdate(b,n);k=TILE5.Geo.P.copy(b);m=n;h()},errorCallback:function(){GRUNT.Log.info("got position error")}})})();return g},Tiler:function(a){a=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,zoomLevel:0,boundsChange:null,tapPOI:null,tapHandler:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,onTilesLoaded:null,zoomAnimation:TILE5.Animation.Easing.Quad.Out},
a);var h=new TILE5.Vector,d=false,e=[],f=0,k=null,m=null,g=a.zoomLevel;if(!a.provider)a.provider=new TILE5.Geo.MapProvider;var b=GRUNT.extend({},new TILE5.Tiling.Tiler(a),{pois:a.pois,annotations:null,getProvider:function(){return a.provider},setProvider:function(o){a.provider=o;d=false},getBoundingBox:function(){var o=b.getTileLayer(),p=b.getOffset(),s=b.getDimensions();if(o)return o.getBoundingBox(p.x,p.y,s.width,s.height);return null},getCenterPosition:function(){return b.getXYPosition(TILE5.D.getCenter(b.getDimensions()))},
getXYPosition:function(o){return b.getTileLayer().pixelsToPos(b.viewPixToGridPix(o))},gotoBounds:function(o,p){var s=TILE5.Geo.B.getZoomLevel(o,b.getDimensions());b.gotoPosition(TILE5.Geo.B.getCenter(o),s,p)},gotoCurrentPosition:function(o){function p(q,u){var v=TILE5.Geo.B.createBoundsFromCenter(q,u/1E3);GRUNT.Log.info("detected position: "+TILE5.Geo.P.toString(q)+", accuracy = "+u);b.clearBackground();b.gotoBounds(v,o)}var s=b.getLayer("geolocation");if(s)p(s.getPosition(),s.getAccuracy());else{s=
new l.GeoLocationOverlay({map:b,onUpdate:function(q,u){p(q,u)}});GRUNT.Log.info("created geolocation layer");b.setLayer("geolocation",s)}},gotoPosition:function(o,p,s){var q=g,u=(new Date).getTime(),v=false,x=b.getBoundingBox();if(x)v=!TILE5.Geo.P.inBounds(o,x);g=p?p:g;if(!g)throw Error("Zoom level required to goto a position.");if(a.provider)g=a.provider.checkZoomLevel(g);if(v||!d||g!==q){TILE5.Resources.resetImageLoadQueue();(p=b.getTileLayer())&&p.deactivate();TILE5.Animation.cancel();d&&b.freeze();
f=u;a.provider.zoomLevel=g;a.provider.getMapTiles(b,o,function(y){if(u===f){b.setTileLayer(y);m=y.getId();b.panToPosition(o,function(){b.unfreeze();b.trigger("zoomLevelChange",g);s&&s()})}else GRUNT.Log.info("request time mismatch - ignoring update")});d=true}else b.panToPosition(o,s)},panToPosition:function(o,p,s){var q=b.getTileLayer();if(q){o=q.getGridXYForPosition(o);q=b.getDimensions();o.x-=q.width/2;o.y-=q.height/2;if(k)k=null;b.updateOffset(o.x,o.y,s);GRUNT.WaterCooler.say("view.wake",{id:b.id});
a.boundsChange&&a.boundsChange(b.getBoundingBox());p&&p(b)}},getZoomLevel:function(){return g},setZoomLevel:function(o){try{b.gotoPosition(b.getCenterPosition(),o)}catch(p){GRUNT.Log.exception(p)}},zoomIn:function(){b.scale(2,TILE5.Animation.Easing.Sine.Out)||b.setZoomLevel(g+1)},zoomOut:function(){b.scale(0.5,TILE5.Animation.Easing.Sine.Out)||b.setZoomLevel(g-1)},animateRoute:function(o,p,s,q){var u=b.getLayer("route");if(u)(o=u.getAnimation(o,p,s,q))&&o.addToView(b)}});b.bind("tap",function(o,p){var s=
b.getTileLayer(),q=null;if(s){q=b.viewPixToGridPix(new TILE5.Vector(p.x,p.y));var u=s.pixelsToPos(q),v=s.pixelsToPos(TILE5.V.offset(q,-a.tapExtent,a.tapExtent)),x=s.pixelsToPos(TILE5.V.offset(q,a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(s.pixelsToPos(q)));q=new TILE5.Geo.BoundingBox(v,x);e=b.pois.findByBounds(q);b.trigger("geotap",o,p,u,q);a.tapPOI&&a.tapPOI(e)}});b.bind("doubleTap",function(o,p){b.animate(2,TILE5.D.getCenter(b.getDimensions()),new TILE5.Vector(p.x,
p.y),a.zoomAnimation)});b.bind("scale",function(o,p){var s=0;o=Math.sqrt(o);if(o<1)s=-(0.5/o);else if(o>1)s=o;b.gotoPosition(b.getXYPosition(p),g+Math.floor(s))});var n=new TILE5.Geo.UI.AnnotationsOverlay({pois:b.pois,map:b,createAnnotationForPOI:a.createAnnotationForPOI});b.annotations=n;b.setLayer("annotations",n);a.crosshair&&b.setLayer("crosshair",new t);GRUNT.WaterCooler.listen("view.idle",function(o){if(o.id&&o.id==b.id)if(TILE5.V.absSize(TILE5.V.diff(h,b.getOffset()))>a.boundsChangeThreshold&&
a.boundsChange){h=b.getOffset();a.boundsChange(b.getBoundingBox())}});return b}};return l}();
