if(!this.JSON)this.JSON={};
(function(){function q(l){return l<10?"0"+l:l}function n(l){f.lastIndex=0;return f.test(l)?'"'+l.replace(f,function(k){var h=e[k];return typeof h==="string"?h:"\\u"+("0000"+k.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+l+'"'}function d(l,k){var h,g,i,m,o=a,r,p=k[l];if(p&&typeof p==="object"&&typeof p.toJSON==="function")p=p.toJSON(l);if(typeof j==="function")p=j.call(k,l,p);switch(typeof p){case "string":return n(p);case "number":return isFinite(p)?String(p):"null";case "boolean":case "null":return String(p);
case "object":if(!p)return"null";a+=c;r=[];if(Object.prototype.toString.apply(p)==="[object Array]"){m=p.length;for(h=0;h<m;h+=1)r[h]=d(h,p)||"null";i=r.length===0?"[]":a?"[\n"+a+r.join(",\n"+a)+"\n"+o+"]":"["+r.join(",")+"]";a=o;return i}if(j&&typeof j==="object"){m=j.length;for(h=0;h<m;h+=1){g=j[h];if(typeof g==="string")if(i=d(g,p))r.push(n(g)+(a?": ":":")+i)}}else for(g in p)if(Object.hasOwnProperty.call(p,g))if(i=d(g,p))r.push(n(g)+(a?": ":":")+i);i=r.length===0?"{}":a?"{\n"+a+r.join(",\n"+a)+
"\n"+o+"}":"{"+r.join(",")+"}";a=o;return i}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+q(this.getUTCMonth()+1)+"-"+q(this.getUTCDate())+"T"+q(this.getUTCHours())+":"+q(this.getUTCMinutes())+":"+q(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var b=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
f=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,a,c,e={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},j;if(typeof JSON.stringify!=="function")JSON.stringify=function(l,k,h){var g;c=a="";if(typeof h==="number")for(g=0;g<h;g+=1)c+=" ";else if(typeof h==="string")c=h;if((j=k)&&typeof k!=="function"&&(typeof k!=="object"||typeof k.length!=="number"))throw Error("JSON.stringify");return d("",
{"":l})};if(typeof JSON.parse!=="function")JSON.parse=function(l,k){function h(i,m){var o,r,p=i[m];if(p&&typeof p==="object")for(o in p)if(Object.hasOwnProperty.call(p,o)){r=h(p,o);if(r!==undefined)p[o]=r;else delete p[o]}return k.call(i,m,p)}var g;l=String(l);b.lastIndex=0;if(b.test(l))l=l.replace(b,function(i){return"\\u"+("0000"+i.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(l.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){g=eval("("+l+")");return typeof k==="function"?h({"":g},""):g}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(q){if(arguments.length<=1)return q;for(var n=arguments.length-2,d=0;d<=n;d++)q=q.replace(RegExp("\\{"+d+"\\}","gi"),arguments[d+1]);return q};
String.prototype.containsWord=function(q){var n="";if(q.toString)q=q.toString();for(var d=0;d<q.length;d++)n+=!/\w/.test(q[d])?"\\"+q[d]:q[d];return RegExp("(^|\\s|\\,)"+n+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var q=Object.prototype.hasOwnProperty,n=0,d={id:"GRUNT.core",extend:function(){var b=arguments[0]||{},f=1,a=arguments.length,c=false,e,j,l,k;if(typeof b==="boolean"){c=b;b=arguments[1]||{};f=2}if(typeof b!=="object"&&!d.isFunction(b))b={};if(a===f){b=this;--f}for(;f<a;f++)if((e=arguments[f])!=null)for(j in e){l=b[j];k=e[j];if(b!==k)if(c&&k&&(d.isPlainObject(k)||d.isArray(k))){l=l&&(d.isPlainObject(l)||d.isArray(l))?l:d.isArray(k)?[]:{};b[j]=d.extend(c,l,k)}else if(k!==undefined)b[j]=
k}return b},isFunction:function(b){return toString.call(b)==="[object Function]"},isArray:function(b){return toString.call(b)==="[object Array]"},isPlainObject:function(b){if(!b||toString.call(b)!=="[object Object]"||b.nodeType||b.setInterval)return false;if(b.constructor&&!q.call(b,"constructor")&&!q.call(b.constructor.prototype,"isPrototypeOf"))return false;var f;for(f in b);return f===undefined||q.call(b,f)},isEmptyObject:function(b){for(var f in b)return false;return true},isXmlDocument:function(b){return toString.call(b)===
"[object Document]"},contains:function(b,f){var a=b,c=arguments,e=1;if(f&&d.isArray(f)){c=f;e=0}for(e=e;e<c;e++)a=a&&typeof foo[c[e]]!=="undefined";return a},newModule:function(b){b=d.extend({id:null,requires:[],parent:null},b);if(b.parent)b=d.extend({},b.parent,b);return b},toID:function(b){return b.replace(/\s/g,"-")},generateObjectID:function(b){return(b?b:"obj")+n++}};return d}();
GRUNT.Log=function(){function q(a,c){var e,j=c&&c.length>0?c[0]:"";for(e=1;c&&e<c.length;e++)j+=" "+(d&&GRUNT.isPlainObject(c[e])?JSON.stringify(c[e]):c[e]);typeof console!=="undefined"&&console[a](j);for(e=0;e<n.length;e++)n[e].call(f,j,a)}var n=[],d=typeof JSON!=="undefined",b=window.console&&window.console.markTimeline,f={id:"GRUNT.log",getTraceTicks:function(){return b?(new Date).getTime():null},trace:function(a,c){if(b)console.markTimeline(a+(c?": "+(f.getTraceTicks()-c)+"ms":""))},debug:function(){q("debug",
arguments)},info:function(){q("info",arguments)},warn:function(){q("warn",arguments)},error:function(){q("error",arguments)},exception:function(a){f.error(arguments);for(var c in a)f.info("ERROR DETAIL: "+c+": "+a[c])},watch:function(a,c){try{c()}catch(e){f.exception(e,a)}},throwError:function(a){f.error(a);throw Error(a);},requestUpdates:function(a){n.push(a)}};return f}();
GRUNT.Data=function(){var q={determineObjectMapping:function(d){if(!d)return null;d=d.split("|");for(var b={},f=0;f<d.length;f++)b[d[f]]=f;return b},mapLineToObject:function(d,b){var f=d.split("|"),a={};for(var c in b){var e=b[c];a[c]=f.length>e?f[e]:null}return a},parse:function(d){var b=null,f=[];d=d.split("\n");for(var a=0;a<d.length;a++){var c=d[a];if(b)f.push(q.mapLineToObject(c,b));else b=q.determineObjectMapping(c)}return f}},n={supportedFormats:{JSON:{parse:function(d){return JSON.parse(d)}},
PDON:{parse:function(d){return q.parse(d)}}},parse:function(d){d=GRUNT.extend({data:"",format:"JSON"},d);if(!n.supportedFormats[d.format])throw Error("Unsupported data format: "+d.format+", cannot parse data in javascript object");try{return n.supportedFormats[d.format].parse(d.data)}catch(b){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+d.format,d.data);GRUNT.Log.exception(b)}return{}}};return n}();
GRUNT.Template=function(){var q=/\$\{(.*?)\}/ig;return{parse:function(n,d){for(var b=n,f=q.exec(b);f;){b=b.replace(f[0],GRUNT.XPath.first(f[1],d));q.lastIndex=0;f=q.exec(b)}return b}}}();
GRUNT.JSONP=function(){function q(f){var a=document.createElement("script"),c=false;a.src=f;a.async=true;a.onload=a.onreadystatechange=function(){if(!c&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){c=true;a.onload=a.onreadystatechange=null;a&&a.parentNode&&a.parentNode.removeChild(a)}};d||(d=document.getElementsByTagName("head")[0]);d.appendChild(a)}var n=0,d,b=this;return{get:function(f,a){f+=f.indexOf("?")>=0?"&":"?";var c="json"+ ++n;b[c]=function(e){a(e);b[c]=
null;try{delete b[c]}catch(j){}};q(f+"callback="+c);return c}}}();
GRUNT.XHR=function(){var q={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},n={JSON:["json"],PDON:["pdon.txt"]},d=["TEXT","STREAM"],b=/^(\w+:)?\/\/([^\/?#]+)/,f={XML:function(e){return e.responseXML},JSON:function(e){try{return JSON.parse(e.responseText)}catch(j){GRUNT.Log.error("Error parsing JSON data: ",e.responseText);GRUNT.Log.exception(j)}return""},PDON:function(e){return GRUNT.Data.parse({data:e.responseText,format:"PDON"})},DEFAULT:function(e){return e.responseText}},
a={CONTENT_TYPE:"Content-Type"},c=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(e){try{e=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},c.ajaxSettings,e);var j=b.exec(e.url),l=j&&(j[1]&&j[1]!==location.protocol||j[2]!==location.host);if(e.data)e.method="POST";if(e.url){j=null;if(e.xhr)j=e.xhr(e);j||(j=new XMLHttpRequest);j.open(e.method,e.url,e.async);e.data&&j.setRequestHeader("Content-Type",
e.contentType);l||j.setRequestHeader("X-Requested-With","XMLHttpRequest");j.onreadystatechange=function(){if(this.readyState===4){var h=null,g=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(g)if(e.handleResponse)e.handleResponse(this);else{var i=e,m=this.getResponseHeader(a.CONTENT_TYPE),o,r=false;for(o in q)if(m&&m.indexOf(q[o])>=0){r=true;break}m=!r;for(r=0;r<d.length;r++)m=m||d[r]==o;if(m)b:{m=o;for(var p in n)for(r=
0;r<n[p].length;r++)if(RegExp(n[p][r]+"$","i").test(i.url)){o=p;break b}o=m?m:"DEFAULT"}try{h=f[o](this,i)}catch(s){GRUNT.Log.warn("error applying processor '"+o+"' to response type, falling back to default");h=f.DEFAULT(this,i)}}else e.error&&e.error(this)}catch(t){GRUNT.Log.exception(t,"PROCESSING AJAX RESPONSE")}g&&h&&e.success&&e.success.call(this,h)}};j.send(e.method=="POST"?c.param(e.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(k){GRUNT.Log.exception(k)}},
param:function(e){var j=[],l=function(h,g){g=GRUNT.isFunction(g)?g():g;j[j.length]=encodeURIComponent(h)+"="+encodeURIComponent(g)};if(GRUNT.isArray(e))for(var k=0;k<e.length;k++)l(e[k].name,e[k].value);else for(k in e)l(k,e[k]);return j.join("&").replace(/%20/g,"+")}});return c}();
GRUNT.XPath=function(){function q(f){for(var a=null,c=0;c<n.length;c++)if(a=n[c](f))break;return a}var n=[],d=[null,function(f){return f.numberValue},function(f){return f.stringValue},function(f){return f.booleanValue},null,null,null,null,function(f){return f.singleNodeValue?f.singleNodeValue.textContent:null},function(f){return f.singleNodeValue?f.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var b={SearchResult:function(f){return{toString:function(){var a=
null;if(f){var c=null;if(f.resultType>=0&&f.resultType<d.length)c=d[f.resultType];if(c){GRUNT.Log.info("invoking match handler for result type: "+f.resultType);a=c(f)}}return a?a:""}}},first:function(f,a){var c=b.SearchResult,e;var j=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!j)j=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(a))e=a.evaluate(f,a,q,j,null);else{GRUNT.Log.warn("attempted xpath expression: "+f+" on a non-xml document");e=null}}catch(l){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
f+" on node: "+a);e=null}return new c(e)},registerResolver:function(f){n.push(f)}};return b}();GRUNT.WaterCooler=function(){var q={};return{listen:function(n,d){q[n]||(q[n]=[]);d&&q[n].push(d)},say:function(n,d){if(q[n])for(var b=0;b<q[n].length;b++)q[n][b](d)},leave:function(){}}}();
TILE5=function(){var q={copyRect:function(n){return n?new q.Rect(n.origin.x,n.origin.y,n.dimensions.width,n.dimensions.height):null},Settings:function(){var n={};return{get:function(d){return n[d]},set:function(d,b){n[d]=b},extend:function(d){GRUNT.extend(n,d)}}}(),Clock:function(){var n=null;return{getTime:function(d){return d&&n?n:n=(new Date).getTime()}}}(),Vector:function(n,d){return{x:n?n:0,y:d?d:0}},V:function(){return{create:function(n,d){return new q.Vector(n,d)},add:function(){for(var n=
new q.Vector,d=arguments.length;d--;){n.x+=arguments[d].x;n.y+=arguments[d].y}return n},absSize:function(n){return Math.max(Math.abs(n.x),Math.abs(n.y))},diff:function(n,d){return new q.Vector(n.x-d.x,n.y-d.y)},copy:function(n){return n?new q.Vector(n.x,n.y):null},invert:function(n){return new TILE5.Vector(-n.x,-n.y)},offset:function(n,d,b){return new TILE5.Vector(n.x+d,n.y+(b?b:d))}}}(),VectorArray:function(n,d){for(var b=Array(n.length),f=n.length;f--;)b[f]=d?q.V.copy(n[f]):n[f];return{applyOffset:function(a){for(var c=
b.length;c--;){b[c].x+=a.x;b[c].y+=a.y}},getRect:function(){return new TILE5.Rect(Math.min(b[0].x,b[1].x),Math.min(b[0].y,b[1].y),Math.abs(b[0].x-b[1].x),Math.abs(b[0].y-b[1].y))},toString:function(){for(var a="",c=b.length;c--;)a+="["+b[c].toString()+"] ";return a}}},VectorMath:function(){function n(d){if(!d||d.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var b={edges:Array(d.length-1),accrued:Array(d.length-1),total:0},f=TILE5.V.diff,a=0;a<d.length-
1;a++){var c=f(d[a],d[a+1]);b.edges[a]=Math.sqrt(c.x*c.x+c.y*c.y);b.accrued[a]=b.total+b.edges[a];b.total+=b.edges[a]}return b}return{edges:n,distance:function(d){return n(d).total},theta:function(d,b,f){f=Math.asin((d.y-b.y)/f);return d.x>b.x?f:Math.PI-f},pointOnEdge:function(d,b,f,a){b=new TILE5.Vector(Math.cos(f)*a,Math.sin(f)*a);return new TILE5.Vector(d.x-b.x,d.y-b.y)}}}(),Dimensions:function(n,d){var b=d?n/d:1,f={width:n,height:d,aspect_ratio:b,inv_aspect_ratio:1/b,getAspectRatio:function(){return f.height!==
0?f.width/f.height:1},getCenter:function(){return new TILE5.Vector(f.width>>1,f.height>>1)},grow:function(a,c){return new TILE5.Dimensions(f.width+a,f.height+c)},matches:function(a){return a&&f.width==a.width&&f.height==a.height},toString:function(){return f.width+" x "+f.height}};return f},Rect:function(n,d,b,f){var a={origin:new TILE5.Vector(n,d),dimensions:new TILE5.Dimensions(b,f),getCenter:function(){return new TILE5.Vector(a.origin.x+(a.dimensions.width>>1),a.origin.y+(a.dimensions.height>>
1))},getSize:function(){return Math.sqrt(Math.pow(a.dimensions.width,2)+Math.pow(a.dimensions.height,2))},grow:function(c,e){var j=new TILE5.Dimensions(c-a.dimensions.width,e-a.dimensions.height);a.dimensions.width=c;a.dimensions.height=e;return j},expand:function(c,e){a.origin.x-=c;a.origin.y-=e;a.dimensions.width+=c;a.dimensions.height+=e},offset:function(c){return new q.Rect(a.origin.x+c.x,a.origin.y+c.y,a.dimensions.width,a.dimensions.height)},getRequiredDelta:function(c,e){var j={top:0,left:0,
bottom:0,right:0};j.top=c.origin.y-a.origin.y+(e?e.y:0);j.left=c.origin.x-a.origin.x+(e?e.x:0);j.right=c.origin.x+c.dimensions.width-(a.origin.x+a.dimensions.width)-j.left;j.bottom=c.origin.y+c.dimensions.height-(a.origin.y+a.dimensions.height)-j.top;return j},applyDelta:function(c,e,j){if(!c||!GRUNT.contains(c,["top","left","bottom","right"]))throw Error("Invalid delta - cannot apply to TILE5.Rect");e||(e=1);a.origin.x+=c.left*e;a.origin.y+=c.top*e;a.dimensions.width+=c.right*e;a.dimensions.height+=
c.bottom*e;j&&a.constrainAspectRatio(j)},constrainAspectRatio:function(c){var e=0,j={top:0,left:0,bottom:0,right:0};if(a.dimensions.getAspectRatio()<c){e=Math.abs(a.dimensions.width-a.dimensions.height*c);j.left=-e;j.right=e}else{e=Math.abs(a.dimensions.height-a.dimensions.width/c);j.top=-e;j.bottom=e}a.applyDelta(j)},moveTo:function(c,e){var j=new TILE5.Vector(c-a.origin.x,e-a.origin.y);a.origin.x=c;a.origin.y=e;return j},toString:function(){return String.format("(origin: {0}, dimensions: {1})",
a.origin,a.dimensions)}};return a}};return q}();
TILE5.Device=function(){function q(){n={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:4,requireFastDraw:false},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,
supportsTouch:true,getScaling:function(){return 1/window.devicePixelRatio}},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true}};d=[n.froyo,n.android,n.ipod,n.iphone,n.ipad]}var n=null,d=[],b=null;return{getConfig:function(){n||q();if(!b){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var f=0;f<d.length;f++){var a=d[f];if(a.regex&&a.regex.test(navigator.userAgent)){b=GRUNT.extend({},n.base,a);GRUNT.Log.info("PLATFORM DETECTED AS: "+
b.name);break}}if(!b){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");b=n.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return b}}}();
TILE5.Resources=function(){var q="",n={},d=function(){function f(){var r=j[this.id];if(r){r.loaded=true;r.hitCount=1;for(var p=h.length;p--;)if(h[p].image.src==this.src){h.splice(p,1);break}r.loadCallback&&r.loadCallback(this,false);g.push({url:this.src,created:r.requested});delete j[this.id];a()}}function a(){for(var r=TILE5.Device.getConfig().maxImageLoads;k.length>0&&(!r||h.length<r);){var p=k.shift();h.push(p);p.image.onload=f;p.image.src=p.url;p.requested=(new Date).getTime()}}function c(){m=
true;try{var r=Math.floor(g.length*0.5);if(r>0){g.sort(function(s,t){return s.created-t.created});for(var p=r;p--;)delete e[g[p].url];g.splice(0,r)}}finally{m=false}GRUNT.WaterCooler.say("imagecache.cleared")}var e={},j={},l=0,k=[],h=[],g=[],i=0,m=false,o={loadingImages:h,queuedImages:k,getCacheFullness:function(){return i},getImage:function(r){var p=null;m||(p=e[r]);return p?p.image:null},loadImage:function(r,p){var s=e[r];if(s){s.hitCount++;s.image.complete&&p&&p(s.image,true)}else{s={url:b.getPath(r),
image:new Image,loaded:false,created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:p};s.image.id="resourceLoaderImage"+l++;e[r]=s;j[s.image.id]=s;k.push(s);a()}return s},resetLoadingQueue:function(){h=[]}};setInterval(function(){for(var r=(new Date).getTime(),p=false,s=0,t=TILE5.Device.getConfig();s<h.length;)if(r-h[s].requested>b.loadTimeout*1E3){h.splice(s,1);p=true}else s++;p&&a();if(t&&t.imageCacheMaxSize){i=g.length*b.avgImageSize/t.imageCacheMaxSize;i>=1&&c()}},1E3);return o}(),
b={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(f,a){for(var c=(f?f.replace(/^.*\?/,""):"").split("&"),e=f?f.replace(/\?.*$/,"?"):"",j=0;j<c.length;j++){var l=c[j].split("=");if(!a||!a.test(l[0]))e+=c[j]+"&"}return e.replace(/\W/g,"")},isValidCacheKey:function(f){GRUNT.Log.info("cache key = "+f);return false}}}(),getCachedUrl:function(f){return f},getPath:function(f){return/^(https?|\/)/.test(f)?f:q+f},setBasePath:function(f){q=
f},getImage:function(f){return d.getImage(f)},loadImage:function(f,a){d.loadImage(f,a)},resetImageLoadQueue:function(){d.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:d.loadingImages.length,queuedImageCount:d.queuedImages.length,imageCacheFullness:d.getCacheFullness()}},loadResource:function(f){f=GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},f);var a=function(c){f.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){f.callback(c)})};f.cacheable&&
n[f.filename]?a(n[f.filename]):GRUNT.XHR.ajax({url:b.getPath(f.filename),dataType:f.dataType,success:function(c){if(f.cacheable)n[f.filename]=c;a(c)},error:function(c,e,j){GRUNT.Log.error("error loading resource ["+f.filename+"], error = "+j)}})},loadSnippet:function(f,a){/\.\w+$/.test(f)||(f+=".html");b.loadResource({filename:"snippets/"+f,callback:a,dataType:"html"})}};return b}();
TILE5.Touch=function(){function q(l,k){var h=l&&l.length>0?l[0]:null;if(h&&k&&k.length>0)return TILE5.V.diff(h,k[0]);return null}function n(l){l.preventDefault();l.stopPropagation()}function d(l){for(var k=Array(l.length),h=l.length;h--;)k[h]=new TILE5.Vector(l[h].pageX,l[h].pageY);return k}var b={TAP:0,MOVE:1,PINCHZOOM:2},f=7,a=0,c=0,e={TouchHelper:function(l){function k(v){v=new TILE5.VectorArray(v,true);l.element&&v.applyOffset(new TILE5.Vector(-l.element.offsetLeft,-l.element.offsetTop));return v}
function h(v){var A=Array(arguments.length-1),C=0;for(C=1;C<arguments.length;C++)A[C-1]=arguments[C];for(C=D.length;C--;)D[C][v]&&D[C][v].apply(M,A)}function g(v){if(v.target&&v.target===l.element){s=p?d(v.touches):[new TILE5.Vector(v.pageX,v.pageY)];u=new TILE5.Vector;z=new TILE5.Vector;E=true;o=false;p&&n(v);G.current=TILE5.Clock.getTime();if(v=s.length>0?s[0]:null){h("touchStartHandler",v.x,v.y);if(G.current-G.last<M.THRESHOLD_DOUBLETAP)if((v=t?TILE5.V.diff(s[0],t[0]):null)&&Math.abs(v.x)<l.maxDistDoubleTap&&
Math.abs(v.y)<l.maxDistDoubleTap)o=true;y=b.TAP;t=[].concat(s)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function i(v){if(v.target&&v.target===l.element)if(E)try{p&&n(v);var A=p?d(v.touches):[new TILE5.Vector(v.pageX,v.pageY)];v=0;if(A.length>1){if(s.length===1)s=[].concat(A);v=TILE5.VectorMath.distance(s)-TILE5.VectorMath.distance(t)}if(y===b.TAP){var C=q(A,s);if(C&&(Math.abs(C.x)>=f||Math.abs(C.y)>=f))y=b.MOVE}if(y!==b.TAP)if(!v||Math.abs(v)<l.pinchZoomThreshold){if(u=
q(A,t)){z.x+=u.x;z.y+=u.y;B.x+=u.x;B.y+=u.y}if(TILE5.V.absSize(B)>l.panEventThreshhold){h("moveHandler",B.x,B.y);B=TILE5.V.create()}y=b.MOVE}else{h("pinchZoomHandler",k(s),k(A));y=b.PINCHZOOM}t=[].concat(A)}catch(J){GRUNT.Log.exception(J)}}function m(v){if(v.target&&v.target===l.element)try{p&&n(v);TILE5.Clock.getTime();G.last=G.current;if(y===b.TAP)r||(r=setTimeout(function(){r=0;var C=o?"doubleTapHandler":"tapHandler",J=s[0],P=null;if(l.element)P=TILE5.V.offset(J,-l.element.offsetLeft,-l.element.offsetTop);
h(C,J,P)},M.THRESHOLD_DOUBLETAP+50));else if(y==b.MOVE)h("moveEndHandler",z.x,z.y);else y==b.PINCHZOOM&&h("pinchZoomEndHandler",k(s),k(t))}catch(A){GRUNT.Log.exception(A)}E=false}l=GRUNT.extend({element:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},l);var o=false,r=0,p=TILE5.Device.getConfig().supportsTouch,
s=null,t=null,u=null,z=null,B=new TILE5.Vector,y=null,E=false,D=[],G={current:0,last:0},F=TILE5.Device.getConfig(),M={supportsTouch:p,THRESHOLD_DOUBLETAP:300,addListeners:function(v){D.push(v)},decoupleListeners:function(v){for(var A=0;v&&A<D.length;A++)if(D[A].listenerId===v){D.splice(A,1);GRUNT.Log.info("successfully decoupled touch listener: "+v);break}},release:function(){F.eventTarget.removeEventListener(F.supportsTouch?"touchstart":"mousedown",g,false);F.eventTarget.removeEventListener(F.supportsTouch?
"touchmove":"mousemove",i,false);F.eventTarget.removeEventListener(F.supportsTouch?"touchend":"mouseup",m,false)},wheelie:function(v){var A=new TILE5.Vector(v.wheelDeltaX,v.wheelDeltaY);v=new TILE5.Vector(v.clientX,v.clientY);var C=A.y!==0?Math.abs(A.y/120):0;if(C!==0)h("wheelZoomHandler",v,A.y>0?C+0.5:0.5/C);GRUNT.Log.info("capture mouse wheel event, delta = "+A+", position = "+v)}};F.eventTarget.addEventListener(F.supportsTouch?"touchstart":"mousedown",g,false);F.eventTarget.addEventListener(F.supportsTouch?
"touchmove":"mousemove",i,false);F.eventTarget.addEventListener(F.supportsTouch?"touchend":"mouseup",m,false);return M}},j=[];return{captureTouch:function(l,k){try{if(!l)throw Error("Unable to capture touch of null element");if(!l.id)l.id="touchable_"+a++;var h=j[l.id];if(!h){h=e.TouchHelper(GRUNT.extend({element:l},k));j[l.id]=h;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+h.supportsTouch)}k.listenerId&&h.decoupleListeners(k.listenerId);k.listenerId=++c;h.addListeners(k)}catch(g){GRUNT.Log.exception(g)}},
resetTouch:function(l){if(l&&l.id&&j[l.id]){j[l.id].release();delete j[l.id]}}}}();if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(q){return this.each(function(){TILE5.Touch.captureTouch(this,q)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(q){q.preventDefault()})}}
TILE5.Pannable=function(q){q=GRUNT.extend({container:null,onPan:null,onPanEnd:null,onAnimate:null,checkOffset:null},q);var n=false,d=new TILE5.Vector,b={pannable:true,getOffset:function(){return new TILE5.Vector(d.x,d.y)},setOffset:function(a,c){d.x=a;d.y=c},pan:function(a,c,e){if(e)b.updateOffset(d.x+a,d.y+c,e);else{b.updateOffset(d.x+a,d.y+c);q.onPan&&q.onPan(a,c)}},isAnimating:function(){return n},panEnd:function(a,c){q.onPanEnd&&q.onPanEnd(a,c)},updateOffset:function(a,c,e){if(e){a=new TILE5.Vector(a,
c);n=true;e=TILE5.Animation.tweenVector(d,a.x,a.y,e,function(){n=false;b.panEnd(0,0)});for(a=e.length;a--;){e[a].cancelOnInteract=true;e[a].requestUpdates(function(){q.onAnimate&&q.onAnimate(d.x,d.y)})}}else b.setOffset(a,c)}},f=document.getElementById(q.container);f&&TILE5.Touch.captureTouch(f,{moveHandler:function(a,c){b.pan(-a,-c)},moveEndHandler:function(a,c){b.panEnd(a,c)}});return b};
TILE5.Scalable=function(q){function n(g,i){b=g.getRect();f=i.getRect();var m=b.getSize(),o=f.getSize();l=f.getCenter();a=b&&m!==0?o/m:1}q=GRUNT.extend({container:null,onAnimate:null,onPinchZoom:null,onScale:null,scaleDamping:false},q);var d=false,b=null,f=null,a=1,c=null,e=null,j=null,l=null,k={scalable:true,animate:function(g,i,m,o,r){function p(){r&&r();d=false;q.onScale&&q.onScale(a,l);a=1;c=null}d=true;j=TILE5.V.copy(i);l=TILE5.V.copy(m);b=null;if(o){e=a;TILE5.Animation.tweenValue(0,g-e,o,p,1E3).requestUpdates(function(s){c=
s/(g-e);a=e+s;q.onAnimate&&q.onAnimate()})}else{a=g;p()}},getScaleInfo:function(){return{factor:a,startRect:TILE5.copyRect(b),endRect:TILE5.copyRect(f),start:j,center:l,progress:c}},getScaling:function(){return d},getScaleFactor:function(){return a}},h=document.getElementById(q.container);h&&TILE5.Touch.captureTouch(h,{pinchZoomHandler:function(g,i){n(g,i);(d=a!==1)&&q.onPinchZoom&&q.onPinchZoom(g,i)},pinchZoomEndHandler:function(g,i){n(g,i);d=false;q.onScale&&q.onScale(a,l,true);a=1},wheelZoomHandler:function(g){b=
f=null;l=TILE5.V.copy(g)}});return k};
TILE5.Dispatcher=function(){var q=[],n={execute:function(d){var b=n.findAction(d);GRUNT.Log.info("looking for action id: "+d+", found: "+b);if(b){var f=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+d,function(){b.execute(f)})}},findAction:function(d){for(var b=q.length;b--;)if(q[b].id==d)return q[b];return null},getRegisteredActions:function(){return[].concat(q)},getRegisteredActionIds:function(){for(var d=[],b=q.length;b--;)q[b].id&&d.push(q[b].id);return d},registerAction:function(d){d&&
d.id&&q.push(d)},Action:function(d){d=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},d);var b={id:d.id,execute:function(){d.execute&&d.execute.apply(this,arguments)},getParam:function(f){return d[f]?d[f]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",b.id,d.title,d.icon)}};d.autoRegister&&n.registerAction(b);return b},createAgent:function(d){d=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},d);var b=null,f={getName:function(){return d.name},
getParam:function(a){return d[a]},getId:function(){return GRUNT.toID(f.getName())},run:function(a,c){if(d.execute){var e=b=TILE5.Clock.getTime(true),j=d.translator?d.translator(a):a;d.execute.call(f,j,function(l,k){if(!d.trashOrphanedResults||e==b)c&&c(l,k,j)})}}};return f},runAgents:function(d,b,f){for(var a=0;a<d.length;a++)d[a].run(b,f)}};return n}();
TILE5.Messaging=function(){var q=[],n=[],d=GRUNT.newModule({id:"TILE5.messaging",requires:["TILE5.core"],STATUS:{none:0,created:1,updated:2,handled:3},send:function(b){b=GRUNT.extend({type:"",payload:{},index:0,status:d.STATUS.created,statusChange:null},b);b.index=n.push(b)-1;b=b.index;var f=b>=0&&b<n.length?n[b]:null;GRUNT.Log.info("firing message update, index = "+b+", message = "+f);for(var a=0;f&&a<q.length&&f.status!==d.STATUS.handled;){var c=q[a].processUpdate(n[b]);if(c){c=c;q[a].getId();var e=
b>=0&&b<n.length?n[b]:null;if(e){e.status=c;e.statusChange&&e.statusChange(e)}}a++}},Handler:function(b){b=GRUNT.extend({id:"",processUpdate:null},b);var f={getId:function(){return b.id},processUpdate:function(a){if(b.processUpdate)return b.processUpdate(a);return d.STATUS.none}};q.push(f);return f}});return d}();
TILE5.Animation=function(){function q(){if(b===0)b=setInterval(function(){if(f.update(TILE5.Clock.getTime())===0){clearInterval(b);b=0}},20)}var n=[],d=false,b=0,f={DURATION:2E3,tweenValue:function(a,c,e,j,l){a=new f.Tween({startValue:a,endValue:c,tweenFn:e,complete:j,duration:l});n.push(a);return a},tween:function(a,c,e,j,l,k){a=new f.Tween({target:a,property:c,endValue:e,tweenFn:j,duration:k,complete:l});n.push(a);return a},tweenVector:function(a,c,e,j,l,k){var h=[];if(a){var g=a.x==c,i=a.y==e;
g||h.push(f.tween(a,"x",c,j,function(){(g=true)&&i&&l()},k));i||h.push(f.tween(a,"y",e,j,function(){i=true;g&&i&&l()},k))}return h},cancel:function(a){if(!d){d=true;try{for(var c=0;c<n.length;)if(!a||a(n[c])){GRUNT.Log.info("CANCELLING ANIMATION");n[c].triggerComplete(true);n.splice(c,1)}else c++}finally{d=false}}},isTweening:function(){return n.length>0},update:function(a){if(d)return n.length;d=true;try{for(var c=0;c<n.length;)if(n[c].isComplete()){n[c].triggerComplete(false);n.splice(c,1);GRUNT.WaterCooler.say("animation.complete")}else{n[c].update(a);
c++}}finally{d=false}return n.length},Tween:function(a){a=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:f.DURATION,tweenFn:f.DEFAULT,complete:null,cancelOnInteract:false},a);var c=TILE5.Clock.getTime(),e=[],j=false,l=0,k=0,h={cancelOnInteract:a.cancelOnInteract,isComplete:function(){return j},triggerComplete:function(g){a.complete&&a.complete(g)},update:function(g){try{var i=a.tweenFn(g-c,l,k,a.duration);if(a.target)a.target[a.property]=i;for(var m=e.length;m--;)e[m](i,
void 0);if(j=c+a.duration<=g){if(a.target)a.target[a.property]=a.tweenFn(a.duration,l,k,a.duration);for(var o=e.length;o--;)e[o](i,true)}}catch(r){GRUNT.Log.exception(r)}},requestUpdates:function(g){e.push(g)}};l=a.target&&a.property&&a.target[a.property]?a.target[a.property]:a.startValue;if(typeof a.endValue!=="undefined")k=a.endValue-l;if(k==0)j=true;q();return h},Easing:function(){var a=1.70158;return{Linear:function(c,e,j,l){return j*c/l+e},Back:{In:function(c,e,j,l){return j*(c/=l)*c*((a+1)*
c-a)+e},Out:function(c,e,j,l){return j*((c=c/l-1)*c*((a+1)*c+a)+1)+e},InOut:function(c,e,j,l){return(c/=l/2)<1?j/2*c*c*(((a*=1.525)+1)*c-a)+e:j/2*((c-=2)*c*(((a*=1.525)+1)*c+a)+2)+e}},Bounce:{In:function(c,e,j,l){return j-f.Easing.Bounce.Out(l-c,0,j,l)+e},Out:function(c,e,j,l){return(c/=l)<1/2.75?j*7.5625*c*c+e:c<2/2.75?j*(7.5625*(c-=1.5/2.75)*c+0.75)+e:c<2.5/2.75?j*(7.5625*(c-=2.25/2.75)*c+0.9375)+e:j*(7.5625*(c-=2.625/2.75)*c+0.984375)+e},InOut:function(c,e,j,l){return c<l/2?f.Easing.Bounce.In(c*
2,0,j,l)*0.5+e:f.Easing.Bounce.Out(c*2-l,0,j,l)*0.5+j*0.5+e}},Cubic:{In:function(c,e,j,l){return j*(c/=l)*c*c+e},Out:function(c,e,j,l){return j*((c=c/l-1)*c*c+1)+e},InOut:function(c,e,j,l){if((c/=l/2)<1)return j/2*c*c*c+e;return j/2*((c-=2)*c*c+2)+e}},Elastic:{In:function(c,e,j,l,k,h){if(c==0)return e;if((c/=l)==1)return e+j;h||(h=l*0.3);if(!k||k<Math.abs(j)){k=j;j=h/4}else j=h/(2*Math.PI)*Math.asin(j/k);return-(k*Math.pow(2,10*(c-=1))*Math.sin((c*l-j)*2*Math.PI/h))+e},Out:function(c,e,j,l,k,h){var g;
if(c==0)return e;if((c/=l)==1)return e+j;h||(h=l*0.3);if(!k||k<Math.abs(j)){k=j;g=h/4}else g=h/(2*Math.PI)*Math.asin(j/k);return k*Math.pow(2,-10*c)*Math.sin((c*l-g)*2*Math.PI/h)+j+e},InOut:function(c,e,j,l,k,h){var g;if(c==0)return e;if((c/=l/2)==2)return e+j;h||(h=l*0.3*1.5);if(!k||k<Math.abs(j)){k=j;g=h/4}else g=h/(2*Math.PI)*Math.asin(j/k);if(c<1)return-0.5*k*Math.pow(2,10*(c-=1))*Math.sin((c*l-g)*2*Math.PI/h)+e;return k*Math.pow(2,-10*(c-=1))*Math.sin((c*l-g)*2*Math.PI/h)*0.5+j+e}},Quad:{In:function(c,
e,j,l){return j*(c/=l)*c+e},Out:function(c,e,j,l){return-j*(c/=l)*(c-2)+e},InOut:function(c,e,j,l){if((c/=l/2)<1)return j/2*c*c+e;return-j/2*(--c*(c-2)-1)+e}},Sine:{In:function(c,e,j,l){return-j*Math.cos(c/l*(Math.PI/2))+j+e},Out:function(c,e,j,l){return j*Math.sin(c/l*(Math.PI/2))+e},InOut:function(c,e,j,l){return-j/2*(Math.cos(Math.PI*c/l)-1)+e}}}}()};return GRUNT.extend(f,{DEFAULT:f.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var q={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},n=0,d={DisplayState:q,AnyDisplayState:255,ActiveDisplayStates:q.ACTIVE|q.ANIMATING,DefaultDisplayStates:q.ACTIVE|q.ANIMATING|q.PAN|q.PINCHZOOM,ViewLayer:function(b){b=GRUNT.extend({centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:d.DefaultDisplayStates},b);var f=null,a="",c=GRUNT.extend({isAnimating:function(){return false},addToView:function(e){e.setLayer(a,
c)},shouldDraw:function(e){var j=f?f.fastDraw&&e!==q.ACTIVE:false;return(e&b.validStates)!==0&&(j?b.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},notify:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:a})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:f?f.id:null})},getId:function(){return a},setId:function(e){a=e},getParent:function(){return f},setParent:function(e){f=e}},b);return c},StatusViewLayer:function(){return new d.ViewLayer({validStates:d.AnyDisplayState,
zindex:5E3,draw:function(b,f,a,c,e){b.fillStyle="#FF0000";b.fillRect(10,10,50,50);b.fillStyle="#FFFFFF";b.font="bold 10px sans";b.fillText(e.getDisplayState(),20,20)}})},AnimatedPathLayer:function(b){function f(k,h,g){k.fillStyle="#FFFFFF";k.strokeStyle="#222222";k.beginPath();k.arc(g.x,g.y,4,0,Math.PI*2,false);k.stroke();k.fill()}b=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,canCache:false,validStates:d.ActiveDisplayStates|q.PAN|q.PINCHZOOM,
drawIndicator:null,duration:2E3,autoCenter:false},b);var a=TILE5.VectorMath.edges(b.path),c,e=null,j=0;TILE5.Animation.tweenValue(0,a.total,b.easing,function(){l.remove()},b.duration).requestUpdates(function(k,h){j=k;h&&l.remove()});var l=GRUNT.extend(new d.ViewLayer(b),{cycle:function(){for(var k=0;k<a.accrued.length&&a.accrued[k]<j;)k++;e=null;if(k<b.path.length-1){var h=j-(k>0?a.accrued[k-1]:0),g=b.path[k],i=b.path[k+1];c=TILE5.VectorMath.theta(g,i,a.edges[k]);e=TILE5.VectorMath.pointOnEdge(g,
i,c,h);if(b.autoCenter)(k=l.getParent())&&k.centerOn(e)}return e?1:0},draw:function(k,h){if(e)(b.drawIndicator?b.drawIndicator:f)(k,h,new TILE5.Vector(e.x-h.x,e.y-h.y),c)}});return l},FPSLayer:function(b){b=GRUNT.extend({zindex:1E3,scalePosition:false},b);var f=null,a=GRUNT.extend(new d.ViewLayer(b),{delays:[],draw:function(c,e,j){c.font="bold 8pt Arial";c.textAlign="right";c.fillStyle="rgba(0, 0, 0, 0.8)";c.fillText((f?f:"?")+" fps",j.width-20,20)}});setInterval(function(){for(var c=0,e=a.delays.length,
j=e;j--;)c+=a.delays[j];if(e!==0)f=Math.floor(1E3/(c/e))},1E3);return a},ResourceStatsLayer:function(b){b=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:q.ACTIVE|q.PAN},b);return GRUNT.extend(new d.ViewLayer(b),{fps:null,draw:function(f){var a=TILE5.Resources.getStats(),c=b.indicatorSize,e=10,j;if(a.imageCacheFullness){f.strokeStyle="rgba(0, 0, 255, 1)";f.beginPath();f.arc(15,15,5,0,Math.PI*2*a.imageCacheFullness,false);f.stroke();e=30}if(a.imageLoadingCount>=0){f.fillStyle=
"rgba(0, 255, 0, 0.7)";for(j=a.imageLoadingCount;j--;)f.fillRect(e+j*(c+2),10,c,c)}if(a.queuedImageCount>=0){f.fillStyle="rgba(255, 0, 0, 0.7)";for(j=a.queuedImageCount;j--;)f.fillRect(e+j*(c+2),10+c+2,c,c)}}})},LoadingLayer:function(b){GRUNT.extend({},b)},View:function(b){function f(w,x){x.setId(w);x.setParent(H);l.push(x);l.sort(function(I,K){var L=K.zindex-I.zindex;if(L===0)L=K.created-I.created;return L})}function a(){GRUNT.WaterCooler.say("view-idle",{id:H.id});F=true;v=0}function c(w,x){var I=
0,K=H.getScaleFactor(),L=H.getDisplayState(),T=(new Date).getTime(),R=(L&q.PINCHZOOM)!==0;m=H.getScaleFactor();var Q=0;if(i||R){w.clearRect(0,0,k.width,k.height);i=false}if(R){var N=G.getScaleInfo();H.getDimensions().getCenter();var O=(N.progress?N.progress:1)*0.5;E=N.center;if(N.startRect){O=N.startRect.getCenter();O=TILE5.V.diff(O,E);A=new TILE5.Vector(E.x+O.x,E.y+O.y)}else{N=TILE5.V.diff(N.start,E);A=new TILE5.Vector(E.x-N.x*O,E.y-N.y*O)}if(A)x=TILE5.V.offset(x,A.x,A.y)}w.save();try{if(s!==1)w.scale(s,
s);else if(R){w.translate(E.x,E.y);w.scale(K,K)}for(Q=l.length;Q--;)if(l[Q].shouldDraw(L)){var S=l[Q].draw(w,x,u,L,H);I+=S?S:0}}finally{w.restore()}GRUNT.Log.trace("draw complete",T);return I}function e(){var w=0,x=J===q.PINCHZOOM||J===q.PAN;C=(new Date).getTime();g=D?D.getOffset():new TILE5.Vector;y&&o&&y.delays.push(C-o);if(x){TILE5.Animation.cancel(function(K){return K.cancelOnInteract});F=false;if(v!==0){clearTimeout(v);v=0}}for(x=l.length;x--;){var I=l[x].cycle(C,g);w+=I?I:0}w+=c(h,g);o=C;M=
0;if(B+w>0)j();else if(!F&&v===0)v=setTimeout(a,500);GRUNT.Log.trace("Completed draw cycle",C)}function j(){B++;if(!(p||M!==0)){B=0;M=setTimeout(e,0)}}b=GRUNT.extend({id:"view_"+n++,container:"",pannable:false,scalable:false,clearOnDraw:false,displayFPS:false,displayResourceStats:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,onPan:null,onPinchZoom:null,onScale:null,onDraw:null,autoSize:false},b);var l=
[],k=document.getElementById(b.container),h=null,g=new TILE5.Vector,i=false,m=1,o=null,r=0,p=false,s=1,t=new TILE5.Vector,u=null,z=null,B=0,y=null,E=null,D=null,G=null,F=false,M=0,v=0,A=null,C=0,J=d.DisplayState.ACTIVE;GRUNT.Log.info("Creating a new view instance, attached to container: "+b.container+", canvas = ",k);if(k){TILE5.Touch.resetTouch(k);if(b.autoSize){GRUNT.Log.info("autosizing view: window.height = "+window.innerHeight+", width = "+window.innerWidth);k.height=window.innerHeight-k.offsetTop;
k.width=window.innerWidth-k.offsetLeft}try{h=k.getContext("2d");h.globalCompositeOperation=b.initialDrawMode;h.clearRect(0,0,k.width,k.height)}catch(P){GRUNT.Log.exception(P);throw Error("Could not initialise canvas on specified view element");}}if(b.pannable)D=new TILE5.Pannable({container:b.container,onAnimate:function(){j()},onPan:function(w,x){r=TILE5.Clock.getTime(true);j();t=TILE5.V.offset(t,w,x);b.onPan&&b.onPan(w,x);J=q.PAN},onPanEnd:function(){j();J=q.ACTIVE}});if(b.scalable)G=new TILE5.Scalable({scaleDamping:b.scaleDamping,
container:b.container,onAnimate:function(){J=d.DisplayState.PINCHZOOM;j()},onPinchZoom:function(w,x){r=TILE5.Clock.getTime(true);j();b.onPinchZoom&&b.onPinchZoom(w,x);J=d.DisplayState.PINCHZOOM},onScale:function(w,x){GRUNT.WaterCooler.say("view.scale",{id:H.id});J=d.DisplayState.ACTIVE;j();b.onScale&&b.onScale(w,x)}});var H=GRUNT.extend({},b,D,G,{id:b.id,deviceScaling:s,fastDraw:b.fastDraw||TILE5.Device.getConfig().requireFastDraw,centerOn:function(w){D.setOffset(w.x-k.width*0.5,w.y-k.height*0.5)},
getDimensions:function(){if(k)return new TILE5.Dimensions(k.width,k.height)},getZoomCenter:function(){return A},getLayer:function(w){for(var x=0;x<l.length;x++)if(l[x].getId()==w)return l[x];return null},setLayer:function(w,x){for(var I=0;I<l.length;I++)if(l[I].getId()===w){l.splice(I,1);break}x&&f(w,x);GRUNT.WaterCooler.say("layer.update",{value:x});j()},eachLayer:function(w){for(var x=0;x<l.length;x++)w(l[x])},clearBackground:function(){i=true},freeze:function(){p=true},unfreeze:function(){p=false;
j()},snapshot:function(){},getDisplayState:function(){return p?q.FROZEN:J},scale:function(w,x,I,K,L){K||(K=H.getDimensions().getCenter());L||(L=H.getDimensions().getCenter());G&&G.animate(w,K,L,x,I);return G},removeLayer:function(w){a:{for(var x=l.length;x--;)if(l[x].getId()==w){w=x;break a}w=-1}if(w>=0&&w<l.length){GRUNT.WaterCooler.say("layer.removed",{layer:l[w]});l.splice(w,1)}}});u=H.getDimensions();z=u.getCenter();GRUNT.WaterCooler.listen("layer.remove",function(w){w.id&&H.removeLayer(w.id)});
GRUNT.WaterCooler.listen("view.wake",function(w){if(!w.id||w.id===H.id)j()});s=TILE5.Device.getConfig().getScaling();if(b.displayFPS){y=new d.FPSLayer;H.setLayer("fps",y)}b.displayResourceStats&&H.setLayer("resourceStats",new d.ResourceStatsLayer);j();return H}};return d}();
TILE5.Tiling=function(){function q(){if(!d){d=document.createElement("canvas");d.width=f.Config.TILESIZE;d.height=f.Config.TILESIZE;var a=d.getContext("2d");a.fillStyle="rgba(150, 150, 150, 0.05)";a.fillRect(0,0,d.width,d.height)}return d}function n(){if(!b){b=document.createElement("canvas");b.width=f.Config.TILESIZE;b.height=f.Config.TILESIZE;var a=b.getContext("2d"),c=Math.sqrt(f.Config.TILESIZE);a.fillStyle="rgba(200, 200, 200, 1)";a.strokeStyle="rgb(190, 190, 190)";a.lineWidth=0.5;a.fillRect(0,
0,b.width,b.height);a.beginPath();for(var e=0;e<b.width;e+=c){a.moveTo(e,0);a.lineTo(e,b.height);for(var j=0;j<b.height;j+=c){a.moveTo(0,j);a.lineTo(b.width,j)}}a.stroke()}return b}TileStore=function(a){a=GRUNT.extend({gridSize:20,center:new TILE5.Vector,onPopulate:null},a);var c=Array(Math.pow(a.gridSize,2)),e=TILE5.V.offset(a.center,-Math.ceil(a.gridSize>>1)),j=null,l=new TILE5.Vector,k=null,h={getGridSize:function(){return a.gridSize},getNormalizedPos:function(g,i){return TILE5.V.add(new TILE5.Vector(g,
i),TILE5.V.invert(e),l)},getTileShift:function(){return TILE5.V.copy(l)},getTile:function(g,i){return g>=0&&g<a.gridSize?c[i*a.gridSize+g]:null},setTile:function(g,i,m){c[i*a.gridSize+g]=m},populate:function(g,i){var m=GRUNT.Log.getTraceTicks(),o=0;new TILE5.Vector(a.gridSize*0.5,a.gridSize*0.5);if(g)for(var r=0;r<a.gridSize;r++)for(var p=0;p<a.gridSize;p++){if(!c[o]){var s=g(p,r,e,a.gridSize);c[o]=s}o++}j=g;k=i;GRUNT.Log.trace("tile grid populated",m);a.onPopulate&&a.onPopulate()},getShiftDelta:function(g,
i,m,o){var r=Math.floor(a.gridSize*0.2),p=new TILE5.Vector;if(g<0||g+m>a.gridSize)p.x=g<0?-r:r;if(i<0||i+o>a.gridSize)p.y=i<0?-r:r;return p},shift:function(g,i){if(!(g.x===0&&g.y===0)){var m=GRUNT.Log.getTraceTicks(),o=Array(c.length);o.length=c.length;for(var r=0;r<a.gridSize;r++)for(var p=0;p<a.gridSize;p++)o[p*a.gridSize+r]=h.getTile(r+g.x,p+g.y);c=o;e=i?i(e,g):TILE5.V.add(e,g);l.x+=-g.x*a.tileSize;l.y+=-g.y*a.tileSize;GRUNT.Log.trace("tile storage shifted",m);h.populate(j,k)}},setOrigin:function(g,
i){if(tileOrigin)shiftOrigin(g,i);else e=TILE5.V.offset(new TILE5.Vector(g,i),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var g=c.length;g--;)if(c[g])c[g].loaded=false});return h};var d=null,b=null,f={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(a){return a=GRUNT.extend({x:0,y:0,size:256},a)},ImageTile:function(a){a=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},a);return new f.Tile(a)},TileGrid:function(a){function c(s,t,u,
z){if((k?TILE5.V.absSize(TILE5.V.diff(k,t)):j)>=20){s=e.getTileShift();s=new TILE5.Vector(Math.floor((t.x+s.x)*l),Math.floor((t.y+s.y)*l));var B=Math.ceil(u.width*l)+1;u=Math.ceil(u.height*l)+1;var y=new TILE5.Vector((B-1)*0.5,(u-1)*0.5),E=new TILE5.Vector(s.x*a.tileSize,s.y*a.tileSize);z.isAnimating();i=[];tilesNeeded=false;for(var D=u;D--;)for(var G=D*a.tileSize+E.y,F=B;F--;){z=e.getTile(F+s.x,D+s.y);var M=F*a.tileSize+E.x,v=new TILE5.Vector(F-y.x,D-y.y);z||(o=e.getShiftDelta(s.x,s.y,B,u));i.push({tile:z,
coordinates:new TILE5.Vector(M,G),centerness:TILE5.V.absSize(v)})}i.sort(function(A,C){return C.centerness-A.centerness});k=TILE5.V.copy(t)}}a=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true,checkChange:100},a);var e=new TileStore(GRUNT.extend({onPopulate:function(){h=true;p.wakeParent()}},a)),j=Math.round(a.tileSize>>1),l=a.tileSize?1/a.tileSize:0,k=null,h=false,g=true,i=[],m=false;new TILE5.Vector;var o=new TILE5.Vector,
r=e.getGridSize()*a.tileSize,p=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{gridDimensions:new TILE5.Dimensions(r,r),cycle:function(){var s=0;if(o.x+o.y!==0){e.shift(o,a.shiftOrigin);o=new TILE5.Vector;s++}return s+h?1:0},deactivate:function(){g=false},drawTile:function(){return false},draw:function(s,t,u,z,B){if(g){var y=GRUNT.Log.getTraceTicks(),E=e.getTileShift(),D=t.x+E.x;E=t.y+E.y;var G=true;if(z!==TILE5.Graphics.DisplayState.PINCHZOOM){c(s,t,u,B);GRUNT.Log.trace("updated draw queue",y)}if(a.drawGrid)s.strokeStyle=
"rgba(50, 50, 50, 0.3)";s.beginPath();for(t=i.length;t--;){u=i[t].tile;B=i[t].coordinates.x-D;var F=i[t].coordinates.y-E;if(u){G=p.drawTile(s,u,B,F,z)&&G;u.x=B;u.y=F}else G=false;a.drawGrid&&s.rect(B,F,a.tileSize,a.tileSize)}s.stroke();GRUNT.Log.trace("drawn tiles",y);G&&!m&&GRUNT.WaterCooler.say("tiles.drawn",{id:p.getId()});m=G;h=false}},getTileSize:function(){return a.tileSize},getTileVirtualXY:function(s,t,u){s=e.getNormalizedPos(s,t);s=new TILE5.Vector(s.x*a.tileSize,s.y*a.tileSize);if(u){s.x+=
j;s.y+=j}return s},getCenterXY:function(){var s=Math.ceil(e.getGridSize()>>1);return p.getTileVirtualXY(s,s,true)},populate:function(s){e.populate(s,function(){})}});GRUNT.WaterCooler.listen("tile.loaded",function(){h=true;p.wakeParent()});return p},ImageTileGrid:function(a){function c(){GRUNT.WaterCooler.say("tile.loaded")}a=GRUNT.extend({},a);return GRUNT.extend(new f.TileGrid(a),{drawTile:function(e,j,l,k,h){var g=TILE5.Resources.getImage(j.url),i=false;h===TILE5.Graphics.DisplayState.PAN&&e.drawImage(n(),
l,k);if(g&&g.complete&&g.width>0){e.drawImage(g,l,k);i=true}else{e.drawImage(q(),l,k);g||TILE5.Resources.loadImage(j.url,c)}return i}})},Tiler:function(a){a=GRUNT.extend({container:"",drawCenter:false,onPan:null,onPanEnd:null,tapHandler:null,doubleTapHandler:null,zoomHandler:null,onDraw:null,datasources:{},tileLoadThreshold:"first"},a);var c=new TILE5.Graphics.View(GRUNT.extend({},a,{pannable:true,scalable:true,scaleDamping:true}));TILE5.Touch.captureTouch(document.getElementById(a.container),a);
GRUNT.extend(c,{getTileLayer:function(){return c.getLayer("grid0")},setTileLayer:function(e){c.setLayer("grid0",e);GRUNT.WaterCooler.say("grid.updated",{grid:e})},gridPixToViewPix:function(e){var j=c.getOffset();return new TILE5.Vector(e.x-j.x,e.y-j.y)},viewPixToGridPix:function(e){var j=c.getOffset();return new TILE5.Vector(e.x+j.x,e.y+j.y)},cleanup:function(){c.removeLayer("grid0")}});return c}};return f}();
TILE5.Geo=function(){function q(h,g){var i=null;for(var m in l)if(g){if(m==g&&l[m][h]){i=l[m];break}}else if(l[m][h]){i=l[m];break}return i}function n(h,g,i,m){var o=0;h=h.toUpperCase();for(var r in m){var p=g[r];if(p){var s=i[r];p=s?s(h,p):h.containsWord(p)?1:0;o+=p*m[r]}}return o}var d=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],b=Math.PI/180,f=180/Math.PI,a=/(\d+)\s?\-\s?(\d+)/,c=/^(\d+).*$/,e=null,j={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",
CT:"COURT",LN:"LANE",HWY:"HIGHWAY",MWY:"MOTORWAY"},l={},k={Engine:function(h){if(!h.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var g=GRUNT.extend({remove:function(){delete l[g.id]}},h);return l[g.id]=g},getEngine:function(h){for(var g=null,i=1;!g&&i<arguments.length;i++)g=q(h,arguments[i]);g=g?g:q(h);if(!g)throw Error("Unable to find GEO engine with "+h+" capability");return g},Radius:function(h,g){return{distance:parseInt(h,10),uom:g}},Position:function(h,g){return{lat:parseFloat(h?
h:0),lon:parseFloat(g?g:0)}},BoundingBox:function(h,g){var i={min:k.P.parse(h),max:k.P.parse(g),expand:function(m){i.min.lat-=m;i.min.lon-=k.Utilities.normalizeLon(m);i.max.lat+=m;i.max.lon+=k.Utilities.normalizeLon(m)},getDistance:function(){return k.P.calcDistance(i.min,i.max)},getCenter:function(){var m=k.calculateBoundsSize(i.min,i.max);return new TILE5.Geo.Position(i.min.lat+m.y*0.5,i.min.lon+m.x*0.5)},transform:function(m){var o=new TILE5.Geo.BoundingBox(i.min,i.max);GRUNT.Log.info("applying "+
m.length+" transformers");for(var r=0;m&&r<m.length;r++)m[r].apply(o);return o}};return i},Transforms:function(){return{Shrink:function(){return function(){}},Offset:function(){return function(){}}}}(),Address:function(h){h=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",pos:null,boundingBox:null},h);return GRUNT.extend(h,{getPos:function(){return h.pos},toString:function(){return h.streetDetails+" "+h.location}})},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},
Utilities:function(){var h={lat2pix:function(g,i){var m=parseFloat(g)*2*Math.PI/360;m=Math.sin(m);var o=0.08181919084262157*m;return Math.log((1+m)/(1-m)*Math.pow((1-o)/(1+o),0.08181919084262157))/2/i},lon2pix:function(g,i){return parseFloat(g)/180*Math.PI/i},pix2lon:function(g,i){return h.normalizeLon(g*i*180/Math.PI)},pix2lat:function(g,i){for(var m=Math.pow(Math.E,-g*i),o=h.mercatorUnproject(m),r=h.findRadPhi(o,m),p=0;p<12&&Math.abs(o-r)>1.0E-7;){o=r;r=h.findRadPhi(o,m);p++}return r*180/Math.PI},
mercatorUnproject:function(g){return Math.PI/2-2*Math.atan(g)},findRadPhi:function(g,i){var m=0.08181919084262157*Math.sin(g);return Math.PI/2-2*Math.atan(i*Math.pow((1-m)/(1+m),0.040909595421310785))},normalizeLon:function(g){for(;g<-180;)g+=360;for(;g>180;)g-=360;return g}};return h}(),GeoSearchResult:function(h){h=GRUNT.extend({id:null,caption:"",resultType:"",data:null,pos:null,matchWeight:0},h);return GRUNT.extend(h,{toString:function(){return h.caption+(h.matchWeight?" ("+h.matchWeight+")":
"")}})},GeoSearchAgent:function(h){h=GRUNT.extend({},h);return GRUNT.extend({},TILE5.Dispatcher.createAgent(h))},GeocodingAgent:function(h){h=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(g,i){try{if(!g.reverse&&!g.freeform)address=new k.Address(g);var m=k.getEngine("geocode");if(m)m.geocode({addresses:[g.freeform?g.freeform:address],complete:function(r,p){if(i){var s=p;if(g.freeform)s=k.rankGeocodeResponses(g.freeform,s,k.getEngine("geocode"));i(s,h)}}})}catch(o){GRUNT.Log.exception(o)}}},
h);return new k.GeoSearchAgent(h)},PointOfInterest:function(h){h=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},h);if(!h.pos&&h.lat&&h.lon)h.pos=new TILE5.Geo.Position(h.lat,h.lon);return GRUNT.extend({toString:function(){return h.id+": '"+h.title+"'"}},h)},POIStorage:function(h){function g(s){s=s?s:"default";o[s]||(o[s]=[]);return o[s]}function i(s){var t=[];for(var u in o)for(var z=0;z<o[u].length;z++)if(!s||s(o[u][z]))t.push(o[u][z]);return t}function m(){GRUNT.WaterCooler.say("geo.pois-updated",
{srcID:p.id,pois:p.getPOIs()})}h=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},h);var o={},r=true,p={id:GRUNT.generateObjectID(),getPOIs:function(){return i()},getOldPOIs:function(s,t){return i(function(u){return u.group==s&&u.retrieved<t})},getVisible:function(){return r},setVisible:function(s){if(s!=r){r=s;h.visibilityChange&&h.visibilityChange()}},findById:function(s){var t=i(function(u){return u.id==s});return t.length>0?t[0]:null},findByBounds:function(s){return i(function(t){return TILE5.Geo.posInBounds(t.pos,
s)})},addPOIs:function(s,t){if(t)o={};for(var u=0;s&&u<s.length;u++){s[u].retrieved=TILE5.Clock.getTime(true);var z=s[u];g(z.group).push(z)}},removeGroup:function(s){if(o[s]){delete o[s];m()}},update:function(s){var t=[],u=0,z=s.length>0?s[0].group:"",B=TILE5.Clock.getTime(true);for(u=0;u<s.length;u++){var y;a:{if(y=s[u])for(var E=g(y.group),D=0;D<E.length;D++)if(E[D].id==y.id){y=E[D];break a}y=null}if(y){y.retrieved=B;y.isNew=false}else t.push(s[u])}s=p.getOldPOIs(z,B);p.addPOIs(t);for(u=0;h.onPOIAdded&&
u<t.length;u++)h.onPOIAdded(t[u]);for(u=0;u<s.length;u++){h.onPOIDeleted&&h.onPOIDeleted(s[u]);z=s[u];B=g(z.group);for(y=0;y<B.length;y++)if(B[y].id==z.id){B.splice(y,1);break}}t.length+s.length>0&&m()}};return p},MapProvider:function(){return{zoomLevel:0,checkZoomLevel:function(h){return h},getCopyright:function(){},getMapTiles:function(){},getPositionForXY:function(){return null}}},P:function(){var h={calcDistance:function(g,i){if(h.empty(g)||h.empty(i))return 0;var m=(i.lat-g.lat).toRad()*0.5,
o=(i.lon-g.lon).toRad()*0.5;m=Math.sin(m)*Math.sin(m)+Math.cos(g.lat.toRad())*Math.cos(i.lat.toRad())*Math.sin(o)*Math.sin(o);return 6371*2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m))},copy:function(g){return g?new k.Position(g.lat,g.lon):null},empty:function(g){return!g||g.lat===0&&g.lon===0},equal:function(g,i){return g&&i&&g.lat==i.lat&&g.lon==i.lon},almostEqual:function(g,i){return g&&i&&Math.floor(g.lat*1E3)===Math.floor(i.lat*1E3)&&Math.floor(g.lon*1E3)===Math.floor(i.lon*1E3)},inArray:function(g,
i){for(var m=k.P.equal,o=i.length;o--;)if(m(g,i[o]))return true;return false},parse:function(g){if(g)if(typeof g.lat!=="undefined")return h.copy(g);else{if(g.split)for(var i=[" ",","],m=0;m<i.length;m++){var o=g.split(i[m]);if(o.length===2)return new k.Position(o[0],o[1])}}else return new k.Position;return null},parseArray:function(g){var i=g.length,m=Array(i);for(i=i;i--;)m[i]=h.parse(g[i]);GRUNT.Log.info("parsed "+m.length+" positions");return m},fromMercatorPixels:function(g,i,m){return new k.Position(TILE5.Geo.Utilities.pix2lat(i,
m),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(g,m)))},toMercatorPixels:function(g,i){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(g.lon,i),TILE5.Geo.Utilities.lat2pix(g.lat,i))},toString:function(g){return g?g.lat+" "+g.lon:""}};return h}(),B:function(){var h=-(Math.PI/2),g=Math.PI/2,i=-Math.PI*2,m=Math.PI*2;return{createBoundsFromCenter:function(o,r){var p=r/6371,s=o.lat*b,t=o.lon*b,u=s-p,z=s+p;GRUNT.Log.info("rad distance = "+p);GRUNT.Log.info("rad lat = "+s+", lon = "+
t);GRUNT.Log.info("min lat = "+u+", max lat = "+z);if(u>h&&z<g){s=Math.asin(Math.sin(p)/Math.cos(s));p=t-s;if(p<i)p+=2*Math.PI;t=t+s;if(t>m)t-=2*Math.PI}else{u=Math.max(u,h);z=Math.min(z,g);p=i;t=m}return new k.BoundingBox(new k.Position(u*f,p*f),new k.Position(z*f,t*f))},toString:function(o){return"min: "+k.P.toString(o.min)+", max: "+k.P.toString(o.max)}}}(),generalizePositions:function(h,g,i){var m=h.length,o=[],r=null;i||(i=250);i/=1E3;GRUNT.Log.info("generalizing positions, must include "+g.length+
" positions");for(var p=m;p--;)if(p===0)o.unshift(h[p]);else{var s=!r||k.P.inArray(h[p],g)?i:k.P.calcDistance(r,h[p]);if(h[p]&&s>=i){o.unshift(h[p]);r=h[p]}}GRUNT.Log.info("generalized "+m+" positions into "+o.length+" positions");return o},emptyBounds:function(h){return!h||k.P.empty(h.min)||k.P.empty(h.max)},posInBounds:function(h,g){var i=!(k.P.empty(h)||k.P.empty(g));return i=(i=i&&h.lat>=g.min.lat&&h.lat<=g.max.lat)&&h.lon>=g.min.lon&&h.lon<=g.max.lon},calculateBoundsSize:function(h,g,i){var m=
new TILE5.Vector(0,g.lat-h.lat);if(typeof i==="undefined")i=true;m.x=i&&h.lon>g.lon?360-h.lon+g.lon:g.lon-h.lon;return m},getBoundingBoxZoomLevel:function(h,g){var i=h.getCenter();i=d[Math.min(Math.round(Math.abs(i.lat)*0.05),d.length)];var m=k.calculateBoundsSize(h.min,h.max);return Math.min(Math.ceil(Math.log(d[3]*g.height/m.y)/Math.log(2)),Math.ceil(Math.log(i*g.width/m.x)/Math.log(2)))},getBoundsForPositions:function(h,g){var i=null,m=TILE5.Clock.getTime();g||(g="auto");for(var o=h.length;o--;)if(i){var r=
k.calculateBoundsSize(i.min,h[o],false),p=k.calculateBoundsSize(h[o],i.max,false);if(r.x<0)i.min.lon=h[o].lon;if(r.y<0)i.min.lat=h[o].lat;if(p.x<0)i.max.lon=h[o].lon;if(p.y<0)i.max.lat=h[o].lat}else i=new TILE5.Geo.BoundingBox(h[o],h[o]);if(g){if(g=="auto"){o=k.calculateBoundsSize(i.min,i.max);g=Math.max(o.x,o.y)*0.3}i.expand(g)}GRUNT.Log.trace("calculated bounds for "+h.length+" positions",m);return i},normalizeAddress:function(h){if(!h)return"";h=h.toUpperCase();if(!e){var g=[];for(var i in j)g.push(i);
e=RegExp("(\\s)("+g.join("|")+")(\\s|$)","i")}e.lastIndex=-1;if(g=e.exec(h))h=h.replace(e,"$1"+j[g[2]]);return h},buildingMatch:function(h,g){c.lastIndex=-1;if(c.test(h))for(var i=h.replace(c,"$1"),m=g.split(","),o=0;o<m.length;o++){a.lastIndex=-1;if(a.test(m[o])){var r=a.exec(m[o]);if(i>=parseInt(r[1],10)&&i<=parseInt(r[2],10))return true}else if(i==m[o])return true}return false},rankGeocodeResponses:function(h,g,i){var m=[],o=k.AddressCompareFns;if(i&&i.compareFns)o=GRUNT.extend({},o,i.compareFns);
for(i=0;i<g.length;i++)m.push(new k.GeoSearchResult({caption:g[i].toString(),data:g[i],pos:g[i].pos,matchWeight:n(h,g[i],o,k.GeocodeFieldWeights)}));m.sort(function(r,p){return p.matchWeight-r.matchWeight});return m}};return k}();
TILE5.Geo.Location=function(){function q(b){function f(k){try{var h=new TILE5.Geo.Position(k.coords.latitude,k.coords.longitude),g=GRUNT.isPlainObject(k.coords.accuracy)&&k.coords.accuracy.horizontal?k.coords.accuracy.horizontal:k.coords.accuracy;GRUNT.Log.info("got position coordinates: "+h+", accuracy = "+g);if(b.successCallback&&(!j||g<l))b.successCallback(h,e,k);if(g>b.highAccuracyCutoff&&e<2){e=2;b.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");
c()}j=k;l=g}catch(i){GRUNT.Log.exception(i)}}function a(k){if(k.code===k.PERMISSION_DENIED)b.errorCallback&&b.errorCallback(k);else if(k.code===k.POSITION_UNAVAILABLE)b.errorCallback&&b.errorCallback(k);else if(k.code===k.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(b.timeout===0&&b.autoPhasing){e=1;b.timeout=n;b.enableHighAccuracy=false;c()}}}function c(){navigator.geolocation.getCurrentPosition(f,a,b)}b=GRUNT.extend({autoPhasing:true,maximumAge:3E5,timeout:0,
highAccuracyCutoff:10,enableHighAccuracy:true,successCallback:null,errorCallback:null},b);var e=0,j=null,l=1E6;c()}var n=3E3,d={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)d.get=q;return d}();TILE5.Geo.Search=function(){return{bestResults:function(q,n){n||(n=20);for(var d=q.length>0?q[0]:null,b=[],f=0;f<q.length;f++)if(d.matchWeight-q[f].matchWeight<=n)b.push(q[f]);else break;return b}}}();
TILE5.Mapping=function(){var q=0,n={AnnotationTween:null,GeoTileGrid:function(d){d=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,radsPerPixel:0},d);var b=TILE5.Geo.P.toMercatorPixels(d.centerPos,d.radsPerPixel),f=b.x-d.centerXY.x,a=b.y-d.centerXY.y,c=GRUNT.extend({},d.grid,{getBoundingBox:function(e,j,l,k){return new TILE5.Geo.BoundingBox(c.pixelsToPos(new TILE5.Vector(e,j+k)),c.pixelsToPos(new TILE5.Vector(e+l,j)))},getCenterOffset:function(){return d.centerXY},
getGridXYForPosition:function(e){e=TILE5.Geo.P.toMercatorPixels(e,d.radsPerPixel);return new TILE5.Vector(e.x-f,c.gridDimensions.height-(e.y-a))},getGuideOffset:function(e){var j=c.getTileSize();return new TILE5.Vector(e.x%j,e.y%j)},pixelsToPos:function(e){return TILE5.Geo.P.fromMercatorPixels(f+e.x,a+c.gridDimensions.height-e.y,d.radsPerPixel)}});return c},POIViewLayer:function(d){GRUNT.extend({},d)},Overlay:function(d){GRUNT.extend({},d);return{}},RadarOverlay:function(d){d=GRUNT.extend({radarFill:"rgba(0, 221, 238, 0.1)",
radarStroke:"rgba(0, 102, 136, 0.3)",zindex:100},d);return GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{draw:function(b,f,a){f=a.width>>1;a=a.height>>1;b.fillStyle=d.radarFill;b.strokeStyle=d.radarStroke;b.beginPath();b.arc(f,a,50,0,Math.PI*2,false);b.fill();b.stroke()}})},CrosshairOverlay:function(d){d=GRUNT.extend({lineWidth:1.5,strokeStyle:"rgba(0, 0, 0, 0.5)",size:15,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},
d);return GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{draw:function(b,f,a){f=a.getCenter();b.lineWidth=d.lineWidth;b.strokeStyle=d.strokeStyle;a=d.size;b.beginPath();b.moveTo(f.x,f.y-a);b.lineTo(f.x,f.y+a);b.moveTo(f.x-a,f.y);b.lineTo(f.x+a,f.y);b.arc(f.x,f.y,a*0.6666,0,2*Math.PI,false);b.stroke()}})},RouteOverlay:function(d){d=GRUNT.extend({strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,zindex:50},
d);var b=true,f=null,a=[],c=0,e=[],j=[],l=GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{getAnimation:function(k,h,g,i){if(b)return null;var m="routeAnimation"+q++;j.push(m);return new TILE5.Graphics.AnimatedPathLayer({id:m,path:a,zindex:d.zindex+1,easing:k?k:TILE5.Animation.Easing.Sine.InOut,duration:h?h:5E3,drawIndicator:g,autoCenter:i?i:false})},draw:function(k,h,g,i,m){g=0;i=d.data?d.data.geometry:null;if(b){b=false;f=null;a=[];c=0}if(i&&c<i.length){a:{m=m.getTileLayer();e=[];i=GRUNT.Log.getTraceTicks();
var o,r,p,s=d.data?d.data.geometry:[],t=s.length,u=d.data?d.data.instructions:[],z=u.length,B=d.calculationsPerCycle,y=0;for(o=c;o<t;o++){r=m.getGridXYForPosition(s[o]);if(p=!f||o===0||Math.abs(r.x-f.x)+Math.abs(r.y-f.y)>d.pixelGeneralization){a.push(r);f=r}y++;if(y>=B){c=o;break a}}c=t;GRUNT.Log.trace(t+" geometry points generalized to "+a.length+" coordinates",i);f=null;for(o=z;o--;)if(u[o].position){r=m.getGridXYForPosition(u[o].position);if(p=!f||o===0||Math.abs(r.x-f.x)+Math.abs(r.y-f.y)>d.pixelGeneralization){e.push(r);
f=r}}}g++}m=a.length;if(m>0&&(!g||d.partialDraw)){k.strokeStyle=d.strokeStyle;k.lineWidth=d.lineWidth;k.beginPath();k.moveTo(a[m-1].x-h.x,a[m-1].y-h.y);for(m=m;m--;)k.lineTo(a[m].x-h.x,a[m].y-h.y);k.stroke();k.fillStyle=d.waypointFillStyle;for(m=e.length;m--;){k.beginPath();k.arc(e[m].x-h.x,e[m].y-h.y,2,0,Math.PI*2,false);k.stroke();k.fill()}}return g}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var k=j.length;k--;)GRUNT.WaterCooler.say("layer.remove",{id:j[k]});j=[];b=true;l.wakeParent()});
return l},Annotation:function(d){d=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:n.AnnotationTween,animationSpeed:null},d);var b=false,f={xy:d.xy,pos:d.pos,isNew:true,isAnimating:function(){return b},draw:function(a,c,e,j){if(f.xy){if(f.isNew&&d.tweenIn){var l=f.xy.y;f.xy.y=c.y-20;b=true;TILE5.Animation.tween(f.xy,"y",l,d.tweenIn,function(){f.xy.y=l;b=false},d.animationSpeed?d.animationSpeed:250+Math.random()*500)}if(d.draw)d.draw(a,c,new TILE5.Vector(f.xy.x-c.x,f.xy.y-c.y),e,j);else{a.beginPath();
a.arc(f.xy.x-c.x,f.xy.y-c.y,4,0,Math.PI*2,false);a.fill()}f.isNew=false}}};return f},ImageAnnotation:function(d){d=GRUNT.extend({imageUrl:null,animatingImageUrl:null,imageAnchor:null},d);var b=d.imageAnchor?TILE5.V.invert(d.imageAnchor):null;d.draw=function(a,c,e,j,l){if(d.animatingImageUrl&&f.isAnimating()){TILE5.Resources.loadImage(d.imageUrl);j=d.animatingImageUrl}else j=d.imageUrl;if(c=TILE5.Resources.getImage(j)){if(c.complete&&c.width>0){b||(b=new TILE5.Vector(-c.width>>1,-c.height>>1));e=TILE5.V.offset(e,
b.x,b.y);a.drawImage(c,e.x,e.y,c.width,c.height)}}else TILE5.Resources.loadImage(j,function(){l.wakeParent()})};var f=new n.Annotation(d);return f},AnnotationsOverlay:function(d){function b(j){for(var l=d.map?d.map.getTileLayer():null,k=0;l&&k<j.length;k++)j[k].xy=l.getGridXYForPosition(j[k].pos)}d=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},d);var f=[],a=false,c=[],e=GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{draw:function(j,l,k,h){j.save();try{var g;a=false;j.fillStyle=
"rgba(255, 0, 0, 0.75)";j.globalCompositeOperation="source-over";for(g=f.length;g--;){f[g].draw(j,l,h,e);a=a||f[g].isAnimating()}for(g=c.length;g--;){c[g].draw(j,l,h,e);a=a||c[g].isAnimating()}a&&e.wakeParent()}finally{j.restore()}},add:function(j){c.push(j);b(c);e.wakeParent()},clear:function(j){c=[];b(c);if(j){f=[];b(f)}e.wakeParent()},isAnimating:function(){return a}});GRUNT.WaterCooler.listen("geo.pois-updated",function(j){if(d.pois&&d.pois.id==j.srcID){j=j.pois;try{f=[];for(var l=0;l<j.length;l++)if(j[l].pos){var k;
var h=j[l];if(h&&h.pos){var g=null;if(g=d.createAnnotationForPOI?d.createAnnotationForPOI(h):new n.Annotation({pos:h.pos})){g.isNew=h.isNew;h.isNew=false}k=g}else k=void 0;k&&f.push(k)}b(f)}catch(i){GRUNT.Log.exception(i)}e.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){b(f);b(c);e.wakeParent()});return e},Tiler:function(d){d=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,copyright:undefined,zoomLevel:0,boundsChange:null,tapPOI:null,tapHandler:null,boundsChangeThreshold:30,
pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,onTilesLoaded:null},d);if(typeof d.copyright==="undefined")d.copyright=d.provider?d.provider.getCopyright():"";var b=new TILE5.Vector,f=d.copyright,a=false,c=[],e=0,j=null,l=null,k=d.zoomLevel,h=d.tapHandler;if(!d.provider)d.provider=new TILE5.Geo.MapProvider;var g=new TILE5.Tiling.Tiler(GRUNT.extend({},d,{tapHandler:function(m,o){var r=i.getTileLayer(),p=null;if(r){p=i.viewPixToGridPix(new TILE5.Vector(o.x,o.y));var s=r.pixelsToPos(p),t=r.pixelsToPos(TILE5.V.offset(p,
-d.tapExtent,d.tapExtent)),u=r.pixelsToPos(TILE5.V.offset(p,d.tapExtent,-d.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(r.pixelsToPos(p)));p=new TILE5.Geo.BoundingBox(t,u);c=i.pois.findByBounds(p);d.tapPOI&&d.tapPOI(c)}h&&h(m,o,s,p)},doubleTapHandler:function(m,o){i.animate(2,i.getDimensions().getCenter(),new TILE5.Vector(o.x,o.y),TILE5.Animation.Easing.Sine.Out)},onScale:function(m,o){var r=0;m=Math.sqrt(m);if(m<1)r=-(0.5/m);else if(m>1)r=m;i.gotoPosition(i.getXYPosition(o),k+
Math.floor(r))}})),i=GRUNT.extend({},g,{pois:d.pois,annotations:null,getBoundingBox:function(){var m=new TILE5.Geo.BoundingBox,o=i.getTileLayer(),r=i.getOffset(),p=i.getDimensions();if(o)m=o.getBoundingBox(r.x,r.y,p.width,p.height);return m},getCenterPosition:function(){return i.getXYPosition(i.gridDimensions.getCenter())},getXYPosition:function(m){return i.getTileLayer().pixelsToPos(i.viewPixToGridPix(m))},gotoBounds:function(m,o){var r=TILE5.Geo.getBoundingBoxZoomLevel(m,i.getDimensions());i.gotoPosition(m.getCenter(),
r,o)},gotoCurrentPosition:function(m){TILE5.Geo.Location.get({successCallback:function(o){i.clearBackground();i.gotoPosition(o,15,m)},errorCallback:function(){}})},gotoPosition:function(m,o,r){var p=k,s=(new Date).getTime();k=o?o:k;if(!k)throw"Zoom level required to goto a position.";if(d.provider)k=d.provider.checkZoomLevel(k);if(!a||k!==p){TILE5.Resources.resetImageLoadQueue();(o=i.getTileLayer())&&o.deactivate();TILE5.Animation.cancel();a&&i.freeze();e=s;d.provider.zoomLevel=k;d.provider.getMapTiles(i,
m,function(t){if(s===e){i.setTileLayer(t);l=t.getId();i.panToPosition(m,function(){i.unfreeze();r&&r()})}else GRUNT.Log.info("request time mismatch - ignoring update")});a=true}else i.panToPosition(m,r)},panToPosition:function(m,o,r){var p=i.getTileLayer();if(p){m=p.getGridXYForPosition(m);p=i.getDimensions();m.x-=p.width>>1;m.y-=p.height>>1;if(j)j=null;i.updateOffset(m.x,m.y,r);GRUNT.WaterCooler.say("view.wake",{id:i.id});d.boundsChange&&d.boundsChange(i.getBoundingBox());o&&o(i)}},setZoomLevel:function(m){i.gotoPosition(i.getCenterPosition(),
m)},zoomIn:function(){i.scale(2,TILE5.Animation.Easing.Sine.Out)||i.setZoomLevel(k+1)},zoomOut:function(){i.scale(0.5,TILE5.Animation.Easing.Sine.Out)||i.setZoomLevel(k-1)},animateRoute:function(m,o,r,p){var s=i.getLayer("route");if(s)(m=s.getAnimation(m,o,r,p))&&m.addToView(i)}},g);g=new TILE5.Mapping.AnnotationsOverlay({pois:i.pois,map:i,createAnnotationForPOI:d.createAnnotationForPOI});i.annotations=g;i.setLayer("annotations",g);d.crosshair&&i.setLayer("crosshair",new TILE5.Mapping.CrosshairOverlay);
f&&i.setLayer("copyright",new TILE5.Graphics.ViewLayer({zindex:999,draw:function(m,o,r){m.lineWidth=2.5;m.fillStyle="rgb(50, 50, 50)";m.strokeStyle="rgba(255, 255, 255, 0.8)";m.font="bold 10px sans";m.textBaseline="bottom";m.strokeText(f,10,r.height-10);m.fillText(f,10,r.height-10)}}));GRUNT.WaterCooler.listen("view-idle",function(m){if(m.id&&m.id==i.id)if(TILE5.V.absSize(TILE5.V.diff(b,i.getOffset()))>d.boundsChangeThreshold&&d.boundsChange){b=i.getOffset();d.boundsChange(i.getBoundingBox())}});
GRUNT.WaterCooler.listen("tiles.drawn",function(m){m.id&&m.id==l&&d.onTilesLoaded&&d.onTilesLoaded()});return i}};return n}();
TILE5.Geo.Routing=function(){var q={calculate:function(n){n=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},n);GRUNT.Log.info("attempting to calculate route");var d=TILE5.Geo.getEngine("route");d&&d.route(n,function(b){if(n.generalize)b.geometry=TILE5.Geo.generalizePositions(b.geometry,b.getInstructionPositions());if(n.map){q.createMapOverlay(n.map,b);if(n.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+b.boundingBox);n.map.gotoBounds(b.boundingBox)}}n.success&&
n.success(b)})},createMapOverlay:function(n,d){var b=n.getDimensions();b=new TILE5.Mapping.RouteOverlay({data:d,width:b.width,height:b.height});n.setLayer("route",b)},Maneuver:{None:0,Continue:1,TurnLeft:100,TurnLeftSlight:101,TurnLeftSharp:102,TurnRight:110,TurnRightSlight:111,TurnRightSharp:112,TurnAround:190,EnterRoundabout:200,ExitRamp:300},Instruction:function(n){n=GRUNT.extend({position:null,description:"",manuever:q.Maneuver.None},n);return GRUNT.extend(n,{})},RouteData:function(n){n=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},n);if(!n.boundingBox)n.boundingBox=TILE5.Geo.getBoundsForPositions(n.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var d=[],b=0;b<n.instructions.length;b++)n.instructions[b].position&&d.push(n.instructions[b].position);return d}},n)}};return q}();
