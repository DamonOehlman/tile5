if(!this.JSON)this.JSON={};
(function(){function t(f){return f<10?"0"+f:f}function q(f){l.lastIndex=0;return l.test(f)?'"'+f.replace(l,function(h){var g=k[h];return typeof g==="string"?g:"\\u"+("0000"+h.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+f+'"'}function n(f,h){var g,e,r,o,s=b,p,u=h[f];if(u&&typeof u==="object"&&typeof u.toJSON==="function")u=u.toJSON(f);if(typeof m==="function")u=m.call(h,f,u);switch(typeof u){case "string":return q(u);case "number":return isFinite(u)?String(u):"null";case "boolean":case "null":return String(u);
case "object":if(!u)return"null";b+=d;p=[];if(Object.prototype.toString.apply(u)==="[object Array]"){o=u.length;for(g=0;g<o;g+=1)p[g]=n(g,u)||"null";r=p.length===0?"[]":b?"[\n"+b+p.join(",\n"+b)+"\n"+s+"]":"["+p.join(",")+"]";b=s;return r}if(m&&typeof m==="object"){o=m.length;for(g=0;g<o;g+=1){e=m[g];if(typeof e==="string")if(r=n(e,u))p.push(q(e)+(b?": ":":")+r)}}else for(e in u)if(Object.hasOwnProperty.call(u,e))if(r=n(e,u))p.push(q(e)+(b?": ":":")+r);r=p.length===0?"{}":b?"{\n"+b+p.join(",\n"+b)+
"\n"+s+"}":"{"+p.join(",")+"}";b=s;return r}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+t(this.getUTCMonth()+1)+"-"+t(this.getUTCDate())+"T"+t(this.getUTCHours())+":"+t(this.getUTCMinutes())+":"+t(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var a=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
l=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,b,d,k={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;if(typeof JSON.stringify!=="function")JSON.stringify=function(f,h,g){var e;d=b="";if(typeof g==="number")for(e=0;e<g;e+=1)d+=" ";else if(typeof g==="string")d=g;if((m=h)&&typeof h!=="function"&&(typeof h!=="object"||typeof h.length!=="number"))throw Error("JSON.stringify");return n("",
{"":f})};if(typeof JSON.parse!=="function")JSON.parse=function(f,h){function g(r,o){var s,p,u=r[o];if(u&&typeof u==="object")for(s in u)if(Object.hasOwnProperty.call(u,s)){p=g(u,s);if(p!==undefined)u[s]=p;else delete u[s]}return h.call(r,o,u)}var e;f=String(f);a.lastIndex=0;if(a.test(f))f=f.replace(a,function(r){return"\\u"+("0000"+r.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(f.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){e=eval("("+f+")");return typeof h==="function"?g({"":e},""):e}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(t){if(arguments.length<=1)return t;for(var q=arguments.length-2,n=0;n<=q;n++)t=t.replace(RegExp("\\{"+n+"\\}","gi"),arguments[n+1]);return t};
String.prototype.containsWord=function(t){var q="";if(t.toString)t=t.toString();for(var n=0;n<t.length;n++)q+=!/\w/.test(t[n])?"\\"+t[n]:t[n];return RegExp("(^|\\s|\\,)"+q+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var t=Object.prototype.hasOwnProperty,q=0,n={id:"GRUNT.core",extend:function(){var a=arguments[0]||{},l=1,b=arguments.length,d=false,k,m,f,h;if(typeof a==="boolean"){d=a;a=arguments[1]||{};l=2}if(typeof a!=="object"&&!n.isFunction(a))a={};if(b===l){a=this;--l}for(;l<b;l++)if((k=arguments[l])!=null)for(m in k){f=a[m];h=k[m];if(a!==h)if(d&&h&&(n.isPlainObject(h)||n.isArray(h))){f=f&&(n.isPlainObject(f)||n.isArray(f))?f:n.isArray(h)?[]:{};a[m]=n.extend(d,f,h)}else if(h!==undefined)a[m]=
h}return a},isFunction:function(a){return toString.call(a)==="[object Function]"},isArray:function(a){return toString.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||toString.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!t.call(a,"constructor")&&!t.call(a.constructor.prototype,"isPrototypeOf"))return false;var l;for(l in a);return l===undefined||t.call(a,l)},isEmptyObject:function(a){for(var l in a)return false;return true},isXmlDocument:function(a){return toString.call(a)===
"[object Document]"},contains:function(a,l){var b=a,d=arguments,k=1;if(l&&n.isArray(l)){d=l;k=0}for(k=k;k<d;k++)b=b&&typeof foo[d[k]]!=="undefined";return b},newModule:function(a){a=n.extend({id:null,requires:[],parent:null},a);if(a.parent)a=n.extend({},a.parent,a);return a},toID:function(a){return a.replace(/\s/g,"-")},generateObjectID:function(a){return(a?a:"obj")+q++}};return n}();
GRUNT.Log=function(){function t(b,d){var k,m=d&&d.length>0?d[0]:"";for(k=1;d&&k<d.length;k++)m+=" "+(n&&GRUNT.isPlainObject(d[k])?JSON.stringify(d[k]):d[k]);typeof console!=="undefined"&&console[b](m);for(k=0;k<q.length;k++)q[k].call(l,m,b)}var q=[],n=typeof JSON!=="undefined",a=window.console&&window.console.markTimeline,l={id:"GRUNT.log",getTraceTicks:function(){return a?(new Date).getTime():null},trace:function(b,d){if(a)console.markTimeline(b+(d?": "+(l.getTraceTicks()-d)+"ms":""))},debug:function(){t("debug",
arguments)},info:function(){t("info",arguments)},warn:function(){t("warn",arguments)},error:function(){t("error",arguments)},exception:function(b){l.error(arguments);for(var d in b)l.info("ERROR DETAIL: "+d+": "+b[d])},watch:function(b,d){try{d()}catch(k){l.exception(k,b)}},throwError:function(b){l.error(b);throw Error(b);},requestUpdates:function(b){q.push(b)}};return l}();
GRUNT.Data=function(){var t={determineObjectMapping:function(n){if(!n)return null;n=n.split("|");for(var a={},l=0;l<n.length;l++)a[n[l]]=l;return a},mapLineToObject:function(n,a){var l=n.split("|"),b={};for(var d in a){var k=a[d];b[d]=l.length>k?l[k]:null}return b},parse:function(n){var a=null,l=[];n=n.split("\n");for(var b=0;b<n.length;b++){var d=n[b];if(a)l.push(t.mapLineToObject(d,a));else a=t.determineObjectMapping(d)}return l}},q={supportedFormats:{JSON:{parse:function(n){return JSON.parse(n)}},
PDON:{parse:function(n){return t.parse(n)}}},parse:function(n){n=GRUNT.extend({data:"",format:"JSON"},n);if(!q.supportedFormats[n.format])throw Error("Unsupported data format: "+n.format+", cannot parse data in javascript object");try{return q.supportedFormats[n.format].parse(n.data)}catch(a){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+n.format,n.data);GRUNT.Log.exception(a)}return{}}};return q}();
GRUNT.Template=function(){var t=/\$\{(.*?)\}/ig;return{parse:function(q,n){for(var a=q,l=t.exec(a);l;){a=a.replace(l[0],GRUNT.XPath.first(l[1],n));t.lastIndex=0;l=t.exec(a)}return a}}}();
GRUNT.JSONP=function(){function t(l){var b=document.createElement("script"),d=false;b.src=l;b.async=true;b.onload=b.onreadystatechange=function(){if(!d&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){d=true;b.onload=b.onreadystatechange=null;b&&b.parentNode&&b.parentNode.removeChild(b)}};n||(n=document.getElementsByTagName("head")[0]);n.appendChild(b)}var q=0,n,a=this;return{get:function(l,b){l+=l.indexOf("?")>=0?"&":"?";var d="json"+ ++q;a[d]=function(k){b(k);a[d]=
null;try{delete a[d]}catch(m){}};t(l+"callback="+d);return d}}}();
GRUNT.XHR=function(){var t={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},q={JSON:["json"],PDON:["pdon.txt"]},n=["TEXT","STREAM"],a=/^(\w+:)?\/\/([^\/?#]+)/,l={XML:function(k){return k.responseXML},JSON:function(k){try{return JSON.parse(k.responseText)}catch(m){GRUNT.Log.error("Error parsing JSON data: ",k.responseText);GRUNT.Log.exception(m)}return""},PDON:function(k){return GRUNT.Data.parse({data:k.responseText,format:"PDON"})},DEFAULT:function(k){return k.responseText}},
b={CONTENT_TYPE:"Content-Type"},d=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(k){try{k=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},d.ajaxSettings,k);var m=a.exec(k.url),f=m&&(m[1]&&m[1]!==location.protocol||m[2]!==location.host);if(k.data)k.method="POST";if(k.url){m=null;if(k.xhr)m=k.xhr(k);m||(m=new XMLHttpRequest);m.open(k.method,k.url,k.async);k.data&&m.setRequestHeader("Content-Type",
k.contentType);f||m.setRequestHeader("X-Requested-With","XMLHttpRequest");m.onreadystatechange=function(){if(this.readyState===4){var g=null,e=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(e)if(k.handleResponse)k.handleResponse(this);else{var r=k,o=this.getResponseHeader(b.CONTENT_TYPE),s,p=false;for(s in t)if(o&&o.indexOf(t[s])>=0){p=true;break}o=!p;for(p=0;p<n.length;p++)o=o||n[p]==s;if(o)b:{o=s;for(var u in q)for(p=
0;p<q[u].length;p++)if(RegExp(q[u][p]+"$","i").test(r.url)){s=u;break b}s=o?o:"DEFAULT"}try{g=l[s](this,r)}catch(v){GRUNT.Log.warn("error applying processor '"+s+"' to response type, falling back to default");g=l.DEFAULT(this,r)}}else k.error&&k.error(this)}catch(w){GRUNT.Log.exception(w,"PROCESSING AJAX RESPONSE")}e&&g&&k.success&&k.success.call(this,g)}};m.send(k.method=="POST"?d.param(k.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(h){GRUNT.Log.exception(h)}},
param:function(k){var m=[],f=function(g,e){e=GRUNT.isFunction(e)?e():e;m[m.length]=encodeURIComponent(g)+"="+encodeURIComponent(e)};if(GRUNT.isArray(k))for(var h=0;h<k.length;h++)f(k[h].name,k[h].value);else for(h in k)f(h,k[h]);return m.join("&").replace(/%20/g,"+")}});return d}();
GRUNT.XPath=function(){function t(l){for(var b=null,d=0;d<q.length;d++)if(b=q[d](l))break;return b}var q=[],n=[null,function(l){return l.numberValue},function(l){return l.stringValue},function(l){return l.booleanValue},null,null,null,null,function(l){return l.singleNodeValue?l.singleNodeValue.textContent:null},function(l){return l.singleNodeValue?l.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var a={SearchResult:function(l){return{toString:function(){var b=
null;if(l){var d=null;if(l.resultType>=0&&l.resultType<n.length)d=n[l.resultType];if(d){GRUNT.Log.info("invoking match handler for result type: "+l.resultType);b=d(l)}}return b?b:""}}},first:function(l,b){var d=a.SearchResult,k;var m=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!m)m=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(b))k=b.evaluate(l,b,t,m,null);else{GRUNT.Log.warn("attempted xpath expression: "+l+" on a non-xml document");k=null}}catch(f){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
l+" on node: "+b);k=null}return new d(k)},registerResolver:function(l){q.push(l)}};return a}();GRUNT.Observable=function(){var t={},q=0,n={bind:function(a,l){t[a]||(t[a]=[]);q+=1;t[a].push({callback:l,callbackId:q});return q},trigger:function(a){var l=t[a];if(l)for(var b=l.length;b--;)l[b].callback.apply(n,Array.prototype.slice.call(arguments,1))},unbind:function(a,l){for(var b=t[a],d=0;b&&d<b.length;d++)if(b[d].callbackId===l){b.splice(d,1);break}}};return n};
GRUNT.WaterCooler=function(){var t={},q=[];return{addPipe:function(n){n("pipe.test",{});q.push(n)},listen:function(n,a){t[n]||(t[n]=[]);a&&t[n].push(a)},say:function(n,a){var l;for(l=q.length;l--;)q[l](n,a);if(t[n])for(l=t[n].length;l--;)t[n][l](a)},leave:function(){}}}();
TILE5=function(){var t={Settings:function(){var q={};return{get:function(n){return q[n]},set:function(n,a){q[n]=a},extend:function(n){GRUNT.extend(q,n)}}}(),Clock:function(){var q=null;return{getTime:function(n){return n&&q?q:q=(new Date).getTime()}}}(),Vector:function(q,n){return{x:q?q:0,y:n?n:0}},V:function(){function q(n){if(!n||n.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var a={edges:Array(n.length-1),accrued:Array(n.length-1),total:0},
l=TILE5.V.diff,b=0;b<n.length-1;b++){var d=l(n[b],n[b+1]);a.edges[b]=Math.sqrt(d.x*d.x+d.y*d.y);a.accrued[b]=a.total+a.edges[b];a.total+=a.edges[b]}return a}return{create:function(n,a){return new t.Vector(n,a)},add:function(){for(var n=new t.Vector,a=arguments.length;a--;){n.x+=arguments[a].x;n.y+=arguments[a].y}return n},absSize:function(n){return Math.max(Math.abs(n.x),Math.abs(n.y))},diff:function(n,a){return new t.Vector(n.x-a.x,n.y-a.y)},copy:function(n){return n?new t.Vector(n.x,n.y):null},
invert:function(n){return new TILE5.Vector(-n.x,-n.y)},offset:function(n,a,l){return new TILE5.Vector(n.x+a,n.y+(l?l:a))},edges:q,distance:function(n){return q(n).total},theta:function(n,a,l){l=Math.asin((n.y-a.y)/l);return n.x>a.x?l:Math.PI-l},pointOnEdge:function(n,a,l,b){a=new TILE5.Vector(Math.cos(l)*b,Math.sin(l)*b);return new TILE5.Vector(n.x-a.x,n.y-a.y)},getRect:function(n){var a=n.length;if(a>1)return new TILE5.Rect(Math.min(n[0].x,n[a-1].x),Math.min(n[0].y,n[a-1].y),Math.abs(n[0].x-n[a-
1].x),Math.abs(n[0].y-n[a-1].y))}}}(),Dimensions:function(q,n){return{width:q?q:0,height:n?n:0}},D:function(){return{getAspectRatio:function(q){return q.height!==0?q.width/q.height:1},getCenter:function(q){return new t.Vector(q.width/2,q.height/2)},getSize:function(q){return Math.sqrt(Math.pow(q.width,2)+Math.pow(q.height,2))}}}(),Rect:function(q,n,a,l){return{origin:new t.Vector(q,n),dimensions:new t.Dimensions(a,l)}},R:function(){return{copy:function(q){return q?new t.Rect(q.origin.x,q.origin.y,
q.dimensions.width,q.dimensions.height):null},getCenter:function(q){return new TILE5.Vector(q.origin.x+q.dimensions.width/2,q.origin.y+q.dimensions.height/2)}}}()};return t}();
TILE5.Device=function(){function t(){for(;h.length>0;){var e=h.shift();document.location=e}f=0}function q(e){for(var r=true,o=g.length;o--;)r=r&&e!=g[o];return r}function n(e,r){var o=[];for(var s in r)s&&o.push(s+"="+escape(r[s]));return"tile5://"+e+"/"+(o.length>0?"?"+o.join("&"):"")}function a(e,r){q(e)&&GRUNT.Log.info("would push url: "+n(e,r))}function l(e,r){if(q(e)){h.push(n(e,r));f||(f=setTimeout(t,100))}}function b(){d={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:4,requireFastDraw:false,bridgeNotify:a,targetFps:25},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true,bridgeNotify:l,targetFps:10},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:l},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:l},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,supportsTouch:true,
getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:l},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:l}};k=[d.froyo,d.android,d.ipod,d.iphone,d.ipad]}var d=null,k=[],m=null,f=0,h=[],g=["view.wake","tile.loaded"];return{getConfig:function(){d||b();if(!m){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var e=0;e<k.length;e++){var r=k[e];if(r.regex&&r.regex.test(navigator.userAgent)){m=GRUNT.extend({},
d.base,r);GRUNT.Log.info("PLATFORM DETECTED AS: "+m.name);break}}if(!m){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");m=d.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return m}}}();
TILE5.Resources=function(){var t="",q={},n=function(){function l(){var v=f[this.id];if(v){v.loaded=true;v.hitCount=1;for(var w=e.length;w--;)if(e[w].image.src==this.src){e.splice(w,1);break}v.loadCallback&&v.loadCallback(this,false);r.push({url:this.src,created:v.requested});delete f[this.id];b()}}function b(){for(var v=TILE5.Device.getConfig().maxImageLoads;g.length>0&&(!v||e.length<v);){var w=g.shift();if(w.imageLoader){e.push(w);w.imageLoader(w,l)}}}function d(v){for(var w=null,x=o.length;x--&&
!w;)w=o[x](v);return w?w:function(A,C){A.image.onload=C;A.image.src=a.getPath(A.url);A.requested=(new Date).getTime()}}function k(){p=true;try{var v=Math.floor(r.length/2);if(v>0){r.sort(function(x,A){return x.created-A.created});for(var w=v;w--;)delete m[r[w].url];r.splice(0,v)}}finally{p=false}GRUNT.WaterCooler.say("imagecache.cleared")}var m={},f={},h=0,g=[],e=[],r=[],o=[],s=0,p=false,u={loadingImages:e,queuedImages:g,addInterceptor:function(v){o.push(v)},getCacheFullness:function(){return s},
getImage:function(v){var w=null;p||(w=m[v]);return w?w.image:null},loadImage:function(v,w){var x=m[v];if(x){x.hitCount++;x.image.complete&&w&&w(x.image,true)}else{x={url:v,image:new Image,loaded:false,imageLoader:d(v),created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:w};x.image.id="resourceLoaderImage"+h++;m[v]=x;f[x.image.id]=x;g.push(x);b()}return x},resetLoadingQueue:function(){e=[]}};setInterval(function(){for(var v=(new Date).getTime(),w=false,x=0,A=TILE5.Device.getConfig();x<
e.length;)if(v-e[x].requested>a.loadTimeout*1E3){e.splice(x,1);w=true}else x++;w&&b();if(A&&A.imageCacheMaxSize){s=r.length*a.avgImageSize/A.imageCacheMaxSize;s>=1&&k()}},1E3);return u}(),a={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(l,b){for(var d=(l?l.replace(/^.*\?/,""):"").split("&"),k=l?l.replace(/\?.*$/,"?"):"",m=0;m<d.length;m++){var f=d[m].split("=");if(!b||!b.test(f[0]))k+=d[m]+"&"}return k.replace(/\W/g,
"")},isValidCacheKey:function(l){GRUNT.Log.info("cache key = "+l);return false}}}(),addInterceptor:n.addInterceptor,getPath:function(l){return/^(file|https?|\/)/.test(l)?l:t+l},setBasePath:function(l){t=l},getImage:function(l){return n.getImage(l)},loadImage:function(l,b){n.loadImage(l,b)},resetImageLoadQueue:function(){n.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:n.loadingImages.length,queuedImageCount:n.queuedImages.length,imageCacheFullness:n.getCacheFullness()}},loadResource:function(l){l=
GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},l);var b=function(d){l.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){l.callback(d)})};l.cacheable&&q[l.filename]?b(q[l.filename]):GRUNT.XHR.ajax({url:a.getPath(l.filename),dataType:l.dataType,success:function(d){if(l.cacheable)q[l.filename]=d;b(d)},error:function(d,k,m){GRUNT.Log.error("error loading resource ["+l.filename+"], error = "+m)}})},loadSnippet:function(l,b){/\.\w+$/.test(l)||(l+=".html");a.loadResource({filename:"snippets/"+
l,callback:b,dataType:"html"})}};return a}();
TILE5.Touch=function(){function t(f,h){var g=f&&f.length>0?f[0]:null;if(g&&h&&h.length>0)return TILE5.V.diff(g,h[0]);return null}function q(f){f.preventDefault();f.stopPropagation()}function n(f){for(var h=Array(f.length),g=f.length;g--;)h[g]=new TILE5.Vector(f[g].pageX,f[g].pageY);return h}var a={TAP:0,MOVE:1,PINCHZOOM:2},l=7,b=0,d=0,k={TouchHelper:function(f){function h(z){for(var F=[],K=f.element?-f.element.offsetLeft:0,O=f.element?-f.element.offsetTop:0,P=z.length;P--;)F.push(TILE5.V.offset(z[P],
K,O));return F}function g(){f.observable&&f.observable.trigger.apply(null,arguments)}function e(z){if(z.target&&z.target===f.element){v=u?n(z.touches):[new TILE5.Vector(z.pageX,z.pageY)];x=new TILE5.Vector;A=new TILE5.Vector;D=true;s=false;u&&q(z);M.current=TILE5.Clock.getTime();if(z=v.length>0?v[0]:null){g("touchStart",z.x,z.y);if(M.current-M.last<J.THRESHOLD_DOUBLETAP)if((z=w?TILE5.V.diff(v[0],w[0]):null)&&Math.abs(z.x)<f.maxDistDoubleTap&&Math.abs(z.y)<f.maxDistDoubleTap)s=true;E=a.TAP;w=[].concat(v)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}
function r(z){if(z.target&&z.target===f.element)if(D)try{u&&q(z);var F=u?n(z.touches):[new TILE5.Vector(z.pageX,z.pageY)];z=0;if(F.length>1){if(v.length===1)v=[].concat(F);z=TILE5.V.distance(v)-TILE5.V.distance(w)}if(E===a.TAP){var K=t(F,v);if(K&&(Math.abs(K.x)>=l||Math.abs(K.y)>=l))E=a.MOVE}if(E!==a.TAP)if(!z||Math.abs(z)<f.pinchZoomThreshold){if(x=t(F,w)){A.x-=x.x;A.y-=x.y;C.x-=x.x;C.y-=x.y}if(TILE5.V.absSize(C)>f.panEventThreshhold){g("move",C.x,C.y);C=TILE5.V.create()}E=a.MOVE}else{g("pinchZoom",
h(v),h(F));E=a.PINCHZOOM}w=[].concat(F)}catch(O){GRUNT.Log.exception(O)}}function o(z){if(z.target&&z.target===f.element)try{u&&q(z);TILE5.Clock.getTime();M.last=M.current;if(E===a.TAP)p||(p=setTimeout(function(){p=0;var K=s?"doubleTap":"tap",O=v[0],P=null;if(f.element)P=TILE5.V.offset(O,-f.element.offsetLeft,-f.element.offsetTop);g(K,O,P)},J.THRESHOLD_DOUBLETAP+50));else if(E==a.MOVE)g("moveEnd",A.x,A.y);else E==a.PINCHZOOM&&g("pinchZoomEnd",h(v),h(w))}catch(F){GRUNT.Log.exception(F)}D=false}f=GRUNT.extend({element:null,
observable:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},f);var s=false,p=0,u=TILE5.Device.getConfig().supportsTouch,v=null,w=null,x=null,A=null,C=new TILE5.Vector,E=null,D=false,L=[],M={current:0,last:0},H=TILE5.Device.getConfig(),J={supportsTouch:u,THRESHOLD_DOUBLETAP:300,addListeners:function(z){L.push(z)},
decoupleListeners:function(z){for(var F=0;z&&F<L.length;F++)if(L[F].listenerId===z){L.splice(F,1);GRUNT.Log.info("successfully decoupled touch listener: "+z);break}},release:function(){H.eventTarget.removeEventListener(H.supportsTouch?"touchstart":"mousedown",e,false);H.eventTarget.removeEventListener(H.supportsTouch?"touchmove":"mousemove",r,false);H.eventTarget.removeEventListener(H.supportsTouch?"touchend":"mouseup",o,false)},wheelie:function(z){var F=new TILE5.Vector(z.wheelDeltaX,z.wheelDeltaY);
z=new TILE5.Vector(z.clientX,z.clientY);GRUNT.Log.info("capture mouse wheel event, delta = "+F+", position = "+z)}};H.eventTarget.addEventListener(H.supportsTouch?"touchstart":"mousedown",e,false);H.eventTarget.addEventListener(H.supportsTouch?"touchmove":"mousemove",r,false);H.eventTarget.addEventListener(H.supportsTouch?"touchend":"mouseup",o,false);return J}},m=[];return{captureTouch:function(f,h){try{if(!f)throw Error("Unable to capture touch of null element");if(!f.id)f.id="touchable_"+b++;var g=
m[f.id];if(!g){g=k.TouchHelper(GRUNT.extend({element:f},h));m[f.id]=g;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+g.supportsTouch)}h.listenerId&&g.decoupleListeners(h.listenerId);h.listenerId=++d;g.addListeners(h)}catch(e){GRUNT.Log.exception(e)}},resetTouch:function(f){if(f&&f.id&&m[f.id]){m[f.id].release();delete m[f.id]}}}}();
if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(t){return this.each(function(){TILE5.Touch.captureTouch(this,t)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(t){t.preventDefault()})}}
TILE5.Dispatcher=function(){var t=[],q={execute:function(n){var a=q.findAction(n);GRUNT.Log.info("looking for action id: "+n+", found: "+a);if(a){var l=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+n,function(){a.execute(l)})}},findAction:function(n){for(var a=t.length;a--;)if(t[a].id==n)return t[a];return null},getRegisteredActions:function(){return[].concat(t)},getRegisteredActionIds:function(){for(var n=[],a=t.length;a--;)t[a].id&&n.push(t[a].id);return n},registerAction:function(n){n&&
n.id&&t.push(n)},Action:function(n){n=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},n);var a={id:n.id,execute:function(){n.execute&&n.execute.apply(this,arguments)},getParam:function(l){return n[l]?n[l]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",a.id,n.title,n.icon)}};n.autoRegister&&q.registerAction(a);return a},createAgent:function(n){n=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},n);var a=null,l={getName:function(){return n.name},
getParam:function(b){return n[b]},getId:function(){return GRUNT.toID(l.getName())},run:function(b,d){if(n.execute){var k=a=TILE5.Clock.getTime(true),m=n.translator?n.translator(b):b;n.execute.call(l,m,function(f,h){if(!n.trashOrphanedResults||k==a)d&&d(f,h,m)})}}};return l},runAgents:function(n,a,l){for(var b=0;b<n.length;b++)n[b].run(a,l)}};return q}();
TILE5.Animation=function(){function t(){if(a===0)a=setInterval(function(){var b;b=TILE5.Clock.getTime();if(!n){n=true;try{for(var d=0;d<q.length;)if(q[d].isComplete()){q[d].triggerComplete(false);q.splice(d,1);GRUNT.WaterCooler.say("animation.complete")}else{q[d].update(b);d++}}finally{n=false}}b=q.length;if(b===0){clearInterval(a);a=0}},20)}var q=[],n=false,a=0,l={DURATION:2E3,tweenValue:function(b,d,k,m,f){b=new l.Tween({startValue:b,endValue:d,tweenFn:k,complete:m,duration:f});q.push(b);return b},
tween:function(b,d,k,m,f,h){b=new l.Tween({target:b,property:d,endValue:k,tweenFn:m,duration:h,complete:f});q.push(b);return b},tweenVector:function(b,d,k,m,f,h){var g=[];if(b){var e=b.x==d,r=b.y==k;e||g.push(l.tween(b,"x",d,m,function(){(e=true)&&r&&f()},h));r||g.push(l.tween(b,"y",k,m,function(){r=true;e&&r&&f()},h))}return g},cancel:function(b){if(!n){n=true;try{for(var d=0;d<q.length;)if(!b||b(q[d])){GRUNT.Log.info("CANCELLING ANIMATION");q[d].triggerComplete(true);q.splice(d,1)}else d++}finally{n=
false}}},isTweening:function(){return q.length>0},Tween:function(b){b=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:l.DURATION,tweenFn:l.DEFAULT,complete:null,cancelOnInteract:false},b);var d=TILE5.Clock.getTime(),k=[],m=false,f=0,h=0,g={cancelOnInteract:b.cancelOnInteract,isComplete:function(){return m},triggerComplete:function(e){b.complete&&b.complete(e)},update:function(e){try{var r=b.tweenFn(e-d,f,h,b.duration);if(b.target)b.target[b.property]=r;for(var o=k.length;o--;)k[o](r,
void 0);if(m=d+b.duration<=e){if(b.target)b.target[b.property]=b.tweenFn(b.duration,f,h,b.duration);for(var s=k.length;s--;)k[s](r,true)}}catch(p){GRUNT.Log.exception(p)}},requestUpdates:function(e){k.push(e)}};f=b.target&&b.property&&b.target[b.property]?b.target[b.property]:b.startValue;if(typeof b.endValue!=="undefined")h=b.endValue-f;if(h==0)m=true;t();return g},Easing:function(){var b=1.70158;return{Linear:function(d,k,m,f){return m*d/f+k},Back:{In:function(d,k,m,f){return m*(d/=f)*d*((b+1)*
d-b)+k},Out:function(d,k,m,f){return m*((d=d/f-1)*d*((b+1)*d+b)+1)+k},InOut:function(d,k,m,f){return(d/=f/2)<1?m/2*d*d*(((b*=1.525)+1)*d-b)+k:m/2*((d-=2)*d*(((b*=1.525)+1)*d+b)+2)+k}},Bounce:{In:function(d,k,m,f){return m-l.Easing.Bounce.Out(f-d,0,m,f)+k},Out:function(d,k,m,f){return(d/=f)<1/2.75?m*7.5625*d*d+k:d<2/2.75?m*(7.5625*(d-=1.5/2.75)*d+0.75)+k:d<2.5/2.75?m*(7.5625*(d-=2.25/2.75)*d+0.9375)+k:m*(7.5625*(d-=2.625/2.75)*d+0.984375)+k},InOut:function(d,k,m,f){return d<f/2?l.Easing.Bounce.In(d*
2,0,m,f)/2+k:l.Easing.Bounce.Out(d*2-f,0,m,f)/2+m/2+k}},Cubic:{In:function(d,k,m,f){return m*(d/=f)*d*d+k},Out:function(d,k,m,f){return m*((d=d/f-1)*d*d+1)+k},InOut:function(d,k,m,f){if((d/=f/2)<1)return m/2*d*d*d+k;return m/2*((d-=2)*d*d+2)+k}},Elastic:{In:function(d,k,m,f,h,g){if(d==0)return k;if((d/=f)==1)return k+m;g||(g=f*0.3);if(!h||h<Math.abs(m)){h=m;m=g/4}else m=g/(2*Math.PI)*Math.asin(m/h);return-(h*Math.pow(2,10*(d-=1))*Math.sin((d*f-m)*2*Math.PI/g))+k},Out:function(d,k,m,f,h,g){var e;if(d==
0)return k;if((d/=f)==1)return k+m;g||(g=f*0.3);if(!h||h<Math.abs(m)){h=m;e=g/4}else e=g/(2*Math.PI)*Math.asin(m/h);return h*Math.pow(2,-10*d)*Math.sin((d*f-e)*2*Math.PI/g)+m+k},InOut:function(d,k,m,f,h,g){var e;if(d==0)return k;if((d/=f/2)==2)return k+m;g||(g=f*0.3*1.5);if(!h||h<Math.abs(m)){h=m;e=g/4}else e=g/(2*Math.PI)*Math.asin(m/h);if(d<1)return-0.5*h*Math.pow(2,10*(d-=1))*Math.sin((d*f-e)*2*Math.PI/g)+k;return h*Math.pow(2,-10*(d-=1))*Math.sin((d*f-e)*2*Math.PI/g)*0.5+m+k}},Quad:{In:function(d,
k,m,f){return m*(d/=f)*d+k},Out:function(d,k,m,f){return-m*(d/=f)*(d-2)+k},InOut:function(d,k,m,f){if((d/=f/2)<1)return m/2*d*d+k;return-m/2*(--d*(d-2)-1)+k}},Sine:{In:function(d,k,m,f){return-m*Math.cos(d/f*(Math.PI/2))+m+k},Out:function(d,k,m,f){return m*Math.sin(d/f*(Math.PI/2))+k},InOut:function(d,k,m,f){return-m/2*(Math.cos(Math.PI*d/f)-1)+k}}}}()};return GRUNT.extend(l,{DEFAULT:l.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var t={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},q=0,n={DisplayState:t,AnyDisplayState:255,ActiveDisplayStates:t.ACTIVE|t.ANIMATING,DefaultDisplayStates:t.ACTIVE|t.ANIMATING|t.PAN|t.PINCHZOOM,ViewLayer:function(a){a=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:n.DefaultDisplayStates},a);var l=null,b=a.id,d=GRUNT.extend({addToView:function(k){k.setLayer(b,d)},shouldDraw:function(k){var m=
l?l.fastDraw&&k!==t.ACTIVE:false;return(k&a.validStates)!==0&&(m?a.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:b})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:l?l.id:null})},getId:function(){return b},setId:function(k){b=k},getParent:function(){return l},setParent:function(k){l=k}},a);return d},AnimatedPathLayer:function(a){function l(h,g,e){h.fillStyle="#FFFFFF";h.strokeStyle="#222222";h.beginPath();
h.arc(e.x,e.y,4,0,Math.PI*2,false);h.stroke();h.fill()}a=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,validStates:n.ActiveDisplayStates|t.PAN|t.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},a);var b=TILE5.V.edges(a.path),d,k=null,m=0;TILE5.Animation.tweenValue(0,b.total,a.easing,function(){f.remove()},a.duration).requestUpdates(function(h,g){m=h;g&&f.remove()});var f=GRUNT.extend(new n.ViewLayer(a),{cycle:function(){for(var h=
0;h<b.accrued.length&&b.accrued[h]<m;)h++;k=null;if(h<a.path.length-1){var g=m-(h>0?b.accrued[h-1]:0),e=a.path[h],r=a.path[h+1];d=TILE5.V.theta(e,r,b.edges[h]);k=TILE5.V.pointOnEdge(e,r,d,g);if(a.autoCenter)(h=f.getParent())&&h.centerOn(k)}return k?1:0},draw:function(h,g){if(k)(a.drawIndicator?a.drawIndicator:l)(h,g,new TILE5.Vector(k.x-g.x,k.y-g.y),d)}});return f},FPSLayer:function(a){a=GRUNT.extend({zindex:1E3,scalePosition:false},a);var l=null,b=GRUNT.extend(new n.ViewLayer(a),{delays:[],draw:function(d,
k,m){d.font="bold 8pt Arial";d.textAlign="right";d.fillStyle="rgba(0, 0, 0, 0.8)";d.fillText((l?l:"?")+" fps",m.width-20,20)}});setInterval(function(){for(var d=0,k=b.delays.length,m=k;m--;)d+=b.delays[m];if(k!==0)l=Math.floor(1E3/(d/k))},1E3);return b},ResourceStatsLayer:function(a){a=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:t.ACTIVE|t.PAN},a);return GRUNT.extend(new n.ViewLayer(a),{fps:null,draw:function(l){var b=TILE5.Resources.getStats(),d=a.indicatorSize,k=10,
m;if(b.imageCacheFullness){l.strokeStyle="rgba(0, 0, 255, 1)";l.beginPath();l.arc(15,15,5,0,Math.PI*2*b.imageCacheFullness,false);l.stroke();k=30}if(b.imageLoadingCount>=0){l.fillStyle="rgba(0, 255, 0, 0.7)";for(m=b.imageLoadingCount;m--;)l.fillRect(k+m*(d+2),10,d,d)}if(b.queuedImageCount>=0){l.fillStyle="rgba(255, 0, 0, 0.7)";for(m=b.queuedImageCount;m--;)l.fillRect(k+m*(d+2),10+d+2,d,d)}}})},LoadingLayer:function(a){GRUNT.extend({},a)},View:function(a){function l(y,B){P=TILE5.V.getRect(y);Y=TILE5.V.getRect(B);
var G=TILE5.D.getSize(P.dimensions),N=TILE5.D.getSize(Y.dimensions);Z=TILE5.R.getCenter(P);D=TILE5.R.getCenter(Y);Q=P&&G!==0?N/G:1}function b(y){GRUNT.WaterCooler.say("view.scale",{id:I.id});O=false;I.trigger("scale",Q,D,y);S=n.DisplayState.ACTIVE;h()}function d(y,B){B.setId(y);B.setParent(I);g.push(B);g.sort(function(G,N){var R=N.zindex-G.zindex;if(R===0)R=N.created-G.created;return R})}function k(){GRUNT.WaterCooler.say("view.idle",{id:I.id});L=true;H=0}function m(y,B){var G=0,N=I.getDisplayState(),
R=(new Date).getTime(),U=(N&t.PINCHZOOM)!==0,T=0;if(s||U){y.clearRect(0,0,e.width,e.height);s=false}if(U){TILE5.D.getCenter(x);var $=(V?V:1)/2,W=TILE5.V.diff(Z,D);if(J=P?new TILE5.Vector(D.x+W.x,D.y+W.y):new TILE5.Vector(D.x-W.x*$,D.y-W.y*$))B=TILE5.V.offset(B,J.x,J.y)}y.save();try{if(w!==1)y.scale(w,w);else if(U){y.translate(D.x,D.y);y.scale(Q,Q)}for(T=g.length;T--;)if(g[T].shouldDraw(N)){var aa=g[T].draw(y,B,x,N,I);G+=aa?aa:0}}finally{y.restore()}GRUNT.Log.trace("draw complete",R);return G}function f(){var y=
0,B=S===t.PINCHZOOM||S===t.PAN;z=(new Date).getTime();o.x=Math.floor(o.x);o.y=Math.floor(o.y);E&&p&&E.delays.push(z-p);if(B){TILE5.Animation.cancel(function(N){return N.cancelOnInteract});L=false;if(H!==0){clearTimeout(H);H=0}}for(B=g.length;B--;){var G=g[B].cycle(z,o,S);y+=G?G:0}if(p+K<z){y+=m(r,o);p=z}M=0;if(C+y>0)h();else if(!L&&H===0)H=setTimeout(k,500);GRUNT.Log.trace("Completed draw cycle",z)}function h(){C++;if(!(v||M!==0)){C=0;M=setTimeout(f,0)}}a=GRUNT.extend({id:"view_"+q++,container:"",
clearOnDraw:false,displayFPS:false,displayResourceStats:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,autoSize:false},a);var g=[],e=document.getElementById(a.container),r=null,o=new TILE5.Vector,s=false,p=null,u=0,v=false,w=1,x=null,A=null,C=0,E=null,D=null,L=false,M=0,H=0,J=null,z=0,F=TILE5.Device.getConfig().targetFps,K=0,O=false,P=null,Y=null,Q=1,V=null,X=null,Z=null,S=n.DisplayState.ACTIVE;GRUNT.Log.info("Creating a new view instance, attached to container: "+
a.container+", canvas = ",e);if(e){TILE5.Touch.resetTouch(e);if(a.autoSize){GRUNT.Log.info("autosizing view: window.height = "+window.innerHeight+", width = "+window.innerWidth);e.height=window.innerHeight-e.offsetTop;e.width=window.innerWidth-e.offsetLeft}try{r=e.getContext("2d");r.globalCompositeOperation=a.initialDrawMode;r.clearRect(0,0,e.width,e.height)}catch(ba){GRUNT.Log.exception(ba);throw Error("Could not initialise canvas on specified view element");}}var I=GRUNT.extend({},a,new GRUNT.Observable,
{id:a.id,deviceScaling:w,fastDraw:a.fastDraw||TILE5.Device.getConfig().requireFastDraw,animate:function(y,B,G,N,R){function U(){R&&R();b();Q=1;V=null}O=true;Z=TILE5.V.copy(B);D=TILE5.V.copy(G);P=null;if(N){X=Q;TILE5.Animation.tweenValue(0,y-X,N,U,1E3).requestUpdates(function(T){V=T/(y-X);Q=X+T;S=n.DisplayState.PINCHZOOM;h();I.trigger("animate")})}else{Q=y;U()}},centerOn:function(y){null.setOffset(y.x-e.width/2,y.y-e.height/2)},getDimensions:function(){if(e)return new TILE5.Dimensions(e.width,e.height)},
getZoomCenter:function(){return J},getLayer:function(y){for(var B=0;B<g.length;B++)if(g[B].getId()==y)return g[B];return null},setLayer:function(y,B){for(var G=0;G<g.length;G++)if(g[G].getId()===y){g.splice(G,1);break}B&&d(y,B);GRUNT.WaterCooler.say("layer.update",{id:y});h()},eachLayer:function(y){for(var B=0;B<g.length;B++)y(g[B])},clearBackground:function(){s=true},freeze:function(){v=true},unfreeze:function(){v=false;h()},snapshot:function(){},getDisplayState:function(){return v?t.FROZEN:S},scale:function(y,
B,G,N,R){N||TILE5.D.getCenter(x);R||TILE5.D.getCenter(x);return null},removeLayer:function(y){a:{for(var B=g.length;B--;)if(g[B].getId()==y){y=B;break a}y=-1}if(y>=0&&y<g.length){GRUNT.WaterCooler.say("layer.removed",{layer:g[y]});g.splice(y,1)}},getOffset:function(){return TILE5.V.copy(o)},setOffset:function(y,B){o.x=y;o.y=B},updateOffset:function(y,B,G){if(G){y=new TILE5.Vector(y,B);animating=true;G=TILE5.Animation.tweenVector(o,y.x,y.y,G,function(){animating=false;I.panEnd(0,0)});for(y=G.length;y--;){G[y].cancelOnInteract=
true;G[y].requestUpdates(function(){a.onAnimate&&a.onAnimate(o.x,o.y)})}}else I.setOffset(y,B)}});x=I.getDimensions();A=TILE5.D.getCenter(x);if(F)K=Math.ceil(1E3/F);GRUNT.Log.info("redraw interval calaculated @ "+K);GRUNT.WaterCooler.listen("layer.remove",function(y){y.id&&I.removeLayer(y.id)});GRUNT.WaterCooler.listen("view.wake",function(y){if(!y.id||y.id===I.id)h()});w=TILE5.Device.getConfig().getScaling();if(a.displayFPS){E=new n.FPSLayer;I.setLayer("fps",E)}a.displayResourceStats&&I.setLayer("resourceStats",
new n.ResourceStatsLayer);TILE5.Touch.captureTouch(e,{observable:I});I.bind("move",function(y,B,G){I.updateOffset(o.x+y,o.y+B,G);u=TILE5.Clock.getTime(true);h();S=t.PAN});I.bind("moveEnd",function(){S=t.ACTIVE;setTimeout(h,50)});I.bind("pinchZoom",function(y,B){l(y,B);if(O=Q!==1){u=TILE5.Clock.getTime(true);S=n.DisplayState.PINCHZOOM;h()}});I.bind("pinchZoomEnd",function(y,B){l(y,B);b(true);Q=1});h();return I}};return n}();
TILE5.Tiling=function(){function t(){if(!n){n=document.createElement("canvas");n.width=l.Config.TILESIZE;n.height=l.Config.TILESIZE;var b=n.getContext("2d");b.fillStyle="rgba(150, 150, 150, 0.025)";b.fillRect(0,0,n.width,n.height)}return n}function q(){function b(){var k=document.createElement("canvas");k.width=32;k.height=32;var m=k.getContext("2d");m.fillStyle="#BBBBBB";m.fillRect(0,0,32,32);m.fillStyle="#C3C3C3";m.fillRect(0,0,16,16);m.fillRect(16,16,16,16);return k}if(!a){a=document.createElement("canvas");
a.width=l.Config.TILESIZE;a.height=l.Config.TILESIZE;var d=a.getContext("2d");d.fillStyle=d.createPattern(b(),"repeat");d.fillRect(0,0,a.width,a.height)}return a}TileStore=function(b){b=GRUNT.extend({tileSize:null,gridSize:25,center:new TILE5.Vector,onPopulate:null},b);if(!b.tileSize)throw Error("Cannot create TileStore with an empty tile size");var d=Array(Math.pow(b.gridSize,2)),k=TILE5.V.offset(b.center,-Math.ceil(b.gridSize>>1)),m=null,f=new TILE5.Vector,h=null,g={getGridSize:function(){return b.gridSize},
getNormalizedPos:function(e,r){return TILE5.V.add(new TILE5.Vector(e,r),TILE5.V.invert(k),f)},getTileShift:function(){return TILE5.V.copy(f)},getTile:function(e,r){return e>=0&&e<b.gridSize?d[r*b.gridSize+e]:null},setTile:function(e,r,o){d[r*b.gridSize+e]=o},populate:function(e,r){var o=GRUNT.Log.getTraceTicks(),s=0,p=b.gridSize,u=b.tileSize;new TILE5.Vector(p/2,p/2);if(e){GRUNT.Log.info("populating grid, x shift = "+f.x+", y shift = "+f.y);for(var v=0;v<p;v++)for(var w=0;w<p;w++){if(!d[s]){var x=
e(w,v,k,p);x.gridX=w*u-f.x;x.gridY=v*u-f.y;d[s]=x}s++}}m=e;h=r;GRUNT.Log.trace("tile grid populated",o);b.onPopulate&&b.onPopulate()},getShiftDelta:function(e,r,o,s){var p=Math.floor(b.gridSize*0.2),u=new TILE5.Vector;if(e<0||e+o>b.gridSize)u.x=e<0?-p:p;if(r<0||r+s>b.gridSize)u.y=r<0?-p:p;return u},shift:function(e,r){if(!(e.x===0&&e.y===0)){var o=GRUNT.Log.getTraceTicks();GRUNT.Log.info("need to shift tile store grid, "+e.x+" cols and "+e.y+" rows.");var s=Array(d.length);s.length=d.length;for(var p=
0;p<b.gridSize;p++)for(var u=0;u<b.gridSize;u++)s[u*b.gridSize+p]=g.getTile(p+e.x,u+e.y);d=s;k=r?r(k,e):TILE5.V.add(k,e);f.x+=-e.x*b.tileSize;f.y+=-e.y*b.tileSize;GRUNT.Log.trace("tile storage shifted",o);g.populate(m,h)}},setOrigin:function(e,r){if(tileOrigin)shiftOrigin(e,r);else k=TILE5.V.offset(new TILE5.Vector(e,r),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var e=d.length;e--;)if(d[e])d[e].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var e=
d.length;e--;)if(d[e]){d[e].x=null;d[e].y=null}});return g};var n=null,a=null,l={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(b){return b=GRUNT.extend({x:0,y:0,gridX:0,gridY:0,size:256},b)},ImageTile:function(b){b=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},b);return new l.Tile(b)},TileGrid:function(b){function d(C,E){if(x){var D,L=[],M=new TILE5.Vector(Math.floor((C.x+p.x)*f),Math.floor((C.y+p.y)*f));tilesNeeded=false;for(var H=w;H--;)for(var J=v;J--;){D=
k.getTile(J+M.x,H+M.y);var z=new TILE5.Vector(J-x.x,H-x.y);D||(s=k.getShiftDelta(M.x,M.y,v,w));L.push({tile:D,centerness:TILE5.V.absSize(z)})}L.sort(function(F,K){return K.centerness-F.centerness});e||(e=Array(L.length));for(D=L.length;D--;){e[D]=L[D].tile;A.prepTile(e[D],E)}}}b=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},b);var k=new TileStore(GRUNT.extend({tileSize:b.tileSize,onPopulate:function(){h=true;A.wakeParent()}},
b)),m=Math.round(b.tileSize/2),f=b.tileSize?1/b.tileSize:0,h=false,g=true,e=null,r=false,o=false;new TILE5.Vector;var s=new TILE5.Vector,p=new TILE5.Vector;TILE5.Device.getConfig();var u=k.getGridSize()*b.tileSize,v,w,x,A=GRUNT.extend(new TILE5.Graphics.ViewLayer(b),{gridDimensions:new TILE5.Dimensions(u,u),cycle:function(C,E,D){C=0;if(s.x+s.y!==0){k.shift(s,b.shiftOrigin);p=k.getTileShift();s=new TILE5.Vector;C++}D!==TILE5.Graphics.DisplayState.PINCHZOOM&&d(E,D);return C+h?1:0},deactivate:function(){g=
false},prepTile:function(){},drawTile:function(){return false},draw:function(C,E,D,L){if(g){var M=(new Date).getTime(),H=E.x;E=E.y;var J=true,z=r||L===TILE5.Graphics.DisplayState.PINCHZOOM||TILE5.Animation.isTweening();if(!x){v=Math.ceil(D.width*f)+1;w=Math.ceil(D.height*f)+1;x=new TILE5.Vector(Math.floor((v-1)/2),Math.floor((w-1)/2))}if(e){if(b.drawGrid)C.strokeStyle="rgba(50, 50, 50, 0.3)";C.beginPath();for(D=e.length;D--;){var F=e[D];if(F){var K=F.gridX-H,O=F.gridY-E;J=((z?false:F.x===K&&F.y===
O)?false:A.drawTile(C,F,K,O,L))&&J}else J=false;b.drawGrid&&C.rect(K,O,b.tileSize,b.tileSize)}C.stroke();GRUNT.Log.trace("drawn tiles",M);J&&!o&&GRUNT.WaterCooler.say("tiles.drawn",{id:A.getId()});o=J;r=h=false}}},getTileVirtualXY:function(C,E,D){C=k.getNormalizedPos(C,E);C=new TILE5.Vector(C.x*b.tileSize,C.y*b.tileSize);if(D){C.x+=m;C.y+=m}return C},populate:function(C){k.populate(C,function(){})}});GRUNT.WaterCooler.listen("tile.loaded",function(){h=true;A.wakeParent()});GRUNT.WaterCooler.listen("grid.invalidate",
function(){r=true});return A},ImageTileGrid:function(b){function d(){GRUNT.WaterCooler.say("tile.loaded")}b=GRUNT.extend({},b);var k=t(),m=q(),f=TILE5.Graphics.DisplayState.ACTIVE,h=TILE5.Graphics.DisplayState.PAN,g=TILE5.Device.getConfig().requireFastDraw;return GRUNT.extend(new l.TileGrid(b),{drawTile:function(e,r,o,s,p){var u=TILE5.Resources.getImage(r.url),v=false;if(u&&u.complete&&u.width>0){e.drawImage(u,o,s);v=true;r.x=o;r.y=s}else p===h?e.drawImage(m,o,s):e.drawImage(k,o,s);return v},prepTile:function(e,
r){if(e&&(!g||r===f))TILE5.Resources.getImage(e.url)||TILE5.Resources.loadImage(e.url,d)}})},Tiler:function(b){b=GRUNT.extend({container:"",drawCenter:false,datasources:{},tileLoadThreshold:"first"},b);var d=new TILE5.Graphics.View(GRUNT.extend({},b,{pannable:true,scalable:true,scaleDamping:true}));GRUNT.extend(d,{getTileLayer:function(){return d.getLayer("grid0")},setTileLayer:function(k){d.setLayer("grid0",k);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(k){var m=
d.getOffset();return new TILE5.Vector(k.x+m.x,k.y+m.y)},cleanup:function(){d.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");GRUNT.WaterCooler.say("view.wake",{id:d.id})}});return d}};return l}();
TILE5.Geo=function(){function t(f,h){var g=null;for(var e in k)if(h){if(e==h&&k[e][f]){g=k[e];break}}else if(k[e][f]){g=k[e];break}return g}function q(f,h,g,e){var r=0;f=f.toUpperCase();for(var o in e){var s=h[o];if(s){var p=g[o];s=p?p(f,s):f.containsWord(s)?1:0;r+=s*e[o]}}return r}var n=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],a=Math.PI/180,l=180/Math.PI,b=null,d={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},k={},m={Engine:function(f){if(!f.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var h=GRUNT.extend({remove:function(){delete k[h.id]}},f);return k[h.id]=h},Radius:function(f,h){return{distance:parseInt(f,10),uom:h}},Position:function(f,h){return{lat:parseFloat(f?f:0),lon:parseFloat(h?h:0)}},BoundingBox:function(f,h){return{min:m.P.parse(f),max:m.P.parse(h)}},Address:function(f){return f=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},f)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var f={dist2rad:function(h){return h/6371},lat2pix:function(h,g){var e=parseFloat(h)*2*Math.PI/360;e=Math.sin(e);var r=0.08181919084262157*e;return Math.log((1+e)/(1-e)*Math.pow((1-r)/(1+r),0.08181919084262157))/2/g},lon2pix:function(h,g){return parseFloat(h)/180*Math.PI/g},pix2lon:function(h,g){return f.normalizeLon(h*g*180/Math.PI)},pix2lat:function(h,g){for(var e=Math.pow(Math.E,
-h*g),r=f.mercatorUnproject(e),o=f.findRadPhi(r,e),s=0;s<12&&Math.abs(r-o)>1.0E-7;){r=o;o=f.findRadPhi(r,e);s++}return o*180/Math.PI},mercatorUnproject:function(h){return Math.PI/2-2*Math.atan(h)},findRadPhi:function(h,g){var e=0.08181919084262157*Math.sin(h);return Math.PI/2-2*Math.atan(g*Math.pow((1-e)/(1+e),0.040909595421310785))},normalizeLon:function(h){for(;h<-180;)h+=360;for(;h>180;)h-=360;return h}};return f}(),GeoSearchResult:function(f){f=GRUNT.extend({id:null,caption:"",resultType:"",data:null,
pos:null,matchWeight:0},f);return GRUNT.extend(f,{toString:function(){return f.caption+(f.matchWeight?" ("+f.matchWeight+")":"")}})},GeoSearchAgent:function(f){f=GRUNT.extend({},f);return GRUNT.extend({},TILE5.Dispatcher.createAgent(f))},GeocodingAgent:function(f){f=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(h,g){try{if(!h.reverse&&!h.freeform)address=new m.Address(h);var e=m.getEngine("geocode");if(e)e.geocode({addresses:[h.freeform?h.freeform:address],complete:function(o,
s){if(g){var p=s;if(h.freeform)p=m.rankGeocodeResponses(h.freeform,p,m.getEngine("geocode"));g(p,f)}}})}catch(r){GRUNT.Log.exception(r)}}},f);return new m.GeoSearchAgent(f)},PointOfInterest:function(f){f=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},f);if(!f.pos&&f.lat&&f.lon)f.pos=new TILE5.Geo.Position(f.lat,f.lon);return GRUNT.extend({toString:function(){return f.id+": '"+f.title+"'"}},f)},POIStorage:function(f){function h(p){p=p?p:"default";r[p]||(r[p]=[]);
return r[p]}function g(p){var u=[];for(var v in r)for(var w=0;w<r[v].length;w++)if(!p||p(r[v][w]))u.push(r[v][w]);return u}function e(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:s.id,pois:s.getPOIs()})}f=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},f);var r={},o=true,s={id:GRUNT.generateObjectID(),getPOIs:function(){return g()},getOldPOIs:function(p,u){return g(function(v){return v.group==p&&v.retrieved<u})},getVisible:function(){return o},setVisible:function(p){if(p!=
o){o=p;f.visibilityChange&&f.visibilityChange()}},findById:function(p){var u=g(function(v){return v.id==p});return u.length>0?u[0]:null},findByBounds:function(p){return g(function(u){return TILE5.Geo.P.inBounds(u.pos,p)})},addPOIs:function(p,u){if(u)r={};for(var v=0;p&&v<p.length;v++){p[v].retrieved=TILE5.Clock.getTime(true);var w=p[v];h(w.group).push(w)}},removeGroup:function(p){if(r[p]){delete r[p];e()}},update:function(p){var u=[],v=0,w=p.length>0?p[0].group:"",x=TILE5.Clock.getTime(true);for(v=
0;v<p.length;v++){var A;a:{if(A=p[v])for(var C=h(A.group),E=0;E<C.length;E++)if(C[E].id==A.id){A=C[E];break a}A=null}if(A){A.retrieved=x;A.isNew=false}else u.push(p[v])}p=s.getOldPOIs(w,x);s.addPOIs(u);for(v=0;f.onPOIAdded&&v<u.length;v++)f.onPOIAdded(u[v]);for(v=0;v<p.length;v++){f.onPOIDeleted&&f.onPOIDeleted(p[v]);w=p[v];x=h(w.group);for(A=0;A<x.length;A++)if(x[A].id==w.id){x.splice(A,1);break}}u.length+p.length>0&&e()}};return s},MapProvider:function(){return{zoomLevel:0,checkZoomLevel:function(f){return f},
getCopyright:function(){},getMapTiles:function(){},getPositionForXY:function(){return null}}},P:function(){var f={calcDistance:function(h,g){if(f.empty(h)||f.empty(g))return 0;var e=(g.lat-h.lat).toRad()/2,r=(g.lon-h.lon).toRad()/2;e=Math.sin(e)*Math.sin(e)+Math.cos(h.lat.toRad())*Math.cos(g.lat.toRad())*Math.sin(r)*Math.sin(r);return 6371*2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e))},copy:function(h){return h?new m.Position(h.lat,h.lon):null},empty:function(h){return!h||h.lat===0&&h.lon===0},equal:function(h,
g){return h&&g&&h.lat==g.lat&&h.lon==g.lon},almostEqual:function(h,g){return h&&g&&Math.floor(h.lat*1E3)===Math.floor(g.lat*1E3)&&Math.floor(h.lon*1E3)===Math.floor(g.lon*1E3)},inArray:function(h,g){for(var e=m.P.equal,r=g.length;r--;)if(e(h,g[r]))return true;return false},inBounds:function(h,g){var e=!(m.P.empty(h)||m.P.empty(g));return e=(e=e&&h.lat>=g.min.lat&&h.lat<=g.max.lat)&&h.lon>=g.min.lon&&h.lon<=g.max.lon},parse:function(h){if(h)if(typeof h.lat!=="undefined")return f.copy(h);else{if(h.split)for(var g=
[" ",","],e=0;e<g.length;e++){var r=h.split(g[e]);if(r.length===2)return new m.Position(r[0],r[1])}}else return new m.Position;return null},parseArray:function(h){var g=h.length,e=Array(g);for(g=g;g--;)e[g]=f.parse(h[g]);GRUNT.Log.info("parsed "+e.length+" positions");return e},fromMercatorPixels:function(h,g,e){return new m.Position(TILE5.Geo.Utilities.pix2lat(g,e),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(h,e)))},toMercatorPixels:function(h,g){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(h.lon,
g),TILE5.Geo.Utilities.lat2pix(h.lat,g))},generalize:function(h,g,e){var r=h.length,o=[],s=null;e||(e=250);e/=1E3;GRUNT.Log.info("generalizing positions, must include "+g.length+" positions");for(var p=r;p--;)if(p===0)o.unshift(h[p]);else{var u=!s||m.P.inArray(h[p],g)?e:m.P.calcDistance(s,h[p]);if(h[p]&&u>=e){o.unshift(h[p]);s=h[p]}}GRUNT.Log.info("generalized "+r+" positions into "+o.length+" positions");return o},toString:function(h){return h?h.lat+" "+h.lon:""}};return f}(),B:function(){var f=
-(Math.PI/2),h=Math.PI/2,g=-Math.PI*2,e=Math.PI*2,r={calcSize:function(o,s,p){var u=new TILE5.Vector(0,s.lat-o.lat);if(typeof p==="undefined")p=true;u.x=p&&o.lon>s.lon?360-o.lon+s.lon:s.lon-o.lon;return u},createBoundsFromCenter:function(o,s){var p=s/6371,u=o.lat*a,v=o.lon*a,w=u-p,x=u+p;if(w>f&&x<h){u=Math.asin(Math.sin(p)/Math.cos(u));p=v-u;if(p<g)p+=2*Math.PI;v=v+u;if(v>e)v-=2*Math.PI}else{w=Math.max(w,f);x=Math.min(x,h);p=g;v=e}return new m.BoundingBox(new m.Position(w*l,p*l),new m.Position(x*
l,v*l))},expand:function(o,s){return new m.BoundingBox(new m.Position(o.min.lat-s,o.min.lon-m.Utilities.normalizeLon(s)),new m.Position(o.max.lat+s,o.max.lon+m.Utilities.normalizeLon(s)))},forPositions:function(o,s){var p=null,u=TILE5.Clock.getTime();s||(s="auto");for(var v=o.length;v--;)if(p){var w=r.calcSize(p.min,o[v],false),x=r.calcSize(o[v],p.max,false);if(w.x<0)p.min.lon=o[v].lon;if(w.y<0)p.min.lat=o[v].lat;if(x.x<0)p.max.lon=o[v].lon;if(x.y<0)p.max.lat=o[v].lat}else p=new TILE5.Geo.BoundingBox(o[v],
o[v]);if(s){if(s=="auto"){v=r.calcSize(p.min,p.max);s=Math.max(v.x,v.y)*0.3}p=r.expand(p,s)}GRUNT.Log.trace("calculated bounds for "+o.length+" positions",u);return p},getCenter:function(o){var s=m.B.calcSize(o.min,o.max);return new TILE5.Geo.Position(o.min.lat+s.y/2,o.min.lon+s.x/2)},getGeoHash:function(o){var s=TILE5.Geo.GeoHash.encode(o.min.lat,o.min.lon);o=TILE5.Geo.GeoHash.encode(o.max.lat,o.max.lon);GRUNT.Log.info("min hash = "+s+", max hash = "+o)},getZoomLevel:function(o,s){var p=r.getCenter(o),
u=n[Math.min(Math.round(Math.abs(p.lat)*0.05),n.length)],v=r.calcSize(o.min,o.max);p=Math.ceil(Math.log(n[3]*s.height/v.y)/Math.log(2));u=Math.ceil(Math.log(u*s.width/v.x)/Math.log(2));return Math.min(isNaN(p)?1E3:p,isNaN(u)?1E3:u)},isEmpty:function(o){return!o||m.P.empty(o.min)||m.P.empty(o.max)},toString:function(o){return"min: "+m.P.toString(o.min)+", max: "+m.P.toString(o.max)}};return r}(),A:function(){var f=/^(\d+).*$/,h=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(g,e){f.lastIndex=-1;
if(f.test(g))for(var r=g.replace(f,"$1"),o=e.split(","),s=0;s<o.length;s++){h.lastIndex=-1;if(h.test(o[s])){var p=h.exec(o[s]);if(r>=parseInt(p[1],10)&&r<=parseInt(p[2],10))return true}else if(r==o[s])return true}return false},normalize:function(g){if(!g)return"";g=g.toUpperCase();if(!b){var e=[];for(var r in d)e.push(r);b=RegExp("(\\s)("+e.join("|")+")(\\s|$)","i")}b.lastIndex=-1;if(e=b.exec(g))g=g.replace(b,"$1"+d[e[2]]);return g},toString:function(g){return g.streetDetails+" "+g.location}}}(),
getEngine:function(f){for(var h=null,g=1;!h&&g<arguments.length;g++)h=t(f,arguments[g]);h=h?h:t(f);if(!h)throw Error("Unable to find GEO engine with "+f+" capability");return h},rankGeocodeResponses:function(f,h,g){var e=[],r=m.AddressCompareFns;if(g&&g.compareFns)r=GRUNT.extend({},r,g.compareFns);for(g=0;g<h.length;g++)e.push(new m.GeoSearchResult({caption:m.A.toString(h[g]),data:h[g],pos:h[g].pos,matchWeight:q(f,h[g],r,m.GeocodeFieldWeights)}));e.sort(function(o,s){return s.matchWeight-o.matchWeight});
return e}};return m}();
TILE5.Geo.Location=function(){function t(a){function l(g){try{var e=new TILE5.Geo.Position(g.coords.latitude,g.coords.longitude),r=GRUNT.isPlainObject(g.coords.accuracy)&&g.coords.accuracy.horizontal?g.coords.accuracy.horizontal:g.coords.accuracy;GRUNT.Log.info("position success, accuracy = "+r);if(a.successCallback&&(!m||r<f))a.successCallback(e,r,k,g);if(r>a.highAccuracyCutoff&&k<2){k=2;a.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");a.watch||
d()}m=g;f=r}catch(o){GRUNT.Log.exception(o)}}function b(g){if(g.code===g.PERMISSION_DENIED)a.errorCallback&&a.errorCallback(g);else if(g.code===g.POSITION_UNAVAILABLE)a.errorCallback&&a.errorCallback(g);else if(g.code===g.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(a.timeout===0&&a.autoPhasing){k=1;a.timeout=q;a.enableHighAccuracy=false;d()}}}function d(){navigator.geolocation.getCurrentPosition(l,b,GRUNT.extend({},a,{enableHighAccuracy:false}))}a=GRUNT.extend({autoPhasing:true,
maximumAge:3E5,timeout:0,highAccuracyCutoff:10,watch:false,enableHighAccuracy:true,successCallback:null,errorCallback:null},a);var k=0,m=null,f=1E6,h;if(a.watch){navigator.geolocation.watchPosition(l,b,a);h=void 0}else h=d();return h}var q=3E3,n={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)n.get=t;return n}();
TILE5.Geo.GeoHash=function(){function t(q,n,a){if(n&a)q[0]=(q[0]+q[1])/2;else q[1]=(q[0]+q[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(q){var n=1,a=[],l=[];a[0]=-90;a[1]=90;l[0]=-180;l[1]=180;lat_err=90;lon_err=180;for(i=0;i<q.length;i++){c=q[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(n){lon_err/=2;t(l,cd,mask)}else{lat_err/=2;t(a,cd,mask)}n=!n}}a[2]=(a[0]+
a[1])/2;l[2]=(l[0]+l[1])/2;return{latitude:a,longitude:l}},encode:function(q,n,a){var l=1,b=[],d=[],k=0,m=0;a=a?a:12;geohash="";b[0]=-90;b[1]=90;d[0]=-180;for(d[1]=180;geohash.length<a;){if(l){mid=(d[0]+d[1])/2;if(n>mid){m|=BITS[k];d[0]=mid}else d[1]=mid}else{mid=(b[0]+b[1])/2;if(q>mid){m|=BITS[k];b[0]=mid}else b[1]=mid}l=!l;if(k<4)k++;else{geohash+=BASE32[m];m=k=0}}return geohash}}}();
TILE5.Geo.Search=function(){return{bestResults:function(t,q){q||(q=20);for(var n=t.length>0?t[0]:null,a=[],l=0;l<t.length;l++)if(n.matchWeight-t[l].matchWeight<=q)a.push(t[l]);else break;return a}}}();
TILE5.Geo.Routing=function(){var t={calculate:function(q){q=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},q);GRUNT.Log.info("attempting to calculate route");var n=TILE5.Geo.getEngine("route");n&&n.route(q,function(a){if(q.generalize)a.geometry=TILE5.Geo.P.generalize(a.geometry,a.getInstructionPositions());if(q.map){t.createMapOverlay(q.map,a);if(q.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+a.boundingBox);q.map.gotoBounds(a.boundingBox)}}q.success&&
q.success(a)})},createMapOverlay:function(q,n){var a=q.getDimensions();a=new TILE5.Geo.UI.RouteOverlay({data:n,width:a.width,height:a.height});q.setLayer("route",a)},parseTurnType:function(q){for(var n=t.TurnType.Unknown,a=TILE5.Geo.Routing.TurnTypeRules,l=0;l<a.length;l++){a[l].regex.lastIndex=-1;var b=a[l].regex.exec(q);if(b){n=a[l].customCheck?a[l].customCheck(q,b):a[l].turnType;break}}return n},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",
TurnLeft:"turn-left",TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(q){q=GRUNT.extend({position:null,description:"",turnType:null},q);if(!q.turnType)q.turnType=t.parseTurnType(q.description);return q},RouteData:function(q){q=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},q);if(!q.boundingBox)q.boundingBox=TILE5.Geo.B.forPositions(q.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var n=[],a=0;a<q.instructions.length;a++)q.instructions[a].position&&n.push(q.instructions[a].position);return n}},q)}};return t}();
TILE5.Geo.Routing.TurnTypeRules=function(){var t=TILE5.Geo.Routing.TurnType,q=[];q.push({regex:/continue/i,turnType:t.Continue});q.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(n,a){return/bear/i.test(a[1])?t.TurnLeftSlight:t.TurnLeft}});q.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(n,a){return/bear/i.test(a[1])?t.TurnRightSlight:t.TurnRight}});q.push({regex:/enter\s(roundabout|rotaty)/i,turnType:t.EnterRoundabout});q.push({regex:/take.*?ramp/i,turnType:t.Ramp});
q.push({regex:/take.*?exit/i,turnType:t.RampExit});q.push({regex:/make(.*?)u\-turn/i,customCheck:function(n,a){return/right/i.test(a[1])?t.UTurnRight:t.UTurnLeft}});q.push({regex:/proceed/i,turnType:t.Start});q.push({regex:/arrive/i,turnType:t.Arrive});q.push({regex:/fell\sthrough/i,turnType:t.Merge});return q}();
TILE5.Geo.UI=function(){function t(a){a=GRUNT.extend({size:12,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},a);var l=null,b=function(){var d=document.createElement("canvas");d.width=a.size*4;d.height=a.size*4;var k=d.getContext("2d"),m=new TILE5.Vector(d.width/2,d.height/2),f=a.size,h=["#FFFFFF","#333333"],g=[3,1.5];k.lineCap="round";for(var e=0;e<h.length;e++){var r=f;k.lineWidth=g[e];k.strokeStyle=
h[e];k.beginPath();k.moveTo(m.x,m.y-r);k.lineTo(m.x,m.y+r);k.moveTo(m.x-r,m.y);k.lineTo(m.x+r,m.y);k.arc(m.x,m.y,f*0.6666,0,2*Math.PI,false);k.stroke()}return d}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(d,k,m){if(!l){l=TILE5.D.getCenter(m);l=new TILE5.Vector(Math.round(l.x-b.width/2),Math.round(l.y-b.height/2))}d.drawImage(b,l.x,l.y)}})}var q=0,n={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,
radsPerPixel:0},a);var l=TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),b=l.x-a.centerXY.x,d=l.y-a.centerXY.y,k=GRUNT.extend({},a.grid,{getBoundingBox:function(m,f,h,g){return new TILE5.Geo.BoundingBox(k.pixelsToPos(new TILE5.Vector(m,f+g)),k.pixelsToPos(new TILE5.Vector(m+h,f)))},getGridXYForPosition:function(m){m=TILE5.Geo.P.toMercatorPixels(m,a.radsPerPixel);return new TILE5.Vector(m.x-b,k.gridDimensions.height-(m.y-d))},getPixelDistance:function(m){m=TILE5.Geo.Utilities.dist2rad(m);
return Math.floor(m/a.radsPerPixel)},pixelsToPos:function(m){return TILE5.Geo.P.fromMercatorPixels(b+m.x,d+k.gridDimensions.height-m.y,a.radsPerPixel)}});return k},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var l=true,b=null,d=[],k=0,m=[],f=[],h=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(g,e,r,o){if(l)return null;
var s="routeAnimation"+q++;f.push(s);return new TILE5.Graphics.AnimatedPathLayer({id:s,path:d,zindex:a.zindex+1,easing:g?g:TILE5.Animation.Easing.Sine.InOut,duration:e?e:5E3,drawIndicator:r,autoCenter:o?o:false})},draw:function(g,e,r,o,s){r=0;o=a.data?a.data.geometry:null;if(l){l=false;b=null;d=[];k=0}if(o&&k<o.length){a:{s=s.getTileLayer();m=[];if(s){o=GRUNT.Log.getTraceTicks();var p,u,v,w=a.data?a.data.geometry:[],x=w.length,A=a.data?a.data.instructions:[],C=A.length,E=a.calculationsPerCycle,D=
0;for(p=k;p<x;p++){u=s.getGridXYForPosition(w[p]);if(v=!b||p===0||Math.abs(u.x-b.x)+Math.abs(u.y-b.y)>a.pixelGeneralization){d.push(u);b=u}D++;if(D>=E){k=p;break a}}k=x;GRUNT.Log.trace(x+" geometry points generalized to "+d.length+" coordinates",o);b=null;for(p=C;p--;)if(A[p].position){u=s.getGridXYForPosition(A[p].position);if(v=!b||p===0||Math.abs(u.x-b.x)+Math.abs(u.y-b.y)>a.pixelGeneralization){m.push(u);b=u}}}}r++}s=d.length;if(s>0&&(!r||a.partialDraw)){g.strokeStyle=a.strokeStyle;g.lineWidth=
a.lineWidth;g.beginPath();g.moveTo(d[s-1].x-e.x,d[s-1].y-e.y);for(s=s;s--;)g.lineTo(d[s].x-e.x,d[s].y-e.y);g.stroke();g.fillStyle=a.waypointFillStyle;for(s=m.length;s--;){g.beginPath();g.arc(m[s].x-e.x,m[s].y-e.y,2,0,Math.PI*2,false);g.stroke();g.fill()}}return r}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var g=f.length;g--;)GRUNT.WaterCooler.say("layer.remove",{id:f[g]});f=[];l=true;h.wakeParent()});return h},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:n.AnnotationTween,
animationSpeed:null},a);var l=false,b={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return l},draw:function(d,k,m,f){if(b.xy){if(b.isNew&&a.tweenIn){var h=b.xy.y;b.xy.y=k.y-20;l=true;TILE5.Animation.tween(b.xy,"y",h,a.tweenIn,function(){b.xy.y=h;l=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(d,k,new TILE5.Vector(b.xy.x-k.x,b.xy.y-k.y),m,f);else{d.beginPath();d.arc(b.xy.x-k.x,b.xy.y-k.y,4,0,Math.PI*2,false);d.fill()}b.isNew=false}}};return b},ImageAnnotation:function(a){a=
GRUNT.extend({imageUrl:null,animatingImageUrl:null,imageAnchor:null},a);var l=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;a.draw=function(d,k,m,f,h){if(a.animatingImageUrl&&b.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);f=a.animatingImageUrl}else f=a.imageUrl;if(k=TILE5.Resources.getImage(f)){if(k.complete&&k.width>0){l||(l=new TILE5.Vector(-k.width>>1,-k.height>>1));m=TILE5.V.offset(m,l.x,l.y);d.drawImage(k,m.x,m.y,k.width,k.height)}}else TILE5.Resources.loadImage(f,function(){h.wakeParent()})};
var b=new n.Annotation(a);return b},AnnotationsOverlay:function(a){function l(f){for(var h=a.map?a.map.getTileLayer():null,g=0;h&&g<f.length;g++)f[g].xy=h.getGridXYForPosition(f[g].pos)}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var b=[],d=false,k=[],m=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){return d?1:0},draw:function(f,h,g,e){d=false;f.fillStyle="rgba(255, 0, 0, 0.75)";f.globalCompositeOperation="source-over";for(g=b.length;g--;){b[g].draw(f,
h,e,m);d=d||b[g].isAnimating()}for(g=k.length;g--;){k[g].draw(f,h,e,m);d=d||k[g].isAnimating()}return d?1:0},add:function(f){k.push(f);l(k);m.wakeParent()},clear:function(f){k=[];l(k);if(f){b=[];l(b)}m.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(f){if(a.pois&&a.pois.id==f.srcID){f=f.pois;try{b=[];for(var h=0;h<f.length;h++)if(f[h].pos){var g;var e=f[h];if(e&&e.pos){var r=null;if(r=a.createAnnotationForPOI?a.createAnnotationForPOI(e):new n.Annotation({pos:e.pos})){r.isNew=
e.isNew;e.isNew=false}g=r}else g=void 0;g&&b.push(g)}l(b)}catch(o){GRUNT.Log.exception(o)}m.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){l(b);l(k);m.wakeParent()});return m},GeoLocationOverlay:function(a){function l(){var g=a.map?a.map.getTileLayer():null;d=null;if(m&&g)d=g.getGridXYForPosition(m);k=0;if(f&&g)k=g.getPixelDistance(f/1E3)}a=GRUNT.extend({fillStyle:"rgba(0, 221, 238, 0.1)",strokeStyle:"rgba(0, 102, 136, 0.3)",originFillStyle:"rgba(0, 102, 136, 0.7)",zindex:100,
map:null,watch:true,onUpdate:null},a);var b=0,d=null,k=0,m=null,f=0,h=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){},draw:function(g,e){if(d&&k){var r=d.x-e.x,o=d.y-e.y;g.fillStyle=a.fillStyle;g.lineWidth=1;g.strokeStyle=a.strokeStyle;g.beginPath();g.arc(r,o,k,0,Math.PI*2,false);g.fill();g.stroke();g.fillStyle=a.originFillStyle;g.beginPath();g.arc(r,o,3,0,Math.PI*2,false);g.fill();GRUNT.WaterCooler.say("grid.invalidate")}},getPosition:function(){return m},getAccuracy:function(){return f}});
GRUNT.WaterCooler.listen("grid.updated",function(){l();h.wakeParent()});(function(){b=TILE5.Geo.Location.get({watch:a.watch,successCallback:function(g,e){a.onUpdate&&a.onUpdate(g,e);m=TILE5.Geo.P.copy(g);f=e;l()},errorCallback:function(){GRUNT.Log.info("got position error")}})})();return h},Tiler:function(a){a=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,copyright:undefined,zoomLevel:0,boundsChange:null,tapPOI:null,tapHandler:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,
createAnnotationForPOI:null,onTilesLoaded:null},a);if(typeof a.copyright==="undefined")a.copyright=a.provider?a.provider.getCopyright():"";var l=new TILE5.Vector,b=a.copyright,d=false,k=[],m=0,f=null,h=null,g=a.zoomLevel;if(!a.provider)a.provider=new TILE5.Geo.MapProvider;var e=GRUNT.extend({},new TILE5.Tiling.Tiler(a),{pois:a.pois,annotations:null,getBoundingBox:function(){var o=e.getTileLayer(),s=e.getOffset(),p=e.getDimensions();if(o)return o.getBoundingBox(s.x,s.y,p.width,p.height);return null},
getCenterPosition:function(){return e.getXYPosition(TILE5.D.getCenter(e.gridDimensions))},getXYPosition:function(o){return e.getTileLayer().pixelsToPos(e.viewPixToGridPix(o))},gotoBounds:function(o,s){var p=TILE5.Geo.B.getZoomLevel(o,e.getDimensions());e.gotoPosition(TILE5.Geo.B.getCenter(o),p,s)},gotoCurrentPosition:function(o){function s(u,v){var w=TILE5.Geo.B.createBoundsFromCenter(u,v/1E3);GRUNT.Log.info("detected position: "+TILE5.Geo.P.toString(u)+", accuracy = "+v);e.clearBackground();e.gotoBounds(w,
o)}var p=e.getLayer("geolocation");if(p)s(p.getPosition(),p.getAccuracy());else{p=new n.GeoLocationOverlay({map:e,onUpdate:function(u,v){s(u,v)}});GRUNT.Log.info("created geolocation layer");e.setLayer("geolocation",p)}},gotoPosition:function(o,s,p){var u=g,v=(new Date).getTime(),w=false,x=e.getBoundingBox();if(x){x=TILE5.Geo.B.getCenter(x);x=TILE5.Geo.P.calcDistance(x,o);GRUNT.Log.info("distance between current position and new position = "+x);if(x>100)w=true}g=s?s:g;if(!g)throw"Zoom level required to goto a position.";
if(a.provider)g=a.provider.checkZoomLevel(g);if(w||!d||g!==u){TILE5.Resources.resetImageLoadQueue();(s=e.getTileLayer())&&s.deactivate();TILE5.Animation.cancel();d&&e.freeze();m=v;a.provider.zoomLevel=g;a.provider.getMapTiles(e,o,function(A){if(v===m){e.setTileLayer(A);h=A.getId();e.panToPosition(o,function(){e.unfreeze();p&&p()})}else GRUNT.Log.info("request time mismatch - ignoring update")});d=true}else e.panToPosition(o,p)},panToPosition:function(o,s,p){var u=e.getTileLayer();if(u){o=u.getGridXYForPosition(o);
u=e.getDimensions();o.x-=u.width/2;o.y-=u.height/2;if(f)f=null;e.updateOffset(o.x,o.y,p);GRUNT.WaterCooler.say("view.wake",{id:e.id});a.boundsChange&&a.boundsChange(e.getBoundingBox());s&&s(e)}},setZoomLevel:function(o){e.gotoPosition(e.getCenterPosition(),o)},zoomIn:function(){e.scale(2,TILE5.Animation.Easing.Sine.Out)||e.setZoomLevel(g+1)},zoomOut:function(){e.scale(0.5,TILE5.Animation.Easing.Sine.Out)||e.setZoomLevel(g-1)},animateRoute:function(o,s,p,u){var v=e.getLayer("route");if(v)(o=v.getAnimation(o,
s,p,u))&&o.addToView(e)}});e.bind("tap",function(o,s){var p=e.getTileLayer(),u=null;if(p){u=e.viewPixToGridPix(new TILE5.Vector(s.x,s.y));p.pixelsToPos(u);var v=p.pixelsToPos(TILE5.V.offset(u,-a.tapExtent,a.tapExtent)),w=p.pixelsToPos(TILE5.V.offset(u,a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(p.pixelsToPos(u)));u=new TILE5.Geo.BoundingBox(v,w);k=e.pois.findByBounds(u);a.tapPOI&&a.tapPOI(k)}});e.bind("doubleTap",function(o,s){e.animate(2,TILE5.D.getCenter(e.getDimensions()),
new TILE5.Vector(s.x,s.y),TILE5.Animation.Easing.Sine.Out)});e.bind("scale",function(o,s){var p=0;o=Math.sqrt(o);if(o<1)p=-(0.5/o);else if(o>1)p=o;e.gotoPosition(e.getXYPosition(s),g+Math.floor(p))});var r=new TILE5.Geo.UI.AnnotationsOverlay({pois:e.pois,map:e,createAnnotationForPOI:a.createAnnotationForPOI});e.annotations=r;e.setLayer("annotations",r);a.crosshair&&e.setLayer("crosshair",new t);b&&e.setLayer("copyright",new TILE5.Graphics.ViewLayer({zindex:999,draw:function(o,s,p){o.lineWidth=2.5;
o.fillStyle="rgb(50, 50, 50)";o.strokeStyle="rgba(255, 255, 255, 0.8)";o.font="bold 10px sans";o.textBaseline="bottom";o.strokeText(b,10,p.height-10);o.fillText(b,10,p.height-10)}}));GRUNT.WaterCooler.listen("view.idle",function(o){if(o.id&&o.id==e.id)if(TILE5.V.absSize(TILE5.V.diff(l,e.getOffset()))>a.boundsChangeThreshold&&a.boundsChange){l=e.getOffset();a.boundsChange(e.getBoundingBox())}});GRUNT.WaterCooler.listen("tiles.drawn",function(o){o.id&&o.id==h&&a.onTilesLoaded&&a.onTilesLoaded()});return e}};
return n}();
