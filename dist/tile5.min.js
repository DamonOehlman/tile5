if(!this.JSON)this.JSON={};
(function(){function t(f){return f<10?"0"+f:f}function q(f){k.lastIndex=0;return k.test(f)?'"'+f.replace(k,function(g){var b=h[g];return typeof b==="string"?b:"\\u"+("0000"+g.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+f+'"'}function m(f,g){var b,n,o,r,s=d,p,u=g[f];if(u&&typeof u==="object"&&typeof u.toJSON==="function")u=u.toJSON(f);if(typeof l==="function")u=l.call(g,f,u);switch(typeof u){case "string":return q(u);case "number":return isFinite(u)?String(u):"null";case "boolean":case "null":return String(u);
case "object":if(!u)return"null";d+=e;p=[];if(Object.prototype.toString.apply(u)==="[object Array]"){r=u.length;for(b=0;b<r;b+=1)p[b]=m(b,u)||"null";o=p.length===0?"[]":d?"[\n"+d+p.join(",\n"+d)+"\n"+s+"]":"["+p.join(",")+"]";d=s;return o}if(l&&typeof l==="object"){r=l.length;for(b=0;b<r;b+=1){n=l[b];if(typeof n==="string")if(o=m(n,u))p.push(q(n)+(d?": ":":")+o)}}else for(n in u)if(Object.hasOwnProperty.call(u,n))if(o=m(n,u))p.push(q(n)+(d?": ":":")+o);o=p.length===0?"{}":d?"{\n"+d+p.join(",\n"+d)+
"\n"+s+"}":"{"+p.join(",")+"}";d=s;return o}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+t(this.getUTCMonth()+1)+"-"+t(this.getUTCDate())+"T"+t(this.getUTCHours())+":"+t(this.getUTCMinutes())+":"+t(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var a=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
k=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,d,e,h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},l;if(typeof JSON.stringify!=="function")JSON.stringify=function(f,g,b){var n;e=d="";if(typeof b==="number")for(n=0;n<b;n+=1)e+=" ";else if(typeof b==="string")e=b;if((l=g)&&typeof g!=="function"&&(typeof g!=="object"||typeof g.length!=="number"))throw Error("JSON.stringify");return m("",
{"":f})};if(typeof JSON.parse!=="function")JSON.parse=function(f,g){function b(o,r){var s,p,u=o[r];if(u&&typeof u==="object")for(s in u)if(Object.hasOwnProperty.call(u,s)){p=b(u,s);if(p!==undefined)u[s]=p;else delete u[s]}return g.call(o,r,u)}var n;f=String(f);a.lastIndex=0;if(a.test(f))f=f.replace(a,function(o){return"\\u"+("0000"+o.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(f.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){n=eval("("+f+")");return typeof g==="function"?b({"":n},""):n}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(t){if(arguments.length<=1)return t;for(var q=arguments.length-2,m=0;m<=q;m++)t=t.replace(RegExp("\\{"+m+"\\}","gi"),arguments[m+1]);return t};
String.prototype.containsWord=function(t){var q="";if(t.toString)t=t.toString();for(var m=0;m<t.length;m++)q+=!/\w/.test(t[m])?"\\"+t[m]:t[m];return RegExp("(^|\\s|\\,)"+q+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var t=Object.prototype.hasOwnProperty,q=0,m={id:"GRUNT.core",extend:function(){var a=arguments[0]||{},k=1,d=arguments.length,e=false,h,l,f,g;if(typeof a==="boolean"){e=a;a=arguments[1]||{};k=2}if(typeof a!=="object"&&!m.isFunction(a))a={};if(d===k){a=this;--k}for(;k<d;k++)if((h=arguments[k])!=null)for(l in h){f=a[l];g=h[l];if(a!==g)if(e&&g&&(m.isPlainObject(g)||m.isArray(g))){f=f&&(m.isPlainObject(f)||m.isArray(f))?f:m.isArray(g)?[]:{};a[l]=m.extend(e,f,g)}else if(g!==undefined)a[l]=
g}return a},isFunction:function(a){return toString.call(a)==="[object Function]"},isArray:function(a){return toString.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||toString.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!t.call(a,"constructor")&&!t.call(a.constructor.prototype,"isPrototypeOf"))return false;var k;for(k in a);return k===undefined||t.call(a,k)},isEmptyObject:function(a){for(var k in a)return false;return true},isXmlDocument:function(a){return toString.call(a)===
"[object Document]"},contains:function(a,k){var d=a,e=arguments,h=1;if(k&&m.isArray(k)){e=k;h=0}for(h=h;h<e;h++)d=d&&typeof foo[e[h]]!=="undefined";return d},newModule:function(a){a=m.extend({id:null,requires:[],parent:null},a);if(a.parent)a=m.extend({},a.parent,a);return a},toID:function(a){return a.replace(/\s/g,"-")},generateObjectID:function(a){return(a?a:"obj")+q++}};return m}();
GRUNT.Log=function(){function t(d,e){var h,l=e&&e.length>0?e[0]:"";for(h=1;e&&h<e.length;h++)l+=" "+(m&&GRUNT.isPlainObject(e[h])?JSON.stringify(e[h]):e[h]);typeof console!=="undefined"&&console[d](l);for(h=0;h<q.length;h++)q[h].call(k,l,d)}var q=[],m=typeof JSON!=="undefined",a=window.console&&window.console.markTimeline,k={id:"GRUNT.log",getTraceTicks:function(){return a?(new Date).getTime():null},trace:function(d,e){if(a)console.markTimeline(d+(e?": "+(k.getTraceTicks()-e)+"ms":""))},debug:function(){t("debug",
arguments)},info:function(){t("info",arguments)},warn:function(){t("warn",arguments)},error:function(){t("error",arguments)},exception:function(d){k.error(arguments);for(var e in d)k.info("ERROR DETAIL: "+e+": "+d[e])},watch:function(d,e){try{e()}catch(h){k.exception(h,d)}},throwError:function(d){k.error(d);throw Error(d);},requestUpdates:function(d){q.push(d)}};return k}();
GRUNT.Data=function(){var t={determineObjectMapping:function(m){if(!m)return null;m=m.split("|");for(var a={},k=0;k<m.length;k++)a[m[k]]=k;return a},mapLineToObject:function(m,a){var k=m.split("|"),d={};for(var e in a){var h=a[e];d[e]=k.length>h?k[h]:null}return d},parse:function(m){var a=null,k=[];m=m.split("\n");for(var d=0;d<m.length;d++){var e=m[d];if(a)k.push(t.mapLineToObject(e,a));else a=t.determineObjectMapping(e)}return k}},q={supportedFormats:{JSON:{parse:function(m){return JSON.parse(m)}},
PDON:{parse:function(m){return t.parse(m)}}},parse:function(m){m=GRUNT.extend({data:"",format:"JSON"},m);if(!q.supportedFormats[m.format])throw Error("Unsupported data format: "+m.format+", cannot parse data in javascript object");try{return q.supportedFormats[m.format].parse(m.data)}catch(a){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+m.format,m.data);GRUNT.Log.exception(a)}return{}}};return q}();
GRUNT.Template=function(){var t=/\$\{(.*?)\}/ig;return{parse:function(q,m){for(var a=q,k=t.exec(a);k;){a=a.replace(k[0],GRUNT.XPath.first(k[1],m));t.lastIndex=0;k=t.exec(a)}return a}}}();
GRUNT.JSONP=function(){function t(k){var d=document.createElement("script"),e=false;d.src=k;d.async=true;d.onload=d.onreadystatechange=function(){if(!e&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){e=true;d.onload=d.onreadystatechange=null;d&&d.parentNode&&d.parentNode.removeChild(d)}};m||(m=document.getElementsByTagName("head")[0]);m.appendChild(d)}var q=0,m,a=this;return{get:function(k,d){k+=k.indexOf("?")>=0?"&":"?";var e="json"+ ++q;a[e]=function(h){d(h);a[e]=
null;try{delete a[e]}catch(l){}};t(k+"callback="+e);return e}}}();
GRUNT.XHR=function(){var t={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},q={JSON:["json"],PDON:["pdon.txt"]},m=["TEXT","STREAM"],a=/^(\w+:)?\/\/([^\/?#]+)/,k={XML:function(h){return h.responseXML},JSON:function(h){try{return JSON.parse(h.responseText)}catch(l){GRUNT.Log.error("Error parsing JSON data: ",h.responseText);GRUNT.Log.exception(l)}return""},PDON:function(h){return GRUNT.Data.parse({data:h.responseText,format:"PDON"})},DEFAULT:function(h){return h.responseText}},
d={CONTENT_TYPE:"Content-Type"},e=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(h){try{h=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},e.ajaxSettings,h);var l=a.exec(h.url),f=l&&(l[1]&&l[1]!==location.protocol||l[2]!==location.host);if(h.data)h.method="POST";if(h.url){l=null;if(h.xhr)l=h.xhr(h);l||(l=new XMLHttpRequest);l.open(h.method,h.url,h.async);h.data&&l.setRequestHeader("Content-Type",
h.contentType);f||l.setRequestHeader("X-Requested-With","XMLHttpRequest");l.onreadystatechange=function(){if(this.readyState===4){var b=null,n=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(n)if(h.handleResponse)h.handleResponse(this);else{var o=h,r=this.getResponseHeader(d.CONTENT_TYPE),s,p=false;for(s in t)if(r&&r.indexOf(t[s])>=0){p=true;break}r=!p;for(p=0;p<m.length;p++)r=r||m[p]==s;if(r)b:{r=s;for(var u in q)for(p=
0;p<q[u].length;p++)if(RegExp(q[u][p]+"$","i").test(o.url)){s=u;break b}s=r?r:"DEFAULT"}try{b=k[s](this,o)}catch(v){GRUNT.Log.warn("error applying processor '"+s+"' to response type, falling back to default");b=k.DEFAULT(this,o)}}else h.error&&h.error(this)}catch(w){GRUNT.Log.exception(w,"PROCESSING AJAX RESPONSE")}n&&b&&h.success&&h.success.call(this,b)}};l.send(h.method=="POST"?e.param(h.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(g){GRUNT.Log.exception(g)}},
param:function(h){var l=[],f=function(b,n){n=GRUNT.isFunction(n)?n():n;l[l.length]=encodeURIComponent(b)+"="+encodeURIComponent(n)};if(GRUNT.isArray(h))for(var g=0;g<h.length;g++)f(h[g].name,h[g].value);else for(g in h)f(g,h[g]);return l.join("&").replace(/%20/g,"+")}});return e}();
GRUNT.XPath=function(){function t(k){for(var d=null,e=0;e<q.length;e++)if(d=q[e](k))break;return d}var q=[],m=[null,function(k){return k.numberValue},function(k){return k.stringValue},function(k){return k.booleanValue},null,null,null,null,function(k){return k.singleNodeValue?k.singleNodeValue.textContent:null},function(k){return k.singleNodeValue?k.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var a={SearchResult:function(k){return{toString:function(){var d=
null;if(k){var e=null;if(k.resultType>=0&&k.resultType<m.length)e=m[k.resultType];if(e){GRUNT.Log.info("invoking match handler for result type: "+k.resultType);d=e(k)}}return d?d:""}}},first:function(k,d){var e=a.SearchResult,h;var l=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!l)l=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(d))h=d.evaluate(k,d,t,l,null);else{GRUNT.Log.warn("attempted xpath expression: "+k+" on a non-xml document");h=null}}catch(f){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
k+" on node: "+d);h=null}return new e(h)},registerResolver:function(k){q.push(k)}};return a}();GRUNT.Observable=function(){var t={},q=0,m={bind:function(a,k){t[a]||(t[a]=[]);q+=1;t[a].push({callback:k,callbackId:q});return q},trigger:function(a){var k=t[a];if(k)for(var d=k.length;d--;)k[d].callback.apply(m,Array.prototype.slice.call(arguments,1))},unbind:function(a,k){for(var d=t[a],e=0;d&&e<d.length;e++)if(d[e].callbackId===k){d.splice(e,1);break}}};return m};
GRUNT.WaterCooler=function(){var t={},q=[];return{addPipe:function(m){m("pipe.test",{});q.push(m)},listen:function(m,a){t[m]||(t[m]=[]);a&&t[m].push(a)},say:function(m,a){var k;for(k=q.length;k--;)q[k](m,a);if(t[m])for(k=t[m].length;k--;)t[m][k](a)},leave:function(){}}}();
TILE5=function(){var t={newCanvas:function(q,m){var a=document.createElement("canvas");typeof G_vmlCanvasManager!==undefined&&G_vmlCanvasManager.initElement(a);a.width=q?q:0;a.height=m?m:0;return a},Settings:function(){var q={};return{get:function(m){return q[m]},set:function(m,a){q[m]=a},extend:function(m){GRUNT.extend(q,m)}}}(),Clock:function(){var q=null;return{getTime:function(m){return m&&q?q:q=(new Date).getTime()}}}(),Vector:function(q,m){return{x:q?q:0,y:m?m:0}},V:function(){function q(m){if(!m||
m.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var a={edges:Array(m.length-1),accrued:Array(m.length-1),total:0},k=TILE5.V.diff,d=0;d<m.length-1;d++){var e=k(m[d],m[d+1]);a.edges[d]=Math.sqrt(e.x*e.x+e.y*e.y);a.accrued[d]=a.total+a.edges[d];a.total+=a.edges[d]}return a}return{create:function(m,a){return new t.Vector(m,a)},add:function(){for(var m=new t.Vector,a=arguments.length;a--;){m.x+=arguments[a].x;m.y+=arguments[a].y}return m},absSize:function(m){return Math.max(Math.abs(m.x),
Math.abs(m.y))},diff:function(m,a){return new t.Vector(m.x-a.x,m.y-a.y)},copy:function(m){return m?new t.Vector(m.x,m.y):null},invert:function(m){return new TILE5.Vector(-m.x,-m.y)},offset:function(m,a,k){return new TILE5.Vector(m.x+a,m.y+(k?k:a))},edges:q,distance:function(m){return q(m).total},theta:function(m,a,k){k=Math.asin((m.y-a.y)/k);return m.x>a.x?k:Math.PI-k},pointOnEdge:function(m,a,k,d){a=new TILE5.Vector(Math.cos(k)*d,Math.sin(k)*d);return new TILE5.Vector(m.x-a.x,m.y-a.y)},getRect:function(m){var a=
m.length;if(a>1)return new TILE5.Rect(Math.min(m[0].x,m[a-1].x),Math.min(m[0].y,m[a-1].y),Math.abs(m[0].x-m[a-1].x),Math.abs(m[0].y-m[a-1].y))}}}(),Dimensions:function(q,m){return{width:q?q:0,height:m?m:0}},D:function(){return{getAspectRatio:function(q){return q.height!==0?q.width/q.height:1},getCenter:function(q){return new t.Vector(q.width/2,q.height/2)},getSize:function(q){return Math.sqrt(Math.pow(q.width,2)+Math.pow(q.height,2))}}}(),Rect:function(q,m,a,k){return{origin:new t.Vector(q,m),dimensions:new t.Dimensions(a,
k)}},R:function(){return{copy:function(q){return q?new t.Rect(q.origin.x,q.origin.y,q.dimensions.width,q.dimensions.height):null},getCenter:function(q){return new TILE5.Vector(q.origin.x+q.dimensions.width/2,q.origin.y+q.dimensions.height/2)}}}()};return t}();
TILE5.Device=function(){function t(){for(;g.length>0;){var n=g.shift();document.location=n}f=0}function q(n){for(var o=true,r=b.length;r--;)o=o&&n!=b[r];return o}function m(n,o){var r=[];for(var s in o)s&&r.push(s+"="+escape(o[s]));return"tile5://"+n+"/"+(r.length>0?"?"+r.join("&"):"")}function a(n,o){q(n)&&GRUNT.Log.info("would push url: "+m(n,o))}function k(n,o){if(q(n)){g.push(m(n,o));f||(f=setTimeout(t,100))}}function d(){e={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:4,requireFastDraw:false,bridgeNotify:a,targetFps:25},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true,bridgeNotify:k,targetFps:10},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:k},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:k},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,supportsTouch:true,
getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:k},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:k}};h=[e.froyo,e.android,e.ipod,e.iphone,e.ipad]}var e=null,h=[],l=null,f=0,g=[],b=["view.wake","tile.loaded"];return{getConfig:function(){e||d();if(!l){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var n=0;n<h.length;n++){var o=h[n];if(o.regex&&o.regex.test(navigator.userAgent)){l=GRUNT.extend({},
e.base,o);GRUNT.Log.info("PLATFORM DETECTED AS: "+l.name);break}}if(!l){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");l=e.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return l}}}();
TILE5.Resources=function(){var t="",q={},m=function(){function k(){var v=f[this.id];if(v){v.loaded=true;v.hitCount=1;for(var w=n.length;w--;)if(n[w].image.src==this.src){n.splice(w,1);break}v.loadCallback&&v.loadCallback(this,false);o.push({url:this.src,created:v.requested});delete f[this.id];d()}}function d(){for(var v=TILE5.Device.getConfig().maxImageLoads;b.length>0&&(!v||n.length<v);){var w=b.shift();if(w.imageLoader){n.push(w);w.imageLoader(w,k)}}}function e(v){for(var w=null,x=r.length;x--&&
!w;)w=r[x](v);return w?w:function(B,C){B.image.onload=C;B.image.src=a.getPath(B.url);B.requested=(new Date).getTime()}}function h(){p=true;try{var v=Math.floor(o.length/2);if(v>0){o.sort(function(x,B){return x.created-B.created});for(var w=v;w--;)delete l[o[w].url];o.splice(0,v)}}finally{p=false}GRUNT.WaterCooler.say("imagecache.cleared")}var l={},f={},g=0,b=[],n=[],o=[],r=[],s=0,p=false,u={loadingImages:n,queuedImages:b,addInterceptor:function(v){r.push(v)},getCacheFullness:function(){return s},
getImage:function(v){var w=null;p||(w=l[v]);return w?w.image:null},loadImage:function(v,w){var x=l[v];if(x){x.hitCount++;x.image.complete&&w&&w(x.image,true)}else{x={url:v,image:new Image,loaded:false,imageLoader:e(v),created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:w};x.image.id="resourceLoaderImage"+g++;l[v]=x;f[x.image.id]=x;b.push(x);d()}return x},resetLoadingQueue:function(){n=[]}};setInterval(function(){for(var v=(new Date).getTime(),w=false,x=0,B=TILE5.Device.getConfig();x<
n.length;)if(v-n[x].requested>a.loadTimeout*1E3){n.splice(x,1);w=true}else x++;w&&d();if(B&&B.imageCacheMaxSize){s=o.length*a.avgImageSize/B.imageCacheMaxSize;s>=1&&h()}},1E3);return u}(),a={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(k,d){for(var e=(k?k.replace(/^.*\?/,""):"").split("&"),h=k?k.replace(/\?.*$/,"?"):"",l=0;l<e.length;l++){var f=e[l].split("=");if(!d||!d.test(f[0]))h+=e[l]+"&"}return h.replace(/\W/g,
"")},isValidCacheKey:function(k){GRUNT.Log.info("cache key = "+k);return false}}}(),addInterceptor:m.addInterceptor,getPath:function(k){return/^(file|https?|\/)/.test(k)?k:t+k},setBasePath:function(k){t=k},getImage:function(k){return m.getImage(k)},loadImage:function(k,d){m.loadImage(k,d)},resetImageLoadQueue:function(){m.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:m.loadingImages.length,queuedImageCount:m.queuedImages.length,imageCacheFullness:m.getCacheFullness()}},loadResource:function(k){k=
GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},k);var d=function(e){k.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){k.callback(e)})};k.cacheable&&q[k.filename]?d(q[k.filename]):GRUNT.XHR.ajax({url:a.getPath(k.filename),dataType:k.dataType,success:function(e){if(k.cacheable)q[k.filename]=e;d(e)},error:function(e,h,l){GRUNT.Log.error("error loading resource ["+k.filename+"], error = "+l)}})},loadSnippet:function(k,d){/\.\w+$/.test(k)||(k+=".html");a.loadResource({filename:"snippets/"+
k,callback:d,dataType:"html"})}};return a}();
TILE5.Touch=function(){function t(f,g){var b=f&&f.length>0?f[0]:null;if(b&&g&&g.length>0)return TILE5.V.diff(b,g[0]);return null}function q(f){f.preventDefault();f.stopPropagation()}function m(f){for(var g=Array(f.length),b=f.length;b--;)g[b]=new TILE5.Vector(f[b].pageX,f[b].pageY);return g}var a={TAP:0,MOVE:1,PINCHZOOM:2},k=7,d=0,e=0,h={TouchHelper:function(f){function g(z){for(var G=[],J=f.element?-f.element.offsetLeft:0,O=f.element?-f.element.offsetTop:0,M=z.length;M--;)G.push(TILE5.V.offset(z[M],
J,O));return G}function b(){f.observable&&f.observable.trigger.apply(null,arguments)}function n(z){if(z.target&&z.target===f.element){v=u?m(z.touches):[new TILE5.Vector(z.pageX,z.pageY)];x=new TILE5.Vector;B=new TILE5.Vector;D=true;s=false;u&&q(z);N.current=TILE5.Clock.getTime();if(z=v.length>0?v[0]:null){b("touchStart",z.x,z.y);if(N.current-N.last<P.THRESHOLD_DOUBLETAP)if((z=w?TILE5.V.diff(v[0],w[0]):null)&&Math.abs(z.x)<f.maxDistDoubleTap&&Math.abs(z.y)<f.maxDistDoubleTap)s=true;E=a.TAP;w=[].concat(v)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}
function o(z){if(z.target&&z.target===f.element)if(D)try{u&&q(z);var G=u?m(z.touches):[new TILE5.Vector(z.pageX,z.pageY)];z=0;if(G.length>1){if(v.length===1)v=[].concat(G);z=TILE5.V.distance(v)-TILE5.V.distance(w)}if(E===a.TAP){var J=t(G,v);if(J&&(Math.abs(J.x)>=k||Math.abs(J.y)>=k))E=a.MOVE}if(E!==a.TAP)if(!z||Math.abs(z)<f.pinchZoomThreshold){if(x=t(G,w)){B.x-=x.x;B.y-=x.y;C.x-=x.x;C.y-=x.y}if(TILE5.V.absSize(C)>f.panEventThreshhold){b("move",C.x,C.y);C=TILE5.V.create()}E=a.MOVE}else{b("pinchZoom",
g(v),g(G));E=a.PINCHZOOM}w=[].concat(G)}catch(O){GRUNT.Log.exception(O)}}function r(z){if(z.target&&z.target===f.element)try{u&&q(z);TILE5.Clock.getTime();N.last=N.current;if(E===a.TAP)p||(p=setTimeout(function(){p=0;var J=s?"doubleTap":"tap",O=v[0],M=null;if(f.element)M=TILE5.V.offset(O,-f.element.offsetLeft,-f.element.offsetTop);b(J,O,M)},P.THRESHOLD_DOUBLETAP+50));else if(E==a.MOVE)b("moveEnd",B.x,B.y);else E==a.PINCHZOOM&&b("pinchZoomEnd",g(v),g(w))}catch(G){GRUNT.Log.exception(G)}D=false}f=GRUNT.extend({element:null,
observable:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},f);var s=false,p=0,u=TILE5.Device.getConfig().supportsTouch,v=null,w=null,x=null,B=null,C=new TILE5.Vector,E=null,D=false,K=[],N={current:0,last:0},H=TILE5.Device.getConfig(),P={supportsTouch:u,THRESHOLD_DOUBLETAP:300,addListeners:function(z){K.push(z)},
decoupleListeners:function(z){for(var G=0;z&&G<K.length;G++)if(K[G].listenerId===z){K.splice(G,1);GRUNT.Log.info("successfully decoupled touch listener: "+z);break}},release:function(){H.eventTarget.removeEventListener(H.supportsTouch?"touchstart":"mousedown",n,false);H.eventTarget.removeEventListener(H.supportsTouch?"touchmove":"mousemove",o,false);H.eventTarget.removeEventListener(H.supportsTouch?"touchend":"mouseup",r,false)},wheelie:function(z){var G=new TILE5.Vector(z.wheelDeltaX,z.wheelDeltaY);
z=new TILE5.Vector(z.clientX,z.clientY);GRUNT.Log.info("capture mouse wheel event, delta = "+G+", position = "+z)}};H.eventTarget.addEventListener(H.supportsTouch?"touchstart":"mousedown",n,false);H.eventTarget.addEventListener(H.supportsTouch?"touchmove":"mousemove",o,false);H.eventTarget.addEventListener(H.supportsTouch?"touchend":"mouseup",r,false);return P}},l=[];return{captureTouch:function(f,g){try{if(!f)throw Error("Unable to capture touch of null element");if(!f.id)f.id="touchable_"+d++;var b=
l[f.id];if(!b){b=h.TouchHelper(GRUNT.extend({element:f},g));l[f.id]=b;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+b.supportsTouch)}g.listenerId&&b.decoupleListeners(g.listenerId);g.listenerId=++e;b.addListeners(g)}catch(n){GRUNT.Log.exception(n)}},resetTouch:function(f){if(f&&f.id&&l[f.id]){l[f.id].release();delete l[f.id]}}}}();
if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(t){return this.each(function(){TILE5.Touch.captureTouch(this,t)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(t){t.preventDefault()})}}
TILE5.Dispatcher=function(){var t=[],q={execute:function(m){var a=q.findAction(m);GRUNT.Log.info("looking for action id: "+m+", found: "+a);if(a){var k=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+m,function(){a.execute(k)})}},findAction:function(m){for(var a=t.length;a--;)if(t[a].id==m)return t[a];return null},getRegisteredActions:function(){return[].concat(t)},getRegisteredActionIds:function(){for(var m=[],a=t.length;a--;)t[a].id&&m.push(t[a].id);return m},registerAction:function(m){m&&
m.id&&t.push(m)},Action:function(m){m=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},m);var a={id:m.id,execute:function(){m.execute&&m.execute.apply(this,arguments)},getParam:function(k){return m[k]?m[k]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",a.id,m.title,m.icon)}};m.autoRegister&&q.registerAction(a);return a},createAgent:function(m){m=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},m);var a=null,k={getName:function(){return m.name},
getParam:function(d){return m[d]},getId:function(){return GRUNT.toID(k.getName())},run:function(d,e){if(m.execute){var h=a=TILE5.Clock.getTime(true),l=m.translator?m.translator(d):d;m.execute.call(k,l,function(f,g){if(!m.trashOrphanedResults||h==a)e&&e(f,g,l)})}}};return k},runAgents:function(m,a,k){for(var d=0;d<m.length;d++)m[d].run(a,k)}};return q}();
TILE5.Animation=function(){function t(){if(a===0)a=setInterval(function(){var d;d=TILE5.Clock.getTime();if(!m){m=true;try{for(var e=0;e<q.length;)if(q[e].isComplete()){q[e].triggerComplete(false);q.splice(e,1);GRUNT.WaterCooler.say("animation.complete")}else{q[e].update(d);e++}}finally{m=false}}d=q.length;if(d===0){clearInterval(a);a=0}},20)}var q=[],m=false,a=0,k={DURATION:2E3,tweenValue:function(d,e,h,l,f){d=new k.Tween({startValue:d,endValue:e,tweenFn:h,complete:l,duration:f});q.push(d);return d},
tween:function(d,e,h,l,f,g){d=new k.Tween({target:d,property:e,endValue:h,tweenFn:l,duration:g,complete:f});q.push(d);return d},tweenVector:function(d,e,h,l,f,g){var b=[];if(d){var n=d.x==e,o=d.y==h;n||b.push(k.tween(d,"x",e,l,function(){(n=true)&&o&&f()},g));o||b.push(k.tween(d,"y",h,l,function(){o=true;n&&o&&f()},g))}return b},cancel:function(d){if(!m){m=true;try{for(var e=0;e<q.length;)if(!d||d(q[e])){GRUNT.Log.info("CANCELLING ANIMATION");q[e].triggerComplete(true);q.splice(e,1)}else e++}finally{m=
false}}},isTweening:function(){return q.length>0},Tween:function(d){d=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:k.DURATION,tweenFn:k.DEFAULT,complete:null,cancelOnInteract:false},d);var e=TILE5.Clock.getTime(),h=[],l=false,f=0,g=0,b={cancelOnInteract:d.cancelOnInteract,isComplete:function(){return l},triggerComplete:function(n){d.complete&&d.complete(n)},update:function(n){try{var o=d.tweenFn(n-e,f,g,d.duration);if(d.target)d.target[d.property]=o;for(var r=h.length;r--;)h[r](o,
void 0);if(l=e+d.duration<=n){if(d.target)d.target[d.property]=d.tweenFn(d.duration,f,g,d.duration);for(var s=h.length;s--;)h[s](o,true)}}catch(p){GRUNT.Log.exception(p)}},requestUpdates:function(n){h.push(n)}};f=d.target&&d.property&&d.target[d.property]?d.target[d.property]:d.startValue;if(typeof d.endValue!=="undefined")g=d.endValue-f;if(g==0)l=true;t();return b},Easing:function(){var d=1.70158;return{Linear:function(e,h,l,f){return l*e/f+h},Back:{In:function(e,h,l,f){return l*(e/=f)*e*((d+1)*
e-d)+h},Out:function(e,h,l,f){return l*((e=e/f-1)*e*((d+1)*e+d)+1)+h},InOut:function(e,h,l,f){return(e/=f/2)<1?l/2*e*e*(((d*=1.525)+1)*e-d)+h:l/2*((e-=2)*e*(((d*=1.525)+1)*e+d)+2)+h}},Bounce:{In:function(e,h,l,f){return l-k.Easing.Bounce.Out(f-e,0,l,f)+h},Out:function(e,h,l,f){return(e/=f)<1/2.75?l*7.5625*e*e+h:e<2/2.75?l*(7.5625*(e-=1.5/2.75)*e+0.75)+h:e<2.5/2.75?l*(7.5625*(e-=2.25/2.75)*e+0.9375)+h:l*(7.5625*(e-=2.625/2.75)*e+0.984375)+h},InOut:function(e,h,l,f){return e<f/2?k.Easing.Bounce.In(e*
2,0,l,f)/2+h:k.Easing.Bounce.Out(e*2-f,0,l,f)/2+l/2+h}},Cubic:{In:function(e,h,l,f){return l*(e/=f)*e*e+h},Out:function(e,h,l,f){return l*((e=e/f-1)*e*e+1)+h},InOut:function(e,h,l,f){if((e/=f/2)<1)return l/2*e*e*e+h;return l/2*((e-=2)*e*e+2)+h}},Elastic:{In:function(e,h,l,f,g,b){if(e==0)return h;if((e/=f)==1)return h+l;b||(b=f*0.3);if(!g||g<Math.abs(l)){g=l;l=b/4}else l=b/(2*Math.PI)*Math.asin(l/g);return-(g*Math.pow(2,10*(e-=1))*Math.sin((e*f-l)*2*Math.PI/b))+h},Out:function(e,h,l,f,g,b){var n;if(e==
0)return h;if((e/=f)==1)return h+l;b||(b=f*0.3);if(!g||g<Math.abs(l)){g=l;n=b/4}else n=b/(2*Math.PI)*Math.asin(l/g);return g*Math.pow(2,-10*e)*Math.sin((e*f-n)*2*Math.PI/b)+l+h},InOut:function(e,h,l,f,g,b){var n;if(e==0)return h;if((e/=f/2)==2)return h+l;b||(b=f*0.3*1.5);if(!g||g<Math.abs(l)){g=l;n=b/4}else n=b/(2*Math.PI)*Math.asin(l/g);if(e<1)return-0.5*g*Math.pow(2,10*(e-=1))*Math.sin((e*f-n)*2*Math.PI/b)+h;return g*Math.pow(2,-10*(e-=1))*Math.sin((e*f-n)*2*Math.PI/b)*0.5+l+h}},Quad:{In:function(e,
h,l,f){return l*(e/=f)*e+h},Out:function(e,h,l,f){return-l*(e/=f)*(e-2)+h},InOut:function(e,h,l,f){if((e/=f/2)<1)return l/2*e*e+h;return-l/2*(--e*(e-2)-1)+h}},Sine:{In:function(e,h,l,f){return-l*Math.cos(e/f*(Math.PI/2))+l+h},Out:function(e,h,l,f){return l*Math.sin(e/f*(Math.PI/2))+h},InOut:function(e,h,l,f){return-l/2*(Math.cos(Math.PI*e/f)-1)+h}}}}()};return GRUNT.extend(k,{DEFAULT:k.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var t={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},q=0,m={DisplayState:t,AnyDisplayState:255,ActiveDisplayStates:t.ACTIVE|t.ANIMATING,DefaultDisplayStates:t.ACTIVE|t.ANIMATING|t.PAN|t.PINCHZOOM,ViewLayer:function(a){a=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:m.DefaultDisplayStates},a);var k=null,d=a.id,e=GRUNT.extend({addToView:function(h){h.setLayer(d,e)},shouldDraw:function(h){var l=
k?k.fastDraw&&h!==t.ACTIVE:false;return(h&a.validStates)!==0&&(l?a.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:d})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:k?k.id:null})},getId:function(){return d},setId:function(h){d=h},getParent:function(){return k},setParent:function(h){k=h}},a);return e},AnimatedPathLayer:function(a){function k(g,b,n){g.fillStyle="#FFFFFF";g.strokeStyle="#222222";g.beginPath();
g.arc(n.x,n.y,4,0,Math.PI*2,false);g.stroke();g.fill()}a=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,validStates:m.ActiveDisplayStates|t.PAN|t.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},a);var d=TILE5.V.edges(a.path),e,h=null,l=0;TILE5.Animation.tweenValue(0,d.total,a.easing,function(){f.remove()},a.duration).requestUpdates(function(g,b){l=g;b&&f.remove()});var f=GRUNT.extend(new m.ViewLayer(a),{cycle:function(){for(var g=
0;g<d.accrued.length&&d.accrued[g]<l;)g++;h=null;if(g<a.path.length-1){var b=l-(g>0?d.accrued[g-1]:0),n=a.path[g],o=a.path[g+1];e=TILE5.V.theta(n,o,d.edges[g]);h=TILE5.V.pointOnEdge(n,o,e,b);if(a.autoCenter)(g=f.getParent())&&g.centerOn(h)}return h?1:0},draw:function(g,b){if(h)(a.drawIndicator?a.drawIndicator:k)(g,b,new TILE5.Vector(h.x-b.x,h.y-b.y),e)}});return f},FPSLayer:function(a){a=GRUNT.extend({zindex:1E3,scalePosition:false},a);var k=null,d=GRUNT.extend(new m.ViewLayer(a),{delays:[],draw:function(e,
h,l){e.font="bold 8pt Arial";e.textAlign="right";e.fillStyle="rgba(0, 0, 0, 0.8)";e.fillText((k?k:"?")+" fps",l.width-20,20)}});setInterval(function(){for(var e=0,h=d.delays.length,l=h;l--;)e+=d.delays[l];if(h!==0)k=Math.floor(1E3/(e/h))},1E3);return d},ResourceStatsLayer:function(a){a=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:t.ACTIVE|t.PAN},a);return GRUNT.extend(new m.ViewLayer(a),{fps:null,draw:function(k){var d=TILE5.Resources.getStats(),e=a.indicatorSize,h=10,
l;if(d.imageCacheFullness){k.strokeStyle="rgba(0, 0, 255, 1)";k.beginPath();k.arc(15,15,5,0,Math.PI*2*d.imageCacheFullness,false);k.stroke();h=30}if(d.imageLoadingCount>=0){k.fillStyle="rgba(0, 255, 0, 0.7)";for(l=d.imageLoadingCount;l--;)k.fillRect(h+l*(e+2),10,e,e)}if(d.queuedImageCount>=0){k.fillStyle="rgba(255, 0, 0, 0.7)";for(l=d.queuedImageCount;l--;)k.fillRect(h+l*(e+2),10+e+2,e,e)}}})},LoadingLayer:function(a){GRUNT.extend({},a)},View:function(a){function k(y,A){M=TILE5.V.getRect(y);Y=TILE5.V.getRect(A);
var F=TILE5.D.getSize(M.dimensions),L=TILE5.D.getSize(Y.dimensions);Z=TILE5.R.getCenter(M);D=TILE5.R.getCenter(Y);R=M&&F!==0?L/F:1}function d(y){GRUNT.WaterCooler.say("view.scale",{id:I.id});O=false;I.trigger("scale",R,D,y);S=m.DisplayState.ACTIVE;g()}function e(y,A){A.setId(y);A.setParent(I);b.push(A);b.sort(function(F,L){var Q=L.zindex-F.zindex;if(Q===0)Q=L.created-F.created;return Q})}function h(){GRUNT.WaterCooler.say("view.idle",{id:I.id});K=true;H=0}function l(y,A){var F=0,L=I.getDisplayState(),
Q=(new Date).getTime(),U=(L&t.PINCHZOOM)!==0,T=0;if(s||U){y.clearRect(0,0,n.width,n.height);s=false}if(U){TILE5.D.getCenter(x);var $=(V?V:1)/2,W=TILE5.V.diff(Z,D);if(P=M?new TILE5.Vector(D.x+W.x,D.y+W.y):new TILE5.Vector(D.x-W.x*$,D.y-W.y*$))A=TILE5.V.offset(A,P.x,P.y)}y.save();try{if(w!==1)y.scale(w,w);else if(U){y.translate(D.x,D.y);y.scale(R,R)}for(T=b.length;T--;)if(b[T].shouldDraw(L)){var aa=b[T].draw(y,A,x,L,I);F+=aa?aa:0}}finally{y.restore()}GRUNT.Log.trace("draw complete",Q);return F}function f(){var y=
0,A=S===t.PINCHZOOM||S===t.PAN;z=(new Date).getTime();r.x=Math.floor(r.x);r.y=Math.floor(r.y);E&&p&&E.delays.push(z-p);if(A){TILE5.Animation.cancel(function(L){return L.cancelOnInteract});K=false;if(H!==0){clearTimeout(H);H=0}}for(A=b.length;A--;){var F=b[A].cycle(z,r,S);y+=F?F:0}if(p+J<z){y+=l(o,r);p=z}N=0;if(C+y>0)g();else if(!K&&H===0)H=setTimeout(h,500);GRUNT.Log.trace("Completed draw cycle",z)}function g(){C++;if(!(v||N!==0)){C=0;N=setTimeout(f,0)}}a=GRUNT.extend({id:"view_"+q++,container:"",
clearOnDraw:false,displayFPS:false,displayResourceStats:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,autoSize:false},a);var b=[],n=document.getElementById(a.container),o=null,r=new TILE5.Vector,s=false,p=null,u=0,v=false,w=1,x=null,B=null,C=0,E=null,D=null,K=false,N=0,H=0,P=null,z=0,G=TILE5.Device.getConfig().targetFps,J=0,O=false,M=null,Y=null,R=1,V=null,X=null,Z=null,S=m.DisplayState.ACTIVE;GRUNT.Log.info("Creating a new view instance, attached to container: "+
a.container+", canvas = ",n);if(n){TILE5.Touch.resetTouch(n);if(a.autoSize){GRUNT.Log.info("autosizing view: window.height = "+window.innerHeight+", width = "+window.innerWidth);n.height=window.innerHeight-n.offsetTop;n.width=window.innerWidth-n.offsetLeft}try{o=n.getContext("2d");o.globalCompositeOperation=a.initialDrawMode;o.clearRect(0,0,n.width,n.height)}catch(ba){GRUNT.Log.exception(ba);throw Error("Could not initialise canvas on specified view element");}}var I=GRUNT.extend({},a,new GRUNT.Observable,
{id:a.id,deviceScaling:w,fastDraw:a.fastDraw||TILE5.Device.getConfig().requireFastDraw,animate:function(y,A,F,L,Q){function U(){Q&&Q();d();R=1;V=null}O=true;Z=TILE5.V.copy(A);D=TILE5.V.copy(F);M=null;if(L){X=R;TILE5.Animation.tweenValue(0,y-X,L,U,1E3).requestUpdates(function(T){V=T/(y-X);R=X+T;S=m.DisplayState.PINCHZOOM;g();I.trigger("animate")})}else{R=y;U()}},centerOn:function(y){I.setOffset(y.x-n.width/2,y.y-n.height/2)},getDimensions:function(){if(n)return new TILE5.Dimensions(n.width,n.height)},
getZoomCenter:function(){return P},getLayer:function(y){for(var A=0;A<b.length;A++)if(b[A].getId()==y)return b[A];return null},setLayer:function(y,A){for(var F=0;F<b.length;F++)if(b[F].getId()===y){b.splice(F,1);break}A&&e(y,A);GRUNT.WaterCooler.say("layer.update",{id:y});g()},eachLayer:function(y){for(var A=0;A<b.length;A++)y(b[A])},clearBackground:function(){s=true},freeze:function(){v=true},unfreeze:function(){v=false;g()},snapshot:function(){},getDisplayState:function(){return v?t.FROZEN:S},scale:function(y,
A,F,L,Q){L||(L=TILE5.D.getCenter(x));Q||(Q=TILE5.D.getCenter(x));I.animate(y,L,Q,A,F);return I},removeLayer:function(y){a:{for(var A=b.length;A--;)if(b[A].getId()==y){y=A;break a}y=-1}if(y>=0&&y<b.length){GRUNT.WaterCooler.say("layer.removed",{layer:b[y]});b.splice(y,1)}},getOffset:function(){return TILE5.V.copy(r)},setOffset:function(y,A){r.x=y;r.y=A},updateOffset:function(y,A,F){if(F){y=new TILE5.Vector(y,A);animating=true;F=TILE5.Animation.tweenVector(r,y.x,y.y,F,function(){animating=false;I.panEnd(0,
0)});for(y=F.length;y--;){F[y].cancelOnInteract=true;F[y].requestUpdates(function(){a.onAnimate&&a.onAnimate(r.x,r.y)})}}else I.setOffset(y,A)}});x=I.getDimensions();B=TILE5.D.getCenter(x);if(G)J=Math.ceil(1E3/G);GRUNT.Log.info("redraw interval calaculated @ "+J);GRUNT.WaterCooler.listen("layer.remove",function(y){y.id&&I.removeLayer(y.id)});GRUNT.WaterCooler.listen("view.wake",function(y){if(!y.id||y.id===I.id)g()});w=TILE5.Device.getConfig().getScaling();if(a.displayFPS){E=new m.FPSLayer;I.setLayer("fps",
E)}a.displayResourceStats&&I.setLayer("resourceStats",new m.ResourceStatsLayer);TILE5.Touch.captureTouch(n,{observable:I});I.bind("move",function(y,A,F){I.updateOffset(r.x+y,r.y+A,F);u=TILE5.Clock.getTime(true);g();S=t.PAN});I.bind("moveEnd",function(){S=t.ACTIVE;setTimeout(g,50)});I.bind("pinchZoom",function(y,A){k(y,A);if(O=R!==1){u=TILE5.Clock.getTime(true);S=m.DisplayState.PINCHZOOM;g()}});I.bind("pinchZoomEnd",function(y,A){k(y,A);d(true);R=1});g();return I}};return m}();
TILE5.Tiling=function(){function t(){if(!m){m=TILE5.newCanvas(k.Config.TILESIZE,k.Config.TILESIZE);var d=m.getContext("2d");d.fillStyle="rgba(150, 150, 150, 0.025)";d.fillRect(0,0,m.width,m.height)}return m}function q(){function d(){var h=TILE5.newCanvas(32,32),l=h.getContext("2d");l.fillStyle="#BBBBBB";l.fillRect(0,0,32,32);l.fillStyle="#C3C3C3";l.fillRect(0,0,16,16);l.fillRect(16,16,16,16);return h}if(!a){a=TILE5.newCanvas(k.Config.TILESIZE,k.Config.TILESIZE);var e=a.getContext("2d");e.fillStyle=
e.createPattern(d(),"repeat");e.fillRect(0,0,a.width,a.height)}return a}TileStore=function(d){d=GRUNT.extend({tileSize:null,gridSize:25,center:new TILE5.Vector,onPopulate:null},d);if(!d.tileSize)throw Error("Cannot create TileStore with an empty tile size");var e=Array(Math.pow(d.gridSize,2)),h=TILE5.V.offset(d.center,-Math.ceil(d.gridSize>>1)),l=null,f=new TILE5.Vector,g=null,b={getGridSize:function(){return d.gridSize},getNormalizedPos:function(n,o){return TILE5.V.add(new TILE5.Vector(n,o),TILE5.V.invert(h),
f)},getTileShift:function(){return TILE5.V.copy(f)},getTile:function(n,o){return n>=0&&n<d.gridSize?e[o*d.gridSize+n]:null},setTile:function(n,o,r){e[o*d.gridSize+n]=r},populate:function(n,o){var r=GRUNT.Log.getTraceTicks(),s=0,p=d.gridSize,u=d.tileSize;new TILE5.Vector(p/2,p/2);if(n){GRUNT.Log.info("populating grid, x shift = "+f.x+", y shift = "+f.y);for(var v=0;v<p;v++)for(var w=0;w<p;w++){if(!e[s]){var x=n(w,v,h,p);x.gridX=w*u-f.x;x.gridY=v*u-f.y;e[s]=x}s++}}l=n;g=o;GRUNT.Log.trace("tile grid populated",
r);d.onPopulate&&d.onPopulate()},getShiftDelta:function(n,o,r,s){var p=Math.floor(d.gridSize*0.2),u=new TILE5.Vector;if(n<0||n+r>d.gridSize)u.x=n<0?-p:p;if(o<0||o+s>d.gridSize)u.y=o<0?-p:p;return u},shift:function(n,o){if(!(n.x===0&&n.y===0)){var r=GRUNT.Log.getTraceTicks();GRUNT.Log.info("need to shift tile store grid, "+n.x+" cols and "+n.y+" rows.");var s=Array(e.length);s.length=e.length;for(var p=0;p<d.gridSize;p++)for(var u=0;u<d.gridSize;u++)s[u*d.gridSize+p]=b.getTile(p+n.x,u+n.y);e=s;h=o?
o(h,n):TILE5.V.add(h,n);f.x+=-n.x*d.tileSize;f.y+=-n.y*d.tileSize;GRUNT.Log.trace("tile storage shifted",r);b.populate(l,g)}},setOrigin:function(n,o){if(tileOrigin)shiftOrigin(n,o);else h=TILE5.V.offset(new TILE5.Vector(n,o),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var n=e.length;n--;)if(e[n])e[n].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var n=e.length;n--;)if(e[n]){e[n].x=null;e[n].y=null}});return b};var m=null,a=null,k={Config:{TILESIZE:256,
TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(d){return d=GRUNT.extend({x:0,y:0,gridX:0,gridY:0,size:256},d)},ImageTile:function(d){d=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},d);return new k.Tile(d)},TileGrid:function(d){function e(C,E){if(x){var D,K=[],N=new TILE5.Vector(Math.floor((C.x+p.x)*f),Math.floor((C.y+p.y)*f));tilesNeeded=false;for(var H=w;H--;)for(var P=v;P--;){D=h.getTile(P+N.x,H+N.y);var z=new TILE5.Vector(P-x.x,H-x.y);D||(s=h.getShiftDelta(N.x,N.y,v,w));K.push({tile:D,
centerness:TILE5.V.absSize(z)})}K.sort(function(G,J){return J.centerness-G.centerness});n||(n=Array(K.length));for(D=K.length;D--;){n[D]=K[D].tile;B.prepTile(n[D],E)}}}d=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},d);var h=new TileStore(GRUNT.extend({tileSize:d.tileSize,onPopulate:function(){g=true;B.wakeParent()}},d)),l=Math.round(d.tileSize/2),f=d.tileSize?1/d.tileSize:0,g=false,b=true,n=null,o=false,r=false;new TILE5.Vector;
var s=new TILE5.Vector,p=new TILE5.Vector;TILE5.Device.getConfig();var u=h.getGridSize()*d.tileSize,v,w,x,B=GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{gridDimensions:new TILE5.Dimensions(u,u),cycle:function(C,E,D){C=0;if(s.x+s.y!==0){h.shift(s,d.shiftOrigin);p=h.getTileShift();s=new TILE5.Vector;C++}D!==TILE5.Graphics.DisplayState.PINCHZOOM&&e(E,D);return C+g?1:0},deactivate:function(){b=false},prepTile:function(){},drawTile:function(){return false},draw:function(C,E,D,K,N){if(b){var H=(new Date).getTime(),
P=E.x;E=E.y;var z=true,G=o||K===TILE5.Graphics.DisplayState.PINCHZOOM||TILE5.Animation.isTweening();if(!x){v=Math.ceil(D.width*f)+1;w=Math.ceil(D.height*f)+1;x=new TILE5.Vector(Math.floor((v-1)/2),Math.floor((w-1)/2))}if(n){if(d.drawGrid)C.strokeStyle="rgba(50, 50, 50, 0.3)";C.beginPath();for(D=n.length;D--;){var J=n[D];if(J){var O=J.gridX-P,M=J.gridY-E;z=((G?false:J.x===O&&J.y===M)?true:B.drawTile(C,J,O,M,K))&&z}else z=false;d.drawGrid&&C.rect(O,M,d.tileSize,d.tileSize)}C.stroke();GRUNT.Log.trace("drawn tiles",
H);z&&!r&&N.trigger("tileDrawComplete");r=z;o=g=false}}},getTileVirtualXY:function(C,E,D){C=h.getNormalizedPos(C,E);C=new TILE5.Vector(C.x*d.tileSize,C.y*d.tileSize);if(D){C.x+=l;C.y+=l}return C},populate:function(C){h.populate(C,function(){})}});GRUNT.WaterCooler.listen("tile.loaded",function(){g=true;B.wakeParent()});GRUNT.WaterCooler.listen("grid.invalidate",function(){o=true});return B},ImageTileGrid:function(d){function e(){GRUNT.WaterCooler.say("tile.loaded")}d=GRUNT.extend({},d);var h=t(),
l=q(),f=TILE5.Graphics.DisplayState.ACTIVE,g=TILE5.Graphics.DisplayState.PAN,b=TILE5.Device.getConfig().requireFastDraw;return GRUNT.extend(new k.TileGrid(d),{drawTile:function(n,o,r,s,p){var u=TILE5.Resources.getImage(o.url),v=false;if(u&&u.complete&&u.width>0){n.drawImage(u,r,s);v=true;o.x=r;o.y=s}else p===g?n.drawImage(l,r,s):n.drawImage(h,r,s);return v},prepTile:function(n,o){if(n&&(!b||o===f))TILE5.Resources.getImage(n.url)||TILE5.Resources.loadImage(n.url,e)}})},Tiler:function(d){d=GRUNT.extend({container:"",
drawCenter:false,datasources:{},tileLoadThreshold:"first"},d);var e=new TILE5.Graphics.View(GRUNT.extend({},d,{pannable:true,scalable:true,scaleDamping:true}));GRUNT.extend(e,{getTileLayer:function(){return e.getLayer("grid0")},setTileLayer:function(h){e.setLayer("grid0",h);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(h){var l=e.getOffset();return new TILE5.Vector(h.x+l.x,h.y+l.y)},cleanup:function(){e.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");
GRUNT.WaterCooler.say("view.wake",{id:e.id})}});return e}};return k}();
TILE5.Geo=function(){function t(f,g){var b=null;for(var n in h)if(g){if(n==g&&h[n][f]){b=h[n];break}}else if(h[n][f]){b=h[n];break}return b}function q(f,g,b,n){var o=0;f=f.toUpperCase();for(var r in n){var s=g[r];if(s){var p=b[r];s=p?p(f,s):f.containsWord(s)?1:0;o+=s*n[r]}}return o}var m=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],a=Math.PI/180,k=180/Math.PI,d=null,e={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},h={},l={Engine:function(f){if(!f.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var g=GRUNT.extend({remove:function(){delete h[g.id]}},f);return h[g.id]=g},Radius:function(f,g){return{distance:parseInt(f,10),uom:g}},Position:function(f,g){return{lat:parseFloat(f?f:0),lon:parseFloat(g?g:0)}},BoundingBox:function(f,g){return{min:l.P.parse(f),max:l.P.parse(g)}},Address:function(f){return f=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},f)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var f={dist2rad:function(g){return g/6371},lat2pix:function(g,b){var n=parseFloat(g)*2*Math.PI/360;n=Math.sin(n);var o=0.08181919084262157*n;return Math.log((1+n)/(1-n)*Math.pow((1-o)/(1+o),0.08181919084262157))/2/b},lon2pix:function(g,b){return parseFloat(g)/180*Math.PI/b},pix2lon:function(g,b){return f.normalizeLon(g*b*180/Math.PI)},pix2lat:function(g,b){for(var n=Math.pow(Math.E,
-g*b),o=f.mercatorUnproject(n),r=f.findRadPhi(o,n),s=0;s<12&&Math.abs(o-r)>1.0E-7;){o=r;r=f.findRadPhi(o,n);s++}return r*180/Math.PI},mercatorUnproject:function(g){return Math.PI/2-2*Math.atan(g)},findRadPhi:function(g,b){var n=0.08181919084262157*Math.sin(g);return Math.PI/2-2*Math.atan(b*Math.pow((1-n)/(1+n),0.040909595421310785))},normalizeLon:function(g){for(;g<-180;)g+=360;for(;g>180;)g-=360;return g}};return f}(),GeoSearchResult:function(f){f=GRUNT.extend({id:null,caption:"",resultType:"",data:null,
pos:null,matchWeight:0},f);return GRUNT.extend(f,{toString:function(){return f.caption+(f.matchWeight?" ("+f.matchWeight+")":"")}})},GeoSearchAgent:function(f){return TILE5.Dispatcher.createAgent(f)},GeocodingAgent:function(f){f=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(g,b){try{if(!g.reverse&&!g.freeform)address=new l.Address(g);var n=l.getEngine("geocode");if(n)n.geocode({addresses:[g.freeform?g.freeform:address],complete:function(r,s){if(b){var p=s;if(g.freeform)p=
l.rankGeocodeResponses(g.freeform,p,l.getEngine("geocode"));b(p,f)}}})}catch(o){GRUNT.Log.exception(o)}}},f);return new l.GeoSearchAgent(f)},PointOfInterest:function(f){f=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},f);if(!f.pos&&f.lat&&f.lon)f.pos=new TILE5.Geo.Position(f.lat,f.lon);return GRUNT.extend({toString:function(){return f.id+": '"+f.title+"'"}},f)},POIStorage:function(f){function g(p){p=p?p:"default";o[p]||(o[p]=[]);return o[p]}function b(p){var u=
[];for(var v in o)for(var w=0;w<o[v].length;w++)if(!p||p(o[v][w]))u.push(o[v][w]);return u}function n(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:s.id,pois:s.getPOIs()})}f=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},f);var o={},r=true,s={id:GRUNT.generateObjectID(),getPOIs:function(){return b()},getOldPOIs:function(p,u){return b(function(v){return v.group==p&&v.retrieved<u})},getVisible:function(){return r},setVisible:function(p){if(p!=r){r=p;f.visibilityChange&&f.visibilityChange()}},
findById:function(p){var u=b(function(v){return v.id==p});return u.length>0?u[0]:null},findByBounds:function(p){return b(function(u){return TILE5.Geo.P.inBounds(u.pos,p)})},addPOIs:function(p,u){if(u)o={};for(var v=0;p&&v<p.length;v++){p[v].retrieved=TILE5.Clock.getTime(true);var w=p[v];g(w.group).push(w)}},removeGroup:function(p){if(o[p]){delete o[p];n()}},update:function(p){var u=[],v=0,w=p.length>0?p[0].group:"",x=TILE5.Clock.getTime(true);for(v=0;v<p.length;v++){var B;a:{if(B=p[v])for(var C=g(B.group),
E=0;E<C.length;E++)if(C[E].id==B.id){B=C[E];break a}B=null}if(B){B.retrieved=x;B.isNew=false}else u.push(p[v])}p=s.getOldPOIs(w,x);s.addPOIs(u);for(v=0;f.onPOIAdded&&v<u.length;v++)f.onPOIAdded(u[v]);for(v=0;v<p.length;v++){f.onPOIDeleted&&f.onPOIDeleted(p[v]);w=p[v];x=g(w.group);for(B=0;B<x.length;B++)if(x[B].id==w.id){x.splice(B,1);break}}u.length+p.length>0&&n()}};return s},MapProvider:function(){return{zoomLevel:0,checkZoomLevel:function(f){return f},getCopyright:function(){},getMapTiles:function(){},
getPositionForXY:function(){return null}}},P:function(){var f={calcDistance:function(g,b){if(f.empty(g)||f.empty(b))return 0;var n=(b.lat-g.lat).toRad()/2,o=(b.lon-g.lon).toRad()/2;n=Math.sin(n)*Math.sin(n)+Math.cos(g.lat.toRad())*Math.cos(b.lat.toRad())*Math.sin(o)*Math.sin(o);return 6371*2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n))},copy:function(g){return g?new l.Position(g.lat,g.lon):null},empty:function(g){return!g||g.lat===0&&g.lon===0},equal:function(g,b){return g&&b&&g.lat==b.lat&&g.lon==b.lon},
almostEqual:function(g,b){return g&&b&&Math.floor(g.lat*1E3)===Math.floor(b.lat*1E3)&&Math.floor(g.lon*1E3)===Math.floor(b.lon*1E3)},inArray:function(g,b){for(var n=l.P.equal,o=b.length;o--;)if(n(g,b[o]))return true;return false},inBounds:function(g,b){var n=!(l.P.empty(g)||l.P.empty(b));return n=(n=n&&g.lat>=b.min.lat&&g.lat<=b.max.lat)&&g.lon>=b.min.lon&&g.lon<=b.max.lon},parse:function(g){if(g)if(typeof g.lat!=="undefined")return f.copy(g);else{if(g.split)for(var b=[" ",","],n=0;n<b.length;n++){var o=
g.split(b[n]);if(o.length===2)return new l.Position(o[0],o[1])}}else return new l.Position;return null},parseArray:function(g){var b=g.length,n=Array(b);for(b=b;b--;)n[b]=f.parse(g[b]);GRUNT.Log.info("parsed "+n.length+" positions");return n},fromMercatorPixels:function(g,b,n){return new l.Position(TILE5.Geo.Utilities.pix2lat(b,n),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(g,n)))},toMercatorPixels:function(g,b){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(g.lon,b),TILE5.Geo.Utilities.lat2pix(g.lat,
b))},generalize:function(g,b,n){var o=g.length,r=[],s=null;n||(n=250);n/=1E3;GRUNT.Log.info("generalizing positions, must include "+b.length+" positions");for(var p=o;p--;)if(p===0)r.unshift(g[p]);else{var u=!s||l.P.inArray(g[p],b)?n:l.P.calcDistance(s,g[p]);if(g[p]&&u>=n){r.unshift(g[p]);s=g[p]}}GRUNT.Log.info("generalized "+o+" positions into "+r.length+" positions");return r},toString:function(g){return g?g.lat+" "+g.lon:""}};return f}(),B:function(){var f=-(Math.PI/2),g=Math.PI/2,b=-Math.PI*2,
n=Math.PI*2,o={calcSize:function(r,s,p){var u=new TILE5.Vector(0,s.lat-r.lat);if(typeof p==="undefined")p=true;u.x=p&&r.lon>s.lon?360-r.lon+s.lon:s.lon-r.lon;return u},createBoundsFromCenter:function(r,s){var p=s/6371,u=r.lat*a,v=r.lon*a,w=u-p,x=u+p;if(w>f&&x<g){u=Math.asin(Math.sin(p)/Math.cos(u));p=v-u;if(p<b)p+=2*Math.PI;v=v+u;if(v>n)v-=2*Math.PI}else{w=Math.max(w,f);x=Math.min(x,g);p=b;v=n}return new l.BoundingBox(new l.Position(w*k,p*k),new l.Position(x*k,v*k))},expand:function(r,s){return new l.BoundingBox(new l.Position(r.min.lat-
s,r.min.lon-l.Utilities.normalizeLon(s)),new l.Position(r.max.lat+s,r.max.lon+l.Utilities.normalizeLon(s)))},forPositions:function(r,s){var p=null,u=TILE5.Clock.getTime();s||(s="auto");for(var v=r.length;v--;)if(p){var w=o.calcSize(p.min,r[v],false),x=o.calcSize(r[v],p.max,false);if(w.x<0)p.min.lon=r[v].lon;if(w.y<0)p.min.lat=r[v].lat;if(x.x<0)p.max.lon=r[v].lon;if(x.y<0)p.max.lat=r[v].lat}else p=new TILE5.Geo.BoundingBox(r[v],r[v]);if(s){if(s=="auto"){v=o.calcSize(p.min,p.max);s=Math.max(v.x,v.y)*
0.3}p=o.expand(p,s)}GRUNT.Log.trace("calculated bounds for "+r.length+" positions",u);return p},getCenter:function(r){var s=l.B.calcSize(r.min,r.max);return new TILE5.Geo.Position(r.min.lat+s.y/2,r.min.lon+s.x/2)},getGeoHash:function(r){var s=TILE5.Geo.GeoHash.encode(r.min.lat,r.min.lon);r=TILE5.Geo.GeoHash.encode(r.max.lat,r.max.lon);GRUNT.Log.info("min hash = "+s+", max hash = "+r)},getZoomLevel:function(r,s){var p=o.getCenter(r),u=m[Math.min(Math.round(Math.abs(p.lat)*0.05),m.length)],v=o.calcSize(r.min,
r.max);p=Math.ceil(Math.log(m[3]*s.height/v.y)/Math.log(2));u=Math.ceil(Math.log(u*s.width/v.x)/Math.log(2));return Math.min(isNaN(p)?1E3:p,isNaN(u)?1E3:u)},isEmpty:function(r){return!r||l.P.empty(r.min)||l.P.empty(r.max)},toString:function(r){return"min: "+l.P.toString(r.min)+", max: "+l.P.toString(r.max)}};return o}(),A:function(){var f=/^(\d+).*$/,g=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(b,n){f.lastIndex=-1;if(f.test(b))for(var o=b.replace(f,"$1"),r=n.split(","),s=0;s<r.length;s++){g.lastIndex=
-1;if(g.test(r[s])){var p=g.exec(r[s]);if(o>=parseInt(p[1],10)&&o<=parseInt(p[2],10))return true}else if(o==r[s])return true}return false},normalize:function(b){if(!b)return"";b=b.toUpperCase();if(!d){var n=[];for(var o in e)n.push(o);d=RegExp("(\\s)("+n.join("|")+")(\\s|$)","i")}d.lastIndex=-1;if(n=d.exec(b))b=b.replace(d,"$1"+e[n[2]]);return b},toString:function(b){return b.streetDetails+" "+b.location}}}(),getEngine:function(f){for(var g=null,b=1;!g&&b<arguments.length;b++)g=t(f,arguments[b]);
g=g?g:t(f);if(!g)throw Error("Unable to find GEO engine with "+f+" capability");return g},rankGeocodeResponses:function(f,g,b){var n=[],o=l.AddressCompareFns;if(b&&b.compareFns)o=GRUNT.extend({},o,b.compareFns);for(b=0;b<g.length;b++)n.push(new l.GeoSearchResult({caption:l.A.toString(g[b]),data:g[b],pos:g[b].pos,matchWeight:q(f,g[b],o,l.GeocodeFieldWeights)}));n.sort(function(r,s){return s.matchWeight-r.matchWeight});return n}};return l}();
TILE5.Geo.Location=function(){function t(a){function k(b){try{var n=new TILE5.Geo.Position(b.coords.latitude,b.coords.longitude),o=GRUNT.isPlainObject(b.coords.accuracy)&&b.coords.accuracy.horizontal?b.coords.accuracy.horizontal:b.coords.accuracy;GRUNT.Log.info("position success, accuracy = "+o);if(a.successCallback&&(!l||o<f))a.successCallback(n,o,h,b);if(o>a.highAccuracyCutoff&&h<2){h=2;a.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");
a.watch||e()}l=b;f=o}catch(r){GRUNT.Log.exception(r)}}function d(b){if(b.code===b.PERMISSION_DENIED)a.errorCallback&&a.errorCallback(b);else if(b.code===b.POSITION_UNAVAILABLE)a.errorCallback&&a.errorCallback(b);else if(b.code===b.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(a.timeout===0&&a.autoPhasing){h=1;a.timeout=q;a.enableHighAccuracy=false;e()}}}function e(){navigator.geolocation.getCurrentPosition(k,d,GRUNT.extend({},a,{enableHighAccuracy:false}))}a=GRUNT.extend({autoPhasing:true,
maximumAge:3E5,timeout:0,highAccuracyCutoff:10,watch:false,enableHighAccuracy:true,successCallback:null,errorCallback:null},a);var h=0,l=null,f=1E6,g;if(a.watch){navigator.geolocation.watchPosition(k,d,a);g=void 0}else g=e();return g}var q=3E3,m={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)m.get=t;return m}();
TILE5.Geo.GeoHash=function(){function t(q,m,a){if(m&a)q[0]=(q[0]+q[1])/2;else q[1]=(q[0]+q[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(q){var m=1,a=[],k=[];a[0]=-90;a[1]=90;k[0]=-180;k[1]=180;lat_err=90;lon_err=180;for(i=0;i<q.length;i++){c=q[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(m){lon_err/=2;t(k,cd,mask)}else{lat_err/=2;t(a,cd,mask)}m=!m}}a[2]=(a[0]+
a[1])/2;k[2]=(k[0]+k[1])/2;return{latitude:a,longitude:k}},encode:function(q,m,a){var k=1,d=[],e=[],h=0,l=0;a=a?a:12;geohash="";d[0]=-90;d[1]=90;e[0]=-180;for(e[1]=180;geohash.length<a;){if(k){mid=(e[0]+e[1])/2;if(m>mid){l|=BITS[h];e[0]=mid}else e[1]=mid}else{mid=(d[0]+d[1])/2;if(q>mid){l|=BITS[h];d[0]=mid}else d[1]=mid}k=!k;if(h<4)h++;else{geohash+=BASE32[l];l=h=0}}return geohash}}}();
TILE5.Geo.Search=function(){return{bestResults:function(t,q){q||(q=20);for(var m=t.length>0?t[0]:null,a=[],k=0;k<t.length;k++)if(m.matchWeight-t[k].matchWeight<=q)a.push(t[k]);else break;return a}}}();
TILE5.Geo.Routing=function(){var t={calculate:function(q){q=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},q);GRUNT.Log.info("attempting to calculate route");var m=TILE5.Geo.getEngine("route");m&&m.route(q,function(a){if(q.generalize)a.geometry=TILE5.Geo.P.generalize(a.geometry,a.getInstructionPositions());if(q.map){t.createMapOverlay(q.map,a);if(q.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+a.boundingBox);q.map.gotoBounds(a.boundingBox)}}q.success&&
q.success(a)})},createMapOverlay:function(q,m){var a=q.getDimensions();a=new TILE5.Geo.UI.RouteOverlay({data:m,width:a.width,height:a.height});q.setLayer("route",a)},parseTurnType:function(q){for(var m=t.TurnType.Unknown,a=TILE5.Geo.Routing.TurnTypeRules,k=0;k<a.length;k++){a[k].regex.lastIndex=-1;var d=a[k].regex.exec(q);if(d){m=a[k].customCheck?a[k].customCheck(q,d):a[k].turnType;break}}return m},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",
TurnLeft:"turn-left",TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(q){q=GRUNT.extend({position:null,description:"",turnType:null},q);if(!q.turnType)q.turnType=t.parseTurnType(q.description);return q},RouteData:function(q){q=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},q);if(!q.boundingBox)q.boundingBox=TILE5.Geo.B.forPositions(q.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var m=[],a=0;a<q.instructions.length;a++)q.instructions[a].position&&m.push(q.instructions[a].position);return m}},q)}};return t}();
TILE5.Geo.Routing.TurnTypeRules=function(){var t=TILE5.Geo.Routing.TurnType,q=[];q.push({regex:/continue/i,turnType:t.Continue});q.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(m,a){return/bear/i.test(a[1])?t.TurnLeftSlight:t.TurnLeft}});q.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(m,a){return/bear/i.test(a[1])?t.TurnRightSlight:t.TurnRight}});q.push({regex:/enter\s(roundabout|rotaty)/i,turnType:t.EnterRoundabout});q.push({regex:/take.*?ramp/i,turnType:t.Ramp});
q.push({regex:/take.*?exit/i,turnType:t.RampExit});q.push({regex:/make(.*?)u\-turn/i,customCheck:function(m,a){return/right/i.test(a[1])?t.UTurnRight:t.UTurnLeft}});q.push({regex:/proceed/i,turnType:t.Start});q.push({regex:/arrive/i,turnType:t.Arrive});q.push({regex:/fell\sthrough/i,turnType:t.Merge});return q}();
TILE5.Geo.UI=function(){function t(a){a=GRUNT.extend({size:12,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},a);var k=null,d=function(){var e=TILE5.newCanvas(a.size*4,a.size*4),h=e.getContext("2d"),l=new TILE5.Vector(e.width/2,e.height/2),f=a.size,g=["#FFFFFF","#333333"],b=[3,1.5];h.lineCap="round";for(var n=0;n<g.length;n++){var o=f;h.lineWidth=b[n];h.strokeStyle=g[n];h.beginPath();h.moveTo(l.x,
l.y-o);h.lineTo(l.x,l.y+o);h.moveTo(l.x-o,l.y);h.lineTo(l.x+o,l.y);h.arc(l.x,l.y,f*0.6666,0,2*Math.PI,false);h.stroke()}return e}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(e,h,l){if(!k){k=TILE5.D.getCenter(l);k=new TILE5.Vector(Math.round(k.x-d.width/2),Math.round(k.y-d.height/2))}e.drawImage(d,k.x,k.y)}})}var q=0,m={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,radsPerPixel:0},a);var k=
TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),d=k.x-a.centerXY.x,e=k.y-a.centerXY.y,h=GRUNT.extend({},a.grid,{getBoundingBox:function(l,f,g,b){return new TILE5.Geo.BoundingBox(h.pixelsToPos(new TILE5.Vector(l,f+b)),h.pixelsToPos(new TILE5.Vector(l+g,f)))},getGridXYForPosition:function(l){l=TILE5.Geo.P.toMercatorPixels(l,a.radsPerPixel);return new TILE5.Vector(l.x-d,h.gridDimensions.height-(l.y-e))},getPixelDistance:function(l){l=TILE5.Geo.Utilities.dist2rad(l);return Math.floor(l/a.radsPerPixel)},
pixelsToPos:function(l){return TILE5.Geo.P.fromMercatorPixels(d+l.x,e+h.gridDimensions.height-l.y,a.radsPerPixel)}});return h},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var k=true,d=null,e=[],h=0,l=[],f=[],g=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(b,n,o,r){if(k)return null;var s="routeAnimation"+q++;f.push(s);
return new TILE5.Graphics.AnimatedPathLayer({id:s,path:e,zindex:a.zindex+1,easing:b?b:TILE5.Animation.Easing.Sine.InOut,duration:n?n:5E3,drawIndicator:o,autoCenter:r?r:false})},draw:function(b,n,o,r,s){o=0;r=a.data?a.data.geometry:null;if(k){k=false;d=null;e=[];h=0}if(r&&h<r.length){a:{s=s.getTileLayer();l=[];if(s){r=GRUNT.Log.getTraceTicks();var p,u,v,w=a.data?a.data.geometry:[],x=w.length,B=a.data?a.data.instructions:[],C=B.length,E=a.calculationsPerCycle,D=0;for(p=h;p<x;p++){u=s.getGridXYForPosition(w[p]);
if(v=!d||p===0||Math.abs(u.x-d.x)+Math.abs(u.y-d.y)>a.pixelGeneralization){e.push(u);d=u}D++;if(D>=E){h=p;break a}}h=x;GRUNT.Log.trace(x+" geometry points generalized to "+e.length+" coordinates",r);d=null;for(p=C;p--;)if(B[p].position){u=s.getGridXYForPosition(B[p].position);if(v=!d||p===0||Math.abs(u.x-d.x)+Math.abs(u.y-d.y)>a.pixelGeneralization){l.push(u);d=u}}}}o++}s=e.length;if(s>0&&(!o||a.partialDraw)){b.strokeStyle=a.strokeStyle;b.lineWidth=a.lineWidth;b.beginPath();b.moveTo(e[s-1].x-n.x,
e[s-1].y-n.y);for(s=s;s--;)b.lineTo(e[s].x-n.x,e[s].y-n.y);b.stroke();b.fillStyle=a.waypointFillStyle;for(s=l.length;s--;){b.beginPath();b.arc(l[s].x-n.x,l[s].y-n.y,2,0,Math.PI*2,false);b.stroke();b.fill()}}return o}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var b=f.length;b--;)GRUNT.WaterCooler.say("layer.remove",{id:f[b]});f=[];k=true;g.wakeParent()});return g},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:m.AnnotationTween,animationSpeed:null},a);var k=
false,d={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return k},draw:function(e,h,l,f){if(d.xy){if(d.isNew&&a.tweenIn){var g=d.xy.y;d.xy.y=h.y-20;k=true;TILE5.Animation.tween(d.xy,"y",g,a.tweenIn,function(){d.xy.y=g;k=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(e,h,new TILE5.Vector(d.xy.x-h.x,d.xy.y-h.y),l,f);else{e.beginPath();e.arc(d.xy.x-h.x,d.xy.y-h.y,4,0,Math.PI*2,false);e.fill()}d.isNew=false}}};return d},ImageAnnotation:function(a){a=GRUNT.extend({imageUrl:null,
animatingImageUrl:null,imageAnchor:null},a);var k=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;a.draw=function(e,h,l,f,g){if(a.animatingImageUrl&&d.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);f=a.animatingImageUrl}else f=a.imageUrl;if(h=TILE5.Resources.getImage(f)){if(h.complete&&h.width>0){k||(k=new TILE5.Vector(-h.width>>1,-h.height>>1));l=TILE5.V.offset(l,k.x,k.y);e.drawImage(h,l.x,l.y,h.width,h.height)}}else TILE5.Resources.loadImage(f,function(){g.wakeParent()})};var d=new m.Annotation(a);
return d},AnnotationsOverlay:function(a){function k(f){for(var g=a.map?a.map.getTileLayer():null,b=0;g&&b<f.length;b++)f[b].xy=g.getGridXYForPosition(f[b].pos)}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var d=[],e=false,h=[],l=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){return e?1:0},draw:function(f,g,b,n){e=false;f.fillStyle="rgba(255, 0, 0, 0.75)";f.globalCompositeOperation="source-over";for(b=d.length;b--;){d[b].draw(f,g,n,l);e=e||d[b].isAnimating()}for(b=
h.length;b--;){h[b].draw(f,g,n,l);e=e||h[b].isAnimating()}return e?1:0},add:function(f){h.push(f);k(h);l.wakeParent()},clear:function(f){h=[];k(h);if(f){d=[];k(d)}l.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(f){if(a.pois&&a.pois.id==f.srcID){f=f.pois;try{d=[];for(var g=0;g<f.length;g++)if(f[g].pos){var b;var n=f[g];if(n&&n.pos){var o=null;if(o=a.createAnnotationForPOI?a.createAnnotationForPOI(n):new m.Annotation({pos:n.pos})){o.isNew=n.isNew;n.isNew=false}b=o}else b=void 0;
b&&d.push(b)}k(d)}catch(r){GRUNT.Log.exception(r)}l.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){k(d);k(h);l.wakeParent()});return l},GeoLocationOverlay:function(a){function k(){var b=a.map?a.map.getTileLayer():null;e=null;if(l&&b)e=b.getGridXYForPosition(l);h=0;if(f&&b)h=b.getPixelDistance(f/1E3)}a=GRUNT.extend({fillStyle:"rgba(0, 221, 238, 0.1)",strokeStyle:"rgba(0, 102, 136, 0.3)",originFillStyle:"rgba(0, 102, 136, 0.7)",zindex:100,map:null,watch:true,onUpdate:null},a);var d=
0,e=null,h=0,l=null,f=0,g=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){},draw:function(b,n){if(e&&h){var o=e.x-n.x,r=e.y-n.y;b.fillStyle=a.fillStyle;b.lineWidth=1;b.strokeStyle=a.strokeStyle;b.beginPath();b.arc(o,r,h,0,Math.PI*2,false);b.fill();b.stroke();b.fillStyle=a.originFillStyle;b.beginPath();b.arc(o,r,3,0,Math.PI*2,false);b.fill();GRUNT.WaterCooler.say("grid.invalidate")}},getPosition:function(){return l},getAccuracy:function(){return f}});GRUNT.WaterCooler.listen("grid.updated",
function(){k();g.wakeParent()});(function(){d=TILE5.Geo.Location.get({watch:a.watch,successCallback:function(b,n){a.onUpdate&&a.onUpdate(b,n);l=TILE5.Geo.P.copy(b);f=n;k()},errorCallback:function(){GRUNT.Log.info("got position error")}})})();return g},Tiler:function(a){a=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,zoomLevel:0,boundsChange:null,tapPOI:null,tapHandler:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,onTilesLoaded:null},a);var k=new TILE5.Vector,
d=false,e=[],h=0,l=null,f=null,g=a.zoomLevel;if(!a.provider)a.provider=new TILE5.Geo.MapProvider;var b=GRUNT.extend({},new TILE5.Tiling.Tiler(a),{pois:a.pois,annotations:null,getBoundingBox:function(){var o=b.getTileLayer(),r=b.getOffset(),s=b.getDimensions();if(o)return o.getBoundingBox(r.x,r.y,s.width,s.height);return null},getCenterPosition:function(){return b.getXYPosition(TILE5.D.getCenter(b.gridDimensions))},getXYPosition:function(o){return b.getTileLayer().pixelsToPos(b.viewPixToGridPix(o))},
gotoBounds:function(o,r){var s=TILE5.Geo.B.getZoomLevel(o,b.getDimensions());b.gotoPosition(TILE5.Geo.B.getCenter(o),s,r)},gotoCurrentPosition:function(o){function r(p,u){var v=TILE5.Geo.B.createBoundsFromCenter(p,u/1E3);GRUNT.Log.info("detected position: "+TILE5.Geo.P.toString(p)+", accuracy = "+u);b.clearBackground();b.gotoBounds(v,o)}var s=b.getLayer("geolocation");if(s)r(s.getPosition(),s.getAccuracy());else{s=new m.GeoLocationOverlay({map:b,onUpdate:function(p,u){r(p,u)}});GRUNT.Log.info("created geolocation layer");
b.setLayer("geolocation",s)}},gotoPosition:function(o,r,s){var p=g,u=(new Date).getTime(),v=false,w=b.getBoundingBox();if(w)(v=!TILE5.Geo.P.inBounds(o,w))&&b.clearBackground();g=r?r:g;if(!g)throw"Zoom level required to goto a position.";if(a.provider)g=a.provider.checkZoomLevel(g);if(v||!d||g!==p){TILE5.Resources.resetImageLoadQueue();(r=b.getTileLayer())&&r.deactivate();TILE5.Animation.cancel();d&&b.freeze();h=u;a.provider.zoomLevel=g;a.provider.getMapTiles(b,o,function(x){if(u===h){b.setTileLayer(x);
f=x.getId();b.panToPosition(o,function(){b.unfreeze();s&&s()})}else GRUNT.Log.info("request time mismatch - ignoring update")});d=true}else b.panToPosition(o,s)},panToPosition:function(o,r,s){var p=b.getTileLayer();if(p){o=p.getGridXYForPosition(o);p=b.getDimensions();o.x-=p.width/2;o.y-=p.height/2;if(l)l=null;b.updateOffset(o.x,o.y,s);GRUNT.WaterCooler.say("view.wake",{id:b.id});a.boundsChange&&a.boundsChange(b.getBoundingBox());r&&r(b)}},getZoomLevel:function(){return g},setZoomLevel:function(o){b.gotoPosition(b.getCenterPosition(),
o)},zoomIn:function(){b.scale(2,TILE5.Animation.Easing.Sine.Out)||b.setZoomLevel(g+1)},zoomOut:function(){b.scale(0.5,TILE5.Animation.Easing.Sine.Out)||b.setZoomLevel(g-1)},animateRoute:function(o,r,s,p){var u=b.getLayer("route");if(u)(o=u.getAnimation(o,r,s,p))&&o.addToView(b)}});b.bind("tap",function(o,r){var s=b.getTileLayer(),p=null;if(s){p=b.viewPixToGridPix(new TILE5.Vector(r.x,r.y));var u=s.pixelsToPos(p),v=s.pixelsToPos(TILE5.V.offset(p,-a.tapExtent,a.tapExtent)),w=s.pixelsToPos(TILE5.V.offset(p,
a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(s.pixelsToPos(p)));p=new TILE5.Geo.BoundingBox(v,w);e=b.pois.findByBounds(p);b.trigger("geotap",o,r,u,p);a.tapPOI&&a.tapPOI(e)}});b.bind("doubleTap",function(o,r){b.animate(2,TILE5.D.getCenter(b.getDimensions()),new TILE5.Vector(r.x,r.y),TILE5.Animation.Easing.Sine.Out)});b.bind("scale",function(o,r){var s=0;o=Math.sqrt(o);if(o<1)s=-(0.5/o);else if(o>1)s=o;b.gotoPosition(b.getXYPosition(r),g+Math.floor(s))});var n=new TILE5.Geo.UI.AnnotationsOverlay({pois:b.pois,
map:b,createAnnotationForPOI:a.createAnnotationForPOI});b.annotations=n;b.setLayer("annotations",n);a.crosshair&&b.setLayer("crosshair",new t);GRUNT.WaterCooler.listen("view.idle",function(o){if(o.id&&o.id==b.id)if(TILE5.V.absSize(TILE5.V.diff(k,b.getOffset()))>a.boundsChangeThreshold&&a.boundsChange){k=b.getOffset();a.boundsChange(b.getBoundingBox())}});return b}};return m}();
