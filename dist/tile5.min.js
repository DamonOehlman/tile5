if(!this.JSON)this.JSON={};
(function(){function s(c){return c<10?"0"+c:c}function q(c){i.lastIndex=0;return i.test(c)?'"'+c.replace(i,function(b){var j=g[b];return typeof j==="string"?j:"\\u"+("0000"+b.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+c+'"'}function a(c,b){var j,k,n,l,o=d,m,p=b[c];if(p&&typeof p==="object"&&typeof p.toJSON==="function")p=p.toJSON(c);if(typeof h==="function")p=h.call(b,c,p);switch(typeof p){case "string":return q(p);case "number":return isFinite(p)?String(p):"null";case "boolean":case "null":return String(p);
case "object":if(!p)return"null";d+=f;m=[];if(Object.prototype.toString.apply(p)==="[object Array]"){l=p.length;for(j=0;j<l;j+=1)m[j]=a(j,p)||"null";n=m.length===0?"[]":d?"[\n"+d+m.join(",\n"+d)+"\n"+o+"]":"["+m.join(",")+"]";d=o;return n}if(h&&typeof h==="object"){l=h.length;for(j=0;j<l;j+=1){k=h[j];if(typeof k==="string")if(n=a(k,p))m.push(q(k)+(d?": ":":")+n)}}else for(k in p)if(Object.hasOwnProperty.call(p,k))if(n=a(k,p))m.push(q(k)+(d?": ":":")+n);n=m.length===0?"{}":d?"{\n"+d+m.join(",\n"+d)+
"\n"+o+"}":"{"+m.join(",")+"}";d=o;return n}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+s(this.getUTCMonth()+1)+"-"+s(this.getUTCDate())+"T"+s(this.getUTCHours())+":"+s(this.getUTCMinutes())+":"+s(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var e=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
i=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,d,f,g={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},h;if(typeof JSON.stringify!=="function")JSON.stringify=function(c,b,j){var k;f=d="";if(typeof j==="number")for(k=0;k<j;k+=1)f+=" ";else if(typeof j==="string")f=j;if((h=b)&&typeof b!=="function"&&(typeof b!=="object"||typeof b.length!=="number"))throw Error("JSON.stringify");return a("",
{"":c})};if(typeof JSON.parse!=="function")JSON.parse=function(c,b){function j(n,l){var o,m,p=n[l];if(p&&typeof p==="object")for(o in p)if(Object.hasOwnProperty.call(p,o)){m=j(p,o);if(m!==undefined)p[o]=m;else delete p[o]}return b.call(n,l,p)}var k;c=String(c);e.lastIndex=0;if(e.test(c))c=c.replace(e,function(n){return"\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(c.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){k=eval("("+c+")");return typeof b==="function"?j({"":k},""):k}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(s){if(arguments.length<=1)return s;for(var q=arguments.length-2,a=0;a<=q;a++)s=s.replace(RegExp("\\{"+a+"\\}","gi"),arguments[a+1]);return s};
String.prototype.containsWord=function(s){var q="";if(s.toString)s=s.toString();for(var a=0;a<s.length;a++)q+=!/\w/.test(s[a])?"\\"+s[a]:s[a];return RegExp("(^|\\s|\\,)"+q+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var s=Object.prototype.hasOwnProperty,q=0,a={id:"GRUNT.core",extend:function(){var e=arguments[0]||{},i=1,d=arguments.length,f=false,g,h,c,b;if(typeof e==="boolean"){f=e;e=arguments[1]||{};i=2}if(typeof e!=="object"&&!a.isFunction(e))e={};if(d===i){e=this;--i}for(;i<d;i++)if((g=arguments[i])!=null)for(h in g){c=e[h];b=g[h];if(e!==b)if(f&&b&&(a.isPlainObject(b)||a.isArray(b))){c=c&&(a.isPlainObject(c)||a.isArray(c))?c:a.isArray(b)?[]:{};e[h]=a.extend(f,c,b)}else if(b!==undefined)e[h]=
b}return e},isFunction:function(e){return toString.call(e)==="[object Function]"},isArray:function(e){return toString.call(e)==="[object Array]"},isPlainObject:function(e){if(!e||toString.call(e)!=="[object Object]"||e.nodeType||e.setInterval)return false;if(e.constructor&&!s.call(e,"constructor")&&!s.call(e.constructor.prototype,"isPrototypeOf"))return false;var i;for(i in e);return i===undefined||s.call(e,i)},isEmptyObject:function(e){for(var i in e)return false;return true},isXmlDocument:function(e){return toString.call(e)===
"[object Document]"},contains:function(e,i){var d=e,f=arguments,g=1;if(i&&a.isArray(i)){f=i;g=0}for(g=g;g<f;g++)d=d&&typeof foo[f[g]]!=="undefined";return d},newModule:function(e){e=a.extend({id:null,requires:[],parent:null},e);if(e.parent)e=a.extend({},e.parent,e);return e},toID:function(e){return e.replace(/\s/g,"-")},generateObjectID:function(e){return(e?e:"obj")+q++}};return a}();
GRUNT.Log=function(){function s(d,f){var g,h=f&&f.length>0?f[0]:"";for(g=1;f&&g<f.length;g++)h+=" "+(a&&GRUNT.isPlainObject(f[g])?JSON.stringify(f[g]):f[g]);typeof console!=="undefined"&&console[d](h);for(g=0;g<q.length;g++)q[g].call(i,h,d)}var q=[],a=typeof JSON!=="undefined",e=window.console&&window.console.markTimeline,i={id:"GRUNT.log",getTraceTicks:function(){return e?(new Date).getTime():null},trace:function(d,f){if(e)console.markTimeline(d+(f?": "+(i.getTraceTicks()-f)+"ms":""))},debug:function(){s("debug",
arguments)},info:function(){s("info",arguments)},warn:function(){s("warn",arguments)},error:function(){s("error",arguments)},exception:function(d){i.error(arguments);for(var f in d)i.info("ERROR DETAIL: "+f+": "+d[f])},watch:function(d,f){try{f()}catch(g){i.exception(g,d)}},throwError:function(d){i.error(d);throw Error(d);},requestUpdates:function(d){q.push(d)}};return i}();
GRUNT.Data=function(){var s={determineObjectMapping:function(a){if(!a)return null;a=a.split("|");for(var e={},i=0;i<a.length;i++)e[a[i]]=i;return e},mapLineToObject:function(a,e){var i=a.split("|"),d={};for(var f in e){var g=e[f];d[f]=i.length>g?i[g]:null}return d},parse:function(a){var e=null,i=[];a=a.split("\n");for(var d=0;d<a.length;d++){var f=a[d];if(e)i.push(s.mapLineToObject(f,e));else e=s.determineObjectMapping(f)}return i}},q={supportedFormats:{JSON:{parse:function(a){return JSON.parse(a)}},
PDON:{parse:function(a){return s.parse(a)}}},parse:function(a){a=GRUNT.extend({data:"",format:"JSON"},a);if(!q.supportedFormats[a.format])throw Error("Unsupported data format: "+a.format+", cannot parse data in javascript object");try{return q.supportedFormats[a.format].parse(a.data)}catch(e){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+a.format,a.data);GRUNT.Log.exception(e)}return{}}};return q}();
GRUNT.Template=function(){var s=/\$\{(.*?)\}/ig;return{parse:function(q,a){for(var e=q,i=s.exec(e);i;){e=e.replace(i[0],GRUNT.XPath.first(i[1],a));s.lastIndex=0;i=s.exec(e)}return e}}}();
GRUNT.JSONP=function(){function s(i){var d=document.createElement("script"),f=false;d.src=i;d.async=true;d.onload=d.onreadystatechange=function(){if(!f&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){f=true;d.onload=d.onreadystatechange=null;d&&d.parentNode&&d.parentNode.removeChild(d)}};a||(a=document.getElementsByTagName("head")[0]);a.appendChild(d)}var q=0,a,e=this;return{get:function(i,d){i+=i.indexOf("?")>=0?"&":"?";var f="json"+ ++q;e[f]=function(g){d(g);e[f]=
null;try{delete e[f]}catch(h){}};s(i+"callback="+f);return f}}}();
GRUNT.XHR=function(){var s={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},q={JSON:["json"],PDON:["pdon.txt"]},a=["TEXT","STREAM"],e=/^(\w+:)?\/\/([^\/?#]+)/,i={XML:function(g){return g.responseXML},JSON:function(g){try{return JSON.parse(g.responseText)}catch(h){GRUNT.Log.error("Error parsing JSON data: ",g.responseText);GRUNT.Log.exception(h)}return""},PDON:function(g){return GRUNT.Data.parse({data:g.responseText,format:"PDON"})},DEFAULT:function(g){return g.responseText}},
d={CONTENT_TYPE:"Content-Type"},f=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(g){try{g=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},f.ajaxSettings,g);var h=e.exec(g.url),c=h&&(h[1]&&h[1]!==location.protocol||h[2]!==location.host);if(g.data)g.method="POST";if(g.url){h=null;if(g.xhr)h=g.xhr(g);h||(h=new XMLHttpRequest);h.open(g.method,g.url,g.async);g.data&&h.setRequestHeader("Content-Type",
g.contentType);c||h.setRequestHeader("X-Requested-With","XMLHttpRequest");h.onreadystatechange=function(){if(this.readyState===4){var j=null,k=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(k)if(g.handleResponse)g.handleResponse(this);else{var n=g,l=this.getResponseHeader(d.CONTENT_TYPE),o,m=false;for(o in s)if(l&&l.indexOf(s[o])>=0){m=true;break}l=!m;for(m=0;m<a.length;m++)l=l||a[m]==o;if(l)b:{l=o;for(var p in q)for(m=
0;m<q[p].length;m++)if(RegExp(q[p][m]+"$","i").test(n.url)){o=p;break b}o=l?l:"DEFAULT"}try{j=i[o](this,n)}catch(r){GRUNT.Log.warn("error applying processor '"+o+"' to response type, falling back to default");j=i.DEFAULT(this,n)}}else g.error&&g.error(this)}catch(t){GRUNT.Log.exception(t,"PROCESSING AJAX RESPONSE")}k&&j&&g.success&&g.success.call(this,j)}};h.send(g.method=="POST"?f.param(g.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(b){GRUNT.Log.exception(b)}},
param:function(g){var h=[],c=function(j,k){k=GRUNT.isFunction(k)?k():k;h[h.length]=encodeURIComponent(j)+"="+encodeURIComponent(k)};if(GRUNT.isArray(g))for(var b=0;b<g.length;b++)c(g[b].name,g[b].value);else for(b in g)c(b,g[b]);return h.join("&").replace(/%20/g,"+")}});return f}();
GRUNT.XPath=function(){function s(i){for(var d=null,f=0;f<q.length;f++)if(d=q[f](i))break;return d}var q=[],a=[null,function(i){return i.numberValue},function(i){return i.stringValue},function(i){return i.booleanValue},null,null,null,null,function(i){return i.singleNodeValue?i.singleNodeValue.textContent:null},function(i){return i.singleNodeValue?i.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var e={SearchResult:function(i){return{toString:function(){var d=
null;if(i){var f=null;if(i.resultType>=0&&i.resultType<a.length)f=a[i.resultType];if(f){GRUNT.Log.info("invoking match handler for result type: "+i.resultType);d=f(i)}}return d?d:""}}},first:function(i,d){var f=e.SearchResult,g;var h=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!h)h=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(d))g=d.evaluate(i,d,s,h,null);else{GRUNT.Log.warn("attempted xpath expression: "+i+" on a non-xml document");g=null}}catch(c){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
i+" on node: "+d);g=null}return new f(g)},registerResolver:function(i){q.push(i)}};return e}();GRUNT.WaterCooler=function(){var s={},q=[];return{addPipe:function(a){a("pipe.test",{});q.push(a)},listen:function(a,e){s[a]||(s[a]=[]);e&&s[a].push(e)},say:function(a,e){var i;for(i=q.length;i--;)q[i](a,e);if(s[a])for(i=s[a].length;i--;)s[a][i](e)},leave:function(){}}}();
TILE5=function(){var s={Settings:function(){var q={};return{get:function(a){return q[a]},set:function(a,e){q[a]=e},extend:function(a){GRUNT.extend(q,a)}}}(),Clock:function(){var q=null;return{getTime:function(a){return a&&q?q:q=(new Date).getTime()}}}(),Vector:function(q,a){return{x:q?q:0,y:a?a:0}},V:function(){function q(a){if(!a||a.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var e={edges:Array(a.length-1),accrued:Array(a.length-1),total:0},
i=TILE5.V.diff,d=0;d<a.length-1;d++){var f=i(a[d],a[d+1]);e.edges[d]=Math.sqrt(f.x*f.x+f.y*f.y);e.accrued[d]=e.total+e.edges[d];e.total+=e.edges[d]}return e}return{create:function(a,e){return new s.Vector(a,e)},add:function(){for(var a=new s.Vector,e=arguments.length;e--;){a.x+=arguments[e].x;a.y+=arguments[e].y}return a},absSize:function(a){return Math.max(Math.abs(a.x),Math.abs(a.y))},diff:function(a,e){return new s.Vector(a.x-e.x,a.y-e.y)},copy:function(a){return a?new s.Vector(a.x,a.y):null},
invert:function(a){return new TILE5.Vector(-a.x,-a.y)},offset:function(a,e,i){return new TILE5.Vector(a.x+e,a.y+(i?i:e))},edges:q,distance:function(a){return q(a).total},theta:function(a,e,i){i=Math.asin((a.y-e.y)/i);return a.x>e.x?i:Math.PI-i},pointOnEdge:function(a,e,i,d){e=new TILE5.Vector(Math.cos(i)*d,Math.sin(i)*d);return new TILE5.Vector(a.x-e.x,a.y-e.y)},getRect:function(a){var e=a.length;if(e>1)return new TILE5.Rect(Math.min(a[0].x,a[e-1].x),Math.min(a[0].y,a[e-1].y),Math.abs(a[0].x-a[e-
1].x),Math.abs(a[0].y-a[e-1].y))}}}(),Dimensions:function(q,a){return{width:q?q:0,height:a?a:0}},D:function(){return{getAspectRatio:function(q){return q.height!==0?q.width/q.height:1},getCenter:function(q){return new s.Vector(q.width/2,q.height/2)},getSize:function(q){return Math.sqrt(Math.pow(q.width,2)+Math.pow(q.height,2))}}}(),Rect:function(q,a,e,i){return{origin:new s.Vector(q,a),dimensions:new s.Dimensions(e,i)}},R:function(){return{copy:function(q){return q?new s.Rect(q.origin.x,q.origin.y,
q.dimensions.width,q.dimensions.height):null},getCenter:function(q){return new TILE5.Vector(q.origin.x+q.dimensions.width/2,q.origin.y+q.dimensions.height/2)}}}()};return s}();
TILE5.Device=function(){function s(){for(;b.length>0;){var k=b.shift();document.location=k}c=0}function q(k){for(var n=true,l=j.length;l--;)n=n&&k!=j[l];return n}function a(k,n){var l=[];for(var o in n)o&&l.push(o+"="+escape(n[o]));return"tile5://"+k+"/"+(l.length>0?"?"+l.join("&"):"")}function e(k,n){q(k)&&GRUNT.Log.info("would push url: "+a(k,n))}function i(k,n){if(q(k)){b.push(a(k,n));c||setTimeout(s,100)}}function d(){f={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in document,
imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:4,requireFastDraw:false,bridgeNotify:e},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true,bridgeNotify:i},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:i},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:i},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,supportsTouch:true,getScaling:function(){return 1/
window.devicePixelRatio},bridgeNotify:i},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:i}};g=[f.froyo,f.android,f.ipod,f.iphone,f.ipad]}var f=null,g=[],h=null,c=0,b=[],j=["view.wake","tile.loaded"];return{getConfig:function(){f||d();if(!h){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var k=0;k<g.length;k++){var n=g[k];if(n.regex&&n.regex.test(navigator.userAgent)){h=GRUNT.extend({},f.base,n);GRUNT.Log.info("PLATFORM DETECTED AS: "+
h.name);break}}if(!h){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");h=f.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return h}}}();
TILE5.Resources=function(){var s="",q={},a=function(){function i(){var m=h[this.id];if(m){m.loaded=true;m.hitCount=1;for(var p=j.length;p--;)if(j[p].image.src==this.src){j.splice(p,1);break}m.loadCallback&&m.loadCallback(this,false);k.push({url:this.src,created:m.requested});delete h[this.id];d()}}function d(){for(var m=TILE5.Device.getConfig().maxImageLoads;b.length>0&&(!m||j.length<m);){var p=b.shift();j.push(p);p.image.onload=i;p.image.src=p.url;p.requested=(new Date).getTime()}}function f(){l=
true;try{var m=Math.floor(k.length/2);if(m>0){k.sort(function(r,t){return r.created-t.created});for(var p=m;p--;)delete g[k[p].url];k.splice(0,m)}}finally{l=false}GRUNT.WaterCooler.say("imagecache.cleared")}var g={},h={},c=0,b=[],j=[],k=[],n=0,l=false,o={loadingImages:j,queuedImages:b,getCacheFullness:function(){return n},getImage:function(m){var p=null;l||(p=g[m]);return p?p.image:null},loadImage:function(m,p){var r=g[m];if(r){r.hitCount++;r.image.complete&&p&&p(r.image,true)}else{r={url:e.getPath(m),
image:new Image,loaded:false,created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:p};r.image.id="resourceLoaderImage"+c++;g[m]=r;h[r.image.id]=r;b.push(r);d()}return r},resetLoadingQueue:function(){j=[]}};setInterval(function(){for(var m=(new Date).getTime(),p=false,r=0,t=TILE5.Device.getConfig();r<j.length;)if(m-j[r].requested>e.loadTimeout*1E3){j.splice(r,1);p=true}else r++;p&&d();if(t&&t.imageCacheMaxSize){n=k.length*e.avgImageSize/t.imageCacheMaxSize;n>=1&&f()}},1E3);return o}(),
e={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(i,d){for(var f=(i?i.replace(/^.*\?/,""):"").split("&"),g=i?i.replace(/\?.*$/,"?"):"",h=0;h<f.length;h++){var c=f[h].split("=");if(!d||!d.test(c[0]))g+=f[h]+"&"}return g.replace(/\W/g,"")},isValidCacheKey:function(i){GRUNT.Log.info("cache key = "+i);return false}}}(),getCachedUrl:function(i){return i},getPath:function(i){return/^(https?|\/)/.test(i)?i:s+i},setBasePath:function(i){s=
i},getImage:function(i){return a.getImage(i)},loadImage:function(i,d){a.loadImage(i,d)},resetImageLoadQueue:function(){a.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:a.loadingImages.length,queuedImageCount:a.queuedImages.length,imageCacheFullness:a.getCacheFullness()}},loadResource:function(i){i=GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},i);var d=function(f){i.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){i.callback(f)})};i.cacheable&&
q[i.filename]?d(q[i.filename]):GRUNT.XHR.ajax({url:e.getPath(i.filename),dataType:i.dataType,success:function(f){if(i.cacheable)q[i.filename]=f;d(f)},error:function(f,g,h){GRUNT.Log.error("error loading resource ["+i.filename+"], error = "+h)}})},loadSnippet:function(i,d){/\.\w+$/.test(i)||(i+=".html");e.loadResource({filename:"snippets/"+i,callback:d,dataType:"html"})}};return e}();
TILE5.Touch=function(){function s(c,b){var j=c&&c.length>0?c[0]:null;if(j&&b&&b.length>0)return TILE5.V.diff(j,b[0]);return null}function q(c){c.preventDefault();c.stopPropagation()}function a(c){for(var b=Array(c.length),j=c.length;j--;)b[j]=new TILE5.Vector(c[j].pageX,c[j].pageY);return b}var e={TAP:0,MOVE:1,PINCHZOOM:2},i=7,d=0,f=0,g={TouchHelper:function(c){function b(u){for(var A=[],C=c.element?-c.element.offsetLeft:0,H=c.element?-c.element.offsetTop:0,O=u.length;O--;)A.push(TILE5.V.offset(u[O],
C,H));return A}function j(u){var A=Array(arguments.length-1),C=0;for(C=1;C<arguments.length;C++)A[C-1]=arguments[C];for(C=F.length;C--;)F[C][u]&&F[C][u].apply(M,A)}function k(u){if(u.target&&u.target===c.element){r=p?a(u.touches):[new TILE5.Vector(u.pageX,u.pageY)];v=new TILE5.Vector;x=new TILE5.Vector;E=true;o=false;p&&q(u);G.current=TILE5.Clock.getTime();if(u=r.length>0?r[0]:null){j("touchStartHandler",u.x,u.y);if(G.current-G.last<M.THRESHOLD_DOUBLETAP)if((u=t?TILE5.V.diff(r[0],t[0]):null)&&Math.abs(u.x)<
c.maxDistDoubleTap&&Math.abs(u.y)<c.maxDistDoubleTap)o=true;B=e.TAP;t=[].concat(r)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function n(u){if(u.target&&u.target===c.element)if(E)try{p&&q(u);var A=p?a(u.touches):[new TILE5.Vector(u.pageX,u.pageY)];u=0;if(A.length>1){if(r.length===1)r=[].concat(A);u=TILE5.V.distance(r)-TILE5.V.distance(t)}if(B===e.TAP){var C=s(A,r);if(C&&(Math.abs(C.x)>=i||Math.abs(C.y)>=i))B=e.MOVE}if(B!==e.TAP)if(!u||Math.abs(u)<c.pinchZoomThreshold){if(v=
s(A,t)){x.x+=v.x;x.y+=v.y;z.x+=v.x;z.y+=v.y}if(TILE5.V.absSize(z)>c.panEventThreshhold){j("moveHandler",z.x,z.y);z=TILE5.V.create()}B=e.MOVE}else{j("pinchZoomHandler",b(r),b(A));B=e.PINCHZOOM}t=[].concat(A)}catch(H){GRUNT.Log.exception(H)}}function l(u){if(u.target&&u.target===c.element)try{p&&q(u);TILE5.Clock.getTime();G.last=G.current;if(B===e.TAP)m||(m=setTimeout(function(){m=0;var C=o?"doubleTapHandler":"tapHandler",H=r[0],O=null;if(c.element)O=TILE5.V.offset(H,-c.element.offsetLeft,-c.element.offsetTop);
j(C,H,O)},M.THRESHOLD_DOUBLETAP+50));else if(B==e.MOVE)j("moveEndHandler",x.x,x.y);else B==e.PINCHZOOM&&j("pinchZoomEndHandler",b(r),b(t))}catch(A){GRUNT.Log.exception(A)}E=false}c=GRUNT.extend({element:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},c);var o=false,m=0,p=TILE5.Device.getConfig().supportsTouch,
r=null,t=null,v=null,x=null,z=new TILE5.Vector,B=null,E=false,F=[],G={current:0,last:0},D=TILE5.Device.getConfig(),M={supportsTouch:p,THRESHOLD_DOUBLETAP:300,addListeners:function(u){F.push(u)},decoupleListeners:function(u){for(var A=0;u&&A<F.length;A++)if(F[A].listenerId===u){F.splice(A,1);GRUNT.Log.info("successfully decoupled touch listener: "+u);break}},release:function(){D.eventTarget.removeEventListener(D.supportsTouch?"touchstart":"mousedown",k,false);D.eventTarget.removeEventListener(D.supportsTouch?
"touchmove":"mousemove",n,false);D.eventTarget.removeEventListener(D.supportsTouch?"touchend":"mouseup",l,false)},wheelie:function(u){var A=new TILE5.Vector(u.wheelDeltaX,u.wheelDeltaY);u=new TILE5.Vector(u.clientX,u.clientY);var C=A.y!==0?Math.abs(A.y/120):0;if(C!==0)j("wheelZoomHandler",u,A.y>0?C+0.5:0.5/C);GRUNT.Log.info("capture mouse wheel event, delta = "+A+", position = "+u)}};D.eventTarget.addEventListener(D.supportsTouch?"touchstart":"mousedown",k,false);D.eventTarget.addEventListener(D.supportsTouch?
"touchmove":"mousemove",n,false);D.eventTarget.addEventListener(D.supportsTouch?"touchend":"mouseup",l,false);return M}},h=[];return{captureTouch:function(c,b){try{if(!c)throw Error("Unable to capture touch of null element");if(!c.id)c.id="touchable_"+d++;var j=h[c.id];if(!j){j=g.TouchHelper(GRUNT.extend({element:c},b));h[c.id]=j;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+j.supportsTouch)}b.listenerId&&j.decoupleListeners(b.listenerId);b.listenerId=++f;j.addListeners(b)}catch(k){GRUNT.Log.exception(k)}},
resetTouch:function(c){if(c&&c.id&&h[c.id]){h[c.id].release();delete h[c.id]}},Pannable:function(c){c=GRUNT.extend({container:null,onPan:null,onPanEnd:null,onAnimate:null,checkOffset:null},c);var b=false,j=new TILE5.Vector,k={pannable:true,getOffset:function(){return new TILE5.Vector(j.x,j.y)},setOffset:function(l,o){j.x=l;j.y=o},pan:function(l,o,m){if(m)k.updateOffset(j.x+l,j.y+o,m);else{k.updateOffset(j.x+l,j.y+o);c.onPan&&c.onPan(l,o)}},isAnimating:function(){return b},panEnd:function(l,o){c.onPanEnd&&
c.onPanEnd(l,o)},updateOffset:function(l,o,m){if(m){l=new TILE5.Vector(l,o);b=true;m=TILE5.Animation.tweenVector(j,l.x,l.y,m,function(){b=false;k.panEnd(0,0)});for(l=m.length;l--;){m[l].cancelOnInteract=true;m[l].requestUpdates(function(){c.onAnimate&&c.onAnimate(j.x,j.y)})}}else k.setOffset(l,o)}},n=document.getElementById(c.container);n&&TILE5.Touch.captureTouch(n,{moveHandler:function(l,o){k.pan(-l,-o)},moveEndHandler:function(l,o){k.panEnd(l,o)}});return k},Scalable:function(c){function b(x,z){k=
TILE5.V.getRect(x);n=TILE5.V.getRect(z);var B=TILE5.D.getSize(k.dimensions),E=TILE5.D.getSize(n.dimensions);r=TILE5.R.getCenter(n);l=k&&B!==0?E/B:1}c=GRUNT.extend({container:null,onAnimate:null,onPinchZoom:null,onScale:null,scaleDamping:false},c);var j=false,k=null,n=null,l=1,o=null,m=null,p=null,r=null,t={scalable:true,animate:function(x,z,B,E,F){function G(){F&&F();j=false;c.onScale&&c.onScale(l,r);l=1;o=null}j=true;p=TILE5.V.copy(z);r=TILE5.V.copy(B);k=null;if(E){m=l;TILE5.Animation.tweenValue(0,
x-m,E,G,1E3).requestUpdates(function(D){o=D/(x-m);l=m+D;c.onAnimate&&c.onAnimate()})}else{l=x;G()}},getScaleInfo:function(){return{factor:l,startRect:TILE5.R.copy(k),endRect:TILE5.R.copy(n),start:p,center:r,progress:o}},getScaling:function(){return j},getScaleFactor:function(){return l}},v=document.getElementById(c.container);v&&TILE5.Touch.captureTouch(v,{pinchZoomHandler:function(x,z){b(x,z);(j=l!==1)&&c.onPinchZoom&&c.onPinchZoom(x,z)},pinchZoomEndHandler:function(x,z){b(x,z);j=false;c.onScale&&
c.onScale(l,r,true);l=1},wheelZoomHandler:function(x){k=n=null;r=TILE5.V.copy(x)}});return t}}}();if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(s){return this.each(function(){TILE5.Touch.captureTouch(this,s)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(s){s.preventDefault()})}}
TILE5.Dispatcher=function(){var s=[],q={execute:function(a){var e=q.findAction(a);GRUNT.Log.info("looking for action id: "+a+", found: "+e);if(e){var i=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+a,function(){e.execute(i)})}},findAction:function(a){for(var e=s.length;e--;)if(s[e].id==a)return s[e];return null},getRegisteredActions:function(){return[].concat(s)},getRegisteredActionIds:function(){for(var a=[],e=s.length;e--;)s[e].id&&a.push(s[e].id);return a},registerAction:function(a){a&&
a.id&&s.push(a)},Action:function(a){a=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},a);var e={id:a.id,execute:function(){a.execute&&a.execute.apply(this,arguments)},getParam:function(i){return a[i]?a[i]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",e.id,a.title,a.icon)}};a.autoRegister&&q.registerAction(e);return e},createAgent:function(a){a=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},a);var e=null,i={getName:function(){return a.name},
getParam:function(d){return a[d]},getId:function(){return GRUNT.toID(i.getName())},run:function(d,f){if(a.execute){var g=e=TILE5.Clock.getTime(true),h=a.translator?a.translator(d):d;a.execute.call(i,h,function(c,b){if(!a.trashOrphanedResults||g==e)f&&f(c,b,h)})}}};return i},runAgents:function(a,e,i){for(var d=0;d<a.length;d++)a[d].run(e,i)}};return q}();
TILE5.Animation=function(){function s(){if(e===0)e=setInterval(function(){if(i.update(TILE5.Clock.getTime())===0){clearInterval(e);e=0}},20)}var q=[],a=false,e=0,i={DURATION:2E3,tweenValue:function(d,f,g,h,c){d=new i.Tween({startValue:d,endValue:f,tweenFn:g,complete:h,duration:c});q.push(d);return d},tween:function(d,f,g,h,c,b){d=new i.Tween({target:d,property:f,endValue:g,tweenFn:h,duration:b,complete:c});q.push(d);return d},tweenVector:function(d,f,g,h,c,b){var j=[];if(d){var k=d.x==f,n=d.y==g;
k||j.push(i.tween(d,"x",f,h,function(){(k=true)&&n&&c()},b));n||j.push(i.tween(d,"y",g,h,function(){n=true;k&&n&&c()},b))}return j},cancel:function(d){if(!a){a=true;try{for(var f=0;f<q.length;)if(!d||d(q[f])){GRUNT.Log.info("CANCELLING ANIMATION");q[f].triggerComplete(true);q.splice(f,1)}else f++}finally{a=false}}},isTweening:function(){return q.length>0},update:function(d){if(a)return q.length;a=true;try{for(var f=0;f<q.length;)if(q[f].isComplete()){q[f].triggerComplete(false);q.splice(f,1);GRUNT.WaterCooler.say("animation.complete")}else{q[f].update(d);
f++}}finally{a=false}return q.length},Tween:function(d){d=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:i.DURATION,tweenFn:i.DEFAULT,complete:null,cancelOnInteract:false},d);var f=TILE5.Clock.getTime(),g=[],h=false,c=0,b=0,j={cancelOnInteract:d.cancelOnInteract,isComplete:function(){return h},triggerComplete:function(k){d.complete&&d.complete(k)},update:function(k){try{var n=d.tweenFn(k-f,c,b,d.duration);if(d.target)d.target[d.property]=n;for(var l=g.length;l--;)g[l](n,
void 0);if(h=f+d.duration<=k){if(d.target)d.target[d.property]=d.tweenFn(d.duration,c,b,d.duration);for(var o=g.length;o--;)g[o](n,true)}}catch(m){GRUNT.Log.exception(m)}},requestUpdates:function(k){g.push(k)}};c=d.target&&d.property&&d.target[d.property]?d.target[d.property]:d.startValue;if(typeof d.endValue!=="undefined")b=d.endValue-c;if(b==0)h=true;s();return j},Easing:function(){var d=1.70158;return{Linear:function(f,g,h,c){return h*f/c+g},Back:{In:function(f,g,h,c){return h*(f/=c)*f*((d+1)*
f-d)+g},Out:function(f,g,h,c){return h*((f=f/c-1)*f*((d+1)*f+d)+1)+g},InOut:function(f,g,h,c){return(f/=c/2)<1?h/2*f*f*(((d*=1.525)+1)*f-d)+g:h/2*((f-=2)*f*(((d*=1.525)+1)*f+d)+2)+g}},Bounce:{In:function(f,g,h,c){return h-i.Easing.Bounce.Out(c-f,0,h,c)+g},Out:function(f,g,h,c){return(f/=c)<1/2.75?h*7.5625*f*f+g:f<2/2.75?h*(7.5625*(f-=1.5/2.75)*f+0.75)+g:f<2.5/2.75?h*(7.5625*(f-=2.25/2.75)*f+0.9375)+g:h*(7.5625*(f-=2.625/2.75)*f+0.984375)+g},InOut:function(f,g,h,c){return f<c/2?i.Easing.Bounce.In(f*
2,0,h,c)/2+g:i.Easing.Bounce.Out(f*2-c,0,h,c)/2+h/2+g}},Cubic:{In:function(f,g,h,c){return h*(f/=c)*f*f+g},Out:function(f,g,h,c){return h*((f=f/c-1)*f*f+1)+g},InOut:function(f,g,h,c){if((f/=c/2)<1)return h/2*f*f*f+g;return h/2*((f-=2)*f*f+2)+g}},Elastic:{In:function(f,g,h,c,b,j){if(f==0)return g;if((f/=c)==1)return g+h;j||(j=c*0.3);if(!b||b<Math.abs(h)){b=h;h=j/4}else h=j/(2*Math.PI)*Math.asin(h/b);return-(b*Math.pow(2,10*(f-=1))*Math.sin((f*c-h)*2*Math.PI/j))+g},Out:function(f,g,h,c,b,j){var k;if(f==
0)return g;if((f/=c)==1)return g+h;j||(j=c*0.3);if(!b||b<Math.abs(h)){b=h;k=j/4}else k=j/(2*Math.PI)*Math.asin(h/b);return b*Math.pow(2,-10*f)*Math.sin((f*c-k)*2*Math.PI/j)+h+g},InOut:function(f,g,h,c,b,j){var k;if(f==0)return g;if((f/=c/2)==2)return g+h;j||(j=c*0.3*1.5);if(!b||b<Math.abs(h)){b=h;k=j/4}else k=j/(2*Math.PI)*Math.asin(h/b);if(f<1)return-0.5*b*Math.pow(2,10*(f-=1))*Math.sin((f*c-k)*2*Math.PI/j)+g;return b*Math.pow(2,-10*(f-=1))*Math.sin((f*c-k)*2*Math.PI/j)*0.5+h+g}},Quad:{In:function(f,
g,h,c){return h*(f/=c)*f+g},Out:function(f,g,h,c){return-h*(f/=c)*(f-2)+g},InOut:function(f,g,h,c){if((f/=c/2)<1)return h/2*f*f+g;return-h/2*(--f*(f-2)-1)+g}},Sine:{In:function(f,g,h,c){return-h*Math.cos(f/c*(Math.PI/2))+h+g},Out:function(f,g,h,c){return h*Math.sin(f/c*(Math.PI/2))+g},InOut:function(f,g,h,c){return-h/2*(Math.cos(Math.PI*f/c)-1)+g}}}}()};return GRUNT.extend(i,{DEFAULT:i.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var s={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},q=0,a={DisplayState:s,AnyDisplayState:255,ActiveDisplayStates:s.ACTIVE|s.ANIMATING,DefaultDisplayStates:s.ACTIVE|s.ANIMATING|s.PAN|s.PINCHZOOM,ViewLayer:function(e){e=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:a.DefaultDisplayStates},e);var i=null,d=e.id,f=GRUNT.extend({addToView:function(g){g.setLayer(d,f)},shouldDraw:function(g){var h=
i?i.fastDraw&&g!==s.ACTIVE:false;return(g&e.validStates)!==0&&(h?e.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:d})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:i?i.id:null})},getId:function(){return d},setId:function(g){d=g},getParent:function(){return i},setParent:function(g){i=g}},e);return f},AnimatedPathLayer:function(e){function i(b,j,k){b.fillStyle="#FFFFFF";b.strokeStyle="#222222";b.beginPath();
b.arc(k.x,k.y,4,0,Math.PI*2,false);b.stroke();b.fill()}e=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,canCache:false,validStates:a.ActiveDisplayStates|s.PAN|s.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},e);var d=TILE5.V.edges(e.path),f,g=null,h=0;TILE5.Animation.tweenValue(0,d.total,e.easing,function(){c.remove()},e.duration).requestUpdates(function(b,j){h=b;j&&c.remove()});var c=GRUNT.extend(new a.ViewLayer(e),{cycle:function(){for(var b=
0;b<d.accrued.length&&d.accrued[b]<h;)b++;g=null;if(b<e.path.length-1){var j=h-(b>0?d.accrued[b-1]:0),k=e.path[b],n=e.path[b+1];f=TILE5.V.theta(k,n,d.edges[b]);g=TILE5.V.pointOnEdge(k,n,f,j);if(e.autoCenter)(b=c.getParent())&&b.centerOn(g)}return g?1:0},draw:function(b,j){if(g)(e.drawIndicator?e.drawIndicator:i)(b,j,new TILE5.Vector(g.x-j.x,g.y-j.y),f)}});return c},FPSLayer:function(e){e=GRUNT.extend({zindex:1E3,scalePosition:false},e);var i=null,d=GRUNT.extend(new a.ViewLayer(e),{delays:[],draw:function(f,
g,h){f.font="bold 8pt Arial";f.textAlign="right";f.fillStyle="rgba(0, 0, 0, 0.8)";f.fillText((i?i:"?")+" fps",h.width-20,20)}});setInterval(function(){for(var f=0,g=d.delays.length,h=g;h--;)f+=d.delays[h];if(g!==0)i=Math.floor(1E3/(f/g))},1E3);return d},ResourceStatsLayer:function(e){e=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:s.ACTIVE|s.PAN},e);return GRUNT.extend(new a.ViewLayer(e),{fps:null,draw:function(i){var d=TILE5.Resources.getStats(),f=e.indicatorSize,g=10,
h;if(d.imageCacheFullness){i.strokeStyle="rgba(0, 0, 255, 1)";i.beginPath();i.arc(15,15,5,0,Math.PI*2*d.imageCacheFullness,false);i.stroke();g=30}if(d.imageLoadingCount>=0){i.fillStyle="rgba(0, 255, 0, 0.7)";for(h=d.imageLoadingCount;h--;)i.fillRect(g+h*(f+2),10,f,f)}if(d.queuedImageCount>=0){i.fillStyle="rgba(255, 0, 0, 0.7)";for(h=d.queuedImageCount;h--;)i.fillRect(g+h*(f+2),10+f+2,f,f)}}})},LoadingLayer:function(e){GRUNT.extend({},e)},View:function(e){function i(w,y){y.setId(w);y.setParent(J);
c.push(y);c.sort(function(I,K){var L=K.zindex-I.zindex;if(L===0)L=K.created-I.created;return L})}function d(){GRUNT.WaterCooler.say("view.idle",{id:J.id});D=true;u=0}function f(w,y){var I=0,K=J.getScaleFactor(),L=J.getDisplayState(),T=(new Date).getTime(),R=(L&s.PINCHZOOM)!==0;l=J.getScaleFactor();var Q=0;if(n||R){w.clearRect(0,0,b.width,b.height);n=false}if(R){var N=G.getScaleInfo();TILE5.D.getCenter(v);var P=(N.progress?N.progress:1)/2;E=N.center;if(N.startRect){P=TILE5.R.getCenter(N.startRect);
P=TILE5.V.diff(P,E);A=new TILE5.Vector(E.x+P.x,E.y+P.y)}else{N=TILE5.V.diff(N.start,E);A=new TILE5.Vector(E.x-N.x*P,E.y-N.y*P)}if(A)y=TILE5.V.offset(y,A.x,A.y)}w.save();try{if(r!==1)w.scale(r,r);else if(R){w.translate(E.x,E.y);w.scale(K,K)}for(Q=c.length;Q--;)if(c[Q].shouldDraw(L)){var S=c[Q].draw(w,y,v,L,J);I+=S?S:0}}finally{w.restore()}GRUNT.Log.trace("draw complete",T);return I}function g(){var w=0,y=H===s.PINCHZOOM||H===s.PAN;C=(new Date).getTime();k=F?F.getOffset():new TILE5.Vector;k.x=Math.floor(k.x);
k.y=Math.floor(k.y);B&&o&&B.delays.push(C-o);if(y){TILE5.Animation.cancel(function(K){return K.cancelOnInteract});D=false;if(u!==0){clearTimeout(u);u=0}}for(y=c.length;y--;){var I=c[y].cycle(C,k);w+=I?I:0}w+=f(j,k);o=C;M=0;if(z+w>0)h();else if(!D&&u===0)u=setTimeout(d,500);GRUNT.Log.trace("Completed draw cycle",C)}function h(){z++;if(!(p||M!==0)){z=0;M=setTimeout(g,0)}}e=GRUNT.extend({id:"view_"+q++,container:"",pannable:false,scalable:false,clearOnDraw:false,displayFPS:false,displayResourceStats:false,
scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,onPan:null,onPinchZoom:null,onScale:null,onDraw:null,autoSize:false},e);var c=[],b=document.getElementById(e.container),j=null,k=new TILE5.Vector,n=false,l=1,o=null,m=0,p=false,r=1,t=new TILE5.Vector,v=null,x=null,z=0,B=null,E=null,F=null,G=null,D=false,M=0,u=0,A=null,C=0,H=a.DisplayState.ACTIVE;GRUNT.Log.info("Creating a new view instance, attached to container: "+
e.container+", canvas = ",b);if(b){TILE5.Touch.resetTouch(b);if(e.autoSize){GRUNT.Log.info("autosizing view: window.height = "+window.innerHeight+", width = "+window.innerWidth);b.height=window.innerHeight-b.offsetTop;b.width=window.innerWidth-b.offsetLeft}try{j=b.getContext("2d");j.globalCompositeOperation=e.initialDrawMode;j.clearRect(0,0,b.width,b.height)}catch(O){GRUNT.Log.exception(O);throw Error("Could not initialise canvas on specified view element");}}if(e.pannable)F=new TILE5.Touch.Pannable({container:e.container,
onAnimate:function(){h()},onPan:function(w,y){m=TILE5.Clock.getTime(true);h();t=TILE5.V.offset(t,w,y);e.onPan&&e.onPan(w,y);H=s.PAN},onPanEnd:function(){h();H=s.ACTIVE}});if(e.scalable)G=new TILE5.Touch.Scalable({scaleDamping:e.scaleDamping,container:e.container,onAnimate:function(){H=a.DisplayState.PINCHZOOM;h()},onPinchZoom:function(w,y){m=TILE5.Clock.getTime(true);h();e.onPinchZoom&&e.onPinchZoom(w,y);H=a.DisplayState.PINCHZOOM},onScale:function(w,y){GRUNT.WaterCooler.say("view.scale",{id:J.id});
H=a.DisplayState.ACTIVE;h();e.onScale&&e.onScale(w,y)}});var J=GRUNT.extend({},e,F,G,{id:e.id,deviceScaling:r,fastDraw:e.fastDraw||TILE5.Device.getConfig().requireFastDraw,centerOn:function(w){F.setOffset(w.x-b.width/2,w.y-b.height/2)},getDimensions:function(){if(b)return new TILE5.Dimensions(b.width,b.height)},getZoomCenter:function(){return A},getLayer:function(w){for(var y=0;y<c.length;y++)if(c[y].getId()==w)return c[y];return null},setLayer:function(w,y){for(var I=0;I<c.length;I++)if(c[I].getId()===
w){c.splice(I,1);break}y&&i(w,y);GRUNT.WaterCooler.say("layer.update",{id:w});h()},eachLayer:function(w){for(var y=0;y<c.length;y++)w(c[y])},clearBackground:function(){n=true},freeze:function(){p=true},unfreeze:function(){p=false;h()},snapshot:function(){},getDisplayState:function(){return p?s.FROZEN:H},scale:function(w,y,I,K,L){K||(K=TILE5.D.getCenter(v));L||(L=TILE5.D.getCenter(v));G&&G.animate(w,K,L,y,I);return G},removeLayer:function(w){a:{for(var y=c.length;y--;)if(c[y].getId()==w){w=y;break a}w=
-1}if(w>=0&&w<c.length){GRUNT.WaterCooler.say("layer.removed",{layer:c[w]});c.splice(w,1)}}});v=J.getDimensions();x=TILE5.D.getCenter(v);GRUNT.WaterCooler.listen("layer.remove",function(w){w.id&&J.removeLayer(w.id)});GRUNT.WaterCooler.listen("view.wake",function(w){if(!w.id||w.id===J.id)h()});r=TILE5.Device.getConfig().getScaling();if(e.displayFPS){B=new a.FPSLayer;J.setLayer("fps",B)}e.displayResourceStats&&J.setLayer("resourceStats",new a.ResourceStatsLayer);h();return J}};return a}();
TILE5.Tiling=function(){function s(){if(!a){a=document.createElement("canvas");a.width=i.Config.TILESIZE;a.height=i.Config.TILESIZE;var d=a.getContext("2d");d.fillStyle="rgba(150, 150, 150, 0.025)";d.fillRect(0,0,a.width,a.height)}return a}function q(){if(!e){e=document.createElement("canvas");e.width=i.Config.TILESIZE;e.height=i.Config.TILESIZE;var d=e.getContext("2d"),f=Math.floor(Math.sqrt(i.Config.TILESIZE));d.fillStyle="rgba(200, 200, 200, 1)";d.strokeStyle="rgb(190, 190, 190)";d.lineWidth=0.5;
d.fillRect(0,0,e.width,e.height);d.beginPath();for(var g=0;g<e.width;g+=f){d.moveTo(g,0);d.lineTo(g,e.height);for(var h=0;h<e.height;h+=f){d.moveTo(0,h);d.lineTo(e.width,h)}}d.stroke()}return e}TileStore=function(d){d=GRUNT.extend({gridSize:20,center:new TILE5.Vector,onPopulate:null},d);var f=Array(Math.pow(d.gridSize,2)),g=TILE5.V.offset(d.center,-Math.ceil(d.gridSize>>1)),h=null,c=new TILE5.Vector,b=null,j={getGridSize:function(){return d.gridSize},getNormalizedPos:function(k,n){return TILE5.V.add(new TILE5.Vector(k,
n),TILE5.V.invert(g),c)},getTileShift:function(){return TILE5.V.copy(c)},getTile:function(k,n){return k>=0&&k<d.gridSize?f[n*d.gridSize+k]:null},setTile:function(k,n,l){f[n*d.gridSize+k]=l},populate:function(k,n){var l=GRUNT.Log.getTraceTicks(),o=0;new TILE5.Vector(d.gridSize/2,d.gridSize/2);if(k)for(var m=0;m<d.gridSize;m++)for(var p=0;p<d.gridSize;p++){if(!f[o]){var r=k(p,m,g,d.gridSize);f[o]=r}o++}h=k;b=n;GRUNT.Log.trace("tile grid populated",l);d.onPopulate&&d.onPopulate()},getShiftDelta:function(k,
n,l,o){var m=Math.floor(d.gridSize*0.2),p=new TILE5.Vector;if(k<0||k+l>d.gridSize)p.x=k<0?-m:m;if(n<0||n+o>d.gridSize)p.y=n<0?-m:m;return p},shift:function(k,n){if(!(k.x===0&&k.y===0)){var l=GRUNT.Log.getTraceTicks(),o=Array(f.length);o.length=f.length;for(var m=0;m<d.gridSize;m++)for(var p=0;p<d.gridSize;p++)o[p*d.gridSize+m]=j.getTile(m+k.x,p+k.y);f=o;g=n?n(g,k):TILE5.V.add(g,k);c.x+=-k.x*d.tileSize;c.y+=-k.y*d.tileSize;GRUNT.Log.trace("tile storage shifted",l);j.populate(h,b)}},setOrigin:function(k,
n){if(tileOrigin)shiftOrigin(k,n);else g=TILE5.V.offset(new TILE5.Vector(k,n),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var k=f.length;k--;)if(f[k])f[k].loaded=false});return j};var a=null,e=null,i={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(d){return d=GRUNT.extend({x:0,y:0,size:256},d)},ImageTile:function(d){d=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},d);return new i.Tile(d)},TileGrid:function(d){function f(r,t,v,
x){if((b?TILE5.V.absSize(TILE5.V.diff(b,t)):h)>=20){r=g.getTileShift();r=new TILE5.Vector(Math.floor((t.x+r.x)*c),Math.floor((t.y+r.y)*c));var z=Math.ceil(v.width*c)+1;v=Math.ceil(v.height*c)+1;var B=new TILE5.Vector(Math.floor((z-1)/2),Math.floor((v-1)/2)),E=new TILE5.Vector(r.x*d.tileSize,r.y*d.tileSize);x.isAnimating();n=[];tilesNeeded=false;for(var F=v;F--;)for(var G=F*d.tileSize+E.y,D=z;D--;){x=g.getTile(D+r.x,F+r.y);var M=D*d.tileSize+E.x,u=new TILE5.Vector(D-B.x,F-B.y);x||(o=g.getShiftDelta(r.x,
r.y,z,v));n.push({tile:x,coordinates:new TILE5.Vector(M,G),centerness:TILE5.V.absSize(u)})}n.sort(function(A,C){return C.centerness-A.centerness});b=TILE5.V.copy(t)}}d=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},d);var g=new TileStore(GRUNT.extend({onPopulate:function(){j=true;p.wakeParent()}},d)),h=Math.round(d.tileSize/2),c=d.tileSize?1/d.tileSize:0,b=null,j=false,k=true,n=[],l=false;new TILE5.Vector;var o=new TILE5.Vector,
m=g.getGridSize()*d.tileSize,p=GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{gridDimensions:new TILE5.Dimensions(m,m),cycle:function(){var r=0;if(o.x+o.y!==0){g.shift(o,d.shiftOrigin);o=new TILE5.Vector;r++}return r+j?1:0},deactivate:function(){k=false},drawTile:function(){return false},draw:function(r,t,v,x,z){if(k){var B=GRUNT.Log.getTraceTicks(),E=g.getTileShift(),F=t.x+E.x;E=t.y+E.y;var G=true;if(x!==TILE5.Graphics.DisplayState.PINCHZOOM){f(r,t,v,z);GRUNT.Log.trace("updated draw queue",B)}if(d.drawGrid)r.strokeStyle=
"rgba(50, 50, 50, 0.3)";r.beginPath();for(t=n.length;t--;){v=n[t].tile;z=n[t].coordinates.x-F;var D=n[t].coordinates.y-E;G=v?p.drawTile(r,v,z,D,x)&&G:false;d.drawGrid&&r.rect(z,D,d.tileSize,d.tileSize)}r.stroke();GRUNT.Log.trace("drawn tiles",B);G&&!l&&GRUNT.WaterCooler.say("tiles.drawn",{id:p.getId()});l=G;j=false}},getTileVirtualXY:function(r,t,v){r=g.getNormalizedPos(r,t);r=new TILE5.Vector(r.x*d.tileSize,r.y*d.tileSize);if(v){r.x+=h;r.y+=h}return r},populate:function(r){g.populate(r,function(){})}});
GRUNT.WaterCooler.listen("tile.loaded",function(){j=true;p.wakeParent()});return p},ImageTileGrid:function(d){function f(){GRUNT.WaterCooler.say("tile.loaded")}d=GRUNT.extend({},d);return GRUNT.extend(new i.TileGrid(d),{drawTile:function(g,h,c,b,j){var k=TILE5.Resources.getImage(h.url),n=false;j===TILE5.Graphics.DisplayState.PAN&&g.drawImage(q(),c,b);if(k&&k.complete&&k.width>0){g.drawImage(k,c,b);n=true}else{g.drawImage(s(),c,b);k||TILE5.Resources.loadImage(h.url,f)}return n}})},Tiler:function(d){d=
GRUNT.extend({container:"",drawCenter:false,onPan:null,onPanEnd:null,tapHandler:null,doubleTapHandler:null,zoomHandler:null,onDraw:null,datasources:{},tileLoadThreshold:"first"},d);var f=new TILE5.Graphics.View(GRUNT.extend({},d,{pannable:true,scalable:true,scaleDamping:true}));TILE5.Touch.captureTouch(document.getElementById(d.container),d);GRUNT.extend(f,{getTileLayer:function(){return f.getLayer("grid0")},setTileLayer:function(g){f.setLayer("grid0",g);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},
viewPixToGridPix:function(g){var h=f.getOffset();return new TILE5.Vector(g.x+h.x,g.y+h.y)},cleanup:function(){f.removeLayer("grid0")}});return f}};return i}();
TILE5.Geo=function(){function s(c,b){var j=null;for(var k in g)if(b){if(k==b&&g[k][c]){j=g[k];break}}else if(g[k][c]){j=g[k];break}return j}function q(c,b,j,k){var n=0;c=c.toUpperCase();for(var l in k){var o=b[l];if(o){var m=j[l];o=m?m(c,o):c.containsWord(o)?1:0;n+=o*k[l]}}return n}var a=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],e=Math.PI/180,i=180/Math.PI,d=null,f={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},g={},h={Engine:function(c){if(!c.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var b=GRUNT.extend({remove:function(){delete g[b.id]}},c);return g[b.id]=b},Radius:function(c,b){return{distance:parseInt(c,10),uom:b}},Position:function(c,b){return{lat:parseFloat(c?c:0),lon:parseFloat(b?b:0)}},BoundingBox:function(c,b){return{min:h.P.parse(c),max:h.P.parse(b)}},Address:function(c){return c=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},c)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var c={lat2pix:function(b,j){var k=parseFloat(b)*2*Math.PI/360;k=Math.sin(k);var n=0.08181919084262157*k;return Math.log((1+k)/(1-k)*Math.pow((1-n)/(1+n),0.08181919084262157))/2/j},lon2pix:function(b,j){return parseFloat(b)/180*Math.PI/j},pix2lon:function(b,j){return c.normalizeLon(b*j*180/Math.PI)},pix2lat:function(b,j){for(var k=Math.pow(Math.E,-b*j),n=c.mercatorUnproject(k),
l=c.findRadPhi(n,k),o=0;o<12&&Math.abs(n-l)>1.0E-7;){n=l;l=c.findRadPhi(n,k);o++}return l*180/Math.PI},mercatorUnproject:function(b){return Math.PI/2-2*Math.atan(b)},findRadPhi:function(b,j){var k=0.08181919084262157*Math.sin(b);return Math.PI/2-2*Math.atan(j*Math.pow((1-k)/(1+k),0.040909595421310785))},normalizeLon:function(b){for(;b<-180;)b+=360;for(;b>180;)b-=360;return b}};return c}(),GeoSearchResult:function(c){c=GRUNT.extend({id:null,caption:"",resultType:"",data:null,pos:null,matchWeight:0},
c);return GRUNT.extend(c,{toString:function(){return c.caption+(c.matchWeight?" ("+c.matchWeight+")":"")}})},GeoSearchAgent:function(c){c=GRUNT.extend({},c);return GRUNT.extend({},TILE5.Dispatcher.createAgent(c))},GeocodingAgent:function(c){c=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(b,j){try{if(!b.reverse&&!b.freeform)address=new h.Address(b);var k=h.getEngine("geocode");if(k)k.geocode({addresses:[b.freeform?b.freeform:address],complete:function(l,o){if(j){var m=
o;if(b.freeform)m=h.rankGeocodeResponses(b.freeform,m,h.getEngine("geocode"));j(m,c)}}})}catch(n){GRUNT.Log.exception(n)}}},c);return new h.GeoSearchAgent(c)},PointOfInterest:function(c){c=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},c);if(!c.pos&&c.lat&&c.lon)c.pos=new TILE5.Geo.Position(c.lat,c.lon);return GRUNT.extend({toString:function(){return c.id+": '"+c.title+"'"}},c)},POIStorage:function(c){function b(m){m=m?m:"default";n[m]||(n[m]=[]);return n[m]}function j(m){var p=
[];for(var r in n)for(var t=0;t<n[r].length;t++)if(!m||m(n[r][t]))p.push(n[r][t]);return p}function k(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:o.id,pois:o.getPOIs()})}c=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},c);var n={},l=true,o={id:GRUNT.generateObjectID(),getPOIs:function(){return j()},getOldPOIs:function(m,p){return j(function(r){return r.group==m&&r.retrieved<p})},getVisible:function(){return l},setVisible:function(m){if(m!=l){l=m;c.visibilityChange&&c.visibilityChange()}},
findById:function(m){var p=j(function(r){return r.id==m});return p.length>0?p[0]:null},findByBounds:function(m){return j(function(p){return TILE5.Geo.P.inBounds(p.pos,m)})},addPOIs:function(m,p){if(p)n={};for(var r=0;m&&r<m.length;r++){m[r].retrieved=TILE5.Clock.getTime(true);var t=m[r];b(t.group).push(t)}},removeGroup:function(m){if(n[m]){delete n[m];k()}},update:function(m){var p=[],r=0,t=m.length>0?m[0].group:"",v=TILE5.Clock.getTime(true);for(r=0;r<m.length;r++){var x;a:{if(x=m[r])for(var z=b(x.group),
B=0;B<z.length;B++)if(z[B].id==x.id){x=z[B];break a}x=null}if(x){x.retrieved=v;x.isNew=false}else p.push(m[r])}m=o.getOldPOIs(t,v);o.addPOIs(p);for(r=0;c.onPOIAdded&&r<p.length;r++)c.onPOIAdded(p[r]);for(r=0;r<m.length;r++){c.onPOIDeleted&&c.onPOIDeleted(m[r]);t=m[r];v=b(t.group);for(x=0;x<v.length;x++)if(v[x].id==t.id){v.splice(x,1);break}}p.length+m.length>0&&k()}};return o},MapProvider:function(){return{zoomLevel:0,checkZoomLevel:function(c){return c},getCopyright:function(){},getMapTiles:function(){},
getPositionForXY:function(){return null}}},P:function(){var c={calcDistance:function(b,j){if(c.empty(b)||c.empty(j))return 0;var k=(j.lat-b.lat).toRad()/2,n=(j.lon-b.lon).toRad()/2;k=Math.sin(k)*Math.sin(k)+Math.cos(b.lat.toRad())*Math.cos(j.lat.toRad())*Math.sin(n)*Math.sin(n);return 6371*2*Math.atan2(Math.sqrt(k),Math.sqrt(1-k))},copy:function(b){return b?new h.Position(b.lat,b.lon):null},empty:function(b){return!b||b.lat===0&&b.lon===0},equal:function(b,j){return b&&j&&b.lat==j.lat&&b.lon==j.lon},
almostEqual:function(b,j){return b&&j&&Math.floor(b.lat*1E3)===Math.floor(j.lat*1E3)&&Math.floor(b.lon*1E3)===Math.floor(j.lon*1E3)},inArray:function(b,j){for(var k=h.P.equal,n=j.length;n--;)if(k(b,j[n]))return true;return false},inBounds:function(b,j){var k=!(h.P.empty(b)||h.P.empty(j));return k=(k=k&&b.lat>=j.min.lat&&b.lat<=j.max.lat)&&b.lon>=j.min.lon&&b.lon<=j.max.lon},parse:function(b){if(b)if(typeof b.lat!=="undefined")return c.copy(b);else{if(b.split)for(var j=[" ",","],k=0;k<j.length;k++){var n=
b.split(j[k]);if(n.length===2)return new h.Position(n[0],n[1])}}else return new h.Position;return null},parseArray:function(b){var j=b.length,k=Array(j);for(j=j;j--;)k[j]=c.parse(b[j]);GRUNT.Log.info("parsed "+k.length+" positions");return k},fromMercatorPixels:function(b,j,k){return new h.Position(TILE5.Geo.Utilities.pix2lat(j,k),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(b,k)))},toMercatorPixels:function(b,j){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(b.lon,j),TILE5.Geo.Utilities.lat2pix(b.lat,
j))},generalize:function(b,j,k){var n=b.length,l=[],o=null;k||(k=250);k/=1E3;GRUNT.Log.info("generalizing positions, must include "+j.length+" positions");for(var m=n;m--;)if(m===0)l.unshift(b[m]);else{var p=!o||h.P.inArray(b[m],j)?k:h.P.calcDistance(o,b[m]);if(b[m]&&p>=k){l.unshift(b[m]);o=b[m]}}GRUNT.Log.info("generalized "+n+" positions into "+l.length+" positions");return l},toString:function(b){return b?b.lat+" "+b.lon:""}};return c}(),B:function(){var c=-(Math.PI/2),b=Math.PI/2,j=-Math.PI*2,
k=Math.PI*2,n={calcSize:function(l,o,m){var p=new TILE5.Vector(0,o.lat-l.lat);if(typeof m==="undefined")m=true;p.x=m&&l.lon>o.lon?360-l.lon+o.lon:o.lon-l.lon;return p},createBoundsFromCenter:function(l,o){var m=o/6371,p=l.lat*e,r=l.lon*e,t=p-m,v=p+m;GRUNT.Log.info("rad distance = "+m);GRUNT.Log.info("rad lat = "+p+", lon = "+r);GRUNT.Log.info("min lat = "+t+", max lat = "+v);if(t>c&&v<b){p=Math.asin(Math.sin(m)/Math.cos(p));m=r-p;if(m<j)m+=2*Math.PI;r=r+p;if(r>k)r-=2*Math.PI}else{t=Math.max(t,c);
v=Math.min(v,b);m=j;r=k}return new h.BoundingBox(new h.Position(t*i,m*i),new h.Position(v*i,r*i))},expand:function(l,o){return new h.BoundingBox(new h.Position(l.min.lat-o,l.min.lon-h.Utilities.normalizeLon(o)),new h.Position(l.max.lat+o,l.max.lon+h.Utilities.normalizeLon(o)))},forPositions:function(l,o){var m=null,p=TILE5.Clock.getTime();o||(o="auto");for(var r=l.length;r--;)if(m){var t=n.calcSize(m.min,l[r],false),v=n.calcSize(l[r],m.max,false);if(t.x<0)m.min.lon=l[r].lon;if(t.y<0)m.min.lat=l[r].lat;
if(v.x<0)m.max.lon=l[r].lon;if(v.y<0)m.max.lat=l[r].lat}else m=new TILE5.Geo.BoundingBox(l[r],l[r]);if(o){if(o=="auto"){r=n.calcSize(m.min,m.max);o=Math.max(r.x,r.y)*0.3}m=n.expand(m,o)}GRUNT.Log.trace("calculated bounds for "+l.length+" positions",p);return m},getCenter:function(l){var o=h.B.calcSize(l.min,l.max);return new TILE5.Geo.Position(l.min.lat+o.y/2,l.min.lon+o.x/2)},getZoomLevel:function(l,o){var m=n.getCenter(l);m=a[Math.min(Math.round(Math.abs(m.lat)*0.05),a.length)];var p=n.calcSize(l.min,
l.max);return Math.min(Math.ceil(Math.log(a[3]*o.height/p.y)/Math.log(2)),Math.ceil(Math.log(m*o.width/p.x)/Math.log(2)))},isEmpty:function(l){return!l||h.P.empty(l.min)||h.P.empty(l.max)},toString:function(l){return"min: "+h.P.toString(l.min)+", max: "+h.P.toString(l.max)}};return n}(),A:function(){var c=/^(\d+).*$/,b=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(j,k){c.lastIndex=-1;if(c.test(j))for(var n=j.replace(c,"$1"),l=k.split(","),o=0;o<l.length;o++){b.lastIndex=-1;if(b.test(l[o])){var m=
b.exec(l[o]);if(n>=parseInt(m[1],10)&&n<=parseInt(m[2],10))return true}else if(n==l[o])return true}return false},normalize:function(j){if(!j)return"";j=j.toUpperCase();if(!d){var k=[];for(var n in f)k.push(n);d=RegExp("(\\s)("+k.join("|")+")(\\s|$)","i")}d.lastIndex=-1;if(k=d.exec(j))j=j.replace(d,"$1"+f[k[2]]);return j},toString:function(j){return j.streetDetails+" "+j.location}}}(),getEngine:function(c){for(var b=null,j=1;!b&&j<arguments.length;j++)b=s(c,arguments[j]);b=b?b:s(c);if(!b)throw Error("Unable to find GEO engine with "+
c+" capability");return b},rankGeocodeResponses:function(c,b,j){var k=[],n=h.AddressCompareFns;if(j&&j.compareFns)n=GRUNT.extend({},n,j.compareFns);for(j=0;j<b.length;j++)k.push(new h.GeoSearchResult({caption:b[j].toString(),data:b[j],pos:b[j].pos,matchWeight:q(c,b[j],n,h.GeocodeFieldWeights)}));k.sort(function(l,o){return o.matchWeight-l.matchWeight});return k}};return h}();
TILE5.Geo.Location=function(){function s(e){function i(b){try{var j=new TILE5.Geo.Position(b.coords.latitude,b.coords.longitude),k=GRUNT.isPlainObject(b.coords.accuracy)&&b.coords.accuracy.horizontal?b.coords.accuracy.horizontal:b.coords.accuracy;GRUNT.Log.info("got position coordinates: "+j+", accuracy = "+k);if(e.successCallback&&(!h||k<c))e.successCallback(j,g,b);if(k>e.highAccuracyCutoff&&g<2){g=2;e.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");
f()}h=b;c=k}catch(n){GRUNT.Log.exception(n)}}function d(b){if(b.code===b.PERMISSION_DENIED)e.errorCallback&&e.errorCallback(b);else if(b.code===b.POSITION_UNAVAILABLE)e.errorCallback&&e.errorCallback(b);else if(b.code===b.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(e.timeout===0&&e.autoPhasing){g=1;e.timeout=q;e.enableHighAccuracy=false;f()}}}function f(){navigator.geolocation.getCurrentPosition(i,d,e)}e=GRUNT.extend({autoPhasing:true,maximumAge:3E5,timeout:0,
highAccuracyCutoff:10,enableHighAccuracy:true,successCallback:null,errorCallback:null},e);var g=0,h=null,c=1E6;f()}var q=3E3,a={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)a.get=s;return a}();TILE5.Geo.Search=function(){return{bestResults:function(s,q){q||(q=20);for(var a=s.length>0?s[0]:null,e=[],i=0;i<s.length;i++)if(a.matchWeight-s[i].matchWeight<=q)e.push(s[i]);else break;return e}}}();
TILE5.Geo.Routing=function(){var s={calculate:function(q){q=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},q);GRUNT.Log.info("attempting to calculate route");var a=TILE5.Geo.getEngine("route");a&&a.route(q,function(e){if(q.generalize)e.geometry=TILE5.Geo.P.generalize(e.geometry,e.getInstructionPositions());if(q.map){s.createMapOverlay(q.map,e);if(q.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+e.boundingBox);q.map.gotoBounds(e.boundingBox)}}q.success&&
q.success(e)})},createMapOverlay:function(q,a){var e=q.getDimensions();e=new TILE5.Geo.UI.RouteOverlay({data:a,width:e.width,height:e.height});q.setLayer("route",e)},Maneuver:{None:0,Continue:1,TurnLeft:100,TurnLeftSlight:101,TurnLeftSharp:102,TurnRight:110,TurnRightSlight:111,TurnRightSharp:112,TurnAround:190,EnterRoundabout:200,ExitRamp:300},Instruction:function(q){q=GRUNT.extend({position:null,description:"",manuever:s.Maneuver.None},q);return GRUNT.extend(q,{})},RouteData:function(q){q=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},q);if(!q.boundingBox)q.boundingBox=TILE5.Geo.B.forPositions(q.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var a=[],e=0;e<q.instructions.length;e++)q.instructions[e].position&&a.push(q.instructions[e].position);return a}},q)}};return s}();
TILE5.Geo.UI=function(){var s=0,q={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,radsPerPixel:0},a);var e=TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),i=e.x-a.centerXY.x,d=e.y-a.centerXY.y,f=GRUNT.extend({},a.grid,{getBoundingBox:function(g,h,c,b){return new TILE5.Geo.BoundingBox(f.pixelsToPos(new TILE5.Vector(g,h+b)),f.pixelsToPos(new TILE5.Vector(g+c,h)))},getCenterOffset:function(){return a.centerXY},
getGridXYForPosition:function(g){g=TILE5.Geo.P.toMercatorPixels(g,a.radsPerPixel);return new TILE5.Vector(g.x-i,f.gridDimensions.height-(g.y-d))},getGuideOffset:function(g){var h=f.tileSize;return new TILE5.Vector(g.x%h,g.y%h)},pixelsToPos:function(g){return TILE5.Geo.P.fromMercatorPixels(i+g.x,d+f.gridDimensions.height-g.y,a.radsPerPixel)}});return f},POIViewLayer:function(a){GRUNT.extend({},a)},Overlay:function(a){GRUNT.extend({},a);return{}},RadarOverlay:function(a){a=GRUNT.extend({radarFill:"rgba(0, 221, 238, 0.1)",
radarStroke:"rgba(0, 102, 136, 0.3)",zindex:100},a);return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(e,i,d){i=d.width>>1;d=d.height>>1;e.fillStyle=a.radarFill;e.strokeStyle=a.radarStroke;e.beginPath();e.arc(i,d,50,0,Math.PI*2,false);e.fill();e.stroke()}})},CrosshairOverlay:function(a){a=GRUNT.extend({lineWidth:1.5,strokeStyle:"rgba(0, 0, 0, 0.5)",size:15,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},
a);var e=null,i=function(){var d=document.createElement("canvas");d.width=a.size*2;d.height=a.size*2;var f=d.getContext("2d"),g=new TILE5.Vector(a.size,a.size),h=a.size;f.lineWidth=a.lineWidth;f.strokeStyle=a.strokeStyle;f.beginPath();f.moveTo(g.x,g.y-h);f.lineTo(g.x,g.y+h);f.moveTo(g.x-h,g.y);f.lineTo(g.x+h,g.y);f.arc(g.x,g.y,h*0.6666,0,2*Math.PI,false);f.stroke();return d}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(d,f,g){e||(e=TILE5.D.getCenter(g));d.drawImage(i,e.x-a.size,
e.y-a.size)}})},RouteOverlay:function(a){a=GRUNT.extend({strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,zindex:50},a);var e=true,i=null,d=[],f=0,g=[],h=[],c=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(b,j,k,n){if(e)return null;var l="routeAnimation"+s++;h.push(l);return new TILE5.Graphics.AnimatedPathLayer({id:l,path:d,zindex:a.zindex+1,easing:b?b:TILE5.Animation.Easing.Sine.InOut,
duration:j?j:5E3,drawIndicator:k,autoCenter:n?n:false})},draw:function(b,j,k,n,l){k=0;n=a.data?a.data.geometry:null;if(e){e=false;i=null;d=[];f=0}if(n&&f<n.length){a:{l=l.getTileLayer();g=[];n=GRUNT.Log.getTraceTicks();var o,m,p,r=a.data?a.data.geometry:[],t=r.length,v=a.data?a.data.instructions:[],x=v.length,z=a.calculationsPerCycle,B=0;for(o=f;o<t;o++){m=l.getGridXYForPosition(r[o]);if(p=!i||o===0||Math.abs(m.x-i.x)+Math.abs(m.y-i.y)>a.pixelGeneralization){d.push(m);i=m}B++;if(B>=z){f=o;break a}}f=
t;GRUNT.Log.trace(t+" geometry points generalized to "+d.length+" coordinates",n);i=null;for(o=x;o--;)if(v[o].position){m=l.getGridXYForPosition(v[o].position);if(p=!i||o===0||Math.abs(m.x-i.x)+Math.abs(m.y-i.y)>a.pixelGeneralization){g.push(m);i=m}}}k++}l=d.length;if(l>0&&(!k||a.partialDraw)){b.strokeStyle=a.strokeStyle;b.lineWidth=a.lineWidth;b.beginPath();b.moveTo(d[l-1].x-j.x,d[l-1].y-j.y);for(l=l;l--;)b.lineTo(d[l].x-j.x,d[l].y-j.y);b.stroke();b.fillStyle=a.waypointFillStyle;for(l=g.length;l--;){b.beginPath();
b.arc(g[l].x-j.x,g[l].y-j.y,2,0,Math.PI*2,false);b.stroke();b.fill()}}return k}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var b=h.length;b--;)GRUNT.WaterCooler.say("layer.remove",{id:h[b]});h=[];e=true;c.wakeParent()});return c},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:q.AnnotationTween,animationSpeed:null},a);var e=false,i={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return e},draw:function(d,f,g,h){if(i.xy){if(i.isNew&&a.tweenIn){var c=i.xy.y;
i.xy.y=f.y-20;e=true;TILE5.Animation.tween(i.xy,"y",c,a.tweenIn,function(){i.xy.y=c;e=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(d,f,new TILE5.Vector(i.xy.x-f.x,i.xy.y-f.y),g,h);else{d.beginPath();d.arc(i.xy.x-f.x,i.xy.y-f.y,4,0,Math.PI*2,false);d.fill()}i.isNew=false}}};return i},ImageAnnotation:function(a){a=GRUNT.extend({imageUrl:null,animatingImageUrl:null,imageAnchor:null},a);var e=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;a.draw=function(d,f,g,h,
c){if(a.animatingImageUrl&&i.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);h=a.animatingImageUrl}else h=a.imageUrl;if(f=TILE5.Resources.getImage(h)){if(f.complete&&f.width>0){e||(e=new TILE5.Vector(-f.width>>1,-f.height>>1));g=TILE5.V.offset(g,e.x,e.y);d.drawImage(f,g.x,g.y,f.width,f.height)}}else TILE5.Resources.loadImage(h,function(){c.wakeParent()})};var i=new q.Annotation(a);return i},AnnotationsOverlay:function(a){function e(h){for(var c=a.map?a.map.getTileLayer():null,b=0;c&&b<h.length;b++)h[b].xy=
c.getGridXYForPosition(h[b].pos)}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var i=[],d=false,f=[],g=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(h,c,b,j){h.save();try{var k;d=false;h.fillStyle="rgba(255, 0, 0, 0.75)";h.globalCompositeOperation="source-over";for(k=i.length;k--;){i[k].draw(h,c,j,g);d=d||i[k].isAnimating()}for(k=f.length;k--;){f[k].draw(h,c,j,g);d=d||f[k].isAnimating()}}finally{h.restore()}return d?1:0},add:function(h){f.push(h);e(f);
g.wakeParent()},clear:function(h){f=[];e(f);if(h){i=[];e(i)}g.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(h){if(a.pois&&a.pois.id==h.srcID){h=h.pois;try{i=[];for(var c=0;c<h.length;c++)if(h[c].pos){var b;var j=h[c];if(j&&j.pos){var k=null;if(k=a.createAnnotationForPOI?a.createAnnotationForPOI(j):new q.Annotation({pos:j.pos})){k.isNew=j.isNew;j.isNew=false}b=k}else b=void 0;b&&i.push(b)}e(i)}catch(n){GRUNT.Log.exception(n)}g.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",
function(){e(i);e(f);g.wakeParent()});return g},Tiler:function(a){a=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,copyright:undefined,zoomLevel:0,boundsChange:null,tapPOI:null,tapHandler:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,onTilesLoaded:null},a);if(typeof a.copyright==="undefined")a.copyright=a.provider?a.provider.getCopyright():"";var e=new TILE5.Vector,i=a.copyright,d=false,f=[],g=0,h=null,c=null,b=a.zoomLevel,j=a.tapHandler;if(!a.provider)a.provider=
new TILE5.Geo.MapProvider;var k=new TILE5.Tiling.Tiler(GRUNT.extend({},a,{tapHandler:function(l,o){var m=n.getTileLayer(),p=null;if(m){p=n.viewPixToGridPix(new TILE5.Vector(o.x,o.y));var r=m.pixelsToPos(p),t=m.pixelsToPos(TILE5.V.offset(p,-a.tapExtent,a.tapExtent)),v=m.pixelsToPos(TILE5.V.offset(p,a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(m.pixelsToPos(p)));p=new TILE5.Geo.BoundingBox(t,v);f=n.pois.findByBounds(p);a.tapPOI&&a.tapPOI(f)}j&&j(l,o,r,p)},doubleTapHandler:function(l,
o){n.animate(2,TILE5.D.getCenter(n.getDimensions()),new TILE5.Vector(o.x,o.y),TILE5.Animation.Easing.Sine.Out)},onScale:function(l,o){var m=0;l=Math.sqrt(l);if(l<1)m=-(0.5/l);else if(l>1)m=l;n.gotoPosition(n.getXYPosition(o),b+Math.floor(m))}})),n=GRUNT.extend({},k,{pois:a.pois,annotations:null,getBoundingBox:function(){var l=new TILE5.Geo.BoundingBox,o=n.getTileLayer(),m=n.getOffset(),p=n.getDimensions();if(o)l=o.getBoundingBox(m.x,m.y,p.width,p.height);return l},getCenterPosition:function(){return n.getXYPosition(TILE5.D.getCenter(n.gridDimensions))},
getXYPosition:function(l){return n.getTileLayer().pixelsToPos(n.viewPixToGridPix(l))},gotoBounds:function(l,o){var m=TILE5.Geo.B.getZoomLevel(l,n.getDimensions());n.gotoPosition(TILE5.Geo.B.getCenter(l),m,o)},gotoCurrentPosition:function(l){TILE5.Geo.Location.get({successCallback:function(o){n.clearBackground();n.gotoPosition(o,15,l)},errorCallback:function(){}})},gotoPosition:function(l,o,m){var p=b,r=(new Date).getTime();b=o?o:b;if(!b)throw"Zoom level required to goto a position.";if(a.provider)b=
a.provider.checkZoomLevel(b);if(!d||b!==p){TILE5.Resources.resetImageLoadQueue();(o=n.getTileLayer())&&o.deactivate();TILE5.Animation.cancel();d&&n.freeze();g=r;a.provider.zoomLevel=b;a.provider.getMapTiles(n,l,function(t){if(r===g){n.setTileLayer(t);c=t.getId();n.panToPosition(l,function(){n.unfreeze();m&&m()})}else GRUNT.Log.info("request time mismatch - ignoring update")});d=true}else n.panToPosition(l,m)},panToPosition:function(l,o,m){var p=n.getTileLayer();if(p){l=p.getGridXYForPosition(l);p=
n.getDimensions();l.x-=p.width/2;l.y-=p.height/2;if(h)h=null;n.updateOffset(l.x,l.y,m);GRUNT.WaterCooler.say("view.wake",{id:n.id});a.boundsChange&&a.boundsChange(n.getBoundingBox());o&&o(n)}},setZoomLevel:function(l){n.gotoPosition(n.getCenterPosition(),l)},zoomIn:function(){n.scale(2,TILE5.Animation.Easing.Sine.Out)||n.setZoomLevel(b+1)},zoomOut:function(){n.scale(0.5,TILE5.Animation.Easing.Sine.Out)||n.setZoomLevel(b-1)},animateRoute:function(l,o,m,p){var r=n.getLayer("route");if(r)(l=r.getAnimation(l,
o,m,p))&&l.addToView(n)}},k);k=new TILE5.Geo.UI.AnnotationsOverlay({pois:n.pois,map:n,createAnnotationForPOI:a.createAnnotationForPOI});n.annotations=k;n.setLayer("annotations",k);a.crosshair&&n.setLayer("crosshair",new TILE5.Geo.UI.CrosshairOverlay);i&&n.setLayer("copyright",new TILE5.Graphics.ViewLayer({zindex:999,draw:function(l,o,m){l.lineWidth=2.5;l.fillStyle="rgb(50, 50, 50)";l.strokeStyle="rgba(255, 255, 255, 0.8)";l.font="bold 10px sans";l.textBaseline="bottom";l.strokeText(i,10,m.height-
10);l.fillText(i,10,m.height-10)}}));GRUNT.WaterCooler.listen("view.idle",function(l){if(l.id&&l.id==n.id)if(TILE5.V.absSize(TILE5.V.diff(e,n.getOffset()))>a.boundsChangeThreshold&&a.boundsChange){e=n.getOffset();a.boundsChange(n.getBoundingBox())}});GRUNT.WaterCooler.listen("tiles.drawn",function(l){l.id&&l.id==c&&a.onTilesLoaded&&a.onTilesLoaded()});return n}};return q}();
