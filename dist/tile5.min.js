if(!this.JSON)this.JSON={};
(function(){function v(b){return b<10?"0"+b:b}function r(b){l.lastIndex=0;return l.test(b)?'"'+b.replace(l,function(f){var g=h[f];return typeof g==="string"?g:"\\u"+("0000"+f.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+b+'"'}function n(b,f){var g,m,s,q,p=d,o,u=f[b];if(u&&typeof u==="object"&&typeof u.toJSON==="function")u=u.toJSON(b);if(typeof k==="function")u=k.call(f,b,u);switch(typeof u){case "string":return r(u);case "number":return isFinite(u)?String(u):"null";case "boolean":case "null":return String(u);
case "object":if(!u)return"null";d+=e;o=[];if(Object.prototype.toString.apply(u)==="[object Array]"){q=u.length;for(g=0;g<q;g+=1)o[g]=n(g,u)||"null";s=o.length===0?"[]":d?"[\n"+d+o.join(",\n"+d)+"\n"+p+"]":"["+o.join(",")+"]";d=p;return s}if(k&&typeof k==="object"){q=k.length;for(g=0;g<q;g+=1){m=k[g];if(typeof m==="string")if(s=n(m,u))o.push(r(m)+(d?": ":":")+s)}}else for(m in u)if(Object.hasOwnProperty.call(u,m))if(s=n(m,u))o.push(r(m)+(d?": ":":")+s);s=o.length===0?"{}":d?"{\n"+d+o.join(",\n"+d)+
"\n"+p+"}":"{"+o.join(",")+"}";d=p;return s}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+v(this.getUTCMonth()+1)+"-"+v(this.getUTCDate())+"T"+v(this.getUTCHours())+":"+v(this.getUTCMinutes())+":"+v(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var a=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
l=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,d,e,h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},k;if(typeof JSON.stringify!=="function")JSON.stringify=function(b,f,g){var m;e=d="";if(typeof g==="number")for(m=0;m<g;m+=1)e+=" ";else if(typeof g==="string")e=g;if((k=f)&&typeof f!=="function"&&(typeof f!=="object"||typeof f.length!=="number"))throw Error("JSON.stringify");return n("",
{"":b})};if(typeof JSON.parse!=="function")JSON.parse=function(b,f){function g(s,q){var p,o,u=s[q];if(u&&typeof u==="object")for(p in u)if(Object.hasOwnProperty.call(u,p)){o=g(u,p);if(o!==undefined)u[p]=o;else delete u[p]}return f.call(s,q,u)}var m;b=String(b);a.lastIndex=0;if(a.test(b))b=b.replace(a,function(s){return"\\u"+("0000"+s.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(b.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){m=eval("("+b+")");return typeof f==="function"?g({"":m},""):m}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(v){if(arguments.length<=1)return v;for(var r=arguments.length-2,n=0;n<=r;n++)v=v.replace(RegExp("\\{"+n+"\\}","gi"),arguments[n+1]);return v};
String.prototype.containsWord=function(v){var r="";if(v.toString)v=v.toString();for(var n=0;n<v.length;n++)r+=!/\w/.test(v[n])?"\\"+v[n]:v[n];return RegExp("(^|\\s|\\,)"+r+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var v=Object.prototype.hasOwnProperty,r=0,n={id:"GRUNT.core",extend:function(){var a=arguments[0]||{},l=1,d=arguments.length,e=false,h,k,b,f;if(typeof a==="boolean"){e=a;a=arguments[1]||{};l=2}if(typeof a!=="object"&&!n.isFunction(a))a={};if(d===l){a=this;--l}for(;l<d;l++)if((h=arguments[l])!=null)for(k in h){b=a[k];f=h[k];if(a!==f)if(e&&f&&(n.isPlainObject(f)||n.isArray(f))){b=b&&(n.isPlainObject(b)||n.isArray(b))?b:n.isArray(f)?[]:{};a[k]=n.extend(e,b,f)}else if(f!==undefined)a[k]=
f}return a},isFunction:function(a){return toString.call(a)==="[object Function]"},isArray:function(a){return toString.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||toString.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!v.call(a,"constructor")&&!v.call(a.constructor.prototype,"isPrototypeOf"))return false;var l;for(l in a);return l===undefined||v.call(a,l)},isEmptyObject:function(a){for(var l in a)return false;return true},isXmlDocument:function(a){return toString.call(a)===
"[object Document]"},contains:function(a,l){var d=a,e=arguments,h=1;if(l&&n.isArray(l)){e=l;h=0}for(h=h;h<e;h++)d=d&&typeof foo[e[h]]!=="undefined";return d},newModule:function(a){a=n.extend({id:null,requires:[],parent:null},a);if(a.parent)a=n.extend({},a.parent,a);return a},toID:function(a){return a.replace(/\s/g,"-")},generateObjectID:function(a){return(a?a:"obj")+r++}};return n}();
GRUNT.Log=function(){function v(d,e){var h,k=e&&e.length>0?e[0]:"";for(h=1;e&&h<e.length;h++)k+=" "+(n&&GRUNT.isPlainObject(e[h])?JSON.stringify(e[h]):e[h]);typeof console!=="undefined"&&console[d](k);for(h=0;h<r.length;h++)r[h].call(l,k,d)}var r=[],n=typeof JSON!=="undefined",a=window.console&&window.console.markTimeline,l={id:"GRUNT.log",getTraceTicks:function(){return a?(new Date).getTime():null},trace:function(d,e){if(a)console.markTimeline(d+(e?": "+(l.getTraceTicks()-e)+"ms":""))},debug:function(){v("debug",
arguments)},info:function(){v("info",arguments)},warn:function(){v("warn",arguments)},error:function(){v("error",arguments)},exception:function(d){l.error(arguments);for(var e in d)l.info("ERROR DETAIL: "+e+": "+d[e])},watch:function(d,e){try{e()}catch(h){l.exception(h,d)}},throwError:function(d){l.error(d);throw Error(d);},requestUpdates:function(d){r.push(d)}};return l}();
GRUNT.Data=function(){var v={determineObjectMapping:function(n){if(!n)return null;n=n.split("|");for(var a={},l=0;l<n.length;l++)a[n[l]]=l;return a},mapLineToObject:function(n,a){var l=n.split("|"),d={};for(var e in a){var h=a[e];d[e]=l.length>h?l[h]:null}return d},parse:function(n){var a=null,l=[];n=n.split("\n");for(var d=0;d<n.length;d++){var e=n[d];if(a)l.push(v.mapLineToObject(e,a));else a=v.determineObjectMapping(e)}return l}},r={supportedFormats:{JSON:{parse:function(n){return JSON.parse(n)}},
PDON:{parse:function(n){return v.parse(n)}}},parse:function(n){n=GRUNT.extend({data:"",format:"JSON"},n);if(!r.supportedFormats[n.format])throw Error("Unsupported data format: "+n.format+", cannot parse data in javascript object");try{return r.supportedFormats[n.format].parse(n.data)}catch(a){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+n.format,n.data);GRUNT.Log.exception(a)}return{}}};return r}();
GRUNT.Template=function(){var v=/\$\{(.*?)\}/ig;return{parse:function(r,n){for(var a=r,l=v.exec(a);l;){a=a.replace(l[0],GRUNT.XPath.first(l[1],n));v.lastIndex=0;l=v.exec(a)}return a}}}();
GRUNT.JSONP=function(){function v(l){var d=document.createElement("script"),e=false;d.src=l;d.async=true;d.onload=d.onreadystatechange=function(){if(!e&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){e=true;d.onload=d.onreadystatechange=null;d&&d.parentNode&&d.parentNode.removeChild(d)}};n||(n=document.getElementsByTagName("head")[0]);n.appendChild(d)}var r=0,n,a=this;return{get:function(l,d){l+=l.indexOf("?")>=0?"&":"?";var e="json"+ ++r;a[e]=function(h){d(h);a[e]=
null;try{delete a[e]}catch(k){}};v(l+"callback="+e);return e}}}();
GRUNT.XHR=function(){var v={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},r={JSON:["json"],PDON:["pdon.txt"]},n=["TEXT","STREAM"],a=/^(\w+:)?\/\/([^\/?#]+)/,l={XML:function(h){return h.responseXML},JSON:function(h){try{return JSON.parse(h.responseText)}catch(k){GRUNT.Log.error("Error parsing JSON data: ",h.responseText);GRUNT.Log.exception(k)}return""},PDON:function(h){return GRUNT.Data.parse({data:h.responseText,format:"PDON"})},DEFAULT:function(h){return h.responseText}},
d={CONTENT_TYPE:"Content-Type"},e=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(h){try{h=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},e.ajaxSettings,h);var k=a.exec(h.url),b=k&&(k[1]&&k[1]!==location.protocol||k[2]!==location.host);if(h.data)h.method="POST";if(h.url){k=null;if(h.xhr)k=h.xhr(h);k||(k=new XMLHttpRequest);k.open(h.method,h.url,h.async);h.data&&k.setRequestHeader("Content-Type",
h.contentType);b||k.setRequestHeader("X-Requested-With","XMLHttpRequest");k.onreadystatechange=function(){if(this.readyState===4){var g=null,m=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(m)if(h.handleResponse)h.handleResponse(this);else{var s=h,q=this.getResponseHeader(d.CONTENT_TYPE),p,o=false;for(p in v)if(q&&q.indexOf(v[p])>=0){o=true;break}q=!o;for(o=0;o<n.length;o++)q=q||n[o]==p;if(q)b:{q=p;for(var u in r)for(o=
0;o<r[u].length;o++)if(RegExp(r[u][o]+"$","i").test(s.url)){p=u;break b}p=q?q:"DEFAULT"}try{g=l[p](this,s)}catch(t){GRUNT.Log.warn("error applying processor '"+p+"' to response type, falling back to default");g=l.DEFAULT(this,s)}}else h.error&&h.error(this)}catch(w){GRUNT.Log.exception(w,"PROCESSING AJAX RESPONSE")}m&&g&&h.success&&h.success.call(this,g)}};k.send(h.method=="POST"?e.param(h.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(f){GRUNT.Log.exception(f)}},
param:function(h){var k=[],b=function(g,m){m=GRUNT.isFunction(m)?m():m;k[k.length]=encodeURIComponent(g)+"="+encodeURIComponent(m)};if(GRUNT.isArray(h))for(var f=0;f<h.length;f++)b(h[f].name,h[f].value);else for(f in h)b(f,h[f]);return k.join("&").replace(/%20/g,"+")}});return e}();
GRUNT.XPath=function(){function v(l){for(var d=null,e=0;e<r.length;e++)if(d=r[e](l))break;return d}var r=[],n=[null,function(l){return l.numberValue},function(l){return l.stringValue},function(l){return l.booleanValue},null,null,null,null,function(l){return l.singleNodeValue?l.singleNodeValue.textContent:null},function(l){return l.singleNodeValue?l.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var a={SearchResult:function(l){return{toString:function(){var d=
null;if(l){var e=null;if(l.resultType>=0&&l.resultType<n.length)e=n[l.resultType];if(e){GRUNT.Log.info("invoking match handler for result type: "+l.resultType);d=e(l)}}return d?d:""}}},first:function(l,d){var e=a.SearchResult,h;var k=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!k)k=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(d))h=d.evaluate(l,d,v,k,null);else{GRUNT.Log.warn("attempted xpath expression: "+l+" on a non-xml document");h=null}}catch(b){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
l+" on node: "+d);h=null}return new e(h)},registerResolver:function(l){r.push(l)}};return a}();GRUNT.WaterCooler=function(){var v={},r=[];return{addPipe:function(n){n("pipe.test",{});r.push(n)},listen:function(n,a){v[n]||(v[n]=[]);a&&v[n].push(a)},say:function(n,a){var l;for(l=r.length;l--;)r[l](n,a);if(v[n])for(l=v[n].length;l--;)v[n][l](a)},leave:function(){}}}();
TILE5=function(){var v={Settings:function(){var r={};return{get:function(n){return r[n]},set:function(n,a){r[n]=a},extend:function(n){GRUNT.extend(r,n)}}}(),Clock:function(){var r=null;return{getTime:function(n){return n&&r?r:r=(new Date).getTime()}}}(),Vector:function(r,n){return{x:r?r:0,y:n?n:0}},V:function(){function r(n){if(!n||n.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var a={edges:Array(n.length-1),accrued:Array(n.length-1),total:0},
l=TILE5.V.diff,d=0;d<n.length-1;d++){var e=l(n[d],n[d+1]);a.edges[d]=Math.sqrt(e.x*e.x+e.y*e.y);a.accrued[d]=a.total+a.edges[d];a.total+=a.edges[d]}return a}return{create:function(n,a){return new v.Vector(n,a)},add:function(){for(var n=new v.Vector,a=arguments.length;a--;){n.x+=arguments[a].x;n.y+=arguments[a].y}return n},absSize:function(n){return Math.max(Math.abs(n.x),Math.abs(n.y))},diff:function(n,a){return new v.Vector(n.x-a.x,n.y-a.y)},copy:function(n){return n?new v.Vector(n.x,n.y):null},
invert:function(n){return new TILE5.Vector(-n.x,-n.y)},offset:function(n,a,l){return new TILE5.Vector(n.x+a,n.y+(l?l:a))},edges:r,distance:function(n){return r(n).total},theta:function(n,a,l){l=Math.asin((n.y-a.y)/l);return n.x>a.x?l:Math.PI-l},pointOnEdge:function(n,a,l,d){a=new TILE5.Vector(Math.cos(l)*d,Math.sin(l)*d);return new TILE5.Vector(n.x-a.x,n.y-a.y)},getRect:function(n){var a=n.length;if(a>1)return new TILE5.Rect(Math.min(n[0].x,n[a-1].x),Math.min(n[0].y,n[a-1].y),Math.abs(n[0].x-n[a-
1].x),Math.abs(n[0].y-n[a-1].y))}}}(),Dimensions:function(r,n){return{width:r?r:0,height:n?n:0}},D:function(){return{getAspectRatio:function(r){return r.height!==0?r.width/r.height:1},getCenter:function(r){return new v.Vector(r.width/2,r.height/2)},getSize:function(r){return Math.sqrt(Math.pow(r.width,2)+Math.pow(r.height,2))}}}(),Rect:function(r,n,a,l){return{origin:new v.Vector(r,n),dimensions:new v.Dimensions(a,l)}},R:function(){return{copy:function(r){return r?new v.Rect(r.origin.x,r.origin.y,
r.dimensions.width,r.dimensions.height):null},getCenter:function(r){return new TILE5.Vector(r.origin.x+r.dimensions.width/2,r.origin.y+r.dimensions.height/2)}}}()};return v}();
TILE5.Device=function(){function v(){for(;f.length>0;){var m=f.shift();document.location=m}b=0}function r(m){for(var s=true,q=g.length;q--;)s=s&&m!=g[q];return s}function n(m,s){var q=[];for(var p in s)p&&q.push(p+"="+escape(s[p]));return"tile5://"+m+"/"+(q.length>0?"?"+q.join("&"):"")}function a(m,s){r(m)&&GRUNT.Log.info("would push url: "+n(m,s))}function l(m,s){if(r(m)){f.push(n(m,s));b||(b=setTimeout(v,100))}}function d(){e={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:4,requireFastDraw:false,bridgeNotify:a,targetFps:25},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true,bridgeNotify:l,targetFps:10},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:l},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:l},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,supportsTouch:true,
getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:l},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:l}};h=[e.froyo,e.android,e.ipod,e.iphone,e.ipad]}var e=null,h=[],k=null,b=0,f=[],g=["view.wake","tile.loaded"];return{getConfig:function(){e||d();if(!k){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var m=0;m<h.length;m++){var s=h[m];if(s.regex&&s.regex.test(navigator.userAgent)){k=GRUNT.extend({},
e.base,s);GRUNT.Log.info("PLATFORM DETECTED AS: "+k.name);break}}if(!k){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");k=e.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return k}}}();
TILE5.Resources=function(){var v="",r={},n=function(){function l(){var t=b[this.id];if(t){t.loaded=true;t.hitCount=1;for(var w=m.length;w--;)if(m[w].image.src==this.src){m.splice(w,1);break}t.loadCallback&&t.loadCallback(this,false);s.push({url:this.src,created:t.requested});delete b[this.id];d()}}function d(){for(var t=TILE5.Device.getConfig().maxImageLoads;g.length>0&&(!t||m.length<t);){var w=g.shift();if(w.imageLoader){m.push(w);w.imageLoader(w,l)}}}function e(t){for(var w=null,y=q.length;y--&&
!w;)w=q[y](t);return w?w:function(x,B){x.image.onload=B;x.image.src=a.getPath(x.url);x.requested=(new Date).getTime()}}function h(){o=true;try{var t=Math.floor(s.length/2);if(t>0){s.sort(function(y,x){return y.created-x.created});for(var w=t;w--;)delete k[s[w].url];s.splice(0,t)}}finally{o=false}GRUNT.WaterCooler.say("imagecache.cleared")}var k={},b={},f=0,g=[],m=[],s=[],q=[],p=0,o=false,u={loadingImages:m,queuedImages:g,addInterceptor:function(t){q.push(t)},getCacheFullness:function(){return p},
getImage:function(t){var w=null;o||(w=k[t]);return w?w.image:null},loadImage:function(t,w){var y=k[t];if(y){y.hitCount++;y.image.complete&&w&&w(y.image,true)}else{y={url:t,image:new Image,loaded:false,imageLoader:e(t),created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:w};y.image.id="resourceLoaderImage"+f++;k[t]=y;b[y.image.id]=y;g.push(y);d()}return y},resetLoadingQueue:function(){m=[]}};setInterval(function(){for(var t=(new Date).getTime(),w=false,y=0,x=TILE5.Device.getConfig();y<
m.length;)if(t-m[y].requested>a.loadTimeout*1E3){m.splice(y,1);w=true}else y++;w&&d();if(x&&x.imageCacheMaxSize){p=s.length*a.avgImageSize/x.imageCacheMaxSize;p>=1&&h()}},1E3);return u}(),a={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(l,d){for(var e=(l?l.replace(/^.*\?/,""):"").split("&"),h=l?l.replace(/\?.*$/,"?"):"",k=0;k<e.length;k++){var b=e[k].split("=");if(!d||!d.test(b[0]))h+=e[k]+"&"}return h.replace(/\W/g,
"")},isValidCacheKey:function(l){GRUNT.Log.info("cache key = "+l);return false}}}(),addInterceptor:n.addInterceptor,getPath:function(l){return/^(file|https?|\/)/.test(l)?l:v+l},setBasePath:function(l){v=l},getImage:function(l){return n.getImage(l)},loadImage:function(l,d){n.loadImage(l,d)},resetImageLoadQueue:function(){n.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:n.loadingImages.length,queuedImageCount:n.queuedImages.length,imageCacheFullness:n.getCacheFullness()}},loadResource:function(l){l=
GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},l);var d=function(e){l.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){l.callback(e)})};l.cacheable&&r[l.filename]?d(r[l.filename]):GRUNT.XHR.ajax({url:a.getPath(l.filename),dataType:l.dataType,success:function(e){if(l.cacheable)r[l.filename]=e;d(e)},error:function(e,h,k){GRUNT.Log.error("error loading resource ["+l.filename+"], error = "+k)}})},loadSnippet:function(l,d){/\.\w+$/.test(l)||(l+=".html");a.loadResource({filename:"snippets/"+
l,callback:d,dataType:"html"})}};return a}();
TILE5.Touch=function(){function v(b,f){var g=b&&b.length>0?b[0]:null;if(g&&f&&f.length>0)return TILE5.V.diff(g,f[0]);return null}function r(b){b.preventDefault();b.stopPropagation()}function n(b){for(var f=Array(b.length),g=b.length;g--;)f[g]=new TILE5.Vector(b[g].pageX,b[g].pageY);return f}var a={TAP:0,MOVE:1,PINCHZOOM:2},l=7,d=0,e=0,h={TouchHelper:function(b){function f(z){for(var D=[],F=b.element?-b.element.offsetLeft:0,P=b.element?-b.element.offsetTop:0,Q=z.length;Q--;)D.push(TILE5.V.offset(z[Q],
F,P));return D}function g(z){var D=Array(arguments.length-1),F=0;for(F=1;F<arguments.length;F++)D[F-1]=arguments[F];for(F=I.length;F--;)I[F][z]&&I[F][z].apply(M,D)}function m(z){if(z.target&&z.target===b.element){t=u?n(z.touches):[new TILE5.Vector(z.pageX,z.pageY)];y=new TILE5.Vector;x=new TILE5.Vector;G=true;p=false;u&&r(z);J.current=TILE5.Clock.getTime();if(z=t.length>0?t[0]:null){g("touchStartHandler",z.x,z.y);if(J.current-J.last<M.THRESHOLD_DOUBLETAP)if((z=w?TILE5.V.diff(t[0],w[0]):null)&&Math.abs(z.x)<
b.maxDistDoubleTap&&Math.abs(z.y)<b.maxDistDoubleTap)p=true;A=a.TAP;w=[].concat(t)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function s(z){if(z.target&&z.target===b.element)if(G)try{u&&r(z);var D=u?n(z.touches):[new TILE5.Vector(z.pageX,z.pageY)];z=0;if(D.length>1){if(t.length===1)t=[].concat(D);z=TILE5.V.distance(t)-TILE5.V.distance(w)}if(A===a.TAP){var F=v(D,t);if(F&&(Math.abs(F.x)>=l||Math.abs(F.y)>=l))A=a.MOVE}if(A!==a.TAP)if(!z||Math.abs(z)<b.pinchZoomThreshold){if(y=
v(D,w)){x.x+=y.x;x.y+=y.y;B.x+=y.x;B.y+=y.y}if(TILE5.V.absSize(B)>b.panEventThreshhold){g("moveHandler",B.x,B.y);B=TILE5.V.create()}A=a.MOVE}else{g("pinchZoomHandler",f(t),f(D));A=a.PINCHZOOM}w=[].concat(D)}catch(P){GRUNT.Log.exception(P)}}function q(z){if(z.target&&z.target===b.element)try{u&&r(z);TILE5.Clock.getTime();J.last=J.current;if(A===a.TAP)o||(o=setTimeout(function(){o=0;var F=p?"doubleTapHandler":"tapHandler",P=t[0],Q=null;if(b.element)Q=TILE5.V.offset(P,-b.element.offsetLeft,-b.element.offsetTop);
g(F,P,Q)},M.THRESHOLD_DOUBLETAP+50));else if(A==a.MOVE)g("moveEndHandler",x.x,x.y);else A==a.PINCHZOOM&&g("pinchZoomEndHandler",f(t),f(w))}catch(D){GRUNT.Log.exception(D)}G=false}b=GRUNT.extend({element:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},b);var p=false,o=0,u=TILE5.Device.getConfig().supportsTouch,
t=null,w=null,y=null,x=null,B=new TILE5.Vector,A=null,G=false,I=[],J={current:0,last:0},H=TILE5.Device.getConfig(),M={supportsTouch:u,THRESHOLD_DOUBLETAP:300,addListeners:function(z){I.push(z)},decoupleListeners:function(z){for(var D=0;z&&D<I.length;D++)if(I[D].listenerId===z){I.splice(D,1);GRUNT.Log.info("successfully decoupled touch listener: "+z);break}},release:function(){H.eventTarget.removeEventListener(H.supportsTouch?"touchstart":"mousedown",m,false);H.eventTarget.removeEventListener(H.supportsTouch?
"touchmove":"mousemove",s,false);H.eventTarget.removeEventListener(H.supportsTouch?"touchend":"mouseup",q,false)},wheelie:function(z){var D=new TILE5.Vector(z.wheelDeltaX,z.wheelDeltaY);z=new TILE5.Vector(z.clientX,z.clientY);var F=D.y!==0?Math.abs(D.y/120):0;if(F!==0)g("wheelZoomHandler",z,D.y>0?F+0.5:0.5/F);GRUNT.Log.info("capture mouse wheel event, delta = "+D+", position = "+z)}};H.eventTarget.addEventListener(H.supportsTouch?"touchstart":"mousedown",m,false);H.eventTarget.addEventListener(H.supportsTouch?
"touchmove":"mousemove",s,false);H.eventTarget.addEventListener(H.supportsTouch?"touchend":"mouseup",q,false);return M}},k=[];return{captureTouch:function(b,f){try{if(!b)throw Error("Unable to capture touch of null element");if(!b.id)b.id="touchable_"+d++;var g=k[b.id];if(!g){g=h.TouchHelper(GRUNT.extend({element:b},f));k[b.id]=g;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+g.supportsTouch)}f.listenerId&&g.decoupleListeners(f.listenerId);f.listenerId=++e;g.addListeners(f)}catch(m){GRUNT.Log.exception(m)}},
resetTouch:function(b){if(b&&b.id&&k[b.id]){k[b.id].release();delete k[b.id]}},Pannable:function(b){b=GRUNT.extend({container:null,onPan:null,onPanEnd:null,onAnimate:null,checkOffset:null},b);var f=false,g=new TILE5.Vector,m={pannable:true,getOffset:function(){return new TILE5.Vector(g.x,g.y)},setOffset:function(q,p){g.x=q;g.y=p},pan:function(q,p,o){if(o)m.updateOffset(g.x+q,g.y+p,o);else{m.updateOffset(g.x+q,g.y+p);b.onPan&&b.onPan(q,p)}},isAnimating:function(){return f},panEnd:function(q,p){b.onPanEnd&&
b.onPanEnd(q,p)},updateOffset:function(q,p,o){if(o){q=new TILE5.Vector(q,p);f=true;o=TILE5.Animation.tweenVector(g,q.x,q.y,o,function(){f=false;m.panEnd(0,0)});for(q=o.length;q--;){o[q].cancelOnInteract=true;o[q].requestUpdates(function(){b.onAnimate&&b.onAnimate(g.x,g.y)})}}else m.setOffset(q,p)}},s=document.getElementById(b.container);s&&TILE5.Touch.captureTouch(s,{moveHandler:function(q,p){m.pan(-q,-p)},moveEndHandler:function(q,p){m.panEnd(q,p)}});return m},Scalable:function(b){function f(x,B){m=
TILE5.V.getRect(x);s=TILE5.V.getRect(B);var A=TILE5.D.getSize(m.dimensions),G=TILE5.D.getSize(s.dimensions);t=TILE5.R.getCenter(s);q=m&&A!==0?G/A:1}b=GRUNT.extend({container:null,onAnimate:null,onPinchZoom:null,onScale:null,scaleDamping:false},b);var g=false,m=null,s=null,q=1,p=null,o=null,u=null,t=null,w={scalable:true,animate:function(x,B,A,G,I){function J(){I&&I();g=false;b.onScale&&b.onScale(q,t);q=1;p=null}g=true;u=TILE5.V.copy(B);t=TILE5.V.copy(A);m=null;if(G){o=q;TILE5.Animation.tweenValue(0,
x-o,G,J,1E3).requestUpdates(function(H){p=H/(x-o);q=o+H;b.onAnimate&&b.onAnimate()})}else{q=x;J()}},getScaleInfo:function(){return{factor:q,startRect:TILE5.R.copy(m),endRect:TILE5.R.copy(s),start:u,center:t,progress:p}},getScaling:function(){return g},getScaleFactor:function(){return q}},y=document.getElementById(b.container);y&&TILE5.Touch.captureTouch(y,{pinchZoomHandler:function(x,B){f(x,B);(g=q!==1)&&b.onPinchZoom&&b.onPinchZoom(x,B)},pinchZoomEndHandler:function(x,B){f(x,B);g=false;b.onScale&&
b.onScale(q,t,true);q=1},wheelZoomHandler:function(x){m=s=null;t=TILE5.V.copy(x)}});return w}}}();if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(v){return this.each(function(){TILE5.Touch.captureTouch(this,v)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(v){v.preventDefault()})}}
TILE5.Dispatcher=function(){var v=[],r={execute:function(n){var a=r.findAction(n);GRUNT.Log.info("looking for action id: "+n+", found: "+a);if(a){var l=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+n,function(){a.execute(l)})}},findAction:function(n){for(var a=v.length;a--;)if(v[a].id==n)return v[a];return null},getRegisteredActions:function(){return[].concat(v)},getRegisteredActionIds:function(){for(var n=[],a=v.length;a--;)v[a].id&&n.push(v[a].id);return n},registerAction:function(n){n&&
n.id&&v.push(n)},Action:function(n){n=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},n);var a={id:n.id,execute:function(){n.execute&&n.execute.apply(this,arguments)},getParam:function(l){return n[l]?n[l]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",a.id,n.title,n.icon)}};n.autoRegister&&r.registerAction(a);return a},createAgent:function(n){n=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},n);var a=null,l={getName:function(){return n.name},
getParam:function(d){return n[d]},getId:function(){return GRUNT.toID(l.getName())},run:function(d,e){if(n.execute){var h=a=TILE5.Clock.getTime(true),k=n.translator?n.translator(d):d;n.execute.call(l,k,function(b,f){if(!n.trashOrphanedResults||h==a)e&&e(b,f,k)})}}};return l},runAgents:function(n,a,l){for(var d=0;d<n.length;d++)n[d].run(a,l)}};return r}();
TILE5.Animation=function(){function v(){if(a===0)a=setInterval(function(){var d;d=TILE5.Clock.getTime();if(!n){n=true;try{for(var e=0;e<r.length;)if(r[e].isComplete()){r[e].triggerComplete(false);r.splice(e,1);GRUNT.WaterCooler.say("animation.complete")}else{r[e].update(d);e++}}finally{n=false}}d=r.length;if(d===0){clearInterval(a);a=0}},20)}var r=[],n=false,a=0,l={DURATION:2E3,tweenValue:function(d,e,h,k,b){d=new l.Tween({startValue:d,endValue:e,tweenFn:h,complete:k,duration:b});r.push(d);return d},
tween:function(d,e,h,k,b,f){d=new l.Tween({target:d,property:e,endValue:h,tweenFn:k,duration:f,complete:b});r.push(d);return d},tweenVector:function(d,e,h,k,b,f){var g=[];if(d){var m=d.x==e,s=d.y==h;m||g.push(l.tween(d,"x",e,k,function(){(m=true)&&s&&b()},f));s||g.push(l.tween(d,"y",h,k,function(){s=true;m&&s&&b()},f))}return g},cancel:function(d){if(!n){n=true;try{for(var e=0;e<r.length;)if(!d||d(r[e])){GRUNT.Log.info("CANCELLING ANIMATION");r[e].triggerComplete(true);r.splice(e,1)}else e++}finally{n=
false}}},isTweening:function(){return r.length>0},Tween:function(d){d=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:l.DURATION,tweenFn:l.DEFAULT,complete:null,cancelOnInteract:false},d);var e=TILE5.Clock.getTime(),h=[],k=false,b=0,f=0,g={cancelOnInteract:d.cancelOnInteract,isComplete:function(){return k},triggerComplete:function(m){d.complete&&d.complete(m)},update:function(m){try{var s=d.tweenFn(m-e,b,f,d.duration);if(d.target)d.target[d.property]=s;for(var q=h.length;q--;)h[q](s,
void 0);if(k=e+d.duration<=m){if(d.target)d.target[d.property]=d.tweenFn(d.duration,b,f,d.duration);for(var p=h.length;p--;)h[p](s,true)}}catch(o){GRUNT.Log.exception(o)}},requestUpdates:function(m){h.push(m)}};b=d.target&&d.property&&d.target[d.property]?d.target[d.property]:d.startValue;if(typeof d.endValue!=="undefined")f=d.endValue-b;if(f==0)k=true;v();return g},Easing:function(){var d=1.70158;return{Linear:function(e,h,k,b){return k*e/b+h},Back:{In:function(e,h,k,b){return k*(e/=b)*e*((d+1)*
e-d)+h},Out:function(e,h,k,b){return k*((e=e/b-1)*e*((d+1)*e+d)+1)+h},InOut:function(e,h,k,b){return(e/=b/2)<1?k/2*e*e*(((d*=1.525)+1)*e-d)+h:k/2*((e-=2)*e*(((d*=1.525)+1)*e+d)+2)+h}},Bounce:{In:function(e,h,k,b){return k-l.Easing.Bounce.Out(b-e,0,k,b)+h},Out:function(e,h,k,b){return(e/=b)<1/2.75?k*7.5625*e*e+h:e<2/2.75?k*(7.5625*(e-=1.5/2.75)*e+0.75)+h:e<2.5/2.75?k*(7.5625*(e-=2.25/2.75)*e+0.9375)+h:k*(7.5625*(e-=2.625/2.75)*e+0.984375)+h},InOut:function(e,h,k,b){return e<b/2?l.Easing.Bounce.In(e*
2,0,k,b)/2+h:l.Easing.Bounce.Out(e*2-b,0,k,b)/2+k/2+h}},Cubic:{In:function(e,h,k,b){return k*(e/=b)*e*e+h},Out:function(e,h,k,b){return k*((e=e/b-1)*e*e+1)+h},InOut:function(e,h,k,b){if((e/=b/2)<1)return k/2*e*e*e+h;return k/2*((e-=2)*e*e+2)+h}},Elastic:{In:function(e,h,k,b,f,g){if(e==0)return h;if((e/=b)==1)return h+k;g||(g=b*0.3);if(!f||f<Math.abs(k)){f=k;k=g/4}else k=g/(2*Math.PI)*Math.asin(k/f);return-(f*Math.pow(2,10*(e-=1))*Math.sin((e*b-k)*2*Math.PI/g))+h},Out:function(e,h,k,b,f,g){var m;if(e==
0)return h;if((e/=b)==1)return h+k;g||(g=b*0.3);if(!f||f<Math.abs(k)){f=k;m=g/4}else m=g/(2*Math.PI)*Math.asin(k/f);return f*Math.pow(2,-10*e)*Math.sin((e*b-m)*2*Math.PI/g)+k+h},InOut:function(e,h,k,b,f,g){var m;if(e==0)return h;if((e/=b/2)==2)return h+k;g||(g=b*0.3*1.5);if(!f||f<Math.abs(k)){f=k;m=g/4}else m=g/(2*Math.PI)*Math.asin(k/f);if(e<1)return-0.5*f*Math.pow(2,10*(e-=1))*Math.sin((e*b-m)*2*Math.PI/g)+h;return f*Math.pow(2,-10*(e-=1))*Math.sin((e*b-m)*2*Math.PI/g)*0.5+k+h}},Quad:{In:function(e,
h,k,b){return k*(e/=b)*e+h},Out:function(e,h,k,b){return-k*(e/=b)*(e-2)+h},InOut:function(e,h,k,b){if((e/=b/2)<1)return k/2*e*e+h;return-k/2*(--e*(e-2)-1)+h}},Sine:{In:function(e,h,k,b){return-k*Math.cos(e/b*(Math.PI/2))+k+h},Out:function(e,h,k,b){return k*Math.sin(e/b*(Math.PI/2))+h},InOut:function(e,h,k,b){return-k/2*(Math.cos(Math.PI*e/b)-1)+h}}}}()};return GRUNT.extend(l,{DEFAULT:l.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var v={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},r=0,n={DisplayState:v,AnyDisplayState:255,ActiveDisplayStates:v.ACTIVE|v.ANIMATING,DefaultDisplayStates:v.ACTIVE|v.ANIMATING|v.PAN|v.PINCHZOOM,ViewLayer:function(a){a=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:n.DefaultDisplayStates},a);var l=null,d=a.id,e=GRUNT.extend({addToView:function(h){h.setLayer(d,e)},shouldDraw:function(h){var k=
l?l.fastDraw&&h!==v.ACTIVE:false;return(h&a.validStates)!==0&&(k?a.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:d})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:l?l.id:null})},getId:function(){return d},setId:function(h){d=h},getParent:function(){return l},setParent:function(h){l=h}},a);return e},AnimatedPathLayer:function(a){function l(f,g,m){f.fillStyle="#FFFFFF";f.strokeStyle="#222222";f.beginPath();
f.arc(m.x,m.y,4,0,Math.PI*2,false);f.stroke();f.fill()}a=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,validStates:n.ActiveDisplayStates|v.PAN|v.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},a);var d=TILE5.V.edges(a.path),e,h=null,k=0;TILE5.Animation.tweenValue(0,d.total,a.easing,function(){b.remove()},a.duration).requestUpdates(function(f,g){k=f;g&&b.remove()});var b=GRUNT.extend(new n.ViewLayer(a),{cycle:function(){for(var f=
0;f<d.accrued.length&&d.accrued[f]<k;)f++;h=null;if(f<a.path.length-1){var g=k-(f>0?d.accrued[f-1]:0),m=a.path[f],s=a.path[f+1];e=TILE5.V.theta(m,s,d.edges[f]);h=TILE5.V.pointOnEdge(m,s,e,g);if(a.autoCenter)(f=b.getParent())&&f.centerOn(h)}return h?1:0},draw:function(f,g){if(h)(a.drawIndicator?a.drawIndicator:l)(f,g,new TILE5.Vector(h.x-g.x,h.y-g.y),e)}});return b},FPSLayer:function(a){a=GRUNT.extend({zindex:1E3,scalePosition:false},a);var l=null,d=GRUNT.extend(new n.ViewLayer(a),{delays:[],draw:function(e,
h,k){e.font="bold 8pt Arial";e.textAlign="right";e.fillStyle="rgba(0, 0, 0, 0.8)";e.fillText((l?l:"?")+" fps",k.width-20,20)}});setInterval(function(){for(var e=0,h=d.delays.length,k=h;k--;)e+=d.delays[k];if(h!==0)l=Math.floor(1E3/(e/h))},1E3);return d},ResourceStatsLayer:function(a){a=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:v.ACTIVE|v.PAN},a);return GRUNT.extend(new n.ViewLayer(a),{fps:null,draw:function(l){var d=TILE5.Resources.getStats(),e=a.indicatorSize,h=10,
k;if(d.imageCacheFullness){l.strokeStyle="rgba(0, 0, 255, 1)";l.beginPath();l.arc(15,15,5,0,Math.PI*2*d.imageCacheFullness,false);l.stroke();h=30}if(d.imageLoadingCount>=0){l.fillStyle="rgba(0, 255, 0, 0.7)";for(k=d.imageLoadingCount;k--;)l.fillRect(h+k*(e+2),10,e,e)}if(d.queuedImageCount>=0){l.fillStyle="rgba(255, 0, 0, 0.7)";for(k=d.queuedImageCount;k--;)l.fillRect(h+k*(e+2),10+e+2,e,e)}}})},LoadingLayer:function(a){GRUNT.extend({},a)},View:function(a){function l(C,E){E.setId(C);E.setParent(L);
b.push(E);b.sort(function(K,N){var O=N.zindex-K.zindex;if(O===0)O=N.created-K.created;return O})}function d(){GRUNT.WaterCooler.say("view.idle",{id:L.id});H=true;z=0}function e(C,E){var K=0,N=L.getScaleFactor(),O=L.getDisplayState(),X=(new Date).getTime(),V=(O&v.PINCHZOOM)!==0;q=L.getScaleFactor();var U=0;if(s||V){C.clearRect(0,0,f.width,f.height);s=false}if(V){var R=J.getScaleInfo();TILE5.D.getCenter(y);var T=(R.progress?R.progress:1)/2;G=R.center;if(R.startRect){T=TILE5.R.getCenter(R.startRect);
T=TILE5.V.diff(T,G);D=new TILE5.Vector(G.x+T.x,G.y+T.y)}else{R=TILE5.V.diff(R.start,G);D=new TILE5.Vector(G.x-R.x*T,G.y-R.y*T)}if(D)E=TILE5.V.offset(E,D.x,D.y)}C.save();try{if(t!==1)C.scale(t,t);else if(V){C.translate(G.x,G.y);C.scale(N,N)}for(U=b.length;U--;)if(b[U].shouldDraw(O)){var W=b[U].draw(C,E,y,O,L);K+=W?W:0}}finally{C.restore()}GRUNT.Log.trace("draw complete",X);return K}function h(){var C=0,E=S===v.PINCHZOOM||S===v.PAN;F=(new Date).getTime();m=I?I.getOffset():new TILE5.Vector;m.x=Math.floor(m.x);
m.y=Math.floor(m.y);A&&p&&A.delays.push(F-p);if(E){TILE5.Animation.cancel(function(N){return N.cancelOnInteract});H=false;if(z!==0){clearTimeout(z);z=0}}for(E=b.length;E--;){var K=b[E].cycle(F,m,S);C+=K?K:0}if(p+Q<F){C+=e(g,m);p=F}M=0;if(B+C>0)k();else if(!H&&z===0)z=setTimeout(d,500);GRUNT.Log.trace("Completed draw cycle",F)}function k(){B++;if(!(u||M!==0)){B=0;M=setTimeout(h,0)}}a=GRUNT.extend({id:"view_"+r++,container:"",pannable:false,scalable:false,clearOnDraw:false,displayFPS:false,displayResourceStats:false,
scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,onPan:null,onPinchZoom:null,onScale:null,onDraw:null,autoSize:false},a);var b=[],f=document.getElementById(a.container),g=null,m=new TILE5.Vector,s=false,q=1,p=null,o=0,u=false,t=1,w=new TILE5.Vector,y=null,x=null,B=0,A=null,G=null,I=null,J=null,H=false,M=0,z=0,D=null,F=0,P=TILE5.Device.getConfig().targetFps,Q=0,S=n.DisplayState.ACTIVE;GRUNT.Log.info("Creating a new view instance, attached to container: "+
a.container+", canvas = ",f);if(f){TILE5.Touch.resetTouch(f);if(a.autoSize){GRUNT.Log.info("autosizing view: window.height = "+window.innerHeight+", width = "+window.innerWidth);f.height=window.innerHeight-f.offsetTop;f.width=window.innerWidth-f.offsetLeft}try{g=f.getContext("2d");g.globalCompositeOperation=a.initialDrawMode;g.clearRect(0,0,f.width,f.height)}catch(Y){GRUNT.Log.exception(Y);throw Error("Could not initialise canvas on specified view element");}}if(a.pannable)I=new TILE5.Touch.Pannable({container:a.container,
onAnimate:function(){k()},onPan:function(C,E){o=TILE5.Clock.getTime(true);k();w=TILE5.V.offset(w,C,E);a.onPan&&a.onPan(C,E);S=v.PAN},onPanEnd:function(){k();S=v.ACTIVE}});if(a.scalable)J=new TILE5.Touch.Scalable({scaleDamping:a.scaleDamping,container:a.container,onAnimate:function(){S=n.DisplayState.PINCHZOOM;k()},onPinchZoom:function(C,E){o=TILE5.Clock.getTime(true);k();a.onPinchZoom&&a.onPinchZoom(C,E);S=n.DisplayState.PINCHZOOM},onScale:function(C,E){GRUNT.WaterCooler.say("view.scale",{id:L.id});
S=n.DisplayState.ACTIVE;k();a.onScale&&a.onScale(C,E)}});var L=GRUNT.extend({},a,I,J,{id:a.id,deviceScaling:t,fastDraw:a.fastDraw||TILE5.Device.getConfig().requireFastDraw,centerOn:function(C){I.setOffset(C.x-f.width/2,C.y-f.height/2)},getDimensions:function(){if(f)return new TILE5.Dimensions(f.width,f.height)},getZoomCenter:function(){return D},getLayer:function(C){for(var E=0;E<b.length;E++)if(b[E].getId()==C)return b[E];return null},setLayer:function(C,E){for(var K=0;K<b.length;K++)if(b[K].getId()===
C){b.splice(K,1);break}E&&l(C,E);GRUNT.WaterCooler.say("layer.update",{id:C});k()},eachLayer:function(C){for(var E=0;E<b.length;E++)C(b[E])},clearBackground:function(){s=true},freeze:function(){u=true},unfreeze:function(){u=false;k()},snapshot:function(){},getDisplayState:function(){return u?v.FROZEN:S},scale:function(C,E,K,N,O){N||(N=TILE5.D.getCenter(y));O||(O=TILE5.D.getCenter(y));J&&J.animate(C,N,O,E,K);return J},removeLayer:function(C){a:{for(var E=b.length;E--;)if(b[E].getId()==C){C=E;break a}C=
-1}if(C>=0&&C<b.length){GRUNT.WaterCooler.say("layer.removed",{layer:b[C]});b.splice(C,1)}}});y=L.getDimensions();x=TILE5.D.getCenter(y);if(P)Q=Math.ceil(1E3/P);GRUNT.Log.info("redraw interval calaculated @ "+Q);GRUNT.WaterCooler.listen("layer.remove",function(C){C.id&&L.removeLayer(C.id)});GRUNT.WaterCooler.listen("view.wake",function(C){if(!C.id||C.id===L.id)k()});t=TILE5.Device.getConfig().getScaling();if(a.displayFPS){A=new n.FPSLayer;L.setLayer("fps",A)}a.displayResourceStats&&L.setLayer("resourceStats",
new n.ResourceStatsLayer);k();return L}};return n}();
TILE5.Tiling=function(){function v(){if(!n){n=document.createElement("canvas");n.width=l.Config.TILESIZE;n.height=l.Config.TILESIZE;var d=n.getContext("2d");d.fillStyle="rgba(150, 150, 150, 0.025)";d.fillRect(0,0,n.width,n.height)}return n}function r(){function d(){var h=document.createElement("canvas");h.width=32;h.height=32;var k=h.getContext("2d");k.fillStyle="#BBBBBB";k.fillRect(0,0,32,32);k.fillStyle="#C3C3C3";k.fillRect(0,0,16,16);k.fillRect(16,16,16,16);return h}if(!a){a=document.createElement("canvas");
a.width=l.Config.TILESIZE;a.height=l.Config.TILESIZE;var e=a.getContext("2d");e.fillStyle=e.createPattern(d(),"repeat");e.fillRect(0,0,a.width,a.height)}return a}TileStore=function(d){d=GRUNT.extend({tileSize:null,gridSize:25,center:new TILE5.Vector,onPopulate:null},d);if(!d.tileSize)throw Error("Cannot create TileStore with an empty tile size");var e=Array(Math.pow(d.gridSize,2)),h=TILE5.V.offset(d.center,-Math.ceil(d.gridSize>>1)),k=null,b=new TILE5.Vector,f=null,g={getGridSize:function(){return d.gridSize},
getNormalizedPos:function(m,s){return TILE5.V.add(new TILE5.Vector(m,s),TILE5.V.invert(h),b)},getTileShift:function(){return TILE5.V.copy(b)},getTile:function(m,s){return m>=0&&m<d.gridSize?e[s*d.gridSize+m]:null},setTile:function(m,s,q){e[s*d.gridSize+m]=q},populate:function(m,s){var q=GRUNT.Log.getTraceTicks(),p=0,o=d.gridSize,u=d.tileSize;new TILE5.Vector(o/2,o/2);if(m){GRUNT.Log.info("populating grid, x shift = "+b.x+", y shift = "+b.y);for(var t=0;t<o;t++)for(var w=0;w<o;w++){if(!e[p]){var y=
m(w,t,h,o);y.gridX=w*u-b.x;y.gridY=t*u-b.y;e[p]=y}p++}}k=m;f=s;GRUNT.Log.trace("tile grid populated",q);d.onPopulate&&d.onPopulate()},getShiftDelta:function(m,s,q,p){var o=Math.floor(d.gridSize*0.2),u=new TILE5.Vector;if(m<0||m+q>d.gridSize)u.x=m<0?-o:o;if(s<0||s+p>d.gridSize)u.y=s<0?-o:o;return u},shift:function(m,s){if(!(m.x===0&&m.y===0)){var q=GRUNT.Log.getTraceTicks();GRUNT.Log.info("need to shift tile store grid, "+m.x+" cols and "+m.y+" rows.");var p=Array(e.length);p.length=e.length;for(var o=
0;o<d.gridSize;o++)for(var u=0;u<d.gridSize;u++)p[u*d.gridSize+o]=g.getTile(o+m.x,u+m.y);e=p;h=s?s(h,m):TILE5.V.add(h,m);b.x+=-m.x*d.tileSize;b.y+=-m.y*d.tileSize;GRUNT.Log.trace("tile storage shifted",q);g.populate(k,f)}},setOrigin:function(m,s){if(tileOrigin)shiftOrigin(m,s);else h=TILE5.V.offset(new TILE5.Vector(m,s),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var m=e.length;m--;)if(e[m])e[m].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var m=
e.length;m--;)if(e[m]){e[m].x=null;e[m].y=null}});return g};var n=null,a=null,l={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(d){return d=GRUNT.extend({x:0,y:0,gridX:0,gridY:0,size:256},d)},ImageTile:function(d){d=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},d);return new l.Tile(d)},TileGrid:function(d){function e(x,B){if(w){var A,G=[],I=new TILE5.Vector(Math.floor((x.x+p.x)*b),Math.floor((x.y+p.y)*b));tilesNeeded=false;for(var J=t;J--;)for(var H=u;H--;){A=
h.getTile(H+I.x,J+I.y);var M=new TILE5.Vector(H-w.x,J-w.y);A||(q=h.getShiftDelta(I.x,I.y,u,t));G.push({tile:A,centerness:TILE5.V.absSize(M)})}G.sort(function(z,D){return D.centerness-z.centerness});m||(m=Array(G.length));for(A=G.length;A--;){m[A]=G[A].tile;y.prepTile(m[A],B)}}}d=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},d);var h=new TileStore(GRUNT.extend({tileSize:d.tileSize,onPopulate:function(){f=true;y.wakeParent()}},
d)),k=Math.round(d.tileSize/2),b=d.tileSize?1/d.tileSize:0,f=false,g=true,m=null,s=false;new TILE5.Vector;var q=new TILE5.Vector,p=new TILE5.Vector;TILE5.Device.getConfig();var o=h.getGridSize()*d.tileSize,u,t,w,y=GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{gridDimensions:new TILE5.Dimensions(o,o),cycle:function(x,B,A){x=0;if(q.x+q.y!==0){h.shift(q,d.shiftOrigin);p=h.getTileShift();q=new TILE5.Vector;x++}A!==TILE5.Graphics.DisplayState.PINCHZOOM&&e(B,A);return x+f?1:0},deactivate:function(){g=false},
prepTile:function(){},drawTile:function(){return false},draw:function(x,B,A,G){if(g){var I=(new Date).getTime(),J=B.x;B=B.y;var H=true,M=G===TILE5.Graphics.DisplayState.PINCHZOOM||TILE5.Animation.isTweening();if(!w){u=Math.ceil(A.width*b)+1;t=Math.ceil(A.height*b)+1;w=new TILE5.Vector(Math.floor((u-1)/2),Math.floor((t-1)/2))}if(m){if(d.drawGrid)x.strokeStyle="rgba(50, 50, 50, 0.3)";x.beginPath();for(A=m.length;A--;){var z=m[A];if(z){var D=z.gridX-J,F=z.gridY-B;H=((M?false:z.x===D&&z.y===F)?false:
y.drawTile(x,z,D,F,G))&&H}else H=false;d.drawGrid&&x.rect(D,F,d.tileSize,d.tileSize)}x.stroke();GRUNT.Log.trace("drawn tiles",I);H&&!s&&GRUNT.WaterCooler.say("tiles.drawn",{id:y.getId()});s=H;f=false}}},getTileVirtualXY:function(x,B,A){x=h.getNormalizedPos(x,B);x=new TILE5.Vector(x.x*d.tileSize,x.y*d.tileSize);if(A){x.x+=k;x.y+=k}return x},populate:function(x){h.populate(x,function(){})}});GRUNT.WaterCooler.listen("tile.loaded",function(){f=true;y.wakeParent()});return y},ImageTileGrid:function(d){function e(){GRUNT.WaterCooler.say("tile.loaded")}
d=GRUNT.extend({},d);var h=v(),k=r(),b=TILE5.Graphics.DisplayState.PAN,f=TILE5.Device.getConfig().requireFastDraw;return GRUNT.extend(new l.TileGrid(d),{drawTile:function(g,m,s,q,p){var o=TILE5.Resources.getImage(m.url),u=false;if(o&&o.complete&&o.width>0){g.drawImage(o,s,q);u=true;m.x=s;m.y=q}else p===b?g.drawImage(k,s,q):g.drawImage(h,s,q);return u},prepTile:function(g,m){if(g&&(!f||m!==b))TILE5.Resources.getImage(g.url)||TILE5.Resources.loadImage(g.url,e)}})},Tiler:function(d){d=GRUNT.extend({container:"",
drawCenter:false,onPan:null,onPanEnd:null,tapHandler:null,doubleTapHandler:null,zoomHandler:null,onDraw:null,datasources:{},tileLoadThreshold:"first"},d);var e=new TILE5.Graphics.View(GRUNT.extend({},d,{pannable:true,scalable:true,scaleDamping:true}));TILE5.Touch.captureTouch(document.getElementById(d.container),d);GRUNT.extend(e,{getTileLayer:function(){return e.getLayer("grid0")},setTileLayer:function(h){e.setLayer("grid0",h);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(h){var k=
e.getOffset();return new TILE5.Vector(h.x+k.x,h.y+k.y)},cleanup:function(){e.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");GRUNT.WaterCooler.say("view.wake",{id:e.id})}});return e}};return l}();
TILE5.Geo=function(){function v(b,f){var g=null;for(var m in h)if(f){if(m==f&&h[m][b]){g=h[m];break}}else if(h[m][b]){g=h[m];break}return g}function r(b,f,g,m){var s=0;b=b.toUpperCase();for(var q in m){var p=f[q];if(p){var o=g[q];p=o?o(b,p):b.containsWord(p)?1:0;s+=p*m[q]}}return s}var n=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],a=Math.PI/180,l=180/Math.PI,d=null,e={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},h={},k={Engine:function(b){if(!b.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var f=GRUNT.extend({remove:function(){delete h[f.id]}},b);return h[f.id]=f},Radius:function(b,f){return{distance:parseInt(b,10),uom:f}},Position:function(b,f){return{lat:parseFloat(b?b:0),lon:parseFloat(f?f:0)}},BoundingBox:function(b,f){return{min:k.P.parse(b),max:k.P.parse(f)}},Address:function(b){return b=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},b)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var b={lat2pix:function(f,g){var m=parseFloat(f)*2*Math.PI/360;m=Math.sin(m);var s=0.08181919084262157*m;return Math.log((1+m)/(1-m)*Math.pow((1-s)/(1+s),0.08181919084262157))/2/g},lon2pix:function(f,g){return parseFloat(f)/180*Math.PI/g},pix2lon:function(f,g){return b.normalizeLon(f*g*180/Math.PI)},pix2lat:function(f,g){for(var m=Math.pow(Math.E,-f*g),s=b.mercatorUnproject(m),
q=b.findRadPhi(s,m),p=0;p<12&&Math.abs(s-q)>1.0E-7;){s=q;q=b.findRadPhi(s,m);p++}return q*180/Math.PI},mercatorUnproject:function(f){return Math.PI/2-2*Math.atan(f)},findRadPhi:function(f,g){var m=0.08181919084262157*Math.sin(f);return Math.PI/2-2*Math.atan(g*Math.pow((1-m)/(1+m),0.040909595421310785))},normalizeLon:function(f){for(;f<-180;)f+=360;for(;f>180;)f-=360;return f}};return b}(),GeoSearchResult:function(b){b=GRUNT.extend({id:null,caption:"",resultType:"",data:null,pos:null,matchWeight:0},
b);return GRUNT.extend(b,{toString:function(){return b.caption+(b.matchWeight?" ("+b.matchWeight+")":"")}})},GeoSearchAgent:function(b){b=GRUNT.extend({},b);return GRUNT.extend({},TILE5.Dispatcher.createAgent(b))},GeocodingAgent:function(b){b=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(f,g){try{if(!f.reverse&&!f.freeform)address=new k.Address(f);var m=k.getEngine("geocode");if(m)m.geocode({addresses:[f.freeform?f.freeform:address],complete:function(q,p){if(g){var o=
p;if(f.freeform)o=k.rankGeocodeResponses(f.freeform,o,k.getEngine("geocode"));g(o,b)}}})}catch(s){GRUNT.Log.exception(s)}}},b);return new k.GeoSearchAgent(b)},PointOfInterest:function(b){b=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},b);if(!b.pos&&b.lat&&b.lon)b.pos=new TILE5.Geo.Position(b.lat,b.lon);return GRUNT.extend({toString:function(){return b.id+": '"+b.title+"'"}},b)},POIStorage:function(b){function f(o){o=o?o:"default";s[o]||(s[o]=[]);return s[o]}function g(o){var u=
[];for(var t in s)for(var w=0;w<s[t].length;w++)if(!o||o(s[t][w]))u.push(s[t][w]);return u}function m(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:p.id,pois:p.getPOIs()})}b=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},b);var s={},q=true,p={id:GRUNT.generateObjectID(),getPOIs:function(){return g()},getOldPOIs:function(o,u){return g(function(t){return t.group==o&&t.retrieved<u})},getVisible:function(){return q},setVisible:function(o){if(o!=q){q=o;b.visibilityChange&&b.visibilityChange()}},
findById:function(o){var u=g(function(t){return t.id==o});return u.length>0?u[0]:null},findByBounds:function(o){return g(function(u){return TILE5.Geo.P.inBounds(u.pos,o)})},addPOIs:function(o,u){if(u)s={};for(var t=0;o&&t<o.length;t++){o[t].retrieved=TILE5.Clock.getTime(true);var w=o[t];f(w.group).push(w)}},removeGroup:function(o){if(s[o]){delete s[o];m()}},update:function(o){var u=[],t=0,w=o.length>0?o[0].group:"",y=TILE5.Clock.getTime(true);for(t=0;t<o.length;t++){var x;a:{if(x=o[t])for(var B=f(x.group),
A=0;A<B.length;A++)if(B[A].id==x.id){x=B[A];break a}x=null}if(x){x.retrieved=y;x.isNew=false}else u.push(o[t])}o=p.getOldPOIs(w,y);p.addPOIs(u);for(t=0;b.onPOIAdded&&t<u.length;t++)b.onPOIAdded(u[t]);for(t=0;t<o.length;t++){b.onPOIDeleted&&b.onPOIDeleted(o[t]);w=o[t];y=f(w.group);for(x=0;x<y.length;x++)if(y[x].id==w.id){y.splice(x,1);break}}u.length+o.length>0&&m()}};return p},MapProvider:function(){return{zoomLevel:0,checkZoomLevel:function(b){return b},getCopyright:function(){},getMapTiles:function(){},
getPositionForXY:function(){return null}}},P:function(){var b={calcDistance:function(f,g){if(b.empty(f)||b.empty(g))return 0;var m=(g.lat-f.lat).toRad()/2,s=(g.lon-f.lon).toRad()/2;m=Math.sin(m)*Math.sin(m)+Math.cos(f.lat.toRad())*Math.cos(g.lat.toRad())*Math.sin(s)*Math.sin(s);return 6371*2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m))},copy:function(f){return f?new k.Position(f.lat,f.lon):null},empty:function(f){return!f||f.lat===0&&f.lon===0},equal:function(f,g){return f&&g&&f.lat==g.lat&&f.lon==g.lon},
almostEqual:function(f,g){return f&&g&&Math.floor(f.lat*1E3)===Math.floor(g.lat*1E3)&&Math.floor(f.lon*1E3)===Math.floor(g.lon*1E3)},inArray:function(f,g){for(var m=k.P.equal,s=g.length;s--;)if(m(f,g[s]))return true;return false},inBounds:function(f,g){var m=!(k.P.empty(f)||k.P.empty(g));return m=(m=m&&f.lat>=g.min.lat&&f.lat<=g.max.lat)&&f.lon>=g.min.lon&&f.lon<=g.max.lon},parse:function(f){if(f)if(typeof f.lat!=="undefined")return b.copy(f);else{if(f.split)for(var g=[" ",","],m=0;m<g.length;m++){var s=
f.split(g[m]);if(s.length===2)return new k.Position(s[0],s[1])}}else return new k.Position;return null},parseArray:function(f){var g=f.length,m=Array(g);for(g=g;g--;)m[g]=b.parse(f[g]);GRUNT.Log.info("parsed "+m.length+" positions");return m},fromMercatorPixels:function(f,g,m){return new k.Position(TILE5.Geo.Utilities.pix2lat(g,m),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(f,m)))},toMercatorPixels:function(f,g){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(f.lon,g),TILE5.Geo.Utilities.lat2pix(f.lat,
g))},generalize:function(f,g,m){var s=f.length,q=[],p=null;m||(m=250);m/=1E3;GRUNT.Log.info("generalizing positions, must include "+g.length+" positions");for(var o=s;o--;)if(o===0)q.unshift(f[o]);else{var u=!p||k.P.inArray(f[o],g)?m:k.P.calcDistance(p,f[o]);if(f[o]&&u>=m){q.unshift(f[o]);p=f[o]}}GRUNT.Log.info("generalized "+s+" positions into "+q.length+" positions");return q},toString:function(f){return f?f.lat+" "+f.lon:""}};return b}(),B:function(){var b=-(Math.PI/2),f=Math.PI/2,g=-Math.PI*2,
m=Math.PI*2,s={calcSize:function(q,p,o){var u=new TILE5.Vector(0,p.lat-q.lat);if(typeof o==="undefined")o=true;u.x=o&&q.lon>p.lon?360-q.lon+p.lon:p.lon-q.lon;return u},createBoundsFromCenter:function(q,p){var o=p/6371,u=q.lat*a,t=q.lon*a,w=u-o,y=u+o;if(w>b&&y<f){u=Math.asin(Math.sin(o)/Math.cos(u));o=t-u;if(o<g)o+=2*Math.PI;t=t+u;if(t>m)t-=2*Math.PI}else{w=Math.max(w,b);y=Math.min(y,f);o=g;t=m}return new k.BoundingBox(new k.Position(w*l,o*l),new k.Position(y*l,t*l))},expand:function(q,p){return new k.BoundingBox(new k.Position(q.min.lat-
p,q.min.lon-k.Utilities.normalizeLon(p)),new k.Position(q.max.lat+p,q.max.lon+k.Utilities.normalizeLon(p)))},forPositions:function(q,p){var o=null,u=TILE5.Clock.getTime();p||(p="auto");for(var t=q.length;t--;)if(o){var w=s.calcSize(o.min,q[t],false),y=s.calcSize(q[t],o.max,false);if(w.x<0)o.min.lon=q[t].lon;if(w.y<0)o.min.lat=q[t].lat;if(y.x<0)o.max.lon=q[t].lon;if(y.y<0)o.max.lat=q[t].lat}else o=new TILE5.Geo.BoundingBox(q[t],q[t]);if(p){if(p=="auto"){t=s.calcSize(o.min,o.max);p=Math.max(t.x,t.y)*
0.3}o=s.expand(o,p)}GRUNT.Log.trace("calculated bounds for "+q.length+" positions",u);return o},getCenter:function(q){var p=k.B.calcSize(q.min,q.max);return new TILE5.Geo.Position(q.min.lat+p.y/2,q.min.lon+p.x/2)},getGeoHash:function(q){var p=TILE5.Geo.GeoHash.encode(q.min.lat,q.min.lon);q=TILE5.Geo.GeoHash.encode(q.max.lat,q.max.lon);GRUNT.Log.info("min hash = "+p+", max hash = "+q)},getZoomLevel:function(q,p){var o=s.getCenter(q),u=n[Math.min(Math.round(Math.abs(o.lat)*0.05),n.length)],t=s.calcSize(q.min,
q.max);o=Math.ceil(Math.log(n[3]*p.height/t.y)/Math.log(2));u=Math.ceil(Math.log(u*p.width/t.x)/Math.log(2));return Math.min(isNaN(o)?1E3:o,isNaN(u)?1E3:u)},isEmpty:function(q){return!q||k.P.empty(q.min)||k.P.empty(q.max)},toString:function(q){return"min: "+k.P.toString(q.min)+", max: "+k.P.toString(q.max)}};return s}(),A:function(){var b=/^(\d+).*$/,f=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(g,m){b.lastIndex=-1;if(b.test(g))for(var s=g.replace(b,"$1"),q=m.split(","),p=0;p<q.length;p++){f.lastIndex=
-1;if(f.test(q[p])){var o=f.exec(q[p]);if(s>=parseInt(o[1],10)&&s<=parseInt(o[2],10))return true}else if(s==q[p])return true}return false},normalize:function(g){if(!g)return"";g=g.toUpperCase();if(!d){var m=[];for(var s in e)m.push(s);d=RegExp("(\\s)("+m.join("|")+")(\\s|$)","i")}d.lastIndex=-1;if(m=d.exec(g))g=g.replace(d,"$1"+e[m[2]]);return g},toString:function(g){return g.streetDetails+" "+g.location}}}(),getEngine:function(b){for(var f=null,g=1;!f&&g<arguments.length;g++)f=v(b,arguments[g]);
f=f?f:v(b);if(!f)throw Error("Unable to find GEO engine with "+b+" capability");return f},rankGeocodeResponses:function(b,f,g){var m=[],s=k.AddressCompareFns;if(g&&g.compareFns)s=GRUNT.extend({},s,g.compareFns);for(g=0;g<f.length;g++)m.push(new k.GeoSearchResult({caption:k.A.toString(f[g]),data:f[g],pos:f[g].pos,matchWeight:r(b,f[g],s,k.GeocodeFieldWeights)}));m.sort(function(q,p){return p.matchWeight-q.matchWeight});return m}};return k}();
TILE5.Geo.Location=function(){function v(a){function l(g){try{var m=new TILE5.Geo.Position(g.coords.latitude,g.coords.longitude),s=GRUNT.isPlainObject(g.coords.accuracy)&&g.coords.accuracy.horizontal?g.coords.accuracy.horizontal:g.coords.accuracy;GRUNT.Log.info("position success, accuracy = "+s);if(a.successCallback&&(!k||s<b))a.successCallback(m,s,h,g);if(s>a.highAccuracyCutoff&&h<2){h=2;a.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");
a.watch||e()}k=g;b=s}catch(q){GRUNT.Log.exception(q)}}function d(g){if(g.code===g.PERMISSION_DENIED)a.errorCallback&&a.errorCallback(g);else if(g.code===g.POSITION_UNAVAILABLE)a.errorCallback&&a.errorCallback(g);else if(g.code===g.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(a.timeout===0&&a.autoPhasing){h=1;a.timeout=r;a.enableHighAccuracy=false;e()}}}function e(){navigator.geolocation.getCurrentPosition(l,d,GRUNT.extend({},a,{enableHighAccuracy:false}))}a=GRUNT.extend({autoPhasing:true,
maximumAge:3E5,timeout:0,highAccuracyCutoff:10,watch:false,enableHighAccuracy:true,successCallback:null,errorCallback:null},a);var h=0,k=null,b=1E6,f;if(a.watch){navigator.geolocation.watchPosition(l,d,a);f=void 0}else f=e();return f}var r=3E3,n={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)n.get=v;return n}();
TILE5.Geo.GeoHash=function(){function v(r,n,a){if(n&a)r[0]=(r[0]+r[1])/2;else r[1]=(r[0]+r[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(r){var n=1,a=[],l=[];a[0]=-90;a[1]=90;l[0]=-180;l[1]=180;lat_err=90;lon_err=180;for(i=0;i<r.length;i++){c=r[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(n){lon_err/=2;v(l,cd,mask)}else{lat_err/=2;v(a,cd,mask)}n=!n}}a[2]=(a[0]+
a[1])/2;l[2]=(l[0]+l[1])/2;return{latitude:a,longitude:l}},encode:function(r,n,a){var l=1,d=[],e=[],h=0,k=0;a=a?a:12;geohash="";d[0]=-90;d[1]=90;e[0]=-180;for(e[1]=180;geohash.length<a;){if(l){mid=(e[0]+e[1])/2;if(n>mid){k|=BITS[h];e[0]=mid}else e[1]=mid}else{mid=(d[0]+d[1])/2;if(r>mid){k|=BITS[h];d[0]=mid}else d[1]=mid}l=!l;if(h<4)h++;else{geohash+=BASE32[k];k=h=0}}return geohash}}}();
TILE5.Geo.Search=function(){return{bestResults:function(v,r){r||(r=20);for(var n=v.length>0?v[0]:null,a=[],l=0;l<v.length;l++)if(n.matchWeight-v[l].matchWeight<=r)a.push(v[l]);else break;return a}}}();
TILE5.Geo.Routing=function(){var v={calculate:function(r){r=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},r);GRUNT.Log.info("attempting to calculate route");var n=TILE5.Geo.getEngine("route");n&&n.route(r,function(a){if(r.generalize)a.geometry=TILE5.Geo.P.generalize(a.geometry,a.getInstructionPositions());if(r.map){v.createMapOverlay(r.map,a);if(r.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+a.boundingBox);r.map.gotoBounds(a.boundingBox)}}r.success&&
r.success(a)})},createMapOverlay:function(r,n){var a=r.getDimensions();a=new TILE5.Geo.UI.RouteOverlay({data:n,width:a.width,height:a.height});r.setLayer("route",a)},parseTurnType:function(r){for(var n=v.TurnType.Unknown,a=TILE5.Geo.Routing.TurnTypeRules,l=0;l<a.length;l++){a[l].regex.lastIndex=-1;var d=a[l].regex.exec(r);if(d){n=a[l].customCheck?a[l].customCheck(r,d):a[l].turnType;break}}return n},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",
TurnLeft:"turn-left",TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(r){r=GRUNT.extend({position:null,description:"",turnType:null},r);if(!r.turnType)r.turnType=v.parseTurnType(r.description);return r},RouteData:function(r){r=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},r);if(!r.boundingBox)r.boundingBox=TILE5.Geo.B.forPositions(r.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var n=[],a=0;a<r.instructions.length;a++)r.instructions[a].position&&n.push(r.instructions[a].position);return n}},r)}};return v}();
TILE5.Geo.Routing.TurnTypeRules=function(){var v=TILE5.Geo.Routing.TurnType,r=[];r.push({regex:/continue/i,turnType:v.Continue});r.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(n,a){return/bear/i.test(a[1])?v.TurnLeftSlight:v.TurnLeft}});r.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(n,a){return/bear/i.test(a[1])?v.TurnRightSlight:v.TurnRight}});r.push({regex:/enter\s(roundabout|rotaty)/i,turnType:v.EnterRoundabout});r.push({regex:/take.*?ramp/i,turnType:v.Ramp});
r.push({regex:/take.*?exit/i,turnType:v.RampExit});r.push({regex:/make(.*?)u\-turn/i,customCheck:function(n,a){return/right/i.test(a[1])?v.UTurnRight:v.UTurnLeft}});r.push({regex:/proceed/i,turnType:v.Start});r.push({regex:/arrive/i,turnType:v.Arrive});r.push({regex:/fell\sthrough/i,turnType:v.Merge});return r}();
TILE5.Geo.UI=function(){function v(a){a=GRUNT.extend({size:12,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},a);var l=null,d=function(){var e=document.createElement("canvas");e.width=a.size*4;e.height=a.size*4;var h=e.getContext("2d"),k=new TILE5.Vector(e.width/2,e.height/2),b=a.size,f=["#FFFFFF","#333333"],g=[3,1.5];h.lineCap="round";for(var m=0;m<f.length;m++){var s=b;h.lineWidth=g[m];h.strokeStyle=
f[m];h.beginPath();h.moveTo(k.x,k.y-s);h.lineTo(k.x,k.y+s);h.moveTo(k.x-s,k.y);h.lineTo(k.x+s,k.y);h.arc(k.x,k.y,b*0.6666,0,2*Math.PI,false);h.stroke()}return e}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(e,h,k){if(!l){l=TILE5.D.getCenter(k);l=new TILE5.Vector(Math.round(l.x-d.width/2),Math.round(l.y-d.height/2))}e.drawImage(d,l.x,l.y)}})}var r=0,n={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,
radsPerPixel:0},a);var l=TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),d=l.x-a.centerXY.x,e=l.y-a.centerXY.y,h=GRUNT.extend({},a.grid,{getBoundingBox:function(k,b,f,g){return new TILE5.Geo.BoundingBox(h.pixelsToPos(new TILE5.Vector(k,b+g)),h.pixelsToPos(new TILE5.Vector(k+f,b)))},getGridXYForPosition:function(k){k=TILE5.Geo.P.toMercatorPixels(k,a.radsPerPixel);return new TILE5.Vector(k.x-d,h.gridDimensions.height-(k.y-e))},pixelsToPos:function(k){return TILE5.Geo.P.fromMercatorPixels(d+
k.x,e+h.gridDimensions.height-k.y,a.radsPerPixel)}});return h},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var l=true,d=null,e=[],h=0,k=[],b=[],f=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(g,m,s,q){if(l)return null;var p="routeAnimation"+r++;b.push(p);return new TILE5.Graphics.AnimatedPathLayer({id:p,path:e,zindex:a.zindex+
1,easing:g?g:TILE5.Animation.Easing.Sine.InOut,duration:m?m:5E3,drawIndicator:s,autoCenter:q?q:false})},draw:function(g,m,s,q,p){s=0;q=a.data?a.data.geometry:null;if(l){l=false;d=null;e=[];h=0}if(q&&h<q.length){a:{p=p.getTileLayer();k=[];if(p){q=GRUNT.Log.getTraceTicks();var o,u,t,w=a.data?a.data.geometry:[],y=w.length,x=a.data?a.data.instructions:[],B=x.length,A=a.calculationsPerCycle,G=0;for(o=h;o<y;o++){u=p.getGridXYForPosition(w[o]);if(t=!d||o===0||Math.abs(u.x-d.x)+Math.abs(u.y-d.y)>a.pixelGeneralization){e.push(u);
d=u}G++;if(G>=A){h=o;break a}}h=y;GRUNT.Log.trace(y+" geometry points generalized to "+e.length+" coordinates",q);d=null;for(o=B;o--;)if(x[o].position){u=p.getGridXYForPosition(x[o].position);if(t=!d||o===0||Math.abs(u.x-d.x)+Math.abs(u.y-d.y)>a.pixelGeneralization){k.push(u);d=u}}}}s++}p=e.length;if(p>0&&(!s||a.partialDraw)){g.strokeStyle=a.strokeStyle;g.lineWidth=a.lineWidth;g.beginPath();g.moveTo(e[p-1].x-m.x,e[p-1].y-m.y);for(p=p;p--;)g.lineTo(e[p].x-m.x,e[p].y-m.y);g.stroke();g.fillStyle=a.waypointFillStyle;
for(p=k.length;p--;){g.beginPath();g.arc(k[p].x-m.x,k[p].y-m.y,2,0,Math.PI*2,false);g.stroke();g.fill()}}return s}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var g=b.length;g--;)GRUNT.WaterCooler.say("layer.remove",{id:b[g]});b=[];l=true;f.wakeParent()});return f},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:n.AnnotationTween,animationSpeed:null},a);var l=false,d={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return l},draw:function(e,h,k,b){if(d.xy){if(d.isNew&&
a.tweenIn){var f=d.xy.y;d.xy.y=h.y-20;l=true;TILE5.Animation.tween(d.xy,"y",f,a.tweenIn,function(){d.xy.y=f;l=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(e,h,new TILE5.Vector(d.xy.x-h.x,d.xy.y-h.y),k,b);else{e.beginPath();e.arc(d.xy.x-h.x,d.xy.y-h.y,4,0,Math.PI*2,false);e.fill()}d.isNew=false}}};return d},ImageAnnotation:function(a){a=GRUNT.extend({imageUrl:null,animatingImageUrl:null,imageAnchor:null},a);var l=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;
a.draw=function(e,h,k,b,f){if(a.animatingImageUrl&&d.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);b=a.animatingImageUrl}else b=a.imageUrl;if(h=TILE5.Resources.getImage(b)){if(h.complete&&h.width>0){l||(l=new TILE5.Vector(-h.width>>1,-h.height>>1));k=TILE5.V.offset(k,l.x,l.y);e.drawImage(h,k.x,k.y,h.width,h.height)}}else TILE5.Resources.loadImage(b,function(){f.wakeParent()})};var d=new n.Annotation(a);return d},AnnotationsOverlay:function(a){function l(b){for(var f=a.map?a.map.getTileLayer():
null,g=0;f&&g<b.length;g++)b[g].xy=f.getGridXYForPosition(b[g].pos)}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var d=[],e=false,h=[],k=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){return e?1:0},draw:function(b,f,g,m){e=false;b.fillStyle="rgba(255, 0, 0, 0.75)";b.globalCompositeOperation="source-over";for(g=d.length;g--;){d[g].draw(b,f,m,k);e=e||d[g].isAnimating()}for(g=h.length;g--;){h[g].draw(b,f,m,k);e=e||h[g].isAnimating()}return e?1:0},add:function(b){h.push(b);
l(h);k.wakeParent()},clear:function(b){h=[];l(h);if(b){d=[];l(d)}k.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(b){if(a.pois&&a.pois.id==b.srcID){b=b.pois;try{d=[];for(var f=0;f<b.length;f++)if(b[f].pos){var g;var m=b[f];if(m&&m.pos){var s=null;if(s=a.createAnnotationForPOI?a.createAnnotationForPOI(m):new n.Annotation({pos:m.pos})){s.isNew=m.isNew;m.isNew=false}g=s}else g=void 0;g&&d.push(g)}l(d)}catch(q){GRUNT.Log.exception(q)}k.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",
function(){l(d);l(h);k.wakeParent()});return k},Tiler:function(a){a=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,copyright:undefined,zoomLevel:0,boundsChange:null,tapPOI:null,tapHandler:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,onTilesLoaded:null},a);if(typeof a.copyright==="undefined")a.copyright=a.provider?a.provider.getCopyright():"";var l=new TILE5.Vector,d=0,e=a.copyright,h=false,k=[],b=0,f=null,g=null,m=a.zoomLevel,s=a.tapHandler;if(!a.provider)a.provider=
new TILE5.Geo.MapProvider;var q=new TILE5.Tiling.Tiler(GRUNT.extend({},a,{tapHandler:function(o,u){var t=p.getTileLayer(),w=null;if(t){w=p.viewPixToGridPix(new TILE5.Vector(u.x,u.y));var y=t.pixelsToPos(w),x=t.pixelsToPos(TILE5.V.offset(w,-a.tapExtent,a.tapExtent)),B=t.pixelsToPos(TILE5.V.offset(w,a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(t.pixelsToPos(w)));w=new TILE5.Geo.BoundingBox(x,B);k=p.pois.findByBounds(w);a.tapPOI&&a.tapPOI(k)}s&&s(o,u,y,w)},doubleTapHandler:function(o,
u){p.animate(2,TILE5.D.getCenter(p.getDimensions()),new TILE5.Vector(u.x,u.y),TILE5.Animation.Easing.Sine.Out)},onScale:function(o,u){var t=0;o=Math.sqrt(o);if(o<1)t=-(0.5/o);else if(o>1)t=o;p.gotoPosition(p.getXYPosition(u),m+Math.floor(t))}})),p=GRUNT.extend({},q,{pois:a.pois,annotations:null,getBoundingBox:function(){var o=p.getTileLayer(),u=p.getOffset(),t=p.getDimensions();if(o)return o.getBoundingBox(u.x,u.y,t.width,t.height);return null},getCenterPosition:function(){return p.getXYPosition(TILE5.D.getCenter(p.gridDimensions))},
getXYPosition:function(o){return p.getTileLayer().pixelsToPos(p.viewPixToGridPix(o))},gotoBounds:function(o,u){var t=TILE5.Geo.B.getZoomLevel(o,p.getDimensions());p.gotoPosition(TILE5.Geo.B.getCenter(o),t,u)},gotoCurrentPosition:function(o){d=TILE5.Geo.Location.get({watch:true,successCallback:function(u,t){var w=TILE5.Geo.B.createBoundsFromCenter(u,t/1E3);GRUNT.Log.info("detected position: "+TILE5.Geo.P.toString(u)+", accuracy = "+t);p.clearBackground();p.gotoBounds(w,o);p.annotations.clear();p.annotations.add(new n.Annotation({pos:u}))},
errorCallback:function(){GRUNT.Log.info("got position error")}})},gotoPosition:function(o,u,t){var w=m,y=(new Date).getTime(),x=false,B=p.getBoundingBox();if(B){B=TILE5.Geo.B.getCenter(B);B=TILE5.Geo.P.calcDistance(B,o);GRUNT.Log.info("distance between current position and new position = "+B);if(B>100)x=true}m=u?u:m;if(!m)throw"Zoom level required to goto a position.";if(a.provider)m=a.provider.checkZoomLevel(m);if(x||!h||m!==w){TILE5.Resources.resetImageLoadQueue();(u=p.getTileLayer())&&u.deactivate();
TILE5.Animation.cancel();h&&p.freeze();b=y;a.provider.zoomLevel=m;a.provider.getMapTiles(p,o,function(A){if(y===b){p.setTileLayer(A);g=A.getId();p.panToPosition(o,function(){p.unfreeze();t&&t()})}else GRUNT.Log.info("request time mismatch - ignoring update")});h=true}else p.panToPosition(o,t)},panToPosition:function(o,u,t){var w=p.getTileLayer();if(w){o=w.getGridXYForPosition(o);w=p.getDimensions();o.x-=w.width/2;o.y-=w.height/2;if(f)f=null;p.updateOffset(o.x,o.y,t);GRUNT.WaterCooler.say("view.wake",
{id:p.id});a.boundsChange&&a.boundsChange(p.getBoundingBox());u&&u(p)}},setZoomLevel:function(o){p.gotoPosition(p.getCenterPosition(),o)},zoomIn:function(){p.scale(2,TILE5.Animation.Easing.Sine.Out)||p.setZoomLevel(m+1)},zoomOut:function(){p.scale(0.5,TILE5.Animation.Easing.Sine.Out)||p.setZoomLevel(m-1)},animateRoute:function(o,u,t,w){var y=p.getLayer("route");if(y)(o=y.getAnimation(o,u,t,w))&&o.addToView(p)}},q);q=new TILE5.Geo.UI.AnnotationsOverlay({pois:p.pois,map:p,createAnnotationForPOI:a.createAnnotationForPOI});
p.annotations=q;p.setLayer("annotations",q);a.crosshair&&p.setLayer("crosshair",new v);e&&p.setLayer("copyright",new TILE5.Graphics.ViewLayer({zindex:999,draw:function(o,u,t){o.lineWidth=2.5;o.fillStyle="rgb(50, 50, 50)";o.strokeStyle="rgba(255, 255, 255, 0.8)";o.font="bold 10px sans";o.textBaseline="bottom";o.strokeText(e,10,t.height-10);o.fillText(e,10,t.height-10)}}));GRUNT.WaterCooler.listen("view.idle",function(o){if(o.id&&o.id==p.id)if(TILE5.V.absSize(TILE5.V.diff(l,p.getOffset()))>a.boundsChangeThreshold&&
a.boundsChange){l=p.getOffset();a.boundsChange(p.getBoundingBox())}});GRUNT.WaterCooler.listen("tiles.drawn",function(o){o.id&&o.id==g&&a.onTilesLoaded&&a.onTilesLoaded()});return p}};return n}();
