if(!this.JSON)this.JSON={};
(function(){function h(o){return o<10?"0"+o:o}function e(o){d.lastIndex=0;return d.test(o)?'"'+o.replace(d,function(g){var n=l[g];return typeof n==="string"?n:"\\u"+("0000"+g.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+o+'"'}function b(o,g){var n,q,p,t,v=f,k,u=g[o];if(u&&typeof u==="object"&&typeof u.toJSON==="function")u=u.toJSON(o);if(typeof s==="function")u=s.call(g,o,u);switch(typeof u){case "string":return e(u);case "number":return isFinite(u)?String(u):"null";case "boolean":case "null":return String(u);
case "object":if(!u)return"null";f+=m;k=[];if(Object.prototype.toString.apply(u)==="[object Array]"){t=u.length;for(n=0;n<t;n+=1)k[n]=b(n,u)||"null";p=k.length===0?"[]":f?"[\n"+f+k.join(",\n"+f)+"\n"+v+"]":"["+k.join(",")+"]";f=v;return p}if(s&&typeof s==="object"){t=s.length;for(n=0;n<t;n+=1){q=s[n];if(typeof q==="string")if(p=b(q,u))k.push(e(q)+(f?": ":":")+p)}}else for(q in u)if(Object.hasOwnProperty.call(u,q))if(p=b(q,u))k.push(e(q)+(f?": ":":")+p);p=k.length===0?"{}":f?"{\n"+f+k.join(",\n"+f)+
"\n"+v+"}":"{"+k.join(",")+"}";f=v;return p}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+h(this.getUTCMonth()+1)+"-"+h(this.getUTCDate())+"T"+h(this.getUTCHours())+":"+h(this.getUTCMinutes())+":"+h(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var a=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f,m,l={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},s;if(typeof JSON.stringify!=="function")JSON.stringify=function(o,g,n){var q;m=f="";if(typeof n==="number")for(q=0;q<n;q+=1)m+=" ";else if(typeof n==="string")m=n;if((s=g)&&typeof g!=="function"&&(typeof g!=="object"||typeof g.length!=="number"))throw Error("JSON.stringify");return b("",
{"":o})};if(typeof JSON.parse!=="function")JSON.parse=function(o,g){function n(p,t){var v,k,u=p[t];if(u&&typeof u==="object")for(v in u)if(Object.hasOwnProperty.call(u,v)){k=n(u,v);if(k!==undefined)u[v]=k;else delete u[v]}return g.call(p,t,u)}var q;o=String(o);a.lastIndex=0;if(a.test(o))o=o.replace(a,function(p){return"\\u"+("0000"+p.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(o.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){q=eval("("+o+")");return typeof g==="function"?n({"":q},""):q}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(h){if(arguments.length<=1)return h;for(var e=arguments.length-2,b=0;b<=e;b++)h=h.replace(RegExp("\\{"+b+"\\}","gi"),arguments[b+1]);return h};
String.prototype.containsWord=function(h){var e="";if(h.toString)h=h.toString();for(var b=0;b<h.length;b++)e+=!/\w/.test(h[b])?"\\"+h[b]:h[b];return RegExp("(^|\\s|\\,)"+e+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var h=Object.prototype.hasOwnProperty,e=0,b={id:"GRUNT.core",extend:function(){var a=arguments[0]||{},d=1,f=arguments.length,m=false,l,s,o,g;if(typeof a==="boolean"){m=a;a=arguments[1]||{};d=2}if(typeof a!=="object"&&!b.isFunction(a))a={};if(f===d){a=this;--d}for(;d<f;d++)if((l=arguments[d])!=null)for(s in l){o=a[s];g=l[s];if(a!==g)if(m&&g&&(b.isPlainObject(g)||b.isArray(g))){o=o&&(b.isPlainObject(o)||b.isArray(o))?o:b.isArray(g)?[]:{};a[s]=b.extend(m,o,g)}else if(g!==undefined)a[s]=
g}return a},isFunction:function(a){return toString.call(a)==="[object Function]"},isArray:function(a){return toString.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||toString.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!h.call(a,"constructor")&&!h.call(a.constructor.prototype,"isPrototypeOf"))return false;var d;for(d in a);return d===undefined||h.call(a,d)},isEmptyObject:function(a){for(var d in a)return false;return true},isXmlDocument:function(a){return toString.call(a)===
"[object Document]"},contains:function(a,d){var f=a,m=arguments,l=1;if(d&&b.isArray(d)){m=d;l=0}for(l=l;l<m;l++)f=f&&typeof foo[m[l]]!=="undefined";return f},newModule:function(a){a=b.extend({id:null,requires:[],parent:null},a);if(a.parent)a=b.extend({},a.parent,a);return a},toID:function(a){return a.replace(/\s/g,"-")},generateObjectID:function(a){return(a?a:"obj")+e++}};return b}();
GRUNT.Log=function(){function h(f,m){var l,s=m&&m.length>0?m[0]:"";for(l=1;m&&l<m.length;l++)s+=" "+(b&&GRUNT.isPlainObject(m[l])?JSON.stringify(m[l]):m[l]);typeof console!=="undefined"&&console[f](s);for(l=0;l<e.length;l++)e[l].call(d,s,f)}var e=[],b=typeof JSON!=="undefined",a=window.console&&window.console.markTimeline,d={id:"GRUNT.log",getTraceTicks:function(){return a?(new Date).getTime():null},trace:function(f,m){if(a)console.markTimeline(f+(m?": "+(d.getTraceTicks()-m)+"ms":""))},debug:function(){h("debug",
arguments)},info:function(){h("info",arguments)},warn:function(){h("warn",arguments)},error:function(){h("error",arguments)},exception:function(f){d.error(arguments);for(var m in f)d.info("ERROR DETAIL: "+m+": "+f[m])},watch:function(f,m){try{m()}catch(l){d.exception(l,f)}},throwError:function(f){d.error(f);throw Error(f);},requestUpdates:function(f){e.push(f)}};return d}();
GRUNT.Data=function(){var h={determineObjectMapping:function(b){if(!b)return null;b=b.split("|");for(var a={},d=0;d<b.length;d++)a[b[d]]=d;return a},mapLineToObject:function(b,a){var d=b.split("|"),f={};for(var m in a){var l=a[m];f[m]=d.length>l?d[l]:null}return f},parse:function(b){var a=null,d=[];b=b.split("\n");for(var f=0;f<b.length;f++){var m=b[f];if(a)d.push(h.mapLineToObject(m,a));else a=h.determineObjectMapping(m)}return d}},e={supportedFormats:{JSON:{parse:function(b){return JSON.parse(b)}},
PDON:{parse:function(b){return h.parse(b)}}},parse:function(b){b=GRUNT.extend({data:"",format:"JSON"},b);if(!e.supportedFormats[b.format])throw Error("Unsupported data format: "+b.format+", cannot parse data in javascript object");try{return e.supportedFormats[b.format].parse(b.data)}catch(a){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+b.format,b.data);GRUNT.Log.exception(a)}return{}}};return e}();
GRUNT.paramTweaker=function(h,e,b){return function(a,d){if(typeof d!=="undefined"){if(a in h)h[a]=d;b&&a in b&&b[a](a,d)}else return e&&a in e?e[a](a):h[a]}};
GRUNT.configurable=function(h,e,b,a){function d(f){h[f]||(h[f]=function(m){return h.configure(f,m)})}if(h){if(!h.configurableSettings){h.configurableId=GRUNT.generateObjectID("configurable");h.configurableSettings={};h.configCallbacks=[];if(!GRUNT.configurables)GRUNT.configurables={}}GRUNT.configurables[h.configurableId]=h;h.configCallbacks.push(b);for(b=e.length;b--;){h.configurableSettings[e[b]]=true;a&&d(e[b])}if(!h.configure)h.configure=function(f,m){var l=h.configCallbacks;if(h.configurableSettings[f]){for(var s=
l.length;s--;){var o=l[s](f,m);if(typeof o!=="undefined")return o}return GRUNT.configurables[h.configurableId]}return null}}};GRUNT.Template=function(){var h=/\$\{(.*?)\}/ig;return{parse:function(e,b){for(var a=e,d=h.exec(a);d;){a=a.replace(d[0],GRUNT.XPath.first(d[1],b));h.lastIndex=0;d=h.exec(a)}return a}}}();
GRUNT.JSONP=function(){function h(d){var f=document.createElement("script"),m=false;f.src=d;f.async=true;f.onload=f.onreadystatechange=function(){if(!m&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){m=true;f.onload=f.onreadystatechange=null;f&&f.parentNode&&f.parentNode.removeChild(f)}};b||(b=document.getElementsByTagName("head")[0]);b.appendChild(f)}var e=0,b,a=this;return{get:function(d,f,m){d+=d.indexOf("?")>=0?"&":"?";var l="json"+ ++e;a[l]=function(s){f(s);a[l]=
null;try{delete a[l]}catch(o){}};h(d+(m?m:"callback")+"="+l);return l}}}();
GRUNT.XHR=function(){var h={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},e={JSON:["json"],PDON:["pdon.txt"]},b=["TEXT","STREAM"],a=/^(\w+:)?\/\/([^\/?#]+)/,d={XML:function(l){return l.responseXML},JSON:function(l){try{return JSON.parse(l.responseText)}catch(s){GRUNT.Log.error("Error parsing JSON data: ",l.responseText);GRUNT.Log.exception(s)}return""},PDON:function(l){return GRUNT.Data.parse({data:l.responseText,format:"PDON"})},DEFAULT:function(l){return l.responseText}},
f={CONTENT_TYPE:"Content-Type"},m=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(l){try{l=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},m.ajaxSettings,l);var s=a.exec(l.url),o=s&&(s[1]&&s[1]!==location.protocol||s[2]!==location.host);if(l.data)l.method="POST";if(l.url){s=null;if(l.xhr)s=l.xhr(l);s||(s=new XMLHttpRequest);s.open(l.method,l.url,l.async);l.data&&s.setRequestHeader("Content-Type",
l.contentType);o||s.setRequestHeader("X-Requested-With","XMLHttpRequest");s.onreadystatechange=function(){if(this.readyState===4){var n=null,q=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(q)if(l.handleResponse)l.handleResponse(this);else{var p=l,t=this.getResponseHeader(f.CONTENT_TYPE),v,k=false;for(v in h)if(t&&t.indexOf(h[v])>=0){k=true;break}t=!k;for(k=0;k<b.length;k++)t=t||b[k]==v;if(t)b:{t=v;for(var u in e)for(k=
0;k<e[u].length;k++)if(RegExp(e[u][k]+"$","i").test(p.url)){v=u;break b}v=t?t:"DEFAULT"}try{n=d[v](this,p)}catch(r){GRUNT.Log.warn("error applying processor '"+v+"' to response type, falling back to default");n=d.DEFAULT(this,p)}}else l.error&&l.error(this)}catch(w){GRUNT.Log.exception(w,"PROCESSING AJAX RESPONSE")}q&&n&&l.success&&l.success.call(this,n)}};s.send(l.method=="POST"?m.param(l.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(g){GRUNT.Log.exception(g)}},
param:function(l){var s=[],o=function(n,q){q=GRUNT.isFunction(q)?q():q;s[s.length]=encodeURIComponent(n)+"="+encodeURIComponent(q)};if(GRUNT.isArray(l))for(var g=0;g<l.length;g++)o(l[g].name,l[g].value);else for(g in l)o(g,l[g]);return s.join("&").replace(/%20/g,"+")}});return m}();
GRUNT.XPath=function(){function h(d){for(var f=null,m=0;m<e.length;m++)if(f=e[m](d))break;return f}var e=[],b=[null,function(d){return d.numberValue},function(d){return d.stringValue},function(d){return d.booleanValue},null,null,null,null,function(d){return d.singleNodeValue?d.singleNodeValue.textContent:null},function(d){return d.singleNodeValue?d.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var a={SearchResult:function(d){return{toString:function(){var f=
null;if(d){var m=null;if(d.resultType>=0&&d.resultType<b.length)m=b[d.resultType];if(m){GRUNT.Log.info("invoking match handler for result type: "+d.resultType);f=m(d)}}return f?f:""}}},first:function(d,f){var m=a.SearchResult,l;var s=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!s)s=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(f))l=f.evaluate(d,f,h,s,null);else{GRUNT.Log.warn("attempted xpath expression: "+d+" on a non-xml document");l=null}}catch(o){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
d+" on node: "+f);l=null}return new m(l)},registerResolver:function(d){e.push(d)}};return a}();
GRUNT.observable=function(h){if(h){if(!h.observableHandlers)h.observableHandlers={};if(!(h.bind||h.trigger||h.unbind)){h.bind=function(e,b){var a=GRUNT.generateObjectID("callback"),d=h.observableHandlers;d[e]||(d[e]=[]);h.observableHandlers[e].push({callback:b,callbackId:a});return a};h.trigger=function(e){var b=h.observableHandlers[e];if(!b)return h;for(var a=b.length;a--;)b[a].callback.apply(self,Array.prototype.slice.call(arguments,1));return h};h.unbind=function(e,b){for(var a=h.observableHandlers[e],
d=0;a&&d<a.length;d++)if(a[d].callbackId===b){a.splice(d,1);break}return h}}}};GRUNT.WaterCooler=function(){var h={},e=[];return{addPipe:function(b){b("pipe.test",{});e.push(b)},listen:function(b,a){h[b]||(h[b]=[]);a&&h[b].push(a)},say:function(b,a){var d;for(d=e.length;d--;)e[d](b,a);if(h[b])for(d=h[b].length;d--;)h[b][d](a)},leave:function(){}}}();
GRUNT.Storage=function(){function h(e){if(e&&e=="session")return sessionStorage;return localStorage}return{get:function(e,b){var a=h(b).getItem(e);return/^(\{|\[).*(\}|\])$/.test(a)?JSON.parse(a):a},set:function(e,b,a){b=jQuery.isArray(b)||jQuery.isPlainObject(b)?JSON.stringify(b):b;h(a).setItem(e,b)},remove:function(e,b){h(b).removeItem(e)}}}();
T5=function(){var h={ex:GRUNT.extend,newCanvas:function(e,b){var a=document.createElement("canvas");typeof G_vmlCanvasManager!=="undefined"&&G_vmlCanvasManager.initElement(a);a.width=e?e:0;a.height=b?b:0;return a},time:function(){return(new Date).getTime()},Settings:function(){var e={};return{get:function(b){return e[b]},set:function(b,a){e[b]=a},extend:function(b){T5.ex(e,b)}}}(),Vector:function(e,b){return{x:e?e:0,y:b?b:0}},V:function(){function e(b){if(!b||b.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");
for(var a={edges:Array(b.length-1),accrued:Array(b.length-1),total:0},d=T5.V.diff,f=0;f<b.length-1;f++){var m=d(b[f],b[f+1]);a.edges[f]=Math.sqrt(m.x*m.x+m.y*m.y);a.accrued[f]=a.total+a.edges[f];a.total+=a.edges[f]}return a}return{create:function(b,a){return new h.Vector(b,a)},add:function(){for(var b=new h.Vector,a=arguments.length;a--;){b.x+=arguments[a].x;b.y+=arguments[a].y}return b},absSize:function(b){return Math.max(Math.abs(b.x),Math.abs(b.y))},diff:function(b,a){return new h.Vector(b.x-a.x,
b.y-a.y)},copy:function(b){return b?new h.Vector(b.x,b.y):null},invert:function(b){return new T5.Vector(-b.x,-b.y)},offset:function(b,a,d){return new T5.Vector(b.x+a,b.y+(d?d:a))},edges:e,distance:function(b){return e(b).total},theta:function(b,a,d){d=Math.asin((b.y-a.y)/d);return b.x>a.x?d:Math.PI-d},pointOnEdge:function(b,a,d,f){a=new T5.Vector(Math.cos(d)*f,Math.sin(d)*f);return new T5.Vector(b.x-a.x,b.y-a.y)},getRect:function(b){var a=b.length;if(a>1)return new T5.Rect(Math.min(b[0].x,b[a-1].x),
Math.min(b[0].y,b[a-1].y),Math.abs(b[0].x-b[a-1].x),Math.abs(b[0].y-b[a-1].y))},toString:function(b){return b.x+", "+b.y}}}(),Dimensions:function(e,b){return{width:e?e:0,height:b?b:0}},D:function(){return{getAspectRatio:function(e){return e.height!==0?e.width/e.height:1},getCenter:function(e){return new h.Vector(e.width/2,e.height/2)},getSize:function(e){return Math.sqrt(Math.pow(e.width,2)+Math.pow(e.height,2))}}}(),Rect:function(e,b,a,d){return{origin:new h.Vector(e,b),dimensions:new h.Dimensions(a,
d)}},R:function(){return{copy:function(e){return e?new h.Rect(e.origin.x,e.origin.y,e.dimensions.width,e.dimensions.height):null},getCenter:function(e){return new T5.Vector(e.origin.x+e.dimensions.width/2,e.origin.y+e.dimensions.height/2)}}}()};return h}();
T5.Device=function(){function h(){for(;g.length>0;){var q=g.shift();document.location=q}o=0}function e(q){for(var p=true,t=n.length;t--;)p=p&&q!=n[t];return p}function b(q,p){var t=[];for(var v in p)v&&t.push(v+"="+escape(p[v]));return"tile5://"+q+"/"+(t.length>0?"?"+t.join("&"):"")}function a(q,p){e(q)&&GRUNT.Log.info("would push url: "+b(q,p))}function d(q,p){if(e(q)){g.push(b(q,p));o||(o=setTimeout(h,100))}}function f(){m={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:null,getScaling:function(){return 1},maxImageLoads:null,requireFastDraw:false,bridgeNotify:a,targetFps:null},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:false,bridgeNotify:d,targetFps:25},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:d},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:d},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,
supportsTouch:true,getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:d},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:d}};l=[m.froyo,m.android,m.ipod,m.iphone,m.ipad]}var m=null,l=[],s=null,o=0,g=[],n=["view.wake","tile.loaded"];return{getConfig:function(){m||f();if(!s){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var q=0;q<l.length;q++){var p=l[q];if(p.regex&&p.regex.test(navigator.userAgent)){s=
T5.ex({},m.base,p);GRUNT.Log.info("PLATFORM DETECTED AS: "+s.name);break}}if(!s){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");s=m.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return s}}}();
T5.Resources=function(){var h="",e={},b=function(){function d(){var r=o[this.id];if(r&&r.image.complete&&r.image.width>0){r.loaded=true;r.hitCount=1;for(var w=q.length;w--;)if(q[w].image.src==this.src){q.splice(w,1);break}if(r.background||r.postProcess)if(r.image){w=T5.newCanvas(r.realSize?r.realSize.width:image.width,r.realSize?r.realSize.height:image.height);var x=w.getContext("2d"),z=r.offset?r.offset:new T5.Vector;r.background&&x.drawImage(r.background,0,0);x.drawImage(r.image,z.x,z.y);r.postProcess&&
r.postProcess(x,r);r.image=w}r.loadCallback&&r.loadCallback(this,false);p.push({url:this.src,created:r.requested});delete o[this.id];f()}}function f(){for(var r=T5.Device.getConfig().maxImageLoads;n.length>0&&(!r||q.length<r);){var w=n.shift();if(w.imageLoader){q.push(w);w.imageLoader(w,d)}}}function m(r){for(var w=null,x=t.length;x--&&!w;)w=t[x](r);return w?w:function(z,F){z.image.onload=F;z.image.src=a.getPath(z.url);z.requested=T5.time()}}function l(){k=true;try{var r=Math.floor(p.length/2);if(r>
0){p.sort(function(x,z){return x.created-z.created});for(var w=r;w--;)delete s[p[w].url];p.splice(0,r)}}finally{k=false}GRUNT.WaterCooler.say("imagecache.cleared")}var s={},o={},g=0,n=[],q=[],p=[],t=[],v=0,k=false,u={loadingImages:q,queuedImages:n,addInterceptor:function(r){t.push(r)},getCacheFullness:function(){return v},getImage:function(r){var w=null,x=null;k||(w=s[r]);if((x=w?w.image:null)&&(x.getContext||x.complete&&x.width>0))return x},loadImage:function(r,w,x){var z=s[r];if(z){z.hitCount++;
z.image.complete&&w&&w(z.image,true)}else{z=T5.ex({url:r,image:new Image,loaded:false,imageLoader:m(r),created:T5.time(),requested:null,hitCount:0,loadCallback:w},x);z.image.id="resourceLoaderImage"+g++;s[r]=z;o[z.image.id]=z;n.push(z);f()}return z},resetLoadingQueue:function(){q=[]}};setInterval(function(){for(var r=T5.time(),w=false,x=0,z=T5.Device.getConfig();x<q.length;)if(r-q[x].requested>a.loadTimeout*1E3){q.splice(x,1);w=true}else x++;w&&f();if(z&&z.imageCacheMaxSize){v=p.length*a.avgImageSize/
z.imageCacheMaxSize;v>=1&&l()}},1E3);return u}(),a={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(d,f){for(var m=(d?d.replace(/^.*\?/,""):"").split("&"),l=d?d.replace(/\?.*$/,"?"):"",s=0;s<m.length;s++){var o=m[s].split("=");if(!f||!f.test(o[0]))l+=m[s]+"&"}return l.replace(/\W/g,"")},isValidCacheKey:function(d){GRUNT.Log.info("cache key = "+d);return false}}}(),addInterceptor:b.addInterceptor,getPath:function(d){return/^(file|https?|\/)/.test(d)?
d:h+d},setBasePath:function(d){h=d},getImage:function(d){return b.getImage(d)},loadImage:function(){b.loadImage.apply(null,arguments)},resetImageLoadQueue:function(){b.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:b.loadingImages.length,queuedImageCount:b.queuedImages.length,imageCacheFullness:b.getCacheFullness()}},loadResource:function(d){d=T5.ex({filename:"",cacheable:true,dataType:null,callback:null},d);var f=function(m){d.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",
function(){d.callback(m)})};d.cacheable&&e[d.filename]?f(e[d.filename]):GRUNT.XHR.ajax({url:a.getPath(d.filename),dataType:d.dataType,success:function(m){if(d.cacheable)e[d.filename]=m;f(m)},error:function(m,l,s){GRUNT.Log.error("error loading resource ["+d.filename+"], error = "+s)}})},loadSnippet:function(d,f){/\.\w+$/.test(d)||(d+=".html");a.loadResource({filename:"snippets/"+d,callback:f,dataType:"html"})}};return a}();
T5.Touch=function(){function h(p,t){var v=p&&p.length>0?p[0]:null;if(v&&t&&t.length>0)return T5.V.diff(v,t[0]);return null}function e(p){p.preventDefault();p.stopPropagation()}function b(p){for(var t=Array(p.length),v=p.length;v--;)t[v]=new T5.Vector(p[v].pageX,p[v].pageY);return t}function a(p){return[new T5.Vector(p.pageX,p.pageY)]}var d=120,f=100,m=250,l={TAP:0,MOVE:1,PINCHZOOM:2},s=7,o=0,g=0,n=function(p){function t(A,C,H,D){var P=Math.asin((A.y-C.y)/H);H=Math.min(Math.floor(H*(Z.duration/D)),
Z.max);P=C.x>A.x?P:Math.PI-P;A=new T5.Vector(Math.cos(P)*-H,Math.sin(P)*H);u("inertiaPan",A.x,A.y)}function v(A,C){var H,D;if(M){H=C-$;if(H<m){D=T5.V.distance([G[0],A]);D>p.inertiaTrigger&&t(G[0],A,D,H)}}else{R=A;var P=setInterval(function(){H=T5.time()-C;D=T5.V.distance([A,R]);if(H<f&&D>p.inertiaTrigger){clearInterval(P);t(A,R,D,H)}else H>f&&clearInterval(P)},5)}}function k(A){for(var C=[],H=p.element?-p.element.offsetLeft:0,D=p.element?-p.element.offsetTop:0,P=A.length;P--;)C.push(T5.V.offset(A[P],
H,D));return C}function u(){p.observable&&p.observable.trigger.apply(null,arguments)}function r(A){if(A.target&&A.target===p.element){G=M?b(A.touches):a(A);O=new T5.Vector;T=new T5.Vector;X=true;F=false;$=T5.time();M&&e(A);u("inertiaCancel");V.current=$;if(A=G.length>0?G[0]:null){u("touchStart",A.x,A.y);if(V.current-V.last<fa.THRESHOLD_DOUBLETAP)if((A=U?T5.V.diff(G[0],U[0]):null)&&Math.abs(A.x)<p.maxDistDoubleTap&&Math.abs(A.y)<p.maxDistDoubleTap)F=true;S=l.TAP;U=[].concat(G)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}
function w(A){if(A.target&&A.target===p.element){R=(M?b(A.touches):a(A))[0];if(X)try{M&&e(A);var C=M?b(A.touches):a(A);A=0;if(C.length>1){if(G.length===1)G=[].concat(C);A=T5.V.distance(G)-T5.V.distance(C)}if(S===l.TAP){var H=h(C,G);if(H&&(Math.abs(H.x)>=s||Math.abs(H.y)>=s))S=l.MOVE}if(S!==l.TAP)if(!A||Math.abs(A)<p.pinchZoomThreshold){if(O=h(C,U)){T.x-=O.x;T.y-=O.y;K.x-=O.x;K.y-=O.y}if(T5.V.absSize(K)>p.panEventThreshhold){u("pan",K.x,K.y);K=T5.V.create()}S=l.MOVE}else{u("pinchZoom",k(G),k(C));S=
l.PINCHZOOM}U=[].concat(C)}catch(D){GRUNT.Log.exception(D)}}}function x(A){if(A.target&&A.target===p.element){var C=(M?b(A.changedTouches):a(A))[0];try{M&&e(A);var H=T5.time();V.last=V.current;if(S===l.TAP)L||(L=setTimeout(function(){L=0;var P=F?"doubleTap":"tap",ba=G[0],Y=null;if(p.element)Y=T5.V.offset(ba,-p.element.offsetLeft,-p.element.offsetTop);u(P,ba,Y)},fa.THRESHOLD_DOUBLETAP+50));else if(S==l.MOVE){u("panEnd",T.x,T.y);Z&&v(C,H)}else S==l.PINCHZOOM&&u("pinchZoomEnd",k(G),k(U),H-$)}catch(D){GRUNT.Log.exception(D)}}X=
false}function z(A){if(A.target&&A.target===p.element){var C;if(A.detail){C=-A.detail*d;C=new T5.Vector(A.axis===1?C:0,A.axis===2?C:0)}else C=new T5.Vector(A.wheelDeltaX,A.wheelDeltaY);var H=C.y!==0?Math.abs(C.y/d):0;if(R&&H!==0){var D=T5.V.offset(R,-p.element.offsetLeft,-p.element.offsetTop);u("wheelZoom",D,Math.pow(2,C.y>0?H:-H))}A.preventDefault()}}p=T5.ex({element:null,observable:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,
moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},p);var F=false,L=0,M=T5.Device.getConfig().supportsTouch,G=null,U=null,O=null,T=null,K=new T5.Vector,S=null,X=false,$=0,aa=[],R=null,Z=null,V={current:0,last:0},N=T5.Device.getConfig(),fa={supportsTouch:M,THRESHOLD_DOUBLETAP:300,addListeners:function(A){aa.push(A)},decoupleListeners:function(A){for(var C=0;A&&C<aa.length;C++)if(aa[C].listenerId===A){aa.splice(C,1);GRUNT.Log.info("successfully decoupled touch listener: "+
A);break}},release:function(){N.eventTarget.removeEventListener(N.supportsTouch?"touchstart":"mousedown",r,false);N.eventTarget.removeEventListener(N.supportsTouch?"touchmove":"mousemove",w,false);N.eventTarget.removeEventListener(N.supportsTouch?"touchend":"mouseup",x,false);if(!N.supportsTouch){window.removeEventListener("mousewheel",z,false);window.removeEventListener("DOMMouseScroll",z,false)}},inertiaEnable:function(A,C){Z={duration:A,max:C?Math.min(C.width,C.height):500}},inertiaDisable:function(){Z=
null}};N.eventTarget.addEventListener(N.supportsTouch?"touchstart":"mousedown",r,false);N.eventTarget.addEventListener(N.supportsTouch?"touchmove":"mousemove",w,false);N.eventTarget.addEventListener(N.supportsTouch?"touchend":"mouseup",x,false);if(!N.supportsTouch){window.addEventListener("mousewheel",z,false);window.addEventListener("DOMMouseScroll",z,false)}return fa},q=[];return{capture:function(p,t){if(!p)throw Error("Unable to capture touch of null element");if(!p.id)p.id="touchable_"+o++;var v=
q[p.id];if(!v){v=new n(T5.ex({element:p},t));q[p.id]=v;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+v.supportsTouch)}t.listenerId&&v.decoupleListeners(t.listenerId);t.listenerId=++g;v.addListeners(t);return v},resetTouch:function(p){if(p&&p.id&&q[p.id]){q[p.id].release();delete q[p.id]}}}}();if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(h){return this.each(function(){T5.Touch.capture(this,h)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(h){h.preventDefault()})}}
T5.Dispatcher=function(){var h=[],e={execute:function(b){var a=e.findAction(b);GRUNT.Log.info("looking for action id: "+b+", found: "+a);if(a){var d=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+b,function(){a.execute(d)})}},findAction:function(b){for(var a=h.length;a--;)if(h[a].id==b)return h[a];return null},getRegisteredActions:function(){return[].concat(h)},getRegisteredActionIds:function(){for(var b=[],a=h.length;a--;)h[a].id&&b.push(h[a].id);return b},registerAction:function(b){b&&
b.id&&h.push(b)},Action:function(b){b=T5.ex({autoRegister:true,id:"",title:"",icon:"",execute:null},b);var a={id:b.id,execute:function(){b.execute&&b.execute.apply(this,arguments)},getParam:function(d){return b[d]?b[d]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",a.id,b.title,b.icon)}};b.autoRegister&&e.registerAction(a);return a},Agent:function(b){b=GRUNT.extend({name:"Untitled",translator:null,execute:null},b);var a={getName:function(){return b.name},getParam:function(d){return b[d]},
getId:function(){return GRUNT.toID(a.getName())},run:function(d,f){if(b.execute){var m=b.translator?b.translator(d):d;b.execute.call(a,m,function(l,s){f&&f(l,s,m)})}}};return a},runAgents:function(b,a,d){for(var f=0;f<b.length;f++)b[f].run(a,d)}};return e}();
T5.Easing=function(){var h=1.70158;return{Linear:function(e,b,a,d){return a*e/d+b},Back:{In:function(e,b,a,d){return a*(e/=d)*e*((h+1)*e-h)+b},Out:function(e,b,a,d){return a*((e=e/d-1)*e*((h+1)*e+h)+1)+b},InOut:function(e,b,a,d){return(e/=d/2)<1?a/2*e*e*(((h*=1.525)+1)*e-h)+b:a/2*((e-=2)*e*(((h*=1.525)+1)*e+h)+2)+b}},Bounce:{In:function(e,b,a,d){return a-module.Easing.Bounce.Out(d-e,0,a,d)+b},Out:function(e,b,a,d){return(e/=d)<1/2.75?a*7.5625*e*e+b:e<2/2.75?a*(7.5625*(e-=1.5/2.75)*e+0.75)+b:e<2.5/
2.75?a*(7.5625*(e-=2.25/2.75)*e+0.9375)+b:a*(7.5625*(e-=2.625/2.75)*e+0.984375)+b},InOut:function(e,b,a,d){return e<d/2?module.Easing.Bounce.In(e*2,0,a,d)/2+b:module.Easing.Bounce.Out(e*2-d,0,a,d)/2+a/2+b}},Cubic:{In:function(e,b,a,d){return a*(e/=d)*e*e+b},Out:function(e,b,a,d){return a*((e=e/d-1)*e*e+1)+b},InOut:function(e,b,a,d){if((e/=d/2)<1)return a/2*e*e*e+b;return a/2*((e-=2)*e*e+2)+b}},Elastic:{In:function(e,b,a,d,f,m){if(e==0)return b;if((e/=d)==1)return b+a;m||(m=d*0.3);if(!f||f<Math.abs(a)){f=
a;a=m/4}else a=m/(2*Math.PI)*Math.asin(a/f);return-(f*Math.pow(2,10*(e-=1))*Math.sin((e*d-a)*2*Math.PI/m))+b},Out:function(e,b,a,d,f,m){var l;if(e==0)return b;if((e/=d)==1)return b+a;m||(m=d*0.3);if(!f||f<Math.abs(a)){f=a;l=m/4}else l=m/(2*Math.PI)*Math.asin(a/f);return f*Math.pow(2,-10*e)*Math.sin((e*d-l)*2*Math.PI/m)+a+b},InOut:function(e,b,a,d,f,m){var l;if(e==0)return b;if((e/=d/2)==2)return b+a;m||(m=d*0.3*1.5);if(!f||f<Math.abs(a)){f=a;l=m/4}else l=m/(2*Math.PI)*Math.asin(a/f);if(e<1)return-0.5*
f*Math.pow(2,10*(e-=1))*Math.sin((e*d-l)*2*Math.PI/m)+b;return f*Math.pow(2,-10*(e-=1))*Math.sin((e*d-l)*2*Math.PI/m)*0.5+a+b}},Quad:{In:function(e,b,a,d){return a*(e/=d)*e+b},Out:function(e,b,a,d){return-a*(e/=d)*(e-2)+b},InOut:function(e,b,a,d){if((e/=d/2)<1)return a/2*e*e+b;return-a/2*(--e*(e-2)-1)+b}},Sine:{In:function(e,b,a,d){return-a*Math.cos(e/d*(Math.PI/2))+a+b},Out:function(e,b,a,d){return a*Math.sin(e/d*(Math.PI/2))+b},InOut:function(e,b,a,d){return-a/2*(Math.cos(Math.PI*e/d)-1)+b}}}}();
T5.Animation=function(){function h(){if(a===0)a=setInterval(function(){var f;f=T5.time();if(!b){b=true;try{for(var m=0;m<e.length;)if(e[m].isComplete()){e[m].triggerComplete(false);e.splice(m,1)}else{e[m].update(f);m++}}finally{b=false}}f=e.length;if(f===0){clearInterval(a);a=0}},20)}var e=[],b=false,a=0,d={DURATION:2E3,tweenValue:function(f,m,l,s,o){f=new d.Tween({startValue:f,endValue:m,tweenFn:l,complete:s,duration:o});e.push(f);return f},tween:function(f,m,l,s,o,g){f=new d.Tween({target:f,property:m,
endValue:l,tweenFn:s,duration:g,complete:o});e.push(f);return f},tweenVector:function(f,m,l,s,o,g){var n=[];if(f){var q=f.x==m,p=f.y==l;q||n.push(d.tween(f,"x",m,s,function(){(q=true)&&p&&o()},g));p||n.push(d.tween(f,"y",l,s,function(){p=true;q&&p&&o()},g))}return n},cancel:function(f){if(!b){b=true;try{for(var m=0;m<e.length;)if(!f||f(e[m])){e[m].triggerComplete(true);e.splice(m,1)}else m++}finally{b=false}}},isTweening:function(){return e.length>0},Tween:function(f){f=T5.ex({target:null,property:null,
startValue:0,endValue:null,duration:d.DURATION,tweenFn:d.DEFAULT,complete:null,cancelOnInteract:false},f);var m=T5.time(),l=[],s=false,o=0,g=0,n={cancelOnInteract:f.cancelOnInteract,isComplete:function(){return s},triggerComplete:function(q){f.complete&&f.complete(q)},update:function(q){try{var p=f.tweenFn(q-m,o,g,f.duration);if(f.target)f.target[f.property]=p;for(var t=l.length;t--;)l[t](p,void 0);if(s=m+f.duration<=q){if(f.target)f.target[f.property]=f.tweenFn(f.duration,o,g,f.duration);for(var v=
l.length;v--;)l[v](p,true)}}catch(k){GRUNT.Log.exception(k)}},requestUpdates:function(q){l.push(q)}};o=f.target&&f.property&&f.target[f.property]?f.target[f.property]:f.startValue;if(typeof f.endValue!=="undefined")g=f.endValue-o;if(g==0)s=true;h();return n}};return T5.ex(d,{DEFAULT:T5.Easing.Back.Out})}();T5.ViewState=function(){var h={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128,get:function(){for(var e=0,b=arguments.length;b--;){var a=h[arguments[b]];if(a)e|=a}return e}};return h}();
T5.ViewLayer=function(h){h=T5.ex({id:"",centerOnScale:true,created:T5.time(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:T5.ViewState.get("ACTIVE","ANIMATING","PAN","PINCHZOOM")},h);var e=null,b=h.id,a=T5.ViewState.get("ACTIVE"),d=T5.ex({addToView:function(f){f.setLayer(b,d)},shouldDraw:function(f){var m=e?e.fastDraw&&f!==a:false;return(f&h.validStates)!==0&&(m?h.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",
{id:b})},wakeParent:function(){e&&e.trigger("wake")},getId:function(){return b},setId:function(f){b=f},getParent:function(){return e},setParent:function(f){e=f}},h);return d};
T5.View=function(h){function e(y,B,E,J){X=typeof E!=="undefined";I.updateOffset(x.x+y,x.y+B,E,J);k();W=T5.ViewState.PAN}function b(y,B){h.inertia&&e(y,B,h.panAnimationEasing,h.panAnimationDuration)}function a(){W=T5.ViewState.ACTIVE;X=false;setTimeout(k,50)}function d(y,B){C=T5.V.getRect(y);H=T5.V.getRect(B);var E=T5.D.getSize(C.dimensions),J=T5.D.getSize(H.dimensions);Y=T5.R.getCenter(C);K=T5.R.getCenter(H);D=C&&E!==0?J/E:1}function f(y,B){d(y,B);if(A=D!==1){W=T5.ViewState.PINCHZOOM;k()}}function m(y,
B,E){d(y,B);if(h.adjustScaleFactor){D=h.adjustScaleFactor(D);GRUNT.Log.info("scale factor adjusted to: "+D)}if(E<h.pinchZoomAnimateTrigger){n(P,D,Y,q(),T5.Easing.Sine.Out,function(){s();D=1},300);D=P}else{s();D=1}}function l(y,B){I.zoom(y,Math.min(Math.pow(2,Math.round(Math.log(B))),8),500)}function s(){GRUNT.WaterCooler.say("view.scale",{id:I.id});A=false;I.trigger("scale",D,C?q():K);W=T5.ViewState.ACTIVE;k()}function o(){if(r){T5.Touch.resetTouch(r);if(h.autoSize){r.height=window.innerHeight-r.offsetTop;
r.width=window.innerWidth-r.offsetLeft}try{w=r.getContext("2d");w.globalCompositeOperation=h.initialDrawMode;w.clearRect(0,0,r.width,r.height)}catch(y){GRUNT.Log.exception(y);throw Error("Could not initialise canvas on specified view element");}ha=T5.Touch.capture(r,{observable:I});h.inertia&&ha.inertiaEnable(h.panAnimationDuration,G);G=I.getDimensions();U=T5.D.getCenter(G);k()}}function g(y,B){B.setId(y);B.setParent(I);u.push(B);u.sort(function(E,J){var Q=J.zindex-E.zindex;if(Q===0)Q=J.created-E.created;
return Q})}function n(y,B,E,J,Q,ea,ca){function ga(){ea&&ea();s();D=1;ba=null}A=true;Y=T5.V.copy(E);K=T5.V.copy(J);C=null;if(Q)T5.Animation.tweenValue(0,B-y,Q,ga,ca?ca:1E3).requestUpdates(function(da){ba=da/(B-y);D=y+da;W=T5.ViewState.PINCHZOOM;k();I.trigger("animate")});else{D=targetScaleFactor;ga()}}function q(){var y=T5.D.getCenter(G),B=T5.V.distance([K,y]),E=T5.V.theta(K,y,B),J=T5.V.diff(Y,K);y=T5.V.pointOnEdge(K,y,E,B/D);y.x+=J.x;y.y+=J.y;return y}function p(){I.trigger("idle");S=true;R=0}function t(y,
B){var E=0,J=I.getDisplayState(),Q=T5.time(),ea=(J&T5.ViewState.PINCHZOOM)!==0,ca=0;if(z||ea){y.clearRect(0,0,r.width,r.height);z=false}if(ea){T5.D.getCenter(G);var ga=(ba?ba:1)/2,da=T5.V.diff(Y,K);if(V=C?new T5.Vector(K.x+da.x,K.y+da.y):new T5.Vector(K.x-da.x*ga,K.y-da.y*ga))B=T5.V.offset(B,V.x,V.y)}y.save();try{P=D;if(M!==1)y.scale(M,M);else if(ea){y.translate(K.x,K.y);y.scale(D,D)}for(ca=u.length;ca--;)if(u[ca].shouldDraw(J)){var ia=u[ca].draw(y,B,G,J,I);E+=ia?ia:0}}finally{y.restore()}GRUNT.Log.trace("draw complete",
Q);aa=false;return E}function v(){var y=0,B=!X&&(W===T5.ViewState.PINCHZOOM||W===T5.ViewState.PAN);N=T5.time();x.x=Math.floor(x.x);x.y=Math.floor(x.y);T&&F&&T.delays.push(N-F);if(B){T5.Animation.cancel(function(J){return J.cancelOnInteract});S=false;if(R!==0){clearTimeout(R);R=0}}for(B=u.length;B--;){var E=u[B].cycle(N,x,W);y+=E?E:0}if(F+fa<N){y+=t(w,x);F=N}$=0;if(O+y>0)k();else if(!S&&R===0)R=setTimeout(p,500);GRUNT.Log.trace("Completed draw cycle",N)}function k(){O++;if(!(L||$!==0)){O=0;$=setTimeout(v,
0)}}h=T5.ex({id:GRUNT.generateObjectID("view"),container:"",clearOnDraw:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,inertia:true,pannable:true,scalable:true,panAnimationEasing:T5.Easing.Sine.Out,panAnimationDuration:750,pinchZoomAnimateTrigger:400,adjustScaleFactor:null,autoSize:false},h);var u=[],r=document.getElementById(h.container),w=null,x=new T5.Vector,z=false,F=null,L=false,M=1,G=null,U=null,O=
0,T=null,K=null,S=false,X=false,$=0,aa=false,R=0,Z=0,V=null,N=0;T5.Device.getConfig();var fa=0,A=false,C=null,H=null,D=1,P=1,ba=null,Y=null,ha=null,W=T5.ViewState.ACTIVE,I={id:h.id,deviceScaling:M,fastDraw:h.fastDraw||T5.Device.getConfig().requireFastDraw,animate:function(y,B,E,J,Q){n(D,y,B,E,J,Q)},centerOn:function(y){I.setOffset(y.x-r.width/2,y.y-r.height/2)},getDimensions:function(){if(r)return new T5.Dimensions(r.width,r.height)},getZoomCenter:function(){return V},getLayer:function(y){for(var B=
0;B<u.length;B++)if(u[B].getId()==y)return u[B];return null},setLayer:function(y,B){for(var E=0;E<u.length;E++)if(u[E].getId()===y){u.splice(E,1);break}B&&g(y,B);GRUNT.WaterCooler.say("layer.update",{id:y});k()},eachLayer:function(y){for(var B=0;B<u.length;B++)y(u[B])},clearBackground:function(){z=true},freeze:function(){L=true},unfreeze:function(){L=false;k()},needRepaint:function(){return aa},snapshot:function(){},getDisplayState:function(){return L?T5.ViewState.FROZEN:W},scale:function(y,B,E,J,
Q){J||(J=T5.D.getCenter(G));Q||(Q=T5.D.getCenter(G));I.animate(y,J,Q,B,E);return I},removeLayer:function(y){a:{for(var B=u.length;B--;)if(u[B].getId()==y){y=B;break a}y=-1}if(y>=0&&y<u.length){GRUNT.WaterCooler.say("layer.removed",{layer:u[y]});u.splice(y,1)}},getOffset:function(){return T5.V.copy(x)},setOffset:function(y,B){x.x=y;x.y=B},updateOffset:function(y,B,E,J){function Q(){a(0,0)}if(E){y=new T5.Vector(y,B);E=T5.Animation.tweenVector(x,y.x,y.y,E,Q,J);for(J=E.length;J--;){E[J].cancelOnInteract=
true;E[J].requestUpdates(function(){k();h.onAnimate&&h.onAnimate(x.x,x.y)})}}else I.setOffset(y,B)},zoom:function(y,B,E){X=false;D=B;A=D!==1;Y=T5.D.getCenter(I.getDimensions());K=D>1?T5.V.copy(y):T5.D.getCenter(I.getDimensions());C=null;clearTimeout(Z);if(A){W=T5.ViewState.PINCHZOOM;k();if(E)Z=setTimeout(function(){s();D=1},parseInt(E,10))}}};GRUNT.WaterCooler.listen("layer.remove",function(y){y.id&&I.removeLayer(y.id)});M=T5.Device.getConfig().getScaling();GRUNT.observable(I);I.bind("wake",k);I.bind("invalidate",
function(){aa=true});if(h.pannable){I.bind("pan",e);I.bind("panEnd",a);I.bind("inertiaPan",b);I.bind("inertiaCancel",function(){X=false;k()})}if(h.scalable){I.bind("pinchZoom",f);I.bind("pinchZoomEnd",m);I.bind("wheelZoom",l)}GRUNT.configurable(I,["inertia","container"],GRUNT.paramTweaker(h,null,{container:function(y,B){r=document.getElementById(B);o()}}),true);o();return I};
T5.AnimatedPathLayer=function(h){function e(l,s,o){l.fillStyle="#FFFFFF";l.strokeStyle="#222222";l.beginPath();l.arc(o.x,o.y,4,0,Math.PI*2,false);l.stroke();l.fill()}h=T5.ex({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:T5.Easing.Sine.InOut,validStates:T5.ViewState.get("ACTIVE","PAN","PINCHZOOM"),drawIndicator:null,duration:2E3,autoCenter:false},h);var b=T5.V.edges(h.path),a,d=null,f=0;T5.Animation.tweenValue(0,b.total,h.easing,function(){m.remove()},h.duration).requestUpdates(function(l,
s){f=l;s&&m.remove()});var m=T5.ex(new T5.ViewLayer(h),{cycle:function(){for(var l=0;l<b.accrued.length&&b.accrued[l]<f;)l++;d=null;if(l<h.path.length-1){var s=f-(l>0?b.accrued[l-1]:0),o=h.path[l],g=h.path[l+1];a=T5.V.theta(o,g,b.edges[l]);d=T5.V.pointOnEdge(o,g,a,s);if(h.autoCenter)(l=m.getParent())&&l.centerOn(d)}return d?1:0},draw:function(l,s){if(d)(h.drawIndicator?h.drawIndicator:e)(l,s,new T5.Vector(d.x-s.x,d.y-s.y),a)}});return m};
T5.Tiling=function(){TileStore=function(a){a=T5.ex({tileSize:null,gridSize:null,center:new T5.Vector,onPopulate:null},a);if(!a.tileSize)throw Error("Cannot create TileStore with an empty tile size");if(!a.gridSize)throw Error("0 grid size for TileStore");var d=Array(Math.pow(a.gridSize,2)),f=T5.V.offset(a.center,-Math.ceil(a.gridSize>>1)),m=null,l=new T5.Vector,s=null,o={find:function(g){if(!g)return null;for(var n=d.length;n--;){var q=d[n];if(q&&g(q))return q}return null},getGridSize:function(){return a.gridSize},
getNormalizedPos:function(g,n){return T5.V.add(new T5.Vector(g,n),T5.V.invert(f),l)},getTileShift:function(){return T5.V.copy(l)},getTile:function(g,n){return g>=0&&g<a.gridSize?d[n*a.gridSize+g]:null},setTile:function(g,n,q){d[n*a.gridSize+g]=q},populate:function(g,n){var q=GRUNT.Log.getTraceTicks(),p=0,t=a.gridSize,v=a.tileSize;new T5.Vector(t/2,t/2);if(g)for(var k=0;k<t;k++)for(var u=0;u<t;u++){if(!d[p]){var r=g(u,k,f,t);r.gridX=u*v-l.x;r.gridY=k*v-l.y;d[p]=r}p++}m=g;s=n;GRUNT.Log.trace("tile grid populated",
q);a.onPopulate&&a.onPopulate()},getShiftDelta:function(g,n,q,p){var t=Math.floor(a.gridSize*0.2),v=new T5.Vector;if(g<0||g+q>a.gridSize)v.x=g<0?-t:t;if(n<0||n+p>a.gridSize)v.y=n<0?-t:t;return v},shift:function(g,n){if(!(g.x===0&&g.y===0)){var q=GRUNT.Log.getTraceTicks(),p=Array(d.length);p.length=d.length;for(var t=0;t<a.gridSize;t++)for(var v=0;v<a.gridSize;v++)p[v*a.gridSize+t]=o.getTile(t+g.x,v+g.y);d=p;f=n?n(f,g):T5.V.add(f,g);l.x+=-g.x*a.tileSize;l.y+=-g.y*a.tileSize;GRUNT.Log.trace("tile storage shifted",
q);o.populate(m,s)}},setOrigin:function(g,n){if(tileOrigin)shiftOrigin(g,n);else f=T5.V.offset(new T5.Vector(g,n),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var g=d.length;g--;)if(d[g])d[g].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var g=d.length;g--;)if(d[g]){d[g].x=null;d[g].y=null}});return o};var h=null,e=null,b={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},getEmptyTile:function(a){if(!h||a!==h.width){h=T5.newCanvas(a,
a);a=h.getContext("2d");a.fillStyle="rgba(150, 150, 150, 0.01)";a.fillRect(0,0,h.width,h.height)}return h},getPanningTile:function(a){function d(){var f=T5.newCanvas(32,32),m=f.getContext("2d");m.fillStyle="#BBBBBB";m.fillRect(0,0,32,32);m.fillStyle="#C3C3C3";m.fillRect(0,0,16,16);m.fillRect(16,16,16,16);return f}if(!e||a!==e.width){e=T5.newCanvas(a,a);a=e.getContext("2d");a.fillStyle=a.createPattern(d(),"repeat");a.fillRect(0,0,e.width,e.height)}return e},Tile:function(a){return a=T5.ex({x:0,y:0,
gridX:0,gridY:0,dirty:false},a)},ImageTile:function(a){a=T5.ex({url:"",sessionParamRegex:null,loaded:false},a);return new b.Tile(a)},TileGrid:function(a){function d(r,w){if(k){var x,z=[],F=new T5.Vector(Math.floor((r.x+q.x)*l),Math.floor((r.y+q.y)*l));tilesNeeded=false;for(var L=v;L--;)for(var M=t;M--;){x=f.getTile(M+F.x,L+F.y);var G=new T5.Vector(M-k.x,L-k.y);x||(n=f.getShiftDelta(F.x,F.y,t,v));z.push({tile:x,centerness:T5.V.absSize(G)})}z.sort(function(U,O){return O.centerness-U.centerness});o||
(o=Array(z.length));for(x=z.length;x--;){o[x]=z[x].tile;u.prepTile(o[x],w)}}}a=T5.ex({tileSize:T5.Tiling.Config.TILESIZE,drawGrid:false,center:new T5.Vector,gridSize:25,shiftOrigin:null,supportFastDraw:true},a);var f=new TileStore(T5.ex({tileSize:a.tileSize,gridSize:a.gridSize,onPopulate:function(){u.dirty=true;u.wakeParent()}},a)),m=Math.round(a.tileSize/2),l=a.tileSize?1/a.tileSize:0,s=true,o=null,g=false;new T5.Vector;var n=new T5.Vector,q=new T5.Vector;T5.Device.getConfig();var p=f.getGridSize()*
a.tileSize,t,v,k,u=T5.ex(new T5.ViewLayer(a),{gridDimensions:new T5.Dimensions(p,p),dirty:false,cycle:function(r,w,x){r=0;if(n.x+n.y!==0){f.shift(n,a.shiftOrigin);q=f.getTileShift();n=new T5.Vector;r++}x!==T5.ViewState.PINCHZOOM&&d(w,x);return r+u.dirty?1:0},deactivate:function(){s=false},find:function(){return f.find.apply(null,arguments)},prepTile:function(){},drawTile:function(){return false},getTileSize:function(){return a.tileSize},draw:function(r,w,x,z,F){if(s){var L=T5.time(),M=w.x;w=w.y;var G=
true,U=F.needRepaint()||z===T5.ViewState.PANNING||z===T5.ViewState.PINCHZOOM||T5.Animation.isTweening();if(!k){t=Math.ceil(x.width*l)+1;v=Math.ceil(x.height*l)+1;k=new T5.Vector(Math.floor((t-1)/2),Math.floor((v-1)/2))}if(o){if(a.drawGrid)r.strokeStyle="rgba(50, 50, 50, 0.3)";r.beginPath();for(x=o.length;x--;){var O=o[x];if(O){var T=O.gridX-M,K=O.gridY-w;if(!(U?false:!O.dirty)){G=u.drawTile(r,O,T,K,z)&&G;O.x=T;O.y=K}}else G=false;a.drawGrid&&r.rect(T,K,a.tileSize,a.tileSize)}r.stroke();GRUNT.Log.trace("drawn tiles",
L);G&&!g&&F.trigger("tileDrawComplete");g=G;u.dirty=false}}},getTileAtXY:function(r,w){for(var x=a.tileSize,z=o?o.length:0;z--;){var F=o[z];if(F&&r>=F.x&&w>=F.y)if(r<=F.x+x&&w<=F.y+x)return F}return null},getTileVirtualXY:function(r,w,x){r=f.getNormalizedPos(r,w);r=new T5.Vector(r.x*a.tileSize,r.y*a.tileSize);if(x){r.x+=m;r.y+=m}return r},populate:function(r){f.populate(r,function(){})}});return u},ImageTileGrid:function(a){function d(){q.getParent().trigger("invalidate");q.dirty=true;q.wakeParent()}
a=T5.ex({emptyTile:b.getEmptyTile(b.Config.TILESIZE),panningTile:b.getPanningTile(b.Config.TILESIZE),tileOffset:new T5.Vector,tileDrawArgs:{}},a);var f=a.emptyTile,m=a.panningTile,l=T5.ViewState.ACTIVE,s=T5.ViewState.PAN,o=T5.Device.getConfig().requireFastDraw,g=a.tileSize?a.tileSize:b.Config.TILESIZE,n=T5.ex({background:null,overlay:null,offset:new T5.Vector,realSize:new T5.Dimensions(g,g)},a.tileDrawArgs),q=T5.ex(new b.TileGrid(a),{drawTile:function(p,t,v,k,u){var r=T5.Resources.getImage(t.url),
w=false;if(r){p.drawImage(r,v,k);t.dirty=false;w=true}else if(u===s)m&&p.drawImage(m,v,k);else f&&p.drawImage(f,v,k);return w},prepTile:function(p,t){if(p)p.dirty=true;if(p&&(!o||t===l))T5.Resources.getImage(p.url)||T5.Resources.loadImage(p.url,d,n)}});return q}};return b}();
T5.Tiler=function(h){h=T5.ex({container:"",drawCenter:false,datasources:{},tileLoadThreshold:"first"},h);var e=T5.ex(new T5.View(h),{getTileLayer:function(){return e.getLayer("grid0")},setTileLayer:function(b){e.setLayer("grid0",b);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(b){var a=e.getOffset();return new T5.Vector(b.x+a.x,b.y+a.y)},centerOn:function(b,a,d){var f=e.getTileLayer(),m=e.getDimensions();(f=f?f.getTileSize():0)&&e.updateOffset(b.gridX-Math.floor((m.width-
f)*0.5),b.gridY-Math.floor((m.height-f)*0.5),a,d)},cleanup:function(){e.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");e.trigger("wake")}});e.bind("tap",function(b,a){var d=e.getTileLayer();if(d)(d=d.getTileAtXY(a.x,a.y))&&e.trigger("tapTile",d)});return e};
T5.Geo=function(){function h(o,g){var n=null;for(var q in l)if(g){if(q==g&&l[q][o]){n=l[q];break}}else if(l[q][o]){n=l[q];break}return n}function e(o,g,n,q){var p=0;o=o.toUpperCase();for(var t in q){var v=g[t];if(v){var k=n[t];v=k?k(o,v):o.containsWord(v)?1:0;p+=v*q[t]}}return p}var b=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],a=Math.PI/180,d=180/Math.PI,f=null,m={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},l={},s={Engine:function(o){if(!o.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var g=T5.ex({remove:function(){delete l[g.id]}},o);return l[g.id]=g},Radius:function(o,g){return{distance:parseInt(o,10),uom:g}},Position:function(o,g){return{lat:parseFloat(o?o:0),lon:parseFloat(g?g:0)}},BoundingBox:function(o,g){return{min:s.P.parse(o),max:s.P.parse(g)}},Address:function(o){return o=T5.ex({streetDetails:"",location:"",country:"",postalCode:"",pos:null,boundingBox:null},
o)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var o={dist2rad:function(g){return g/6371},lat2pix:function(g,n){var q=parseFloat(g)*2*Math.PI/360;q=Math.sin(q);var p=0.08181919084262157*q;return Math.log((1+q)/(1-q)*Math.pow((1-p)/(1+p),0.08181919084262157))/2/n},lon2pix:function(g,n){return parseFloat(g)/180*Math.PI/n},pix2lon:function(g,n){return o.normalizeLon(g*n*180/Math.PI)},pix2lat:function(g,n){for(var q=Math.pow(Math.E,-g*n),p=o.mercatorUnproject(q),
t=o.findRadPhi(p,q),v=0;v<12&&Math.abs(p-t)>1.0E-7;){p=t;t=o.findRadPhi(p,q);v++}return t*180/Math.PI},mercatorUnproject:function(g){return Math.PI/2-2*Math.atan(g)},findRadPhi:function(g,n){var q=0.08181919084262157*Math.sin(g);return Math.PI/2-2*Math.atan(n*Math.pow((1-q)/(1+q),0.040909595421310785))},normalizeLon:function(g){for(;g<-180;)g+=360;for(;g>180;)g-=360;return g}};return o}(),GeoSearchResult:function(o){o=T5.ex({id:null,caption:"",resultType:"",data:null,pos:null,matchWeight:0},o);return T5.ex(o,
{toString:function(){return o.caption+(o.matchWeight?" ("+o.matchWeight+")":"")}})},GeoSearchAgent:function(o){return new T5.Dispatcher.Agent(o)},GeocodingAgent:function(o){o=T5.ex({name:"Geocoding Search Agent",paramTranslator:null,execute:function(g,n){try{if(!g.reverse&&!g.freeform)address=new s.Address(g);var q=s.getEngine("geocode");if(q)q.geocode({addresses:[g.freeform?g.freeform:address],complete:function(t,v){if(n){var k=v;if(g.freeform)k=s.rankGeocodeResponses(g.freeform,k,s.getEngine("geocode"));
n(k,o)}}})}catch(p){GRUNT.Log.exception(p)}}},o);return new s.GeoSearchAgent(o)},PointOfInterest:function(o){o=T5.ex({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},o);if(!o.pos&&o.lat&&o.lon)o.pos=new T5.Geo.Position(o.lat,o.lon);return T5.ex({toString:function(){return o.id+": '"+o.title+"'"}},o)},POIStorage:function(o){function g(k){k=k?k:"default";p[k]||(p[k]=[]);return p[k]}function n(k){var u=[];for(var r in p)for(var w=0;w<p[r].length;w++)if(!k||k(p[r][w]))u.push(p[r][w]);
return u}function q(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:v.id,pois:v.getPOIs()})}o=T5.ex({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},o);var p={},t=true,v={id:GRUNT.generateObjectID(),getPOIs:function(){return n()},getOldPOIs:function(k,u){return n(function(r){return r.group==k&&r.retrieved<u})},getVisible:function(){return t},setVisible:function(k){if(k!=t){t=k;o.visibilityChange&&o.visibilityChange()}},findById:function(k){var u=n(function(r){return r.id==k});return u.length>
0?u[0]:null},findByBounds:function(k){return n(function(u){return T5.Geo.P.inBounds(u.pos,k)})},addPOIs:function(k,u){if(u)p={};for(var r=0;k&&r<k.length;r++){k[r].retrieved=T5.time();var w=k[r];g(w.group).push(w)}},removeGroup:function(k){if(p[k]){delete p[k];q()}},update:function(k){var u=[],r=0,w=k.length>0?k[0].group:"",x=T5.time();for(r=0;r<k.length;r++){var z;a:{if(z=k[r])for(var F=g(z.group),L=0;L<F.length;L++)if(F[L].id==z.id){z=F[L];break a}z=null}if(z){z.retrieved=x;z.isNew=false}else u.push(k[r])}k=
v.getOldPOIs(w,x);v.addPOIs(u);for(r=0;o.onPOIAdded&&r<u.length;r++)o.onPOIAdded(u[r]);for(r=0;r<k.length;r++){o.onPOIDeleted&&o.onPOIDeleted(k[r]);w=k[r];x=g(w.group);for(z=0;z<x.length;z++)if(x[z].id==w.id){x.splice(z,1);break}}u.length+k.length>0&&q()}};return v},MapProvider:function(){var o=1,g=20;return{zoomLevel:0,checkZoomLevel:function(n){return Math.min(Math.max(n,o),g)},getCopyright:function(){},getLogoUrl:function(){},getMapTiles:function(){},getZoomRange:function(){return{min:o,max:g}},
setZoomRange:function(n,q){o=n;g=q}}},P:function(){var o={calcDistance:function(g,n){if(o.empty(g)||o.empty(n))return 0;var q=(n.lat-g.lat).toRad()/2,p=(n.lon-g.lon).toRad()/2;q=Math.sin(q)*Math.sin(q)+Math.cos(g.lat.toRad())*Math.cos(n.lat.toRad())*Math.sin(p)*Math.sin(p);return 6371*2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q))},copy:function(g){return g?new s.Position(g.lat,g.lon):null},empty:function(g){return!g||g.lat===0&&g.lon===0},equal:function(g,n){return g&&n&&g.lat==n.lat&&g.lon==n.lon},almostEqual:function(g,
n){return g&&n&&Math.floor(g.lat*1E3)===Math.floor(n.lat*1E3)&&Math.floor(g.lon*1E3)===Math.floor(n.lon*1E3)},inArray:function(g,n){for(var q=s.P.equal,p=n.length;p--;)if(q(g,n[p]))return true;return false},inBounds:function(g,n){var q=!(s.P.empty(g)||s.P.empty(n));return q=(q=q&&g.lat>=n.min.lat&&g.lat<=n.max.lat)&&g.lon>=n.min.lon&&g.lon<=n.max.lon},parse:function(g){if(g)if(typeof g.lat!=="undefined")return o.copy(g);else{if(g.split)for(var n=[" ",","],q=0;q<n.length;q++){var p=g.split(n[q]);if(p.length===
2)return new s.Position(p[0],p[1])}}else return new s.Position;return null},parseArray:function(g){var n=g.length,q=Array(n);for(n=n;n--;)q[n]=o.parse(g[n]);GRUNT.Log.info("parsed "+q.length+" positions");return q},fromMercatorPixels:function(g,n,q){return new s.Position(T5.Geo.Utilities.pix2lat(n,q),T5.Geo.Utilities.normalizeLon(T5.Geo.Utilities.pix2lon(g,q)))},toMercatorPixels:function(g,n){return new T5.Vector(T5.Geo.Utilities.lon2pix(g.lon,n),T5.Geo.Utilities.lat2pix(g.lat,n))},generalize:function(g,
n,q){var p=g.length,t=[],v=null;q||(q=250);q/=1E3;GRUNT.Log.info("generalizing positions, must include "+n.length+" positions");for(var k=p;k--;)if(k===0)t.unshift(g[k]);else{var u=!v||s.P.inArray(g[k],n)?q:s.P.calcDistance(v,g[k]);if(g[k]&&u>=q){t.unshift(g[k]);v=g[k]}}GRUNT.Log.info("generalized "+p+" positions into "+t.length+" positions");return t},toString:function(g){return g?g.lat+" "+g.lon:""}};return o}(),B:function(){var o=-(Math.PI/2),g=Math.PI/2,n=-Math.PI*2,q=Math.PI*2,p={calcSize:function(t,
v,k){var u=new T5.Vector(0,v.lat-t.lat);if(typeof k==="undefined")k=true;u.x=k&&t.lon>v.lon?360-t.lon+v.lon:v.lon-t.lon;return u},createBoundsFromCenter:function(t,v){var k=v/6371,u=t.lat*a,r=t.lon*a,w=u-k,x=u+k;if(w>o&&x<g){u=Math.asin(Math.sin(k)/Math.cos(u));k=r-u;if(k<n)k+=2*Math.PI;r=r+u;if(r>q)r-=2*Math.PI}else{w=Math.max(w,o);x=Math.min(x,g);k=n;r=q}return new s.BoundingBox(new s.Position(w*d,k*d),new s.Position(x*d,r*d))},expand:function(t,v){return new s.BoundingBox(new s.Position(t.min.lat-
v,t.min.lon-s.Utilities.normalizeLon(v)),new s.Position(t.max.lat+v,t.max.lon+s.Utilities.normalizeLon(v)))},forPositions:function(t,v){var k=null,u=T5.time();v||(v="auto");for(var r=t.length;r--;)if(k){var w=p.calcSize(k.min,t[r],false),x=p.calcSize(t[r],k.max,false);if(w.x<0)k.min.lon=t[r].lon;if(w.y<0)k.min.lat=t[r].lat;if(x.x<0)k.max.lon=t[r].lon;if(x.y<0)k.max.lat=t[r].lat}else k=new T5.Geo.BoundingBox(t[r],t[r]);if(v){if(v=="auto"){r=p.calcSize(k.min,k.max);v=Math.max(r.x,r.y)*0.3}k=p.expand(k,
v)}GRUNT.Log.trace("calculated bounds for "+t.length+" positions",u);return k},getCenter:function(t){var v=s.B.calcSize(t.min,t.max);return new T5.Geo.Position(t.min.lat+v.y/2,t.min.lon+v.x/2)},getGeoHash:function(t){var v=T5.Geo.GeoHash.encode(t.min.lat,t.min.lon);t=T5.Geo.GeoHash.encode(t.max.lat,t.max.lon);GRUNT.Log.info("min hash = "+v+", max hash = "+t)},getZoomLevel:function(t,v){var k=p.getCenter(t),u=b[Math.min(Math.round(Math.abs(k.lat)*0.05),b.length)],r=p.calcSize(t.min,t.max);k=Math.ceil(Math.log(b[3]*
v.height/r.y)/Math.log(2));u=Math.ceil(Math.log(u*v.width/r.x)/Math.log(2));return Math.min(isNaN(k)?1E3:k,isNaN(u)?1E3:u)},isEmpty:function(t){return!t||s.P.empty(t.min)||s.P.empty(t.max)},toString:function(t){return"min: "+s.P.toString(t.min)+", max: "+s.P.toString(t.max)}};return p}(),A:function(){var o=/^(\d+).*$/,g=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(n,q){o.lastIndex=-1;if(o.test(n))for(var p=n.replace(o,"$1"),t=q.split(","),v=0;v<t.length;v++){g.lastIndex=-1;if(g.test(t[v])){var k=
g.exec(t[v]);if(p>=parseInt(k[1],10)&&p<=parseInt(k[2],10))return true}else if(p==t[v])return true}return false},normalize:function(n){if(!n)return"";n=n.toUpperCase();if(!f){var q=[];for(var p in m)q.push(p);f=RegExp("(\\s)("+q.join("|")+")(\\s|$)","i")}f.lastIndex=-1;if(q=f.exec(n))n=n.replace(f,"$1"+m[q[2]]);return n},toString:function(n){return n.streetDetails+" "+n.location}}}(),getEngine:function(o){for(var g=null,n=1;!g&&n<arguments.length;n++)g=h(o,arguments[n]);g=g?g:h(o);if(!g)throw Error("Unable to find GEO engine with "+
o+" capability");return g},rankGeocodeResponses:function(o,g,n){var q=[],p=s.AddressCompareFns;if(n&&n.compareFns)p=T5.ex({},p,n.compareFns);for(n=0;n<g.length;n++)q.push(new s.GeoSearchResult({caption:s.A.toString(g[n]),data:g[n],pos:g[n].pos,matchWeight:e(o,g[n],p,s.GeocodeFieldWeights)}));q.sort(function(t,v){return v.matchWeight-t.matchWeight});return q}};return s}();
T5.Geo.GeoHash=function(){function h(e,b,a){if(b&a)e[0]=(e[0]+e[1])/2;else e[1]=(e[0]+e[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(e){var b=1,a=[],d=[];a[0]=-90;a[1]=90;d[0]=-180;d[1]=180;lat_err=90;lon_err=180;for(i=0;i<e.length;i++){c=e[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(b){lon_err/=2;h(d,cd,mask)}else{lat_err/=2;h(a,cd,mask)}b=!b}}a[2]=(a[0]+
a[1])/2;d[2]=(d[0]+d[1])/2;return{latitude:a,longitude:d}},encode:function(e,b,a){var d=1,f=[],m=[],l=0,s=0;a=a?a:12;geohash="";f[0]=-90;f[1]=90;m[0]=-180;for(m[1]=180;geohash.length<a;){if(d){mid=(m[0]+m[1])/2;if(b>mid){s|=BITS[l];m[0]=mid}else m[1]=mid}else{mid=(f[0]+f[1])/2;if(e>mid){s|=BITS[l];f[0]=mid}else f[1]=mid}d=!d;if(l<4)l++;else{geohash+=BASE32[s];s=l=0}}return geohash}}}();
T5.Geo.Search=function(){return{bestResults:function(h,e){e||(e=20);for(var b=h.length>0?h[0]:null,a=[],d=0;d<h.length;d++)if(b.matchWeight-h[d].matchWeight<=e)a.push(h[d]);else break;return a}}}();
T5.Geo.Routing=function(){var h={calculate:function(e){e=T5.ex({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:false},e);GRUNT.Log.info("attempting to calculate route");var b=T5.Geo.getEngine("route");b&&b.route(e,function(a){if(e.generalize)a.geometry=T5.Geo.P.generalize(a.geometry,a.getInstructionPositions());if(e.map){h.createMapOverlay(e.map,a);if(e.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+a.boundingBox);e.map.gotoBounds(a.boundingBox)}}e.success&&
e.success(a)})},createMapOverlay:function(e,b){var a=e.getDimensions();a=new T5.Geo.UI.RouteOverlay({data:b,width:a.width,height:a.height});e.setLayer("route",a)},parseTurnType:function(e){for(var b=h.TurnType.Unknown,a=T5.Geo.Routing.TurnTypeRules,d=0;d<a.length;d++){a[d].regex.lastIndex=-1;var f=a[d].regex.exec(e);if(f){b=a[d].customCheck?a[d].customCheck(e,f):a[d].turnType;break}}return b},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",TurnLeft:"turn-left",
TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(e){e=T5.ex({position:null,description:"",turnType:null},e);if(!e.turnType)e.turnType=h.parseTurnType(e.description);return e},RouteData:function(e){e=T5.ex({geometry:[],instructions:[],boundingBox:null},
e);if(!e.boundingBox)e.boundingBox=T5.Geo.B.forPositions(e.geometry);return T5.ex({getInstructionPositions:function(){for(var b=[],a=0;a<e.instructions.length;a++)e.instructions[a].position&&b.push(e.instructions[a].position);return b}},e)}};return h}();
T5.Geo.Routing.TurnTypeRules=function(){var h=T5.Geo.Routing.TurnType,e=[];e.push({regex:/continue/i,turnType:h.Continue});e.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(b,a){return/bear/i.test(a[1])?h.TurnLeftSlight:h.TurnLeft}});e.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(b,a){return/bear/i.test(a[1])?h.TurnRightSlight:h.TurnRight}});e.push({regex:/enter\s(roundabout|rotaty)/i,turnType:h.EnterRoundabout});e.push({regex:/take.*?ramp/i,turnType:h.Ramp});e.push({regex:/take.*?exit/i,
turnType:h.RampExit});e.push({regex:/make(.*?)u\-turn/i,customCheck:function(b,a){return/right/i.test(a[1])?h.UTurnRight:h.UTurnLeft}});e.push({regex:/proceed/i,turnType:h.Start});e.push({regex:/arrive/i,turnType:h.Arrive});e.push({regex:/fell\sthrough/i,turnType:h.Merge});return e}();
T5.Geo.UI=function(){var h=0,e={AnnotationTween:null,GeoTileGrid:function(b){b=T5.ex({grid:null,centerPos:new T5.Geo.Position,centerXY:new T5.Vector,radsPerPixel:0},b);var a=T5.Geo.P.toMercatorPixels(b.centerPos,b.radsPerPixel),d=a.x-b.centerXY.x,f=a.y-b.centerXY.y,m=T5.ex({},b.grid,{getBoundingBox:function(l,s,o,g){return new T5.Geo.BoundingBox(m.pixelsToPos(new T5.Vector(l,s+g)),m.pixelsToPos(new T5.Vector(l+o,s)))},getGridXYForPosition:function(l){l=T5.Geo.P.toMercatorPixels(l,b.radsPerPixel);
return new T5.Vector(l.x-d,m.gridDimensions.height-(l.y-f))},getPixelDistance:function(l){l=T5.Geo.Utilities.dist2rad(l);return Math.floor(l/b.radsPerPixel)},pixelsToPos:function(l){return T5.Geo.P.fromMercatorPixels(d+l.x,f+m.gridDimensions.height-l.y,b.radsPerPixel)}});return m},RouteOverlay:function(b){b=T5.ex({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},b);var a=true,d=null,f=
[],m=0,l=[],s=[],o=T5.ex(new T5.ViewLayer(b),{getAnimation:function(g,n,q,p){if(a)return null;var t="routeAnimation"+h++;s.push(t);return new T5.AnimatedPathLayer({id:t,path:f,zindex:b.zindex+1,easing:g?g:T5.Easing.Sine.InOut,duration:n?n:5E3,drawIndicator:q,autoCenter:p?p:false})},draw:function(g,n,q,p,t){q=0;p=b.data?b.data.geometry:null;if(a){a=false;d=null;f=[];m=0}if(p&&m<p.length){a:{t=t.getTileLayer();l=[];if(t){p=GRUNT.Log.getTraceTicks();var v,k,u,r=b.data?b.data.geometry:[],w=r.length,x=
b.data?b.data.instructions:[],z=x.length,F=b.calculationsPerCycle,L=0;for(v=m;v<w;v++){k=t.getGridXYForPosition(r[v]);if(u=!d||v===0||Math.abs(k.x-d.x)+Math.abs(k.y-d.y)>b.pixelGeneralization){f.push(k);d=k}L++;if(L>=F){m=v;break a}}m=w;GRUNT.Log.trace(w+" geometry points generalized to "+f.length+" coordinates",p);d=null;for(v=z;v--;)if(x[v].position){k=t.getGridXYForPosition(x[v].position);if(u=!d||v===0||Math.abs(k.x-d.x)+Math.abs(k.y-d.y)>b.pixelGeneralization){l.push(k);d=k}}}}q++}t=f.length;
if(t>0&&(!q||b.partialDraw)){g.strokeStyle=b.strokeStyle;g.lineWidth=b.lineWidth;g.beginPath();g.moveTo(f[t-1].x-n.x,f[t-1].y-n.y);for(t=t;t--;)g.lineTo(f[t].x-n.x,f[t].y-n.y);g.stroke();g.fillStyle=b.waypointFillStyle;for(t=l.length;t--;){g.beginPath();g.arc(l[t].x-n.x,l[t].y-n.y,2,0,Math.PI*2,false);g.stroke();g.fill()}}return q}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var g=s.length;g--;)GRUNT.WaterCooler.say("layer.remove",{id:s[g]});s=[];a=true;o.wakeParent()});return o},Annotation:function(b){b=
T5.ex({xy:null,pos:null,draw:null,calcXY:null,tweenIn:e.AnnotationTween,animationSpeed:null},b);var a=false,d={xy:b.xy,pos:b.pos,isNew:true,isAnimating:function(){return a},calcXY:function(f){d.xy=f.getGridXYForPosition(d.pos);b.calcXY&&b.calcXY(f)},draw:function(f,m,l,s,o){if(d.xy){if(d.isNew&&b.tweenIn){var g=d.xy.y;d.xy.y=m.y-20;a=true;T5.Animation.tween(d.xy,"y",g,b.tweenIn,function(){d.xy.y=g;a=false},b.animationSpeed?b.animationSpeed:250+Math.random()*500)}if(b.draw)b.draw(f,m,new T5.Vector(d.xy.x-
m.x,d.xy.y-m.y),l,s,o);else{f.beginPath();f.arc(d.xy.x-m.x,d.xy.y-m.y,4,0,Math.PI*2,false);f.fill()}d.isNew=false}}};return d},ImageAnnotation:function(b){b=T5.ex({imageUrl:null,animatingImageUrl:null,imageAnchor:null},b);var a=b.imageAnchor?T5.V.invert(b.imageAnchor):null;b.draw=function(f,m,l,s,o){if(b.animatingImageUrl&&d.isAnimating()){T5.Resources.loadImage(b.imageUrl);s=b.animatingImageUrl}else s=b.imageUrl;if(m=T5.Resources.getImage(s)){if(m.complete&&m.width>0){a||(a=new T5.Vector(-m.width>>
1,-m.height>>1));l=T5.V.offset(l,a.x,a.y);f.drawImage(m,l.x,l.y,m.width,m.height)}}else T5.Resources.loadImage(s,function(){o.wakeParent()})};var d=new e.Annotation(b);return d},LocationAnnotation:function(b){b=T5.ex({accuracy:null},b);var a=new Image,d=new T5.Vector,f=null;a.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAACIQAAAiEBPhEQkwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAG+SURBVCiRlZHNahNRAIW/O7mTTJPahLZBA1YUyriINRAE3bQIKm40m8K8gLj0CRQkO32ELHUlKbgoIu4EqeJPgtCaoBuNtjXt5LeTMZk0mbmuWiuuPLsD3+HAOUIpxf9IHjWmaUbEyWv5ROrsVULhcHP761rUfnN3Y2Otc8CIg4YT85lzuVsPP+Qupw1vpPjRCvhS9ymvV0e77x7nNj+uvADQAIQQ+uLyvdfLV9JGZi7EdEwQlqBpEJ019f0z1mo2u5Q8DMydv25lshemmj1FueZTawbs7inarqLbV7Qjab1upB9YlhWSAHLavLHZCvg1VEhN0PMU9W7At4bPVidg7CtkLLXkut+lBPD6/Ub155jJiADAHSpaLmx3ApyBQoYEUd0PBoOBkAC6+3llvda/YxgGgYL+UNHf/zN3KiExGlsvTdP0NYDkhPdWrz35ZDsBzV5wCMuQwEyFmXFeeadjzfuFQmGkAZRKpdGC/n7x+M6jqvA9Zo6FWDhlcHE+wqT93J1tP7vpOE7rrx8ALMuasPf8S12St4WmJ6bYWTUC52k8Hm8Vi0X/nwBAPp/XKpWKdF1X2LYdlMvlsToC/QYTls7DLFr/PAAAAABJRU5ErkJggg%3D%3D";
a.onload=function(){d=new T5.Vector(a.width/2,a.height/2)};var m=new e.Annotation(T5.ex({calcXY:function(l){f=Math.floor(l.getPixelDistance(m.accuracy)*0.5)},draw:function(l,s,o,g,n,q){s=o.x-d.x;g=o.y-d.y;if(f&&m.drawAccuracyIndicator){l.fillStyle="rgba(30, 30, 30, 0.2)";l.beginPath();l.arc(o.x,o.y,f,0,Math.PI*2,false);l.fill()}a.complete&&a.width>0&&l.drawImage(a,s,g,a.width,a.height);q.trigger("invalidate")}},b));m.accuracy=b.accuracy;m.drawAccuracyIndicator=false;return m},AnnotationsOverlay:function(b){function a(s){var o=
b.map?b.map.getTileLayer():null,g=s.length;if(o)for(g=g;g--;)s[g].calcXY(o);s.sort(function(n,q){var p=q.xy.y-n.xy.y;if(p===0)p=q.xy.x-n.xy.x;return p})}b=T5.ex({pois:null,map:null,createAnnotationForPOI:null,zindex:100},b);var d=[],f=false,m=[],l=T5.ex(new T5.ViewLayer(b),{cycle:function(){return f?1:0},draw:function(s,o,g,n,q){f=false;s.fillStyle="rgba(255, 0, 0, 0.75)";s.globalCompositeOperation="source-over";for(g=d.length;g--;){d[g].draw(s,o,n,l,q);f=f||d[g].isAnimating()}for(g=m.length;g--;){m[g].draw(s,
o,n,l,q);f=f||m[g].isAnimating()}return f?1:0},add:function(s){m.push(s);a(m);l.wakeParent()},clear:function(s){m=[];a(m);if(s){d=[];a(d)}l.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(s){if(b.pois&&b.pois.id==s.srcID){s=s.pois;try{d=[];for(var o=0;o<s.length;o++)if(s[o].pos){var g;var n=s[o];if(n&&n.pos){var q=null;if(q=b.createAnnotationForPOI?b.createAnnotationForPOI(n):new e.Annotation({pos:n.pos})){q.isNew=n.isNew;n.isNew=false}g=q}else g=void 0;g&&d.push(g)}a(d)}catch(p){GRUNT.Log.exception(p)}l.wakeParent()}});
GRUNT.WaterCooler.listen("grid.updated",function(){a(d);a(m);l.wakeParent()});return l}};return e}();
T5.Map=function(h){function e(u){try{var r=new T5.Geo.Position(u.coords.latitude,u.coords.longitude),w=u.coords.accuracy/1E3;k.trigger("locationUpdate",u,w);if(t){if(!n){n=new T5.Geo.UI.LocationAnnotation({pos:r,accuracy:w});k.bind("tileDrawComplete",function(){n.drawAccuracyIndicator=true})}h.displayLocationAnnotation&&s.add(n);var x=T5.Geo.B.createBoundsFromCenter(r,Math.max(w,1));k.gotoBounds(x)}else{n.pos=r;n.accuracy=w;n.calcXY(k.getTileLayer());k.panToPosition(r,null,T5.Easing.Sine.Out)}t=false}catch(z){GRUNT.Log.exception(z)}}
function b(u){GRUNT.Log.info("caught location tracking error:",u)}h=T5.ex({tapExtent:10,provider:null,crosshair:false,zoomLevel:0,boundsChange:null,tapPOI:null,boundsChangeThreshold:30,pois:new T5.Geo.POIStorage,createAnnotationForPOI:null,displayLocationAnnotation:true,zoomAnimation:T5.Easing.Quad.Out},h);var a={NONE:0,SINGLE:1,WATCH:2},d=new T5.Vector,f=a.NONE,m=false,l=[],s=null,o=null,g=null,n=null,q=0,p=false,t=true,v=h.zoomLevel;if(!h.provider)h.provider=new T5.Geo.MapProvider;h.adjustScaleFactor=
function(u){return Math.pow(2,(u<1?Math.floor:Math.ceil)(Math.log(u)))};var k=T5.ex({},new T5.Tiler(h),{pois:h.pois,annotations:null,getBoundingBox:function(){var u=k.getTileLayer(),r=k.getOffset(),w=k.getDimensions();if(u)return u.getBoundingBox(r.x,r.y,w.width,w.height);return null},getCenterPosition:function(){return k.getXYPosition(T5.D.getCenter(k.getDimensions()))},getXYPosition:function(u){return k.getTileLayer().pixelsToPos(k.viewPixToGridPix(u))},gotoBounds:function(u,r){var w=T5.Geo.B.getZoomLevel(u,
k.getDimensions());k.gotoPosition(T5.Geo.B.getCenter(u),w,r)},gotoPosition:function(u,r,w){function x(M){k.setTileLayer(M);g=M.getId();k.panToPosition(u,function(){k.unfreeze();k.trigger("zoomLevelChange",v);w&&w()});m=true;p=false}var z=v,F=!m,L=k.getBoundingBox();if(L)F=F||!T5.Geo.P.inBounds(u,L);v=r?r:v;if(!v)throw Error("Zoom level required to goto a position.");if(h.provider)v=h.provider.checkZoomLevel(v);if(F||v!==z)if(p)GRUNT.Log.warn("Tile request in progress, aborting");else{T5.Resources.resetImageLoadQueue();
if(n)n.drawAccuracyIndicator=false;(r=k.getTileLayer())&&r.deactivate();T5.Animation.cancel();m&&k.freeze();p=true;h.provider.zoomLevel=v;h.provider.getMapTiles(k,u,x)}else k.panToPosition(u,w)},panToPosition:function(u,r,w){var x=k.getTileLayer();if(x){u=x.getGridXYForPosition(u);x=k.getDimensions();u.x-=x.width/2;u.y-=x.height/2;if(o)o=null;k.updateOffset(u.x,u.y,w);k.trigger("wake");h.boundsChange&&h.boundsChange(k.getBoundingBox());r&&r(k)}},locate:function(){k.trackStart(a.SINGLE);setTimeout(k.trackCancel,
1E4)},trackStart:function(u){if(navigator.geolocation&&!q){f=u?u:a.WATCH;t=true;q=navigator.geolocation.watchPosition(e,b,{enableHighAccuracy:true,timeout:1E4,maximumAge:5E3})}},trackCancel:function(){q&&navigator.geolocation&&navigator.geolocation.clearWatch(q);f===a.WATCH&&s.clear();f=a.NONE;q=0},getZoomLevel:function(){return v},setZoomLevel:function(u){try{k.gotoPosition(k.getCenterPosition(),u)}catch(r){GRUNT.Log.exception(r)}},zoomIn:function(){k.scale(2,T5.Easing.Sine.Out)||k.setZoomLevel(v+
1)},zoomOut:function(){k.scale(0.5,T5.Easing.Sine.Out)||k.setZoomLevel(v-1)},animateRoute:function(u,r,w,x){var z=k.getLayer("route");if(z)(u=z.getAnimation(u,r,w,x))&&u.addToView(k)}});k.bind("pan",function(){f===a.SINGLE&&k.trackCancel()});k.bind("tap",function(u,r){var w=k.getTileLayer(),x=null;if(w){var z=k.viewPixToGridPix(new T5.Vector(r.x,r.y)),F=w.pixelsToPos(z);x=w.pixelsToPos(T5.V.offset(z,-h.tapExtent,h.tapExtent));w=w.pixelsToPos(T5.V.offset(z,h.tapExtent,-h.tapExtent));x=new T5.Geo.BoundingBox(x,
w);l=k.pois.findByBounds(x);k.trigger("geotap",u,r,F,x);h.tapPOI&&h.tapPOI(l)}});k.bind("doubleTap",function(u,r){k.animate(2,T5.D.getCenter(k.getDimensions()),new T5.Vector(r.x,r.y),h.zoomAnimation)});k.bind("scale",function(u,r){var w=0;u=Math.sqrt(u);if(u<1)w=-(0.5/u);else if(u>1)w=u;k.gotoPosition(k.getXYPosition(r),v+Math.floor(w))});s=new T5.Geo.UI.AnnotationsOverlay({pois:k.pois,map:k,createAnnotationForPOI:h.createAnnotationForPOI});k.annotations=s;k.setLayer("annotations",s);h.crosshair&&
k.setLayer("crosshair",new CrosshairOverlay);k.bind("idle",function(){if(T5.V.absSize(T5.V.diff(d,k.getOffset()))>h.boundsChangeThreshold&&h.boundsChange){d=k.getOffset();h.boundsChange(k.getBoundingBox())}});GRUNT.configurable(k,["provider"],GRUNT.paramTweaker(h,null,{provider:function(){k.cleanup();m=false}}),true);return k};
