if(!this.JSON)this.JSON={};
(function(){function v(m){return m<10?"0"+m:m}function q(m){g.lastIndex=0;return g.test(m)?'"'+m.replace(g,function(k){var n=f[k];return typeof n==="string"?n:"\\u"+("0000"+k.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+m+'"'}function l(m,k){var n,e,o,r,u=b,p,s=k[m];if(s&&typeof s==="object"&&typeof s.toJSON==="function")s=s.toJSON(m);if(typeof h==="function")s=h.call(k,m,s);switch(typeof s){case "string":return q(s);case "number":return isFinite(s)?String(s):"null";case "boolean":case "null":return String(s);
case "object":if(!s)return"null";b+=d;p=[];if(Object.prototype.toString.apply(s)==="[object Array]"){r=s.length;for(n=0;n<r;n+=1)p[n]=l(n,s)||"null";o=p.length===0?"[]":b?"[\n"+b+p.join(",\n"+b)+"\n"+u+"]":"["+p.join(",")+"]";b=u;return o}if(h&&typeof h==="object"){r=h.length;for(n=0;n<r;n+=1){e=h[n];if(typeof e==="string")if(o=l(e,s))p.push(q(e)+(b?": ":":")+o)}}else for(e in s)if(Object.hasOwnProperty.call(s,e))if(o=l(e,s))p.push(q(e)+(b?": ":":")+o);o=p.length===0?"{}":b?"{\n"+b+p.join(",\n"+b)+
"\n"+u+"}":"{"+p.join(",")+"}";b=u;return o}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+v(this.getUTCMonth()+1)+"-"+v(this.getUTCDate())+"T"+v(this.getUTCHours())+":"+v(this.getUTCMinutes())+":"+v(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var a=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
g=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,b,d,f={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},h;if(typeof JSON.stringify!=="function")JSON.stringify=function(m,k,n){var e;d=b="";if(typeof n==="number")for(e=0;e<n;e+=1)d+=" ";else if(typeof n==="string")d=n;if((h=k)&&typeof k!=="function"&&(typeof k!=="object"||typeof k.length!=="number"))throw Error("JSON.stringify");return l("",
{"":m})};if(typeof JSON.parse!=="function")JSON.parse=function(m,k){function n(o,r){var u,p,s=o[r];if(s&&typeof s==="object")for(u in s)if(Object.hasOwnProperty.call(s,u)){p=n(s,u);if(p!==undefined)s[u]=p;else delete s[u]}return k.call(o,r,s)}var e;m=String(m);a.lastIndex=0;if(a.test(m))m=m.replace(a,function(o){return"\\u"+("0000"+o.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(m.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){e=eval("("+m+")");return typeof k==="function"?n({"":e},""):e}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(v){if(arguments.length<=1)return v;for(var q=arguments.length-2,l=0;l<=q;l++)v=v.replace(RegExp("\\{"+l+"\\}","gi"),arguments[l+1]);return v};
String.prototype.containsWord=function(v){var q="";if(v.toString)v=v.toString();for(var l=0;l<v.length;l++)q+=!/\w/.test(v[l])?"\\"+v[l]:v[l];return RegExp("(^|\\s|\\,)"+q+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var v=Object.prototype.hasOwnProperty,q=0,l={id:"GRUNT.core",extend:function(){var a=arguments[0]||{},g=1,b=arguments.length,d=false,f,h,m,k;if(typeof a==="boolean"){d=a;a=arguments[1]||{};g=2}if(typeof a!=="object"&&!l.isFunction(a))a={};if(b===g){a=this;--g}for(;g<b;g++)if((f=arguments[g])!=null)for(h in f){m=a[h];k=f[h];if(a!==k)if(d&&k&&(l.isPlainObject(k)||l.isArray(k))){m=m&&(l.isPlainObject(m)||l.isArray(m))?m:l.isArray(k)?[]:{};a[h]=l.extend(d,m,k)}else if(k!==undefined)a[h]=
k}return a},isFunction:function(a){return toString.call(a)==="[object Function]"},isArray:function(a){return toString.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||toString.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!v.call(a,"constructor")&&!v.call(a.constructor.prototype,"isPrototypeOf"))return false;var g;for(g in a);return g===undefined||v.call(a,g)},isEmptyObject:function(a){for(var g in a)return false;return true},isXmlDocument:function(a){return toString.call(a)===
"[object Document]"},contains:function(a,g){var b=a,d=arguments,f=1;if(g&&l.isArray(g)){d=g;f=0}for(f=f;f<d;f++)b=b&&typeof foo[d[f]]!=="undefined";return b},newModule:function(a){a=l.extend({id:null,requires:[],parent:null},a);if(a.parent)a=l.extend({},a.parent,a);return a},toID:function(a){return a.replace(/\s/g,"-")},generateObjectID:function(a){return(a?a:"obj")+q++}};return l}();
GRUNT.Log=function(){function v(b,d){var f,h=d&&d.length>0?d[0]:"";for(f=1;d&&f<d.length;f++)h+=" "+(l&&GRUNT.isPlainObject(d[f])?JSON.stringify(d[f]):d[f]);typeof console!=="undefined"&&console[b](h);for(f=0;f<q.length;f++)q[f].call(g,h,b)}var q=[],l=typeof JSON!=="undefined",a=window.console&&window.console.markTimeline,g={id:"GRUNT.log",getTraceTicks:function(){return a?(new Date).getTime():null},trace:function(b,d){if(a)console.markTimeline(b+(d?": "+(g.getTraceTicks()-d)+"ms":""))},debug:function(){v("debug",
arguments)},info:function(){v("info",arguments)},warn:function(){v("warn",arguments)},error:function(){v("error",arguments)},exception:function(b){g.error(arguments);for(var d in b)g.info("ERROR DETAIL: "+d+": "+b[d])},watch:function(b,d){try{d()}catch(f){g.exception(f,b)}},throwError:function(b){g.error(b);throw Error(b);},requestUpdates:function(b){q.push(b)}};return g}();
GRUNT.Data=function(){var v={determineObjectMapping:function(l){if(!l)return null;l=l.split("|");for(var a={},g=0;g<l.length;g++)a[l[g]]=g;return a},mapLineToObject:function(l,a){var g=l.split("|"),b={};for(var d in a){var f=a[d];b[d]=g.length>f?g[f]:null}return b},parse:function(l){var a=null,g=[];l=l.split("\n");for(var b=0;b<l.length;b++){var d=l[b];if(a)g.push(v.mapLineToObject(d,a));else a=v.determineObjectMapping(d)}return g}},q={supportedFormats:{JSON:{parse:function(l){return JSON.parse(l)}},
PDON:{parse:function(l){return v.parse(l)}}},parse:function(l){l=GRUNT.extend({data:"",format:"JSON"},l);if(!q.supportedFormats[l.format])throw Error("Unsupported data format: "+l.format+", cannot parse data in javascript object");try{return q.supportedFormats[l.format].parse(l.data)}catch(a){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+l.format,l.data);GRUNT.Log.exception(a)}return{}}};return q}();
GRUNT.Template=function(){var v=/\$\{(.*?)\}/ig;return{parse:function(q,l){for(var a=q,g=v.exec(a);g;){a=a.replace(g[0],GRUNT.XPath.first(g[1],l));v.lastIndex=0;g=v.exec(a)}return a}}}();
GRUNT.JSONP=function(){function v(g){var b=document.createElement("script"),d=false;b.src=g;b.async=true;b.onload=b.onreadystatechange=function(){if(!d&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){d=true;b.onload=b.onreadystatechange=null;b&&b.parentNode&&b.parentNode.removeChild(b)}};l||(l=document.getElementsByTagName("head")[0]);l.appendChild(b)}var q=0,l,a=this;return{get:function(g,b,d){g+=g.indexOf("?")>=0?"&":"?";var f="json"+ ++q;a[f]=function(h){b(h);a[f]=
null;try{delete a[f]}catch(m){}};v(g+(d?d:"callback")+"="+f);return f}}}();
GRUNT.XHR=function(){var v={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},q={JSON:["json"],PDON:["pdon.txt"]},l=["TEXT","STREAM"],a=/^(\w+:)?\/\/([^\/?#]+)/,g={XML:function(f){return f.responseXML},JSON:function(f){try{return JSON.parse(f.responseText)}catch(h){GRUNT.Log.error("Error parsing JSON data: ",f.responseText);GRUNT.Log.exception(h)}return""},PDON:function(f){return GRUNT.Data.parse({data:f.responseText,format:"PDON"})},DEFAULT:function(f){return f.responseText}},
b={CONTENT_TYPE:"Content-Type"},d=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(f){try{f=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},d.ajaxSettings,f);var h=a.exec(f.url),m=h&&(h[1]&&h[1]!==location.protocol||h[2]!==location.host);if(f.data)f.method="POST";if(f.url){h=null;if(f.xhr)h=f.xhr(f);h||(h=new XMLHttpRequest);h.open(f.method,f.url,f.async);f.data&&h.setRequestHeader("Content-Type",
f.contentType);m||h.setRequestHeader("X-Requested-With","XMLHttpRequest");h.onreadystatechange=function(){if(this.readyState===4){var n=null,e=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(e)if(f.handleResponse)f.handleResponse(this);else{var o=f,r=this.getResponseHeader(b.CONTENT_TYPE),u,p=false;for(u in v)if(r&&r.indexOf(v[u])>=0){p=true;break}r=!p;for(p=0;p<l.length;p++)r=r||l[p]==u;if(r)b:{r=u;for(var s in q)for(p=
0;p<q[s].length;p++)if(RegExp(q[s][p]+"$","i").test(o.url)){u=s;break b}u=r?r:"DEFAULT"}try{n=g[u](this,o)}catch(t){GRUNT.Log.warn("error applying processor '"+u+"' to response type, falling back to default");n=g.DEFAULT(this,o)}}else f.error&&f.error(this)}catch(w){GRUNT.Log.exception(w,"PROCESSING AJAX RESPONSE")}e&&n&&f.success&&f.success.call(this,n)}};h.send(f.method=="POST"?d.param(f.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(k){GRUNT.Log.exception(k)}},
param:function(f){var h=[],m=function(n,e){e=GRUNT.isFunction(e)?e():e;h[h.length]=encodeURIComponent(n)+"="+encodeURIComponent(e)};if(GRUNT.isArray(f))for(var k=0;k<f.length;k++)m(f[k].name,f[k].value);else for(k in f)m(k,f[k]);return h.join("&").replace(/%20/g,"+")}});return d}();
GRUNT.XPath=function(){function v(g){for(var b=null,d=0;d<q.length;d++)if(b=q[d](g))break;return b}var q=[],l=[null,function(g){return g.numberValue},function(g){return g.stringValue},function(g){return g.booleanValue},null,null,null,null,function(g){return g.singleNodeValue?g.singleNodeValue.textContent:null},function(g){return g.singleNodeValue?g.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var a={SearchResult:function(g){return{toString:function(){var b=
null;if(g){var d=null;if(g.resultType>=0&&g.resultType<l.length)d=l[g.resultType];if(d){GRUNT.Log.info("invoking match handler for result type: "+g.resultType);b=d(g)}}return b?b:""}}},first:function(g,b){var d=a.SearchResult,f;var h=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!h)h=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(b))f=b.evaluate(g,b,v,h,null);else{GRUNT.Log.warn("attempted xpath expression: "+g+" on a non-xml document");f=null}}catch(m){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
g+" on node: "+b);f=null}return new d(f)},registerResolver:function(g){q.push(g)}};return a}();GRUNT.Observable=function(){var v={},q=0,l={bind:function(a,g){v[a]||(v[a]=[]);q+=1;v[a].push({callback:g,callbackId:q});return q},trigger:function(a){var g=v[a];if(g)for(var b=g.length;b--;)g[b].callback.apply(l,Array.prototype.slice.call(arguments,1))},unbind:function(a,g){for(var b=v[a],d=0;b&&d<b.length;d++)if(b[d].callbackId===g){b.splice(d,1);break}}};return l};
GRUNT.WaterCooler=function(){var v={},q=[];return{addPipe:function(l){l("pipe.test",{});q.push(l)},listen:function(l,a){v[l]||(v[l]=[]);a&&v[l].push(a)},say:function(l,a){var g;for(g=q.length;g--;)q[g](l,a);if(v[l])for(g=v[l].length;g--;)v[l][g](a)},leave:function(){}}}();
TILE5=function(){var v={newCanvas:function(q,l){var a=document.createElement("canvas");typeof G_vmlCanvasManager!=="undefined"&&G_vmlCanvasManager.initElement(a);a.width=q?q:0;a.height=l?l:0;return a},Settings:function(){var q={};return{get:function(l){return q[l]},set:function(l,a){q[l]=a},extend:function(l){GRUNT.extend(q,l)}}}(),Clock:function(){var q=null;return{getTime:function(l){return l&&q?q:q=(new Date).getTime()}}}(),Vector:function(q,l){return{x:q?q:0,y:l?l:0}},V:function(){function q(l){if(!l||
l.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var a={edges:Array(l.length-1),accrued:Array(l.length-1),total:0},g=TILE5.V.diff,b=0;b<l.length-1;b++){var d=g(l[b],l[b+1]);a.edges[b]=Math.sqrt(d.x*d.x+d.y*d.y);a.accrued[b]=a.total+a.edges[b];a.total+=a.edges[b]}return a}return{create:function(l,a){return new v.Vector(l,a)},add:function(){for(var l=new v.Vector,a=arguments.length;a--;){l.x+=arguments[a].x;l.y+=arguments[a].y}return l},absSize:function(l){return Math.max(Math.abs(l.x),
Math.abs(l.y))},diff:function(l,a){return new v.Vector(l.x-a.x,l.y-a.y)},copy:function(l){return l?new v.Vector(l.x,l.y):null},invert:function(l){return new TILE5.Vector(-l.x,-l.y)},offset:function(l,a,g){return new TILE5.Vector(l.x+a,l.y+(g?g:a))},edges:q,distance:function(l){return q(l).total},theta:function(l,a,g){g=Math.asin((l.y-a.y)/g);return l.x>a.x?g:Math.PI-g},pointOnEdge:function(l,a,g,b){a=new TILE5.Vector(Math.cos(g)*b,Math.sin(g)*b);return new TILE5.Vector(l.x-a.x,l.y-a.y)},getRect:function(l){var a=
l.length;if(a>1)return new TILE5.Rect(Math.min(l[0].x,l[a-1].x),Math.min(l[0].y,l[a-1].y),Math.abs(l[0].x-l[a-1].x),Math.abs(l[0].y-l[a-1].y))},toString:function(l){return l.x+", "+l.y}}}(),Dimensions:function(q,l){return{width:q?q:0,height:l?l:0}},D:function(){return{getAspectRatio:function(q){return q.height!==0?q.width/q.height:1},getCenter:function(q){return new v.Vector(q.width/2,q.height/2)},getSize:function(q){return Math.sqrt(Math.pow(q.width,2)+Math.pow(q.height,2))}}}(),Rect:function(q,
l,a,g){return{origin:new v.Vector(q,l),dimensions:new v.Dimensions(a,g)}},R:function(){return{copy:function(q){return q?new v.Rect(q.origin.x,q.origin.y,q.dimensions.width,q.dimensions.height):null},getCenter:function(q){return new TILE5.Vector(q.origin.x+q.dimensions.width/2,q.origin.y+q.dimensions.height/2)}}}()};return v}();
TILE5.Device=function(){function v(){for(;k.length>0;){var e=k.shift();document.location=e}m=0}function q(e){for(var o=true,r=n.length;r--;)o=o&&e!=n[r];return o}function l(e,o){var r=[];for(var u in o)u&&r.push(u+"="+escape(o[u]));return"tile5://"+e+"/"+(r.length>0?"?"+r.join("&"):"")}function a(e,o){q(e)&&GRUNT.Log.info("would push url: "+l(e,o))}function g(e,o){if(q(e)){k.push(l(e,o));m||(m=setTimeout(v,100))}}function b(){d={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:null,requireFastDraw:false,bridgeNotify:a,targetFps:null},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:false,bridgeNotify:g,targetFps:25},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:g},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:g},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,
supportsTouch:true,getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:g},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:g}};f=[d.froyo,d.android,d.ipod,d.iphone,d.ipad]}var d=null,f=[],h=null,m=0,k=[],n=["view.wake","tile.loaded"];return{getConfig:function(){d||b();if(!h){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var e=0;e<f.length;e++){var o=f[e];if(o.regex&&o.regex.test(navigator.userAgent)){h=
GRUNT.extend({},d.base,o);GRUNT.Log.info("PLATFORM DETECTED AS: "+h.name);break}}if(!h){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");h=d.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return h}}}();
TILE5.Resources=function(){var v="",q={},l=function(){function g(){var t=m[this.id];if(t&&t.image.complete&&t.image.width>0){t.loaded=true;t.hitCount=1;for(var w=e.length;w--;)if(e[w].image.src==this.src){e.splice(w,1);break}t.loadCallback&&t.loadCallback(this,false);o.push({url:this.src,created:t.requested});delete m[this.id];b()}}function b(){for(var t=TILE5.Device.getConfig().maxImageLoads;n.length>0&&(!t||e.length<t);){var w=n.shift();if(w.imageLoader){e.push(w);w.imageLoader(w,g)}}}function d(t){for(var w=
null,x=r.length;x--&&!w;)w=r[x](t);return w?w:function(z,C){z.image.onload=C;z.image.src=a.getPath(z.url);z.requested=(new Date).getTime()}}function f(){p=true;try{var t=Math.floor(o.length/2);if(t>0){o.sort(function(x,z){return x.created-z.created});for(var w=t;w--;)delete h[o[w].url];o.splice(0,t)}}finally{p=false}GRUNT.WaterCooler.say("imagecache.cleared")}var h={},m={},k=0,n=[],e=[],o=[],r=[],u=0,p=false,s={loadingImages:e,queuedImages:n,addInterceptor:function(t){r.push(t)},getCacheFullness:function(){return u},
getImage:function(t){var w=null;p||(w=h[t]);return w?w.image:null},loadImage:function(t,w){var x=h[t];if(x){x.hitCount++;x.image.complete&&w&&w(x.image,true)}else{x={url:t,image:new Image,loaded:false,imageLoader:d(t),created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:w};x.image.id="resourceLoaderImage"+k++;h[t]=x;m[x.image.id]=x;n.push(x);b()}return x},resetLoadingQueue:function(){e=[]}};setInterval(function(){for(var t=(new Date).getTime(),w=false,x=0,z=TILE5.Device.getConfig();x<
e.length;)if(t-e[x].requested>a.loadTimeout*1E3){e.splice(x,1);w=true}else x++;w&&b();if(z&&z.imageCacheMaxSize){u=o.length*a.avgImageSize/z.imageCacheMaxSize;u>=1&&f()}},1E3);return s}(),a={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(g,b){for(var d=(g?g.replace(/^.*\?/,""):"").split("&"),f=g?g.replace(/\?.*$/,"?"):"",h=0;h<d.length;h++){var m=d[h].split("=");if(!b||!b.test(m[0]))f+=d[h]+"&"}return f.replace(/\W/g,
"")},isValidCacheKey:function(g){GRUNT.Log.info("cache key = "+g);return false}}}(),addInterceptor:l.addInterceptor,getPath:function(g){return/^(file|https?|\/)/.test(g)?g:v+g},setBasePath:function(g){v=g},getImage:function(g){return l.getImage(g)},loadImage:function(g,b){l.loadImage(g,b)},resetImageLoadQueue:function(){l.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:l.loadingImages.length,queuedImageCount:l.queuedImages.length,imageCacheFullness:l.getCacheFullness()}},loadResource:function(g){g=
GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},g);var b=function(d){g.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){g.callback(d)})};g.cacheable&&q[g.filename]?b(q[g.filename]):GRUNT.XHR.ajax({url:a.getPath(g.filename),dataType:g.dataType,success:function(d){if(g.cacheable)q[g.filename]=d;b(d)},error:function(d,f,h){GRUNT.Log.error("error loading resource ["+g.filename+"], error = "+h)}})},loadSnippet:function(g,b){/\.\w+$/.test(g)||(g+=".html");a.loadResource({filename:"snippets/"+
g,callback:b,dataType:"html"})}};return a}();
TILE5.Touch=function(){function v(e,o){var r=e&&e.length>0?e[0]:null;if(r&&o&&o.length>0)return TILE5.V.diff(r,o[0]);return null}function q(e){e.preventDefault();e.stopPropagation()}function l(e){for(var o=Array(e.length),r=e.length;r--;)o[r]=new TILE5.Vector(e[r].pageX,e[r].pageY);return o}function a(e){return[new TILE5.Vector(e.pageX,e.pageY)]}var g=100,b=250,d={TAP:0,MOVE:1,PINCHZOOM:2},f=7,h=0,m=0,k={TouchHelper:function(e){function o(A,F,D,M){var O=Math.asin((A.y-F.y)/D);D=Math.min(Math.floor(D*
(U.duration/M)),U.max);O=F.x>A.x?O:Math.PI-O;A=new TILE5.Vector(Math.cos(O)*-D,Math.sin(O)*D);p("moveInertia",A.x,A.y)}function r(A,F){var D,M;if(E){D=F-S;if(D<b){M=TILE5.V.distance([H[0],A]);M>e.inertiaTrigger&&o(H[0],A,M,D)}}else{W=A;var O=setInterval(function(){D=(new Date).getTime()-F;M=TILE5.V.distance([A,W]);if(D<g&&M>e.inertiaTrigger){clearInterval(O);o(A,W,M,D)}else D>g&&clearInterval(O)},5)}}function u(A){for(var F=[],D=e.element?-e.element.offsetLeft:0,M=e.element?-e.element.offsetTop:0,
O=A.length;O--;)F.push(TILE5.V.offset(A[O],D,M));return F}function p(){e.observable&&e.observable.trigger.apply(null,arguments)}function s(A){if(A.target&&A.target===e.element){H=E?l(A.touches):a(A);I=new TILE5.Vector;Q=new TILE5.Vector;X=true;z=false;S=TILE5.Clock.getTime();E&&q(A);p("cancelInertia");Z.current=S;if(A=H.length>0?H[0]:null){p("touchStart",A.x,A.y);if(Z.current-Z.last<Y.THRESHOLD_DOUBLETAP)if((A=P?TILE5.V.diff(H[0],P[0]):null)&&Math.abs(A.x)<e.maxDistDoubleTap&&Math.abs(A.y)<e.maxDistDoubleTap)z=
true;L=d.TAP;P=[].concat(H)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function t(A){if(A.target&&A.target===e.element){W=(E?l(A.touches):a(A))[0];if(X)try{E&&q(A);var F=E?l(A.touches):a(A);A=0;if(F.length>1){if(H.length===1)H=[].concat(F);A=TILE5.V.distance(H)-TILE5.V.distance(F)}if(L===d.TAP){var D=v(F,H);if(D&&(Math.abs(D.x)>=f||Math.abs(D.y)>=f))L=d.MOVE}if(L!==d.TAP)if(!A||Math.abs(A)<e.pinchZoomThreshold){if(I=v(F,P)){Q.x-=I.x;Q.y-=I.y;R.x-=I.x;R.y-=I.y}if(TILE5.V.absSize(R)>
e.panEventThreshhold){p("move",R.x,R.y);R=TILE5.V.create()}L=d.MOVE}else{p("pinchZoom",u(H),u(F));L=d.PINCHZOOM}P=[].concat(F)}catch(M){GRUNT.Log.exception(M)}}}function w(A){if(A.target&&A.target===e.element){var F=(E?l(A.changedTouches):a(A))[0];try{E&&q(A);var D=TILE5.Clock.getTime();Z.last=Z.current;if(L===d.TAP)C||(C=setTimeout(function(){C=0;var O=z?"doubleTap":"tap",$=H[0],T=null;if(e.element)T=TILE5.V.offset($,-e.element.offsetLeft,-e.element.offsetTop);p(O,$,T)},Y.THRESHOLD_DOUBLETAP+50));
else if(L==d.MOVE){p("moveEnd",Q.x,Q.y);U&&r(F,D)}else L==d.PINCHZOOM&&p("pinchZoomEnd",u(H),u(P))}catch(M){GRUNT.Log.exception(M)}}X=false}function x(A){A=new TILE5.Vector(A.wheelDeltaX,A.wheelDeltaY);var F=A.y!==0?Math.abs(A.y/120):0;if(W&&F!==0){var D=TILE5.V.offset(W,-e.element.offsetLeft,-e.element.offsetTop);p("wheelZoom",D,Math.pow(2,A.y>0?F:-F))}}e=GRUNT.extend({element:null,observable:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,
moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},e);var z=false,C=0,E=TILE5.Device.getConfig().supportsTouch,H=null,P=null,I=null,Q=null,R=new TILE5.Vector,L=null,X=false,S=0,aa=[],W=null,U=null,Z={current:0,last:0},N=TILE5.Device.getConfig(),Y={supportsTouch:E,THRESHOLD_DOUBLETAP:300,addListeners:function(A){aa.push(A)},decoupleListeners:function(A){for(var F=0;A&&F<aa.length;F++)if(aa[F].listenerId===
A){aa.splice(F,1);GRUNT.Log.info("successfully decoupled touch listener: "+A);break}},release:function(){N.eventTarget.removeEventListener(N.supportsTouch?"touchstart":"mousedown",s,false);N.eventTarget.removeEventListener(N.supportsTouch?"touchmove":"mousemove",t,false);N.eventTarget.removeEventListener(N.supportsTouch?"touchend":"mouseup",w,false);N.supportsTouch||N.eventTarget.removeEventListener("mousewheel",x,false)},inertiaEnable:function(A,F){U={duration:A,max:F?Math.min(F.width,F.height):
500}},inertiaDisable:function(){U=null}};N.eventTarget.addEventListener(N.supportsTouch?"touchstart":"mousedown",s,false);N.eventTarget.addEventListener(N.supportsTouch?"touchmove":"mousemove",t,false);N.eventTarget.addEventListener(N.supportsTouch?"touchend":"mouseup",w,false);N.supportsTouch||N.eventTarget.addEventListener("mousewheel",x,false);return Y}},n=[];return{captureTouch:function(e,o){if(!e)throw Error("Unable to capture touch of null element");if(!e.id)e.id="touchable_"+h++;var r=n[e.id];
if(!r){r=k.TouchHelper(GRUNT.extend({element:e},o));n[e.id]=r;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+r.supportsTouch)}o.listenerId&&r.decoupleListeners(o.listenerId);o.listenerId=++m;r.addListeners(o);return r},resetTouch:function(e){if(e&&e.id&&n[e.id]){n[e.id].release();delete n[e.id]}}}}();
if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(v){return this.each(function(){TILE5.Touch.captureTouch(this,v)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(v){v.preventDefault()})}}
TILE5.Dispatcher=function(){var v=[],q={execute:function(l){var a=q.findAction(l);GRUNT.Log.info("looking for action id: "+l+", found: "+a);if(a){var g=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+l,function(){a.execute(g)})}},findAction:function(l){for(var a=v.length;a--;)if(v[a].id==l)return v[a];return null},getRegisteredActions:function(){return[].concat(v)},getRegisteredActionIds:function(){for(var l=[],a=v.length;a--;)v[a].id&&l.push(v[a].id);return l},registerAction:function(l){l&&
l.id&&v.push(l)},Action:function(l){l=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},l);var a={id:l.id,execute:function(){l.execute&&l.execute.apply(this,arguments)},getParam:function(g){return l[g]?l[g]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",a.id,l.title,l.icon)}};l.autoRegister&&q.registerAction(a);return a},createAgent:function(l){l=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},l);var a=null,g={getName:function(){return l.name},
getParam:function(b){return l[b]},getId:function(){return GRUNT.toID(g.getName())},run:function(b,d){if(l.execute){var f=a=TILE5.Clock.getTime(true),h=l.translator?l.translator(b):b;l.execute.call(g,h,function(m,k){if(!l.trashOrphanedResults||f==a)d&&d(m,k,h)})}}};return g},runAgents:function(l,a,g){for(var b=0;b<l.length;b++)l[b].run(a,g)}};return q}();
TILE5.Animation=function(){function v(){if(a===0)a=setInterval(function(){var b;b=TILE5.Clock.getTime();if(!l){l=true;try{for(var d=0;d<q.length;)if(q[d].isComplete()){q[d].triggerComplete(false);q.splice(d,1);GRUNT.WaterCooler.say("animation.complete")}else{q[d].update(b);d++}}finally{l=false}}b=q.length;if(b===0){clearInterval(a);a=0}},20)}var q=[],l=false,a=0,g={DURATION:2E3,tweenValue:function(b,d,f,h,m){b=new g.Tween({startValue:b,endValue:d,tweenFn:f,complete:h,duration:m});q.push(b);return b},
tween:function(b,d,f,h,m,k){b=new g.Tween({target:b,property:d,endValue:f,tweenFn:h,duration:k,complete:m});q.push(b);return b},tweenVector:function(b,d,f,h,m,k){var n=[];if(b){var e=b.x==d,o=b.y==f;e||n.push(g.tween(b,"x",d,h,function(){(e=true)&&o&&m()},k));o||n.push(g.tween(b,"y",f,h,function(){o=true;e&&o&&m()},k))}return n},cancel:function(b){if(!l){l=true;try{for(var d=0;d<q.length;)if(!b||b(q[d])){q[d].triggerComplete(true);q.splice(d,1)}else d++}finally{l=false}}},isTweening:function(){return q.length>
0},Tween:function(b){b=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:g.DURATION,tweenFn:g.DEFAULT,complete:null,cancelOnInteract:false},b);var d=TILE5.Clock.getTime(),f=[],h=false,m=0,k=0,n={cancelOnInteract:b.cancelOnInteract,isComplete:function(){return h},triggerComplete:function(e){b.complete&&b.complete(e)},update:function(e){try{var o=b.tweenFn(e-d,m,k,b.duration);if(b.target)b.target[b.property]=o;for(var r=f.length;r--;)f[r](o,void 0);if(h=d+b.duration<=e){if(b.target)b.target[b.property]=
b.tweenFn(b.duration,m,k,b.duration);for(var u=f.length;u--;)f[u](o,true)}}catch(p){GRUNT.Log.exception(p)}},requestUpdates:function(e){f.push(e)}};m=b.target&&b.property&&b.target[b.property]?b.target[b.property]:b.startValue;if(typeof b.endValue!=="undefined")k=b.endValue-m;if(k==0)h=true;v();return n},Easing:function(){var b=1.70158;return{Linear:function(d,f,h,m){return h*d/m+f},Back:{In:function(d,f,h,m){return h*(d/=m)*d*((b+1)*d-b)+f},Out:function(d,f,h,m){return h*((d=d/m-1)*d*((b+1)*d+b)+
1)+f},InOut:function(d,f,h,m){return(d/=m/2)<1?h/2*d*d*(((b*=1.525)+1)*d-b)+f:h/2*((d-=2)*d*(((b*=1.525)+1)*d+b)+2)+f}},Bounce:{In:function(d,f,h,m){return h-g.Easing.Bounce.Out(m-d,0,h,m)+f},Out:function(d,f,h,m){return(d/=m)<1/2.75?h*7.5625*d*d+f:d<2/2.75?h*(7.5625*(d-=1.5/2.75)*d+0.75)+f:d<2.5/2.75?h*(7.5625*(d-=2.25/2.75)*d+0.9375)+f:h*(7.5625*(d-=2.625/2.75)*d+0.984375)+f},InOut:function(d,f,h,m){return d<m/2?g.Easing.Bounce.In(d*2,0,h,m)/2+f:g.Easing.Bounce.Out(d*2-m,0,h,m)/2+h/2+f}},Cubic:{In:function(d,
f,h,m){return h*(d/=m)*d*d+f},Out:function(d,f,h,m){return h*((d=d/m-1)*d*d+1)+f},InOut:function(d,f,h,m){if((d/=m/2)<1)return h/2*d*d*d+f;return h/2*((d-=2)*d*d+2)+f}},Elastic:{In:function(d,f,h,m,k,n){if(d==0)return f;if((d/=m)==1)return f+h;n||(n=m*0.3);if(!k||k<Math.abs(h)){k=h;h=n/4}else h=n/(2*Math.PI)*Math.asin(h/k);return-(k*Math.pow(2,10*(d-=1))*Math.sin((d*m-h)*2*Math.PI/n))+f},Out:function(d,f,h,m,k,n){var e;if(d==0)return f;if((d/=m)==1)return f+h;n||(n=m*0.3);if(!k||k<Math.abs(h)){k=
h;e=n/4}else e=n/(2*Math.PI)*Math.asin(h/k);return k*Math.pow(2,-10*d)*Math.sin((d*m-e)*2*Math.PI/n)+h+f},InOut:function(d,f,h,m,k,n){var e;if(d==0)return f;if((d/=m/2)==2)return f+h;n||(n=m*0.3*1.5);if(!k||k<Math.abs(h)){k=h;e=n/4}else e=n/(2*Math.PI)*Math.asin(h/k);if(d<1)return-0.5*k*Math.pow(2,10*(d-=1))*Math.sin((d*m-e)*2*Math.PI/n)+f;return k*Math.pow(2,-10*(d-=1))*Math.sin((d*m-e)*2*Math.PI/n)*0.5+h+f}},Quad:{In:function(d,f,h,m){return h*(d/=m)*d+f},Out:function(d,f,h,m){return-h*(d/=m)*(d-
2)+f},InOut:function(d,f,h,m){if((d/=m/2)<1)return h/2*d*d+f;return-h/2*(--d*(d-2)-1)+f}},Sine:{In:function(d,f,h,m){return-h*Math.cos(d/m*(Math.PI/2))+h+f},Out:function(d,f,h,m){return h*Math.sin(d/m*(Math.PI/2))+f},InOut:function(d,f,h,m){return-h/2*(Math.cos(Math.PI*d/m)-1)+f}}}}()};return GRUNT.extend(g,{DEFAULT:g.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var v={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},q=0,l={DisplayState:v,AnyDisplayState:255,ActiveDisplayStates:v.ACTIVE|v.ANIMATING,DefaultDisplayStates:v.ACTIVE|v.ANIMATING|v.PAN|v.PINCHZOOM,ViewLayer:function(a){a=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:l.DefaultDisplayStates},a);var g=null,b=a.id,d=GRUNT.extend({addToView:function(f){f.setLayer(b,d)},shouldDraw:function(f){var h=
g?g.fastDraw&&f!==v.ACTIVE:false;return(f&a.validStates)!==0&&(h?a.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:b})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:g?g.id:null})},getId:function(){return b},setId:function(f){b=f},getParent:function(){return g},setParent:function(f){g=f}},a);return d},AnimatedPathLayer:function(a){function g(k,n,e){k.fillStyle="#FFFFFF";k.strokeStyle="#222222";k.beginPath();
k.arc(e.x,e.y,4,0,Math.PI*2,false);k.stroke();k.fill()}a=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,validStates:l.ActiveDisplayStates|v.PAN|v.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},a);var b=TILE5.V.edges(a.path),d,f=null,h=0;TILE5.Animation.tweenValue(0,b.total,a.easing,function(){m.remove()},a.duration).requestUpdates(function(k,n){h=k;n&&m.remove()});var m=GRUNT.extend(new l.ViewLayer(a),{cycle:function(){for(var k=
0;k<b.accrued.length&&b.accrued[k]<h;)k++;f=null;if(k<a.path.length-1){var n=h-(k>0?b.accrued[k-1]:0),e=a.path[k],o=a.path[k+1];d=TILE5.V.theta(e,o,b.edges[k]);f=TILE5.V.pointOnEdge(e,o,d,n);if(a.autoCenter)(k=m.getParent())&&k.centerOn(f)}return f?1:0},draw:function(k,n){if(f)(a.drawIndicator?a.drawIndicator:g)(k,n,new TILE5.Vector(f.x-n.x,f.y-n.y),d)}});return m},View:function(a){function g(y,B,G,J){R=typeof G!=="undefined";K.updateOffset(s.x+y,s.y+B,G,J);o();T=v.PAN}function b(){T=v.ACTIVE;R=false;
setTimeout(o,50)}function d(y,B){A=TILE5.V.getRect(y);F=TILE5.V.getRect(B);var G=TILE5.D.getSize(A.dimensions),J=TILE5.D.getSize(F.dimensions);$=TILE5.R.getCenter(A);I=TILE5.R.getCenter(F);D=A&&G!==0?J/G:1}function f(){GRUNT.WaterCooler.say("view.scale",{id:K.id});Y=false;K.trigger("scale",D,A?m():I);T=l.DisplayState.ACTIVE;D=1;o()}function h(y,B){B.setId(y);B.setParent(K);r.push(B);r.sort(function(G,J){var V=J.zindex-G.zindex;if(V===0)V=J.created-G.created;return V})}function m(){var y=TILE5.D.getCenter(C),
B=TILE5.V.distance([I,y]),G=TILE5.V.theta(I,y,B),J=TILE5.V.diff($,I);y=TILE5.V.pointOnEdge(I,y,G,B/D);y.x+=J.x;y.y+=J.y;return y}function k(){GRUNT.WaterCooler.say("view.idle",{id:K.id});Q=true;S=0}function n(y,B){var G=0,J=K.getDisplayState(),V=(new Date).getTime(),ca=(J&v.PINCHZOOM)!==0,ba=0;if(t||ca){y.clearRect(0,0,u.width,u.height);t=false}if(ca){TILE5.D.getCenter(C);var ea=(M?M:1)/2,da=TILE5.V.diff($,I);if(W=A?new TILE5.Vector(I.x+da.x,I.y+da.y):new TILE5.Vector(I.x-da.x*ea,I.y-da.y*ea))B=TILE5.V.offset(B,
W.x,W.y)}y.save();try{if(z!==1)y.scale(z,z);else if(ca){y.translate(I.x,I.y);y.scale(D,D)}for(ba=r.length;ba--;)if(r[ba].shouldDraw(J)){var fa=r[ba].draw(y,B,C,J,K);G+=fa?fa:0}}finally{y.restore()}GRUNT.Log.trace("draw complete",V);X=false;return G}function e(){var y=0,B=!R&&(T===v.PINCHZOOM||T===v.PAN);U=(new Date).getTime();s.x=Math.floor(s.x);s.y=Math.floor(s.y);P&&w&&P.delays.push(U-w);if(B){TILE5.Animation.cancel(function(J){return J.cancelOnInteract});Q=false;if(S!==0){clearTimeout(S);S=0}}for(B=
r.length;B--;){var G=r[B].cycle(U,s,T);y+=G?G:0}if(w+N<U){y+=n(p,s);w=U}L=0;if(H+y>0)o();else if(!Q&&S===0)S=setTimeout(k,500);GRUNT.Log.trace("Completed draw cycle",U)}function o(){H++;if(!(x||L!==0)){H=0;L=setTimeout(e,0)}}a=GRUNT.extend({id:"view_"+q++,container:"",clearOnDraw:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,inertialScroll:true,panAnimationEasing:TILE5.Animation.Easing.Sine.Out,panAnimationDuration:750,
autoSize:false},a);var r=[],u=document.getElementById(a.container),p=null,s=new TILE5.Vector,t=false,w=null,x=false,z=1,C=null,E=null,H=0,P=null,I=null,Q=false,R=false,L=0,X=false,S=0,aa=0,W=null,U=0,Z=TILE5.Device.getConfig().targetFps,N=0,Y=false,A=null,F=null,D=1,M=null,O=null,$=null;E=null;var T=l.DisplayState.ACTIVE;if(u){TILE5.Touch.resetTouch(u);if(a.autoSize){u.height=window.innerHeight-u.offsetTop;u.width=window.innerWidth-u.offsetLeft}try{p=u.getContext("2d");p.globalCompositeOperation=
a.initialDrawMode;p.clearRect(0,0,u.width,u.height)}catch(ga){GRUNT.Log.exception(ga);throw Error("Could not initialise canvas on specified view element");}}var K=GRUNT.extend({},a,new GRUNT.Observable,{id:a.id,deviceScaling:z,fastDraw:a.fastDraw||TILE5.Device.getConfig().requireFastDraw,animate:function(y,B,G,J,V){function ca(){V&&V();f();D=1;M=null}Y=true;$=TILE5.V.copy(B);I=TILE5.V.copy(G);A=null;if(J){O=D;TILE5.Animation.tweenValue(0,y-O,J,ca,1E3).requestUpdates(function(ba){M=ba/(y-O);D=O+ba;
T=l.DisplayState.PINCHZOOM;o();K.trigger("animate")})}else{D=y;ca()}},centerOn:function(y){K.setOffset(y.x-u.width/2,y.y-u.height/2)},getDimensions:function(){if(u)return new TILE5.Dimensions(u.width,u.height)},getZoomCenter:function(){return W},getLayer:function(y){for(var B=0;B<r.length;B++)if(r[B].getId()==y)return r[B];return null},setLayer:function(y,B){for(var G=0;G<r.length;G++)if(r[G].getId()===y){r.splice(G,1);break}B&&h(y,B);GRUNT.WaterCooler.say("layer.update",{id:y});o()},eachLayer:function(y){for(var B=
0;B<r.length;B++)y(r[B])},clearBackground:function(){t=true},freeze:function(){x=true},unfreeze:function(){x=false;o()},needRepaint:function(){return X},snapshot:function(){},getDisplayState:function(){return x?v.FROZEN:T},scale:function(y,B,G,J,V){J||(J=TILE5.D.getCenter(C));V||(V=TILE5.D.getCenter(C));K.animate(y,J,V,B,G);return K},removeLayer:function(y){a:{for(var B=r.length;B--;)if(r[B].getId()==y){y=B;break a}y=-1}if(y>=0&&y<r.length){GRUNT.WaterCooler.say("layer.removed",{layer:r[y]});r.splice(y,
1)}},getOffset:function(){return TILE5.V.copy(s)},setOffset:function(y,B){s.x=y;s.y=B},updateOffset:function(y,B,G,J){if(G){y=new TILE5.Vector(y,B);animating=true;G=TILE5.Animation.tweenVector(s,y.x,y.y,G,function(){animating=false;b(0,0)},J);for(J=G.length;J--;){G[J].cancelOnInteract=true;G[J].requestUpdates(function(){o();a.onAnimate&&a.onAnimate(s.x,s.y)})}}else K.setOffset(y,B)},zoom:function(y,B,G){R=false;D=B;Y=D!==1;$=TILE5.D.getCenter(K.getDimensions());I=D>1?TILE5.V.copy(y):TILE5.D.getCenter(K.getDimensions());
A=null;clearTimeout(aa);if(Y){T=l.DisplayState.PINCHZOOM;o();if(G)aa=setTimeout(f,parseInt(G,10))}}});C=K.getDimensions();E=TILE5.D.getCenter(C);if(Z)N=Math.ceil(1E3/Z);GRUNT.WaterCooler.listen("layer.remove",function(y){y.id&&K.removeLayer(y.id)});GRUNT.WaterCooler.listen("view.wake",function(y){if(!y.id||y.id===K.id)o()});z=TILE5.Device.getConfig().getScaling();K.bind("invalidate",function(){X=true});E=TILE5.Touch.captureTouch(u,{observable:K});K.bind("move",g);K.bind("moveEnd",b);K.bind("pinchZoom",
function(y,B){d(y,B);if(Y=D!==1){T=l.DisplayState.PINCHZOOM;o()}});K.bind("pinchZoomEnd",function(y,B){d(y,B);f();D=1});K.bind("wheelZoom",function(y,B){K.zoom(y,Math.min(Math.pow(2,Math.round(Math.log(B))),8),500)});a.inertialScroll&&E.inertiaEnable(a.panAnimationDuration,C);K.bind("moveInertia",function(y,B){a.inertialScroll&&g(y,B,a.panAnimationEasing,a.panAnimationDuration)});K.bind("cancelInertia",function(){R=false;o()});o();return K}};return l}();
TILE5.Tiling=function(){function v(){if(!l){l=TILE5.newCanvas(g.Config.TILESIZE,g.Config.TILESIZE);var b=l.getContext("2d");b.fillStyle="rgba(150, 150, 150, 0.01)";b.fillRect(0,0,l.width,l.height)}return l}function q(){function b(){var f=TILE5.newCanvas(32,32),h=f.getContext("2d");h.fillStyle="#BBBBBB";h.fillRect(0,0,32,32);h.fillStyle="#C3C3C3";h.fillRect(0,0,16,16);h.fillRect(16,16,16,16);return f}if(!a){a=TILE5.newCanvas(g.Config.TILESIZE,g.Config.TILESIZE);var d=a.getContext("2d");d.fillStyle=
d.createPattern(b(),"repeat");d.fillRect(0,0,a.width,a.height)}return a}TileStore=function(b){b=GRUNT.extend({tileSize:null,gridSize:25,center:new TILE5.Vector,onPopulate:null},b);if(!b.tileSize)throw Error("Cannot create TileStore with an empty tile size");var d=Array(Math.pow(b.gridSize,2)),f=TILE5.V.offset(b.center,-Math.ceil(b.gridSize>>1)),h=null,m=new TILE5.Vector,k=null,n={getGridSize:function(){return b.gridSize},getNormalizedPos:function(e,o){return TILE5.V.add(new TILE5.Vector(e,o),TILE5.V.invert(f),
m)},getTileShift:function(){return TILE5.V.copy(m)},getTile:function(e,o){return e>=0&&e<b.gridSize?d[o*b.gridSize+e]:null},setTile:function(e,o,r){d[o*b.gridSize+e]=r},populate:function(e,o){var r=GRUNT.Log.getTraceTicks(),u=0,p=b.gridSize,s=b.tileSize;new TILE5.Vector(p/2,p/2);if(e)for(var t=0;t<p;t++)for(var w=0;w<p;w++){if(!d[u]){var x=e(w,t,f,p);x.gridX=w*s-m.x;x.gridY=t*s-m.y;d[u]=x}u++}h=e;k=o;GRUNT.Log.trace("tile grid populated",r);b.onPopulate&&b.onPopulate()},getShiftDelta:function(e,o,
r,u){var p=Math.floor(b.gridSize*0.2),s=new TILE5.Vector;if(e<0||e+r>b.gridSize)s.x=e<0?-p:p;if(o<0||o+u>b.gridSize)s.y=o<0?-p:p;return s},shift:function(e,o){if(!(e.x===0&&e.y===0)){var r=GRUNT.Log.getTraceTicks();GRUNT.Log.info("need to shift tile store grid, "+e.x+" cols and "+e.y+" rows.");var u=Array(d.length);u.length=d.length;for(var p=0;p<b.gridSize;p++)for(var s=0;s<b.gridSize;s++)u[s*b.gridSize+p]=n.getTile(p+e.x,s+e.y);d=u;f=o?o(f,e):TILE5.V.add(f,e);m.x+=-e.x*b.tileSize;m.y+=-e.y*b.tileSize;
GRUNT.Log.trace("tile storage shifted",r);n.populate(h,k)}},setOrigin:function(e,o){if(tileOrigin)shiftOrigin(e,o);else f=TILE5.V.offset(new TILE5.Vector(e,o),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var e=d.length;e--;)if(d[e])d[e].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var e=d.length;e--;)if(d[e]){d[e].x=null;d[e].y=null}});return n};var l=null,a=null,g={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(b){return b=
GRUNT.extend({gridX:0,gridY:0,size:256,dirty:false},b)},ImageTile:function(b){b=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},b);return new g.Tile(b)},TileGrid:function(b){function d(x,z){if(t){var C,E=[],H=new TILE5.Vector(Math.floor((x.x+r.x)*m),Math.floor((x.y+r.y)*m));tilesNeeded=false;for(var P=s;P--;)for(var I=p;I--;){C=f.getTile(I+H.x,P+H.y);var Q=new TILE5.Vector(I-t.x,P-t.y);C||(o=f.getShiftDelta(H.x,H.y,p,s));E.push({tile:C,centerness:TILE5.V.absSize(Q)})}E.sort(function(R,L){return L.centerness-
R.centerness});n||(n=Array(E.length));for(C=E.length;C--;){n[C]=E[C].tile;w.prepTile(n[C],z)}}}b=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},b);var f=new TileStore(GRUNT.extend({tileSize:b.tileSize,onPopulate:function(){w.dirty=true;w.wakeParent()}},b)),h=Math.round(b.tileSize/2),m=b.tileSize?1/b.tileSize:0,k=true,n=null,e=false;new TILE5.Vector;var o=new TILE5.Vector,r=new TILE5.Vector;TILE5.Device.getConfig();
var u=f.getGridSize()*b.tileSize,p,s,t,w=GRUNT.extend(new TILE5.Graphics.ViewLayer(b),{gridDimensions:new TILE5.Dimensions(u,u),dirty:false,cycle:function(x,z,C){x=0;if(o.x+o.y!==0){f.shift(o,b.shiftOrigin);r=f.getTileShift();o=new TILE5.Vector;x++}C!==TILE5.Graphics.DisplayState.PINCHZOOM&&d(z,C);return x+w.dirty?1:0},deactivate:function(){k=false},prepTile:function(){},drawTile:function(){return false},draw:function(x,z,C,E,H){if(k){var P=(new Date).getTime(),I=z.x;z=z.y;var Q=true,R=H.needRepaint()||
E===TILE5.Graphics.DisplayState.PANNING||E===TILE5.Graphics.DisplayState.PINCHZOOM||TILE5.Animation.isTweening();if(!t){p=Math.ceil(C.width*m)+1;s=Math.ceil(C.height*m)+1;t=new TILE5.Vector(Math.floor((p-1)/2),Math.floor((s-1)/2))}if(n){if(b.drawGrid)x.strokeStyle="rgba(50, 50, 50, 0.3)";x.beginPath();for(C=n.length;C--;){var L=n[C];if(L){var X=L.gridX-I,S=L.gridY-z;Q=((R?false:!L.dirty)?true:w.drawTile(x,L,X,S,E))&&Q}else Q=false;b.drawGrid&&x.rect(X,S,b.tileSize,b.tileSize)}x.stroke();GRUNT.Log.trace("drawn tiles",
P);Q&&!e&&H.trigger("tileDrawComplete");e=Q;w.dirty=false}}},getTileVirtualXY:function(x,z,C){x=f.getNormalizedPos(x,z);x=new TILE5.Vector(x.x*b.tileSize,x.y*b.tileSize);if(C){x.x+=h;x.y+=h}return x},populate:function(x){f.populate(x,function(){})}});return w},ImageTileGrid:function(b){function d(){e.getParent().trigger("invalidate");e.dirty=true;e.wakeParent()}b=GRUNT.extend({},b);var f=v(),h=q(),m=TILE5.Graphics.DisplayState.ACTIVE,k=TILE5.Graphics.DisplayState.PAN,n=TILE5.Device.getConfig().requireFastDraw,
e=GRUNT.extend(new g.TileGrid(b),{drawTile:function(o,r,u,p,s){var t=TILE5.Resources.getImage(r.url),w=false;if(t&&t.complete&&t.width>0){o.drawImage(t,u,p);r.dirty=false;w=true}else s===k?o.drawImage(h,u,p):o.drawImage(f,u,p);return w},prepTile:function(o,r){o.dirty=true;if(o&&(!n||r===m))TILE5.Resources.getImage(o.url)||TILE5.Resources.loadImage(o.url,d)}});return e},Tiler:function(b){b=GRUNT.extend({container:"",drawCenter:false,datasources:{},tileLoadThreshold:"first"},b);var d=new TILE5.Graphics.View(GRUNT.extend({},
b,{pannable:true,scalable:true,scaleDamping:true}));GRUNT.extend(d,{getTileLayer:function(){return d.getLayer("grid0")},setTileLayer:function(f){d.setLayer("grid0",f);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(f){var h=d.getOffset();return new TILE5.Vector(f.x+h.x,f.y+h.y)},cleanup:function(){d.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");GRUNT.WaterCooler.say("view.wake",{id:d.id})}});return d}};return g}();
TILE5.Geo=function(){function v(m,k){var n=null;for(var e in f)if(k){if(e==k&&f[e][m]){n=f[e];break}}else if(f[e][m]){n=f[e];break}return n}function q(m,k,n,e){var o=0;m=m.toUpperCase();for(var r in e){var u=k[r];if(u){var p=n[r];u=p?p(m,u):m.containsWord(u)?1:0;o+=u*e[r]}}return o}var l=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],a=Math.PI/180,g=180/Math.PI,b=null,d={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},f={},h={Engine:function(m){if(!m.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var k=GRUNT.extend({remove:function(){delete f[k.id]}},m);return f[k.id]=k},Radius:function(m,k){return{distance:parseInt(m,10),uom:k}},Position:function(m,k){return{lat:parseFloat(m?m:0),lon:parseFloat(k?k:0)}},BoundingBox:function(m,k){return{min:h.P.parse(m),max:h.P.parse(k)}},Address:function(m){return m=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},m)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var m={dist2rad:function(k){return k/6371},lat2pix:function(k,n){var e=parseFloat(k)*2*Math.PI/360;e=Math.sin(e);var o=0.08181919084262157*e;return Math.log((1+e)/(1-e)*Math.pow((1-o)/(1+o),0.08181919084262157))/2/n},lon2pix:function(k,n){return parseFloat(k)/180*Math.PI/n},pix2lon:function(k,n){return m.normalizeLon(k*n*180/Math.PI)},pix2lat:function(k,n){for(var e=Math.pow(Math.E,
-k*n),o=m.mercatorUnproject(e),r=m.findRadPhi(o,e),u=0;u<12&&Math.abs(o-r)>1.0E-7;){o=r;r=m.findRadPhi(o,e);u++}return r*180/Math.PI},mercatorUnproject:function(k){return Math.PI/2-2*Math.atan(k)},findRadPhi:function(k,n){var e=0.08181919084262157*Math.sin(k);return Math.PI/2-2*Math.atan(n*Math.pow((1-e)/(1+e),0.040909595421310785))},normalizeLon:function(k){for(;k<-180;)k+=360;for(;k>180;)k-=360;return k}};return m}(),GeoSearchResult:function(m){m=GRUNT.extend({id:null,caption:"",resultType:"",data:null,
pos:null,matchWeight:0},m);return GRUNT.extend(m,{toString:function(){return m.caption+(m.matchWeight?" ("+m.matchWeight+")":"")}})},GeoSearchAgent:function(m){return TILE5.Dispatcher.createAgent(m)},GeocodingAgent:function(m){m=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(k,n){try{if(!k.reverse&&!k.freeform)address=new h.Address(k);var e=h.getEngine("geocode");if(e)e.geocode({addresses:[k.freeform?k.freeform:address],complete:function(r,u){if(n){var p=u;if(k.freeform)p=
h.rankGeocodeResponses(k.freeform,p,h.getEngine("geocode"));n(p,m)}}})}catch(o){GRUNT.Log.exception(o)}}},m);return new h.GeoSearchAgent(m)},PointOfInterest:function(m){m=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},m);if(!m.pos&&m.lat&&m.lon)m.pos=new TILE5.Geo.Position(m.lat,m.lon);return GRUNT.extend({toString:function(){return m.id+": '"+m.title+"'"}},m)},POIStorage:function(m){function k(p){p=p?p:"default";o[p]||(o[p]=[]);return o[p]}function n(p){var s=
[];for(var t in o)for(var w=0;w<o[t].length;w++)if(!p||p(o[t][w]))s.push(o[t][w]);return s}function e(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:u.id,pois:u.getPOIs()})}m=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},m);var o={},r=true,u={id:GRUNT.generateObjectID(),getPOIs:function(){return n()},getOldPOIs:function(p,s){return n(function(t){return t.group==p&&t.retrieved<s})},getVisible:function(){return r},setVisible:function(p){if(p!=r){r=p;m.visibilityChange&&m.visibilityChange()}},
findById:function(p){var s=n(function(t){return t.id==p});return s.length>0?s[0]:null},findByBounds:function(p){return n(function(s){return TILE5.Geo.P.inBounds(s.pos,p)})},addPOIs:function(p,s){if(s)o={};for(var t=0;p&&t<p.length;t++){p[t].retrieved=TILE5.Clock.getTime(true);var w=p[t];k(w.group).push(w)}},removeGroup:function(p){if(o[p]){delete o[p];e()}},update:function(p){var s=[],t=0,w=p.length>0?p[0].group:"",x=TILE5.Clock.getTime(true);for(t=0;t<p.length;t++){var z;a:{if(z=p[t])for(var C=k(z.group),
E=0;E<C.length;E++)if(C[E].id==z.id){z=C[E];break a}z=null}if(z){z.retrieved=x;z.isNew=false}else s.push(p[t])}p=u.getOldPOIs(w,x);u.addPOIs(s);for(t=0;m.onPOIAdded&&t<s.length;t++)m.onPOIAdded(s[t]);for(t=0;t<p.length;t++){m.onPOIDeleted&&m.onPOIDeleted(p[t]);w=p[t];x=k(w.group);for(z=0;z<x.length;z++)if(x[z].id==w.id){x.splice(z,1);break}}s.length+p.length>0&&e()}};return u},MapProvider:function(){var m=1,k=20;return{zoomLevel:0,checkZoomLevel:function(n){return Math.min(Math.max(n,m),k)},getCopyright:function(){},
getLogoUrl:function(){},getMapTiles:function(){},getPositionForXY:function(){return null},getZoomRange:function(){return{min:m,max:k}},setZoomRange:function(n,e){m=n;k=e}}},P:function(){var m={calcDistance:function(k,n){if(m.empty(k)||m.empty(n))return 0;var e=(n.lat-k.lat).toRad()/2,o=(n.lon-k.lon).toRad()/2;e=Math.sin(e)*Math.sin(e)+Math.cos(k.lat.toRad())*Math.cos(n.lat.toRad())*Math.sin(o)*Math.sin(o);return 6371*2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e))},copy:function(k){return k?new h.Position(k.lat,
k.lon):null},empty:function(k){return!k||k.lat===0&&k.lon===0},equal:function(k,n){return k&&n&&k.lat==n.lat&&k.lon==n.lon},almostEqual:function(k,n){return k&&n&&Math.floor(k.lat*1E3)===Math.floor(n.lat*1E3)&&Math.floor(k.lon*1E3)===Math.floor(n.lon*1E3)},inArray:function(k,n){for(var e=h.P.equal,o=n.length;o--;)if(e(k,n[o]))return true;return false},inBounds:function(k,n){var e=!(h.P.empty(k)||h.P.empty(n));return e=(e=e&&k.lat>=n.min.lat&&k.lat<=n.max.lat)&&k.lon>=n.min.lon&&k.lon<=n.max.lon},
parse:function(k){if(k)if(typeof k.lat!=="undefined")return m.copy(k);else{if(k.split)for(var n=[" ",","],e=0;e<n.length;e++){var o=k.split(n[e]);if(o.length===2)return new h.Position(o[0],o[1])}}else return new h.Position;return null},parseArray:function(k){var n=k.length,e=Array(n);for(n=n;n--;)e[n]=m.parse(k[n]);GRUNT.Log.info("parsed "+e.length+" positions");return e},fromMercatorPixels:function(k,n,e){return new h.Position(TILE5.Geo.Utilities.pix2lat(n,e),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(k,
e)))},toMercatorPixels:function(k,n){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(k.lon,n),TILE5.Geo.Utilities.lat2pix(k.lat,n))},generalize:function(k,n,e){var o=k.length,r=[],u=null;e||(e=250);e/=1E3;GRUNT.Log.info("generalizing positions, must include "+n.length+" positions");for(var p=o;p--;)if(p===0)r.unshift(k[p]);else{var s=!u||h.P.inArray(k[p],n)?e:h.P.calcDistance(u,k[p]);if(k[p]&&s>=e){r.unshift(k[p]);u=k[p]}}GRUNT.Log.info("generalized "+o+" positions into "+r.length+" positions");
return r},toString:function(k){return k?k.lat+" "+k.lon:""}};return m}(),B:function(){var m=-(Math.PI/2),k=Math.PI/2,n=-Math.PI*2,e=Math.PI*2,o={calcSize:function(r,u,p){var s=new TILE5.Vector(0,u.lat-r.lat);if(typeof p==="undefined")p=true;s.x=p&&r.lon>u.lon?360-r.lon+u.lon:u.lon-r.lon;return s},createBoundsFromCenter:function(r,u){var p=u/6371,s=r.lat*a,t=r.lon*a,w=s-p,x=s+p;if(w>m&&x<k){s=Math.asin(Math.sin(p)/Math.cos(s));p=t-s;if(p<n)p+=2*Math.PI;t=t+s;if(t>e)t-=2*Math.PI}else{w=Math.max(w,m);
x=Math.min(x,k);p=n;t=e}return new h.BoundingBox(new h.Position(w*g,p*g),new h.Position(x*g,t*g))},expand:function(r,u){return new h.BoundingBox(new h.Position(r.min.lat-u,r.min.lon-h.Utilities.normalizeLon(u)),new h.Position(r.max.lat+u,r.max.lon+h.Utilities.normalizeLon(u)))},forPositions:function(r,u){var p=null,s=TILE5.Clock.getTime();u||(u="auto");for(var t=r.length;t--;)if(p){var w=o.calcSize(p.min,r[t],false),x=o.calcSize(r[t],p.max,false);if(w.x<0)p.min.lon=r[t].lon;if(w.y<0)p.min.lat=r[t].lat;
if(x.x<0)p.max.lon=r[t].lon;if(x.y<0)p.max.lat=r[t].lat}else p=new TILE5.Geo.BoundingBox(r[t],r[t]);if(u){if(u=="auto"){t=o.calcSize(p.min,p.max);u=Math.max(t.x,t.y)*0.3}p=o.expand(p,u)}GRUNT.Log.trace("calculated bounds for "+r.length+" positions",s);return p},getCenter:function(r){var u=h.B.calcSize(r.min,r.max);return new TILE5.Geo.Position(r.min.lat+u.y/2,r.min.lon+u.x/2)},getGeoHash:function(r){var u=TILE5.Geo.GeoHash.encode(r.min.lat,r.min.lon);r=TILE5.Geo.GeoHash.encode(r.max.lat,r.max.lon);
GRUNT.Log.info("min hash = "+u+", max hash = "+r)},getZoomLevel:function(r,u){var p=o.getCenter(r),s=l[Math.min(Math.round(Math.abs(p.lat)*0.05),l.length)],t=o.calcSize(r.min,r.max);p=Math.ceil(Math.log(l[3]*u.height/t.y)/Math.log(2));s=Math.ceil(Math.log(s*u.width/t.x)/Math.log(2));return Math.min(isNaN(p)?1E3:p,isNaN(s)?1E3:s)},isEmpty:function(r){return!r||h.P.empty(r.min)||h.P.empty(r.max)},toString:function(r){return"min: "+h.P.toString(r.min)+", max: "+h.P.toString(r.max)}};return o}(),A:function(){var m=
/^(\d+).*$/,k=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(n,e){m.lastIndex=-1;if(m.test(n))for(var o=n.replace(m,"$1"),r=e.split(","),u=0;u<r.length;u++){k.lastIndex=-1;if(k.test(r[u])){var p=k.exec(r[u]);if(o>=parseInt(p[1],10)&&o<=parseInt(p[2],10))return true}else if(o==r[u])return true}return false},normalize:function(n){if(!n)return"";n=n.toUpperCase();if(!b){var e=[];for(var o in d)e.push(o);b=RegExp("(\\s)("+e.join("|")+")(\\s|$)","i")}b.lastIndex=-1;if(e=b.exec(n))n=n.replace(b,"$1"+
d[e[2]]);return n},toString:function(n){return n.streetDetails+" "+n.location}}}(),getEngine:function(m){for(var k=null,n=1;!k&&n<arguments.length;n++)k=v(m,arguments[n]);k=k?k:v(m);if(!k)throw Error("Unable to find GEO engine with "+m+" capability");return k},rankGeocodeResponses:function(m,k,n){var e=[],o=h.AddressCompareFns;if(n&&n.compareFns)o=GRUNT.extend({},o,n.compareFns);for(n=0;n<k.length;n++)e.push(new h.GeoSearchResult({caption:h.A.toString(k[n]),data:k[n],pos:k[n].pos,matchWeight:q(m,
k[n],o,h.GeocodeFieldWeights)}));e.sort(function(r,u){return u.matchWeight-r.matchWeight});return e}};return h}();
TILE5.Geo.GeoHash=function(){function v(q,l,a){if(l&a)q[0]=(q[0]+q[1])/2;else q[1]=(q[0]+q[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(q){var l=1,a=[],g=[];a[0]=-90;a[1]=90;g[0]=-180;g[1]=180;lat_err=90;lon_err=180;for(i=0;i<q.length;i++){c=q[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(l){lon_err/=2;v(g,cd,mask)}else{lat_err/=2;v(a,cd,mask)}l=!l}}a[2]=(a[0]+
a[1])/2;g[2]=(g[0]+g[1])/2;return{latitude:a,longitude:g}},encode:function(q,l,a){var g=1,b=[],d=[],f=0,h=0;a=a?a:12;geohash="";b[0]=-90;b[1]=90;d[0]=-180;for(d[1]=180;geohash.length<a;){if(g){mid=(d[0]+d[1])/2;if(l>mid){h|=BITS[f];d[0]=mid}else d[1]=mid}else{mid=(b[0]+b[1])/2;if(q>mid){h|=BITS[f];b[0]=mid}else b[1]=mid}g=!g;if(f<4)f++;else{geohash+=BASE32[h];h=f=0}}return geohash}}}();
TILE5.Geo.Search=function(){return{bestResults:function(v,q){q||(q=20);for(var l=v.length>0?v[0]:null,a=[],g=0;g<v.length;g++)if(l.matchWeight-v[g].matchWeight<=q)a.push(v[g]);else break;return a}}}();
TILE5.Geo.Routing=function(){var v={calculate:function(q){q=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},q);GRUNT.Log.info("attempting to calculate route");var l=TILE5.Geo.getEngine("route");l&&l.route(q,function(a){if(q.generalize)a.geometry=TILE5.Geo.P.generalize(a.geometry,a.getInstructionPositions());if(q.map){v.createMapOverlay(q.map,a);if(q.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+a.boundingBox);q.map.gotoBounds(a.boundingBox)}}q.success&&
q.success(a)})},createMapOverlay:function(q,l){var a=q.getDimensions();a=new TILE5.Geo.UI.RouteOverlay({data:l,width:a.width,height:a.height});q.setLayer("route",a)},parseTurnType:function(q){for(var l=v.TurnType.Unknown,a=TILE5.Geo.Routing.TurnTypeRules,g=0;g<a.length;g++){a[g].regex.lastIndex=-1;var b=a[g].regex.exec(q);if(b){l=a[g].customCheck?a[g].customCheck(q,b):a[g].turnType;break}}return l},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",
TurnLeft:"turn-left",TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(q){q=GRUNT.extend({position:null,description:"",turnType:null},q);if(!q.turnType)q.turnType=v.parseTurnType(q.description);return q},RouteData:function(q){q=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},q);if(!q.boundingBox)q.boundingBox=TILE5.Geo.B.forPositions(q.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var l=[],a=0;a<q.instructions.length;a++)q.instructions[a].position&&l.push(q.instructions[a].position);return l}},q)}};return v}();
TILE5.Geo.Routing.TurnTypeRules=function(){var v=TILE5.Geo.Routing.TurnType,q=[];q.push({regex:/continue/i,turnType:v.Continue});q.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(l,a){return/bear/i.test(a[1])?v.TurnLeftSlight:v.TurnLeft}});q.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(l,a){return/bear/i.test(a[1])?v.TurnRightSlight:v.TurnRight}});q.push({regex:/enter\s(roundabout|rotaty)/i,turnType:v.EnterRoundabout});q.push({regex:/take.*?ramp/i,turnType:v.Ramp});
q.push({regex:/take.*?exit/i,turnType:v.RampExit});q.push({regex:/make(.*?)u\-turn/i,customCheck:function(l,a){return/right/i.test(a[1])?v.UTurnRight:v.UTurnLeft}});q.push({regex:/proceed/i,turnType:v.Start});q.push({regex:/arrive/i,turnType:v.Arrive});q.push({regex:/fell\sthrough/i,turnType:v.Merge});return q}();
TILE5.Geo.UI=function(){function v(a){a=GRUNT.extend({size:12,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},a);var g=null,b=function(){var d=TILE5.newCanvas(a.size*4,a.size*4),f=d.getContext("2d"),h=new TILE5.Vector(d.width/2,d.height/2),m=a.size,k=["#FFFFFF","#333333"],n=[3,1.5];f.lineCap="round";for(var e=0;e<k.length;e++){var o=m;f.lineWidth=n[e];f.strokeStyle=k[e];f.beginPath();f.moveTo(h.x,
h.y-o);f.lineTo(h.x,h.y+o);f.moveTo(h.x-o,h.y);f.lineTo(h.x+o,h.y);f.arc(h.x,h.y,m*0.6666,0,2*Math.PI,false);f.stroke()}return d}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(d,f,h){if(!g){g=TILE5.D.getCenter(h);g=new TILE5.Vector(Math.round(g.x-b.width/2),Math.round(g.y-b.height/2))}d.drawImage(b,g.x,g.y)}})}var q=0,l={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,radsPerPixel:0},a);var g=
TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),b=g.x-a.centerXY.x,d=g.y-a.centerXY.y,f=GRUNT.extend({},a.grid,{getBoundingBox:function(h,m,k,n){return new TILE5.Geo.BoundingBox(f.pixelsToPos(new TILE5.Vector(h,m+n)),f.pixelsToPos(new TILE5.Vector(h+k,m)))},getGridXYForPosition:function(h){h=TILE5.Geo.P.toMercatorPixels(h,a.radsPerPixel);return new TILE5.Vector(h.x-b,f.gridDimensions.height-(h.y-d))},getPixelDistance:function(h){h=TILE5.Geo.Utilities.dist2rad(h);return Math.floor(h/a.radsPerPixel)},
pixelsToPos:function(h){return TILE5.Geo.P.fromMercatorPixels(b+h.x,d+f.gridDimensions.height-h.y,a.radsPerPixel)}});return f},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var g=true,b=null,d=[],f=0,h=[],m=[],k=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(n,e,o,r){if(g)return null;var u="routeAnimation"+q++;m.push(u);
return new TILE5.Graphics.AnimatedPathLayer({id:u,path:d,zindex:a.zindex+1,easing:n?n:TILE5.Animation.Easing.Sine.InOut,duration:e?e:5E3,drawIndicator:o,autoCenter:r?r:false})},draw:function(n,e,o,r,u){o=0;r=a.data?a.data.geometry:null;if(g){g=false;b=null;d=[];f=0}if(r&&f<r.length){a:{u=u.getTileLayer();h=[];if(u){r=GRUNT.Log.getTraceTicks();var p,s,t,w=a.data?a.data.geometry:[],x=w.length,z=a.data?a.data.instructions:[],C=z.length,E=a.calculationsPerCycle,H=0;for(p=f;p<x;p++){s=u.getGridXYForPosition(w[p]);
if(t=!b||p===0||Math.abs(s.x-b.x)+Math.abs(s.y-b.y)>a.pixelGeneralization){d.push(s);b=s}H++;if(H>=E){f=p;break a}}f=x;GRUNT.Log.trace(x+" geometry points generalized to "+d.length+" coordinates",r);b=null;for(p=C;p--;)if(z[p].position){s=u.getGridXYForPosition(z[p].position);if(t=!b||p===0||Math.abs(s.x-b.x)+Math.abs(s.y-b.y)>a.pixelGeneralization){h.push(s);b=s}}}}o++}u=d.length;if(u>0&&(!o||a.partialDraw)){n.strokeStyle=a.strokeStyle;n.lineWidth=a.lineWidth;n.beginPath();n.moveTo(d[u-1].x-e.x,
d[u-1].y-e.y);for(u=u;u--;)n.lineTo(d[u].x-e.x,d[u].y-e.y);n.stroke();n.fillStyle=a.waypointFillStyle;for(u=h.length;u--;){n.beginPath();n.arc(h[u].x-e.x,h[u].y-e.y,2,0,Math.PI*2,false);n.stroke();n.fill()}}return o}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var n=m.length;n--;)GRUNT.WaterCooler.say("layer.remove",{id:m[n]});m=[];g=true;k.wakeParent()});return k},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,calcXY:null,tweenIn:l.AnnotationTween,animationSpeed:null},
a);var g=false,b={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return g},calcXY:function(d){b.xy=d.getGridXYForPosition(b.pos);a.calcXY&&a.calcXY(d)},draw:function(d,f,h,m,k){if(b.xy){if(b.isNew&&a.tweenIn){var n=b.xy.y;b.xy.y=f.y-20;g=true;TILE5.Animation.tween(b.xy,"y",n,a.tweenIn,function(){b.xy.y=n;g=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(d,f,new TILE5.Vector(b.xy.x-f.x,b.xy.y-f.y),h,m,k);else{d.beginPath();d.arc(b.xy.x-f.x,b.xy.y-f.y,4,0,Math.PI*
2,false);d.fill()}b.isNew=false}}};return b},ImageAnnotation:function(a){a=GRUNT.extend({imageUrl:null,animatingImageUrl:null,imageAnchor:null},a);var g=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;a.draw=function(d,f,h,m,k){if(a.animatingImageUrl&&b.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);m=a.animatingImageUrl}else m=a.imageUrl;if(f=TILE5.Resources.getImage(m)){if(f.complete&&f.width>0){g||(g=new TILE5.Vector(-f.width>>1,-f.height>>1));h=TILE5.V.offset(h,g.x,g.y);d.drawImage(f,h.x,
h.y,f.width,f.height)}}else TILE5.Resources.loadImage(m,function(){k.wakeParent()})};var b=new l.Annotation(a);return b},LocationAnnotation:function(a){a=GRUNT.extend({accuracy:null},a);var g=new Image,b=new TILE5.Vector,d=null;g.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAACIQAAAiEBPhEQkwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAG+SURBVCiRlZHNahNRAIW/O7mTTJPahLZBA1YUyriINRAE3bQIKm40m8K8gLj0CRQkO32ELHUlKbgoIu4EqeJPgtCaoBuNtjXt5LeTMZk0mbmuWiuuPLsD3+HAOUIpxf9IHjWmaUbEyWv5ROrsVULhcHP761rUfnN3Y2Otc8CIg4YT85lzuVsPP+Qupw1vpPjRCvhS9ymvV0e77x7nNj+uvADQAIQQ+uLyvdfLV9JGZi7EdEwQlqBpEJ019f0z1mo2u5Q8DMydv25lshemmj1FueZTawbs7inarqLbV7Qjab1upB9YlhWSAHLavLHZCvg1VEhN0PMU9W7At4bPVidg7CtkLLXkut+lBPD6/Ub155jJiADAHSpaLmx3ApyBQoYEUd0PBoOBkAC6+3llvda/YxgGgYL+UNHf/zN3KiExGlsvTdP0NYDkhPdWrz35ZDsBzV5wCMuQwEyFmXFeeadjzfuFQmGkAZRKpdGC/n7x+M6jqvA9Zo6FWDhlcHE+wqT93J1tP7vpOE7rrx8ALMuasPf8S12St4WmJ6bYWTUC52k8Hm8Vi0X/nwBAPp/XKpWKdF1X2LYdlMvlsToC/QYTls7DLFr/PAAAAABJRU5ErkJggg%3D%3D";
g.onload=function(){b=new TILE5.Vector(g.width/2,g.height/2)};var f=new l.Annotation(GRUNT.extend({calcXY:function(h){d=Math.floor(h.getPixelDistance(f.accuracy)*0.5)},draw:function(h,m,k,n,e,o){m=k.x-b.x;n=k.y-b.y;if(d&&f.drawAccuracyIndicator){h.fillStyle="rgba(30, 30, 30, 0.2)";h.beginPath();h.arc(k.x,k.y,d,0,Math.PI*2,false);h.fill()}h.drawImage(g,m,n,g.width,g.height);o.trigger("invalidate")}},a));f.accuracy=a.accuracy;f.drawAccuracyIndicator=false;return f},AnnotationsOverlay:function(a){function g(m){var k=
a.map?a.map.getTileLayer():null,n=m.length;if(k)for(n=n;n--;)m[n].calcXY(k);m.sort(function(e,o){var r=o.xy.y-e.xy.y;if(r===0)r=o.xy.x-e.xy.x;return r})}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var b=[],d=false,f=[],h=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){return d?1:0},draw:function(m,k,n,e,o){d=false;m.fillStyle="rgba(255, 0, 0, 0.75)";m.globalCompositeOperation="source-over";for(n=b.length;n--;){b[n].draw(m,k,e,h,o);d=d||b[n].isAnimating()}for(n=
f.length;n--;){f[n].draw(m,k,e,h,o);d=d||f[n].isAnimating()}return d?1:0},add:function(m){f.push(m);g(f);h.wakeParent()},clear:function(m){f=[];g(f);if(m){b=[];g(b)}h.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(m){if(a.pois&&a.pois.id==m.srcID){m=m.pois;try{b=[];for(var k=0;k<m.length;k++)if(m[k].pos){var n;var e=m[k];if(e&&e.pos){var o=null;if(o=a.createAnnotationForPOI?a.createAnnotationForPOI(e):new l.Annotation({pos:e.pos})){o.isNew=e.isNew;e.isNew=false}n=o}else n=void 0;
n&&b.push(n)}g(b)}catch(r){GRUNT.Log.exception(r)}h.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){g(b);g(f);h.wakeParent()});return h},Tiler:function(a){function g(t){var w=new TILE5.Geo.Position(t.coords.latitude,t.coords.longitude);t=Math.floor((GRUNT.isPlainObject(t.coords.accuracy)&&t.coords.accuracy.horizontal?t.coords.accuracy.horizontal:t.coords.accuracy)/1E3);if(u){if(!o){o=new l.LocationAnnotation({pos:w,accuracy:t});s.bind("tileDrawComplete",function(){o.drawAccuracyIndicator=
true});m.add(o)}w=TILE5.Geo.B.createBoundsFromCenter(w,t*2);s.gotoBounds(w)}else{o.pos=w;o.accuracy=t;s.panToPosition(w,null,TILE5.Animation.Easing.Sine.Out)}u=false}function b(){}a=GRUNT.extend({tapExtent:10,provider:null,crosshair:false,zoomLevel:0,boundsChange:null,tapPOI:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,zoomAnimation:TILE5.Animation.Easing.Quad.Out},a);var d=new TILE5.Vector,f=false,h=[],m=null,k=0,n=null,e=null,o=null,r=0,u=true,p=a.zoomLevel;
if(!a.provider)a.provider=new TILE5.Geo.MapProvider;var s=GRUNT.extend({},new TILE5.Tiling.Tiler(a),{pois:a.pois,annotations:null,getProvider:function(){return a.provider},setProvider:function(t){a.provider=t;f=false},getBoundingBox:function(){var t=s.getTileLayer(),w=s.getOffset(),x=s.getDimensions();if(t)return t.getBoundingBox(w.x,w.y,x.width,x.height);return null},getCenterPosition:function(){return s.getXYPosition(TILE5.D.getCenter(s.getDimensions()))},getXYPosition:function(t){return s.getTileLayer().pixelsToPos(s.viewPixToGridPix(t))},
gotoBounds:function(t,w){var x=TILE5.Geo.B.getZoomLevel(t,s.getDimensions());s.gotoPosition(TILE5.Geo.B.getCenter(t),x,w)},gotoPosition:function(t,w,x){var z=p,C=(new Date).getTime(),E=false,H=s.getBoundingBox();if(H)E=!TILE5.Geo.P.inBounds(t,H);p=w?w:p;if(!p)throw Error("Zoom level required to goto a position.");if(a.provider)p=a.provider.checkZoomLevel(p);if(E||!f||p!==z){TILE5.Resources.resetImageLoadQueue();if(o)o.drawAccuracyIndicator=false;(w=s.getTileLayer())&&w.deactivate();TILE5.Animation.cancel();
f&&s.freeze();k=C;a.provider.zoomLevel=p;a.provider.getMapTiles(s,t,function(P){if(C===k){s.setTileLayer(P);e=P.getId();s.panToPosition(t,function(){s.unfreeze();s.trigger("zoomLevelChange",p);x&&x()})}else GRUNT.Log.info("request time mismatch - ignoring update")});f=true}else s.panToPosition(t,x)},panToPosition:function(t,w,x){var z=s.getTileLayer();if(z){t=z.getGridXYForPosition(t);z=s.getDimensions();t.x-=z.width/2;t.y-=z.height/2;if(n)n=null;s.updateOffset(t.x,t.y,x);GRUNT.WaterCooler.say("view.wake",
{id:s.id});a.boundsChange&&a.boundsChange(s.getBoundingBox());w&&w(s)}},locate:function(){s.trackStart();setTimeout(s.trackCancel,3E4)},trackStart:function(){if(navigator.geolocation){u=true;r=navigator.geolocation.watchPosition(g,b,{enableHighAccuracy:true,timeout:1E4,maximumAge:5E3})}},trackCancel:function(){r&&navigator.geolocation&&navigator.geolocation.clearWatch(r);r=0},getZoomLevel:function(){return p},setZoomLevel:function(t){try{s.gotoPosition(s.getCenterPosition(),t)}catch(w){GRUNT.Log.exception(w)}},
zoomIn:function(){s.scale(2,TILE5.Animation.Easing.Sine.Out)||s.setZoomLevel(p+1)},zoomOut:function(){s.scale(0.5,TILE5.Animation.Easing.Sine.Out)||s.setZoomLevel(p-1)},animateRoute:function(t,w,x,z){var C=s.getLayer("route");if(C)(t=C.getAnimation(t,w,x,z))&&t.addToView(s)}});s.bind("tap",function(t,w){var x=s.getTileLayer(),z=null;if(x){z=s.viewPixToGridPix(new TILE5.Vector(w.x,w.y));var C=x.pixelsToPos(z),E=x.pixelsToPos(TILE5.V.offset(z,-a.tapExtent,a.tapExtent)),H=x.pixelsToPos(TILE5.V.offset(z,
a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(x.pixelsToPos(z)));z=new TILE5.Geo.BoundingBox(E,H);h=s.pois.findByBounds(z);s.trigger("geotap",t,w,C,z);a.tapPOI&&a.tapPOI(h)}});s.bind("doubleTap",function(t,w){s.animate(2,TILE5.D.getCenter(s.getDimensions()),new TILE5.Vector(w.x,w.y),a.zoomAnimation)});s.bind("scale",function(t,w){var x=0;t=Math.sqrt(t);if(t<1)x=-(0.5/t);else if(t>1)x=t;s.gotoPosition(s.getXYPosition(w),p+Math.floor(x))});m=new TILE5.Geo.UI.AnnotationsOverlay({pois:s.pois,
map:s,createAnnotationForPOI:a.createAnnotationForPOI});s.annotations=m;s.setLayer("annotations",m);a.crosshair&&s.setLayer("crosshair",new v);GRUNT.WaterCooler.listen("view.idle",function(t){if(t.id&&t.id==s.id)if(TILE5.V.absSize(TILE5.V.diff(d,s.getOffset()))>a.boundsChangeThreshold&&a.boundsChange){d=s.getOffset();a.boundsChange(s.getBoundingBox())}});return s}};return l}();
