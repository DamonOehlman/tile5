if(!this.JSON)this.JSON={};
(function(){function q(l){return l<10?"0"+l:l}function n(l){f.lastIndex=0;return f.test(l)?'"'+l.replace(f,function(k){var i=e[k];return typeof i==="string"?i:"\\u"+("0000"+k.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+l+'"'}function d(l,k){var i,g,h,m,o=a,r,p=k[l];if(p&&typeof p==="object"&&typeof p.toJSON==="function")p=p.toJSON(l);if(typeof j==="function")p=j.call(k,l,p);switch(typeof p){case "string":return n(p);case "number":return isFinite(p)?String(p):"null";case "boolean":case "null":return String(p);
case "object":if(!p)return"null";a+=b;r=[];if(Object.prototype.toString.apply(p)==="[object Array]"){m=p.length;for(i=0;i<m;i+=1)r[i]=d(i,p)||"null";h=r.length===0?"[]":a?"[\n"+a+r.join(",\n"+a)+"\n"+o+"]":"["+r.join(",")+"]";a=o;return h}if(j&&typeof j==="object"){m=j.length;for(i=0;i<m;i+=1){g=j[i];if(typeof g==="string")if(h=d(g,p))r.push(n(g)+(a?": ":":")+h)}}else for(g in p)if(Object.hasOwnProperty.call(p,g))if(h=d(g,p))r.push(n(g)+(a?": ":":")+h);h=r.length===0?"{}":a?"{\n"+a+r.join(",\n"+a)+
"\n"+o+"}":"{"+r.join(",")+"}";a=o;return h}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+q(this.getUTCMonth()+1)+"-"+q(this.getUTCDate())+"T"+q(this.getUTCHours())+":"+q(this.getUTCMinutes())+":"+q(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var c=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
f=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,a,b,e={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},j;if(typeof JSON.stringify!=="function")JSON.stringify=function(l,k,i){var g;b=a="";if(typeof i==="number")for(g=0;g<i;g+=1)b+=" ";else if(typeof i==="string")b=i;if((j=k)&&typeof k!=="function"&&(typeof k!=="object"||typeof k.length!=="number"))throw Error("JSON.stringify");return d("",
{"":l})};if(typeof JSON.parse!=="function")JSON.parse=function(l,k){function i(h,m){var o,r,p=h[m];if(p&&typeof p==="object")for(o in p)if(Object.hasOwnProperty.call(p,o)){r=i(p,o);if(r!==undefined)p[o]=r;else delete p[o]}return k.call(h,m,p)}var g;l=String(l);c.lastIndex=0;if(c.test(l))l=l.replace(c,function(h){return"\\u"+("0000"+h.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(l.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){g=eval("("+l+")");return typeof k==="function"?i({"":g},""):g}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(q){if(arguments.length<=1)return q;for(var n=arguments.length-2,d=0;d<=n;d++)q=q.replace(RegExp("\\{"+d+"\\}","gi"),arguments[d+1]);return q};
String.prototype.containsWord=function(q){var n="";if(q.toString)q=q.toString();for(var d=0;d<q.length;d++)n+=!/\w/.test(q[d])?"\\"+q[d]:q[d];return RegExp("(^|\\s|\\,)"+n+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var q=Object.prototype.hasOwnProperty,n=0,d={id:"GRUNT.core",extend:function(){var c=arguments[0]||{},f=1,a=arguments.length,b=false,e,j,l,k;if(typeof c==="boolean"){b=c;c=arguments[1]||{};f=2}if(typeof c!=="object"&&!d.isFunction(c))c={};if(a===f){c=this;--f}for(;f<a;f++)if((e=arguments[f])!=null)for(j in e){l=c[j];k=e[j];if(c!==k)if(b&&k&&(d.isPlainObject(k)||d.isArray(k))){l=l&&(d.isPlainObject(l)||d.isArray(l))?l:d.isArray(k)?[]:{};c[j]=d.extend(b,l,k)}else if(k!==undefined)c[j]=
k}return c},isFunction:function(c){return toString.call(c)==="[object Function]"},isArray:function(c){return toString.call(c)==="[object Array]"},isPlainObject:function(c){if(!c||toString.call(c)!=="[object Object]"||c.nodeType||c.setInterval)return false;if(c.constructor&&!q.call(c,"constructor")&&!q.call(c.constructor.prototype,"isPrototypeOf"))return false;var f;for(f in c);return f===undefined||q.call(c,f)},isEmptyObject:function(c){for(var f in c)return false;return true},isXmlDocument:function(c){return toString.call(c)===
"[object Document]"},contains:function(c,f){var a=c,b=arguments,e=1;if(f&&d.isArray(f)){b=f;e=0}for(e=e;e<b;e++)a=a&&typeof foo[b[e]]!=="undefined";return a},newModule:function(c){c=d.extend({id:null,requires:[],parent:null},c);if(c.parent)c=d.extend({},c.parent,c);return c},toID:function(c){return c.replace(/\s/g,"-")},generateObjectID:function(c){return(c?c:"obj")+n++}};return d}();
GRUNT.Log=function(){function q(a,b){var e,j=b&&b.length>0?b[0]:"";for(e=1;b&&e<b.length;e++)j+=" "+(d&&GRUNT.isPlainObject(b[e])?JSON.stringify(b[e]):b[e]);typeof console!=="undefined"&&console[a](j);for(e=0;e<n.length;e++)n[e].call(f,j,a)}var n=[],d=typeof JSON!=="undefined",c=window.console&&window.console.markTimeline,f={id:"GRUNT.log",getTraceTicks:function(){return c?(new Date).getTime():null},trace:function(a,b){if(c)console.markTimeline(a+(b?": "+(f.getTraceTicks()-b)+"ms":""))},debug:function(){q("debug",
arguments)},info:function(){q("info",arguments)},warn:function(){q("warn",arguments)},error:function(){q("error",arguments)},exception:function(a){f.error(arguments);for(var b in a)f.info("ERROR DETAIL: "+b+": "+a[b])},watch:function(a,b){try{b()}catch(e){f.exception(e,a)}},throwError:function(a){f.error(a);throw Error(a);},requestUpdates:function(a){n.push(a)}};return f}();
GRUNT.Data=function(){var q={determineObjectMapping:function(d){if(!d)return null;d=d.split("|");for(var c={},f=0;f<d.length;f++)c[d[f]]=f;return c},mapLineToObject:function(d,c){var f=d.split("|"),a={};for(var b in c){var e=c[b];a[b]=f.length>e?f[e]:null}return a},parse:function(d){var c=null,f=[];d=d.split("\n");for(var a=0;a<d.length;a++){var b=d[a];if(c)f.push(q.mapLineToObject(b,c));else c=q.determineObjectMapping(b)}return f}},n={supportedFormats:{JSON:{parse:function(d){return JSON.parse(d)}},
PDON:{parse:function(d){return q.parse(d)}}},parse:function(d){d=GRUNT.extend({data:"",format:"JSON"},d);if(!n.supportedFormats[d.format])throw Error("Unsupported data format: "+d.format+", cannot parse data in javascript object");try{return n.supportedFormats[d.format].parse(d.data)}catch(c){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+d.format,d.data);GRUNT.Log.exception(c)}return{}}};return n}();
GRUNT.Template=function(){var q=/\$\{(.*?)\}/ig;return{parse:function(n,d){for(var c=n,f=q.exec(c);f;){c=c.replace(f[0],GRUNT.XPath.first(f[1],d));q.lastIndex=0;f=q.exec(c)}return c}}}();
GRUNT.JSONP=function(){function q(f){var a=document.createElement("script"),b=false;a.src=f;a.async=true;a.onload=a.onreadystatechange=function(){if(!b&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){b=true;a.onload=a.onreadystatechange=null;a&&a.parentNode&&a.parentNode.removeChild(a)}};d||(d=document.getElementsByTagName("head")[0]);d.appendChild(a)}var n=0,d,c=this;return{get:function(f,a){f+=f.indexOf("?")>=0?"&":"?";var b="json"+ ++n;c[b]=function(e){a(e);c[b]=
null;try{delete c[b]}catch(j){}};q(f+"callback="+b);return b}}}();
GRUNT.XHR=function(){var q={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},n={JSON:["json"],PDON:["pdon.txt"]},d=["TEXT","STREAM"],c=/^(\w+:)?\/\/([^\/?#]+)/,f={XML:function(e){return e.responseXML},JSON:function(e){try{return JSON.parse(e.responseText)}catch(j){GRUNT.Log.error("Error parsing JSON data: ",e.responseText);GRUNT.Log.exception(j)}return""},PDON:function(e){return GRUNT.Data.parse({data:e.responseText,format:"PDON"})},DEFAULT:function(e){return e.responseText}},
a={CONTENT_TYPE:"Content-Type"},b=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(e){try{e=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},b.ajaxSettings,e);var j=c.exec(e.url),l=j&&(j[1]&&j[1]!==location.protocol||j[2]!==location.host);if(e.data)e.method="POST";if(e.url){j=null;if(e.xhr)j=e.xhr(e);j||(j=new XMLHttpRequest);j.open(e.method,e.url,e.async);e.data&&j.setRequestHeader("Content-Type",
e.contentType);l||j.setRequestHeader("X-Requested-With","XMLHttpRequest");j.onreadystatechange=function(){if(this.readyState===4){var i=null,g=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(g)if(e.handleResponse)e.handleResponse(this);else{var h=e,m=this.getResponseHeader(a.CONTENT_TYPE),o,r=false;for(o in q)if(m&&m.indexOf(q[o])>=0){r=true;break}m=!r;for(r=0;r<d.length;r++)m=m||d[r]==o;if(m)b:{m=o;for(var p in n)for(r=
0;r<n[p].length;r++)if(RegExp(n[p][r]+"$","i").test(h.url)){o=p;break b}o=m?m:"DEFAULT"}try{i=f[o](this,h)}catch(s){GRUNT.Log.warn("error applying processor '"+o+"' to response type, falling back to default");i=f.DEFAULT(this,h)}}else e.error&&e.error(this)}catch(t){GRUNT.Log.exception(t,"PROCESSING AJAX RESPONSE")}g&&i&&e.success&&e.success.call(this,i)}};j.send(e.method=="POST"?b.param(e.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(k){GRUNT.Log.exception(k)}},
param:function(e){var j=[],l=function(i,g){g=GRUNT.isFunction(g)?g():g;j[j.length]=encodeURIComponent(i)+"="+encodeURIComponent(g)};if(GRUNT.isArray(e))for(var k=0;k<e.length;k++)l(e[k].name,e[k].value);else for(k in e)l(k,e[k]);return j.join("&").replace(/%20/g,"+")}});return b}();
GRUNT.XPath=function(){function q(f){for(var a=null,b=0;b<n.length;b++)if(a=n[b](f))break;return a}var n=[],d=[null,function(f){return f.numberValue},function(f){return f.stringValue},function(f){return f.booleanValue},null,null,null,null,function(f){return f.singleNodeValue?f.singleNodeValue.textContent:null},function(f){return f.singleNodeValue?f.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var c={SearchResult:function(f){return{toString:function(){var a=
null;if(f){var b=null;if(f.resultType>=0&&f.resultType<d.length)b=d[f.resultType];if(b){GRUNT.Log.info("invoking match handler for result type: "+f.resultType);a=b(f)}}return a?a:""}}},first:function(f,a){var b=c.SearchResult,e;var j=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!j)j=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(a))e=a.evaluate(f,a,q,j,null);else{GRUNT.Log.warn("attempted xpath expression: "+f+" on a non-xml document");e=null}}catch(l){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
f+" on node: "+a);e=null}return new b(e)},registerResolver:function(f){n.push(f)}};return c}();GRUNT.WaterCooler=function(){var q={},n=[];return{addPipe:function(d){d("pipe.test",{});n.push(d)},listen:function(d,c){q[d]||(q[d]=[]);c&&q[d].push(c)},say:function(d,c){var f;for(f=n.length;f--;)n[f](d,c);if(q[d])for(f=q[d].length;f--;)q[d][f](c)},leave:function(){}}}();
TILE5=function(){var q={copyRect:function(n){return n?new q.Rect(n.origin.x,n.origin.y,n.dimensions.width,n.dimensions.height):null},Settings:function(){var n={};return{get:function(d){return n[d]},set:function(d,c){n[d]=c},extend:function(d){GRUNT.extend(n,d)}}}(),Clock:function(){var n=null;return{getTime:function(d){return d&&n?n:n=(new Date).getTime()}}}(),Vector:function(n,d){return{x:n?n:0,y:d?d:0}},V:function(){return{create:function(n,d){return new q.Vector(n,d)},add:function(){for(var n=
new q.Vector,d=arguments.length;d--;){n.x+=arguments[d].x;n.y+=arguments[d].y}return n},absSize:function(n){return Math.max(Math.abs(n.x),Math.abs(n.y))},diff:function(n,d){return new q.Vector(n.x-d.x,n.y-d.y)},copy:function(n){return n?new q.Vector(n.x,n.y):null},invert:function(n){return new TILE5.Vector(-n.x,-n.y)},offset:function(n,d,c){return new TILE5.Vector(n.x+d,n.y+(c?c:d))}}}(),VectorArray:function(n,d){for(var c=Array(n.length),f=n.length;f--;)c[f]=d?q.V.copy(n[f]):n[f];return{applyOffset:function(a){for(var b=
c.length;b--;){c[b].x+=a.x;c[b].y+=a.y}},getRect:function(){return new TILE5.Rect(Math.min(c[0].x,c[1].x),Math.min(c[0].y,c[1].y),Math.abs(c[0].x-c[1].x),Math.abs(c[0].y-c[1].y))},toString:function(){for(var a="",b=c.length;b--;)a+="["+c[b].toString()+"] ";return a}}},VectorMath:function(){function n(d){if(!d||d.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var c={edges:Array(d.length-1),accrued:Array(d.length-1),total:0},f=TILE5.V.diff,a=0;a<d.length-
1;a++){var b=f(d[a],d[a+1]);c.edges[a]=Math.sqrt(b.x*b.x+b.y*b.y);c.accrued[a]=c.total+c.edges[a];c.total+=c.edges[a]}return c}return{edges:n,distance:function(d){return n(d).total},theta:function(d,c,f){f=Math.asin((d.y-c.y)/f);return d.x>c.x?f:Math.PI-f},pointOnEdge:function(d,c,f,a){c=new TILE5.Vector(Math.cos(f)*a,Math.sin(f)*a);return new TILE5.Vector(d.x-c.x,d.y-c.y)}}}(),Dimensions:function(n,d){var c=d?n/d:1,f={width:n,height:d,aspect_ratio:c,inv_aspect_ratio:1/c,getAspectRatio:function(){return f.height!==
0?f.width/f.height:1},getCenter:function(){return new TILE5.Vector(f.width>>1,f.height>>1)},grow:function(a,b){return new TILE5.Dimensions(f.width+a,f.height+b)},matches:function(a){return a&&f.width==a.width&&f.height==a.height},toString:function(){return f.width+" x "+f.height}};return f},Rect:function(n,d,c,f){var a={origin:new TILE5.Vector(n,d),dimensions:new TILE5.Dimensions(c,f),getCenter:function(){return new TILE5.Vector(a.origin.x+(a.dimensions.width>>1),a.origin.y+(a.dimensions.height>>
1))},getSize:function(){return Math.sqrt(Math.pow(a.dimensions.width,2)+Math.pow(a.dimensions.height,2))},grow:function(b,e){var j=new TILE5.Dimensions(b-a.dimensions.width,e-a.dimensions.height);a.dimensions.width=b;a.dimensions.height=e;return j},expand:function(b,e){a.origin.x-=b;a.origin.y-=e;a.dimensions.width+=b;a.dimensions.height+=e},offset:function(b){return new q.Rect(a.origin.x+b.x,a.origin.y+b.y,a.dimensions.width,a.dimensions.height)},getRequiredDelta:function(b,e){var j={top:0,left:0,
bottom:0,right:0};j.top=b.origin.y-a.origin.y+(e?e.y:0);j.left=b.origin.x-a.origin.x+(e?e.x:0);j.right=b.origin.x+b.dimensions.width-(a.origin.x+a.dimensions.width)-j.left;j.bottom=b.origin.y+b.dimensions.height-(a.origin.y+a.dimensions.height)-j.top;return j},applyDelta:function(b,e,j){if(!b||!GRUNT.contains(b,["top","left","bottom","right"]))throw Error("Invalid delta - cannot apply to TILE5.Rect");e||(e=1);a.origin.x+=b.left*e;a.origin.y+=b.top*e;a.dimensions.width+=b.right*e;a.dimensions.height+=
b.bottom*e;j&&a.constrainAspectRatio(j)},constrainAspectRatio:function(b){var e=0,j={top:0,left:0,bottom:0,right:0};if(a.dimensions.getAspectRatio()<b){e=Math.abs(a.dimensions.width-a.dimensions.height*b);j.left=-e;j.right=e}else{e=Math.abs(a.dimensions.height-a.dimensions.width/b);j.top=-e;j.bottom=e}a.applyDelta(j)},moveTo:function(b,e){var j=new TILE5.Vector(b-a.origin.x,e-a.origin.y);a.origin.x=b;a.origin.y=e;return j},toString:function(){return String.format("(origin: {0}, dimensions: {1})",
a.origin,a.dimensions)}};return a}};return q}();
TILE5.Device=function(){function q(){for(;k.length>0;){var g=k.shift();document.location=g}l=0}function n(g){for(var h=true,m=i.length;m--;)h=h&&g!=i[m];return h}function d(g,h){var m=[];for(var o in h)o&&m.push(o+"="+escape(h[o]));return"tile5://"+g+"/"+(m.length>0?"?"+m.join("&"):"")}function c(g,h){n(g)&&GRUNT.Log.info("would push url: "+d(g,h))}function f(g,h){if(n(g)){k.push(d(g,h));l||setTimeout(q,100)}}function a(){b={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in document,
imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:4,requireFastDraw:false,bridgeNotify:c},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true,bridgeNotify:f},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:f},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:f},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,supportsTouch:true,getScaling:function(){return 1/
window.devicePixelRatio},bridgeNotify:f},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:f}};e=[b.froyo,b.android,b.ipod,b.iphone,b.ipad]}var b=null,e=[],j=null,l=0,k=[],i=["view.wake","tile.loaded"];return{getConfig:function(){b||a();if(!j){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var g=0;g<e.length;g++){var h=e[g];if(h.regex&&h.regex.test(navigator.userAgent)){j=GRUNT.extend({},b.base,h);GRUNT.Log.info("PLATFORM DETECTED AS: "+
j.name);break}}if(!j){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");j=b.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return j}}}();
TILE5.Resources=function(){var q="",n={},d=function(){function f(){var r=j[this.id];if(r){r.loaded=true;r.hitCount=1;for(var p=i.length;p--;)if(i[p].image.src==this.src){i.splice(p,1);break}r.loadCallback&&r.loadCallback(this,false);g.push({url:this.src,created:r.requested});delete j[this.id];a()}}function a(){for(var r=TILE5.Device.getConfig().maxImageLoads;k.length>0&&(!r||i.length<r);){var p=k.shift();i.push(p);p.image.onload=f;p.image.src=p.url;p.requested=(new Date).getTime()}}function b(){m=
true;try{var r=Math.floor(g.length*0.5);if(r>0){g.sort(function(s,t){return s.created-t.created});for(var p=r;p--;)delete e[g[p].url];g.splice(0,r)}}finally{m=false}GRUNT.WaterCooler.say("imagecache.cleared")}var e={},j={},l=0,k=[],i=[],g=[],h=0,m=false,o={loadingImages:i,queuedImages:k,getCacheFullness:function(){return h},getImage:function(r){var p=null;m||(p=e[r]);return p?p.image:null},loadImage:function(r,p){var s=e[r];if(s){s.hitCount++;s.image.complete&&p&&p(s.image,true)}else{s={url:c.getPath(r),
image:new Image,loaded:false,created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:p};s.image.id="resourceLoaderImage"+l++;e[r]=s;j[s.image.id]=s;k.push(s);a()}return s},resetLoadingQueue:function(){i=[]}};setInterval(function(){for(var r=(new Date).getTime(),p=false,s=0,t=TILE5.Device.getConfig();s<i.length;)if(r-i[s].requested>c.loadTimeout*1E3){i.splice(s,1);p=true}else s++;p&&a();if(t&&t.imageCacheMaxSize){h=g.length*c.avgImageSize/t.imageCacheMaxSize;h>=1&&b()}},1E3);return o}(),
c={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(f,a){for(var b=(f?f.replace(/^.*\?/,""):"").split("&"),e=f?f.replace(/\?.*$/,"?"):"",j=0;j<b.length;j++){var l=b[j].split("=");if(!a||!a.test(l[0]))e+=b[j]+"&"}return e.replace(/\W/g,"")},isValidCacheKey:function(f){GRUNT.Log.info("cache key = "+f);return false}}}(),getCachedUrl:function(f){return f},getPath:function(f){return/^(https?|\/)/.test(f)?f:q+f},setBasePath:function(f){q=
f},getImage:function(f){return d.getImage(f)},loadImage:function(f,a){d.loadImage(f,a)},resetImageLoadQueue:function(){d.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:d.loadingImages.length,queuedImageCount:d.queuedImages.length,imageCacheFullness:d.getCacheFullness()}},loadResource:function(f){f=GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},f);var a=function(b){f.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){f.callback(b)})};f.cacheable&&
n[f.filename]?a(n[f.filename]):GRUNT.XHR.ajax({url:c.getPath(f.filename),dataType:f.dataType,success:function(b){if(f.cacheable)n[f.filename]=b;a(b)},error:function(b,e,j){GRUNT.Log.error("error loading resource ["+f.filename+"], error = "+j)}})},loadSnippet:function(f,a){/\.\w+$/.test(f)||(f+=".html");c.loadResource({filename:"snippets/"+f,callback:a,dataType:"html"})}};return c}();
TILE5.Touch=function(){function q(l,k){var i=l&&l.length>0?l[0]:null;if(i&&k&&k.length>0)return TILE5.V.diff(i,k[0]);return null}function n(l){l.preventDefault();l.stopPropagation()}function d(l){for(var k=Array(l.length),i=l.length;i--;)k[i]=new TILE5.Vector(l[i].pageX,l[i].pageY);return k}var c={TAP:0,MOVE:1,PINCHZOOM:2},f=7,a=0,b=0,e={TouchHelper:function(l){function k(v){v=new TILE5.VectorArray(v,true);l.element&&v.applyOffset(new TILE5.Vector(-l.element.offsetLeft,-l.element.offsetTop));return v}
function i(v){var A=Array(arguments.length-1),C=0;for(C=1;C<arguments.length;C++)A[C-1]=arguments[C];for(C=D.length;C--;)D[C][v]&&D[C][v].apply(M,A)}function g(v){if(v.target&&v.target===l.element){s=p?d(v.touches):[new TILE5.Vector(v.pageX,v.pageY)];u=new TILE5.Vector;z=new TILE5.Vector;E=true;o=false;p&&n(v);G.current=TILE5.Clock.getTime();if(v=s.length>0?s[0]:null){i("touchStartHandler",v.x,v.y);if(G.current-G.last<M.THRESHOLD_DOUBLETAP)if((v=t?TILE5.V.diff(s[0],t[0]):null)&&Math.abs(v.x)<l.maxDistDoubleTap&&
Math.abs(v.y)<l.maxDistDoubleTap)o=true;x=c.TAP;t=[].concat(s)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function h(v){if(v.target&&v.target===l.element)if(E)try{p&&n(v);var A=p?d(v.touches):[new TILE5.Vector(v.pageX,v.pageY)];v=0;if(A.length>1){if(s.length===1)s=[].concat(A);v=TILE5.VectorMath.distance(s)-TILE5.VectorMath.distance(t)}if(x===c.TAP){var C=q(A,s);if(C&&(Math.abs(C.x)>=f||Math.abs(C.y)>=f))x=c.MOVE}if(x!==c.TAP)if(!v||Math.abs(v)<l.pinchZoomThreshold){if(u=
q(A,t)){z.x+=u.x;z.y+=u.y;B.x+=u.x;B.y+=u.y}if(TILE5.V.absSize(B)>l.panEventThreshhold){i("moveHandler",B.x,B.y);B=TILE5.V.create()}x=c.MOVE}else{i("pinchZoomHandler",k(s),k(A));x=c.PINCHZOOM}t=[].concat(A)}catch(J){GRUNT.Log.exception(J)}}function m(v){if(v.target&&v.target===l.element)try{p&&n(v);TILE5.Clock.getTime();G.last=G.current;if(x===c.TAP)r||(r=setTimeout(function(){r=0;var C=o?"doubleTapHandler":"tapHandler",J=s[0],P=null;if(l.element)P=TILE5.V.offset(J,-l.element.offsetLeft,-l.element.offsetTop);
i(C,J,P)},M.THRESHOLD_DOUBLETAP+50));else if(x==c.MOVE)i("moveEndHandler",z.x,z.y);else x==c.PINCHZOOM&&i("pinchZoomEndHandler",k(s),k(t))}catch(A){GRUNT.Log.exception(A)}E=false}l=GRUNT.extend({element:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},l);var o=false,r=0,p=TILE5.Device.getConfig().supportsTouch,
s=null,t=null,u=null,z=null,B=new TILE5.Vector,x=null,E=false,D=[],G={current:0,last:0},F=TILE5.Device.getConfig(),M={supportsTouch:p,THRESHOLD_DOUBLETAP:300,addListeners:function(v){D.push(v)},decoupleListeners:function(v){for(var A=0;v&&A<D.length;A++)if(D[A].listenerId===v){D.splice(A,1);GRUNT.Log.info("successfully decoupled touch listener: "+v);break}},release:function(){F.eventTarget.removeEventListener(F.supportsTouch?"touchstart":"mousedown",g,false);F.eventTarget.removeEventListener(F.supportsTouch?
"touchmove":"mousemove",h,false);F.eventTarget.removeEventListener(F.supportsTouch?"touchend":"mouseup",m,false)},wheelie:function(v){var A=new TILE5.Vector(v.wheelDeltaX,v.wheelDeltaY);v=new TILE5.Vector(v.clientX,v.clientY);var C=A.y!==0?Math.abs(A.y/120):0;if(C!==0)i("wheelZoomHandler",v,A.y>0?C+0.5:0.5/C);GRUNT.Log.info("capture mouse wheel event, delta = "+A+", position = "+v)}};F.eventTarget.addEventListener(F.supportsTouch?"touchstart":"mousedown",g,false);F.eventTarget.addEventListener(F.supportsTouch?
"touchmove":"mousemove",h,false);F.eventTarget.addEventListener(F.supportsTouch?"touchend":"mouseup",m,false);return M}},j=[];return{captureTouch:function(l,k){try{if(!l)throw Error("Unable to capture touch of null element");if(!l.id)l.id="touchable_"+a++;var i=j[l.id];if(!i){i=e.TouchHelper(GRUNT.extend({element:l},k));j[l.id]=i;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+i.supportsTouch)}k.listenerId&&i.decoupleListeners(k.listenerId);k.listenerId=++b;i.addListeners(k)}catch(g){GRUNT.Log.exception(g)}},
resetTouch:function(l){if(l&&l.id&&j[l.id]){j[l.id].release();delete j[l.id]}}}}();if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(q){return this.each(function(){TILE5.Touch.captureTouch(this,q)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(q){q.preventDefault()})}}
TILE5.Pannable=function(q){q=GRUNT.extend({container:null,onPan:null,onPanEnd:null,onAnimate:null,checkOffset:null},q);var n=false,d=new TILE5.Vector,c={pannable:true,getOffset:function(){return new TILE5.Vector(d.x,d.y)},setOffset:function(a,b){d.x=a;d.y=b},pan:function(a,b,e){if(e)c.updateOffset(d.x+a,d.y+b,e);else{c.updateOffset(d.x+a,d.y+b);q.onPan&&q.onPan(a,b)}},isAnimating:function(){return n},panEnd:function(a,b){q.onPanEnd&&q.onPanEnd(a,b)},updateOffset:function(a,b,e){if(e){a=new TILE5.Vector(a,
b);n=true;e=TILE5.Animation.tweenVector(d,a.x,a.y,e,function(){n=false;c.panEnd(0,0)});for(a=e.length;a--;){e[a].cancelOnInteract=true;e[a].requestUpdates(function(){q.onAnimate&&q.onAnimate(d.x,d.y)})}}else c.setOffset(a,b)}},f=document.getElementById(q.container);f&&TILE5.Touch.captureTouch(f,{moveHandler:function(a,b){c.pan(-a,-b)},moveEndHandler:function(a,b){c.panEnd(a,b)}});return c};
TILE5.Scalable=function(q){function n(g,h){c=g.getRect();f=h.getRect();var m=c.getSize(),o=f.getSize();l=f.getCenter();a=c&&m!==0?o/m:1}q=GRUNT.extend({container:null,onAnimate:null,onPinchZoom:null,onScale:null,scaleDamping:false},q);var d=false,c=null,f=null,a=1,b=null,e=null,j=null,l=null,k={scalable:true,animate:function(g,h,m,o,r){function p(){r&&r();d=false;q.onScale&&q.onScale(a,l);a=1;b=null}d=true;j=TILE5.V.copy(h);l=TILE5.V.copy(m);c=null;if(o){e=a;TILE5.Animation.tweenValue(0,g-e,o,p,1E3).requestUpdates(function(s){b=
s/(g-e);a=e+s;q.onAnimate&&q.onAnimate()})}else{a=g;p()}},getScaleInfo:function(){return{factor:a,startRect:TILE5.copyRect(c),endRect:TILE5.copyRect(f),start:j,center:l,progress:b}},getScaling:function(){return d},getScaleFactor:function(){return a}},i=document.getElementById(q.container);i&&TILE5.Touch.captureTouch(i,{pinchZoomHandler:function(g,h){n(g,h);(d=a!==1)&&q.onPinchZoom&&q.onPinchZoom(g,h)},pinchZoomEndHandler:function(g,h){n(g,h);d=false;q.onScale&&q.onScale(a,l,true);a=1},wheelZoomHandler:function(g){c=
f=null;l=TILE5.V.copy(g)}});return k};
TILE5.Dispatcher=function(){var q=[],n={execute:function(d){var c=n.findAction(d);GRUNT.Log.info("looking for action id: "+d+", found: "+c);if(c){var f=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+d,function(){c.execute(f)})}},findAction:function(d){for(var c=q.length;c--;)if(q[c].id==d)return q[c];return null},getRegisteredActions:function(){return[].concat(q)},getRegisteredActionIds:function(){for(var d=[],c=q.length;c--;)q[c].id&&d.push(q[c].id);return d},registerAction:function(d){d&&
d.id&&q.push(d)},Action:function(d){d=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},d);var c={id:d.id,execute:function(){d.execute&&d.execute.apply(this,arguments)},getParam:function(f){return d[f]?d[f]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",c.id,d.title,d.icon)}};d.autoRegister&&n.registerAction(c);return c},createAgent:function(d){d=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},d);var c=null,f={getName:function(){return d.name},
getParam:function(a){return d[a]},getId:function(){return GRUNT.toID(f.getName())},run:function(a,b){if(d.execute){var e=c=TILE5.Clock.getTime(true),j=d.translator?d.translator(a):a;d.execute.call(f,j,function(l,k){if(!d.trashOrphanedResults||e==c)b&&b(l,k,j)})}}};return f},runAgents:function(d,c,f){for(var a=0;a<d.length;a++)d[a].run(c,f)}};return n}();
TILE5.Messaging=function(){var q=[],n=[],d=GRUNT.newModule({id:"TILE5.messaging",requires:["TILE5.core"],STATUS:{none:0,created:1,updated:2,handled:3},send:function(c){c=GRUNT.extend({type:"",payload:{},index:0,status:d.STATUS.created,statusChange:null},c);c.index=n.push(c)-1;c=c.index;var f=c>=0&&c<n.length?n[c]:null;GRUNT.Log.info("firing message update, index = "+c+", message = "+f);for(var a=0;f&&a<q.length&&f.status!==d.STATUS.handled;){var b=q[a].processUpdate(n[c]);if(b){b=b;q[a].getId();var e=
c>=0&&c<n.length?n[c]:null;if(e){e.status=b;e.statusChange&&e.statusChange(e)}}a++}},Handler:function(c){c=GRUNT.extend({id:"",processUpdate:null},c);var f={getId:function(){return c.id},processUpdate:function(a){if(c.processUpdate)return c.processUpdate(a);return d.STATUS.none}};q.push(f);return f}});return d}();
TILE5.Animation=function(){function q(){if(c===0)c=setInterval(function(){if(f.update(TILE5.Clock.getTime())===0){clearInterval(c);c=0}},20)}var n=[],d=false,c=0,f={DURATION:2E3,tweenValue:function(a,b,e,j,l){a=new f.Tween({startValue:a,endValue:b,tweenFn:e,complete:j,duration:l});n.push(a);return a},tween:function(a,b,e,j,l,k){a=new f.Tween({target:a,property:b,endValue:e,tweenFn:j,duration:k,complete:l});n.push(a);return a},tweenVector:function(a,b,e,j,l,k){var i=[];if(a){var g=a.x==b,h=a.y==e;
g||i.push(f.tween(a,"x",b,j,function(){(g=true)&&h&&l()},k));h||i.push(f.tween(a,"y",e,j,function(){h=true;g&&h&&l()},k))}return i},cancel:function(a){if(!d){d=true;try{for(var b=0;b<n.length;)if(!a||a(n[b])){GRUNT.Log.info("CANCELLING ANIMATION");n[b].triggerComplete(true);n.splice(b,1)}else b++}finally{d=false}}},isTweening:function(){return n.length>0},update:function(a){if(d)return n.length;d=true;try{for(var b=0;b<n.length;)if(n[b].isComplete()){n[b].triggerComplete(false);n.splice(b,1);GRUNT.WaterCooler.say("animation.complete")}else{n[b].update(a);
b++}}finally{d=false}return n.length},Tween:function(a){a=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:f.DURATION,tweenFn:f.DEFAULT,complete:null,cancelOnInteract:false},a);var b=TILE5.Clock.getTime(),e=[],j=false,l=0,k=0,i={cancelOnInteract:a.cancelOnInteract,isComplete:function(){return j},triggerComplete:function(g){a.complete&&a.complete(g)},update:function(g){try{var h=a.tweenFn(g-b,l,k,a.duration);if(a.target)a.target[a.property]=h;for(var m=e.length;m--;)e[m](h,
void 0);if(j=b+a.duration<=g){if(a.target)a.target[a.property]=a.tweenFn(a.duration,l,k,a.duration);for(var o=e.length;o--;)e[o](h,true)}}catch(r){GRUNT.Log.exception(r)}},requestUpdates:function(g){e.push(g)}};l=a.target&&a.property&&a.target[a.property]?a.target[a.property]:a.startValue;if(typeof a.endValue!=="undefined")k=a.endValue-l;if(k==0)j=true;q();return i},Easing:function(){var a=1.70158;return{Linear:function(b,e,j,l){return j*b/l+e},Back:{In:function(b,e,j,l){return j*(b/=l)*b*((a+1)*
b-a)+e},Out:function(b,e,j,l){return j*((b=b/l-1)*b*((a+1)*b+a)+1)+e},InOut:function(b,e,j,l){return(b/=l/2)<1?j/2*b*b*(((a*=1.525)+1)*b-a)+e:j/2*((b-=2)*b*(((a*=1.525)+1)*b+a)+2)+e}},Bounce:{In:function(b,e,j,l){return j-f.Easing.Bounce.Out(l-b,0,j,l)+e},Out:function(b,e,j,l){return(b/=l)<1/2.75?j*7.5625*b*b+e:b<2/2.75?j*(7.5625*(b-=1.5/2.75)*b+0.75)+e:b<2.5/2.75?j*(7.5625*(b-=2.25/2.75)*b+0.9375)+e:j*(7.5625*(b-=2.625/2.75)*b+0.984375)+e},InOut:function(b,e,j,l){return b<l/2?f.Easing.Bounce.In(b*
2,0,j,l)*0.5+e:f.Easing.Bounce.Out(b*2-l,0,j,l)*0.5+j*0.5+e}},Cubic:{In:function(b,e,j,l){return j*(b/=l)*b*b+e},Out:function(b,e,j,l){return j*((b=b/l-1)*b*b+1)+e},InOut:function(b,e,j,l){if((b/=l/2)<1)return j/2*b*b*b+e;return j/2*((b-=2)*b*b+2)+e}},Elastic:{In:function(b,e,j,l,k,i){if(b==0)return e;if((b/=l)==1)return e+j;i||(i=l*0.3);if(!k||k<Math.abs(j)){k=j;j=i/4}else j=i/(2*Math.PI)*Math.asin(j/k);return-(k*Math.pow(2,10*(b-=1))*Math.sin((b*l-j)*2*Math.PI/i))+e},Out:function(b,e,j,l,k,i){var g;
if(b==0)return e;if((b/=l)==1)return e+j;i||(i=l*0.3);if(!k||k<Math.abs(j)){k=j;g=i/4}else g=i/(2*Math.PI)*Math.asin(j/k);return k*Math.pow(2,-10*b)*Math.sin((b*l-g)*2*Math.PI/i)+j+e},InOut:function(b,e,j,l,k,i){var g;if(b==0)return e;if((b/=l/2)==2)return e+j;i||(i=l*0.3*1.5);if(!k||k<Math.abs(j)){k=j;g=i/4}else g=i/(2*Math.PI)*Math.asin(j/k);if(b<1)return-0.5*k*Math.pow(2,10*(b-=1))*Math.sin((b*l-g)*2*Math.PI/i)+e;return k*Math.pow(2,-10*(b-=1))*Math.sin((b*l-g)*2*Math.PI/i)*0.5+j+e}},Quad:{In:function(b,
e,j,l){return j*(b/=l)*b+e},Out:function(b,e,j,l){return-j*(b/=l)*(b-2)+e},InOut:function(b,e,j,l){if((b/=l/2)<1)return j/2*b*b+e;return-j/2*(--b*(b-2)-1)+e}},Sine:{In:function(b,e,j,l){return-j*Math.cos(b/l*(Math.PI/2))+j+e},Out:function(b,e,j,l){return j*Math.sin(b/l*(Math.PI/2))+e},InOut:function(b,e,j,l){return-j/2*(Math.cos(Math.PI*b/l)-1)+e}}}}()};return GRUNT.extend(f,{DEFAULT:f.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var q={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},n=0,d={DisplayState:q,AnyDisplayState:255,ActiveDisplayStates:q.ACTIVE|q.ANIMATING,DefaultDisplayStates:q.ACTIVE|q.ANIMATING|q.PAN|q.PINCHZOOM,ViewLayer:function(c){c=GRUNT.extend({centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:d.DefaultDisplayStates},c);var f=null,a="",b=GRUNT.extend({isAnimating:function(){return false},addToView:function(e){e.setLayer(a,
b)},shouldDraw:function(e){var j=f?f.fastDraw&&e!==q.ACTIVE:false;return(e&c.validStates)!==0&&(j?c.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},notify:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:a})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:f?f.id:null})},getId:function(){return a},setId:function(e){a=e},getParent:function(){return f},setParent:function(e){f=e}},c);return b},StatusViewLayer:function(){return new d.ViewLayer({validStates:d.AnyDisplayState,
zindex:5E3,draw:function(c,f,a,b,e){c.fillStyle="#FF0000";c.fillRect(10,10,50,50);c.fillStyle="#FFFFFF";c.font="bold 10px sans";c.fillText(e.getDisplayState(),20,20)}})},AnimatedPathLayer:function(c){function f(k,i,g){k.fillStyle="#FFFFFF";k.strokeStyle="#222222";k.beginPath();k.arc(g.x,g.y,4,0,Math.PI*2,false);k.stroke();k.fill()}c=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,canCache:false,validStates:d.ActiveDisplayStates|q.PAN|q.PINCHZOOM,
drawIndicator:null,duration:2E3,autoCenter:false},c);var a=TILE5.VectorMath.edges(c.path),b,e=null,j=0;TILE5.Animation.tweenValue(0,a.total,c.easing,function(){l.remove()},c.duration).requestUpdates(function(k,i){j=k;i&&l.remove()});var l=GRUNT.extend(new d.ViewLayer(c),{cycle:function(){for(var k=0;k<a.accrued.length&&a.accrued[k]<j;)k++;e=null;if(k<c.path.length-1){var i=j-(k>0?a.accrued[k-1]:0),g=c.path[k],h=c.path[k+1];b=TILE5.VectorMath.theta(g,h,a.edges[k]);e=TILE5.VectorMath.pointOnEdge(g,
h,b,i);if(c.autoCenter)(k=l.getParent())&&k.centerOn(e)}return e?1:0},draw:function(k,i){if(e)(c.drawIndicator?c.drawIndicator:f)(k,i,new TILE5.Vector(e.x-i.x,e.y-i.y),b)}});return l},FPSLayer:function(c){c=GRUNT.extend({zindex:1E3,scalePosition:false},c);var f=null,a=GRUNT.extend(new d.ViewLayer(c),{delays:[],draw:function(b,e,j){b.font="bold 8pt Arial";b.textAlign="right";b.fillStyle="rgba(0, 0, 0, 0.8)";b.fillText((f?f:"?")+" fps",j.width-20,20)}});setInterval(function(){for(var b=0,e=a.delays.length,
j=e;j--;)b+=a.delays[j];if(e!==0)f=Math.floor(1E3/(b/e))},1E3);return a},ResourceStatsLayer:function(c){c=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:q.ACTIVE|q.PAN},c);return GRUNT.extend(new d.ViewLayer(c),{fps:null,draw:function(f){var a=TILE5.Resources.getStats(),b=c.indicatorSize,e=10,j;if(a.imageCacheFullness){f.strokeStyle="rgba(0, 0, 255, 1)";f.beginPath();f.arc(15,15,5,0,Math.PI*2*a.imageCacheFullness,false);f.stroke();e=30}if(a.imageLoadingCount>=0){f.fillStyle=
"rgba(0, 255, 0, 0.7)";for(j=a.imageLoadingCount;j--;)f.fillRect(e+j*(b+2),10,b,b)}if(a.queuedImageCount>=0){f.fillStyle="rgba(255, 0, 0, 0.7)";for(j=a.queuedImageCount;j--;)f.fillRect(e+j*(b+2),10+b+2,b,b)}}})},LoadingLayer:function(c){GRUNT.extend({},c)},View:function(c){function f(w,y){y.setId(w);y.setParent(H);l.push(y);l.sort(function(I,K){var L=K.zindex-I.zindex;if(L===0)L=K.created-I.created;return L})}function a(){GRUNT.WaterCooler.say("view.idle",{id:H.id});F=true;v=0}function b(w,y){var I=
0,K=H.getScaleFactor(),L=H.getDisplayState(),T=(new Date).getTime(),R=(L&q.PINCHZOOM)!==0;m=H.getScaleFactor();var Q=0;if(h||R){w.clearRect(0,0,k.width,k.height);h=false}if(R){var N=G.getScaleInfo();H.getDimensions().getCenter();var O=(N.progress?N.progress:1)*0.5;E=N.center;if(N.startRect){O=N.startRect.getCenter();O=TILE5.V.diff(O,E);A=new TILE5.Vector(E.x+O.x,E.y+O.y)}else{N=TILE5.V.diff(N.start,E);A=new TILE5.Vector(E.x-N.x*O,E.y-N.y*O)}if(A)y=TILE5.V.offset(y,A.x,A.y)}w.save();try{if(s!==1)w.scale(s,
s);else if(R){w.translate(E.x,E.y);w.scale(K,K)}for(Q=l.length;Q--;)if(l[Q].shouldDraw(L)){var S=l[Q].draw(w,y,u,L,H);I+=S?S:0}}finally{w.restore()}GRUNT.Log.trace("draw complete",T);return I}function e(){var w=0,y=J===q.PINCHZOOM||J===q.PAN;C=(new Date).getTime();g=D?D.getOffset():new TILE5.Vector;x&&o&&x.delays.push(C-o);if(y){TILE5.Animation.cancel(function(K){return K.cancelOnInteract});F=false;if(v!==0){clearTimeout(v);v=0}}for(y=l.length;y--;){var I=l[y].cycle(C,g);w+=I?I:0}w+=b(i,g);o=C;M=
0;if(B+w>0)j();else if(!F&&v===0)v=setTimeout(a,500);GRUNT.Log.trace("Completed draw cycle",C)}function j(){B++;if(!(p||M!==0)){B=0;M=setTimeout(e,0)}}c=GRUNT.extend({id:"view_"+n++,container:"",pannable:false,scalable:false,clearOnDraw:false,displayFPS:false,displayResourceStats:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,onPan:null,onPinchZoom:null,onScale:null,onDraw:null,autoSize:false},c);var l=
[],k=document.getElementById(c.container),i=null,g=new TILE5.Vector,h=false,m=1,o=null,r=0,p=false,s=1,t=new TILE5.Vector,u=null,z=null,B=0,x=null,E=null,D=null,G=null,F=false,M=0,v=0,A=null,C=0,J=d.DisplayState.ACTIVE;GRUNT.Log.info("Creating a new view instance, attached to container: "+c.container+", canvas = ",k);if(k){TILE5.Touch.resetTouch(k);if(c.autoSize){GRUNT.Log.info("autosizing view: window.height = "+window.innerHeight+", width = "+window.innerWidth);k.height=window.innerHeight-k.offsetTop;
k.width=window.innerWidth-k.offsetLeft}try{i=k.getContext("2d");i.globalCompositeOperation=c.initialDrawMode;i.clearRect(0,0,k.width,k.height)}catch(P){GRUNT.Log.exception(P);throw Error("Could not initialise canvas on specified view element");}}if(c.pannable)D=new TILE5.Pannable({container:c.container,onAnimate:function(){j()},onPan:function(w,y){r=TILE5.Clock.getTime(true);j();t=TILE5.V.offset(t,w,y);c.onPan&&c.onPan(w,y);J=q.PAN},onPanEnd:function(){j();J=q.ACTIVE}});if(c.scalable)G=new TILE5.Scalable({scaleDamping:c.scaleDamping,
container:c.container,onAnimate:function(){J=d.DisplayState.PINCHZOOM;j()},onPinchZoom:function(w,y){r=TILE5.Clock.getTime(true);j();c.onPinchZoom&&c.onPinchZoom(w,y);J=d.DisplayState.PINCHZOOM},onScale:function(w,y){GRUNT.WaterCooler.say("view.scale",{id:H.id});J=d.DisplayState.ACTIVE;j();c.onScale&&c.onScale(w,y)}});var H=GRUNT.extend({},c,D,G,{id:c.id,deviceScaling:s,fastDraw:c.fastDraw||TILE5.Device.getConfig().requireFastDraw,centerOn:function(w){D.setOffset(w.x-k.width*0.5,w.y-k.height*0.5)},
getDimensions:function(){if(k)return new TILE5.Dimensions(k.width,k.height)},getZoomCenter:function(){return A},getLayer:function(w){for(var y=0;y<l.length;y++)if(l[y].getId()==w)return l[y];return null},setLayer:function(w,y){for(var I=0;I<l.length;I++)if(l[I].getId()===w){l.splice(I,1);break}y&&f(w,y);GRUNT.WaterCooler.say("layer.update",{id:w});j()},eachLayer:function(w){for(var y=0;y<l.length;y++)w(l[y])},clearBackground:function(){h=true},freeze:function(){p=true},unfreeze:function(){p=false;
j()},snapshot:function(){},getDisplayState:function(){return p?q.FROZEN:J},scale:function(w,y,I,K,L){K||(K=H.getDimensions().getCenter());L||(L=H.getDimensions().getCenter());G&&G.animate(w,K,L,y,I);return G},removeLayer:function(w){a:{for(var y=l.length;y--;)if(l[y].getId()==w){w=y;break a}w=-1}if(w>=0&&w<l.length){GRUNT.WaterCooler.say("layer.removed",{layer:l[w]});l.splice(w,1)}}});u=H.getDimensions();z=u.getCenter();GRUNT.WaterCooler.listen("layer.remove",function(w){w.id&&H.removeLayer(w.id)});
GRUNT.WaterCooler.listen("view.wake",function(w){if(!w.id||w.id===H.id)j()});s=TILE5.Device.getConfig().getScaling();if(c.displayFPS){x=new d.FPSLayer;H.setLayer("fps",x)}c.displayResourceStats&&H.setLayer("resourceStats",new d.ResourceStatsLayer);j();return H}};return d}();
TILE5.Tiling=function(){function q(){if(!d){d=document.createElement("canvas");d.width=f.Config.TILESIZE;d.height=f.Config.TILESIZE;var a=d.getContext("2d");a.fillStyle="rgba(150, 150, 150, 0.05)";a.fillRect(0,0,d.width,d.height)}return d}function n(){if(!c){c=document.createElement("canvas");c.width=f.Config.TILESIZE;c.height=f.Config.TILESIZE;var a=c.getContext("2d"),b=Math.sqrt(f.Config.TILESIZE);a.fillStyle="rgba(200, 200, 200, 1)";a.strokeStyle="rgb(190, 190, 190)";a.lineWidth=0.5;a.fillRect(0,
0,c.width,c.height);a.beginPath();for(var e=0;e<c.width;e+=b){a.moveTo(e,0);a.lineTo(e,c.height);for(var j=0;j<c.height;j+=b){a.moveTo(0,j);a.lineTo(c.width,j)}}a.stroke()}return c}TileStore=function(a){a=GRUNT.extend({gridSize:20,center:new TILE5.Vector,onPopulate:null},a);var b=Array(Math.pow(a.gridSize,2)),e=TILE5.V.offset(a.center,-Math.ceil(a.gridSize>>1)),j=null,l=new TILE5.Vector,k=null,i={getGridSize:function(){return a.gridSize},getNormalizedPos:function(g,h){return TILE5.V.add(new TILE5.Vector(g,
h),TILE5.V.invert(e),l)},getTileShift:function(){return TILE5.V.copy(l)},getTile:function(g,h){return g>=0&&g<a.gridSize?b[h*a.gridSize+g]:null},setTile:function(g,h,m){b[h*a.gridSize+g]=m},populate:function(g,h){var m=GRUNT.Log.getTraceTicks(),o=0;new TILE5.Vector(a.gridSize*0.5,a.gridSize*0.5);if(g)for(var r=0;r<a.gridSize;r++)for(var p=0;p<a.gridSize;p++){if(!b[o]){var s=g(p,r,e,a.gridSize);b[o]=s}o++}j=g;k=h;GRUNT.Log.trace("tile grid populated",m);a.onPopulate&&a.onPopulate()},getShiftDelta:function(g,
h,m,o){var r=Math.floor(a.gridSize*0.2),p=new TILE5.Vector;if(g<0||g+m>a.gridSize)p.x=g<0?-r:r;if(h<0||h+o>a.gridSize)p.y=h<0?-r:r;return p},shift:function(g,h){if(!(g.x===0&&g.y===0)){var m=GRUNT.Log.getTraceTicks(),o=Array(b.length);o.length=b.length;for(var r=0;r<a.gridSize;r++)for(var p=0;p<a.gridSize;p++)o[p*a.gridSize+r]=i.getTile(r+g.x,p+g.y);b=o;e=h?h(e,g):TILE5.V.add(e,g);l.x+=-g.x*a.tileSize;l.y+=-g.y*a.tileSize;GRUNT.Log.trace("tile storage shifted",m);i.populate(j,k)}},setOrigin:function(g,
h){if(tileOrigin)shiftOrigin(g,h);else e=TILE5.V.offset(new TILE5.Vector(g,h),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var g=b.length;g--;)if(b[g])b[g].loaded=false});return i};var d=null,c=null,f={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(a){return a=GRUNT.extend({x:0,y:0,size:256},a)},ImageTile:function(a){a=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},a);return new f.Tile(a)},TileGrid:function(a){function b(s,t,u,
z){if((k?TILE5.V.absSize(TILE5.V.diff(k,t)):j)>=20){s=e.getTileShift();s=new TILE5.Vector(Math.floor((t.x+s.x)*l),Math.floor((t.y+s.y)*l));var B=Math.ceil(u.width*l)+1;u=Math.ceil(u.height*l)+1;var x=new TILE5.Vector((B-1)*0.5,(u-1)*0.5),E=new TILE5.Vector(s.x*a.tileSize,s.y*a.tileSize);z.isAnimating();h=[];tilesNeeded=false;for(var D=u;D--;)for(var G=D*a.tileSize+E.y,F=B;F--;){z=e.getTile(F+s.x,D+s.y);var M=F*a.tileSize+E.x,v=new TILE5.Vector(F-x.x,D-x.y);z||(o=e.getShiftDelta(s.x,s.y,B,u));h.push({tile:z,
coordinates:new TILE5.Vector(M,G),centerness:TILE5.V.absSize(v)})}h.sort(function(A,C){return C.centerness-A.centerness});k=TILE5.V.copy(t)}}a=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true,checkChange:100},a);var e=new TileStore(GRUNT.extend({onPopulate:function(){i=true;p.wakeParent()}},a)),j=Math.round(a.tileSize>>1),l=a.tileSize?1/a.tileSize:0,k=null,i=false,g=true,h=[],m=false;new TILE5.Vector;var o=new TILE5.Vector,
r=e.getGridSize()*a.tileSize,p=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{gridDimensions:new TILE5.Dimensions(r,r),cycle:function(){var s=0;if(o.x+o.y!==0){e.shift(o,a.shiftOrigin);o=new TILE5.Vector;s++}return s+i?1:0},deactivate:function(){g=false},drawTile:function(){return false},draw:function(s,t,u,z,B){if(g){var x=GRUNT.Log.getTraceTicks(),E=e.getTileShift(),D=t.x+E.x;E=t.y+E.y;var G=true;if(z!==TILE5.Graphics.DisplayState.PINCHZOOM){b(s,t,u,B);GRUNT.Log.trace("updated draw queue",x)}if(a.drawGrid)s.strokeStyle=
"rgba(50, 50, 50, 0.3)";s.beginPath();for(t=h.length;t--;){u=h[t].tile;B=h[t].coordinates.x-D;var F=h[t].coordinates.y-E;if(u){G=p.drawTile(s,u,B,F,z)&&G;u.x=B;u.y=F}else G=false;a.drawGrid&&s.rect(B,F,a.tileSize,a.tileSize)}s.stroke();GRUNT.Log.trace("drawn tiles",x);G&&!m&&GRUNT.WaterCooler.say("tiles.drawn",{id:p.getId()});m=G;i=false}},getTileSize:function(){return a.tileSize},getTileVirtualXY:function(s,t,u){s=e.getNormalizedPos(s,t);s=new TILE5.Vector(s.x*a.tileSize,s.y*a.tileSize);if(u){s.x+=
j;s.y+=j}return s},getCenterXY:function(){var s=Math.ceil(e.getGridSize()>>1);return p.getTileVirtualXY(s,s,true)},populate:function(s){e.populate(s,function(){})}});GRUNT.WaterCooler.listen("tile.loaded",function(){i=true;p.wakeParent()});return p},ImageTileGrid:function(a){function b(){GRUNT.WaterCooler.say("tile.loaded")}a=GRUNT.extend({},a);return GRUNT.extend(new f.TileGrid(a),{drawTile:function(e,j,l,k,i){var g=TILE5.Resources.getImage(j.url),h=false;i===TILE5.Graphics.DisplayState.PAN&&e.drawImage(n(),
l,k);if(g&&g.complete&&g.width>0){e.drawImage(g,l,k);h=true}else{e.drawImage(q(),l,k);g||TILE5.Resources.loadImage(j.url,b)}return h}})},Tiler:function(a){a=GRUNT.extend({container:"",drawCenter:false,onPan:null,onPanEnd:null,tapHandler:null,doubleTapHandler:null,zoomHandler:null,onDraw:null,datasources:{},tileLoadThreshold:"first"},a);var b=new TILE5.Graphics.View(GRUNT.extend({},a,{pannable:true,scalable:true,scaleDamping:true}));TILE5.Touch.captureTouch(document.getElementById(a.container),a);
GRUNT.extend(b,{getTileLayer:function(){return b.getLayer("grid0")},setTileLayer:function(e){b.setLayer("grid0",e);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},gridPixToViewPix:function(e){var j=b.getOffset();return new TILE5.Vector(e.x-j.x,e.y-j.y)},viewPixToGridPix:function(e){var j=b.getOffset();return new TILE5.Vector(e.x+j.x,e.y+j.y)},cleanup:function(){b.removeLayer("grid0")}});return b}};return f}();
TILE5.Geo=function(){function q(i,g){var h=null;for(var m in l)if(g){if(m==g&&l[m][i]){h=l[m];break}}else if(l[m][i]){h=l[m];break}return h}function n(i,g,h,m){var o=0;i=i.toUpperCase();for(var r in m){var p=g[r];if(p){var s=h[r];p=s?s(i,p):i.containsWord(p)?1:0;o+=p*m[r]}}return o}var d=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],c=Math.PI/180,f=180/Math.PI,a=/(\d+)\s?\-\s?(\d+)/,b=/^(\d+).*$/,e=null,j={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",
CT:"COURT",LN:"LANE",HWY:"HIGHWAY",MWY:"MOTORWAY"},l={},k={Engine:function(i){if(!i.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var g=GRUNT.extend({remove:function(){delete l[g.id]}},i);return l[g.id]=g},getEngine:function(i){for(var g=null,h=1;!g&&h<arguments.length;h++)g=q(i,arguments[h]);g=g?g:q(i);if(!g)throw Error("Unable to find GEO engine with "+i+" capability");return g},Radius:function(i,g){return{distance:parseInt(i,10),uom:g}},Position:function(i,g){return{lat:parseFloat(i?
i:0),lon:parseFloat(g?g:0)}},BoundingBox:function(i,g){var h={min:k.P.parse(i),max:k.P.parse(g),expand:function(m){h.min.lat-=m;h.min.lon-=k.Utilities.normalizeLon(m);h.max.lat+=m;h.max.lon+=k.Utilities.normalizeLon(m)},getDistance:function(){return k.P.calcDistance(h.min,h.max)},getCenter:function(){var m=k.calculateBoundsSize(h.min,h.max);return new TILE5.Geo.Position(h.min.lat+m.y*0.5,h.min.lon+m.x*0.5)},transform:function(m){var o=new TILE5.Geo.BoundingBox(h.min,h.max);GRUNT.Log.info("applying "+
m.length+" transformers");for(var r=0;m&&r<m.length;r++)m[r].apply(o);return o}};return h},Transforms:function(){return{Shrink:function(){return function(){}},Offset:function(){return function(){}}}}(),Address:function(i){i=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",pos:null,boundingBox:null},i);return GRUNT.extend(i,{getPos:function(){return i.pos},toString:function(){return i.streetDetails+" "+i.location}})},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},
Utilities:function(){var i={lat2pix:function(g,h){var m=parseFloat(g)*2*Math.PI/360;m=Math.sin(m);var o=0.08181919084262157*m;return Math.log((1+m)/(1-m)*Math.pow((1-o)/(1+o),0.08181919084262157))/2/h},lon2pix:function(g,h){return parseFloat(g)/180*Math.PI/h},pix2lon:function(g,h){return i.normalizeLon(g*h*180/Math.PI)},pix2lat:function(g,h){for(var m=Math.pow(Math.E,-g*h),o=i.mercatorUnproject(m),r=i.findRadPhi(o,m),p=0;p<12&&Math.abs(o-r)>1.0E-7;){o=r;r=i.findRadPhi(o,m);p++}return r*180/Math.PI},
mercatorUnproject:function(g){return Math.PI/2-2*Math.atan(g)},findRadPhi:function(g,h){var m=0.08181919084262157*Math.sin(g);return Math.PI/2-2*Math.atan(h*Math.pow((1-m)/(1+m),0.040909595421310785))},normalizeLon:function(g){for(;g<-180;)g+=360;for(;g>180;)g-=360;return g}};return i}(),GeoSearchResult:function(i){i=GRUNT.extend({id:null,caption:"",resultType:"",data:null,pos:null,matchWeight:0},i);return GRUNT.extend(i,{toString:function(){return i.caption+(i.matchWeight?" ("+i.matchWeight+")":
"")}})},GeoSearchAgent:function(i){i=GRUNT.extend({},i);return GRUNT.extend({},TILE5.Dispatcher.createAgent(i))},GeocodingAgent:function(i){i=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(g,h){try{if(!g.reverse&&!g.freeform)address=new k.Address(g);var m=k.getEngine("geocode");if(m)m.geocode({addresses:[g.freeform?g.freeform:address],complete:function(r,p){if(h){var s=p;if(g.freeform)s=k.rankGeocodeResponses(g.freeform,s,k.getEngine("geocode"));h(s,i)}}})}catch(o){GRUNT.Log.exception(o)}}},
i);return new k.GeoSearchAgent(i)},PointOfInterest:function(i){i=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},i);if(!i.pos&&i.lat&&i.lon)i.pos=new TILE5.Geo.Position(i.lat,i.lon);return GRUNT.extend({toString:function(){return i.id+": '"+i.title+"'"}},i)},POIStorage:function(i){function g(s){s=s?s:"default";o[s]||(o[s]=[]);return o[s]}function h(s){var t=[];for(var u in o)for(var z=0;z<o[u].length;z++)if(!s||s(o[u][z]))t.push(o[u][z]);return t}function m(){GRUNT.WaterCooler.say("geo.pois-updated",
{srcID:p.id,pois:p.getPOIs()})}i=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},i);var o={},r=true,p={id:GRUNT.generateObjectID(),getPOIs:function(){return h()},getOldPOIs:function(s,t){return h(function(u){return u.group==s&&u.retrieved<t})},getVisible:function(){return r},setVisible:function(s){if(s!=r){r=s;i.visibilityChange&&i.visibilityChange()}},findById:function(s){var t=h(function(u){return u.id==s});return t.length>0?t[0]:null},findByBounds:function(s){return h(function(t){return TILE5.Geo.posInBounds(t.pos,
s)})},addPOIs:function(s,t){if(t)o={};for(var u=0;s&&u<s.length;u++){s[u].retrieved=TILE5.Clock.getTime(true);var z=s[u];g(z.group).push(z)}},removeGroup:function(s){if(o[s]){delete o[s];m()}},update:function(s){var t=[],u=0,z=s.length>0?s[0].group:"",B=TILE5.Clock.getTime(true);for(u=0;u<s.length;u++){var x;a:{if(x=s[u])for(var E=g(x.group),D=0;D<E.length;D++)if(E[D].id==x.id){x=E[D];break a}x=null}if(x){x.retrieved=B;x.isNew=false}else t.push(s[u])}s=p.getOldPOIs(z,B);p.addPOIs(t);for(u=0;i.onPOIAdded&&
u<t.length;u++)i.onPOIAdded(t[u]);for(u=0;u<s.length;u++){i.onPOIDeleted&&i.onPOIDeleted(s[u]);z=s[u];B=g(z.group);for(x=0;x<B.length;x++)if(B[x].id==z.id){B.splice(x,1);break}}t.length+s.length>0&&m()}};return p},MapProvider:function(){return{zoomLevel:0,checkZoomLevel:function(i){return i},getCopyright:function(){},getMapTiles:function(){},getPositionForXY:function(){return null}}},P:function(){var i={calcDistance:function(g,h){if(i.empty(g)||i.empty(h))return 0;var m=(h.lat-g.lat).toRad()*0.5,
o=(h.lon-g.lon).toRad()*0.5;m=Math.sin(m)*Math.sin(m)+Math.cos(g.lat.toRad())*Math.cos(h.lat.toRad())*Math.sin(o)*Math.sin(o);return 6371*2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m))},copy:function(g){return g?new k.Position(g.lat,g.lon):null},empty:function(g){return!g||g.lat===0&&g.lon===0},equal:function(g,h){return g&&h&&g.lat==h.lat&&g.lon==h.lon},almostEqual:function(g,h){return g&&h&&Math.floor(g.lat*1E3)===Math.floor(h.lat*1E3)&&Math.floor(g.lon*1E3)===Math.floor(h.lon*1E3)},inArray:function(g,
h){for(var m=k.P.equal,o=h.length;o--;)if(m(g,h[o]))return true;return false},parse:function(g){if(g)if(typeof g.lat!=="undefined")return i.copy(g);else{if(g.split)for(var h=[" ",","],m=0;m<h.length;m++){var o=g.split(h[m]);if(o.length===2)return new k.Position(o[0],o[1])}}else return new k.Position;return null},parseArray:function(g){var h=g.length,m=Array(h);for(h=h;h--;)m[h]=i.parse(g[h]);GRUNT.Log.info("parsed "+m.length+" positions");return m},fromMercatorPixels:function(g,h,m){return new k.Position(TILE5.Geo.Utilities.pix2lat(h,
m),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(g,m)))},toMercatorPixels:function(g,h){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(g.lon,h),TILE5.Geo.Utilities.lat2pix(g.lat,h))},toString:function(g){return g?g.lat+" "+g.lon:""}};return i}(),B:function(){var i=-(Math.PI/2),g=Math.PI/2,h=-Math.PI*2,m=Math.PI*2;return{createBoundsFromCenter:function(o,r){var p=r/6371,s=o.lat*c,t=o.lon*c,u=s-p,z=s+p;GRUNT.Log.info("rad distance = "+p);GRUNT.Log.info("rad lat = "+s+", lon = "+
t);GRUNT.Log.info("min lat = "+u+", max lat = "+z);if(u>i&&z<g){s=Math.asin(Math.sin(p)/Math.cos(s));p=t-s;if(p<h)p+=2*Math.PI;t=t+s;if(t>m)t-=2*Math.PI}else{u=Math.max(u,i);z=Math.min(z,g);p=h;t=m}return new k.BoundingBox(new k.Position(u*f,p*f),new k.Position(z*f,t*f))},toString:function(o){return"min: "+k.P.toString(o.min)+", max: "+k.P.toString(o.max)}}}(),generalizePositions:function(i,g,h){var m=i.length,o=[],r=null;h||(h=250);h/=1E3;GRUNT.Log.info("generalizing positions, must include "+g.length+
" positions");for(var p=m;p--;)if(p===0)o.unshift(i[p]);else{var s=!r||k.P.inArray(i[p],g)?h:k.P.calcDistance(r,i[p]);if(i[p]&&s>=h){o.unshift(i[p]);r=i[p]}}GRUNT.Log.info("generalized "+m+" positions into "+o.length+" positions");return o},emptyBounds:function(i){return!i||k.P.empty(i.min)||k.P.empty(i.max)},posInBounds:function(i,g){var h=!(k.P.empty(i)||k.P.empty(g));return h=(h=h&&i.lat>=g.min.lat&&i.lat<=g.max.lat)&&i.lon>=g.min.lon&&i.lon<=g.max.lon},calculateBoundsSize:function(i,g,h){var m=
new TILE5.Vector(0,g.lat-i.lat);if(typeof h==="undefined")h=true;m.x=h&&i.lon>g.lon?360-i.lon+g.lon:g.lon-i.lon;return m},getBoundingBoxZoomLevel:function(i,g){var h=i.getCenter();h=d[Math.min(Math.round(Math.abs(h.lat)*0.05),d.length)];var m=k.calculateBoundsSize(i.min,i.max);return Math.min(Math.ceil(Math.log(d[3]*g.height/m.y)/Math.log(2)),Math.ceil(Math.log(h*g.width/m.x)/Math.log(2)))},getBoundsForPositions:function(i,g){var h=null,m=TILE5.Clock.getTime();g||(g="auto");for(var o=i.length;o--;)if(h){var r=
k.calculateBoundsSize(h.min,i[o],false),p=k.calculateBoundsSize(i[o],h.max,false);if(r.x<0)h.min.lon=i[o].lon;if(r.y<0)h.min.lat=i[o].lat;if(p.x<0)h.max.lon=i[o].lon;if(p.y<0)h.max.lat=i[o].lat}else h=new TILE5.Geo.BoundingBox(i[o],i[o]);if(g){if(g=="auto"){o=k.calculateBoundsSize(h.min,h.max);g=Math.max(o.x,o.y)*0.3}h.expand(g)}GRUNT.Log.trace("calculated bounds for "+i.length+" positions",m);return h},normalizeAddress:function(i){if(!i)return"";i=i.toUpperCase();if(!e){var g=[];for(var h in j)g.push(h);
e=RegExp("(\\s)("+g.join("|")+")(\\s|$)","i")}e.lastIndex=-1;if(g=e.exec(i))i=i.replace(e,"$1"+j[g[2]]);return i},buildingMatch:function(i,g){b.lastIndex=-1;if(b.test(i))for(var h=i.replace(b,"$1"),m=g.split(","),o=0;o<m.length;o++){a.lastIndex=-1;if(a.test(m[o])){var r=a.exec(m[o]);if(h>=parseInt(r[1],10)&&h<=parseInt(r[2],10))return true}else if(h==m[o])return true}return false},rankGeocodeResponses:function(i,g,h){var m=[],o=k.AddressCompareFns;if(h&&h.compareFns)o=GRUNT.extend({},o,h.compareFns);
for(h=0;h<g.length;h++)m.push(new k.GeoSearchResult({caption:g[h].toString(),data:g[h],pos:g[h].pos,matchWeight:n(i,g[h],o,k.GeocodeFieldWeights)}));m.sort(function(r,p){return p.matchWeight-r.matchWeight});return m}};return k}();
TILE5.Geo.Location=function(){function q(c){function f(k){try{var i=new TILE5.Geo.Position(k.coords.latitude,k.coords.longitude),g=GRUNT.isPlainObject(k.coords.accuracy)&&k.coords.accuracy.horizontal?k.coords.accuracy.horizontal:k.coords.accuracy;GRUNT.Log.info("got position coordinates: "+i+", accuracy = "+g);if(c.successCallback&&(!j||g<l))c.successCallback(i,e,k);if(g>c.highAccuracyCutoff&&e<2){e=2;c.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");
b()}j=k;l=g}catch(h){GRUNT.Log.exception(h)}}function a(k){if(k.code===k.PERMISSION_DENIED)c.errorCallback&&c.errorCallback(k);else if(k.code===k.POSITION_UNAVAILABLE)c.errorCallback&&c.errorCallback(k);else if(k.code===k.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(c.timeout===0&&c.autoPhasing){e=1;c.timeout=n;c.enableHighAccuracy=false;b()}}}function b(){navigator.geolocation.getCurrentPosition(f,a,c)}c=GRUNT.extend({autoPhasing:true,maximumAge:3E5,timeout:0,
highAccuracyCutoff:10,enableHighAccuracy:true,successCallback:null,errorCallback:null},c);var e=0,j=null,l=1E6;b()}var n=3E3,d={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)d.get=q;return d}();TILE5.Geo.Search=function(){return{bestResults:function(q,n){n||(n=20);for(var d=q.length>0?q[0]:null,c=[],f=0;f<q.length;f++)if(d.matchWeight-q[f].matchWeight<=n)c.push(q[f]);else break;return c}}}();
TILE5.Mapping=function(){var q=0,n={AnnotationTween:null,GeoTileGrid:function(d){d=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,radsPerPixel:0},d);var c=TILE5.Geo.P.toMercatorPixels(d.centerPos,d.radsPerPixel),f=c.x-d.centerXY.x,a=c.y-d.centerXY.y,b=GRUNT.extend({},d.grid,{getBoundingBox:function(e,j,l,k){return new TILE5.Geo.BoundingBox(b.pixelsToPos(new TILE5.Vector(e,j+k)),b.pixelsToPos(new TILE5.Vector(e+l,j)))},getCenterOffset:function(){return d.centerXY},
getGridXYForPosition:function(e){e=TILE5.Geo.P.toMercatorPixels(e,d.radsPerPixel);return new TILE5.Vector(e.x-f,b.gridDimensions.height-(e.y-a))},getGuideOffset:function(e){var j=b.getTileSize();return new TILE5.Vector(e.x%j,e.y%j)},pixelsToPos:function(e){return TILE5.Geo.P.fromMercatorPixels(f+e.x,a+b.gridDimensions.height-e.y,d.radsPerPixel)}});return b},POIViewLayer:function(d){GRUNT.extend({},d)},Overlay:function(d){GRUNT.extend({},d);return{}},RadarOverlay:function(d){d=GRUNT.extend({radarFill:"rgba(0, 221, 238, 0.1)",
radarStroke:"rgba(0, 102, 136, 0.3)",zindex:100},d);return GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{draw:function(c,f,a){f=a.width>>1;a=a.height>>1;c.fillStyle=d.radarFill;c.strokeStyle=d.radarStroke;c.beginPath();c.arc(f,a,50,0,Math.PI*2,false);c.fill();c.stroke()}})},CrosshairOverlay:function(d){d=GRUNT.extend({lineWidth:1.5,strokeStyle:"rgba(0, 0, 0, 0.5)",size:15,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},
d);return GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{draw:function(c,f,a){f=a.getCenter();c.lineWidth=d.lineWidth;c.strokeStyle=d.strokeStyle;a=d.size;c.beginPath();c.moveTo(f.x,f.y-a);c.lineTo(f.x,f.y+a);c.moveTo(f.x-a,f.y);c.lineTo(f.x+a,f.y);c.arc(f.x,f.y,a*0.6666,0,2*Math.PI,false);c.stroke()}})},RouteOverlay:function(d){d=GRUNT.extend({strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,zindex:50},
d);var c=true,f=null,a=[],b=0,e=[],j=[],l=GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{getAnimation:function(k,i,g,h){if(c)return null;var m="routeAnimation"+q++;j.push(m);return new TILE5.Graphics.AnimatedPathLayer({id:m,path:a,zindex:d.zindex+1,easing:k?k:TILE5.Animation.Easing.Sine.InOut,duration:i?i:5E3,drawIndicator:g,autoCenter:h?h:false})},draw:function(k,i,g,h,m){g=0;h=d.data?d.data.geometry:null;if(c){c=false;f=null;a=[];b=0}if(h&&b<h.length){a:{m=m.getTileLayer();e=[];h=GRUNT.Log.getTraceTicks();
var o,r,p,s=d.data?d.data.geometry:[],t=s.length,u=d.data?d.data.instructions:[],z=u.length,B=d.calculationsPerCycle,x=0;for(o=b;o<t;o++){r=m.getGridXYForPosition(s[o]);if(p=!f||o===0||Math.abs(r.x-f.x)+Math.abs(r.y-f.y)>d.pixelGeneralization){a.push(r);f=r}x++;if(x>=B){b=o;break a}}b=t;GRUNT.Log.trace(t+" geometry points generalized to "+a.length+" coordinates",h);f=null;for(o=z;o--;)if(u[o].position){r=m.getGridXYForPosition(u[o].position);if(p=!f||o===0||Math.abs(r.x-f.x)+Math.abs(r.y-f.y)>d.pixelGeneralization){e.push(r);
f=r}}}g++}m=a.length;if(m>0&&(!g||d.partialDraw)){k.strokeStyle=d.strokeStyle;k.lineWidth=d.lineWidth;k.beginPath();k.moveTo(a[m-1].x-i.x,a[m-1].y-i.y);for(m=m;m--;)k.lineTo(a[m].x-i.x,a[m].y-i.y);k.stroke();k.fillStyle=d.waypointFillStyle;for(m=e.length;m--;){k.beginPath();k.arc(e[m].x-i.x,e[m].y-i.y,2,0,Math.PI*2,false);k.stroke();k.fill()}}return g}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var k=j.length;k--;)GRUNT.WaterCooler.say("layer.remove",{id:j[k]});j=[];c=true;l.wakeParent()});
return l},Annotation:function(d){d=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:n.AnnotationTween,animationSpeed:null},d);var c=false,f={xy:d.xy,pos:d.pos,isNew:true,isAnimating:function(){return c},draw:function(a,b,e,j){if(f.xy){if(f.isNew&&d.tweenIn){var l=f.xy.y;f.xy.y=b.y-20;c=true;TILE5.Animation.tween(f.xy,"y",l,d.tweenIn,function(){f.xy.y=l;c=false},d.animationSpeed?d.animationSpeed:250+Math.random()*500)}if(d.draw)d.draw(a,b,new TILE5.Vector(f.xy.x-b.x,f.xy.y-b.y),e,j);else{a.beginPath();
a.arc(f.xy.x-b.x,f.xy.y-b.y,4,0,Math.PI*2,false);a.fill()}f.isNew=false}}};return f},ImageAnnotation:function(d){d=GRUNT.extend({imageUrl:null,animatingImageUrl:null,imageAnchor:null},d);var c=d.imageAnchor?TILE5.V.invert(d.imageAnchor):null;d.draw=function(a,b,e,j,l){if(d.animatingImageUrl&&f.isAnimating()){TILE5.Resources.loadImage(d.imageUrl);j=d.animatingImageUrl}else j=d.imageUrl;if(b=TILE5.Resources.getImage(j)){if(b.complete&&b.width>0){c||(c=new TILE5.Vector(-b.width>>1,-b.height>>1));e=TILE5.V.offset(e,
c.x,c.y);a.drawImage(b,e.x,e.y,b.width,b.height)}}else TILE5.Resources.loadImage(j,function(){l.wakeParent()})};var f=new n.Annotation(d);return f},AnnotationsOverlay:function(d){function c(j){for(var l=d.map?d.map.getTileLayer():null,k=0;l&&k<j.length;k++)j[k].xy=l.getGridXYForPosition(j[k].pos)}d=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},d);var f=[],a=false,b=[],e=GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{draw:function(j,l,k,i){j.save();try{var g;a=false;j.fillStyle=
"rgba(255, 0, 0, 0.75)";j.globalCompositeOperation="source-over";for(g=f.length;g--;){f[g].draw(j,l,i,e);a=a||f[g].isAnimating()}for(g=b.length;g--;){b[g].draw(j,l,i,e);a=a||b[g].isAnimating()}a&&e.wakeParent()}finally{j.restore()}},add:function(j){b.push(j);c(b);e.wakeParent()},clear:function(j){b=[];c(b);if(j){f=[];c(f)}e.wakeParent()},isAnimating:function(){return a}});GRUNT.WaterCooler.listen("geo.pois-updated",function(j){if(d.pois&&d.pois.id==j.srcID){j=j.pois;try{f=[];for(var l=0;l<j.length;l++)if(j[l].pos){var k;
var i=j[l];if(i&&i.pos){var g=null;if(g=d.createAnnotationForPOI?d.createAnnotationForPOI(i):new n.Annotation({pos:i.pos})){g.isNew=i.isNew;i.isNew=false}k=g}else k=void 0;k&&f.push(k)}c(f)}catch(h){GRUNT.Log.exception(h)}e.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){c(f);c(b);e.wakeParent()});return e},Tiler:function(d){d=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,copyright:undefined,zoomLevel:0,boundsChange:null,tapPOI:null,tapHandler:null,boundsChangeThreshold:30,
pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,onTilesLoaded:null},d);if(typeof d.copyright==="undefined")d.copyright=d.provider?d.provider.getCopyright():"";var c=new TILE5.Vector,f=d.copyright,a=false,b=[],e=0,j=null,l=null,k=d.zoomLevel,i=d.tapHandler;if(!d.provider)d.provider=new TILE5.Geo.MapProvider;var g=new TILE5.Tiling.Tiler(GRUNT.extend({},d,{tapHandler:function(m,o){var r=h.getTileLayer(),p=null;if(r){p=h.viewPixToGridPix(new TILE5.Vector(o.x,o.y));var s=r.pixelsToPos(p),t=r.pixelsToPos(TILE5.V.offset(p,
-d.tapExtent,d.tapExtent)),u=r.pixelsToPos(TILE5.V.offset(p,d.tapExtent,-d.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(r.pixelsToPos(p)));p=new TILE5.Geo.BoundingBox(t,u);b=h.pois.findByBounds(p);d.tapPOI&&d.tapPOI(b)}i&&i(m,o,s,p)},doubleTapHandler:function(m,o){h.animate(2,h.getDimensions().getCenter(),new TILE5.Vector(o.x,o.y),TILE5.Animation.Easing.Sine.Out)},onScale:function(m,o){var r=0;m=Math.sqrt(m);if(m<1)r=-(0.5/m);else if(m>1)r=m;h.gotoPosition(h.getXYPosition(o),k+
Math.floor(r))}})),h=GRUNT.extend({},g,{pois:d.pois,annotations:null,getBoundingBox:function(){var m=new TILE5.Geo.BoundingBox,o=h.getTileLayer(),r=h.getOffset(),p=h.getDimensions();if(o)m=o.getBoundingBox(r.x,r.y,p.width,p.height);return m},getCenterPosition:function(){return h.getXYPosition(h.gridDimensions.getCenter())},getXYPosition:function(m){return h.getTileLayer().pixelsToPos(h.viewPixToGridPix(m))},gotoBounds:function(m,o){var r=TILE5.Geo.getBoundingBoxZoomLevel(m,h.getDimensions());h.gotoPosition(m.getCenter(),
r,o)},gotoCurrentPosition:function(m){TILE5.Geo.Location.get({successCallback:function(o){h.clearBackground();h.gotoPosition(o,15,m)},errorCallback:function(){}})},gotoPosition:function(m,o,r){var p=k,s=(new Date).getTime();k=o?o:k;if(!k)throw"Zoom level required to goto a position.";if(d.provider)k=d.provider.checkZoomLevel(k);if(!a||k!==p){TILE5.Resources.resetImageLoadQueue();(o=h.getTileLayer())&&o.deactivate();TILE5.Animation.cancel();a&&h.freeze();e=s;d.provider.zoomLevel=k;d.provider.getMapTiles(h,
m,function(t){if(s===e){h.setTileLayer(t);l=t.getId();h.panToPosition(m,function(){h.unfreeze();r&&r()})}else GRUNT.Log.info("request time mismatch - ignoring update")});a=true}else h.panToPosition(m,r)},panToPosition:function(m,o,r){var p=h.getTileLayer();if(p){m=p.getGridXYForPosition(m);p=h.getDimensions();m.x-=p.width>>1;m.y-=p.height>>1;if(j)j=null;h.updateOffset(m.x,m.y,r);GRUNT.WaterCooler.say("view.wake",{id:h.id});d.boundsChange&&d.boundsChange(h.getBoundingBox());o&&o(h)}},setZoomLevel:function(m){h.gotoPosition(h.getCenterPosition(),
m)},zoomIn:function(){h.scale(2,TILE5.Animation.Easing.Sine.Out)||h.setZoomLevel(k+1)},zoomOut:function(){h.scale(0.5,TILE5.Animation.Easing.Sine.Out)||h.setZoomLevel(k-1)},animateRoute:function(m,o,r,p){var s=h.getLayer("route");if(s)(m=s.getAnimation(m,o,r,p))&&m.addToView(h)}},g);g=new TILE5.Mapping.AnnotationsOverlay({pois:h.pois,map:h,createAnnotationForPOI:d.createAnnotationForPOI});h.annotations=g;h.setLayer("annotations",g);d.crosshair&&h.setLayer("crosshair",new TILE5.Mapping.CrosshairOverlay);
f&&h.setLayer("copyright",new TILE5.Graphics.ViewLayer({zindex:999,draw:function(m,o,r){m.lineWidth=2.5;m.fillStyle="rgb(50, 50, 50)";m.strokeStyle="rgba(255, 255, 255, 0.8)";m.font="bold 10px sans";m.textBaseline="bottom";m.strokeText(f,10,r.height-10);m.fillText(f,10,r.height-10)}}));GRUNT.WaterCooler.listen("view.idle",function(m){if(m.id&&m.id==h.id)if(TILE5.V.absSize(TILE5.V.diff(c,h.getOffset()))>d.boundsChangeThreshold&&d.boundsChange){c=h.getOffset();d.boundsChange(h.getBoundingBox())}});
GRUNT.WaterCooler.listen("tiles.drawn",function(m){m.id&&m.id==l&&d.onTilesLoaded&&d.onTilesLoaded()});return h}};return n}();
TILE5.Geo.Routing=function(){var q={calculate:function(n){n=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},n);GRUNT.Log.info("attempting to calculate route");var d=TILE5.Geo.getEngine("route");d&&d.route(n,function(c){if(n.generalize)c.geometry=TILE5.Geo.generalizePositions(c.geometry,c.getInstructionPositions());if(n.map){q.createMapOverlay(n.map,c);if(n.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+c.boundingBox);n.map.gotoBounds(c.boundingBox)}}n.success&&
n.success(c)})},createMapOverlay:function(n,d){var c=n.getDimensions();c=new TILE5.Mapping.RouteOverlay({data:d,width:c.width,height:c.height});n.setLayer("route",c)},Maneuver:{None:0,Continue:1,TurnLeft:100,TurnLeftSlight:101,TurnLeftSharp:102,TurnRight:110,TurnRightSlight:111,TurnRightSharp:112,TurnAround:190,EnterRoundabout:200,ExitRamp:300},Instruction:function(n){n=GRUNT.extend({position:null,description:"",manuever:q.Maneuver.None},n);return GRUNT.extend(n,{})},RouteData:function(n){n=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},n);if(!n.boundingBox)n.boundingBox=TILE5.Geo.getBoundsForPositions(n.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var d=[],c=0;c<n.instructions.length;c++)n.instructions[c].position&&d.push(n.instructions[c].position);return d}},n)}};return q}();
