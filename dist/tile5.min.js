if(!this.JSON)this.JSON={};
(function(){function t(n){return n<10?"0"+n:n}function q(n){g.lastIndex=0;return g.test(n)?'"'+n.replace(g,function(e){var b=h[e];return typeof b==="string"?b:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+n+'"'}function m(n,e){var b,k,o,s,r=d,p,u=e[n];if(u&&typeof u==="object"&&typeof u.toJSON==="function")u=u.toJSON(n);if(typeof l==="function")u=l.call(e,n,u);switch(typeof u){case "string":return q(u);case "number":return isFinite(u)?String(u):"null";case "boolean":case "null":return String(u);
case "object":if(!u)return"null";d+=f;p=[];if(Object.prototype.toString.apply(u)==="[object Array]"){s=u.length;for(b=0;b<s;b+=1)p[b]=m(b,u)||"null";o=p.length===0?"[]":d?"[\n"+d+p.join(",\n"+d)+"\n"+r+"]":"["+p.join(",")+"]";d=r;return o}if(l&&typeof l==="object"){s=l.length;for(b=0;b<s;b+=1){k=l[b];if(typeof k==="string")if(o=m(k,u))p.push(q(k)+(d?": ":":")+o)}}else for(k in u)if(Object.hasOwnProperty.call(u,k))if(o=m(k,u))p.push(q(k)+(d?": ":":")+o);o=p.length===0?"{}":d?"{\n"+d+p.join(",\n"+d)+
"\n"+r+"}":"{"+p.join(",")+"}";d=r;return o}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+t(this.getUTCMonth()+1)+"-"+t(this.getUTCDate())+"T"+t(this.getUTCHours())+":"+t(this.getUTCMinutes())+":"+t(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var a=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
g=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,d,f,h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},l;if(typeof JSON.stringify!=="function")JSON.stringify=function(n,e,b){var k;f=d="";if(typeof b==="number")for(k=0;k<b;k+=1)f+=" ";else if(typeof b==="string")f=b;if((l=e)&&typeof e!=="function"&&(typeof e!=="object"||typeof e.length!=="number"))throw Error("JSON.stringify");return m("",
{"":n})};if(typeof JSON.parse!=="function")JSON.parse=function(n,e){function b(o,s){var r,p,u=o[s];if(u&&typeof u==="object")for(r in u)if(Object.hasOwnProperty.call(u,r)){p=b(u,r);if(p!==undefined)u[r]=p;else delete u[r]}return e.call(o,s,u)}var k;n=String(n);a.lastIndex=0;if(a.test(n))n=n.replace(a,function(o){return"\\u"+("0000"+o.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(n.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){k=eval("("+n+")");return typeof e==="function"?b({"":k},""):k}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(t){if(arguments.length<=1)return t;for(var q=arguments.length-2,m=0;m<=q;m++)t=t.replace(RegExp("\\{"+m+"\\}","gi"),arguments[m+1]);return t};
String.prototype.containsWord=function(t){var q="";if(t.toString)t=t.toString();for(var m=0;m<t.length;m++)q+=!/\w/.test(t[m])?"\\"+t[m]:t[m];return RegExp("(^|\\s|\\,)"+q+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var t=Object.prototype.hasOwnProperty,q=0,m={id:"GRUNT.core",extend:function(){var a=arguments[0]||{},g=1,d=arguments.length,f=false,h,l,n,e;if(typeof a==="boolean"){f=a;a=arguments[1]||{};g=2}if(typeof a!=="object"&&!m.isFunction(a))a={};if(d===g){a=this;--g}for(;g<d;g++)if((h=arguments[g])!=null)for(l in h){n=a[l];e=h[l];if(a!==e)if(f&&e&&(m.isPlainObject(e)||m.isArray(e))){n=n&&(m.isPlainObject(n)||m.isArray(n))?n:m.isArray(e)?[]:{};a[l]=m.extend(f,n,e)}else if(e!==undefined)a[l]=
e}return a},isFunction:function(a){return toString.call(a)==="[object Function]"},isArray:function(a){return toString.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||toString.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!t.call(a,"constructor")&&!t.call(a.constructor.prototype,"isPrototypeOf"))return false;var g;for(g in a);return g===undefined||t.call(a,g)},isEmptyObject:function(a){for(var g in a)return false;return true},isXmlDocument:function(a){return toString.call(a)===
"[object Document]"},contains:function(a,g){var d=a,f=arguments,h=1;if(g&&m.isArray(g)){f=g;h=0}for(h=h;h<f;h++)d=d&&typeof foo[f[h]]!=="undefined";return d},newModule:function(a){a=m.extend({id:null,requires:[],parent:null},a);if(a.parent)a=m.extend({},a.parent,a);return a},toID:function(a){return a.replace(/\s/g,"-")},generateObjectID:function(a){return(a?a:"obj")+q++}};return m}();
GRUNT.Log=function(){function t(d,f){var h,l=f&&f.length>0?f[0]:"";for(h=1;f&&h<f.length;h++)l+=" "+(m&&GRUNT.isPlainObject(f[h])?JSON.stringify(f[h]):f[h]);typeof console!=="undefined"&&console[d](l);for(h=0;h<q.length;h++)q[h].call(g,l,d)}var q=[],m=typeof JSON!=="undefined",a=window.console&&window.console.markTimeline,g={id:"GRUNT.log",getTraceTicks:function(){return a?(new Date).getTime():null},trace:function(d,f){if(a)console.markTimeline(d+(f?": "+(g.getTraceTicks()-f)+"ms":""))},debug:function(){t("debug",
arguments)},info:function(){t("info",arguments)},warn:function(){t("warn",arguments)},error:function(){t("error",arguments)},exception:function(d){g.error(arguments);for(var f in d)g.info("ERROR DETAIL: "+f+": "+d[f])},watch:function(d,f){try{f()}catch(h){g.exception(h,d)}},throwError:function(d){g.error(d);throw Error(d);},requestUpdates:function(d){q.push(d)}};return g}();
GRUNT.Data=function(){var t={determineObjectMapping:function(m){if(!m)return null;m=m.split("|");for(var a={},g=0;g<m.length;g++)a[m[g]]=g;return a},mapLineToObject:function(m,a){var g=m.split("|"),d={};for(var f in a){var h=a[f];d[f]=g.length>h?g[h]:null}return d},parse:function(m){var a=null,g=[];m=m.split("\n");for(var d=0;d<m.length;d++){var f=m[d];if(a)g.push(t.mapLineToObject(f,a));else a=t.determineObjectMapping(f)}return g}},q={supportedFormats:{JSON:{parse:function(m){return JSON.parse(m)}},
PDON:{parse:function(m){return t.parse(m)}}},parse:function(m){m=GRUNT.extend({data:"",format:"JSON"},m);if(!q.supportedFormats[m.format])throw Error("Unsupported data format: "+m.format+", cannot parse data in javascript object");try{return q.supportedFormats[m.format].parse(m.data)}catch(a){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+m.format,m.data);GRUNT.Log.exception(a)}return{}}};return q}();
GRUNT.Template=function(){var t=/\$\{(.*?)\}/ig;return{parse:function(q,m){for(var a=q,g=t.exec(a);g;){a=a.replace(g[0],GRUNT.XPath.first(g[1],m));t.lastIndex=0;g=t.exec(a)}return a}}}();
GRUNT.JSONP=function(){function t(g){var d=document.createElement("script"),f=false;d.src=g;d.async=true;d.onload=d.onreadystatechange=function(){if(!f&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){f=true;d.onload=d.onreadystatechange=null;d&&d.parentNode&&d.parentNode.removeChild(d)}};m||(m=document.getElementsByTagName("head")[0]);m.appendChild(d)}var q=0,m,a=this;return{get:function(g,d,f){g+=g.indexOf("?")>=0?"&":"?";var h="json"+ ++q;a[h]=function(l){d(l);a[h]=
null;try{delete a[h]}catch(n){}};t(g+(f?f:"callback")+"="+h);return h}}}();
GRUNT.XHR=function(){var t={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},q={JSON:["json"],PDON:["pdon.txt"]},m=["TEXT","STREAM"],a=/^(\w+:)?\/\/([^\/?#]+)/,g={XML:function(h){return h.responseXML},JSON:function(h){try{return JSON.parse(h.responseText)}catch(l){GRUNT.Log.error("Error parsing JSON data: ",h.responseText);GRUNT.Log.exception(l)}return""},PDON:function(h){return GRUNT.Data.parse({data:h.responseText,format:"PDON"})},DEFAULT:function(h){return h.responseText}},
d={CONTENT_TYPE:"Content-Type"},f=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(h){try{h=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},f.ajaxSettings,h);var l=a.exec(h.url),n=l&&(l[1]&&l[1]!==location.protocol||l[2]!==location.host);if(h.data)h.method="POST";if(h.url){l=null;if(h.xhr)l=h.xhr(h);l||(l=new XMLHttpRequest);l.open(h.method,h.url,h.async);h.data&&l.setRequestHeader("Content-Type",
h.contentType);n||l.setRequestHeader("X-Requested-With","XMLHttpRequest");l.onreadystatechange=function(){if(this.readyState===4){var b=null,k=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(k)if(h.handleResponse)h.handleResponse(this);else{var o=h,s=this.getResponseHeader(d.CONTENT_TYPE),r,p=false;for(r in t)if(s&&s.indexOf(t[r])>=0){p=true;break}s=!p;for(p=0;p<m.length;p++)s=s||m[p]==r;if(s)b:{s=r;for(var u in q)for(p=
0;p<q[u].length;p++)if(RegExp(q[u][p]+"$","i").test(o.url)){r=u;break b}r=s?s:"DEFAULT"}try{b=g[r](this,o)}catch(v){GRUNT.Log.warn("error applying processor '"+r+"' to response type, falling back to default");b=g.DEFAULT(this,o)}}else h.error&&h.error(this)}catch(w){GRUNT.Log.exception(w,"PROCESSING AJAX RESPONSE")}k&&b&&h.success&&h.success.call(this,b)}};l.send(h.method=="POST"?f.param(h.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(e){GRUNT.Log.exception(e)}},
param:function(h){var l=[],n=function(b,k){k=GRUNT.isFunction(k)?k():k;l[l.length]=encodeURIComponent(b)+"="+encodeURIComponent(k)};if(GRUNT.isArray(h))for(var e=0;e<h.length;e++)n(h[e].name,h[e].value);else for(e in h)n(e,h[e]);return l.join("&").replace(/%20/g,"+")}});return f}();
GRUNT.XPath=function(){function t(g){for(var d=null,f=0;f<q.length;f++)if(d=q[f](g))break;return d}var q=[],m=[null,function(g){return g.numberValue},function(g){return g.stringValue},function(g){return g.booleanValue},null,null,null,null,function(g){return g.singleNodeValue?g.singleNodeValue.textContent:null},function(g){return g.singleNodeValue?g.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var a={SearchResult:function(g){return{toString:function(){var d=
null;if(g){var f=null;if(g.resultType>=0&&g.resultType<m.length)f=m[g.resultType];if(f){GRUNT.Log.info("invoking match handler for result type: "+g.resultType);d=f(g)}}return d?d:""}}},first:function(g,d){var f=a.SearchResult,h;var l=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!l)l=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(d))h=d.evaluate(g,d,t,l,null);else{GRUNT.Log.warn("attempted xpath expression: "+g+" on a non-xml document");h=null}}catch(n){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
g+" on node: "+d);h=null}return new f(h)},registerResolver:function(g){q.push(g)}};return a}();GRUNT.Observable=function(){var t={},q=0,m={bind:function(a,g){t[a]||(t[a]=[]);q+=1;t[a].push({callback:g,callbackId:q});return q},trigger:function(a){var g=t[a];if(g)for(var d=g.length;d--;)g[d].callback.apply(m,Array.prototype.slice.call(arguments,1))},unbind:function(a,g){for(var d=t[a],f=0;d&&f<d.length;f++)if(d[f].callbackId===g){d.splice(f,1);break}}};return m};
GRUNT.WaterCooler=function(){var t={},q=[];return{addPipe:function(m){m("pipe.test",{});q.push(m)},listen:function(m,a){t[m]||(t[m]=[]);a&&t[m].push(a)},say:function(m,a){var g;for(g=q.length;g--;)q[g](m,a);if(t[m])for(g=t[m].length;g--;)t[m][g](a)},leave:function(){}}}();
TILE5=function(){var t={newCanvas:function(q,m){var a=document.createElement("canvas");typeof G_vmlCanvasManager!=="undefined"&&G_vmlCanvasManager.initElement(a);a.width=q?q:0;a.height=m?m:0;return a},Settings:function(){var q={};return{get:function(m){return q[m]},set:function(m,a){q[m]=a},extend:function(m){GRUNT.extend(q,m)}}}(),Clock:function(){var q=null;return{getTime:function(m){return m&&q?q:q=(new Date).getTime()}}}(),Vector:function(q,m){return{x:q?q:0,y:m?m:0}},V:function(){function q(m){if(!m||
m.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var a={edges:Array(m.length-1),accrued:Array(m.length-1),total:0},g=TILE5.V.diff,d=0;d<m.length-1;d++){var f=g(m[d],m[d+1]);a.edges[d]=Math.sqrt(f.x*f.x+f.y*f.y);a.accrued[d]=a.total+a.edges[d];a.total+=a.edges[d]}return a}return{create:function(m,a){return new t.Vector(m,a)},add:function(){for(var m=new t.Vector,a=arguments.length;a--;){m.x+=arguments[a].x;m.y+=arguments[a].y}return m},absSize:function(m){return Math.max(Math.abs(m.x),
Math.abs(m.y))},diff:function(m,a){return new t.Vector(m.x-a.x,m.y-a.y)},copy:function(m){return m?new t.Vector(m.x,m.y):null},invert:function(m){return new TILE5.Vector(-m.x,-m.y)},offset:function(m,a,g){return new TILE5.Vector(m.x+a,m.y+(g?g:a))},edges:q,distance:function(m){return q(m).total},theta:function(m,a,g){g=Math.asin((m.y-a.y)/g);return m.x>a.x?g:Math.PI-g},pointOnEdge:function(m,a,g,d){a=new TILE5.Vector(Math.cos(g)*d,Math.sin(g)*d);return new TILE5.Vector(m.x-a.x,m.y-a.y)},getRect:function(m){var a=
m.length;if(a>1)return new TILE5.Rect(Math.min(m[0].x,m[a-1].x),Math.min(m[0].y,m[a-1].y),Math.abs(m[0].x-m[a-1].x),Math.abs(m[0].y-m[a-1].y))},toString:function(m){return m.x+", "+m.y}}}(),Dimensions:function(q,m){return{width:q?q:0,height:m?m:0}},D:function(){return{getAspectRatio:function(q){return q.height!==0?q.width/q.height:1},getCenter:function(q){return new t.Vector(q.width/2,q.height/2)},getSize:function(q){return Math.sqrt(Math.pow(q.width,2)+Math.pow(q.height,2))}}}(),Rect:function(q,
m,a,g){return{origin:new t.Vector(q,m),dimensions:new t.Dimensions(a,g)}},R:function(){return{copy:function(q){return q?new t.Rect(q.origin.x,q.origin.y,q.dimensions.width,q.dimensions.height):null},getCenter:function(q){return new TILE5.Vector(q.origin.x+q.dimensions.width/2,q.origin.y+q.dimensions.height/2)}}}()};return t}();
TILE5.Device=function(){function t(){for(;e.length>0;){var k=e.shift();document.location=k}n=0}function q(k){for(var o=true,s=b.length;s--;)o=o&&k!=b[s];return o}function m(k,o){var s=[];for(var r in o)r&&s.push(r+"="+escape(o[r]));return"tile5://"+k+"/"+(s.length>0?"?"+s.join("&"):"")}function a(k,o){q(k)&&GRUNT.Log.info("would push url: "+m(k,o))}function g(k,o){if(q(k)){e.push(m(k,o));n||(n=setTimeout(t,100))}}function d(){f={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:null,requireFastDraw:false,bridgeNotify:a,targetFps:null},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true,bridgeNotify:g,targetFps:10},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:g},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:g},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,
supportsTouch:true,getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:g},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:g}};h=[f.froyo,f.android,f.ipod,f.iphone,f.ipad]}var f=null,h=[],l=null,n=0,e=[],b=["view.wake","tile.loaded"];return{getConfig:function(){f||d();if(!l){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var k=0;k<h.length;k++){var o=h[k];if(o.regex&&o.regex.test(navigator.userAgent)){l=
GRUNT.extend({},f.base,o);GRUNT.Log.info("PLATFORM DETECTED AS: "+l.name);break}}if(!l){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");l=f.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return l}}}();
TILE5.Resources=function(){var t="",q={},m=function(){function g(){var v=n[this.id];if(v&&v.image.complete&&v.image.width>0){v.loaded=true;v.hitCount=1;for(var w=k.length;w--;)if(k[w].image.src==this.src){k.splice(w,1);break}v.loadCallback&&v.loadCallback(this,false);o.push({url:this.src,created:v.requested});delete n[this.id];d()}}function d(){for(var v=TILE5.Device.getConfig().maxImageLoads;b.length>0&&(!v||k.length<v);){var w=b.shift();if(w.imageLoader){k.push(w);w.imageLoader(w,g)}}}function f(v){for(var w=
null,y=s.length;y--&&!w;)w=s[y](v);return w?w:function(A,C){A.image.onload=C;A.image.src=a.getPath(A.url);A.requested=(new Date).getTime()}}function h(){p=true;try{var v=Math.floor(o.length/2);if(v>0){o.sort(function(y,A){return y.created-A.created});for(var w=v;w--;)delete l[o[w].url];o.splice(0,v)}}finally{p=false}GRUNT.WaterCooler.say("imagecache.cleared")}var l={},n={},e=0,b=[],k=[],o=[],s=[],r=0,p=false,u={loadingImages:k,queuedImages:b,addInterceptor:function(v){s.push(v)},getCacheFullness:function(){return r},
getImage:function(v){var w=null;p||(w=l[v]);return w?w.image:null},loadImage:function(v,w){var y=l[v];if(y){y.hitCount++;y.image.complete&&w&&w(y.image,true)}else{y={url:v,image:new Image,loaded:false,imageLoader:f(v),created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:w};y.image.id="resourceLoaderImage"+e++;l[v]=y;n[y.image.id]=y;b.push(y);d()}return y},resetLoadingQueue:function(){k=[]}};setInterval(function(){for(var v=(new Date).getTime(),w=false,y=0,A=TILE5.Device.getConfig();y<
k.length;)if(v-k[y].requested>a.loadTimeout*1E3){k.splice(y,1);w=true}else y++;w&&d();if(A&&A.imageCacheMaxSize){r=o.length*a.avgImageSize/A.imageCacheMaxSize;r>=1&&h()}},1E3);return u}(),a={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(g,d){for(var f=(g?g.replace(/^.*\?/,""):"").split("&"),h=g?g.replace(/\?.*$/,"?"):"",l=0;l<f.length;l++){var n=f[l].split("=");if(!d||!d.test(n[0]))h+=f[l]+"&"}return h.replace(/\W/g,
"")},isValidCacheKey:function(g){GRUNT.Log.info("cache key = "+g);return false}}}(),addInterceptor:m.addInterceptor,getPath:function(g){return/^(file|https?|\/)/.test(g)?g:t+g},setBasePath:function(g){t=g},getImage:function(g){return m.getImage(g)},loadImage:function(g,d){m.loadImage(g,d)},resetImageLoadQueue:function(){m.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:m.loadingImages.length,queuedImageCount:m.queuedImages.length,imageCacheFullness:m.getCacheFullness()}},loadResource:function(g){g=
GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},g);var d=function(f){g.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){g.callback(f)})};g.cacheable&&q[g.filename]?d(q[g.filename]):GRUNT.XHR.ajax({url:a.getPath(g.filename),dataType:g.dataType,success:function(f){if(g.cacheable)q[g.filename]=f;d(f)},error:function(f,h,l){GRUNT.Log.error("error loading resource ["+g.filename+"], error = "+l)}})},loadSnippet:function(g,d){/\.\w+$/.test(g)||(g+=".html");a.loadResource({filename:"snippets/"+
g,callback:d,dataType:"html"})}};return a}();
TILE5.Touch=function(){function t(e,b){var k=e&&e.length>0?e[0]:null;if(k&&b&&b.length>0)return TILE5.V.diff(k,b[0]);return null}function q(e){e.preventDefault();e.stopPropagation()}function m(e){for(var b=Array(e.length),k=e.length;k--;)b[k]=new TILE5.Vector(e[k].pageX,e[k].pageY);return b}function a(e){return[new TILE5.Vector(e.pageX,e.pageY)]}var g={TAP:0,MOVE:1,PINCHZOOM:2},d=7,f=0,h=0,l={TouchHelper:function(e){function b(B){for(var G=[],O=e.element?-e.element.offsetLeft:0,P=e.element?-e.element.offsetTop:
0,V=B.length;V--;)G.push(TILE5.V.offset(B[V],O,P));return G}function k(){e.observable&&e.observable.trigger.apply(null,arguments)}function o(B){if(B.target&&B.target===e.element){y=w?m(B.touches):a(B);C=new TILE5.Vector;I=new TILE5.Vector;Q=true;u=false;w&&q(B);M.current=TILE5.Clock.getTime();if(B=y.length>0?y[0]:null){k("touchStart",B.x,B.y);if(M.current-M.last<K.THRESHOLD_DOUBLETAP)if((B=A?TILE5.V.diff(y[0],A[0]):null)&&Math.abs(B.x)<e.maxDistDoubleTap&&Math.abs(B.y)<e.maxDistDoubleTap)u=true;D=
g.TAP;A=[].concat(y)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function s(B){if(B.target&&B.target===e.element){w||(N=a(B)[0]);if(Q)try{w&&q(B);var G=w?m(B.touches):a(B);B=0;if(G.length>1){if(y.length===1)y=[].concat(G);B=TILE5.V.distance(y)-TILE5.V.distance(G)}if(D===g.TAP){var O=t(G,y);if(O&&(Math.abs(O.x)>=d||Math.abs(O.y)>=d))D=g.MOVE}if(D!==g.TAP)if(!B||Math.abs(B)<e.pinchZoomThreshold){if(C=t(G,A)){I.x-=C.x;I.y-=C.y;E.x-=C.x;E.y-=C.y}if(TILE5.V.absSize(E)>e.panEventThreshhold){k("move",
E.x,E.y);E=TILE5.V.create()}D=g.MOVE}else{k("pinchZoom",b(y),b(G));D=g.PINCHZOOM}A=[].concat(G)}catch(P){GRUNT.Log.exception(P)}}}function r(B){if(B.target&&B.target===e.element)try{w&&q(B);TILE5.Clock.getTime();M.last=M.current;if(D===g.TAP)v||(v=setTimeout(function(){v=0;var O=u?"doubleTap":"tap",P=y[0],V=null;if(e.element)V=TILE5.V.offset(P,-e.element.offsetLeft,-e.element.offsetTop);k(O,P,V)},K.THRESHOLD_DOUBLETAP+50));else if(D==g.MOVE)k("moveEnd",I.x,I.y);else D==g.PINCHZOOM&&k("pinchZoomEnd",
b(y),b(A))}catch(G){GRUNT.Log.exception(G)}Q=false}function p(B){B=new TILE5.Vector(B.wheelDeltaX,B.wheelDeltaY);var G=B.y!==0?Math.max(Math.abs(B.y/360),1):0;if(N&&G!==0){var O=TILE5.V.offset(N,-e.element.offsetLeft,-e.element.offsetTop);k("wheelZoom",O,B.y>0?G+0.5:0.5/G)}}e=GRUNT.extend({element:null,observable:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,
tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},e);var u=false,v=0,w=TILE5.Device.getConfig().supportsTouch,y=null,A=null,C=null,I=null,E=new TILE5.Vector,D=null,Q=false,R=[],N=null,M={current:0,last:0},J=TILE5.Device.getConfig(),K={supportsTouch:w,THRESHOLD_DOUBLETAP:300,addListeners:function(B){R.push(B)},decoupleListeners:function(B){for(var G=0;B&&G<R.length;G++)if(R[G].listenerId===B){R.splice(G,1);GRUNT.Log.info("successfully decoupled touch listener: "+B);break}},release:function(){J.eventTarget.removeEventListener(J.supportsTouch?
"touchstart":"mousedown",o,false);J.eventTarget.removeEventListener(J.supportsTouch?"touchmove":"mousemove",s,false);J.eventTarget.removeEventListener(J.supportsTouch?"touchend":"mouseup",r,false);J.supportsTouch||J.eventTarget.removeEventListener("mousewheel",p,false)}};J.eventTarget.addEventListener(J.supportsTouch?"touchstart":"mousedown",o,false);J.eventTarget.addEventListener(J.supportsTouch?"touchmove":"mousemove",s,false);J.eventTarget.addEventListener(J.supportsTouch?"touchend":"mouseup",
r,false);J.supportsTouch||J.eventTarget.addEventListener("mousewheel",p,false);return K}},n=[];return{captureTouch:function(e,b){try{if(!e)throw Error("Unable to capture touch of null element");if(!e.id)e.id="touchable_"+f++;var k=n[e.id];if(!k){k=l.TouchHelper(GRUNT.extend({element:e},b));n[e.id]=k;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+k.supportsTouch)}b.listenerId&&k.decoupleListeners(b.listenerId);b.listenerId=++h;k.addListeners(b)}catch(o){GRUNT.Log.exception(o)}},resetTouch:function(e){if(e&&
e.id&&n[e.id]){n[e.id].release();delete n[e.id]}}}}();if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(t){return this.each(function(){TILE5.Touch.captureTouch(this,t)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(t){t.preventDefault()})}}
TILE5.Dispatcher=function(){var t=[],q={execute:function(m){var a=q.findAction(m);GRUNT.Log.info("looking for action id: "+m+", found: "+a);if(a){var g=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+m,function(){a.execute(g)})}},findAction:function(m){for(var a=t.length;a--;)if(t[a].id==m)return t[a];return null},getRegisteredActions:function(){return[].concat(t)},getRegisteredActionIds:function(){for(var m=[],a=t.length;a--;)t[a].id&&m.push(t[a].id);return m},registerAction:function(m){m&&
m.id&&t.push(m)},Action:function(m){m=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},m);var a={id:m.id,execute:function(){m.execute&&m.execute.apply(this,arguments)},getParam:function(g){return m[g]?m[g]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",a.id,m.title,m.icon)}};m.autoRegister&&q.registerAction(a);return a},createAgent:function(m){m=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},m);var a=null,g={getName:function(){return m.name},
getParam:function(d){return m[d]},getId:function(){return GRUNT.toID(g.getName())},run:function(d,f){if(m.execute){var h=a=TILE5.Clock.getTime(true),l=m.translator?m.translator(d):d;m.execute.call(g,l,function(n,e){if(!m.trashOrphanedResults||h==a)f&&f(n,e,l)})}}};return g},runAgents:function(m,a,g){for(var d=0;d<m.length;d++)m[d].run(a,g)}};return q}();
TILE5.Animation=function(){function t(){if(a===0)a=setInterval(function(){var d;d=TILE5.Clock.getTime();if(!m){m=true;try{for(var f=0;f<q.length;)if(q[f].isComplete()){q[f].triggerComplete(false);q.splice(f,1);GRUNT.WaterCooler.say("animation.complete")}else{q[f].update(d);f++}}finally{m=false}}d=q.length;if(d===0){clearInterval(a);a=0}},20)}var q=[],m=false,a=0,g={DURATION:2E3,tweenValue:function(d,f,h,l,n){d=new g.Tween({startValue:d,endValue:f,tweenFn:h,complete:l,duration:n});q.push(d);return d},
tween:function(d,f,h,l,n,e){d=new g.Tween({target:d,property:f,endValue:h,tweenFn:l,duration:e,complete:n});q.push(d);return d},tweenVector:function(d,f,h,l,n,e){var b=[];if(d){var k=d.x==f,o=d.y==h;k||b.push(g.tween(d,"x",f,l,function(){(k=true)&&o&&n()},e));o||b.push(g.tween(d,"y",h,l,function(){o=true;k&&o&&n()},e))}return b},cancel:function(d){if(!m){m=true;try{for(var f=0;f<q.length;)if(!d||d(q[f])){GRUNT.Log.info("CANCELLING ANIMATION");q[f].triggerComplete(true);q.splice(f,1)}else f++}finally{m=
false}}},isTweening:function(){return q.length>0},Tween:function(d){d=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:g.DURATION,tweenFn:g.DEFAULT,complete:null,cancelOnInteract:false},d);var f=TILE5.Clock.getTime(),h=[],l=false,n=0,e=0,b={cancelOnInteract:d.cancelOnInteract,isComplete:function(){return l},triggerComplete:function(k){d.complete&&d.complete(k)},update:function(k){try{var o=d.tweenFn(k-f,n,e,d.duration);if(d.target)d.target[d.property]=o;for(var s=h.length;s--;)h[s](o,
void 0);if(l=f+d.duration<=k){if(d.target)d.target[d.property]=d.tweenFn(d.duration,n,e,d.duration);for(var r=h.length;r--;)h[r](o,true)}}catch(p){GRUNT.Log.exception(p)}},requestUpdates:function(k){h.push(k)}};n=d.target&&d.property&&d.target[d.property]?d.target[d.property]:d.startValue;if(typeof d.endValue!=="undefined")e=d.endValue-n;if(e==0)l=true;t();return b},Easing:function(){var d=1.70158;return{Linear:function(f,h,l,n){return l*f/n+h},Back:{In:function(f,h,l,n){return l*(f/=n)*f*((d+1)*
f-d)+h},Out:function(f,h,l,n){return l*((f=f/n-1)*f*((d+1)*f+d)+1)+h},InOut:function(f,h,l,n){return(f/=n/2)<1?l/2*f*f*(((d*=1.525)+1)*f-d)+h:l/2*((f-=2)*f*(((d*=1.525)+1)*f+d)+2)+h}},Bounce:{In:function(f,h,l,n){return l-g.Easing.Bounce.Out(n-f,0,l,n)+h},Out:function(f,h,l,n){return(f/=n)<1/2.75?l*7.5625*f*f+h:f<2/2.75?l*(7.5625*(f-=1.5/2.75)*f+0.75)+h:f<2.5/2.75?l*(7.5625*(f-=2.25/2.75)*f+0.9375)+h:l*(7.5625*(f-=2.625/2.75)*f+0.984375)+h},InOut:function(f,h,l,n){return f<n/2?g.Easing.Bounce.In(f*
2,0,l,n)/2+h:g.Easing.Bounce.Out(f*2-n,0,l,n)/2+l/2+h}},Cubic:{In:function(f,h,l,n){return l*(f/=n)*f*f+h},Out:function(f,h,l,n){return l*((f=f/n-1)*f*f+1)+h},InOut:function(f,h,l,n){if((f/=n/2)<1)return l/2*f*f*f+h;return l/2*((f-=2)*f*f+2)+h}},Elastic:{In:function(f,h,l,n,e,b){if(f==0)return h;if((f/=n)==1)return h+l;b||(b=n*0.3);if(!e||e<Math.abs(l)){e=l;l=b/4}else l=b/(2*Math.PI)*Math.asin(l/e);return-(e*Math.pow(2,10*(f-=1))*Math.sin((f*n-l)*2*Math.PI/b))+h},Out:function(f,h,l,n,e,b){var k;if(f==
0)return h;if((f/=n)==1)return h+l;b||(b=n*0.3);if(!e||e<Math.abs(l)){e=l;k=b/4}else k=b/(2*Math.PI)*Math.asin(l/e);return e*Math.pow(2,-10*f)*Math.sin((f*n-k)*2*Math.PI/b)+l+h},InOut:function(f,h,l,n,e,b){var k;if(f==0)return h;if((f/=n/2)==2)return h+l;b||(b=n*0.3*1.5);if(!e||e<Math.abs(l)){e=l;k=b/4}else k=b/(2*Math.PI)*Math.asin(l/e);if(f<1)return-0.5*e*Math.pow(2,10*(f-=1))*Math.sin((f*n-k)*2*Math.PI/b)+h;return e*Math.pow(2,-10*(f-=1))*Math.sin((f*n-k)*2*Math.PI/b)*0.5+l+h}},Quad:{In:function(f,
h,l,n){return l*(f/=n)*f+h},Out:function(f,h,l,n){return-l*(f/=n)*(f-2)+h},InOut:function(f,h,l,n){if((f/=n/2)<1)return l/2*f*f+h;return-l/2*(--f*(f-2)-1)+h}},Sine:{In:function(f,h,l,n){return-l*Math.cos(f/n*(Math.PI/2))+l+h},Out:function(f,h,l,n){return l*Math.sin(f/n*(Math.PI/2))+h},InOut:function(f,h,l,n){return-l/2*(Math.cos(Math.PI*f/n)-1)+h}}}}()};return GRUNT.extend(g,{DEFAULT:g.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var t={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},q=0,m={DisplayState:t,AnyDisplayState:255,ActiveDisplayStates:t.ACTIVE|t.ANIMATING,DefaultDisplayStates:t.ACTIVE|t.ANIMATING|t.PAN|t.PINCHZOOM,ViewLayer:function(a){a=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:m.DefaultDisplayStates},a);var g=null,d=a.id,f=GRUNT.extend({addToView:function(h){h.setLayer(d,f)},shouldDraw:function(h){var l=
g?g.fastDraw&&h!==t.ACTIVE:false;return(h&a.validStates)!==0&&(l?a.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:d})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:g?g.id:null})},getId:function(){return d},setId:function(h){d=h},getParent:function(){return g},setParent:function(h){g=h}},a);return f},AnimatedPathLayer:function(a){function g(e,b,k){e.fillStyle="#FFFFFF";e.strokeStyle="#222222";e.beginPath();
e.arc(k.x,k.y,4,0,Math.PI*2,false);e.stroke();e.fill()}a=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,validStates:m.ActiveDisplayStates|t.PAN|t.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},a);var d=TILE5.V.edges(a.path),f,h=null,l=0;TILE5.Animation.tweenValue(0,d.total,a.easing,function(){n.remove()},a.duration).requestUpdates(function(e,b){l=e;b&&n.remove()});var n=GRUNT.extend(new m.ViewLayer(a),{cycle:function(){for(var e=
0;e<d.accrued.length&&d.accrued[e]<l;)e++;h=null;if(e<a.path.length-1){var b=l-(e>0?d.accrued[e-1]:0),k=a.path[e],o=a.path[e+1];f=TILE5.V.theta(k,o,d.edges[e]);h=TILE5.V.pointOnEdge(k,o,f,b);if(a.autoCenter)(e=n.getParent())&&e.centerOn(h)}return h?1:0},draw:function(e,b){if(h)(a.drawIndicator?a.drawIndicator:g)(e,b,new TILE5.Vector(h.x-b.x,h.y-b.y),f)}});return n},FPSLayer:function(a){a=GRUNT.extend({zindex:1E3,scalePosition:false},a);var g=null,d=GRUNT.extend(new m.ViewLayer(a),{delays:[],draw:function(f,
h,l){f.font="bold 8pt Arial";f.textAlign="right";f.fillStyle="rgba(0, 0, 0, 0.8)";f.fillText((g?g:"?")+" fps",l.width-20,20)}});setInterval(function(){for(var f=0,h=d.delays.length,l=h;l--;)f+=d.delays[l];if(h!==0)g=Math.floor(1E3/(f/h))},1E3);return d},ResourceStatsLayer:function(a){a=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:t.ACTIVE|t.PAN},a);return GRUNT.extend(new m.ViewLayer(a),{fps:null,draw:function(g){var d=TILE5.Resources.getStats(),f=a.indicatorSize,h=10,
l;if(d.imageCacheFullness){g.strokeStyle="rgba(0, 0, 255, 1)";g.beginPath();g.arc(15,15,5,0,Math.PI*2*d.imageCacheFullness,false);g.stroke();h=30}if(d.imageLoadingCount>=0){g.fillStyle="rgba(0, 255, 0, 0.7)";for(l=d.imageLoadingCount;l--;)g.fillRect(h+l*(f+2),10,f,f)}if(d.queuedImageCount>=0){g.fillStyle="rgba(255, 0, 0, 0.7)";for(l=d.queuedImageCount;l--;)g.fillRect(h+l*(f+2),10+f+2,f,f)}}})},LoadingLayer:function(a){GRUNT.extend({},a)},View:function(a){function g(x,z){P=TILE5.V.getRect(x);V=TILE5.V.getRect(z);
var F=TILE5.D.getSize(P.dimensions),L=TILE5.D.getSize(V.dimensions);X=TILE5.R.getCenter(P);D=TILE5.R.getCenter(V);S=P&&F!==0?L/F:1}function d(){GRUNT.WaterCooler.say("view.scale",{id:H.id});O=false;H.trigger("scale",S,P?h():D);U=m.DisplayState.ACTIVE;S=1;b()}function f(x,z){z.setId(x);z.setParent(H);k.push(z);k.sort(function(F,L){var T=L.zindex-F.zindex;if(T===0)T=L.created-F.created;return T})}function h(){var x=TILE5.D.getCenter(A),z=TILE5.V.distance([D,x]),F=TILE5.V.theta(D,x,z);TILE5.V.distance([X,
D]);x=TILE5.V.pointOnEdge(D,x,F,z/S);return x=TILE5.V.add(x,TILE5.V.diff(X,D))}function l(){GRUNT.WaterCooler.say("view.idle",{id:H.id});Q=true;N=0}function n(x,z){var F=0,L=H.getDisplayState(),T=(new Date).getTime(),Y=(L&t.PINCHZOOM)!==0,W=0;if(p||Y){x.clearRect(0,0,o.width,o.height);p=false}if(Y){TILE5.D.getCenter(A);var ba=(Z?Z:1)/2,$=TILE5.V.diff(X,D);if(J=P?new TILE5.Vector(D.x+$.x,D.y+$.y):new TILE5.Vector(D.x-$.x*ba,D.y-$.y*ba))z=TILE5.V.offset(z,J.x,J.y)}x.save();try{if(y!==1)x.scale(y,y);
else if(Y){x.translate(D.x,D.y);x.scale(S,S)}for(W=k.length;W--;)if(k[W].shouldDraw(L)){var ca=k[W].draw(x,z,A,L,H);F+=ca?ca:0}}finally{x.restore()}GRUNT.Log.trace("draw complete",T);return F}function e(){var x=0,z=U===t.PINCHZOOM||U===t.PAN;K=(new Date).getTime();r.x=Math.floor(r.x);r.y=Math.floor(r.y);E&&u&&E.delays.push(K-u);if(z){TILE5.Animation.cancel(function(L){return L.cancelOnInteract});Q=false;if(N!==0){clearTimeout(N);N=0}}for(z=k.length;z--;){var F=k[z].cycle(K,r,U);x+=F?F:0}if(u+G<K){x+=
n(s,r);u=K}R=0;if(I+x>0)b();else if(!Q&&N===0)N=setTimeout(l,500);GRUNT.Log.trace("Completed draw cycle",K)}function b(){I++;if(!(w||R!==0)){I=0;R=setTimeout(e,0)}}a=GRUNT.extend({id:"view_"+q++,container:"",clearOnDraw:false,displayFPS:false,displayResourceStats:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,autoSize:false},a);var k=[],o=document.getElementById(a.container),s=null,r=new TILE5.Vector,p=
false,u=null,v=0,w=false,y=1,A=null,C=null,I=0,E=null,D=null,Q=false,R=0,N=0,M=0,J=null,K=0,B=TILE5.Device.getConfig().targetFps,G=0,O=false,P=null,V=null,S=1,Z=null,aa=null,X=null,U=m.DisplayState.ACTIVE;GRUNT.Log.info("Creating a new view instance, attached to container: "+a.container+", canvas = ",o);if(o){TILE5.Touch.resetTouch(o);if(a.autoSize){GRUNT.Log.info("autosizing view: window.height = "+window.innerHeight+", width = "+window.innerWidth);o.height=window.innerHeight-o.offsetTop;o.width=
window.innerWidth-o.offsetLeft}try{s=o.getContext("2d");s.globalCompositeOperation=a.initialDrawMode;s.clearRect(0,0,o.width,o.height)}catch(da){GRUNT.Log.exception(da);throw Error("Could not initialise canvas on specified view element");}}var H=GRUNT.extend({},a,new GRUNT.Observable,{id:a.id,deviceScaling:y,fastDraw:a.fastDraw||TILE5.Device.getConfig().requireFastDraw,animate:function(x,z,F,L,T){function Y(){T&&T();d();S=1;Z=null}O=true;X=TILE5.V.copy(z);D=TILE5.V.copy(F);P=null;if(L){aa=S;TILE5.Animation.tweenValue(0,
x-aa,L,Y,1E3).requestUpdates(function(W){Z=W/(x-aa);S=aa+W;U=m.DisplayState.PINCHZOOM;b();H.trigger("animate")})}else{S=x;Y()}},centerOn:function(x){H.setOffset(x.x-o.width/2,x.y-o.height/2)},getDimensions:function(){if(o)return new TILE5.Dimensions(o.width,o.height)},getZoomCenter:function(){return J},getLayer:function(x){for(var z=0;z<k.length;z++)if(k[z].getId()==x)return k[z];return null},setLayer:function(x,z){for(var F=0;F<k.length;F++)if(k[F].getId()===x){k.splice(F,1);break}z&&f(x,z);GRUNT.WaterCooler.say("layer.update",
{id:x});b()},eachLayer:function(x){for(var z=0;z<k.length;z++)x(k[z])},clearBackground:function(){p=true},freeze:function(){w=true},unfreeze:function(){w=false;b()},snapshot:function(){},getDisplayState:function(){return w?t.FROZEN:U},scale:function(x,z,F,L,T){L||(L=TILE5.D.getCenter(A));T||(T=TILE5.D.getCenter(A));H.animate(x,L,T,z,F);return H},removeLayer:function(x){a:{for(var z=k.length;z--;)if(k[z].getId()==x){x=z;break a}x=-1}if(x>=0&&x<k.length){GRUNT.WaterCooler.say("layer.removed",{layer:k[x]});
k.splice(x,1)}},getOffset:function(){return TILE5.V.copy(r)},setOffset:function(x,z){r.x=x;r.y=z},updateOffset:function(x,z,F){if(F){x=new TILE5.Vector(x,z);animating=true;F=TILE5.Animation.tweenVector(r,x.x,x.y,F,function(){animating=false;H.panEnd(0,0)});for(x=F.length;x--;){F[x].cancelOnInteract=true;F[x].requestUpdates(function(){a.onAnimate&&a.onAnimate(r.x,r.y)})}}else H.setOffset(x,z)},zoom:function(x,z){S=x;O=S!==1;X=TILE5.D.getCenter(H.getDimensions());D=TILE5.D.getCenter(H.getDimensions());
P=null;clearTimeout(M);if(O){v=TILE5.Clock.getTime(true);U=m.DisplayState.PINCHZOOM;b();if(z)M=setTimeout(d,parseInt(z,10))}}});A=H.getDimensions();C=TILE5.D.getCenter(A);if(B)G=Math.ceil(1E3/B);GRUNT.Log.info("redraw interval calaculated @ "+G);GRUNT.WaterCooler.listen("layer.remove",function(x){x.id&&H.removeLayer(x.id)});GRUNT.WaterCooler.listen("view.wake",function(x){if(!x.id||x.id===H.id)b()});y=TILE5.Device.getConfig().getScaling();if(a.displayFPS){E=new m.FPSLayer;H.setLayer("fps",E)}a.displayResourceStats&&
H.setLayer("resourceStats",new m.ResourceStatsLayer);TILE5.Touch.captureTouch(o,{observable:H});H.bind("move",function(x,z,F){H.updateOffset(r.x+x,r.y+z,F);v=TILE5.Clock.getTime(true);b();U=t.PAN});H.bind("moveEnd",function(){U=t.ACTIVE;setTimeout(b,50)});H.bind("pinchZoom",function(x,z){g(x,z);if(O=S!==1){v=TILE5.Clock.getTime(true);U=m.DisplayState.PINCHZOOM;b()}});H.bind("pinchZoomEnd",function(x,z){g(x,z);d();S=1});H.bind("wheelZoom",function(x,z){H.zoom(Math.min(Math.max(z,0.25),4),500)});b();
return H}};return m}();
TILE5.Tiling=function(){function t(){if(!m){m=TILE5.newCanvas(g.Config.TILESIZE,g.Config.TILESIZE);var d=m.getContext("2d");d.fillStyle="rgba(150, 150, 150, 0.025)";d.fillRect(0,0,m.width,m.height)}return m}function q(){function d(){var h=TILE5.newCanvas(32,32),l=h.getContext("2d");l.fillStyle="#BBBBBB";l.fillRect(0,0,32,32);l.fillStyle="#C3C3C3";l.fillRect(0,0,16,16);l.fillRect(16,16,16,16);return h}if(!a){a=TILE5.newCanvas(g.Config.TILESIZE,g.Config.TILESIZE);var f=a.getContext("2d");f.fillStyle=
f.createPattern(d(),"repeat");f.fillRect(0,0,a.width,a.height)}return a}TileStore=function(d){d=GRUNT.extend({tileSize:null,gridSize:25,center:new TILE5.Vector,onPopulate:null},d);if(!d.tileSize)throw Error("Cannot create TileStore with an empty tile size");var f=Array(Math.pow(d.gridSize,2)),h=TILE5.V.offset(d.center,-Math.ceil(d.gridSize>>1)),l=null,n=new TILE5.Vector,e=null,b={getGridSize:function(){return d.gridSize},getNormalizedPos:function(k,o){return TILE5.V.add(new TILE5.Vector(k,o),TILE5.V.invert(h),
n)},getTileShift:function(){return TILE5.V.copy(n)},getTile:function(k,o){return k>=0&&k<d.gridSize?f[o*d.gridSize+k]:null},setTile:function(k,o,s){f[o*d.gridSize+k]=s},populate:function(k,o){var s=GRUNT.Log.getTraceTicks(),r=0,p=d.gridSize,u=d.tileSize;new TILE5.Vector(p/2,p/2);if(k)for(var v=0;v<p;v++)for(var w=0;w<p;w++){if(!f[r]){var y=k(w,v,h,p);y.gridX=w*u-n.x;y.gridY=v*u-n.y;f[r]=y}r++}l=k;e=o;GRUNT.Log.trace("tile grid populated",s);d.onPopulate&&d.onPopulate()},getShiftDelta:function(k,o,
s,r){var p=Math.floor(d.gridSize*0.2),u=new TILE5.Vector;if(k<0||k+s>d.gridSize)u.x=k<0?-p:p;if(o<0||o+r>d.gridSize)u.y=o<0?-p:p;return u},shift:function(k,o){if(!(k.x===0&&k.y===0)){var s=GRUNT.Log.getTraceTicks();GRUNT.Log.info("need to shift tile store grid, "+k.x+" cols and "+k.y+" rows.");var r=Array(f.length);r.length=f.length;for(var p=0;p<d.gridSize;p++)for(var u=0;u<d.gridSize;u++)r[u*d.gridSize+p]=b.getTile(p+k.x,u+k.y);f=r;h=o?o(h,k):TILE5.V.add(h,k);n.x+=-k.x*d.tileSize;n.y+=-k.y*d.tileSize;
GRUNT.Log.trace("tile storage shifted",s);b.populate(l,e)}},setOrigin:function(k,o){if(tileOrigin)shiftOrigin(k,o);else h=TILE5.V.offset(new TILE5.Vector(k,o),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var k=f.length;k--;)if(f[k])f[k].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var k=f.length;k--;)if(f[k]){f[k].x=null;f[k].y=null}});return b};var m=null,a=null,g={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(d){return d=
GRUNT.extend({x:0,y:0,gridX:0,gridY:0,size:256},d)},ImageTile:function(d){d=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},d);return new g.Tile(d)},TileGrid:function(d){function f(C,I){if(y){var E,D=[],Q=new TILE5.Vector(Math.floor((C.x+p.x)*n),Math.floor((C.y+p.y)*n));tilesNeeded=false;for(var R=w;R--;)for(var N=v;N--;){E=h.getTile(N+Q.x,R+Q.y);var M=new TILE5.Vector(N-y.x,R-y.y);E||(r=h.getShiftDelta(Q.x,Q.y,v,w));D.push({tile:E,centerness:TILE5.V.absSize(M)})}D.sort(function(J,K){return K.centerness-
J.centerness});k||(k=Array(D.length));for(E=D.length;E--;){k[E]=D[E].tile;A.prepTile(k[E],I)}}}d=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},d);var h=new TileStore(GRUNT.extend({tileSize:d.tileSize,onPopulate:function(){e=true;A.wakeParent()}},d)),l=Math.round(d.tileSize/2),n=d.tileSize?1/d.tileSize:0,e=false,b=true,k=null,o=false,s=false;new TILE5.Vector;var r=new TILE5.Vector,p=new TILE5.Vector;TILE5.Device.getConfig();
var u=h.getGridSize()*d.tileSize,v,w,y,A=GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{gridDimensions:new TILE5.Dimensions(u,u),cycle:function(C,I,E){C=0;if(r.x+r.y!==0){h.shift(r,d.shiftOrigin);p=h.getTileShift();r=new TILE5.Vector;C++}E!==TILE5.Graphics.DisplayState.PINCHZOOM&&f(I,E);return C+e?1:0},deactivate:function(){b=false},prepTile:function(){},drawTile:function(){return false},draw:function(C,I,E,D,Q){if(b){var R=(new Date).getTime(),N=I.x;I=I.y;var M=true,J=o||D===TILE5.Graphics.DisplayState.PINCHZOOM||
TILE5.Animation.isTweening();if(!y){v=Math.ceil(E.width*n)+1;w=Math.ceil(E.height*n)+1;y=new TILE5.Vector(Math.floor((v-1)/2),Math.floor((w-1)/2))}if(k){if(d.drawGrid)C.strokeStyle="rgba(50, 50, 50, 0.3)";C.beginPath();for(E=k.length;E--;){var K=k[E];if(K){var B=K.gridX-N,G=K.gridY-I;M=((J?false:K.x===B&&K.y===G)?true:A.drawTile(C,K,B,G,D))&&M}else M=false;d.drawGrid&&C.rect(B,G,d.tileSize,d.tileSize)}C.stroke();GRUNT.Log.trace("drawn tiles",R);M&&!s&&Q.trigger("tileDrawComplete");s=M;o=e=false}}},
getTileVirtualXY:function(C,I,E){C=h.getNormalizedPos(C,I);C=new TILE5.Vector(C.x*d.tileSize,C.y*d.tileSize);if(E){C.x+=l;C.y+=l}return C},populate:function(C){h.populate(C,function(){})}});GRUNT.WaterCooler.listen("tile.loaded",function(){e=true;A.wakeParent()});GRUNT.WaterCooler.listen("grid.invalidate",function(){o=true});return A},ImageTileGrid:function(d){function f(){GRUNT.WaterCooler.say("tile.loaded")}d=GRUNT.extend({},d);var h=t(),l=q(),n=TILE5.Graphics.DisplayState.ACTIVE,e=TILE5.Graphics.DisplayState.PAN,
b=TILE5.Device.getConfig().requireFastDraw;return GRUNT.extend(new g.TileGrid(d),{drawTile:function(k,o,s,r,p){var u=TILE5.Resources.getImage(o.url),v=false;if(u&&u.complete&&u.width>0){k.drawImage(u,s,r);v=true;o.x=s;o.y=r}else p===e?k.drawImage(l,s,r):k.drawImage(h,s,r);return v},prepTile:function(k,o){if(k&&(!b||o===n))TILE5.Resources.getImage(k.url)||TILE5.Resources.loadImage(k.url,f)}})},Tiler:function(d){d=GRUNT.extend({container:"",drawCenter:false,datasources:{},tileLoadThreshold:"first"},
d);var f=new TILE5.Graphics.View(GRUNT.extend({},d,{pannable:true,scalable:true,scaleDamping:true}));GRUNT.extend(f,{getTileLayer:function(){return f.getLayer("grid0")},setTileLayer:function(h){f.setLayer("grid0",h);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(h){var l=f.getOffset();return new TILE5.Vector(h.x+l.x,h.y+l.y)},cleanup:function(){f.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");GRUNT.WaterCooler.say("view.wake",{id:f.id})}});
return f}};return g}();
TILE5.Geo=function(){function t(n,e){var b=null;for(var k in h)if(e){if(k==e&&h[k][n]){b=h[k];break}}else if(h[k][n]){b=h[k];break}return b}function q(n,e,b,k){var o=0;n=n.toUpperCase();for(var s in k){var r=e[s];if(r){var p=b[s];r=p?p(n,r):n.containsWord(r)?1:0;o+=r*k[s]}}return o}var m=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],a=Math.PI/180,g=180/Math.PI,d=null,f={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},h={},l={Engine:function(n){if(!n.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var e=GRUNT.extend({remove:function(){delete h[e.id]}},n);return h[e.id]=e},Radius:function(n,e){return{distance:parseInt(n,10),uom:e}},Position:function(n,e){return{lat:parseFloat(n?n:0),lon:parseFloat(e?e:0)}},BoundingBox:function(n,e){return{min:l.P.parse(n),max:l.P.parse(e)}},Address:function(n){return n=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},n)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var n={dist2rad:function(e){return e/6371},lat2pix:function(e,b){var k=parseFloat(e)*2*Math.PI/360;k=Math.sin(k);var o=0.08181919084262157*k;return Math.log((1+k)/(1-k)*Math.pow((1-o)/(1+o),0.08181919084262157))/2/b},lon2pix:function(e,b){return parseFloat(e)/180*Math.PI/b},pix2lon:function(e,b){return n.normalizeLon(e*b*180/Math.PI)},pix2lat:function(e,b){for(var k=Math.pow(Math.E,
-e*b),o=n.mercatorUnproject(k),s=n.findRadPhi(o,k),r=0;r<12&&Math.abs(o-s)>1.0E-7;){o=s;s=n.findRadPhi(o,k);r++}return s*180/Math.PI},mercatorUnproject:function(e){return Math.PI/2-2*Math.atan(e)},findRadPhi:function(e,b){var k=0.08181919084262157*Math.sin(e);return Math.PI/2-2*Math.atan(b*Math.pow((1-k)/(1+k),0.040909595421310785))},normalizeLon:function(e){for(;e<-180;)e+=360;for(;e>180;)e-=360;return e}};return n}(),GeoSearchResult:function(n){n=GRUNT.extend({id:null,caption:"",resultType:"",data:null,
pos:null,matchWeight:0},n);return GRUNT.extend(n,{toString:function(){return n.caption+(n.matchWeight?" ("+n.matchWeight+")":"")}})},GeoSearchAgent:function(n){return TILE5.Dispatcher.createAgent(n)},GeocodingAgent:function(n){n=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(e,b){try{if(!e.reverse&&!e.freeform)address=new l.Address(e);var k=l.getEngine("geocode");if(k)k.geocode({addresses:[e.freeform?e.freeform:address],complete:function(s,r){if(b){var p=r;if(e.freeform)p=
l.rankGeocodeResponses(e.freeform,p,l.getEngine("geocode"));b(p,n)}}})}catch(o){GRUNT.Log.exception(o)}}},n);return new l.GeoSearchAgent(n)},PointOfInterest:function(n){n=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},n);if(!n.pos&&n.lat&&n.lon)n.pos=new TILE5.Geo.Position(n.lat,n.lon);return GRUNT.extend({toString:function(){return n.id+": '"+n.title+"'"}},n)},POIStorage:function(n){function e(p){p=p?p:"default";o[p]||(o[p]=[]);return o[p]}function b(p){var u=
[];for(var v in o)for(var w=0;w<o[v].length;w++)if(!p||p(o[v][w]))u.push(o[v][w]);return u}function k(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:r.id,pois:r.getPOIs()})}n=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},n);var o={},s=true,r={id:GRUNT.generateObjectID(),getPOIs:function(){return b()},getOldPOIs:function(p,u){return b(function(v){return v.group==p&&v.retrieved<u})},getVisible:function(){return s},setVisible:function(p){if(p!=s){s=p;n.visibilityChange&&n.visibilityChange()}},
findById:function(p){var u=b(function(v){return v.id==p});return u.length>0?u[0]:null},findByBounds:function(p){return b(function(u){return TILE5.Geo.P.inBounds(u.pos,p)})},addPOIs:function(p,u){if(u)o={};for(var v=0;p&&v<p.length;v++){p[v].retrieved=TILE5.Clock.getTime(true);var w=p[v];e(w.group).push(w)}},removeGroup:function(p){if(o[p]){delete o[p];k()}},update:function(p){var u=[],v=0,w=p.length>0?p[0].group:"",y=TILE5.Clock.getTime(true);for(v=0;v<p.length;v++){var A;a:{if(A=p[v])for(var C=e(A.group),
I=0;I<C.length;I++)if(C[I].id==A.id){A=C[I];break a}A=null}if(A){A.retrieved=y;A.isNew=false}else u.push(p[v])}p=r.getOldPOIs(w,y);r.addPOIs(u);for(v=0;n.onPOIAdded&&v<u.length;v++)n.onPOIAdded(u[v]);for(v=0;v<p.length;v++){n.onPOIDeleted&&n.onPOIDeleted(p[v]);w=p[v];y=e(w.group);for(A=0;A<y.length;A++)if(y[A].id==w.id){y.splice(A,1);break}}u.length+p.length>0&&k()}};return r},MapProvider:function(){return{zoomLevel:0,checkZoomLevel:function(n){return n},getCopyright:function(){},getLogoUrl:function(){},
getMapTiles:function(){},getPositionForXY:function(){return null}}},P:function(){var n={calcDistance:function(e,b){if(n.empty(e)||n.empty(b))return 0;var k=(b.lat-e.lat).toRad()/2,o=(b.lon-e.lon).toRad()/2;k=Math.sin(k)*Math.sin(k)+Math.cos(e.lat.toRad())*Math.cos(b.lat.toRad())*Math.sin(o)*Math.sin(o);return 6371*2*Math.atan2(Math.sqrt(k),Math.sqrt(1-k))},copy:function(e){return e?new l.Position(e.lat,e.lon):null},empty:function(e){return!e||e.lat===0&&e.lon===0},equal:function(e,b){return e&&b&&
e.lat==b.lat&&e.lon==b.lon},almostEqual:function(e,b){return e&&b&&Math.floor(e.lat*1E3)===Math.floor(b.lat*1E3)&&Math.floor(e.lon*1E3)===Math.floor(b.lon*1E3)},inArray:function(e,b){for(var k=l.P.equal,o=b.length;o--;)if(k(e,b[o]))return true;return false},inBounds:function(e,b){var k=!(l.P.empty(e)||l.P.empty(b));return k=(k=k&&e.lat>=b.min.lat&&e.lat<=b.max.lat)&&e.lon>=b.min.lon&&e.lon<=b.max.lon},parse:function(e){if(e)if(typeof e.lat!=="undefined")return n.copy(e);else{if(e.split)for(var b=
[" ",","],k=0;k<b.length;k++){var o=e.split(b[k]);if(o.length===2)return new l.Position(o[0],o[1])}}else return new l.Position;return null},parseArray:function(e){var b=e.length,k=Array(b);for(b=b;b--;)k[b]=n.parse(e[b]);GRUNT.Log.info("parsed "+k.length+" positions");return k},fromMercatorPixels:function(e,b,k){return new l.Position(TILE5.Geo.Utilities.pix2lat(b,k),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(e,k)))},toMercatorPixels:function(e,b){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(e.lon,
b),TILE5.Geo.Utilities.lat2pix(e.lat,b))},generalize:function(e,b,k){var o=e.length,s=[],r=null;k||(k=250);k/=1E3;GRUNT.Log.info("generalizing positions, must include "+b.length+" positions");for(var p=o;p--;)if(p===0)s.unshift(e[p]);else{var u=!r||l.P.inArray(e[p],b)?k:l.P.calcDistance(r,e[p]);if(e[p]&&u>=k){s.unshift(e[p]);r=e[p]}}GRUNT.Log.info("generalized "+o+" positions into "+s.length+" positions");return s},toString:function(e){return e?e.lat+" "+e.lon:""}};return n}(),B:function(){var n=
-(Math.PI/2),e=Math.PI/2,b=-Math.PI*2,k=Math.PI*2,o={calcSize:function(s,r,p){var u=new TILE5.Vector(0,r.lat-s.lat);if(typeof p==="undefined")p=true;u.x=p&&s.lon>r.lon?360-s.lon+r.lon:r.lon-s.lon;return u},createBoundsFromCenter:function(s,r){var p=r/6371,u=s.lat*a,v=s.lon*a,w=u-p,y=u+p;if(w>n&&y<e){u=Math.asin(Math.sin(p)/Math.cos(u));p=v-u;if(p<b)p+=2*Math.PI;v=v+u;if(v>k)v-=2*Math.PI}else{w=Math.max(w,n);y=Math.min(y,e);p=b;v=k}return new l.BoundingBox(new l.Position(w*g,p*g),new l.Position(y*
g,v*g))},expand:function(s,r){return new l.BoundingBox(new l.Position(s.min.lat-r,s.min.lon-l.Utilities.normalizeLon(r)),new l.Position(s.max.lat+r,s.max.lon+l.Utilities.normalizeLon(r)))},forPositions:function(s,r){var p=null,u=TILE5.Clock.getTime();r||(r="auto");for(var v=s.length;v--;)if(p){var w=o.calcSize(p.min,s[v],false),y=o.calcSize(s[v],p.max,false);if(w.x<0)p.min.lon=s[v].lon;if(w.y<0)p.min.lat=s[v].lat;if(y.x<0)p.max.lon=s[v].lon;if(y.y<0)p.max.lat=s[v].lat}else p=new TILE5.Geo.BoundingBox(s[v],
s[v]);if(r){if(r=="auto"){v=o.calcSize(p.min,p.max);r=Math.max(v.x,v.y)*0.3}p=o.expand(p,r)}GRUNT.Log.trace("calculated bounds for "+s.length+" positions",u);return p},getCenter:function(s){var r=l.B.calcSize(s.min,s.max);return new TILE5.Geo.Position(s.min.lat+r.y/2,s.min.lon+r.x/2)},getGeoHash:function(s){var r=TILE5.Geo.GeoHash.encode(s.min.lat,s.min.lon);s=TILE5.Geo.GeoHash.encode(s.max.lat,s.max.lon);GRUNT.Log.info("min hash = "+r+", max hash = "+s)},getZoomLevel:function(s,r){var p=o.getCenter(s),
u=m[Math.min(Math.round(Math.abs(p.lat)*0.05),m.length)],v=o.calcSize(s.min,s.max);p=Math.ceil(Math.log(m[3]*r.height/v.y)/Math.log(2));u=Math.ceil(Math.log(u*r.width/v.x)/Math.log(2));return Math.min(isNaN(p)?1E3:p,isNaN(u)?1E3:u)},isEmpty:function(s){return!s||l.P.empty(s.min)||l.P.empty(s.max)},toString:function(s){return"min: "+l.P.toString(s.min)+", max: "+l.P.toString(s.max)}};return o}(),A:function(){var n=/^(\d+).*$/,e=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(b,k){n.lastIndex=-1;
if(n.test(b))for(var o=b.replace(n,"$1"),s=k.split(","),r=0;r<s.length;r++){e.lastIndex=-1;if(e.test(s[r])){var p=e.exec(s[r]);if(o>=parseInt(p[1],10)&&o<=parseInt(p[2],10))return true}else if(o==s[r])return true}return false},normalize:function(b){if(!b)return"";b=b.toUpperCase();if(!d){var k=[];for(var o in f)k.push(o);d=RegExp("(\\s)("+k.join("|")+")(\\s|$)","i")}d.lastIndex=-1;if(k=d.exec(b))b=b.replace(d,"$1"+f[k[2]]);return b},toString:function(b){return b.streetDetails+" "+b.location}}}(),
getEngine:function(n){for(var e=null,b=1;!e&&b<arguments.length;b++)e=t(n,arguments[b]);e=e?e:t(n);if(!e)throw Error("Unable to find GEO engine with "+n+" capability");return e},rankGeocodeResponses:function(n,e,b){var k=[],o=l.AddressCompareFns;if(b&&b.compareFns)o=GRUNT.extend({},o,b.compareFns);for(b=0;b<e.length;b++)k.push(new l.GeoSearchResult({caption:l.A.toString(e[b]),data:e[b],pos:e[b].pos,matchWeight:q(n,e[b],o,l.GeocodeFieldWeights)}));k.sort(function(s,r){return r.matchWeight-s.matchWeight});
return k}};return l}();
TILE5.Geo.Location=function(){function t(a){function g(b){try{var k=new TILE5.Geo.Position(b.coords.latitude,b.coords.longitude),o=GRUNT.isPlainObject(b.coords.accuracy)&&b.coords.accuracy.horizontal?b.coords.accuracy.horizontal:b.coords.accuracy;GRUNT.Log.info("position success, accuracy = "+o);if(a.successCallback&&(!l||o<n))a.successCallback(k,o,h,b);if(o>a.highAccuracyCutoff&&h<2){h=2;a.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");a.watch||
f()}l=b;n=o}catch(s){GRUNT.Log.exception(s)}}function d(b){if(b.code===b.PERMISSION_DENIED)a.errorCallback&&a.errorCallback(b);else if(b.code===b.POSITION_UNAVAILABLE)a.errorCallback&&a.errorCallback(b);else if(b.code===b.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(a.timeout===0&&a.autoPhasing){h=1;a.timeout=q;a.enableHighAccuracy=false;f()}}}function f(){navigator.geolocation.getCurrentPosition(g,d,GRUNT.extend({},a,{enableHighAccuracy:false}))}a=GRUNT.extend({autoPhasing:true,
maximumAge:3E5,timeout:0,highAccuracyCutoff:10,watch:false,enableHighAccuracy:true,successCallback:null,errorCallback:null},a);var h=0,l=null,n=1E6,e;if(a.watch){navigator.geolocation.watchPosition(g,d,a);e=void 0}else e=f();return e}var q=3E3,m={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)m.get=t;return m}();
TILE5.Geo.GeoHash=function(){function t(q,m,a){if(m&a)q[0]=(q[0]+q[1])/2;else q[1]=(q[0]+q[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(q){var m=1,a=[],g=[];a[0]=-90;a[1]=90;g[0]=-180;g[1]=180;lat_err=90;lon_err=180;for(i=0;i<q.length;i++){c=q[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(m){lon_err/=2;t(g,cd,mask)}else{lat_err/=2;t(a,cd,mask)}m=!m}}a[2]=(a[0]+
a[1])/2;g[2]=(g[0]+g[1])/2;return{latitude:a,longitude:g}},encode:function(q,m,a){var g=1,d=[],f=[],h=0,l=0;a=a?a:12;geohash="";d[0]=-90;d[1]=90;f[0]=-180;for(f[1]=180;geohash.length<a;){if(g){mid=(f[0]+f[1])/2;if(m>mid){l|=BITS[h];f[0]=mid}else f[1]=mid}else{mid=(d[0]+d[1])/2;if(q>mid){l|=BITS[h];d[0]=mid}else d[1]=mid}g=!g;if(h<4)h++;else{geohash+=BASE32[l];l=h=0}}return geohash}}}();
TILE5.Geo.Search=function(){return{bestResults:function(t,q){q||(q=20);for(var m=t.length>0?t[0]:null,a=[],g=0;g<t.length;g++)if(m.matchWeight-t[g].matchWeight<=q)a.push(t[g]);else break;return a}}}();
TILE5.Geo.Routing=function(){var t={calculate:function(q){q=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},q);GRUNT.Log.info("attempting to calculate route");var m=TILE5.Geo.getEngine("route");m&&m.route(q,function(a){if(q.generalize)a.geometry=TILE5.Geo.P.generalize(a.geometry,a.getInstructionPositions());if(q.map){t.createMapOverlay(q.map,a);if(q.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+a.boundingBox);q.map.gotoBounds(a.boundingBox)}}q.success&&
q.success(a)})},createMapOverlay:function(q,m){var a=q.getDimensions();a=new TILE5.Geo.UI.RouteOverlay({data:m,width:a.width,height:a.height});q.setLayer("route",a)},parseTurnType:function(q){for(var m=t.TurnType.Unknown,a=TILE5.Geo.Routing.TurnTypeRules,g=0;g<a.length;g++){a[g].regex.lastIndex=-1;var d=a[g].regex.exec(q);if(d){m=a[g].customCheck?a[g].customCheck(q,d):a[g].turnType;break}}return m},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",
TurnLeft:"turn-left",TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(q){q=GRUNT.extend({position:null,description:"",turnType:null},q);if(!q.turnType)q.turnType=t.parseTurnType(q.description);return q},RouteData:function(q){q=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},q);if(!q.boundingBox)q.boundingBox=TILE5.Geo.B.forPositions(q.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var m=[],a=0;a<q.instructions.length;a++)q.instructions[a].position&&m.push(q.instructions[a].position);return m}},q)}};return t}();
TILE5.Geo.Routing.TurnTypeRules=function(){var t=TILE5.Geo.Routing.TurnType,q=[];q.push({regex:/continue/i,turnType:t.Continue});q.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(m,a){return/bear/i.test(a[1])?t.TurnLeftSlight:t.TurnLeft}});q.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(m,a){return/bear/i.test(a[1])?t.TurnRightSlight:t.TurnRight}});q.push({regex:/enter\s(roundabout|rotaty)/i,turnType:t.EnterRoundabout});q.push({regex:/take.*?ramp/i,turnType:t.Ramp});
q.push({regex:/take.*?exit/i,turnType:t.RampExit});q.push({regex:/make(.*?)u\-turn/i,customCheck:function(m,a){return/right/i.test(a[1])?t.UTurnRight:t.UTurnLeft}});q.push({regex:/proceed/i,turnType:t.Start});q.push({regex:/arrive/i,turnType:t.Arrive});q.push({regex:/fell\sthrough/i,turnType:t.Merge});return q}();
TILE5.Geo.UI=function(){function t(a){a=GRUNT.extend({size:12,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},a);var g=null,d=function(){var f=TILE5.newCanvas(a.size*4,a.size*4),h=f.getContext("2d"),l=new TILE5.Vector(f.width/2,f.height/2),n=a.size,e=["#FFFFFF","#333333"],b=[3,1.5];h.lineCap="round";for(var k=0;k<e.length;k++){var o=n;h.lineWidth=b[k];h.strokeStyle=e[k];h.beginPath();h.moveTo(l.x,
l.y-o);h.lineTo(l.x,l.y+o);h.moveTo(l.x-o,l.y);h.lineTo(l.x+o,l.y);h.arc(l.x,l.y,n*0.6666,0,2*Math.PI,false);h.stroke()}return f}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(f,h,l){if(!g){g=TILE5.D.getCenter(l);g=new TILE5.Vector(Math.round(g.x-d.width/2),Math.round(g.y-d.height/2))}f.drawImage(d,g.x,g.y)}})}var q=0,m={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,radsPerPixel:0},a);var g=
TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),d=g.x-a.centerXY.x,f=g.y-a.centerXY.y,h=GRUNT.extend({},a.grid,{getBoundingBox:function(l,n,e,b){return new TILE5.Geo.BoundingBox(h.pixelsToPos(new TILE5.Vector(l,n+b)),h.pixelsToPos(new TILE5.Vector(l+e,n)))},getGridXYForPosition:function(l){l=TILE5.Geo.P.toMercatorPixels(l,a.radsPerPixel);return new TILE5.Vector(l.x-d,h.gridDimensions.height-(l.y-f))},getPixelDistance:function(l){l=TILE5.Geo.Utilities.dist2rad(l);return Math.floor(l/a.radsPerPixel)},
pixelsToPos:function(l){return TILE5.Geo.P.fromMercatorPixels(d+l.x,f+h.gridDimensions.height-l.y,a.radsPerPixel)}});return h},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var g=true,d=null,f=[],h=0,l=[],n=[],e=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(b,k,o,s){if(g)return null;var r="routeAnimation"+q++;n.push(r);
return new TILE5.Graphics.AnimatedPathLayer({id:r,path:f,zindex:a.zindex+1,easing:b?b:TILE5.Animation.Easing.Sine.InOut,duration:k?k:5E3,drawIndicator:o,autoCenter:s?s:false})},draw:function(b,k,o,s,r){o=0;s=a.data?a.data.geometry:null;if(g){g=false;d=null;f=[];h=0}if(s&&h<s.length){a:{r=r.getTileLayer();l=[];if(r){s=GRUNT.Log.getTraceTicks();var p,u,v,w=a.data?a.data.geometry:[],y=w.length,A=a.data?a.data.instructions:[],C=A.length,I=a.calculationsPerCycle,E=0;for(p=h;p<y;p++){u=r.getGridXYForPosition(w[p]);
if(v=!d||p===0||Math.abs(u.x-d.x)+Math.abs(u.y-d.y)>a.pixelGeneralization){f.push(u);d=u}E++;if(E>=I){h=p;break a}}h=y;GRUNT.Log.trace(y+" geometry points generalized to "+f.length+" coordinates",s);d=null;for(p=C;p--;)if(A[p].position){u=r.getGridXYForPosition(A[p].position);if(v=!d||p===0||Math.abs(u.x-d.x)+Math.abs(u.y-d.y)>a.pixelGeneralization){l.push(u);d=u}}}}o++}r=f.length;if(r>0&&(!o||a.partialDraw)){b.strokeStyle=a.strokeStyle;b.lineWidth=a.lineWidth;b.beginPath();b.moveTo(f[r-1].x-k.x,
f[r-1].y-k.y);for(r=r;r--;)b.lineTo(f[r].x-k.x,f[r].y-k.y);b.stroke();b.fillStyle=a.waypointFillStyle;for(r=l.length;r--;){b.beginPath();b.arc(l[r].x-k.x,l[r].y-k.y,2,0,Math.PI*2,false);b.stroke();b.fill()}}return o}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var b=n.length;b--;)GRUNT.WaterCooler.say("layer.remove",{id:n[b]});n=[];g=true;e.wakeParent()});return e},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:m.AnnotationTween,animationSpeed:null},a);var g=
false,d={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return g},draw:function(f,h,l,n){if(d.xy){if(d.isNew&&a.tweenIn){var e=d.xy.y;d.xy.y=h.y-20;g=true;TILE5.Animation.tween(d.xy,"y",e,a.tweenIn,function(){d.xy.y=e;g=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(f,h,new TILE5.Vector(d.xy.x-h.x,d.xy.y-h.y),l,n);else{f.beginPath();f.arc(d.xy.x-h.x,d.xy.y-h.y,4,0,Math.PI*2,false);f.fill()}d.isNew=false}}};return d},ImageAnnotation:function(a){a=GRUNT.extend({imageUrl:null,
animatingImageUrl:null,imageAnchor:null},a);var g=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;a.draw=function(f,h,l,n,e){if(a.animatingImageUrl&&d.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);n=a.animatingImageUrl}else n=a.imageUrl;if(h=TILE5.Resources.getImage(n)){if(h.complete&&h.width>0){g||(g=new TILE5.Vector(-h.width>>1,-h.height>>1));l=TILE5.V.offset(l,g.x,g.y);f.drawImage(h,l.x,l.y,h.width,h.height)}}else TILE5.Resources.loadImage(n,function(){e.wakeParent()})};var d=new m.Annotation(a);
return d},AnnotationsOverlay:function(a){function g(n){for(var e=a.map?a.map.getTileLayer():null,b=0;e&&b<n.length;b++)n[b].xy=e.getGridXYForPosition(n[b].pos)}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var d=[],f=false,h=[],l=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){return f?1:0},draw:function(n,e,b,k){f=false;n.fillStyle="rgba(255, 0, 0, 0.75)";n.globalCompositeOperation="source-over";for(b=d.length;b--;){d[b].draw(n,e,k,l);f=f||d[b].isAnimating()}for(b=
h.length;b--;){h[b].draw(n,e,k,l);f=f||h[b].isAnimating()}return f?1:0},add:function(n){h.push(n);g(h);l.wakeParent()},clear:function(n){h=[];g(h);if(n){d=[];g(d)}l.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(n){if(a.pois&&a.pois.id==n.srcID){n=n.pois;try{d=[];for(var e=0;e<n.length;e++)if(n[e].pos){var b;var k=n[e];if(k&&k.pos){var o=null;if(o=a.createAnnotationForPOI?a.createAnnotationForPOI(k):new m.Annotation({pos:k.pos})){o.isNew=k.isNew;k.isNew=false}b=o}else b=void 0;
b&&d.push(b)}g(d)}catch(s){GRUNT.Log.exception(s)}l.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){g(d);g(h);l.wakeParent()});return l},GeoLocationOverlay:function(a){function g(){var b=a.map?a.map.getTileLayer():null;f=null;if(l&&b)f=b.getGridXYForPosition(l);h=0;if(n&&b)h=b.getPixelDistance(n/1E3)}a=GRUNT.extend({fillStyle:"rgba(0, 221, 238, 0.1)",strokeStyle:"rgba(0, 102, 136, 0.3)",originFillStyle:"rgba(0, 102, 136, 0.7)",zindex:100,map:null,watch:true,onUpdate:null},a);var d=
0,f=null,h=0,l=null,n=0,e=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){},draw:function(b,k){if(f&&h){var o=f.x-k.x,s=f.y-k.y;b.fillStyle=a.fillStyle;b.lineWidth=1;b.strokeStyle=a.strokeStyle;b.beginPath();b.arc(o,s,h,0,Math.PI*2,false);b.fill();b.stroke();b.fillStyle=a.originFillStyle;b.beginPath();b.arc(o,s,3,0,Math.PI*2,false);b.fill();GRUNT.WaterCooler.say("grid.invalidate")}},getPosition:function(){return l},getAccuracy:function(){return n}});GRUNT.WaterCooler.listen("grid.updated",
function(){g();e.wakeParent()});(function(){d=TILE5.Geo.Location.get({watch:a.watch,successCallback:function(b,k){a.onUpdate&&a.onUpdate(b,k);l=TILE5.Geo.P.copy(b);n=k;g()},errorCallback:function(){GRUNT.Log.info("got position error")}})})();return e},Tiler:function(a){a=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,zoomLevel:0,boundsChange:null,tapPOI:null,tapHandler:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,onTilesLoaded:null,zoomAnimation:TILE5.Animation.Easing.Quad.Out},
a);var g=new TILE5.Vector,d=false,f=[],h=0,l=null,n=null,e=a.zoomLevel;if(!a.provider)a.provider=new TILE5.Geo.MapProvider;var b=GRUNT.extend({},new TILE5.Tiling.Tiler(a),{pois:a.pois,annotations:null,getBoundingBox:function(){var o=b.getTileLayer(),s=b.getOffset(),r=b.getDimensions();if(o)return o.getBoundingBox(s.x,s.y,r.width,r.height);return null},getCenterPosition:function(){return b.getXYPosition(TILE5.D.getCenter(b.gridDimensions))},getXYPosition:function(o){return b.getTileLayer().pixelsToPos(b.viewPixToGridPix(o))},
gotoBounds:function(o,s){var r=TILE5.Geo.B.getZoomLevel(o,b.getDimensions());b.gotoPosition(TILE5.Geo.B.getCenter(o),r,s)},gotoCurrentPosition:function(o){function s(p,u){var v=TILE5.Geo.B.createBoundsFromCenter(p,u/1E3);GRUNT.Log.info("detected position: "+TILE5.Geo.P.toString(p)+", accuracy = "+u);b.clearBackground();b.gotoBounds(v,o)}var r=b.getLayer("geolocation");if(r)s(r.getPosition(),r.getAccuracy());else{r=new m.GeoLocationOverlay({map:b,onUpdate:function(p,u){s(p,u)}});GRUNT.Log.info("created geolocation layer");
b.setLayer("geolocation",r)}},gotoPosition:function(o,s,r){var p=e,u=(new Date).getTime(),v=false,w=b.getBoundingBox();if(w)v=!TILE5.Geo.P.inBounds(o,w);e=s?s:e;if(!e)throw"Zoom level required to goto a position.";if(a.provider)e=a.provider.checkZoomLevel(e);if(v||!d||e!==p){TILE5.Resources.resetImageLoadQueue();(s=b.getTileLayer())&&s.deactivate();TILE5.Animation.cancel();d&&b.freeze();h=u;a.provider.zoomLevel=e;a.provider.getMapTiles(b,o,function(y){if(u===h){b.setTileLayer(y);n=y.getId();b.panToPosition(o,
function(){b.unfreeze();r&&r()})}else GRUNT.Log.info("request time mismatch - ignoring update")});d=true}else b.panToPosition(o,r)},panToPosition:function(o,s,r){var p=b.getTileLayer();if(p){o=p.getGridXYForPosition(o);p=b.getDimensions();o.x-=p.width/2;o.y-=p.height/2;if(l)l=null;b.updateOffset(o.x,o.y,r);GRUNT.WaterCooler.say("view.wake",{id:b.id});a.boundsChange&&a.boundsChange(b.getBoundingBox());s&&s(b)}},getZoomLevel:function(){return e},setZoomLevel:function(o){b.gotoPosition(b.getCenterPosition(),
o)},zoomIn:function(){b.scale(2,TILE5.Animation.Easing.Sine.Out)||b.setZoomLevel(e+1)},zoomOut:function(){b.scale(0.5,TILE5.Animation.Easing.Sine.Out)||b.setZoomLevel(e-1)},animateRoute:function(o,s,r,p){var u=b.getLayer("route");if(u)(o=u.getAnimation(o,s,r,p))&&o.addToView(b)}});b.bind("tap",function(o,s){var r=b.getTileLayer(),p=null;if(r){p=b.viewPixToGridPix(new TILE5.Vector(s.x,s.y));var u=r.pixelsToPos(p),v=r.pixelsToPos(TILE5.V.offset(p,-a.tapExtent,a.tapExtent)),w=r.pixelsToPos(TILE5.V.offset(p,
a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(r.pixelsToPos(p)));p=new TILE5.Geo.BoundingBox(v,w);f=b.pois.findByBounds(p);b.trigger("geotap",o,s,u,p);a.tapPOI&&a.tapPOI(f)}});b.bind("doubleTap",function(o,s){b.animate(2,TILE5.D.getCenter(b.getDimensions()),new TILE5.Vector(s.x,s.y),a.zoomAnimation)});b.bind("scale",function(o,s){var r=0;o=Math.sqrt(o);if(o<1)r=-(0.5/o);else if(o>1)r=o;b.gotoPosition(b.getXYPosition(s),e+Math.floor(r))});var k=new TILE5.Geo.UI.AnnotationsOverlay({pois:b.pois,
map:b,createAnnotationForPOI:a.createAnnotationForPOI});b.annotations=k;b.setLayer("annotations",k);a.crosshair&&b.setLayer("crosshair",new t);GRUNT.WaterCooler.listen("view.idle",function(o){if(o.id&&o.id==b.id)if(TILE5.V.absSize(TILE5.V.diff(g,b.getOffset()))>a.boundsChangeThreshold&&a.boundsChange){g=b.getOffset();a.boundsChange(b.getBoundingBox())}});return b}};return m}();
