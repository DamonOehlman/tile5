if(!this.JSON)this.JSON={};
(function(){function t(n){return n<10?"0"+n:n}function s(n){h.lastIndex=0;return h.test(n)?'"'+n.replace(h,function(k){var e=g[k];return typeof e==="string"?e:"\\u"+("0000"+k.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+n+'"'}function m(n,k){var e,f,o,p,q=b,r,u=k[n];if(u&&typeof u==="object"&&typeof u.toJSON==="function")u=u.toJSON(n);if(typeof l==="function")u=l.call(k,n,u);switch(typeof u){case "string":return s(u);case "number":return isFinite(u)?String(u):"null";case "boolean":case "null":return String(u);
case "object":if(!u)return"null";b+=d;r=[];if(Object.prototype.toString.apply(u)==="[object Array]"){p=u.length;for(e=0;e<p;e+=1)r[e]=m(e,u)||"null";o=r.length===0?"[]":b?"[\n"+b+r.join(",\n"+b)+"\n"+q+"]":"["+r.join(",")+"]";b=q;return o}if(l&&typeof l==="object"){p=l.length;for(e=0;e<p;e+=1){f=l[e];if(typeof f==="string")if(o=m(f,u))r.push(s(f)+(b?": ":":")+o)}}else for(f in u)if(Object.hasOwnProperty.call(u,f))if(o=m(f,u))r.push(s(f)+(b?": ":":")+o);o=r.length===0?"{}":b?"{\n"+b+r.join(",\n"+b)+
"\n"+q+"}":"{"+r.join(",")+"}";b=q;return o}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+t(this.getUTCMonth()+1)+"-"+t(this.getUTCDate())+"T"+t(this.getUTCHours())+":"+t(this.getUTCMinutes())+":"+t(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var a=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
h=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,b,d,g={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},l;if(typeof JSON.stringify!=="function")JSON.stringify=function(n,k,e){var f;d=b="";if(typeof e==="number")for(f=0;f<e;f+=1)d+=" ";else if(typeof e==="string")d=e;if((l=k)&&typeof k!=="function"&&(typeof k!=="object"||typeof k.length!=="number"))throw Error("JSON.stringify");return m("",
{"":n})};if(typeof JSON.parse!=="function")JSON.parse=function(n,k){function e(o,p){var q,r,u=o[p];if(u&&typeof u==="object")for(q in u)if(Object.hasOwnProperty.call(u,q)){r=e(u,q);if(r!==undefined)u[q]=r;else delete u[q]}return k.call(o,p,u)}var f;n=String(n);a.lastIndex=0;if(a.test(n))n=n.replace(a,function(o){return"\\u"+("0000"+o.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(n.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){f=eval("("+n+")");return typeof k==="function"?e({"":f},""):f}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(t){if(arguments.length<=1)return t;for(var s=arguments.length-2,m=0;m<=s;m++)t=t.replace(RegExp("\\{"+m+"\\}","gi"),arguments[m+1]);return t};
String.prototype.containsWord=function(t){var s="";if(t.toString)t=t.toString();for(var m=0;m<t.length;m++)s+=!/\w/.test(t[m])?"\\"+t[m]:t[m];return RegExp("(^|\\s|\\,)"+s+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var t=Object.prototype.hasOwnProperty,s=0,m={id:"GRUNT.core",extend:function(){var a=arguments[0]||{},h=1,b=arguments.length,d=false,g,l,n,k;if(typeof a==="boolean"){d=a;a=arguments[1]||{};h=2}if(typeof a!=="object"&&!m.isFunction(a))a={};if(b===h){a=this;--h}for(;h<b;h++)if((g=arguments[h])!=null)for(l in g){n=a[l];k=g[l];if(a!==k)if(d&&k&&(m.isPlainObject(k)||m.isArray(k))){n=n&&(m.isPlainObject(n)||m.isArray(n))?n:m.isArray(k)?[]:{};a[l]=m.extend(d,n,k)}else if(k!==undefined)a[l]=
k}return a},isFunction:function(a){return toString.call(a)==="[object Function]"},isArray:function(a){return toString.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||toString.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!t.call(a,"constructor")&&!t.call(a.constructor.prototype,"isPrototypeOf"))return false;var h;for(h in a);return h===undefined||t.call(a,h)},isEmptyObject:function(a){for(var h in a)return false;return true},isXmlDocument:function(a){return toString.call(a)===
"[object Document]"},contains:function(a,h){var b=a,d=arguments,g=1;if(h&&m.isArray(h)){d=h;g=0}for(g=g;g<d;g++)b=b&&typeof foo[d[g]]!=="undefined";return b},newModule:function(a){a=m.extend({id:null,requires:[],parent:null},a);if(a.parent)a=m.extend({},a.parent,a);return a},toID:function(a){return a.replace(/\s/g,"-")},generateObjectID:function(a){return(a?a:"obj")+s++}};return m}();
GRUNT.Log=function(){function t(b,d){var g,l=d&&d.length>0?d[0]:"";for(g=1;d&&g<d.length;g++)l+=" "+(m&&GRUNT.isPlainObject(d[g])?JSON.stringify(d[g]):d[g]);typeof console!=="undefined"&&console[b](l);for(g=0;g<s.length;g++)s[g].call(h,l,b)}var s=[],m=typeof JSON!=="undefined",a=window.console&&window.console.markTimeline,h={id:"GRUNT.log",getTraceTicks:function(){return a?(new Date).getTime():null},trace:function(b,d){if(a)console.markTimeline(b+(d?": "+(h.getTraceTicks()-d)+"ms":""))},debug:function(){t("debug",
arguments)},info:function(){t("info",arguments)},warn:function(){t("warn",arguments)},error:function(){t("error",arguments)},exception:function(b){h.error(arguments);for(var d in b)h.info("ERROR DETAIL: "+d+": "+b[d])},watch:function(b,d){try{d()}catch(g){h.exception(g,b)}},throwError:function(b){h.error(b);throw Error(b);},requestUpdates:function(b){s.push(b)}};return h}();
GRUNT.Data=function(){var t={determineObjectMapping:function(m){if(!m)return null;m=m.split("|");for(var a={},h=0;h<m.length;h++)a[m[h]]=h;return a},mapLineToObject:function(m,a){var h=m.split("|"),b={};for(var d in a){var g=a[d];b[d]=h.length>g?h[g]:null}return b},parse:function(m){var a=null,h=[];m=m.split("\n");for(var b=0;b<m.length;b++){var d=m[b];if(a)h.push(t.mapLineToObject(d,a));else a=t.determineObjectMapping(d)}return h}},s={supportedFormats:{JSON:{parse:function(m){return JSON.parse(m)}},
PDON:{parse:function(m){return t.parse(m)}}},parse:function(m){m=GRUNT.extend({data:"",format:"JSON"},m);if(!s.supportedFormats[m.format])throw Error("Unsupported data format: "+m.format+", cannot parse data in javascript object");try{return s.supportedFormats[m.format].parse(m.data)}catch(a){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+m.format,m.data);GRUNT.Log.exception(a)}return{}}};return s}();
GRUNT.Template=function(){var t=/\$\{(.*?)\}/ig;return{parse:function(s,m){for(var a=s,h=t.exec(a);h;){a=a.replace(h[0],GRUNT.XPath.first(h[1],m));t.lastIndex=0;h=t.exec(a)}return a}}}();
GRUNT.JSONP=function(){function t(h){var b=document.createElement("script"),d=false;b.src=h;b.async=true;b.onload=b.onreadystatechange=function(){if(!d&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){d=true;b.onload=b.onreadystatechange=null;b&&b.parentNode&&b.parentNode.removeChild(b)}};m||(m=document.getElementsByTagName("head")[0]);m.appendChild(b)}var s=0,m,a=this;return{get:function(h,b,d){h+=h.indexOf("?")>=0?"&":"?";var g="json"+ ++s;a[g]=function(l){b(l);a[g]=
null;try{delete a[g]}catch(n){}};t(h+(d?d:"callback")+"="+g);return g}}}();
GRUNT.XHR=function(){var t={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},s={JSON:["json"],PDON:["pdon.txt"]},m=["TEXT","STREAM"],a=/^(\w+:)?\/\/([^\/?#]+)/,h={XML:function(g){return g.responseXML},JSON:function(g){try{return JSON.parse(g.responseText)}catch(l){GRUNT.Log.error("Error parsing JSON data: ",g.responseText);GRUNT.Log.exception(l)}return""},PDON:function(g){return GRUNT.Data.parse({data:g.responseText,format:"PDON"})},DEFAULT:function(g){return g.responseText}},
b={CONTENT_TYPE:"Content-Type"},d=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(g){try{g=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},d.ajaxSettings,g);var l=a.exec(g.url),n=l&&(l[1]&&l[1]!==location.protocol||l[2]!==location.host);if(g.data)g.method="POST";if(g.url){l=null;if(g.xhr)l=g.xhr(g);l||(l=new XMLHttpRequest);l.open(g.method,g.url,g.async);g.data&&l.setRequestHeader("Content-Type",
g.contentType);n||l.setRequestHeader("X-Requested-With","XMLHttpRequest");l.onreadystatechange=function(){if(this.readyState===4){var e=null,f=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(f)if(g.handleResponse)g.handleResponse(this);else{var o=g,p=this.getResponseHeader(b.CONTENT_TYPE),q,r=false;for(q in t)if(p&&p.indexOf(t[q])>=0){r=true;break}p=!r;for(r=0;r<m.length;r++)p=p||m[r]==q;if(p)b:{p=q;for(var u in s)for(r=
0;r<s[u].length;r++)if(RegExp(s[u][r]+"$","i").test(o.url)){q=u;break b}q=p?p:"DEFAULT"}try{e=h[q](this,o)}catch(v){GRUNT.Log.warn("error applying processor '"+q+"' to response type, falling back to default");e=h.DEFAULT(this,o)}}else g.error&&g.error(this)}catch(w){GRUNT.Log.exception(w,"PROCESSING AJAX RESPONSE")}f&&e&&g.success&&g.success.call(this,e)}};l.send(g.method=="POST"?d.param(g.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(k){GRUNT.Log.exception(k)}},
param:function(g){var l=[],n=function(e,f){f=GRUNT.isFunction(f)?f():f;l[l.length]=encodeURIComponent(e)+"="+encodeURIComponent(f)};if(GRUNT.isArray(g))for(var k=0;k<g.length;k++)n(g[k].name,g[k].value);else for(k in g)n(k,g[k]);return l.join("&").replace(/%20/g,"+")}});return d}();
GRUNT.XPath=function(){function t(h){for(var b=null,d=0;d<s.length;d++)if(b=s[d](h))break;return b}var s=[],m=[null,function(h){return h.numberValue},function(h){return h.stringValue},function(h){return h.booleanValue},null,null,null,null,function(h){return h.singleNodeValue?h.singleNodeValue.textContent:null},function(h){return h.singleNodeValue?h.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var a={SearchResult:function(h){return{toString:function(){var b=
null;if(h){var d=null;if(h.resultType>=0&&h.resultType<m.length)d=m[h.resultType];if(d){GRUNT.Log.info("invoking match handler for result type: "+h.resultType);b=d(h)}}return b?b:""}}},first:function(h,b){var d=a.SearchResult,g;var l=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!l)l=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(b))g=b.evaluate(h,b,t,l,null);else{GRUNT.Log.warn("attempted xpath expression: "+h+" on a non-xml document");g=null}}catch(n){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
h+" on node: "+b);g=null}return new d(g)},registerResolver:function(h){s.push(h)}};return a}();GRUNT.Observable=function(){var t={},s=0,m={bind:function(a,h){t[a]||(t[a]=[]);s+=1;t[a].push({callback:h,callbackId:s});return s},trigger:function(a){var h=t[a];if(h)for(var b=h.length;b--;)h[b].callback.apply(m,Array.prototype.slice.call(arguments,1))},unbind:function(a,h){for(var b=t[a],d=0;b&&d<b.length;d++)if(b[d].callbackId===h){b.splice(d,1);break}}};return m};
GRUNT.WaterCooler=function(){var t={},s=[];return{addPipe:function(m){m("pipe.test",{});s.push(m)},listen:function(m,a){t[m]||(t[m]=[]);a&&t[m].push(a)},say:function(m,a){var h;for(h=s.length;h--;)s[h](m,a);if(t[m])for(h=t[m].length;h--;)t[m][h](a)},leave:function(){}}}();
TILE5=function(){var t={newCanvas:function(s,m){var a=document.createElement("canvas");typeof G_vmlCanvasManager!=="undefined"&&G_vmlCanvasManager.initElement(a);a.width=s?s:0;a.height=m?m:0;return a},Settings:function(){var s={};return{get:function(m){return s[m]},set:function(m,a){s[m]=a},extend:function(m){GRUNT.extend(s,m)}}}(),Clock:function(){var s=null;return{getTime:function(m){return m&&s?s:s=(new Date).getTime()}}}(),Vector:function(s,m){return{x:s?s:0,y:m?m:0}},V:function(){function s(m){if(!m||
m.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var a={edges:Array(m.length-1),accrued:Array(m.length-1),total:0},h=TILE5.V.diff,b=0;b<m.length-1;b++){var d=h(m[b],m[b+1]);a.edges[b]=Math.sqrt(d.x*d.x+d.y*d.y);a.accrued[b]=a.total+a.edges[b];a.total+=a.edges[b]}return a}return{create:function(m,a){return new t.Vector(m,a)},add:function(){for(var m=new t.Vector,a=arguments.length;a--;){m.x+=arguments[a].x;m.y+=arguments[a].y}return m},absSize:function(m){return Math.max(Math.abs(m.x),
Math.abs(m.y))},diff:function(m,a){return new t.Vector(m.x-a.x,m.y-a.y)},copy:function(m){return m?new t.Vector(m.x,m.y):null},invert:function(m){return new TILE5.Vector(-m.x,-m.y)},offset:function(m,a,h){return new TILE5.Vector(m.x+a,m.y+(h?h:a))},edges:s,distance:function(m){return s(m).total},theta:function(m,a,h){h=Math.asin((m.y-a.y)/h);return m.x>a.x?h:Math.PI-h},pointOnEdge:function(m,a,h,b){a=new TILE5.Vector(Math.cos(h)*b,Math.sin(h)*b);return new TILE5.Vector(m.x-a.x,m.y-a.y)},getRect:function(m){var a=
m.length;if(a>1)return new TILE5.Rect(Math.min(m[0].x,m[a-1].x),Math.min(m[0].y,m[a-1].y),Math.abs(m[0].x-m[a-1].x),Math.abs(m[0].y-m[a-1].y))},toString:function(m){return m.x+", "+m.y}}}(),Dimensions:function(s,m){return{width:s?s:0,height:m?m:0}},D:function(){return{getAspectRatio:function(s){return s.height!==0?s.width/s.height:1},getCenter:function(s){return new t.Vector(s.width/2,s.height/2)},getSize:function(s){return Math.sqrt(Math.pow(s.width,2)+Math.pow(s.height,2))}}}(),Rect:function(s,
m,a,h){return{origin:new t.Vector(s,m),dimensions:new t.Dimensions(a,h)}},R:function(){return{copy:function(s){return s?new t.Rect(s.origin.x,s.origin.y,s.dimensions.width,s.dimensions.height):null},getCenter:function(s){return new TILE5.Vector(s.origin.x+s.dimensions.width/2,s.origin.y+s.dimensions.height/2)}}}()};return t}();
TILE5.Device=function(){function t(){for(;k.length>0;){var f=k.shift();document.location=f}n=0}function s(f){for(var o=true,p=e.length;p--;)o=o&&f!=e[p];return o}function m(f,o){var p=[];for(var q in o)q&&p.push(q+"="+escape(o[q]));return"tile5://"+f+"/"+(p.length>0?"?"+p.join("&"):"")}function a(f,o){s(f)&&GRUNT.Log.info("would push url: "+m(f,o))}function h(f,o){if(s(f)){k.push(m(f,o));n||(n=setTimeout(t,100))}}function b(){d={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:null,requireFastDraw:false,bridgeNotify:a,targetFps:null},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true,bridgeNotify:h,targetFps:10},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:h},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:h},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,
supportsTouch:true,getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:h},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:h}};g=[d.froyo,d.android,d.ipod,d.iphone,d.ipad]}var d=null,g=[],l=null,n=0,k=[],e=["view.wake","tile.loaded"];return{getConfig:function(){d||b();if(!l){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var f=0;f<g.length;f++){var o=g[f];if(o.regex&&o.regex.test(navigator.userAgent)){l=
GRUNT.extend({},d.base,o);GRUNT.Log.info("PLATFORM DETECTED AS: "+l.name);break}}if(!l){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");l=d.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return l}}}();
TILE5.Resources=function(){var t="",s={},m=function(){function h(){var v=n[this.id];if(v&&v.image.complete&&v.image.width>0){v.loaded=true;v.hitCount=1;for(var w=f.length;w--;)if(f[w].image.src==this.src){f.splice(w,1);break}v.loadCallback&&v.loadCallback(this,false);o.push({url:this.src,created:v.requested});delete n[this.id];b()}}function b(){for(var v=TILE5.Device.getConfig().maxImageLoads;e.length>0&&(!v||f.length<v);){var w=e.shift();if(w.imageLoader){f.push(w);w.imageLoader(w,h)}}}function d(v){for(var w=
null,y=p.length;y--&&!w;)w=p[y](v);return w?w:function(C,B){C.image.onload=B;C.image.src=a.getPath(C.url);C.requested=(new Date).getTime()}}function g(){r=true;try{var v=Math.floor(o.length/2);if(v>0){o.sort(function(y,C){return y.created-C.created});for(var w=v;w--;)delete l[o[w].url];o.splice(0,v)}}finally{r=false}GRUNT.WaterCooler.say("imagecache.cleared")}var l={},n={},k=0,e=[],f=[],o=[],p=[],q=0,r=false,u={loadingImages:f,queuedImages:e,addInterceptor:function(v){p.push(v)},getCacheFullness:function(){return q},
getImage:function(v){var w=null;r||(w=l[v]);return w?w.image:null},loadImage:function(v,w){var y=l[v];if(y){y.hitCount++;y.image.complete&&w&&w(y.image,true)}else{y={url:v,image:new Image,loaded:false,imageLoader:d(v),created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:w};y.image.id="resourceLoaderImage"+k++;l[v]=y;n[y.image.id]=y;e.push(y);b()}return y},resetLoadingQueue:function(){f=[]}};setInterval(function(){for(var v=(new Date).getTime(),w=false,y=0,C=TILE5.Device.getConfig();y<
f.length;)if(v-f[y].requested>a.loadTimeout*1E3){f.splice(y,1);w=true}else y++;w&&b();if(C&&C.imageCacheMaxSize){q=o.length*a.avgImageSize/C.imageCacheMaxSize;q>=1&&g()}},1E3);return u}(),a={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(h,b){for(var d=(h?h.replace(/^.*\?/,""):"").split("&"),g=h?h.replace(/\?.*$/,"?"):"",l=0;l<d.length;l++){var n=d[l].split("=");if(!b||!b.test(n[0]))g+=d[l]+"&"}return g.replace(/\W/g,
"")},isValidCacheKey:function(h){GRUNT.Log.info("cache key = "+h);return false}}}(),addInterceptor:m.addInterceptor,getPath:function(h){return/^(file|https?|\/)/.test(h)?h:t+h},setBasePath:function(h){t=h},getImage:function(h){return m.getImage(h)},loadImage:function(h,b){m.loadImage(h,b)},resetImageLoadQueue:function(){m.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:m.loadingImages.length,queuedImageCount:m.queuedImages.length,imageCacheFullness:m.getCacheFullness()}},loadResource:function(h){h=
GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},h);var b=function(d){h.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){h.callback(d)})};h.cacheable&&s[h.filename]?b(s[h.filename]):GRUNT.XHR.ajax({url:a.getPath(h.filename),dataType:h.dataType,success:function(d){if(h.cacheable)s[h.filename]=d;b(d)},error:function(d,g,l){GRUNT.Log.error("error loading resource ["+h.filename+"], error = "+l)}})},loadSnippet:function(h,b){/\.\w+$/.test(h)||(h+=".html");a.loadResource({filename:"snippets/"+
h,callback:b,dataType:"html"})}};return a}();
TILE5.Touch=function(){function t(f,o){var p=f&&f.length>0?f[0]:null;if(p&&o&&o.length>0)return TILE5.V.diff(p,o[0]);return null}function s(f){f.preventDefault();f.stopPropagation()}function m(f){for(var o=Array(f.length),p=f.length;p--;)o[p]=new TILE5.Vector(f[p].pageX,f[p].pageY);return o}function a(f){return[new TILE5.Vector(f.pageX,f.pageY)]}var h=100,b=500,d={TAP:0,MOVE:1,PINCHZOOM:2},g=7,l=0,n=0,k={TouchHelper:function(f){function o(z,D,L,K){var P=Math.asin((z.y-D.y)/L);L=Math.min(Math.floor(L*
(1E3/K)),600);P=D.x>z.x?P:Math.PI-P;z=new TILE5.Vector(Math.cos(P)*-L,Math.sin(P)*L);q("moveInertia",z.x,z.y)}function p(z){for(var D=[],L=f.element?-f.element.offsetLeft:0,K=f.element?-f.element.offsetTop:0,P=z.length;P--;)D.push(TILE5.V.offset(z[P],L,K));return D}function q(){f.observable&&f.observable.trigger.apply(null,arguments)}function r(z){if(z.target&&z.target===f.element){F=B?m(z.touches):a(z);N=new TILE5.Vector;I=new TILE5.Vector;T=true;y=false;V=TILE5.Clock.getTime();B&&s(z);q("cancelInertia");
Q.current=V;if(z=F.length>0?F[0]:null){q("touchStart",z.x,z.y);if(Q.current-Q.last<aa.THRESHOLD_DOUBLETAP)if((z=G?TILE5.V.diff(F[0],G[0]):null)&&Math.abs(z.x)<f.maxDistDoubleTap&&Math.abs(z.y)<f.maxDistDoubleTap)y=true;M=d.TAP;G=[].concat(F)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function u(z){if(z.target&&z.target===f.element){U=(B?m(z.touches):a(z))[0];if(T)try{B&&s(z);var D=B?m(z.touches):a(z);z=0;if(D.length>1){if(F.length===1)F=[].concat(D);z=TILE5.V.distance(F)-
TILE5.V.distance(D)}if(M===d.TAP){var L=t(D,F);if(L&&(Math.abs(L.x)>=g||Math.abs(L.y)>=g))M=d.MOVE}if(M!==d.TAP)if(!z||Math.abs(z)<f.pinchZoomThreshold){if(N=t(D,G)){I.x-=N.x;I.y-=N.y;R.x-=N.x;R.y-=N.y}if(TILE5.V.absSize(R)>f.panEventThreshhold){q("move",R.x,R.y);R=TILE5.V.create()}M=d.MOVE}else{q("pinchZoom",p(F),p(D));M=d.PINCHZOOM}G=[].concat(D)}catch(K){GRUNT.Log.exception(K)}}}function v(z){if(z.target&&z.target===f.element){var D,L,K=(B?m(z.changedTouches):a(z))[0];try{B&&s(z);var P=TILE5.Clock.getTime();
Q.last=Q.current;if(M===d.TAP)C||(C=setTimeout(function(){C=0;var W=y?"doubleTap":"tap",ca=F[0],H=null;if(f.element)H=TILE5.V.offset(ca,-f.element.offsetLeft,-f.element.offsetTop);q(W,ca,H)},aa.THRESHOLD_DOUBLETAP+50));else if(M==d.MOVE){q("moveEnd",I.x,I.y);if(B){D=P-V;if(D<b){L=TILE5.V.distance([F[0],K]);L>f.inertiaTrigger&&o(F[0],K,L,D)}}else{U=K;var Y=setInterval(function(){D=(new Date).getTime()-P;L=TILE5.V.distance([K,U]);if(D<h&&L>f.inertiaTrigger){clearInterval(Y);o(K,U,L,D)}else D>h&&clearInterval(Y)},
5)}}else M==d.PINCHZOOM&&q("pinchZoomEnd",p(F),p(G))}catch(Z){GRUNT.Log.exception(Z)}}T=false}function w(z){z=new TILE5.Vector(z.wheelDeltaX,z.wheelDeltaY);var D=z.y!==0?Math.abs(z.y/120):0;if(U&&D!==0){var L=TILE5.V.offset(U,-f.element.offsetLeft,-f.element.offsetTop);q("wheelZoom",L,Math.pow(2,z.y>0?D:-D))}}f=GRUNT.extend({element:null,observable:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,
pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},f);var y=false,C=0,B=TILE5.Device.getConfig().supportsTouch,F=null,G=null,N=null,I=null,R=new TILE5.Vector,M=null,T=false,V=0,S=[],U=null,Q={current:0,last:0},O=TILE5.Device.getConfig(),aa={supportsTouch:B,THRESHOLD_DOUBLETAP:300,addListeners:function(z){S.push(z)},decoupleListeners:function(z){for(var D=0;z&&D<S.length;D++)if(S[D].listenerId===z){S.splice(D,1);GRUNT.Log.info("successfully decoupled touch listener: "+
z);break}},release:function(){O.eventTarget.removeEventListener(O.supportsTouch?"touchstart":"mousedown",r,false);O.eventTarget.removeEventListener(O.supportsTouch?"touchmove":"mousemove",u,false);O.eventTarget.removeEventListener(O.supportsTouch?"touchend":"mouseup",v,false);O.supportsTouch||O.eventTarget.removeEventListener("mousewheel",w,false)}};O.eventTarget.addEventListener(O.supportsTouch?"touchstart":"mousedown",r,false);O.eventTarget.addEventListener(O.supportsTouch?"touchmove":"mousemove",
u,false);O.eventTarget.addEventListener(O.supportsTouch?"touchend":"mouseup",v,false);O.supportsTouch||O.eventTarget.addEventListener("mousewheel",w,false);return aa}},e=[];return{captureTouch:function(f,o){try{if(!f)throw Error("Unable to capture touch of null element");if(!f.id)f.id="touchable_"+l++;var p=e[f.id];if(!p){p=k.TouchHelper(GRUNT.extend({element:f},o));e[f.id]=p;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+p.supportsTouch)}o.listenerId&&p.decoupleListeners(o.listenerId);
o.listenerId=++n;p.addListeners(o)}catch(q){GRUNT.Log.exception(q)}},resetTouch:function(f){if(f&&f.id&&e[f.id]){e[f.id].release();delete e[f.id]}}}}();if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(t){return this.each(function(){TILE5.Touch.captureTouch(this,t)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(t){t.preventDefault()})}}
TILE5.Dispatcher=function(){var t=[],s={execute:function(m){var a=s.findAction(m);GRUNT.Log.info("looking for action id: "+m+", found: "+a);if(a){var h=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+m,function(){a.execute(h)})}},findAction:function(m){for(var a=t.length;a--;)if(t[a].id==m)return t[a];return null},getRegisteredActions:function(){return[].concat(t)},getRegisteredActionIds:function(){for(var m=[],a=t.length;a--;)t[a].id&&m.push(t[a].id);return m},registerAction:function(m){m&&
m.id&&t.push(m)},Action:function(m){m=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},m);var a={id:m.id,execute:function(){m.execute&&m.execute.apply(this,arguments)},getParam:function(h){return m[h]?m[h]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",a.id,m.title,m.icon)}};m.autoRegister&&s.registerAction(a);return a},createAgent:function(m){m=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},m);var a=null,h={getName:function(){return m.name},
getParam:function(b){return m[b]},getId:function(){return GRUNT.toID(h.getName())},run:function(b,d){if(m.execute){var g=a=TILE5.Clock.getTime(true),l=m.translator?m.translator(b):b;m.execute.call(h,l,function(n,k){if(!m.trashOrphanedResults||g==a)d&&d(n,k,l)})}}};return h},runAgents:function(m,a,h){for(var b=0;b<m.length;b++)m[b].run(a,h)}};return s}();
TILE5.Animation=function(){function t(){if(a===0)a=setInterval(function(){var b;b=TILE5.Clock.getTime();if(!m){m=true;try{for(var d=0;d<s.length;)if(s[d].isComplete()){s[d].triggerComplete(false);s.splice(d,1);GRUNT.WaterCooler.say("animation.complete")}else{s[d].update(b);d++}}finally{m=false}}b=s.length;if(b===0){clearInterval(a);a=0}},20)}var s=[],m=false,a=0,h={DURATION:2E3,tweenValue:function(b,d,g,l,n){b=new h.Tween({startValue:b,endValue:d,tweenFn:g,complete:l,duration:n});s.push(b);return b},
tween:function(b,d,g,l,n,k){b=new h.Tween({target:b,property:d,endValue:g,tweenFn:l,duration:k,complete:n});s.push(b);return b},tweenVector:function(b,d,g,l,n,k){var e=[];if(b){var f=b.x==d,o=b.y==g;f||e.push(h.tween(b,"x",d,l,function(){(f=true)&&o&&n()},k));o||e.push(h.tween(b,"y",g,l,function(){o=true;f&&o&&n()},k))}return e},cancel:function(b){if(!m){m=true;try{for(var d=0;d<s.length;)if(!b||b(s[d])){s[d].triggerComplete(true);s.splice(d,1)}else d++}finally{m=false}}},isTweening:function(){return s.length>
0},Tween:function(b){b=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:h.DURATION,tweenFn:h.DEFAULT,complete:null,cancelOnInteract:false},b);var d=TILE5.Clock.getTime(),g=[],l=false,n=0,k=0,e={cancelOnInteract:b.cancelOnInteract,isComplete:function(){return l},triggerComplete:function(f){b.complete&&b.complete(f)},update:function(f){try{var o=b.tweenFn(f-d,n,k,b.duration);if(b.target)b.target[b.property]=o;for(var p=g.length;p--;)g[p](o,void 0);if(l=d+b.duration<=f){if(b.target)b.target[b.property]=
b.tweenFn(b.duration,n,k,b.duration);for(var q=g.length;q--;)g[q](o,true)}}catch(r){GRUNT.Log.exception(r)}},requestUpdates:function(f){g.push(f)}};n=b.target&&b.property&&b.target[b.property]?b.target[b.property]:b.startValue;if(typeof b.endValue!=="undefined")k=b.endValue-n;if(k==0)l=true;t();return e},Easing:function(){var b=1.70158;return{Linear:function(d,g,l,n){return l*d/n+g},Back:{In:function(d,g,l,n){return l*(d/=n)*d*((b+1)*d-b)+g},Out:function(d,g,l,n){return l*((d=d/n-1)*d*((b+1)*d+b)+
1)+g},InOut:function(d,g,l,n){return(d/=n/2)<1?l/2*d*d*(((b*=1.525)+1)*d-b)+g:l/2*((d-=2)*d*(((b*=1.525)+1)*d+b)+2)+g}},Bounce:{In:function(d,g,l,n){return l-h.Easing.Bounce.Out(n-d,0,l,n)+g},Out:function(d,g,l,n){return(d/=n)<1/2.75?l*7.5625*d*d+g:d<2/2.75?l*(7.5625*(d-=1.5/2.75)*d+0.75)+g:d<2.5/2.75?l*(7.5625*(d-=2.25/2.75)*d+0.9375)+g:l*(7.5625*(d-=2.625/2.75)*d+0.984375)+g},InOut:function(d,g,l,n){return d<n/2?h.Easing.Bounce.In(d*2,0,l,n)/2+g:h.Easing.Bounce.Out(d*2-n,0,l,n)/2+l/2+g}},Cubic:{In:function(d,
g,l,n){return l*(d/=n)*d*d+g},Out:function(d,g,l,n){return l*((d=d/n-1)*d*d+1)+g},InOut:function(d,g,l,n){if((d/=n/2)<1)return l/2*d*d*d+g;return l/2*((d-=2)*d*d+2)+g}},Elastic:{In:function(d,g,l,n,k,e){if(d==0)return g;if((d/=n)==1)return g+l;e||(e=n*0.3);if(!k||k<Math.abs(l)){k=l;l=e/4}else l=e/(2*Math.PI)*Math.asin(l/k);return-(k*Math.pow(2,10*(d-=1))*Math.sin((d*n-l)*2*Math.PI/e))+g},Out:function(d,g,l,n,k,e){var f;if(d==0)return g;if((d/=n)==1)return g+l;e||(e=n*0.3);if(!k||k<Math.abs(l)){k=
l;f=e/4}else f=e/(2*Math.PI)*Math.asin(l/k);return k*Math.pow(2,-10*d)*Math.sin((d*n-f)*2*Math.PI/e)+l+g},InOut:function(d,g,l,n,k,e){var f;if(d==0)return g;if((d/=n/2)==2)return g+l;e||(e=n*0.3*1.5);if(!k||k<Math.abs(l)){k=l;f=e/4}else f=e/(2*Math.PI)*Math.asin(l/k);if(d<1)return-0.5*k*Math.pow(2,10*(d-=1))*Math.sin((d*n-f)*2*Math.PI/e)+g;return k*Math.pow(2,-10*(d-=1))*Math.sin((d*n-f)*2*Math.PI/e)*0.5+l+g}},Quad:{In:function(d,g,l,n){return l*(d/=n)*d+g},Out:function(d,g,l,n){return-l*(d/=n)*(d-
2)+g},InOut:function(d,g,l,n){if((d/=n/2)<1)return l/2*d*d+g;return-l/2*(--d*(d-2)-1)+g}},Sine:{In:function(d,g,l,n){return-l*Math.cos(d/n*(Math.PI/2))+l+g},Out:function(d,g,l,n){return l*Math.sin(d/n*(Math.PI/2))+g},InOut:function(d,g,l,n){return-l/2*(Math.cos(Math.PI*d/n)-1)+g}}}}()};return GRUNT.extend(h,{DEFAULT:h.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var t={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},s=0,m={DisplayState:t,AnyDisplayState:255,ActiveDisplayStates:t.ACTIVE|t.ANIMATING,DefaultDisplayStates:t.ACTIVE|t.ANIMATING|t.PAN|t.PINCHZOOM,ViewLayer:function(a){a=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:m.DefaultDisplayStates},a);var h=null,b=a.id,d=GRUNT.extend({addToView:function(g){g.setLayer(b,d)},shouldDraw:function(g){var l=
h?h.fastDraw&&g!==t.ACTIVE:false;return(g&a.validStates)!==0&&(l?a.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:b})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:h?h.id:null})},getId:function(){return b},setId:function(g){b=g},getParent:function(){return h},setParent:function(g){h=g}},a);return d},AnimatedPathLayer:function(a){function h(k,e,f){k.fillStyle="#FFFFFF";k.strokeStyle="#222222";k.beginPath();
k.arc(f.x,f.y,4,0,Math.PI*2,false);k.stroke();k.fill()}a=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,validStates:m.ActiveDisplayStates|t.PAN|t.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},a);var b=TILE5.V.edges(a.path),d,g=null,l=0;TILE5.Animation.tweenValue(0,b.total,a.easing,function(){n.remove()},a.duration).requestUpdates(function(k,e){l=k;e&&n.remove()});var n=GRUNT.extend(new m.ViewLayer(a),{cycle:function(){for(var k=
0;k<b.accrued.length&&b.accrued[k]<l;)k++;g=null;if(k<a.path.length-1){var e=l-(k>0?b.accrued[k-1]:0),f=a.path[k],o=a.path[k+1];d=TILE5.V.theta(f,o,b.edges[k]);g=TILE5.V.pointOnEdge(f,o,d,e);if(a.autoCenter)(k=n.getParent())&&k.centerOn(g)}return g?1:0},draw:function(k,e){if(g)(a.drawIndicator?a.drawIndicator:h)(k,e,new TILE5.Vector(g.x-e.x,g.y-e.y),d)}});return n},FPSLayer:function(a){a=GRUNT.extend({zindex:1E3,scalePosition:false},a);var h=null,b=GRUNT.extend(new m.ViewLayer(a),{delays:[],draw:function(d,
g,l){d.font="bold 8pt Arial";d.textAlign="right";d.fillStyle="rgba(0, 0, 0, 0.8)";d.fillText((h?h:"?")+" fps",l.width-20,20)}});setInterval(function(){for(var d=0,g=b.delays.length,l=g;l--;)d+=b.delays[l];if(g!==0)h=Math.floor(1E3/(d/g))},1E3);return b},ResourceStatsLayer:function(a){a=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:t.ACTIVE|t.PAN},a);return GRUNT.extend(new m.ViewLayer(a),{fps:null,draw:function(h){var b=TILE5.Resources.getStats(),d=a.indicatorSize,g=10,
l;if(b.imageCacheFullness){h.strokeStyle="rgba(0, 0, 255, 1)";h.beginPath();h.arc(15,15,5,0,Math.PI*2*b.imageCacheFullness,false);h.stroke();g=30}if(b.imageLoadingCount>=0){h.fillStyle="rgba(0, 255, 0, 0.7)";for(l=b.imageLoadingCount;l--;)h.fillRect(g+l*(d+2),10,d,d)}if(b.queuedImageCount>=0){h.fillStyle="rgba(255, 0, 0, 0.7)";for(l=b.queuedImageCount;l--;)h.fillRect(g+l*(d+2),10+d+2,d,d)}}})},LoadingLayer:function(a){GRUNT.extend({},a)},View:function(a){function h(x,A,E,J){M=typeof E!=="undefined";
H.updateOffset(u.x+x,u.y+A,E,J);o();W=t.PAN}function b(){W=t.ACTIVE;M=false;setTimeout(o,50)}function d(x,A){D=TILE5.V.getRect(x);L=TILE5.V.getRect(A);var E=TILE5.D.getSize(D.dimensions),J=TILE5.D.getSize(L.dimensions);Z=TILE5.R.getCenter(D);I=TILE5.R.getCenter(L);K=D&&E!==0?J/E:1}function g(){GRUNT.WaterCooler.say("view.scale",{id:H.id});z=false;H.trigger("scale",K,D?n():I);W=m.DisplayState.ACTIVE;K=1;o()}function l(x,A){A.setId(x);A.setParent(H);p.push(A);p.sort(function(E,J){var X=J.zindex-E.zindex;
if(X===0)X=J.created-E.created;return X})}function n(){var x=TILE5.D.getCenter(B),A=TILE5.V.distance([I,x]),E=TILE5.V.theta(I,x,A),J=TILE5.V.diff(Z,I);x=TILE5.V.pointOnEdge(I,x,E,A/K);x.x+=J.x;x.y+=J.y;return x}function k(){GRUNT.WaterCooler.say("view.idle",{id:H.id});R=true;V=0}function e(x,A){var E=0,J=H.getDisplayState(),X=(new Date).getTime(),ba=(J&t.PINCHZOOM)!==0,$=0;if(v||ba){x.clearRect(0,0,q.width,q.height);v=false}if(ba){TILE5.D.getCenter(B);var ea=(P?P:1)/2,da=TILE5.V.diff(Z,I);if(U=D?
new TILE5.Vector(I.x+da.x,I.y+da.y):new TILE5.Vector(I.x-da.x*ea,I.y-da.y*ea))A=TILE5.V.offset(A,U.x,U.y)}x.save();try{if(C!==1)x.scale(C,C);else if(ba){x.translate(I.x,I.y);x.scale(K,K)}for($=p.length;$--;)if(p[$].shouldDraw(J)){var fa=p[$].draw(x,A,B,J,H);E+=fa?fa:0}}finally{x.restore()}GRUNT.Log.trace("draw complete",X);return E}function f(){var x=0,A=!M&&(W===t.PINCHZOOM||W===t.PAN);Q=(new Date).getTime();u.x=Math.floor(u.x);u.y=Math.floor(u.y);N&&w&&N.delays.push(Q-w);if(A){TILE5.Animation.cancel(function(J){return J.cancelOnInteract});
R=false;if(V!==0){clearTimeout(V);V=0}}for(A=p.length;A--;){var E=p[A].cycle(Q,u,W);x+=E?E:0}if(w+aa<Q){x+=e(r,u);w=Q}T=0;if(G+x>0)o();else if(!R&&V===0)V=setTimeout(k,500);GRUNT.Log.trace("Completed draw cycle",Q)}function o(){G++;if(!(y||T!==0)){G=0;T=setTimeout(f,0)}}a=GRUNT.extend({id:"view_"+s++,container:"",clearOnDraw:false,displayFPS:false,displayResourceStats:false,scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,
panAnimationEasing:TILE5.Animation.Easing.Sine.Out,panAnimationDuration:750,autoSize:false},a);var p=[],q=document.getElementById(a.container),r=null,u=new TILE5.Vector,v=false,w=null,y=false,C=1,B=null,F=null,G=0,N=null,I=null,R=false,M=false,T=0,V=0,S=0,U=null,Q=0,O=TILE5.Device.getConfig().targetFps,aa=0,z=false,D=null,L=null,K=1,P=null,Y=null,Z=null,W=m.DisplayState.ACTIVE;if(q){TILE5.Touch.resetTouch(q);if(a.autoSize){q.height=window.innerHeight-q.offsetTop;q.width=window.innerWidth-q.offsetLeft}try{r=
q.getContext("2d");r.globalCompositeOperation=a.initialDrawMode;r.clearRect(0,0,q.width,q.height)}catch(ca){GRUNT.Log.exception(ca);throw Error("Could not initialise canvas on specified view element");}}var H=GRUNT.extend({},a,new GRUNT.Observable,{id:a.id,deviceScaling:C,fastDraw:a.fastDraw||TILE5.Device.getConfig().requireFastDraw,animate:function(x,A,E,J,X){function ba(){X&&X();g();K=1;P=null}z=true;Z=TILE5.V.copy(A);I=TILE5.V.copy(E);D=null;if(J){Y=K;TILE5.Animation.tweenValue(0,x-Y,J,ba,1E3).requestUpdates(function($){P=
$/(x-Y);K=Y+$;W=m.DisplayState.PINCHZOOM;o();H.trigger("animate")})}else{K=x;ba()}},centerOn:function(x){H.setOffset(x.x-q.width/2,x.y-q.height/2)},getDimensions:function(){if(q)return new TILE5.Dimensions(q.width,q.height)},getZoomCenter:function(){return U},getLayer:function(x){for(var A=0;A<p.length;A++)if(p[A].getId()==x)return p[A];return null},setLayer:function(x,A){for(var E=0;E<p.length;E++)if(p[E].getId()===x){p.splice(E,1);break}A&&l(x,A);GRUNT.WaterCooler.say("layer.update",{id:x});o()},
eachLayer:function(x){for(var A=0;A<p.length;A++)x(p[A])},clearBackground:function(){v=true},freeze:function(){y=true},unfreeze:function(){y=false;o()},snapshot:function(){},getDisplayState:function(){return y?t.FROZEN:W},scale:function(x,A,E,J,X){J||(J=TILE5.D.getCenter(B));X||(X=TILE5.D.getCenter(B));H.animate(x,J,X,A,E);return H},removeLayer:function(x){a:{for(var A=p.length;A--;)if(p[A].getId()==x){x=A;break a}x=-1}if(x>=0&&x<p.length){GRUNT.WaterCooler.say("layer.removed",{layer:p[x]});p.splice(x,
1)}},getOffset:function(){return TILE5.V.copy(u)},setOffset:function(x,A){u.x=x;u.y=A},updateOffset:function(x,A,E,J){if(E){x=new TILE5.Vector(x,A);animating=true;E=TILE5.Animation.tweenVector(u,x.x,x.y,E,function(){animating=false;b(0,0)},J);for(J=E.length;J--;){E[J].cancelOnInteract=true;E[J].requestUpdates(function(){o();a.onAnimate&&a.onAnimate(u.x,u.y)})}}else H.setOffset(x,A)},zoom:function(x,A,E){M=false;K=A;z=K!==1;Z=TILE5.D.getCenter(H.getDimensions());I=K>1?TILE5.V.copy(x):TILE5.D.getCenter(H.getDimensions());
D=null;clearTimeout(S);if(z){W=m.DisplayState.PINCHZOOM;o();if(E)S=setTimeout(g,parseInt(E,10))}}});B=H.getDimensions();F=TILE5.D.getCenter(B);if(O)aa=Math.ceil(1E3/O);GRUNT.WaterCooler.listen("layer.remove",function(x){x.id&&H.removeLayer(x.id)});GRUNT.WaterCooler.listen("view.wake",function(x){if(!x.id||x.id===H.id)o()});C=TILE5.Device.getConfig().getScaling();if(a.displayFPS){N=new m.FPSLayer;H.setLayer("fps",N)}a.displayResourceStats&&H.setLayer("resourceStats",new m.ResourceStatsLayer);TILE5.Touch.captureTouch(q,
{observable:H});H.bind("move",h);H.bind("moveEnd",b);H.bind("pinchZoom",function(x,A){d(x,A);if(z=K!==1){W=m.DisplayState.PINCHZOOM;o()}});H.bind("pinchZoomEnd",function(x,A){d(x,A);g();K=1});H.bind("wheelZoom",function(x,A){H.zoom(x,Math.min(Math.pow(2,Math.round(Math.log(A))),8),500)});H.bind("moveInertia",function(x,A){h(x,A,a.panAnimationEasing,a.panAnimationDuration)});H.bind("cancelInertia",function(){M=false;o()});o();return H}};return m}();
TILE5.Tiling=function(){function t(){if(!m){m=TILE5.newCanvas(h.Config.TILESIZE,h.Config.TILESIZE);var b=m.getContext("2d");b.fillStyle="rgba(150, 150, 150, 0.025)";b.fillRect(0,0,m.width,m.height)}return m}function s(){function b(){var g=TILE5.newCanvas(32,32),l=g.getContext("2d");l.fillStyle="#BBBBBB";l.fillRect(0,0,32,32);l.fillStyle="#C3C3C3";l.fillRect(0,0,16,16);l.fillRect(16,16,16,16);return g}if(!a){a=TILE5.newCanvas(h.Config.TILESIZE,h.Config.TILESIZE);var d=a.getContext("2d");d.fillStyle=
d.createPattern(b(),"repeat");d.fillRect(0,0,a.width,a.height)}return a}TileStore=function(b){b=GRUNT.extend({tileSize:null,gridSize:25,center:new TILE5.Vector,onPopulate:null},b);if(!b.tileSize)throw Error("Cannot create TileStore with an empty tile size");var d=Array(Math.pow(b.gridSize,2)),g=TILE5.V.offset(b.center,-Math.ceil(b.gridSize>>1)),l=null,n=new TILE5.Vector,k=null,e={getGridSize:function(){return b.gridSize},getNormalizedPos:function(f,o){return TILE5.V.add(new TILE5.Vector(f,o),TILE5.V.invert(g),
n)},getTileShift:function(){return TILE5.V.copy(n)},getTile:function(f,o){return f>=0&&f<b.gridSize?d[o*b.gridSize+f]:null},setTile:function(f,o,p){d[o*b.gridSize+f]=p},populate:function(f,o){var p=GRUNT.Log.getTraceTicks(),q=0,r=b.gridSize,u=b.tileSize;new TILE5.Vector(r/2,r/2);if(f)for(var v=0;v<r;v++)for(var w=0;w<r;w++){if(!d[q]){var y=f(w,v,g,r);y.gridX=w*u-n.x;y.gridY=v*u-n.y;d[q]=y}q++}l=f;k=o;GRUNT.Log.trace("tile grid populated",p);b.onPopulate&&b.onPopulate()},getShiftDelta:function(f,o,
p,q){var r=Math.floor(b.gridSize*0.2),u=new TILE5.Vector;if(f<0||f+p>b.gridSize)u.x=f<0?-r:r;if(o<0||o+q>b.gridSize)u.y=o<0?-r:r;return u},shift:function(f,o){if(!(f.x===0&&f.y===0)){var p=GRUNT.Log.getTraceTicks();GRUNT.Log.info("need to shift tile store grid, "+f.x+" cols and "+f.y+" rows.");var q=Array(d.length);q.length=d.length;for(var r=0;r<b.gridSize;r++)for(var u=0;u<b.gridSize;u++)q[u*b.gridSize+r]=e.getTile(r+f.x,u+f.y);d=q;g=o?o(g,f):TILE5.V.add(g,f);n.x+=-f.x*b.tileSize;n.y+=-f.y*b.tileSize;
GRUNT.Log.trace("tile storage shifted",p);e.populate(l,k)}},setOrigin:function(f,o){if(tileOrigin)shiftOrigin(f,o);else g=TILE5.V.offset(new TILE5.Vector(f,o),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var f=d.length;f--;)if(d[f])d[f].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var f=d.length;f--;)if(d[f]){d[f].x=null;d[f].y=null}});return e};var m=null,a=null,h={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(b){return b=
GRUNT.extend({x:0,y:0,gridX:0,gridY:0,size:256},b)},ImageTile:function(b){b=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},b);return new h.Tile(b)},TileGrid:function(b){function d(B,F){if(y){var G,N=[],I=new TILE5.Vector(Math.floor((B.x+r.x)*n),Math.floor((B.y+r.y)*n));tilesNeeded=false;for(var R=w;R--;)for(var M=v;M--;){G=g.getTile(M+I.x,R+I.y);var T=new TILE5.Vector(M-y.x,R-y.y);G||(q=g.getShiftDelta(I.x,I.y,v,w));N.push({tile:G,centerness:TILE5.V.absSize(T)})}N.sort(function(V,S){return S.centerness-
V.centerness});f||(f=Array(N.length));for(G=N.length;G--;){f[G]=N[G].tile;C.prepTile(f[G],F)}}}b=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},b);var g=new TileStore(GRUNT.extend({tileSize:b.tileSize,onPopulate:function(){k=true;C.wakeParent()}},b)),l=Math.round(b.tileSize/2),n=b.tileSize?1/b.tileSize:0,k=false,e=true,f=null,o=false,p=false;new TILE5.Vector;var q=new TILE5.Vector,r=new TILE5.Vector;TILE5.Device.getConfig();
var u=g.getGridSize()*b.tileSize,v,w,y,C=GRUNT.extend(new TILE5.Graphics.ViewLayer(b),{gridDimensions:new TILE5.Dimensions(u,u),cycle:function(B,F,G){B=0;if(q.x+q.y!==0){g.shift(q,b.shiftOrigin);r=g.getTileShift();q=new TILE5.Vector;B++}G!==TILE5.Graphics.DisplayState.PINCHZOOM&&d(F,G);return B+k?1:0},deactivate:function(){e=false},prepTile:function(){},drawTile:function(){return false},draw:function(B,F,G,N,I){if(e){var R=(new Date).getTime(),M=F.x;F=F.y;var T=true,V=o||N===TILE5.Graphics.DisplayState.PINCHZOOM||
TILE5.Animation.isTweening();if(!y){v=Math.ceil(G.width*n)+1;w=Math.ceil(G.height*n)+1;y=new TILE5.Vector(Math.floor((v-1)/2),Math.floor((w-1)/2))}if(f){if(b.drawGrid)B.strokeStyle="rgba(50, 50, 50, 0.3)";B.beginPath();for(G=f.length;G--;){var S=f[G];if(S){var U=S.gridX-M,Q=S.gridY-F;T=((V?false:S.x===U&&S.y===Q)?true:C.drawTile(B,S,U,Q,N))&&T}else T=false;b.drawGrid&&B.rect(U,Q,b.tileSize,b.tileSize)}B.stroke();GRUNT.Log.trace("drawn tiles",R);T&&!p&&I.trigger("tileDrawComplete");p=T;o=k=false}}},
getTileVirtualXY:function(B,F,G){B=g.getNormalizedPos(B,F);B=new TILE5.Vector(B.x*b.tileSize,B.y*b.tileSize);if(G){B.x+=l;B.y+=l}return B},populate:function(B){g.populate(B,function(){})}});GRUNT.WaterCooler.listen("tile.loaded",function(){k=true;C.wakeParent()});GRUNT.WaterCooler.listen("grid.invalidate",function(){o=true});return C},ImageTileGrid:function(b){function d(){GRUNT.WaterCooler.say("tile.loaded")}b=GRUNT.extend({},b);var g=t(),l=s(),n=TILE5.Graphics.DisplayState.ACTIVE,k=TILE5.Graphics.DisplayState.PAN,
e=TILE5.Device.getConfig().requireFastDraw;return GRUNT.extend(new h.TileGrid(b),{drawTile:function(f,o,p,q,r){var u=TILE5.Resources.getImage(o.url),v=false;if(u&&u.complete&&u.width>0){f.drawImage(u,p,q);v=true;o.x=p;o.y=q}else r===k?f.drawImage(l,p,q):f.drawImage(g,p,q);return v},prepTile:function(f,o){if(f&&(!e||o===n))TILE5.Resources.getImage(f.url)||TILE5.Resources.loadImage(f.url,d)}})},Tiler:function(b){b=GRUNT.extend({container:"",drawCenter:false,datasources:{},tileLoadThreshold:"first"},
b);var d=new TILE5.Graphics.View(GRUNT.extend({},b,{pannable:true,scalable:true,scaleDamping:true}));GRUNT.extend(d,{getTileLayer:function(){return d.getLayer("grid0")},setTileLayer:function(g){d.setLayer("grid0",g);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(g){var l=d.getOffset();return new TILE5.Vector(g.x+l.x,g.y+l.y)},cleanup:function(){d.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");GRUNT.WaterCooler.say("view.wake",{id:d.id})}});
return d}};return h}();
TILE5.Geo=function(){function t(n,k){var e=null;for(var f in g)if(k){if(f==k&&g[f][n]){e=g[f];break}}else if(g[f][n]){e=g[f];break}return e}function s(n,k,e,f){var o=0;n=n.toUpperCase();for(var p in f){var q=k[p];if(q){var r=e[p];q=r?r(n,q):n.containsWord(q)?1:0;o+=q*f[p]}}return o}var m=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],a=Math.PI/180,h=180/Math.PI,b=null,d={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},g={},l={Engine:function(n){if(!n.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var k=GRUNT.extend({remove:function(){delete g[k.id]}},n);return g[k.id]=k},Radius:function(n,k){return{distance:parseInt(n,10),uom:k}},Position:function(n,k){return{lat:parseFloat(n?n:0),lon:parseFloat(k?k:0)}},BoundingBox:function(n,k){return{min:l.P.parse(n),max:l.P.parse(k)}},Address:function(n){return n=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},n)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var n={dist2rad:function(k){return k/6371},lat2pix:function(k,e){var f=parseFloat(k)*2*Math.PI/360;f=Math.sin(f);var o=0.08181919084262157*f;return Math.log((1+f)/(1-f)*Math.pow((1-o)/(1+o),0.08181919084262157))/2/e},lon2pix:function(k,e){return parseFloat(k)/180*Math.PI/e},pix2lon:function(k,e){return n.normalizeLon(k*e*180/Math.PI)},pix2lat:function(k,e){for(var f=Math.pow(Math.E,
-k*e),o=n.mercatorUnproject(f),p=n.findRadPhi(o,f),q=0;q<12&&Math.abs(o-p)>1.0E-7;){o=p;p=n.findRadPhi(o,f);q++}return p*180/Math.PI},mercatorUnproject:function(k){return Math.PI/2-2*Math.atan(k)},findRadPhi:function(k,e){var f=0.08181919084262157*Math.sin(k);return Math.PI/2-2*Math.atan(e*Math.pow((1-f)/(1+f),0.040909595421310785))},normalizeLon:function(k){for(;k<-180;)k+=360;for(;k>180;)k-=360;return k}};return n}(),GeoSearchResult:function(n){n=GRUNT.extend({id:null,caption:"",resultType:"",data:null,
pos:null,matchWeight:0},n);return GRUNT.extend(n,{toString:function(){return n.caption+(n.matchWeight?" ("+n.matchWeight+")":"")}})},GeoSearchAgent:function(n){return TILE5.Dispatcher.createAgent(n)},GeocodingAgent:function(n){n=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(k,e){try{if(!k.reverse&&!k.freeform)address=new l.Address(k);var f=l.getEngine("geocode");if(f)f.geocode({addresses:[k.freeform?k.freeform:address],complete:function(p,q){if(e){var r=q;if(k.freeform)r=
l.rankGeocodeResponses(k.freeform,r,l.getEngine("geocode"));e(r,n)}}})}catch(o){GRUNT.Log.exception(o)}}},n);return new l.GeoSearchAgent(n)},PointOfInterest:function(n){n=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},n);if(!n.pos&&n.lat&&n.lon)n.pos=new TILE5.Geo.Position(n.lat,n.lon);return GRUNT.extend({toString:function(){return n.id+": '"+n.title+"'"}},n)},POIStorage:function(n){function k(r){r=r?r:"default";o[r]||(o[r]=[]);return o[r]}function e(r){var u=
[];for(var v in o)for(var w=0;w<o[v].length;w++)if(!r||r(o[v][w]))u.push(o[v][w]);return u}function f(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:q.id,pois:q.getPOIs()})}n=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},n);var o={},p=true,q={id:GRUNT.generateObjectID(),getPOIs:function(){return e()},getOldPOIs:function(r,u){return e(function(v){return v.group==r&&v.retrieved<u})},getVisible:function(){return p},setVisible:function(r){if(r!=p){p=r;n.visibilityChange&&n.visibilityChange()}},
findById:function(r){var u=e(function(v){return v.id==r});return u.length>0?u[0]:null},findByBounds:function(r){return e(function(u){return TILE5.Geo.P.inBounds(u.pos,r)})},addPOIs:function(r,u){if(u)o={};for(var v=0;r&&v<r.length;v++){r[v].retrieved=TILE5.Clock.getTime(true);var w=r[v];k(w.group).push(w)}},removeGroup:function(r){if(o[r]){delete o[r];f()}},update:function(r){var u=[],v=0,w=r.length>0?r[0].group:"",y=TILE5.Clock.getTime(true);for(v=0;v<r.length;v++){var C;a:{if(C=r[v])for(var B=k(C.group),
F=0;F<B.length;F++)if(B[F].id==C.id){C=B[F];break a}C=null}if(C){C.retrieved=y;C.isNew=false}else u.push(r[v])}r=q.getOldPOIs(w,y);q.addPOIs(u);for(v=0;n.onPOIAdded&&v<u.length;v++)n.onPOIAdded(u[v]);for(v=0;v<r.length;v++){n.onPOIDeleted&&n.onPOIDeleted(r[v]);w=r[v];y=k(w.group);for(C=0;C<y.length;C++)if(y[C].id==w.id){y.splice(C,1);break}}u.length+r.length>0&&f()}};return q},MapProvider:function(){var n=1,k=20;return{zoomLevel:0,checkZoomLevel:function(e){return Math.min(Math.max(e,n),k)},getCopyright:function(){},
getLogoUrl:function(){},getMapTiles:function(){},getPositionForXY:function(){return null},getZoomRange:function(){return{min:n,max:k}},setZoomRange:function(e,f){n=e;k=f}}},P:function(){var n={calcDistance:function(k,e){if(n.empty(k)||n.empty(e))return 0;var f=(e.lat-k.lat).toRad()/2,o=(e.lon-k.lon).toRad()/2;f=Math.sin(f)*Math.sin(f)+Math.cos(k.lat.toRad())*Math.cos(e.lat.toRad())*Math.sin(o)*Math.sin(o);return 6371*2*Math.atan2(Math.sqrt(f),Math.sqrt(1-f))},copy:function(k){return k?new l.Position(k.lat,
k.lon):null},empty:function(k){return!k||k.lat===0&&k.lon===0},equal:function(k,e){return k&&e&&k.lat==e.lat&&k.lon==e.lon},almostEqual:function(k,e){return k&&e&&Math.floor(k.lat*1E3)===Math.floor(e.lat*1E3)&&Math.floor(k.lon*1E3)===Math.floor(e.lon*1E3)},inArray:function(k,e){for(var f=l.P.equal,o=e.length;o--;)if(f(k,e[o]))return true;return false},inBounds:function(k,e){var f=!(l.P.empty(k)||l.P.empty(e));return f=(f=f&&k.lat>=e.min.lat&&k.lat<=e.max.lat)&&k.lon>=e.min.lon&&k.lon<=e.max.lon},
parse:function(k){if(k)if(typeof k.lat!=="undefined")return n.copy(k);else{if(k.split)for(var e=[" ",","],f=0;f<e.length;f++){var o=k.split(e[f]);if(o.length===2)return new l.Position(o[0],o[1])}}else return new l.Position;return null},parseArray:function(k){var e=k.length,f=Array(e);for(e=e;e--;)f[e]=n.parse(k[e]);GRUNT.Log.info("parsed "+f.length+" positions");return f},fromMercatorPixels:function(k,e,f){return new l.Position(TILE5.Geo.Utilities.pix2lat(e,f),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(k,
f)))},toMercatorPixels:function(k,e){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(k.lon,e),TILE5.Geo.Utilities.lat2pix(k.lat,e))},generalize:function(k,e,f){var o=k.length,p=[],q=null;f||(f=250);f/=1E3;GRUNT.Log.info("generalizing positions, must include "+e.length+" positions");for(var r=o;r--;)if(r===0)p.unshift(k[r]);else{var u=!q||l.P.inArray(k[r],e)?f:l.P.calcDistance(q,k[r]);if(k[r]&&u>=f){p.unshift(k[r]);q=k[r]}}GRUNT.Log.info("generalized "+o+" positions into "+p.length+" positions");
return p},toString:function(k){return k?k.lat+" "+k.lon:""}};return n}(),B:function(){var n=-(Math.PI/2),k=Math.PI/2,e=-Math.PI*2,f=Math.PI*2,o={calcSize:function(p,q,r){var u=new TILE5.Vector(0,q.lat-p.lat);if(typeof r==="undefined")r=true;u.x=r&&p.lon>q.lon?360-p.lon+q.lon:q.lon-p.lon;return u},createBoundsFromCenter:function(p,q){var r=q/6371,u=p.lat*a,v=p.lon*a,w=u-r,y=u+r;if(w>n&&y<k){u=Math.asin(Math.sin(r)/Math.cos(u));r=v-u;if(r<e)r+=2*Math.PI;v=v+u;if(v>f)v-=2*Math.PI}else{w=Math.max(w,n);
y=Math.min(y,k);r=e;v=f}return new l.BoundingBox(new l.Position(w*h,r*h),new l.Position(y*h,v*h))},expand:function(p,q){return new l.BoundingBox(new l.Position(p.min.lat-q,p.min.lon-l.Utilities.normalizeLon(q)),new l.Position(p.max.lat+q,p.max.lon+l.Utilities.normalizeLon(q)))},forPositions:function(p,q){var r=null,u=TILE5.Clock.getTime();q||(q="auto");for(var v=p.length;v--;)if(r){var w=o.calcSize(r.min,p[v],false),y=o.calcSize(p[v],r.max,false);if(w.x<0)r.min.lon=p[v].lon;if(w.y<0)r.min.lat=p[v].lat;
if(y.x<0)r.max.lon=p[v].lon;if(y.y<0)r.max.lat=p[v].lat}else r=new TILE5.Geo.BoundingBox(p[v],p[v]);if(q){if(q=="auto"){v=o.calcSize(r.min,r.max);q=Math.max(v.x,v.y)*0.3}r=o.expand(r,q)}GRUNT.Log.trace("calculated bounds for "+p.length+" positions",u);return r},getCenter:function(p){var q=l.B.calcSize(p.min,p.max);return new TILE5.Geo.Position(p.min.lat+q.y/2,p.min.lon+q.x/2)},getGeoHash:function(p){var q=TILE5.Geo.GeoHash.encode(p.min.lat,p.min.lon);p=TILE5.Geo.GeoHash.encode(p.max.lat,p.max.lon);
GRUNT.Log.info("min hash = "+q+", max hash = "+p)},getZoomLevel:function(p,q){var r=o.getCenter(p),u=m[Math.min(Math.round(Math.abs(r.lat)*0.05),m.length)],v=o.calcSize(p.min,p.max);r=Math.ceil(Math.log(m[3]*q.height/v.y)/Math.log(2));u=Math.ceil(Math.log(u*q.width/v.x)/Math.log(2));return Math.min(isNaN(r)?1E3:r,isNaN(u)?1E3:u)},isEmpty:function(p){return!p||l.P.empty(p.min)||l.P.empty(p.max)},toString:function(p){return"min: "+l.P.toString(p.min)+", max: "+l.P.toString(p.max)}};return o}(),A:function(){var n=
/^(\d+).*$/,k=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(e,f){n.lastIndex=-1;if(n.test(e))for(var o=e.replace(n,"$1"),p=f.split(","),q=0;q<p.length;q++){k.lastIndex=-1;if(k.test(p[q])){var r=k.exec(p[q]);if(o>=parseInt(r[1],10)&&o<=parseInt(r[2],10))return true}else if(o==p[q])return true}return false},normalize:function(e){if(!e)return"";e=e.toUpperCase();if(!b){var f=[];for(var o in d)f.push(o);b=RegExp("(\\s)("+f.join("|")+")(\\s|$)","i")}b.lastIndex=-1;if(f=b.exec(e))e=e.replace(b,"$1"+
d[f[2]]);return e},toString:function(e){return e.streetDetails+" "+e.location}}}(),getEngine:function(n){for(var k=null,e=1;!k&&e<arguments.length;e++)k=t(n,arguments[e]);k=k?k:t(n);if(!k)throw Error("Unable to find GEO engine with "+n+" capability");return k},rankGeocodeResponses:function(n,k,e){var f=[],o=l.AddressCompareFns;if(e&&e.compareFns)o=GRUNT.extend({},o,e.compareFns);for(e=0;e<k.length;e++)f.push(new l.GeoSearchResult({caption:l.A.toString(k[e]),data:k[e],pos:k[e].pos,matchWeight:s(n,
k[e],o,l.GeocodeFieldWeights)}));f.sort(function(p,q){return q.matchWeight-p.matchWeight});return f}};return l}();
TILE5.Geo.Location=function(){function t(a){function h(e){try{var f=new TILE5.Geo.Position(e.coords.latitude,e.coords.longitude),o=GRUNT.isPlainObject(e.coords.accuracy)&&e.coords.accuracy.horizontal?e.coords.accuracy.horizontal:e.coords.accuracy;GRUNT.Log.info("position success, accuracy = "+o);if(a.successCallback&&(!l||o<n))a.successCallback(f,o,g,e);if(o>a.highAccuracyCutoff&&g<2){g=2;a.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");
a.watch||d()}l=e;n=o}catch(p){GRUNT.Log.exception(p)}}function b(e){if(e.code===e.PERMISSION_DENIED)a.errorCallback&&a.errorCallback(e);else if(e.code===e.POSITION_UNAVAILABLE)a.errorCallback&&a.errorCallback(e);else if(e.code===e.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(a.timeout===0&&a.autoPhasing){g=1;a.timeout=s;a.enableHighAccuracy=false;d()}}}function d(){navigator.geolocation.getCurrentPosition(h,b,GRUNT.extend({},a,{enableHighAccuracy:false}))}a=GRUNT.extend({autoPhasing:true,
maximumAge:500,timeout:0,highAccuracyCutoff:10,watch:false,enableHighAccuracy:true,successCallback:null,errorCallback:null},a);var g=0,l=null,n=1E6,k;if(a.watch){navigator.geolocation.watchPosition(h,b,a);k=void 0}else k=d();return k}var s=3E3,m={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)m.get=t;return m}();
TILE5.Geo.GeoHash=function(){function t(s,m,a){if(m&a)s[0]=(s[0]+s[1])/2;else s[1]=(s[0]+s[1])/2}BITS=[16,8,4,2,1];BASE32="0123456789bcdefghjkmnpqrstuvwxyz";NEIGHBORS={right:{even:"bc01fg45238967deuvhjyznpkmstqrwx"},left:{even:"238967debc01fg45kmstqrwxuvhjyznp"},top:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},bottom:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}};BORDERS={right:{even:"bcfguvyz"},left:{even:"0145hjnp"},top:{even:"prxz"},bottom:{even:"028b"}};NEIGHBORS.bottom.odd=NEIGHBORS.left.even;NEIGHBORS.top.odd=
NEIGHBORS.right.even;NEIGHBORS.left.odd=NEIGHBORS.bottom.even;NEIGHBORS.right.odd=NEIGHBORS.top.even;BORDERS.bottom.odd=BORDERS.left.even;BORDERS.top.odd=BORDERS.right.even;BORDERS.left.odd=BORDERS.bottom.even;BORDERS.right.odd=BORDERS.top.even;return{decode:function(s){var m=1,a=[],h=[];a[0]=-90;a[1]=90;h[0]=-180;h[1]=180;lat_err=90;lon_err=180;for(i=0;i<s.length;i++){c=s[i];cd=BASE32.indexOf(c);for(j=0;j<5;j++){mask=BITS[j];if(m){lon_err/=2;t(h,cd,mask)}else{lat_err/=2;t(a,cd,mask)}m=!m}}a[2]=(a[0]+
a[1])/2;h[2]=(h[0]+h[1])/2;return{latitude:a,longitude:h}},encode:function(s,m,a){var h=1,b=[],d=[],g=0,l=0;a=a?a:12;geohash="";b[0]=-90;b[1]=90;d[0]=-180;for(d[1]=180;geohash.length<a;){if(h){mid=(d[0]+d[1])/2;if(m>mid){l|=BITS[g];d[0]=mid}else d[1]=mid}else{mid=(b[0]+b[1])/2;if(s>mid){l|=BITS[g];b[0]=mid}else b[1]=mid}h=!h;if(g<4)g++;else{geohash+=BASE32[l];l=g=0}}return geohash}}}();
TILE5.Geo.Search=function(){return{bestResults:function(t,s){s||(s=20);for(var m=t.length>0?t[0]:null,a=[],h=0;h<t.length;h++)if(m.matchWeight-t[h].matchWeight<=s)a.push(t[h]);else break;return a}}}();
TILE5.Geo.Routing=function(){var t={calculate:function(s){s=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},s);GRUNT.Log.info("attempting to calculate route");var m=TILE5.Geo.getEngine("route");m&&m.route(s,function(a){if(s.generalize)a.geometry=TILE5.Geo.P.generalize(a.geometry,a.getInstructionPositions());if(s.map){t.createMapOverlay(s.map,a);if(s.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+a.boundingBox);s.map.gotoBounds(a.boundingBox)}}s.success&&
s.success(a)})},createMapOverlay:function(s,m){var a=s.getDimensions();a=new TILE5.Geo.UI.RouteOverlay({data:m,width:a.width,height:a.height});s.setLayer("route",a)},parseTurnType:function(s){for(var m=t.TurnType.Unknown,a=TILE5.Geo.Routing.TurnTypeRules,h=0;h<a.length;h++){a[h].regex.lastIndex=-1;var b=a[h].regex.exec(s);if(b){m=a[h].customCheck?a[h].customCheck(s,b):a[h].turnType;break}}return m},TurnType:{Unknown:"turn-unknown",Start:"turn-none-start",Continue:"turn-none",Arrive:"turn-none-arrive",
TurnLeft:"turn-left",TurnLeftSlight:"turn-left-slight",TurnLeftSharp:"turn-left-sharp",TurnRight:"turn-right",TurnRightSlight:"turn-right-slight",TurnRightSharp:"turn-right-sharp",Merge:"merge",UTurnLeft:"uturn-left",UTurnRight:"uturn-right",EnterRoundabout:"roundabout-enter",Ramp:"ramp",RampExit:"ramp-exit"},Instruction:function(s){s=GRUNT.extend({position:null,description:"",turnType:null},s);if(!s.turnType)s.turnType=t.parseTurnType(s.description);return s},RouteData:function(s){s=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},s);if(!s.boundingBox)s.boundingBox=TILE5.Geo.B.forPositions(s.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var m=[],a=0;a<s.instructions.length;a++)s.instructions[a].position&&m.push(s.instructions[a].position);return m}},s)}};return t}();
TILE5.Geo.Routing.TurnTypeRules=function(){var t=TILE5.Geo.Routing.TurnType,s=[];s.push({regex:/continue/i,turnType:t.Continue});s.push({regex:/(take|bear|turn)(.*?)left/i,customCheck:function(m,a){return/bear/i.test(a[1])?t.TurnLeftSlight:t.TurnLeft}});s.push({regex:/(take|bear|turn)(.*?)right/i,customCheck:function(m,a){return/bear/i.test(a[1])?t.TurnRightSlight:t.TurnRight}});s.push({regex:/enter\s(roundabout|rotaty)/i,turnType:t.EnterRoundabout});s.push({regex:/take.*?ramp/i,turnType:t.Ramp});
s.push({regex:/take.*?exit/i,turnType:t.RampExit});s.push({regex:/make(.*?)u\-turn/i,customCheck:function(m,a){return/right/i.test(a[1])?t.UTurnRight:t.UTurnLeft}});s.push({regex:/proceed/i,turnType:t.Start});s.push({regex:/arrive/i,turnType:t.Arrive});s.push({regex:/fell\sthrough/i,turnType:t.Merge});return s}();
TILE5.Geo.UI=function(){function t(a){a=GRUNT.extend({size:12,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},a);var h=null,b=function(){var d=TILE5.newCanvas(a.size*4,a.size*4),g=d.getContext("2d"),l=new TILE5.Vector(d.width/2,d.height/2),n=a.size,k=["#FFFFFF","#333333"],e=[3,1.5];g.lineCap="round";for(var f=0;f<k.length;f++){var o=n;g.lineWidth=e[f];g.strokeStyle=k[f];g.beginPath();g.moveTo(l.x,
l.y-o);g.lineTo(l.x,l.y+o);g.moveTo(l.x-o,l.y);g.lineTo(l.x+o,l.y);g.arc(l.x,l.y,n*0.6666,0,2*Math.PI,false);g.stroke()}return d}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(d,g,l){if(!h){h=TILE5.D.getCenter(l);h=new TILE5.Vector(Math.round(h.x-b.width/2),Math.round(h.y-b.height/2))}d.drawImage(b,h.x,h.y)}})}var s=0,m={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,radsPerPixel:0},a);var h=
TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),b=h.x-a.centerXY.x,d=h.y-a.centerXY.y,g=GRUNT.extend({},a.grid,{getBoundingBox:function(l,n,k,e){return new TILE5.Geo.BoundingBox(g.pixelsToPos(new TILE5.Vector(l,n+e)),g.pixelsToPos(new TILE5.Vector(l+k,n)))},getGridXYForPosition:function(l){l=TILE5.Geo.P.toMercatorPixels(l,a.radsPerPixel);return new TILE5.Vector(l.x-b,g.gridDimensions.height-(l.y-d))},getPixelDistance:function(l){l=TILE5.Geo.Utilities.dist2rad(l);return Math.floor(l/a.radsPerPixel)},
pixelsToPos:function(l){return TILE5.Geo.P.fromMercatorPixels(b+l.x,d+g.gridDimensions.height-l.y,a.radsPerPixel)}});return g},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var h=true,b=null,d=[],g=0,l=[],n=[],k=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(e,f,o,p){if(h)return null;var q="routeAnimation"+s++;n.push(q);
return new TILE5.Graphics.AnimatedPathLayer({id:q,path:d,zindex:a.zindex+1,easing:e?e:TILE5.Animation.Easing.Sine.InOut,duration:f?f:5E3,drawIndicator:o,autoCenter:p?p:false})},draw:function(e,f,o,p,q){o=0;p=a.data?a.data.geometry:null;if(h){h=false;b=null;d=[];g=0}if(p&&g<p.length){a:{q=q.getTileLayer();l=[];if(q){p=GRUNT.Log.getTraceTicks();var r,u,v,w=a.data?a.data.geometry:[],y=w.length,C=a.data?a.data.instructions:[],B=C.length,F=a.calculationsPerCycle,G=0;for(r=g;r<y;r++){u=q.getGridXYForPosition(w[r]);
if(v=!b||r===0||Math.abs(u.x-b.x)+Math.abs(u.y-b.y)>a.pixelGeneralization){d.push(u);b=u}G++;if(G>=F){g=r;break a}}g=y;GRUNT.Log.trace(y+" geometry points generalized to "+d.length+" coordinates",p);b=null;for(r=B;r--;)if(C[r].position){u=q.getGridXYForPosition(C[r].position);if(v=!b||r===0||Math.abs(u.x-b.x)+Math.abs(u.y-b.y)>a.pixelGeneralization){l.push(u);b=u}}}}o++}q=d.length;if(q>0&&(!o||a.partialDraw)){e.strokeStyle=a.strokeStyle;e.lineWidth=a.lineWidth;e.beginPath();e.moveTo(d[q-1].x-f.x,
d[q-1].y-f.y);for(q=q;q--;)e.lineTo(d[q].x-f.x,d[q].y-f.y);e.stroke();e.fillStyle=a.waypointFillStyle;for(q=l.length;q--;){e.beginPath();e.arc(l[q].x-f.x,l[q].y-f.y,2,0,Math.PI*2,false);e.stroke();e.fill()}}return o}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var e=n.length;e--;)GRUNT.WaterCooler.say("layer.remove",{id:n[e]});n=[];h=true;k.wakeParent()});return k},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:m.AnnotationTween,animationSpeed:null},a);var h=
false,b={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return h},draw:function(d,g,l,n){if(b.xy){if(b.isNew&&a.tweenIn){var k=b.xy.y;b.xy.y=g.y-20;h=true;TILE5.Animation.tween(b.xy,"y",k,a.tweenIn,function(){b.xy.y=k;h=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(d,g,new TILE5.Vector(b.xy.x-g.x,b.xy.y-g.y),l,n);else{d.beginPath();d.arc(b.xy.x-g.x,b.xy.y-g.y,4,0,Math.PI*2,false);d.fill()}b.isNew=false}}};return b},ImageAnnotation:function(a){a=GRUNT.extend({imageUrl:null,
animatingImageUrl:null,imageAnchor:null},a);var h=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;a.draw=function(d,g,l,n,k){if(a.animatingImageUrl&&b.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);n=a.animatingImageUrl}else n=a.imageUrl;if(g=TILE5.Resources.getImage(n)){if(g.complete&&g.width>0){h||(h=new TILE5.Vector(-g.width>>1,-g.height>>1));l=TILE5.V.offset(l,h.x,h.y);d.drawImage(g,l.x,l.y,g.width,g.height)}}else TILE5.Resources.loadImage(n,function(){k.wakeParent()})};var b=new m.Annotation(a);
return b},AnnotationsOverlay:function(a){function h(n){for(var k=a.map?a.map.getTileLayer():null,e=0;k&&e<n.length;e++)n[e].xy=k.getGridXYForPosition(n[e].pos);n.sort(function(f,o){var p=o.xy.y-f.xy.y;if(p===0)p=o.xy.x-f.xy.x;return p})}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var b=[],d=false,g=[],l=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){return d?1:0},draw:function(n,k,e,f){d=false;n.fillStyle="rgba(255, 0, 0, 0.75)";n.globalCompositeOperation=
"source-over";for(e=b.length;e--;){b[e].draw(n,k,f,l);d=d||b[e].isAnimating()}for(e=g.length;e--;){g[e].draw(n,k,f,l);d=d||g[e].isAnimating()}return d?1:0},add:function(n){g.push(n);h(g);l.wakeParent()},clear:function(n){g=[];h(g);if(n){b=[];h(b)}l.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(n){if(a.pois&&a.pois.id==n.srcID){n=n.pois;try{b=[];for(var k=0;k<n.length;k++)if(n[k].pos){var e;var f=n[k];if(f&&f.pos){var o=null;if(o=a.createAnnotationForPOI?a.createAnnotationForPOI(f):
new m.Annotation({pos:f.pos})){o.isNew=f.isNew;f.isNew=false}e=o}else e=void 0;e&&b.push(e)}h(b)}catch(p){GRUNT.Log.exception(p)}l.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",function(){h(b);h(g);l.wakeParent()});return l},GeoLocationOverlay:function(a){function h(){var e=a.map?a.map.getTileLayer():null;d=null;if(l&&e)d=e.getGridXYForPosition(l);g=0;if(n&&e)g=e.getPixelDistance(n/1E3)}a=GRUNT.extend({fillStyle:"rgba(0, 221, 238, 0.1)",strokeStyle:"rgba(0, 102, 136, 0.3)",originFillStyle:"rgba(0, 102, 136, 0.7)",
zindex:100,map:null,watch:true,onUpdate:null},a);var b=0,d=null,g=0,l=null,n=0,k=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){},draw:function(e,f){if(d&&g){var o=d.x-f.x,p=d.y-f.y;e.fillStyle=a.fillStyle;e.lineWidth=1;e.strokeStyle=a.strokeStyle;e.beginPath();e.arc(o,p,g,0,Math.PI*2,false);e.fill();e.stroke();e.fillStyle=a.originFillStyle;e.beginPath();e.arc(o,p,3,0,Math.PI*2,false);e.fill();GRUNT.WaterCooler.say("grid.invalidate")}},getPosition:function(){return l},getAccuracy:function(){return n}});
GRUNT.WaterCooler.listen("grid.updated",function(){h();k.wakeParent()});(function(){b=TILE5.Geo.Location.get({watch:a.watch,successCallback:function(e,f){a.onUpdate&&a.onUpdate(e,f);l=TILE5.Geo.P.copy(e);n=f;h()},errorCallback:function(){GRUNT.Log.info("got position error")}})})();return k},Tiler:function(a){a=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,zoomLevel:0,boundsChange:null,tapPOI:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,zoomAnimation:TILE5.Animation.Easing.Quad.Out},
a);var h=new TILE5.Vector,b=false,d=[],g=0,l=null,n=null,k=a.zoomLevel;if(!a.provider)a.provider=new TILE5.Geo.MapProvider;var e=GRUNT.extend({},new TILE5.Tiling.Tiler(a),{pois:a.pois,annotations:null,getProvider:function(){return a.provider},setProvider:function(o){a.provider=o;b=false},getBoundingBox:function(){var o=e.getTileLayer(),p=e.getOffset(),q=e.getDimensions();if(o)return o.getBoundingBox(p.x,p.y,q.width,q.height);return null},getCenterPosition:function(){return e.getXYPosition(TILE5.D.getCenter(e.getDimensions()))},
getXYPosition:function(o){return e.getTileLayer().pixelsToPos(e.viewPixToGridPix(o))},gotoBounds:function(o,p){var q=TILE5.Geo.B.getZoomLevel(o,e.getDimensions());e.gotoPosition(TILE5.Geo.B.getCenter(o),q,p)},gotoCurrentPosition:function(o){function p(r,u){var v=TILE5.Geo.B.createBoundsFromCenter(r,u/1E3);GRUNT.Log.info("detected position: "+TILE5.Geo.P.toString(r)+", accuracy = "+u);e.clearBackground();e.gotoBounds(v,o)}var q=e.getLayer("geolocation");if(q)p(q.getPosition(),q.getAccuracy());else{q=
new m.GeoLocationOverlay({map:e,onUpdate:function(r,u){p(r,u)}});GRUNT.Log.info("created geolocation layer");e.setLayer("geolocation",q)}},gotoPosition:function(o,p,q){var r=k,u=(new Date).getTime(),v=false,w=e.getBoundingBox();if(w)v=!TILE5.Geo.P.inBounds(o,w);k=p?p:k;if(!k)throw Error("Zoom level required to goto a position.");if(a.provider)k=a.provider.checkZoomLevel(k);if(v||!b||k!==r){TILE5.Resources.resetImageLoadQueue();(p=e.getTileLayer())&&p.deactivate();TILE5.Animation.cancel();b&&e.freeze();
g=u;a.provider.zoomLevel=k;a.provider.getMapTiles(e,o,function(y){if(u===g){e.setTileLayer(y);n=y.getId();e.panToPosition(o,function(){e.unfreeze();e.trigger("zoomLevelChange",k);q&&q()})}else GRUNT.Log.info("request time mismatch - ignoring update")});b=true}else e.panToPosition(o,q)},panToPosition:function(o,p,q){var r=e.getTileLayer();if(r){o=r.getGridXYForPosition(o);r=e.getDimensions();o.x-=r.width/2;o.y-=r.height/2;if(l)l=null;e.updateOffset(o.x,o.y,q);GRUNT.WaterCooler.say("view.wake",{id:e.id});
a.boundsChange&&a.boundsChange(e.getBoundingBox());p&&p(e)}},getZoomLevel:function(){return k},setZoomLevel:function(o){try{e.gotoPosition(e.getCenterPosition(),o)}catch(p){GRUNT.Log.exception(p)}},zoomIn:function(){e.scale(2,TILE5.Animation.Easing.Sine.Out)||e.setZoomLevel(k+1)},zoomOut:function(){e.scale(0.5,TILE5.Animation.Easing.Sine.Out)||e.setZoomLevel(k-1)},animateRoute:function(o,p,q,r){var u=e.getLayer("route");if(u)(o=u.getAnimation(o,p,q,r))&&o.addToView(e)}});e.bind("tap",function(o,p){var q=
e.getTileLayer(),r=null;if(q){r=e.viewPixToGridPix(new TILE5.Vector(p.x,p.y));var u=q.pixelsToPos(r),v=q.pixelsToPos(TILE5.V.offset(r,-a.tapExtent,a.tapExtent)),w=q.pixelsToPos(TILE5.V.offset(r,a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(q.pixelsToPos(r)));r=new TILE5.Geo.BoundingBox(v,w);d=e.pois.findByBounds(r);e.trigger("geotap",o,p,u,r);a.tapPOI&&a.tapPOI(d)}});e.bind("doubleTap",function(o,p){e.animate(2,TILE5.D.getCenter(e.getDimensions()),new TILE5.Vector(p.x,
p.y),a.zoomAnimation)});e.bind("scale",function(o,p){var q=0;o=Math.sqrt(o);if(o<1)q=-(0.5/o);else if(o>1)q=o;e.gotoPosition(e.getXYPosition(p),k+Math.floor(q))});var f=new TILE5.Geo.UI.AnnotationsOverlay({pois:e.pois,map:e,createAnnotationForPOI:a.createAnnotationForPOI});e.annotations=f;e.setLayer("annotations",f);a.crosshair&&e.setLayer("crosshair",new t);GRUNT.WaterCooler.listen("view.idle",function(o){if(o.id&&o.id==e.id)if(TILE5.V.absSize(TILE5.V.diff(h,e.getOffset()))>a.boundsChangeThreshold&&
a.boundsChange){h=e.getOffset();a.boundsChange(e.getBoundingBox())}});return e}};return m}();
