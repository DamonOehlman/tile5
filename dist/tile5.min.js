if(!this.JSON)this.JSON={};
(function(){function s(b){return b<10?"0"+b:b}function p(b){j.lastIndex=0;return j.test(b)?'"'+b.replace(j,function(c){var f=h[c];return typeof f==="string"?f:"\\u"+("0000"+c.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+b+'"'}function k(b,c){var f,i,o,l,m=d,n,q=c[b];if(q&&typeof q==="object"&&typeof q.toJSON==="function")q=q.toJSON(b);if(typeof g==="function")q=g.call(c,b,q);switch(typeof q){case "string":return p(q);case "number":return isFinite(q)?String(q):"null";case "boolean":case "null":return String(q);
case "object":if(!q)return"null";d+=e;n=[];if(Object.prototype.toString.apply(q)==="[object Array]"){l=q.length;for(f=0;f<l;f+=1)n[f]=k(f,q)||"null";o=n.length===0?"[]":d?"[\n"+d+n.join(",\n"+d)+"\n"+m+"]":"["+n.join(",")+"]";d=m;return o}if(g&&typeof g==="object"){l=g.length;for(f=0;f<l;f+=1){i=g[f];if(typeof i==="string")if(o=k(i,q))n.push(p(i)+(d?": ":":")+o)}}else for(i in q)if(Object.hasOwnProperty.call(q,i))if(o=k(i,q))n.push(p(i)+(d?": ":":")+o);o=n.length===0?"{}":d?"{\n"+d+n.join(",\n"+d)+
"\n"+m+"}":"{"+n.join(",")+"}";d=m;return o}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+s(this.getUTCMonth()+1)+"-"+s(this.getUTCDate())+"T"+s(this.getUTCHours())+":"+s(this.getUTCMinutes())+":"+s(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var a=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
j=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,d,e,h={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},g;if(typeof JSON.stringify!=="function")JSON.stringify=function(b,c,f){var i;e=d="";if(typeof f==="number")for(i=0;i<f;i+=1)e+=" ";else if(typeof f==="string")e=f;if((g=c)&&typeof c!=="function"&&(typeof c!=="object"||typeof c.length!=="number"))throw Error("JSON.stringify");return k("",
{"":b})};if(typeof JSON.parse!=="function")JSON.parse=function(b,c){function f(o,l){var m,n,q=o[l];if(q&&typeof q==="object")for(m in q)if(Object.hasOwnProperty.call(q,m)){n=f(q,m);if(n!==undefined)q[m]=n;else delete q[m]}return c.call(o,l,q)}var i;b=String(b);a.lastIndex=0;if(a.test(b))b=b.replace(a,function(o){return"\\u"+("0000"+o.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(b.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){i=eval("("+b+")");return typeof c==="function"?f({"":i},""):i}throw new SyntaxError("JSON.parse");}})();if(!String.format)String.format=function(s){if(arguments.length<=1)return s;for(var p=arguments.length-2,k=0;k<=p;k++)s=s.replace(RegExp("\\{"+k+"\\}","gi"),arguments[k+1]);return s};
String.prototype.containsWord=function(s){var p="";if(s.toString)s=s.toString();for(var k=0;k<s.length;k++)p+=!/\w/.test(s[k])?"\\"+s[k]:s[k];return RegExp("(^|\\s|\\,)"+p+"(\\,|\\s|$)","i").test(this)};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.sec=function(){return 1/Math.cos(this)};
GRUNT=function(){var s=Object.prototype.hasOwnProperty,p=0,k={id:"GRUNT.core",extend:function(){var a=arguments[0]||{},j=1,d=arguments.length,e=false,h,g,b,c;if(typeof a==="boolean"){e=a;a=arguments[1]||{};j=2}if(typeof a!=="object"&&!k.isFunction(a))a={};if(d===j){a=this;--j}for(;j<d;j++)if((h=arguments[j])!=null)for(g in h){b=a[g];c=h[g];if(a!==c)if(e&&c&&(k.isPlainObject(c)||k.isArray(c))){b=b&&(k.isPlainObject(b)||k.isArray(b))?b:k.isArray(c)?[]:{};a[g]=k.extend(e,b,c)}else if(c!==undefined)a[g]=
c}return a},isFunction:function(a){return toString.call(a)==="[object Function]"},isArray:function(a){return toString.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||toString.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!s.call(a,"constructor")&&!s.call(a.constructor.prototype,"isPrototypeOf"))return false;var j;for(j in a);return j===undefined||s.call(a,j)},isEmptyObject:function(a){for(var j in a)return false;return true},isXmlDocument:function(a){return toString.call(a)===
"[object Document]"},contains:function(a,j){var d=a,e=arguments,h=1;if(j&&k.isArray(j)){e=j;h=0}for(h=h;h<e;h++)d=d&&typeof foo[e[h]]!=="undefined";return d},newModule:function(a){a=k.extend({id:null,requires:[],parent:null},a);if(a.parent)a=k.extend({},a.parent,a);return a},toID:function(a){return a.replace(/\s/g,"-")},generateObjectID:function(a){return(a?a:"obj")+p++}};return k}();
GRUNT.Log=function(){function s(d,e){var h,g=e&&e.length>0?e[0]:"";for(h=1;e&&h<e.length;h++)g+=" "+(k&&GRUNT.isPlainObject(e[h])?JSON.stringify(e[h]):e[h]);typeof console!=="undefined"&&console[d](g);for(h=0;h<p.length;h++)p[h].call(j,g,d)}var p=[],k=typeof JSON!=="undefined",a=window.console&&window.console.markTimeline,j={id:"GRUNT.log",getTraceTicks:function(){return a?(new Date).getTime():null},trace:function(d,e){if(a)console.markTimeline(d+(e?": "+(j.getTraceTicks()-e)+"ms":""))},debug:function(){s("debug",
arguments)},info:function(){s("info",arguments)},warn:function(){s("warn",arguments)},error:function(){s("error",arguments)},exception:function(d){j.error(arguments);for(var e in d)j.info("ERROR DETAIL: "+e+": "+d[e])},watch:function(d,e){try{e()}catch(h){j.exception(h,d)}},throwError:function(d){j.error(d);throw Error(d);},requestUpdates:function(d){p.push(d)}};return j}();
GRUNT.Data=function(){var s={determineObjectMapping:function(k){if(!k)return null;k=k.split("|");for(var a={},j=0;j<k.length;j++)a[k[j]]=j;return a},mapLineToObject:function(k,a){var j=k.split("|"),d={};for(var e in a){var h=a[e];d[e]=j.length>h?j[h]:null}return d},parse:function(k){var a=null,j=[];k=k.split("\n");for(var d=0;d<k.length;d++){var e=k[d];if(a)j.push(s.mapLineToObject(e,a));else a=s.determineObjectMapping(e)}return j}},p={supportedFormats:{JSON:{parse:function(k){return JSON.parse(k)}},
PDON:{parse:function(k){return s.parse(k)}}},parse:function(k){k=GRUNT.extend({data:"",format:"JSON"},k);if(!p.supportedFormats[k.format])throw Error("Unsupported data format: "+k.format+", cannot parse data in javascript object");try{return p.supportedFormats[k.format].parse(k.data)}catch(a){GRUNT.Log.error("ERROR PARSING DATA FROM FORMAT: "+k.format,k.data);GRUNT.Log.exception(a)}return{}}};return p}();
GRUNT.Template=function(){var s=/\$\{(.*?)\}/ig;return{parse:function(p,k){for(var a=p,j=s.exec(a);j;){a=a.replace(j[0],GRUNT.XPath.first(j[1],k));s.lastIndex=0;j=s.exec(a)}return a}}}();
GRUNT.JSONP=function(){function s(j){var d=document.createElement("script"),e=false;d.src=j;d.async=true;d.onload=d.onreadystatechange=function(){if(!e&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){e=true;d.onload=d.onreadystatechange=null;d&&d.parentNode&&d.parentNode.removeChild(d)}};k||(k=document.getElementsByTagName("head")[0]);k.appendChild(d)}var p=0,k,a=this;return{get:function(j,d){j+=j.indexOf("?")>=0?"&":"?";var e="json"+ ++p;a[e]=function(h){d(h);a[e]=
null;try{delete a[e]}catch(g){}};s(j+"callback="+e);return e}}}();
GRUNT.XHR=function(){var s={HTML:"text/html",XML:"text/xml",TEXT:"text/plain",STREAM:"application/octet-stream"},p={JSON:["json"],PDON:["pdon.txt"]},k=["TEXT","STREAM"],a=/^(\w+:)?\/\/([^\/?#]+)/,j={XML:function(h){return h.responseXML},JSON:function(h){try{return JSON.parse(h.responseText)}catch(g){GRUNT.Log.error("Error parsing JSON data: ",h.responseText);GRUNT.Log.exception(g)}return""},PDON:function(h){return GRUNT.Data.parse({data:h.responseText,format:"PDON"})},DEFAULT:function(h){return h.responseText}},
d={CONTENT_TYPE:"Content-Type"},e=GRUNT.newModule({id:"GRUNT.xhr",ajaxSettings:{xhr:null},ajax:function(h){try{h=GRUNT.extend({method:"GET",data:null,url:null,async:true,success:null,handleResponse:null,error:null,contentType:"application/x-www-form-urlencoded"},e.ajaxSettings,h);var g=a.exec(h.url),b=g&&(g[1]&&g[1]!==location.protocol||g[2]!==location.host);if(h.data)h.method="POST";if(h.url){g=null;if(h.xhr)g=h.xhr(h);g||(g=new XMLHttpRequest);g.open(h.method,h.url,h.async);h.data&&g.setRequestHeader("Content-Type",
h.contentType);b||g.setRequestHeader("X-Requested-With","XMLHttpRequest");g.onreadystatechange=function(){if(this.readyState===4){var f=null,i=!this.status&&location.protocol==="file:"||this.status>=200&&this.status<300||this.status===304||this.status===1223||this.status===0;try{if(i)if(h.handleResponse)h.handleResponse(this);else{var o=h,l=this.getResponseHeader(d.CONTENT_TYPE),m,n=false;for(m in s)if(l&&l.indexOf(s[m])>=0){n=true;break}l=!n;for(n=0;n<k.length;n++)l=l||k[n]==m;if(l)b:{l=m;for(var q in p)for(n=
0;n<p[q].length;n++)if(RegExp(p[q][n]+"$","i").test(o.url)){m=q;break b}m=l?l:"DEFAULT"}try{f=j[m](this,o)}catch(r){GRUNT.Log.warn("error applying processor '"+m+"' to response type, falling back to default");f=j.DEFAULT(this,o)}}else h.error&&h.error(this)}catch(u){GRUNT.Log.exception(u,"PROCESSING AJAX RESPONSE")}i&&f&&h.success&&h.success.call(this,f)}};g.send(h.method=="POST"?e.param(h.data):null)}else GRUNT.Log.warn("ajax request issued with no url - that ain't going to work...")}catch(c){GRUNT.Log.exception(c)}},
param:function(h){var g=[],b=function(f,i){i=GRUNT.isFunction(i)?i():i;g[g.length]=encodeURIComponent(f)+"="+encodeURIComponent(i)};if(GRUNT.isArray(h))for(var c=0;c<h.length;c++)b(h[c].name,h[c].value);else for(c in h)b(c,h[c]);return g.join("&").replace(/%20/g,"+")}});return e}();
GRUNT.XPath=function(){function s(j){for(var d=null,e=0;e<p.length;e++)if(d=p[e](j))break;return d}var p=[],k=[null,function(j){return j.numberValue},function(j){return j.stringValue},function(j){return j.booleanValue},null,null,null,null,function(j){return j.singleNodeValue?j.singleNodeValue.textContent:null},function(j){return j.singleNodeValue?j.singleNodeValue.textContent:null}];typeof XPathResult!=="undefined"||GRUNT.Log.warn("No XPATH support, this is going to cause problems");var a={SearchResult:function(j){return{toString:function(){var d=
null;if(j){var e=null;if(j.resultType>=0&&j.resultType<k.length)e=k[j.resultType];if(e){GRUNT.Log.info("invoking match handler for result type: "+j.resultType);d=e(j)}}return d?d:""}}},first:function(j,d){var e=a.SearchResult,h;var g=XPathResult.FIRST_ORDERED_NODE_TYPE;if(!g)g=XPathResult.ANY_TYPE;try{if(GRUNT.isXmlDocument(d))h=d.evaluate(j,d,s,g,null);else{GRUNT.Log.warn("attempted xpath expression: "+j+" on a non-xml document");h=null}}catch(b){GRUNT.Log.warn("attempted to run invalid xpath expression: "+
j+" on node: "+d);h=null}return new e(h)},registerResolver:function(j){p.push(j)}};return a}();GRUNT.WaterCooler=function(){var s={},p=[];return{addPipe:function(k){k("pipe.test",{});p.push(k)},listen:function(k,a){s[k]||(s[k]=[]);a&&s[k].push(a)},say:function(k,a){var j;for(j=p.length;j--;)p[j](k,a);if(s[k])for(j=s[k].length;j--;)s[k][j](a)},leave:function(){}}}();
TILE5=function(){var s={Settings:function(){var p={};return{get:function(k){return p[k]},set:function(k,a){p[k]=a},extend:function(k){GRUNT.extend(p,k)}}}(),Clock:function(){var p=null;return{getTime:function(k){return k&&p?p:p=(new Date).getTime()}}}(),Vector:function(p,k){return{x:p?p:0,y:k?k:0}},V:function(){function p(k){if(!k||k.length<=1)throw Error("Cannot determine edge distances for a vector array of only one vector");for(var a={edges:Array(k.length-1),accrued:Array(k.length-1),total:0},
j=TILE5.V.diff,d=0;d<k.length-1;d++){var e=j(k[d],k[d+1]);a.edges[d]=Math.sqrt(e.x*e.x+e.y*e.y);a.accrued[d]=a.total+a.edges[d];a.total+=a.edges[d]}return a}return{create:function(k,a){return new s.Vector(k,a)},add:function(){for(var k=new s.Vector,a=arguments.length;a--;){k.x+=arguments[a].x;k.y+=arguments[a].y}return k},absSize:function(k){return Math.max(Math.abs(k.x),Math.abs(k.y))},diff:function(k,a){return new s.Vector(k.x-a.x,k.y-a.y)},copy:function(k){return k?new s.Vector(k.x,k.y):null},
invert:function(k){return new TILE5.Vector(-k.x,-k.y)},offset:function(k,a,j){return new TILE5.Vector(k.x+a,k.y+(j?j:a))},edges:p,distance:function(k){return p(k).total},theta:function(k,a,j){j=Math.asin((k.y-a.y)/j);return k.x>a.x?j:Math.PI-j},pointOnEdge:function(k,a,j,d){a=new TILE5.Vector(Math.cos(j)*d,Math.sin(j)*d);return new TILE5.Vector(k.x-a.x,k.y-a.y)},getRect:function(k){var a=k.length;if(a>1)return new TILE5.Rect(Math.min(k[0].x,k[a-1].x),Math.min(k[0].y,k[a-1].y),Math.abs(k[0].x-k[a-
1].x),Math.abs(k[0].y-k[a-1].y))}}}(),Dimensions:function(p,k){return{width:p?p:0,height:k?k:0}},D:function(){return{getAspectRatio:function(p){return p.height!==0?p.width/p.height:1},getCenter:function(p){return new s.Vector(p.width/2,p.height/2)},getSize:function(p){return Math.sqrt(Math.pow(p.width,2)+Math.pow(p.height,2))}}}(),Rect:function(p,k,a,j){return{origin:new s.Vector(p,k),dimensions:new s.Dimensions(a,j)}},R:function(){return{copy:function(p){return p?new s.Rect(p.origin.x,p.origin.y,
p.dimensions.width,p.dimensions.height):null},getCenter:function(p){return new TILE5.Vector(p.origin.x+p.dimensions.width/2,p.origin.y+p.dimensions.height/2)}}}()};return s}();
TILE5.Device=function(){function s(){for(;c.length>0;){var i=c.shift();document.location=i}b=0}function p(i){for(var o=true,l=f.length;l--;)o=o&&i!=f[l];return o}function k(i,o){var l=[];for(var m in o)m&&l.push(m+"="+escape(o[m]));return"tile5://"+i+"/"+(l.length>0?"?"+l.join("&"):"")}function a(i,o){p(i)&&GRUNT.Log.info("would push url: "+k(i,o))}function j(i,o){if(p(i)){c.push(k(i,o));b||(b=setTimeout(s,100))}}function d(){e={base:{name:"Unknown",eventTarget:document,supportsTouch:"createTouch"in
document,imageCacheMaxSize:4096,getScaling:function(){return 1},maxImageLoads:4,requireFastDraw:false,bridgeNotify:a,targetFps:25},ipod:{name:"iPod Touch",regex:/ipod/i,imageCacheMaxSize:6144,maxImageLoads:4,requireFastDraw:true,bridgeNotify:j,targetFps:10},iphone:{name:"iPhone",regex:/iphone/i,imageCacheMaxSize:6144,maxImageLoads:4,bridgeNotify:j},ipad:{name:"iPad",regex:/ipad/i,imageCacheMaxSize:6144,bridgeNotify:j},android:{name:"Android OS <= 2.1",regex:/android/i,eventTarget:document.body,supportsTouch:true,
getScaling:function(){return 1/window.devicePixelRatio},bridgeNotify:j},froyo:{name:"Android OS >= 2.2",regex:/froyo/i,eventTarget:document.body,supportsTouch:true,bridgeNotify:j}};h=[e.froyo,e.android,e.ipod,e.iphone,e.ipad]}var e=null,h=[],g=null,b=0,c=[],f=["view.wake","tile.loaded"];return{getConfig:function(){e||d();if(!g){GRUNT.Log.info("ATTEMPTING TO DETECT PLATFORM: UserAgent = "+navigator.userAgent);for(var i=0;i<h.length;i++){var o=h[i];if(o.regex&&o.regex.test(navigator.userAgent)){g=GRUNT.extend({},
e.base,o);GRUNT.Log.info("PLATFORM DETECTED AS: "+g.name);break}}if(!g){GRUNT.Log.warn("UNABLE TO DETECT PLATFORM, REVERTING TO BASE CONFIGURATION");g=e.base}GRUNT.Log.info("CURRENT DEVICE PIXEL RATIO = "+window.devicePixelRatio)}return g}}}();
TILE5.Resources=function(){var s="",p={},k=function(){function j(){var r=b[this.id];if(r){r.loaded=true;r.hitCount=1;for(var u=i.length;u--;)if(i[u].image.src==this.src){i.splice(u,1);break}r.loadCallback&&r.loadCallback(this,false);o.push({url:this.src,created:r.requested});delete b[this.id];d()}}function d(){for(var r=TILE5.Device.getConfig().maxImageLoads;f.length>0&&(!r||i.length<r);){var u=f.shift();if(u.imageLoader){i.push(u);u.imageLoader(u,j)}}}function e(r){for(var u=null,v=l.length;v--&&
!u;)u=l[v](r);return u?u:function(t,y){t.image.onload=y;t.image.src=a.getPath(t.url);t.requested=(new Date).getTime()}}function h(){n=true;try{var r=Math.floor(o.length/2);if(r>0){o.sort(function(v,t){return v.created-t.created});for(var u=r;u--;)delete g[o[u].url];o.splice(0,r)}}finally{n=false}GRUNT.WaterCooler.say("imagecache.cleared")}var g={},b={},c=0,f=[],i=[],o=[],l=[],m=0,n=false,q={loadingImages:i,queuedImages:f,addInterceptor:function(r){l.push(r)},getCacheFullness:function(){return m},
getImage:function(r){var u=null;n||(u=g[r]);return u?u.image:null},loadImage:function(r,u){var v=g[r];if(v){v.hitCount++;v.image.complete&&u&&u(v.image,true)}else{v={url:r,image:new Image,loaded:false,imageLoader:e(r),created:(new Date).getTime(),requested:null,hitCount:0,loadCallback:u};v.image.id="resourceLoaderImage"+c++;g[r]=v;b[v.image.id]=v;f.push(v);d()}return v},resetLoadingQueue:function(){i=[]}};setInterval(function(){for(var r=(new Date).getTime(),u=false,v=0,t=TILE5.Device.getConfig();v<
i.length;)if(r-i[v].requested>a.loadTimeout*1E3){i.splice(v,1);u=true}else v++;u&&d();if(t&&t.imageCacheMaxSize){m=o.length*a.avgImageSize/t.imageCacheMaxSize;m>=1&&h()}},1E3);return q}(),a={avgImageSize:25,loadTimeout:10,Cache:function(){return{read:function(){return null},write:function(){},getUrlCacheKey:function(j,d){for(var e=(j?j.replace(/^.*\?/,""):"").split("&"),h=j?j.replace(/\?.*$/,"?"):"",g=0;g<e.length;g++){var b=e[g].split("=");if(!d||!d.test(b[0]))h+=e[g]+"&"}return h.replace(/\W/g,
"")},isValidCacheKey:function(j){GRUNT.Log.info("cache key = "+j);return false}}}(),addInterceptor:k.addInterceptor,getPath:function(j){return/^(file|https?|\/)/.test(j)?j:s+j},setBasePath:function(j){s=j},getImage:function(j){return k.getImage(j)},loadImage:function(j,d){k.loadImage(j,d)},resetImageLoadQueue:function(){k.resetLoadingQueue()},getStats:function(){return{imageLoadingCount:k.loadingImages.length,queuedImageCount:k.queuedImages.length,imageCacheFullness:k.getCacheFullness()}},loadResource:function(j){j=
GRUNT.extend({filename:"",cacheable:true,dataType:null,callback:null},j);var d=function(e){j.callback&&GRUNT.Log.watch("CALLING RESOURCE CALLBACK",function(){j.callback(e)})};j.cacheable&&p[j.filename]?d(p[j.filename]):GRUNT.XHR.ajax({url:a.getPath(j.filename),dataType:j.dataType,success:function(e){if(j.cacheable)p[j.filename]=e;d(e)},error:function(e,h,g){GRUNT.Log.error("error loading resource ["+j.filename+"], error = "+g)}})},loadSnippet:function(j,d){/\.\w+$/.test(j)||(j+=".html");a.loadResource({filename:"snippets/"+
j,callback:d,dataType:"html"})}};return a}();
TILE5.Touch=function(){function s(b,c){var f=b&&b.length>0?b[0]:null;if(f&&c&&c.length>0)return TILE5.V.diff(f,c[0]);return null}function p(b){b.preventDefault();b.stopPropagation()}function k(b){for(var c=Array(b.length),f=b.length;f--;)c[f]=new TILE5.Vector(b[f].pageX,b[f].pageY);return c}var a={TAP:0,MOVE:1,PINCHZOOM:2},j=7,d=0,e=0,h={TouchHelper:function(b){function c(w){for(var B=[],C=b.element?-b.element.offsetLeft:0,M=b.element?-b.element.offsetTop:0,N=w.length;N--;)B.push(TILE5.V.offset(w[N],
C,M));return B}function f(w){var B=Array(arguments.length-1),C=0;for(C=1;C<arguments.length;C++)B[C-1]=arguments[C];for(C=F.length;C--;)F[C][w]&&F[C][w].apply(J,B)}function i(w){if(w.target&&w.target===b.element){r=q?k(w.touches):[new TILE5.Vector(w.pageX,w.pageY)];v=new TILE5.Vector;t=new TILE5.Vector;D=true;m=false;q&&p(w);G.current=TILE5.Clock.getTime();if(w=r.length>0?r[0]:null){f("touchStartHandler",w.x,w.y);if(G.current-G.last<J.THRESHOLD_DOUBLETAP)if((w=u?TILE5.V.diff(r[0],u[0]):null)&&Math.abs(w.x)<
b.maxDistDoubleTap&&Math.abs(w.y)<b.maxDistDoubleTap)m=true;z=a.TAP;u=[].concat(r)}else GRUNT.Log.warn("Touch start fired, but no touch vector found")}}function o(w){if(w.target&&w.target===b.element)if(D)try{q&&p(w);var B=q?k(w.touches):[new TILE5.Vector(w.pageX,w.pageY)];w=0;if(B.length>1){if(r.length===1)r=[].concat(B);w=TILE5.V.distance(r)-TILE5.V.distance(u)}if(z===a.TAP){var C=s(B,r);if(C&&(Math.abs(C.x)>=j||Math.abs(C.y)>=j))z=a.MOVE}if(z!==a.TAP)if(!w||Math.abs(w)<b.pinchZoomThreshold){if(v=
s(B,u)){t.x+=v.x;t.y+=v.y;y.x+=v.x;y.y+=v.y}if(TILE5.V.absSize(y)>b.panEventThreshhold){f("moveHandler",y.x,y.y);y=TILE5.V.create()}z=a.MOVE}else{f("pinchZoomHandler",c(r),c(B));z=a.PINCHZOOM}u=[].concat(B)}catch(M){GRUNT.Log.exception(M)}}function l(w){if(w.target&&w.target===b.element)try{q&&p(w);TILE5.Clock.getTime();G.last=G.current;if(z===a.TAP)n||(n=setTimeout(function(){n=0;var C=m?"doubleTapHandler":"tapHandler",M=r[0],N=null;if(b.element)N=TILE5.V.offset(M,-b.element.offsetLeft,-b.element.offsetTop);
f(C,M,N)},J.THRESHOLD_DOUBLETAP+50));else if(z==a.MOVE)f("moveEndHandler",t.x,t.y);else z==a.PINCHZOOM&&f("pinchZoomEndHandler",c(r),c(u))}catch(B){GRUNT.Log.exception(B)}D=false}b=GRUNT.extend({element:null,inertiaTrigger:20,maxDistDoubleTap:20,panEventThreshhold:0,pinchZoomThreshold:5,touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null,wheelZoomHandler:null},b);var m=false,n=0,q=TILE5.Device.getConfig().supportsTouch,
r=null,u=null,v=null,t=null,y=new TILE5.Vector,z=null,D=false,F=[],G={current:0,last:0},E=TILE5.Device.getConfig(),J={supportsTouch:q,THRESHOLD_DOUBLETAP:300,addListeners:function(w){F.push(w)},decoupleListeners:function(w){for(var B=0;w&&B<F.length;B++)if(F[B].listenerId===w){F.splice(B,1);GRUNT.Log.info("successfully decoupled touch listener: "+w);break}},release:function(){E.eventTarget.removeEventListener(E.supportsTouch?"touchstart":"mousedown",i,false);E.eventTarget.removeEventListener(E.supportsTouch?
"touchmove":"mousemove",o,false);E.eventTarget.removeEventListener(E.supportsTouch?"touchend":"mouseup",l,false)},wheelie:function(w){var B=new TILE5.Vector(w.wheelDeltaX,w.wheelDeltaY);w=new TILE5.Vector(w.clientX,w.clientY);var C=B.y!==0?Math.abs(B.y/120):0;if(C!==0)f("wheelZoomHandler",w,B.y>0?C+0.5:0.5/C);GRUNT.Log.info("capture mouse wheel event, delta = "+B+", position = "+w)}};E.eventTarget.addEventListener(E.supportsTouch?"touchstart":"mousedown",i,false);E.eventTarget.addEventListener(E.supportsTouch?
"touchmove":"mousemove",o,false);E.eventTarget.addEventListener(E.supportsTouch?"touchend":"mouseup",l,false);return J}},g=[];return{captureTouch:function(b,c){try{if(!b)throw Error("Unable to capture touch of null element");if(!b.id)b.id="touchable_"+d++;var f=g[b.id];if(!f){f=h.TouchHelper(GRUNT.extend({element:b},c));g[b.id]=f;GRUNT.Log.info("CREATED TOUCH HELPER. SUPPORTS TOUCH = "+f.supportsTouch)}c.listenerId&&f.decoupleListeners(c.listenerId);c.listenerId=++e;f.addListeners(c)}catch(i){GRUNT.Log.exception(i)}},
resetTouch:function(b){if(b&&b.id&&g[b.id]){g[b.id].release();delete g[b.id]}},Pannable:function(b){b=GRUNT.extend({container:null,onPan:null,onPanEnd:null,onAnimate:null,checkOffset:null},b);var c=false,f=new TILE5.Vector,i={pannable:true,getOffset:function(){return new TILE5.Vector(f.x,f.y)},setOffset:function(l,m){f.x=l;f.y=m},pan:function(l,m,n){if(n)i.updateOffset(f.x+l,f.y+m,n);else{i.updateOffset(f.x+l,f.y+m);b.onPan&&b.onPan(l,m)}},isAnimating:function(){return c},panEnd:function(l,m){b.onPanEnd&&
b.onPanEnd(l,m)},updateOffset:function(l,m,n){if(n){l=new TILE5.Vector(l,m);c=true;n=TILE5.Animation.tweenVector(f,l.x,l.y,n,function(){c=false;i.panEnd(0,0)});for(l=n.length;l--;){n[l].cancelOnInteract=true;n[l].requestUpdates(function(){b.onAnimate&&b.onAnimate(f.x,f.y)})}}else i.setOffset(l,m)}},o=document.getElementById(b.container);o&&TILE5.Touch.captureTouch(o,{moveHandler:function(l,m){i.pan(-l,-m)},moveEndHandler:function(l,m){i.panEnd(l,m)}});return i},Scalable:function(b){function c(t,y){i=
TILE5.V.getRect(t);o=TILE5.V.getRect(y);var z=TILE5.D.getSize(i.dimensions),D=TILE5.D.getSize(o.dimensions);r=TILE5.R.getCenter(o);l=i&&z!==0?D/z:1}b=GRUNT.extend({container:null,onAnimate:null,onPinchZoom:null,onScale:null,scaleDamping:false},b);var f=false,i=null,o=null,l=1,m=null,n=null,q=null,r=null,u={scalable:true,animate:function(t,y,z,D,F){function G(){F&&F();f=false;b.onScale&&b.onScale(l,r);l=1;m=null}f=true;q=TILE5.V.copy(y);r=TILE5.V.copy(z);i=null;if(D){n=l;TILE5.Animation.tweenValue(0,
t-n,D,G,1E3).requestUpdates(function(E){m=E/(t-n);l=n+E;b.onAnimate&&b.onAnimate()})}else{l=t;G()}},getScaleInfo:function(){return{factor:l,startRect:TILE5.R.copy(i),endRect:TILE5.R.copy(o),start:q,center:r,progress:m}},getScaling:function(){return f},getScaleFactor:function(){return l}},v=document.getElementById(b.container);v&&TILE5.Touch.captureTouch(v,{pinchZoomHandler:function(t,y){c(t,y);(f=l!==1)&&b.onPinchZoom&&b.onPinchZoom(t,y)},pinchZoomEndHandler:function(t,y){c(t,y);f=false;b.onScale&&
b.onScale(l,r,true);l=1},wheelZoomHandler:function(t){i=o=null;r=TILE5.V.copy(t)}});return u}}}();if(typeof jQuery!=="undefined"){jQuery.fn.canTouchThis=function(s){return this.each(function(){TILE5.Touch.captureTouch(this,s)})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(s){s.preventDefault()})}}
TILE5.Dispatcher=function(){var s=[],p={execute:function(k){var a=p.findAction(k);GRUNT.Log.info("looking for action id: "+k+", found: "+a);if(a){var j=[].concat(arguments).slice(0,1);GRUNT.Log.watch("EXECUTING ACTION: "+k,function(){a.execute(j)})}},findAction:function(k){for(var a=s.length;a--;)if(s[a].id==k)return s[a];return null},getRegisteredActions:function(){return[].concat(s)},getRegisteredActionIds:function(){for(var k=[],a=s.length;a--;)s[a].id&&k.push(s[a].id);return k},registerAction:function(k){k&&
k.id&&s.push(k)},Action:function(k){k=GRUNT.extend({autoRegister:true,id:"",title:"",icon:"",execute:null},k);var a={id:k.id,execute:function(){k.execute&&k.execute.apply(this,arguments)},getParam:function(j){return k[j]?k[j]:""},toString:function(){return String.format("{0} [title = {1}, icon = {2}]",a.id,k.title,k.icon)}};k.autoRegister&&p.registerAction(a);return a},createAgent:function(k){k=GRUNT.extend({name:"Untitled",trashOrphanedResults:true,translator:null,execute:null},k);var a=null,j={getName:function(){return k.name},
getParam:function(d){return k[d]},getId:function(){return GRUNT.toID(j.getName())},run:function(d,e){if(k.execute){var h=a=TILE5.Clock.getTime(true),g=k.translator?k.translator(d):d;k.execute.call(j,g,function(b,c){if(!k.trashOrphanedResults||h==a)e&&e(b,c,g)})}}};return j},runAgents:function(k,a,j){for(var d=0;d<k.length;d++)k[d].run(a,j)}};return p}();
TILE5.Animation=function(){function s(){if(a===0)a=setInterval(function(){var d;d=TILE5.Clock.getTime();if(!k){k=true;try{for(var e=0;e<p.length;)if(p[e].isComplete()){p[e].triggerComplete(false);p.splice(e,1);GRUNT.WaterCooler.say("animation.complete")}else{p[e].update(d);e++}}finally{k=false}}d=p.length;if(d===0){clearInterval(a);a=0}},20)}var p=[],k=false,a=0,j={DURATION:2E3,tweenValue:function(d,e,h,g,b){d=new j.Tween({startValue:d,endValue:e,tweenFn:h,complete:g,duration:b});p.push(d);return d},
tween:function(d,e,h,g,b,c){d=new j.Tween({target:d,property:e,endValue:h,tweenFn:g,duration:c,complete:b});p.push(d);return d},tweenVector:function(d,e,h,g,b,c){var f=[];if(d){var i=d.x==e,o=d.y==h;i||f.push(j.tween(d,"x",e,g,function(){(i=true)&&o&&b()},c));o||f.push(j.tween(d,"y",h,g,function(){o=true;i&&o&&b()},c))}return f},cancel:function(d){if(!k){k=true;try{for(var e=0;e<p.length;)if(!d||d(p[e])){GRUNT.Log.info("CANCELLING ANIMATION");p[e].triggerComplete(true);p.splice(e,1)}else e++}finally{k=
false}}},isTweening:function(){return p.length>0},Tween:function(d){d=GRUNT.extend({target:null,property:null,startValue:0,endValue:null,duration:j.DURATION,tweenFn:j.DEFAULT,complete:null,cancelOnInteract:false},d);var e=TILE5.Clock.getTime(),h=[],g=false,b=0,c=0,f={cancelOnInteract:d.cancelOnInteract,isComplete:function(){return g},triggerComplete:function(i){d.complete&&d.complete(i)},update:function(i){try{var o=d.tweenFn(i-e,b,c,d.duration);if(d.target)d.target[d.property]=o;for(var l=h.length;l--;)h[l](o,
void 0);if(g=e+d.duration<=i){if(d.target)d.target[d.property]=d.tweenFn(d.duration,b,c,d.duration);for(var m=h.length;m--;)h[m](o,true)}}catch(n){GRUNT.Log.exception(n)}},requestUpdates:function(i){h.push(i)}};b=d.target&&d.property&&d.target[d.property]?d.target[d.property]:d.startValue;if(typeof d.endValue!=="undefined")c=d.endValue-b;if(c==0)g=true;s();return f},Easing:function(){var d=1.70158;return{Linear:function(e,h,g,b){return g*e/b+h},Back:{In:function(e,h,g,b){return g*(e/=b)*e*((d+1)*
e-d)+h},Out:function(e,h,g,b){return g*((e=e/b-1)*e*((d+1)*e+d)+1)+h},InOut:function(e,h,g,b){return(e/=b/2)<1?g/2*e*e*(((d*=1.525)+1)*e-d)+h:g/2*((e-=2)*e*(((d*=1.525)+1)*e+d)+2)+h}},Bounce:{In:function(e,h,g,b){return g-j.Easing.Bounce.Out(b-e,0,g,b)+h},Out:function(e,h,g,b){return(e/=b)<1/2.75?g*7.5625*e*e+h:e<2/2.75?g*(7.5625*(e-=1.5/2.75)*e+0.75)+h:e<2.5/2.75?g*(7.5625*(e-=2.25/2.75)*e+0.9375)+h:g*(7.5625*(e-=2.625/2.75)*e+0.984375)+h},InOut:function(e,h,g,b){return e<b/2?j.Easing.Bounce.In(e*
2,0,g,b)/2+h:j.Easing.Bounce.Out(e*2-b,0,g,b)/2+g/2+h}},Cubic:{In:function(e,h,g,b){return g*(e/=b)*e*e+h},Out:function(e,h,g,b){return g*((e=e/b-1)*e*e+1)+h},InOut:function(e,h,g,b){if((e/=b/2)<1)return g/2*e*e*e+h;return g/2*((e-=2)*e*e+2)+h}},Elastic:{In:function(e,h,g,b,c,f){if(e==0)return h;if((e/=b)==1)return h+g;f||(f=b*0.3);if(!c||c<Math.abs(g)){c=g;g=f/4}else g=f/(2*Math.PI)*Math.asin(g/c);return-(c*Math.pow(2,10*(e-=1))*Math.sin((e*b-g)*2*Math.PI/f))+h},Out:function(e,h,g,b,c,f){var i;if(e==
0)return h;if((e/=b)==1)return h+g;f||(f=b*0.3);if(!c||c<Math.abs(g)){c=g;i=f/4}else i=f/(2*Math.PI)*Math.asin(g/c);return c*Math.pow(2,-10*e)*Math.sin((e*b-i)*2*Math.PI/f)+g+h},InOut:function(e,h,g,b,c,f){var i;if(e==0)return h;if((e/=b/2)==2)return h+g;f||(f=b*0.3*1.5);if(!c||c<Math.abs(g)){c=g;i=f/4}else i=f/(2*Math.PI)*Math.asin(g/c);if(e<1)return-0.5*c*Math.pow(2,10*(e-=1))*Math.sin((e*b-i)*2*Math.PI/f)+h;return c*Math.pow(2,-10*(e-=1))*Math.sin((e*b-i)*2*Math.PI/f)*0.5+g+h}},Quad:{In:function(e,
h,g,b){return g*(e/=b)*e+h},Out:function(e,h,g,b){return-g*(e/=b)*(e-2)+h},InOut:function(e,h,g,b){if((e/=b/2)<1)return g/2*e*e+h;return-g/2*(--e*(e-2)-1)+h}},Sine:{In:function(e,h,g,b){return-g*Math.cos(e/b*(Math.PI/2))+g+h},Out:function(e,h,g,b){return g*Math.sin(e/b*(Math.PI/2))+h},InOut:function(e,h,g,b){return-g/2*(Math.cos(Math.PI*e/b)-1)+h}}}}()};return GRUNT.extend(j,{DEFAULT:j.Easing.Back.Out})}();TILE5.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
TILE5.Graphics=function(){var s={NONE:0,ACTIVE:1,ANIMATING:4,PAN:8,PINCHZOOM:16,FREEZE:128},p=0,k={DisplayState:s,AnyDisplayState:255,ActiveDisplayStates:s.ACTIVE|s.ANIMATING,DefaultDisplayStates:s.ACTIVE|s.ANIMATING|s.PAN|s.PINCHZOOM,ViewLayer:function(a){a=GRUNT.extend({id:"",centerOnScale:true,created:(new Date).getTime(),scalePosition:true,zindex:0,supportFastDraw:false,validStates:k.DefaultDisplayStates},a);var j=null,d=a.id,e=GRUNT.extend({addToView:function(h){h.setLayer(d,e)},shouldDraw:function(h){var g=
j?j.fastDraw&&h!==s.ACTIVE:false;return(h&a.validStates)!==0&&(g?a.supportFastDraw:true)},cycle:function(){return 0},draw:function(){},remove:function(){GRUNT.WaterCooler.say("layer.remove",{id:d})},wakeParent:function(){GRUNT.WaterCooler.say("view.wake",{id:j?j.id:null})},getId:function(){return d},setId:function(h){d=h},getParent:function(){return j},setParent:function(h){j=h}},a);return e},AnimatedPathLayer:function(a){function j(c,f,i){c.fillStyle="#FFFFFF";c.strokeStyle="#222222";c.beginPath();
c.arc(i.x,i.y,4,0,Math.PI*2,false);c.stroke();c.fill()}a=GRUNT.extend({path:[],id:GRUNT.generateObjectID("pathAnimation"),easing:TILE5.Animation.Easing.Sine.InOut,validStates:k.ActiveDisplayStates|s.PAN|s.PINCHZOOM,drawIndicator:null,duration:2E3,autoCenter:false},a);var d=TILE5.V.edges(a.path),e,h=null,g=0;TILE5.Animation.tweenValue(0,d.total,a.easing,function(){b.remove()},a.duration).requestUpdates(function(c,f){g=c;f&&b.remove()});var b=GRUNT.extend(new k.ViewLayer(a),{cycle:function(){for(var c=
0;c<d.accrued.length&&d.accrued[c]<g;)c++;h=null;if(c<a.path.length-1){var f=g-(c>0?d.accrued[c-1]:0),i=a.path[c],o=a.path[c+1];e=TILE5.V.theta(i,o,d.edges[c]);h=TILE5.V.pointOnEdge(i,o,e,f);if(a.autoCenter)(c=b.getParent())&&c.centerOn(h)}return h?1:0},draw:function(c,f){if(h)(a.drawIndicator?a.drawIndicator:j)(c,f,new TILE5.Vector(h.x-f.x,h.y-f.y),e)}});return b},FPSLayer:function(a){a=GRUNT.extend({zindex:1E3,scalePosition:false},a);var j=null,d=GRUNT.extend(new k.ViewLayer(a),{delays:[],draw:function(e,
h,g){e.font="bold 8pt Arial";e.textAlign="right";e.fillStyle="rgba(0, 0, 0, 0.8)";e.fillText((j?j:"?")+" fps",g.width-20,20)}});setInterval(function(){for(var e=0,h=d.delays.length,g=h;g--;)e+=d.delays[g];if(h!==0)j=Math.floor(1E3/(e/h))},1E3);return d},ResourceStatsLayer:function(a){a=GRUNT.extend({zindex:500,indicatorSize:5,scalePosition:false,validStates:s.ACTIVE|s.PAN},a);return GRUNT.extend(new k.ViewLayer(a),{fps:null,draw:function(j){var d=TILE5.Resources.getStats(),e=a.indicatorSize,h=10,
g;if(d.imageCacheFullness){j.strokeStyle="rgba(0, 0, 255, 1)";j.beginPath();j.arc(15,15,5,0,Math.PI*2*d.imageCacheFullness,false);j.stroke();h=30}if(d.imageLoadingCount>=0){j.fillStyle="rgba(0, 255, 0, 0.7)";for(g=d.imageLoadingCount;g--;)j.fillRect(h+g*(e+2),10,e,e)}if(d.queuedImageCount>=0){j.fillStyle="rgba(255, 0, 0, 0.7)";for(g=d.queuedImageCount;g--;)j.fillRect(h+g*(e+2),10+e+2,e,e)}}})},LoadingLayer:function(a){GRUNT.extend({},a)},View:function(a){function j(x,A){A.setId(x);A.setParent(I);
b.push(A);b.sort(function(H,K){var L=K.zindex-H.zindex;if(L===0)L=K.created-H.created;return L})}function d(){GRUNT.WaterCooler.say("view.idle",{id:I.id});E=true;w=0}function e(x,A){var H=0,K=I.getScaleFactor(),L=I.getDisplayState(),U=(new Date).getTime(),S=(L&s.PINCHZOOM)!==0;l=I.getScaleFactor();var R=0;if(o||S){x.clearRect(0,0,c.width,c.height);o=false}if(S){var O=G.getScaleInfo();TILE5.D.getCenter(v);var Q=(O.progress?O.progress:1)/2;D=O.center;if(O.startRect){Q=TILE5.R.getCenter(O.startRect);
Q=TILE5.V.diff(Q,D);B=new TILE5.Vector(D.x+Q.x,D.y+Q.y)}else{O=TILE5.V.diff(O.start,D);B=new TILE5.Vector(D.x-O.x*Q,D.y-O.y*Q)}if(B)A=TILE5.V.offset(A,B.x,B.y)}x.save();try{if(r!==1)x.scale(r,r);else if(S){x.translate(D.x,D.y);x.scale(K,K)}for(R=b.length;R--;)if(b[R].shouldDraw(L)){var T=b[R].draw(x,A,v,L,I);H+=T?T:0}}finally{x.restore()}GRUNT.Log.trace("draw complete",U);return H}function h(){var x=0,A=P===s.PINCHZOOM||P===s.PAN;C=(new Date).getTime();i=F?F.getOffset():new TILE5.Vector;i.x=Math.floor(i.x);
i.y=Math.floor(i.y);z&&m&&z.delays.push(C-m);if(A){TILE5.Animation.cancel(function(K){return K.cancelOnInteract});E=false;if(w!==0){clearTimeout(w);w=0}}for(A=b.length;A--;){var H=b[A].cycle(C,i,P);x+=H?H:0}if(m+N<C){x+=e(f,i);m=C}J=0;if(y+x>0)g();else if(!E&&w===0)w=setTimeout(d,500);GRUNT.Log.trace("Completed draw cycle",C)}function g(){y++;if(!(q||J!==0)){y=0;J=setTimeout(h,0)}}a=GRUNT.extend({id:"view_"+p++,container:"",pannable:false,scalable:false,clearOnDraw:false,displayFPS:false,displayResourceStats:false,
scaleDamping:false,fastDraw:false,fillStyle:"rgb(200, 200, 200)",initialDrawMode:"source-over",bufferRefresh:100,defaultFreezeDelay:500,onPan:null,onPinchZoom:null,onScale:null,onDraw:null,autoSize:false},a);var b=[],c=document.getElementById(a.container),f=null,i=new TILE5.Vector,o=false,l=1,m=null,n=0,q=false,r=1,u=new TILE5.Vector,v=null,t=null,y=0,z=null,D=null,F=null,G=null,E=false,J=0,w=0,B=null,C=0,M=TILE5.Device.getConfig().targetFps,N=0,P=k.DisplayState.ACTIVE;GRUNT.Log.info("Creating a new view instance, attached to container: "+
a.container+", canvas = ",c);if(c){TILE5.Touch.resetTouch(c);if(a.autoSize){GRUNT.Log.info("autosizing view: window.height = "+window.innerHeight+", width = "+window.innerWidth);c.height=window.innerHeight-c.offsetTop;c.width=window.innerWidth-c.offsetLeft}try{f=c.getContext("2d");f.globalCompositeOperation=a.initialDrawMode;f.clearRect(0,0,c.width,c.height)}catch(V){GRUNT.Log.exception(V);throw Error("Could not initialise canvas on specified view element");}}if(a.pannable)F=new TILE5.Touch.Pannable({container:a.container,
onAnimate:function(){g()},onPan:function(x,A){n=TILE5.Clock.getTime(true);g();u=TILE5.V.offset(u,x,A);a.onPan&&a.onPan(x,A);P=s.PAN},onPanEnd:function(){g();P=s.ACTIVE}});if(a.scalable)G=new TILE5.Touch.Scalable({scaleDamping:a.scaleDamping,container:a.container,onAnimate:function(){P=k.DisplayState.PINCHZOOM;g()},onPinchZoom:function(x,A){n=TILE5.Clock.getTime(true);g();a.onPinchZoom&&a.onPinchZoom(x,A);P=k.DisplayState.PINCHZOOM},onScale:function(x,A){GRUNT.WaterCooler.say("view.scale",{id:I.id});
P=k.DisplayState.ACTIVE;g();a.onScale&&a.onScale(x,A)}});var I=GRUNT.extend({},a,F,G,{id:a.id,deviceScaling:r,fastDraw:a.fastDraw||TILE5.Device.getConfig().requireFastDraw,centerOn:function(x){F.setOffset(x.x-c.width/2,x.y-c.height/2)},getDimensions:function(){if(c)return new TILE5.Dimensions(c.width,c.height)},getZoomCenter:function(){return B},getLayer:function(x){for(var A=0;A<b.length;A++)if(b[A].getId()==x)return b[A];return null},setLayer:function(x,A){for(var H=0;H<b.length;H++)if(b[H].getId()===
x){b.splice(H,1);break}A&&j(x,A);GRUNT.WaterCooler.say("layer.update",{id:x});g()},eachLayer:function(x){for(var A=0;A<b.length;A++)x(b[A])},clearBackground:function(){o=true},freeze:function(){q=true},unfreeze:function(){q=false;g()},snapshot:function(){},getDisplayState:function(){return q?s.FROZEN:P},scale:function(x,A,H,K,L){K||(K=TILE5.D.getCenter(v));L||(L=TILE5.D.getCenter(v));G&&G.animate(x,K,L,A,H);return G},removeLayer:function(x){a:{for(var A=b.length;A--;)if(b[A].getId()==x){x=A;break a}x=
-1}if(x>=0&&x<b.length){GRUNT.WaterCooler.say("layer.removed",{layer:b[x]});b.splice(x,1)}}});v=I.getDimensions();t=TILE5.D.getCenter(v);if(M)N=Math.ceil(1E3/M);GRUNT.Log.info("redraw interval calaculated @ "+N);GRUNT.WaterCooler.listen("layer.remove",function(x){x.id&&I.removeLayer(x.id)});GRUNT.WaterCooler.listen("view.wake",function(x){if(!x.id||x.id===I.id)g()});r=TILE5.Device.getConfig().getScaling();if(a.displayFPS){z=new k.FPSLayer;I.setLayer("fps",z)}a.displayResourceStats&&I.setLayer("resourceStats",
new k.ResourceStatsLayer);g();return I}};return k}();
TILE5.Tiling=function(){function s(){if(!k){k=document.createElement("canvas");k.width=j.Config.TILESIZE;k.height=j.Config.TILESIZE;var d=k.getContext("2d");d.fillStyle="rgba(150, 150, 150, 0.025)";d.fillRect(0,0,k.width,k.height)}return k}function p(){function d(){var h=document.createElement("canvas");h.width=32;h.height=32;var g=h.getContext("2d");g.fillStyle="#BBBBBB";g.fillRect(0,0,32,32);g.fillStyle="#C3C3C3";g.fillRect(0,0,16,16);g.fillRect(16,16,16,16);return h}if(!a){a=document.createElement("canvas");
a.width=j.Config.TILESIZE;a.height=j.Config.TILESIZE;var e=a.getContext("2d");e.fillStyle=e.createPattern(d(),"repeat");e.fillRect(0,0,a.width,a.height)}return a}TileStore=function(d){d=GRUNT.extend({tileSize:null,gridSize:25,center:new TILE5.Vector,onPopulate:null},d);if(!d.tileSize)throw Error("Cannot create TileStore with an empty tile size");var e=Array(Math.pow(d.gridSize,2)),h=TILE5.V.offset(d.center,-Math.ceil(d.gridSize>>1)),g=null,b=new TILE5.Vector,c=null,f={getGridSize:function(){return d.gridSize},
getNormalizedPos:function(i,o){return TILE5.V.add(new TILE5.Vector(i,o),TILE5.V.invert(h),b)},getTileShift:function(){return TILE5.V.copy(b)},getTile:function(i,o){return i>=0&&i<d.gridSize?e[o*d.gridSize+i]:null},setTile:function(i,o,l){e[o*d.gridSize+i]=l},populate:function(i,o){var l=GRUNT.Log.getTraceTicks(),m=0,n=d.gridSize,q=d.tileSize;new TILE5.Vector(n/2,n/2);if(i){GRUNT.Log.info("populating grid, x shift = "+b.x+", y shift = "+b.y);for(var r=0;r<n;r++)for(var u=0;u<n;u++){if(!e[m]){var v=
i(u,r,h,n);v.gridX=u*q-b.x;v.gridY=r*q-b.y;e[m]=v}m++}}g=i;c=o;GRUNT.Log.trace("tile grid populated",l);d.onPopulate&&d.onPopulate()},getShiftDelta:function(i,o,l,m){var n=Math.floor(d.gridSize*0.2),q=new TILE5.Vector;if(i<0||i+l>d.gridSize)q.x=i<0?-n:n;if(o<0||o+m>d.gridSize)q.y=o<0?-n:n;return q},shift:function(i,o){if(!(i.x===0&&i.y===0)){var l=GRUNT.Log.getTraceTicks();GRUNT.Log.info("need to shift tile store grid, "+i.x+" cols and "+i.y+" rows.");var m=Array(e.length);m.length=e.length;for(var n=
0;n<d.gridSize;n++)for(var q=0;q<d.gridSize;q++)m[q*d.gridSize+n]=f.getTile(n+i.x,q+i.y);e=m;h=o?o(h,i):TILE5.V.add(h,i);b.x+=-i.x*d.tileSize;b.y+=-i.y*d.tileSize;GRUNT.Log.trace("tile storage shifted",l);f.populate(g,c)}},setOrigin:function(i,o){if(tileOrigin)shiftOrigin(i,o);else h=TILE5.V.offset(new TILE5.Vector(i,o),-tileHalfWidth)}};GRUNT.WaterCooler.listen("imagecache.cleared",function(){for(var i=e.length;i--;)if(e[i])e[i].loaded=false});GRUNT.WaterCooler.listen("tiler.repaint",function(){for(var i=
e.length;i--;)if(e[i]){e[i].x=null;e[i].y=null}});return f};var k=null,a=null,j={Config:{TILESIZE:256,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2},Tile:function(d){return d=GRUNT.extend({x:0,y:0,gridX:0,gridY:0,size:256},d)},ImageTile:function(d){d=GRUNT.extend({url:"",sessionParamRegex:null,loaded:false},d);return new j.Tile(d)},TileGrid:function(d){function e(t){if(u){var y=[],z=new TILE5.Vector(Math.floor((t.x+m.x)*b),Math.floor((t.y+m.y)*b));tilesNeeded=false;for(var D=r;D--;)for(var F=q;F--;){t=h.getTile(F+
z.x,D+z.y);var G=new TILE5.Vector(F-u.x,D-u.y);t||(l=h.getShiftDelta(z.x,z.y,q,r));y.push({tile:t,centerness:TILE5.V.absSize(G)})}y.sort(function(E,J){return J.centerness-E.centerness});i||(i=Array(y.length));for(t=y.length;t--;){i[t]=y[t].tile;v.prepTile(i[t])}}}d=GRUNT.extend({tileSize:TILE5.Tiling.Config.TILESIZE,drawGrid:false,center:new TILE5.Vector,shiftOrigin:null,supportFastDraw:true},d);var h=new TileStore(GRUNT.extend({tileSize:d.tileSize,onPopulate:function(){c=true;v.wakeParent()}},d)),
g=Math.round(d.tileSize/2),b=d.tileSize?1/d.tileSize:0,c=false,f=true,i=null,o=false;new TILE5.Vector;var l=new TILE5.Vector,m=new TILE5.Vector;TILE5.Device.getConfig();var n=h.getGridSize()*d.tileSize,q,r,u,v=GRUNT.extend(new TILE5.Graphics.ViewLayer(d),{gridDimensions:new TILE5.Dimensions(n,n),cycle:function(t,y,z){t=0;if(l.x+l.y!==0){h.shift(l,d.shiftOrigin);m=h.getTileShift();l=new TILE5.Vector;t++}z!==TILE5.Graphics.DisplayState.PINCHZOOM&&e(y);return t+c?1:0},deactivate:function(){f=false},
prepTile:function(){},drawTile:function(){return false},draw:function(t,y,z,D){if(f){var F=(new Date).getTime(),G=y.x;y=y.y;var E=true,J=D===TILE5.Graphics.DisplayState.PINCHZOOM||TILE5.Animation.isTweening();if(!u){q=Math.ceil(z.width*b)+1;r=Math.ceil(z.height*b)+1;u=new TILE5.Vector(Math.floor((q-1)/2),Math.floor((r-1)/2))}if(i){if(d.drawGrid)t.strokeStyle="rgba(50, 50, 50, 0.3)";t.beginPath();for(z=i.length;z--;){var w=i[z];if(w){var B=w.gridX-G,C=w.gridY-y;E=((J?false:w.x===B&&w.y===C)?false:
v.drawTile(t,w,B,C,D))&&E}else E=false;d.drawGrid&&t.rect(B,C,d.tileSize,d.tileSize)}t.stroke();GRUNT.Log.trace("drawn tiles",F);E&&!o&&GRUNT.WaterCooler.say("tiles.drawn",{id:v.getId()});o=E;c=false}}},getTileVirtualXY:function(t,y,z){t=h.getNormalizedPos(t,y);t=new TILE5.Vector(t.x*d.tileSize,t.y*d.tileSize);if(z){t.x+=g;t.y+=g}return t},populate:function(t){h.populate(t,function(){})}});GRUNT.WaterCooler.listen("tile.loaded",function(){c=true;v.wakeParent()});return v},ImageTileGrid:function(d){function e(){GRUNT.WaterCooler.say("tile.loaded")}
d=GRUNT.extend({},d);var h=s(),g=p();return GRUNT.extend(new j.TileGrid(d),{drawTile:function(b,c,f,i,o){var l=TILE5.Resources.getImage(c.url),m=false;if(l&&l.complete&&l.width>0){b.drawImage(l,f,i);m=true;c.x=f;c.y=i}else o===TILE5.Graphics.DisplayState.PAN?b.drawImage(g,f,i):b.drawImage(h,f,i);return m},prepTile:function(b){if(b)TILE5.Resources.getImage(b.url)||TILE5.Resources.loadImage(b.url,e)}})},Tiler:function(d){d=GRUNT.extend({container:"",drawCenter:false,onPan:null,onPanEnd:null,tapHandler:null,
doubleTapHandler:null,zoomHandler:null,onDraw:null,datasources:{},tileLoadThreshold:"first"},d);var e=new TILE5.Graphics.View(GRUNT.extend({},d,{pannable:true,scalable:true,scaleDamping:true}));TILE5.Touch.captureTouch(document.getElementById(d.container),d);GRUNT.extend(e,{getTileLayer:function(){return e.getLayer("grid0")},setTileLayer:function(h){e.setLayer("grid0",h);GRUNT.WaterCooler.say("grid.updated",{id:"grid0"})},viewPixToGridPix:function(h){var g=e.getOffset();return new TILE5.Vector(h.x+
g.x,h.y+g.y)},cleanup:function(){e.removeLayer("grid0")},repaint:function(){GRUNT.WaterCooler.say("tiler.repaint");GRUNT.WaterCooler.say("view.wake",{id:e.id})}});return e}};return j}();
TILE5.Geo=function(){function s(b,c){var f=null;for(var i in h)if(c){if(i==c&&h[i][b]){f=h[i];break}}else if(h[i][b]){f=h[i];break}return f}function p(b,c,f,i){var o=0;b=b.toUpperCase();for(var l in i){var m=c[l];if(m){var n=f[l];m=n?n(b,m):b.containsWord(m)?1:0;o+=m*i[l]}}return o}var k=[1.406245461070741,1.321415085624082,1.077179995861952,0.703119412486786,0.488332580888611],a=Math.PI/180,j=180/Math.PI,d=null,e={RD:"ROAD",ST:"STREET",CR:"CRESCENT",CRES:"CRESCENT",CT:"COURT",LN:"LANE",HWY:"HIGHWAY",
MWY:"MOTORWAY"},h={},g={Engine:function(b){if(!b.id)throw Error("A GEO.Engine cannot be registered without providing an id.");var c=GRUNT.extend({remove:function(){delete h[c.id]}},b);return h[c.id]=c},Radius:function(b,c){return{distance:parseInt(b,10),uom:c}},Position:function(b,c){return{lat:parseFloat(b?b:0),lon:parseFloat(c?c:0)}},BoundingBox:function(b,c){return{min:g.P.parse(b),max:g.P.parse(c)}},Address:function(b){return b=GRUNT.extend({streetDetails:"",location:"",country:"",postalCode:"",
pos:null,boundingBox:null},b)},GeocodeFieldWeights:{streetDetails:50,location:50},AddressCompareFns:{},Utilities:function(){var b={lat2pix:function(c,f){var i=parseFloat(c)*2*Math.PI/360;i=Math.sin(i);var o=0.08181919084262157*i;return Math.log((1+i)/(1-i)*Math.pow((1-o)/(1+o),0.08181919084262157))/2/f},lon2pix:function(c,f){return parseFloat(c)/180*Math.PI/f},pix2lon:function(c,f){return b.normalizeLon(c*f*180/Math.PI)},pix2lat:function(c,f){for(var i=Math.pow(Math.E,-c*f),o=b.mercatorUnproject(i),
l=b.findRadPhi(o,i),m=0;m<12&&Math.abs(o-l)>1.0E-7;){o=l;l=b.findRadPhi(o,i);m++}return l*180/Math.PI},mercatorUnproject:function(c){return Math.PI/2-2*Math.atan(c)},findRadPhi:function(c,f){var i=0.08181919084262157*Math.sin(c);return Math.PI/2-2*Math.atan(f*Math.pow((1-i)/(1+i),0.040909595421310785))},normalizeLon:function(c){for(;c<-180;)c+=360;for(;c>180;)c-=360;return c}};return b}(),GeoSearchResult:function(b){b=GRUNT.extend({id:null,caption:"",resultType:"",data:null,pos:null,matchWeight:0},
b);return GRUNT.extend(b,{toString:function(){return b.caption+(b.matchWeight?" ("+b.matchWeight+")":"")}})},GeoSearchAgent:function(b){b=GRUNT.extend({},b);return GRUNT.extend({},TILE5.Dispatcher.createAgent(b))},GeocodingAgent:function(b){b=GRUNT.extend({name:"Geocoding Search Agent",paramTranslator:null,execute:function(c,f){try{if(!c.reverse&&!c.freeform)address=new g.Address(c);var i=g.getEngine("geocode");if(i)i.geocode({addresses:[c.freeform?c.freeform:address],complete:function(l,m){if(f){var n=
m;if(c.freeform)n=g.rankGeocodeResponses(c.freeform,n,g.getEngine("geocode"));f(n,b)}}})}catch(o){GRUNT.Log.exception(o)}}},b);return new g.GeoSearchAgent(b)},PointOfInterest:function(b){b=GRUNT.extend({id:0,title:"",pos:null,lat:"",lon:"",group:"",retrieved:0,isNew:true},b);if(!b.pos&&b.lat&&b.lon)b.pos=new TILE5.Geo.Position(b.lat,b.lon);return GRUNT.extend({toString:function(){return b.id+": '"+b.title+"'"}},b)},POIStorage:function(b){function c(n){n=n?n:"default";o[n]||(o[n]=[]);return o[n]}function f(n){var q=
[];for(var r in o)for(var u=0;u<o[r].length;u++)if(!n||n(o[r][u]))q.push(o[r][u]);return q}function i(){GRUNT.WaterCooler.say("geo.pois-updated",{srcID:m.id,pois:m.getPOIs()})}b=GRUNT.extend({visibilityChange:null,onPOIDeleted:null,onPOIAdded:null},b);var o={},l=true,m={id:GRUNT.generateObjectID(),getPOIs:function(){return f()},getOldPOIs:function(n,q){return f(function(r){return r.group==n&&r.retrieved<q})},getVisible:function(){return l},setVisible:function(n){if(n!=l){l=n;b.visibilityChange&&b.visibilityChange()}},
findById:function(n){var q=f(function(r){return r.id==n});return q.length>0?q[0]:null},findByBounds:function(n){return f(function(q){return TILE5.Geo.P.inBounds(q.pos,n)})},addPOIs:function(n,q){if(q)o={};for(var r=0;n&&r<n.length;r++){n[r].retrieved=TILE5.Clock.getTime(true);var u=n[r];c(u.group).push(u)}},removeGroup:function(n){if(o[n]){delete o[n];i()}},update:function(n){var q=[],r=0,u=n.length>0?n[0].group:"",v=TILE5.Clock.getTime(true);for(r=0;r<n.length;r++){var t;a:{if(t=n[r])for(var y=c(t.group),
z=0;z<y.length;z++)if(y[z].id==t.id){t=y[z];break a}t=null}if(t){t.retrieved=v;t.isNew=false}else q.push(n[r])}n=m.getOldPOIs(u,v);m.addPOIs(q);for(r=0;b.onPOIAdded&&r<q.length;r++)b.onPOIAdded(q[r]);for(r=0;r<n.length;r++){b.onPOIDeleted&&b.onPOIDeleted(n[r]);u=n[r];v=c(u.group);for(t=0;t<v.length;t++)if(v[t].id==u.id){v.splice(t,1);break}}q.length+n.length>0&&i()}};return m},MapProvider:function(){return{zoomLevel:0,checkZoomLevel:function(b){return b},getCopyright:function(){},getMapTiles:function(){},
getPositionForXY:function(){return null}}},P:function(){var b={calcDistance:function(c,f){if(b.empty(c)||b.empty(f))return 0;var i=(f.lat-c.lat).toRad()/2,o=(f.lon-c.lon).toRad()/2;i=Math.sin(i)*Math.sin(i)+Math.cos(c.lat.toRad())*Math.cos(f.lat.toRad())*Math.sin(o)*Math.sin(o);return 6371*2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))},copy:function(c){return c?new g.Position(c.lat,c.lon):null},empty:function(c){return!c||c.lat===0&&c.lon===0},equal:function(c,f){return c&&f&&c.lat==f.lat&&c.lon==f.lon},
almostEqual:function(c,f){return c&&f&&Math.floor(c.lat*1E3)===Math.floor(f.lat*1E3)&&Math.floor(c.lon*1E3)===Math.floor(f.lon*1E3)},inArray:function(c,f){for(var i=g.P.equal,o=f.length;o--;)if(i(c,f[o]))return true;return false},inBounds:function(c,f){var i=!(g.P.empty(c)||g.P.empty(f));return i=(i=i&&c.lat>=f.min.lat&&c.lat<=f.max.lat)&&c.lon>=f.min.lon&&c.lon<=f.max.lon},parse:function(c){if(c)if(typeof c.lat!=="undefined")return b.copy(c);else{if(c.split)for(var f=[" ",","],i=0;i<f.length;i++){var o=
c.split(f[i]);if(o.length===2)return new g.Position(o[0],o[1])}}else return new g.Position;return null},parseArray:function(c){var f=c.length,i=Array(f);for(f=f;f--;)i[f]=b.parse(c[f]);GRUNT.Log.info("parsed "+i.length+" positions");return i},fromMercatorPixels:function(c,f,i){return new g.Position(TILE5.Geo.Utilities.pix2lat(f,i),TILE5.Geo.Utilities.normalizeLon(TILE5.Geo.Utilities.pix2lon(c,i)))},toMercatorPixels:function(c,f){return new TILE5.Vector(TILE5.Geo.Utilities.lon2pix(c.lon,f),TILE5.Geo.Utilities.lat2pix(c.lat,
f))},generalize:function(c,f,i){var o=c.length,l=[],m=null;i||(i=250);i/=1E3;GRUNT.Log.info("generalizing positions, must include "+f.length+" positions");for(var n=o;n--;)if(n===0)l.unshift(c[n]);else{var q=!m||g.P.inArray(c[n],f)?i:g.P.calcDistance(m,c[n]);if(c[n]&&q>=i){l.unshift(c[n]);m=c[n]}}GRUNT.Log.info("generalized "+o+" positions into "+l.length+" positions");return l},toString:function(c){return c?c.lat+" "+c.lon:""}};return b}(),B:function(){var b=-(Math.PI/2),c=Math.PI/2,f=-Math.PI*2,
i=Math.PI*2,o={calcSize:function(l,m,n){var q=new TILE5.Vector(0,m.lat-l.lat);if(typeof n==="undefined")n=true;q.x=n&&l.lon>m.lon?360-l.lon+m.lon:m.lon-l.lon;return q},createBoundsFromCenter:function(l,m){var n=m/6371,q=l.lat*a,r=l.lon*a,u=q-n,v=q+n;if(u>b&&v<c){q=Math.asin(Math.sin(n)/Math.cos(q));n=r-q;if(n<f)n+=2*Math.PI;r=r+q;if(r>i)r-=2*Math.PI}else{u=Math.max(u,b);v=Math.min(v,c);n=f;r=i}return new g.BoundingBox(new g.Position(u*j,n*j),new g.Position(v*j,r*j))},expand:function(l,m){return new g.BoundingBox(new g.Position(l.min.lat-
m,l.min.lon-g.Utilities.normalizeLon(m)),new g.Position(l.max.lat+m,l.max.lon+g.Utilities.normalizeLon(m)))},forPositions:function(l,m){var n=null,q=TILE5.Clock.getTime();m||(m="auto");for(var r=l.length;r--;)if(n){var u=o.calcSize(n.min,l[r],false),v=o.calcSize(l[r],n.max,false);if(u.x<0)n.min.lon=l[r].lon;if(u.y<0)n.min.lat=l[r].lat;if(v.x<0)n.max.lon=l[r].lon;if(v.y<0)n.max.lat=l[r].lat}else n=new TILE5.Geo.BoundingBox(l[r],l[r]);if(m){if(m=="auto"){r=o.calcSize(n.min,n.max);m=Math.max(r.x,r.y)*
0.3}n=o.expand(n,m)}GRUNT.Log.trace("calculated bounds for "+l.length+" positions",q);return n},getCenter:function(l){var m=g.B.calcSize(l.min,l.max);return new TILE5.Geo.Position(l.min.lat+m.y/2,l.min.lon+m.x/2)},getZoomLevel:function(l,m){var n=o.getCenter(l);n=k[Math.min(Math.round(Math.abs(n.lat)*0.05),k.length)];var q=o.calcSize(l.min,l.max);return Math.min(Math.ceil(Math.log(k[3]*m.height/q.y)/Math.log(2)),Math.ceil(Math.log(n*m.width/q.x)/Math.log(2)))},isEmpty:function(l){return!l||g.P.empty(l.min)||
g.P.empty(l.max)},toString:function(l){return"min: "+g.P.toString(l.min)+", max: "+g.P.toString(l.max)}};return o}(),A:function(){var b=/^(\d+).*$/,c=/(\d+)\s?\-\s?(\d+)/;return{buildingMatch:function(f,i){b.lastIndex=-1;if(b.test(f))for(var o=f.replace(b,"$1"),l=i.split(","),m=0;m<l.length;m++){c.lastIndex=-1;if(c.test(l[m])){var n=c.exec(l[m]);if(o>=parseInt(n[1],10)&&o<=parseInt(n[2],10))return true}else if(o==l[m])return true}return false},normalize:function(f){if(!f)return"";f=f.toUpperCase();
if(!d){var i=[];for(var o in e)i.push(o);d=RegExp("(\\s)("+i.join("|")+")(\\s|$)","i")}d.lastIndex=-1;if(i=d.exec(f))f=f.replace(d,"$1"+e[i[2]]);return f},toString:function(f){return f.streetDetails+" "+f.location}}}(),getEngine:function(b){for(var c=null,f=1;!c&&f<arguments.length;f++)c=s(b,arguments[f]);c=c?c:s(b);if(!c)throw Error("Unable to find GEO engine with "+b+" capability");return c},rankGeocodeResponses:function(b,c,f){var i=[],o=g.AddressCompareFns;if(f&&f.compareFns)o=GRUNT.extend({},
o,f.compareFns);for(f=0;f<c.length;f++)i.push(new g.GeoSearchResult({caption:c[f].toString(),data:c[f],pos:c[f].pos,matchWeight:p(b,c[f],o,g.GeocodeFieldWeights)}));i.sort(function(l,m){return m.matchWeight-l.matchWeight});return i}};return g}();
TILE5.Geo.Location=function(){function s(a){function j(c){try{var f=new TILE5.Geo.Position(c.coords.latitude,c.coords.longitude),i=GRUNT.isPlainObject(c.coords.accuracy)&&c.coords.accuracy.horizontal?c.coords.accuracy.horizontal:c.coords.accuracy;GRUNT.Log.info("got position coordinates: "+f+", accuracy = "+i);if(a.successCallback&&(!g||i<b))a.successCallback(f,h,c);if(i>a.highAccuracyCutoff&&h<2){h=2;a.enableHighAccuracy=true;GRUNT.Log.info("Position not at required accuracy, trying again with high accuracy");
e()}g=c;b=i}catch(o){GRUNT.Log.exception(o)}}function d(c){if(c.code===c.PERMISSION_DENIED)a.errorCallback&&a.errorCallback(c);else if(c.code===c.POSITION_UNAVAILABLE)a.errorCallback&&a.errorCallback(c);else if(c.code===c.TIMEOUT){GRUNT.Log.info("had a timeout on cached position, moving to phase 1");if(a.timeout===0&&a.autoPhasing){h=1;a.timeout=p;a.enableHighAccuracy=false;e()}}}function e(){navigator.geolocation.getCurrentPosition(j,d,a)}a=GRUNT.extend({autoPhasing:true,maximumAge:3E5,timeout:0,
highAccuracyCutoff:10,enableHighAccuracy:true,successCallback:null,errorCallback:null},a);var h=0,g=null,b=1E6;e()}var p=3E3,k={get:function(){throw Error("No geolocation APIs supported.");}};if(navigator.geolocation)k.get=s;return k}();TILE5.Geo.Search=function(){return{bestResults:function(s,p){p||(p=20);for(var k=s.length>0?s[0]:null,a=[],j=0;j<s.length;j++)if(k.matchWeight-s[j].matchWeight<=p)a.push(s[j]);else break;return a}}}();
TILE5.Geo.Routing=function(){var s={calculate:function(p){p=GRUNT.extend({engineId:"",waypoints:[],map:null,error:null,autoFit:true,success:null,generalize:true},p);GRUNT.Log.info("attempting to calculate route");var k=TILE5.Geo.getEngine("route");k&&k.route(p,function(a){if(p.generalize)a.geometry=TILE5.Geo.P.generalize(a.geometry,a.getInstructionPositions());if(p.map){s.createMapOverlay(p.map,a);if(p.autoFit){GRUNT.Log.info("AUTOFITTING MAP TO ROUTE: bounds = "+a.boundingBox);p.map.gotoBounds(a.boundingBox)}}p.success&&
p.success(a)})},createMapOverlay:function(p,k){var a=p.getDimensions();a=new TILE5.Geo.UI.RouteOverlay({data:k,width:a.width,height:a.height});p.setLayer("route",a)},Maneuver:{None:0,Continue:1,TurnLeft:100,TurnLeftSlight:101,TurnLeftSharp:102,TurnRight:110,TurnRightSlight:111,TurnRightSharp:112,TurnAround:190,EnterRoundabout:200,ExitRamp:300},Instruction:function(p){p=GRUNT.extend({position:null,description:"",manuever:s.Maneuver.None},p);return GRUNT.extend(p,{})},RouteData:function(p){p=GRUNT.extend({geometry:[],
instructions:[],boundingBox:null},p);if(!p.boundingBox)p.boundingBox=TILE5.Geo.B.forPositions(p.geometry);return GRUNT.extend({getInstructionPositions:function(){for(var k=[],a=0;a<p.instructions.length;a++)p.instructions[a].position&&k.push(p.instructions[a].position);return k}},p)}};return s}();
TILE5.Geo.UI=function(){function s(a){a=GRUNT.extend({size:12,zindex:150,scalePosition:false,validStates:TILE5.Graphics.DisplayState.ACTIVE|TILE5.Graphics.DisplayState.ANIMATING|TILE5.Graphics.DisplayState.PAN},a);var j=null,d=function(){var e=document.createElement("canvas");e.width=a.size*4;e.height=a.size*4;var h=e.getContext("2d"),g=new TILE5.Vector(e.width/2,e.height/2),b=a.size,c=["#FFFFFF","#333333"],f=[3,1.5];h.lineCap="round";for(var i=0;i<c.length;i++){var o=b;h.lineWidth=f[i];h.strokeStyle=
c[i];h.beginPath();h.moveTo(g.x,g.y-o);h.lineTo(g.x,g.y+o);h.moveTo(g.x-o,g.y);h.lineTo(g.x+o,g.y);h.arc(g.x,g.y,b*0.6666,0,2*Math.PI,false);h.stroke()}return e}();return GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{draw:function(e,h,g){if(!j){j=TILE5.D.getCenter(g);j=new TILE5.Vector(Math.round(j.x-d.width/2),Math.round(j.y-d.height/2))}e.drawImage(d,j.x,j.y)}})}var p=0,k={AnnotationTween:null,GeoTileGrid:function(a){a=GRUNT.extend({grid:null,centerPos:new TILE5.Geo.Position,centerXY:new TILE5.Vector,
radsPerPixel:0},a);var j=TILE5.Geo.P.toMercatorPixels(a.centerPos,a.radsPerPixel),d=j.x-a.centerXY.x,e=j.y-a.centerXY.y,h=GRUNT.extend({},a.grid,{getBoundingBox:function(g,b,c,f){return new TILE5.Geo.BoundingBox(h.pixelsToPos(new TILE5.Vector(g,b+f)),h.pixelsToPos(new TILE5.Vector(g+c,b)))},getGridXYForPosition:function(g){g=TILE5.Geo.P.toMercatorPixels(g,a.radsPerPixel);return new TILE5.Vector(g.x-d,h.gridDimensions.height-(g.y-e))},pixelsToPos:function(g){return TILE5.Geo.P.fromMercatorPixels(d+
g.x,e+h.gridDimensions.height-g.y,a.radsPerPixel)}});return h},RouteOverlay:function(a){a=GRUNT.extend({data:null,pixelGeneralization:8,calculationsPerCycle:250,partialDraw:false,strokeStyle:"rgba(0, 51, 119, 0.9)",waypointFillStyle:"#FFFFFF",lineWidth:4,zindex:50},a);var j=true,d=null,e=[],h=0,g=[],b=[],c=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{getAnimation:function(f,i,o,l){if(j)return null;var m="routeAnimation"+p++;b.push(m);return new TILE5.Graphics.AnimatedPathLayer({id:m,path:e,zindex:a.zindex+
1,easing:f?f:TILE5.Animation.Easing.Sine.InOut,duration:i?i:5E3,drawIndicator:o,autoCenter:l?l:false})},draw:function(f,i,o,l,m){o=0;l=a.data?a.data.geometry:null;if(j){j=false;d=null;e=[];h=0}if(l&&h<l.length){a:{m=m.getTileLayer();g=[];if(m){l=GRUNT.Log.getTraceTicks();var n,q,r,u=a.data?a.data.geometry:[],v=u.length,t=a.data?a.data.instructions:[],y=t.length,z=a.calculationsPerCycle,D=0;for(n=h;n<v;n++){q=m.getGridXYForPosition(u[n]);if(r=!d||n===0||Math.abs(q.x-d.x)+Math.abs(q.y-d.y)>a.pixelGeneralization){e.push(q);
d=q}D++;if(D>=z){h=n;break a}}h=v;GRUNT.Log.trace(v+" geometry points generalized to "+e.length+" coordinates",l);d=null;for(n=y;n--;)if(t[n].position){q=m.getGridXYForPosition(t[n].position);if(r=!d||n===0||Math.abs(q.x-d.x)+Math.abs(q.y-d.y)>a.pixelGeneralization){g.push(q);d=q}}}}o++}m=e.length;if(m>0&&(!o||a.partialDraw)){f.strokeStyle=a.strokeStyle;f.lineWidth=a.lineWidth;f.beginPath();f.moveTo(e[m-1].x-i.x,e[m-1].y-i.y);for(m=m;m--;)f.lineTo(e[m].x-i.x,e[m].y-i.y);f.stroke();f.fillStyle=a.waypointFillStyle;
for(m=g.length;m--;){f.beginPath();f.arc(g[m].x-i.x,g[m].y-i.y,2,0,Math.PI*2,false);f.stroke();f.fill()}}return o}});GRUNT.WaterCooler.listen("grid.updated",function(){for(var f=b.length;f--;)GRUNT.WaterCooler.say("layer.remove",{id:b[f]});b=[];j=true;c.wakeParent()});return c},Annotation:function(a){a=GRUNT.extend({xy:null,pos:null,draw:null,tweenIn:k.AnnotationTween,animationSpeed:null},a);var j=false,d={xy:a.xy,pos:a.pos,isNew:true,isAnimating:function(){return j},draw:function(e,h,g,b){if(d.xy){if(d.isNew&&
a.tweenIn){var c=d.xy.y;d.xy.y=h.y-20;j=true;TILE5.Animation.tween(d.xy,"y",c,a.tweenIn,function(){d.xy.y=c;j=false},a.animationSpeed?a.animationSpeed:250+Math.random()*500)}if(a.draw)a.draw(e,h,new TILE5.Vector(d.xy.x-h.x,d.xy.y-h.y),g,b);else{e.beginPath();e.arc(d.xy.x-h.x,d.xy.y-h.y,4,0,Math.PI*2,false);e.fill()}d.isNew=false}}};return d},ImageAnnotation:function(a){a=GRUNT.extend({imageUrl:null,animatingImageUrl:null,imageAnchor:null},a);var j=a.imageAnchor?TILE5.V.invert(a.imageAnchor):null;
a.draw=function(e,h,g,b,c){if(a.animatingImageUrl&&d.isAnimating()){TILE5.Resources.loadImage(a.imageUrl);b=a.animatingImageUrl}else b=a.imageUrl;if(h=TILE5.Resources.getImage(b)){if(h.complete&&h.width>0){j||(j=new TILE5.Vector(-h.width>>1,-h.height>>1));g=TILE5.V.offset(g,j.x,j.y);e.drawImage(h,g.x,g.y,h.width,h.height)}}else TILE5.Resources.loadImage(b,function(){c.wakeParent()})};var d=new k.Annotation(a);return d},AnnotationsOverlay:function(a){function j(b){for(var c=a.map?a.map.getTileLayer():
null,f=0;c&&f<b.length;f++)b[f].xy=c.getGridXYForPosition(b[f].pos)}a=GRUNT.extend({pois:null,map:null,createAnnotationForPOI:null,zindex:100},a);var d=[],e=false,h=[],g=GRUNT.extend(new TILE5.Graphics.ViewLayer(a),{cycle:function(){return e?1:0},draw:function(b,c,f,i){e=false;b.fillStyle="rgba(255, 0, 0, 0.75)";b.globalCompositeOperation="source-over";for(f=d.length;f--;){d[f].draw(b,c,i,g);e=e||d[f].isAnimating()}for(f=h.length;f--;){h[f].draw(b,c,i,g);e=e||h[f].isAnimating()}return e?1:0},add:function(b){h.push(b);
j(h);g.wakeParent()},clear:function(b){h=[];j(h);if(b){d=[];j(d)}g.wakeParent()}});GRUNT.WaterCooler.listen("geo.pois-updated",function(b){if(a.pois&&a.pois.id==b.srcID){b=b.pois;try{d=[];for(var c=0;c<b.length;c++)if(b[c].pos){var f;var i=b[c];if(i&&i.pos){var o=null;if(o=a.createAnnotationForPOI?a.createAnnotationForPOI(i):new k.Annotation({pos:i.pos})){o.isNew=i.isNew;i.isNew=false}f=o}else f=void 0;f&&d.push(f)}j(d)}catch(l){GRUNT.Log.exception(l)}g.wakeParent()}});GRUNT.WaterCooler.listen("grid.updated",
function(){j(d);j(h);g.wakeParent()});return g},Tiler:function(a){a=GRUNT.extend({tapExtent:10,provider:null,crosshair:true,copyright:undefined,zoomLevel:0,boundsChange:null,tapPOI:null,tapHandler:null,boundsChangeThreshold:30,pois:new TILE5.Geo.POIStorage,createAnnotationForPOI:null,onTilesLoaded:null},a);if(typeof a.copyright==="undefined")a.copyright=a.provider?a.provider.getCopyright():"";var j=new TILE5.Vector,d=a.copyright,e=false,h=[],g=0,b=null,c=null,f=a.zoomLevel,i=a.tapHandler;if(!a.provider)a.provider=
new TILE5.Geo.MapProvider;var o=new TILE5.Tiling.Tiler(GRUNT.extend({},a,{tapHandler:function(m,n){var q=l.getTileLayer(),r=null;if(q){r=l.viewPixToGridPix(new TILE5.Vector(n.x,n.y));var u=q.pixelsToPos(r),v=q.pixelsToPos(TILE5.V.offset(r,-a.tapExtent,a.tapExtent)),t=q.pixelsToPos(TILE5.V.offset(r,a.tapExtent,-a.tapExtent));GRUNT.Log.info("grid tapped @ "+TILE5.Geo.P.toString(q.pixelsToPos(r)));r=new TILE5.Geo.BoundingBox(v,t);h=l.pois.findByBounds(r);a.tapPOI&&a.tapPOI(h)}i&&i(m,n,u,r)},doubleTapHandler:function(m,
n){l.animate(2,TILE5.D.getCenter(l.getDimensions()),new TILE5.Vector(n.x,n.y),TILE5.Animation.Easing.Sine.Out)},onScale:function(m,n){var q=0;m=Math.sqrt(m);if(m<1)q=-(0.5/m);else if(m>1)q=m;l.gotoPosition(l.getXYPosition(n),f+Math.floor(q))}})),l=GRUNT.extend({},o,{pois:a.pois,annotations:null,getBoundingBox:function(){var m=l.getTileLayer(),n=l.getOffset(),q=l.getDimensions();if(m)return m.getBoundingBox(n.x,n.y,q.width,q.height);return null},getCenterPosition:function(){return l.getXYPosition(TILE5.D.getCenter(l.gridDimensions))},
getXYPosition:function(m){return l.getTileLayer().pixelsToPos(l.viewPixToGridPix(m))},gotoBounds:function(m,n){var q=TILE5.Geo.B.getZoomLevel(m,l.getDimensions());l.gotoPosition(TILE5.Geo.B.getCenter(m),q,n)},gotoCurrentPosition:function(m){TILE5.Geo.Location.get({successCallback:function(n){l.clearBackground();l.gotoPosition(n,15,m)},errorCallback:function(){}})},gotoPosition:function(m,n,q){var r=f,u=(new Date).getTime(),v=false,t=l.getBoundingBox();if(t){t=TILE5.Geo.B.getCenter(t);t=TILE5.Geo.P.calcDistance(t,
m);GRUNT.Log.info("distance between current position and new position = "+t);if(t>100)v=true}f=n?n:f;if(!f)throw"Zoom level required to goto a position.";if(a.provider)f=a.provider.checkZoomLevel(f);if(v||!e||f!==r){TILE5.Resources.resetImageLoadQueue();(n=l.getTileLayer())&&n.deactivate();TILE5.Animation.cancel();e&&l.freeze();g=u;a.provider.zoomLevel=f;a.provider.getMapTiles(l,m,function(y){if(u===g){l.setTileLayer(y);c=y.getId();l.panToPosition(m,function(){l.unfreeze();q&&q()})}else GRUNT.Log.info("request time mismatch - ignoring update")});
e=true}else l.panToPosition(m,q)},panToPosition:function(m,n,q){var r=l.getTileLayer();if(r){m=r.getGridXYForPosition(m);r=l.getDimensions();m.x-=r.width/2;m.y-=r.height/2;if(b)b=null;l.updateOffset(m.x,m.y,q);GRUNT.WaterCooler.say("view.wake",{id:l.id});a.boundsChange&&a.boundsChange(l.getBoundingBox());n&&n(l)}},setZoomLevel:function(m){l.gotoPosition(l.getCenterPosition(),m)},zoomIn:function(){l.scale(2,TILE5.Animation.Easing.Sine.Out)||l.setZoomLevel(f+1)},zoomOut:function(){l.scale(0.5,TILE5.Animation.Easing.Sine.Out)||
l.setZoomLevel(f-1)},animateRoute:function(m,n,q,r){var u=l.getLayer("route");if(u)(m=u.getAnimation(m,n,q,r))&&m.addToView(l)}},o);o=new TILE5.Geo.UI.AnnotationsOverlay({pois:l.pois,map:l,createAnnotationForPOI:a.createAnnotationForPOI});l.annotations=o;l.setLayer("annotations",o);a.crosshair&&l.setLayer("crosshair",new s);d&&l.setLayer("copyright",new TILE5.Graphics.ViewLayer({zindex:999,draw:function(m,n,q){m.lineWidth=2.5;m.fillStyle="rgb(50, 50, 50)";m.strokeStyle="rgba(255, 255, 255, 0.8)";
m.font="bold 10px sans";m.textBaseline="bottom";m.strokeText(d,10,q.height-10);m.fillText(d,10,q.height-10)}}));GRUNT.WaterCooler.listen("view.idle",function(m){if(m.id&&m.id==l.id)if(TILE5.V.absSize(TILE5.V.diff(j,l.getOffset()))>a.boundsChangeThreshold&&a.boundsChange){j=l.getOffset();a.boundsChange(l.getBoundingBox())}});GRUNT.WaterCooler.listen("tiles.drawn",function(m){m.id&&m.id==c&&a.onTilesLoaded&&a.onTilesLoaded()});return l}};return k}();
