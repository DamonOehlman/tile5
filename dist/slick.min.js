/*!
 * Sidelab Slick Javascript Library v0.2.1

 * http://sidelab.com/projects/slick/
 *
 * Copyright 2010, Damon Oehlman
 * Licensed under the MIT licence
 * http://sidelab.com/projects/slick/license
 *
 * Date: ${date}
 */
 /* initialise javascript extensions */

if (! String.format) {
    String.format = function( text )
if(!String.format)String.format=function(c){if(arguments.length<=1)return c;for(var a=arguments.length-2,e=0;e<=a;e++)c=c.replace(new RegExp("\\{"+e+"\\}","gi"),arguments[e+1]);return c};if(!Number.toRad)Number.prototype.toRad=function(){return this*Math.PI/180};if(!Number.sec)Number.prototype.sec=function(){return 1/Math.cos(this)};var SLICK={};
SLICK.Logger=function(){var c=jQuery("#console").get(0),a=["debug","info","warn","error"],e=[],d=false,f=0,h={LOGLEVEL_DEBUG:0,LOGLEVEL_INFO:1,LOGLEVEL_WARN:2,LOGLEVEL_ERROR:3,displayToggle:function(){(d=!d)?jQuery("ul#console").slideDown():jQuery("ul#console").slideUp();if(d)f=setInterval(function(){for(var j="",g=e.length-1;g>=0&&g>=e.length-20;){j+="<li class='"+e[g].clsName+"'>"+e[g].msg+"</li>";g--}jQuery(c).html(j)},2E3);else clearInterval(f)},log:function(j,g){g||(g=1);var b=a[1];if(g<a.length)b=
a[g];e.push({time:(new Date).getTime(),lvl:g,clsName:b,msg:j});console&&console.info(j)},debug:function(j){h.log(j,h.LOGLEVEL_DEBUG)},info:function(j){h.log(j,h.LOGLEVEL_INFO)},warn:function(j){h.log(j,h.LOGLEVEL_WARN)},error:function(j){h.log(j,h.LOGLEVEL_ERROR)},exception:function(j){h.log("EXCEPTION: "+j.message,h.LOGLEVEL_ERROR);j.stack&&h.log("STACK TRACE: "+j.stack,h.LOGLEVEL_ERROR)}};return h};
SLICK.Vector=function(c,a){c||(c=0);a||(a=0);var e={x:c,y:a,add:function(d){e.x+=d.x;e.y+=d.y},copy:function(d){e.x=d.x;e.y=d.y},offset:function(d,f){return new SLICK.Vector(e.x+d,e.y+f)},toString:function(){return e.x+", "+e.y}};return e};SLICK.Dimensions=function(c,a){var e=a?c/a:1,d={width:c,height:a,aspect_ratio:e,inv_aspect_ratio:1/e,getCenter:function(){return new SLICK.Vector(d.width*0.5,d.height*0.5)}};return d};var LOGGER=null;jQuery(document).ready(function(){LOGGER=new SLICK.Logger});
SLICK.Touches=function(){var c=[];return{addTouch:function(a){c.push(a)},calculateDelta:function(a){return(a=a.getTouch(0))?new SLICK.Vector(c[0].x-a.x,c[0].y-a.y):new SLICK.Vector},getDistance:function(){var a=0;if(c.length>1){a=Math.abs(c[0].x-c[1].x);var e=Math.abs(c[0].y-c[1].y);a=Math.sqrt(a*a+e*e)}return a},getTouch:function(a){a||(a=0);if(c.length>a)return c[a]},getTouchCount:function(){return c.length},toString:function(){for(var a="",e=0;e<c.length;e++)a+="["+c[e]+"]";return a}}};
SLICK.TouchHelper=function(c){var a={GLOBAL:"touches",TARGET:"targetTouches",CHANGED:"changedTouches"},e=[a.GLOBAL,a.TARGET],d={TAP:0,MOVE:1,PINCHZOOM:2},f=null,h=null,j=null,g=null,b=null,l={current:0,last:0},k={args:jQuery.extend({},{touchStartHandler:null,moveHandler:null,moveEndHandler:null,pinchZoomHandler:null,pinchZoomEndHandler:null,tapHandler:null,doubleTapHandler:null},c),THRESHOLD_DOUBLETAP:300,getTouchPoints:function(i,m){var p=new SLICK.Touches;m||(m=e);if(i.originalEvent)i=i.originalEvent;
var q=null,t=0;for(t=0;t<m.length;t++){var v=m[t];if(i[v]&&i[v].length>0){q=i[v];break}}for(t=0;q&&t<q.length;t++)p.addTouch(new SLICK.Vector(q[t].pageX,q[t].pageY));return p},start:function(i){f=k.getTouchPoints(i);h=k.getTouchPoints(i);j=new SLICK.Vector;g=new SLICK.Vector;l.current=(new Date).getTime();if(k.args.touchStartHandler){i=f.getTouch();k.args.touchStartHandler(i.x,i.y)}if(l.current-l.last<k.THRESHOLD_DOUBLETAP&&k.args.doubleTapHandler)(i=f.getTouch(0))&&k.args.doubleTapHandler(i.x,i.y);
b=d.TAP},move:function(i){i=k.getTouchPoints(i);var m=0;if(i.getTouchCount()>1)m=h.getDistance()-f.getDistance();if(b===d.TAP){var p=i.calculateDelta(f);if(Math.abs(p.x)>=7||Math.abs(p.y)>=7)b=d.MOVE}if(b!==d.TAP)if(m==0){j=i.calculateDelta(h);g.add(j);k.args.moveHandler&&k.args.moveHandler(j.x,j.y);b=d.MOVE}else if(k.args.pinchZoomHandler){k.args.pinchZoomHandler(m);b=d.PINCHZOOM}h=i},end:function(){l.last=l.current;if(b===d.TAP&&k.args.tapHandler){var i=f.getTouch(0);k.args.tapHandler(i.x,i.y)}else if(b==
d.MOVE&&k.args.moveEndHandler)k.args.moveEndHandler(g.x,g.y);else b==d.ZOOM&&k.args.pinchZoomEndHandler&&k.args.pinchZoomEndHandler(0)}};return k};
jQuery.fn.canTouchThis=function(c){var a=jQuery.extend({preventDefault:true},c),e=new SLICK.TouchHelper(c);return this.bind("touchstart",function(d){a.preventDefault&&d.preventDefault();try{e.start(d)}catch(f){LOGGER.exception(f)}}).bind("touchmove",function(d){a.preventDefault&&d.preventDefault();try{e.move(d)}catch(f){LOGGER.exception(f)}}).bind("touchend",function(d){a.preventDefault&&d.preventDefault();try{e.end(d)}catch(f){LOGGER.exception(f)}}).bind("mousewheel",function(d){d.preventDefault();
LOGGER.info("Got a mouse wheel event")})};jQuery.fn.untouchable=function(){return this.bind("touchmove",function(c){c.preventDefault()})};SLICK.DisplayOpts={ajaxActivityImage:null};
SLICK.InfoBox=function(c){function a(){return jQuery("#"+h)}function e(i){for(var m=i?i.className.split(" "):[],p=0;p<m.length;p++){var q=/^button\_(\d+)$/.exec(m[p]);if(q){q=parseInt(q[1],10);q>=0&&q<k.buttons.length&&k.buttons[q].click&&k.buttons[q].click(i)}}}function d(){var i=a().find(".box-buttons");i.html("");for(var m=0;m<k.buttons.length;m++){i.append(String.format("<a href='#' class='button_{0} {1}'>{2}</a>",m,k.buttons[m].align?k.buttons[m].align:"",k.buttons[m].text));i.find(".button_"+
m).click(function(){try{e(this)}catch(p){LOGGER.exception(p)}})}}function f(){var i=/.*?\sDETAILS$/i;a().find("a").each(function(){var m=jQuery(this).text();if(i.test(m))jQuery(this).text((j?"Hide":"Show")+" Details")})}var h="box_"+(new Date).getTime(),j=false;c=jQuery.extend({},{content:"",buttons:[],position:"top",classes:[]},c);for(var g=null,b=[c.position,"top","bottom"],l=0;!g&&l<b.length;l++)g=jQuery("#container-"+b[l]).get(0);jQuery(g).append(String.format("<div id='{0}' class='infobox {2}'><div class='box-content'>{1}</div><div class='box-details'>I'm some details</div><div class='box-buttons'></div></div>",
h,c.content,c.classes.join(" ")));var k={buttons:c.buttons,getId:function(){return h},getDetailsVisible:function(){return j},setButtons:function(i){k.buttons=i;d()},show:function(){var i=a();i.slideDown("normal",function(){i.find(".box-buttons").show()})},hide:function(){var i=a();i.find(".box-buttons").hide();i.find(".box-details").hide();i.slideUp("normal")},showDetails:function(i,m){a().find(".box-details").html(i).slideDown("fast",function(){j=true;f();m&&m()})},hideDetails:function(i){a().find(".box-details").slideUp("fast",
function(){jQuery(this).html("");j=false;f();i&&i()})},updateContent:function(i){a().find(".box-content").html(i)}};d();return k};SLICK.Notification=function(){};
SLICK.DisplayHelper=function(){var c=["top","bottom"],a=["top","bottom"],e=/\$\{(.*?)\}/ig,d={top:null,right:null,bottom:null,left:null},f={init:function(){for(var h in d)d[h]=jQuery("#container-"+h).get(0);LOGGER.info("ajax activity indicator: "+SLICK.DisplayOpts.ajaxActivityImage);if(SLICK.DisplayOpts.ajaxActivityImage){f.addChunk(String.format("<img id='{0}' src='{1}' />","ajax_loader_indicator",SLICK.DisplayOpts.ajaxActivityImage),c);jQuery("#ajax_loader_indicator").ajaxStart(function(){jQuery(this).show()}).ajaxStop(function(){jQuery(this).hide()})}},
addChunk:function(h,j){j=j?j:a;for(var g=null,b=0;!g&&b<j.length;b++)g=d[j[b]];g&&jQuery(g).append(h)},removeChunk:function(h){jQuery(h).remove()},parseTemplate:function(h,j){h=h;for(var g=e.exec(h);g;){h=h.replace(g[0],jQuery(j).find(g[1]).text());g=e.exec(h)}return h}};return f};SLICK.Template=function(){return{}};SLICK.display=new SLICK.DisplayHelper;jQuery(document).ready(function(){SLICK.display.init()});
SLICK.Pannable=function(c){var a=new SLICK.Vector,e={args:jQuery.extend({},{container:null,onPan:null,checkOffset:null},c),pannable:true,getOffset:function(){return new SLICK.Vector(a.x,a.y)},pan:function(d,f){e.updateOffset(a.x+d,a.y+f);c.onPan&&c.onPan(d,f)},updateOffset:function(d,f){a.x=d;a.y=f;if(c.checkOffset)a=c.checkOffset(a)}};e.args.container&&jQuery(e.args.container).canTouchThis({moveHandler:function(d,f){e.pan(-d,-f)}});return e};
SLICK.Scalable=function(c){var a=0,e={args:jQuery.extend({},{container:null,onScale:null},c),scalable:true,getScaleAmount:function(){return a},scale:function(d){a=d*0.5;LOGGER.info("scaling by "+a);c.onScale&&c.onScale(a)}};e.args.container&&jQuery(e.args.container).canTouchThis({pinchZoomHandler:function(d){e.scale(d)}});return e};
SLICK.View=function(c){c=jQuery.extend({},{container:"",fps:30},c);var a=jQuery(c.container).get(0),e=null;if(a)try{e=a.getContext("2d")}catch(d){LOGGER.exception(d);throw"Could not initialise canvas on specified tiler element";}var f=0,h=Math.floor(1E3/c.fps);return{getContext:function(){return e},getDimensions:function(){var j=jQuery(a);return new SLICK.Dimensions(j.width(),j.height())},invalidate:function(j){if(j&&e&&c.onDraw)c.onDraw(e);else if(e&&f===0)f=setTimeout(function(){c.onDraw&&c.onDraw(e);
f=0},h)}}};
SLICK.OffscreenCanvas=function(c){c=jQuery.extend({},{width:0,height:0},c);var a=document.createElement("canvas");a.width=c.width;a.height=c.height;var e=a.height?a.width/a.height:1,d={width:c.width,height:c.height,aspect_ratio:e,inv_aspect_ratio:1/e,getCanvas:function(){return a},getContext:function(f){f||(f="2d");return a.getContext(f)},drawBackground:function(f,h){f.fillStyle="rgb(200, 200, 200)";f.fillRect(0,0,h.width,h.height)},drawToView:function(f){var h=f.getContext(),j=f.getDimensions();d.drawBackground(h,
j);var g=f.scalable?f.getScaleAmount():0,b=f.pannable?f.getOffset():new SLICK.Vector,l=f=0,k=j.width,i=j.height,m=Math.min(Math.max(b.x+g,0),a.width);b=Math.min(Math.max(b.y+g,0),a.height);var p=j.width-g*2,q=Math.round(p*j.inv_aspect_ratio);if(m<0||m+p>a.width||b<0||b+q>a.height){p=Math.min(p,a.width-m);q=Math.round(p*j.inv_aspect_ratio);if(b+q>a.height){q=a.height-b;p=Math.round(q*j.aspect_ratio)}k=Math.max(Math.min(j.width+g*2,j.width),200);i=Math.round(k*j.inv_aspect_ratio);f=(j.width-k)*0.5;
l=(j.height-i)*0.5}h.drawImage(a,m,b,p,q,f,l,k,i)}};return d};SLICK.TilerConfig={TILESIZE:128,TILEBUFFER:1,TILEBUFFER_LOADNEW:0.2,EMPTYTILE:"/public/images/tile.png"};SLICK.Border={NONE:0,TOP:1,RIGHT:2,BOTTOM:3,LEFT:4};
SLICK.TileGrid=function(c){function a(n,o,s){w.getContext().drawImage(n,o*b,s*b,b,b);for(n=0;n<q.length;n++)q[n]()}function e(n,o,s){if(n.src&&!n.complete){i.push({tile:n,col:o,row:s});a(t,o,s);n.onload=function(){if(!p){clearTimeout(m);m=setTimeout(function(){p=true;try{for(var r=0;r<i.length;)if(i[r].tile.complete){a(i[r].tile,i[r].col,i[r].row);i.splice(r,1)}else r++}catch(u){LOGGER.exception(u)}finally{p=false}},g)}}}else a(n,o,s)}function d(n,o){n=new SLICK.Vector(n.x,n.y);if(c.onNeedTiles){i=
[];c.onNeedTiles(o);n.x+=b*o.cols;n.y+=b*o.rows}return n}function f(n){if(n){var o=n.getContext("2d");o.fillStyle="rgb(200, 200, 200)";o.fillRect(0,0,n.width,n.height);o.strokeStyle="rgb(180, 180, 180)";o.lineWidth=0.5;for(var s=0;s<n.width;s+=j){o.beginPath();o.moveTo(s,0);o.lineTo(s,n.height);o.stroke();o.closePath();for(var r=0;r<n.height;r+=j){o.beginPath();o.moveTo(0,r);o.lineTo(n.width,r);o.stroke();o.closePath()}}}else LOGGER.warn("Cannot prep canvas - not supplied")}var h={tilesize:SLICK.TilerConfig.TILESIZE,
width:800,height:600,onNeedTiles:null};if(b==0)throw new Exception("Cannot create new TileGrid: Tile size cannot be 0");c=jQuery.extend({},h,c);LOGGER.info("Creating a tiler with tilesize "+c.tilesize);var j=16,g=200,b=c.tilesize,l=Math.ceil(c.width/b)+SLICK.TilerConfig.TILEBUFFER,k=Math.ceil(c.height/b)+SLICK.TilerConfig.TILEBUFFER,i=[],m=0,p=false,q=[];l=l%2==0?l+1:l;k=k%2==0?k+1:k;c.width=l*b;c.height=k*b;var t=document.createElement("canvas");t.width=b;t.height=b;f(t);var v=new Array(l*k);h=new SLICK.OffscreenCanvas(c);
var w=jQuery.extend({},h,{customdata:{},columns:l,rows:k,centerTile:{col:Math.ceil(l*0.5),row:Math.ceil(k*0.5)},checkTileBuffers:function(n,o){if(!o)o=SLICK.TilerConfig.TILEBUFFER_LOADNEW;var s=n.pannable?n.getOffset():new Vector,r=n.getDimensions();r={top:s.y,left:s.x,bottom:s.y+r.height,right:s.x+r.width};var u={cols:0,rows:0};LOGGER.info(String.format("CHECKING TILE BUFFERS, display rect = (top: {0}, left: {1}, bottom: {2}, right: {3})",r.top,r.left,r.bottom,r.right));if(r.top<=b*o)u.rows=Math.abs(Math.floor(r.top/
b))+1;else if(r.bottom+b*o>=w.height)u.rows=-(Math.floor((r.bottom-w.height)/b)+1);if(r.left<=b*o)u.cols=Math.abs(Math.floor(r.left/b))+1;else if(r.right+b*o>=w.width)u.cols=-(Math.floor((r.right-w.width)/b)+1);if(u.rows!==0||u.cols!==0){updated_offset=d(s,u);n.updateOffset(updated_offset.x,updated_offset.y)}},requestUpdates:function(n){q.push(n)},getGridHeight:function(){return k*b},getGridWidth:function(){return l*b},getTile:function(n,o){if(n<l&&n>=0&&o<k&&o>=0)return v[o*k+n];return null},setTile:function(n,
o,s){s=s?s:t;(v[o*k+n]=s)&&e(s,n,o)},getTileSize:function(){return b}});return w};
SLICK.Tiler=function(c){jQuery(c.container).canTouchThis({touchStartHandler:function(){j.scale(0)},tapHandler:function(g,b){j.args.tapHandler&&j.args.tapHandler(g,b)}});var a=null,e=[],d=new SLICK.View(jQuery.extend({},c,{onDraw:function(g){if(a){a.drawToView(d);for(var b=0;b<e.length;b++)e[b].drawToView(d)}j.args.onDraw&&j.args.onDraw(g)}})),f=new SLICK.Pannable({container:c.container,onPan:function(g,b){if(a){j.invalidate(true);a.checkTileBuffers(j);j.args.panHandler&&j.args.panHandler(g,b)}}}),
h=new SLICK.Scalable({container:c.container,onScale:function(){a&&j.invalidate(true)}}),j=jQuery.extend(d,f,h,{args:jQuery.extend({},{container:"",panHandler:null,tapHandler:null,onDraw:null},c),getGrid:function(){return a},setGrid:function(g){a=g;j.invalidate();a.requestUpdates(function(){j.invalidate()})},gridPixToViewPix:function(g){var b=j.getOffset();return new SLICK.Vector(g.x-b.x,g.y-b.y)},viewPixToGridPix:function(g){var b=j.getOffset();LOGGER.info("Offset = "+b);return new SLICK.Vector(g.x+
b.x,g.y+b.y)}});return j};var GEO={};GEO.Distance=function(c,a){var e=0;if(c&&!c.isEmpty()&&a&&!a.isEmpty()){var d=(a.lat-c.lat).toRad()*0.5,f=(a.lon-c.lon).toRad()*0.5;c=Math.sin(d)*Math.sin(d)+Math.cos(c.lat.toRad())*Math.cos(a.lat.toRad())*Math.sin(f)*Math.sin(f);e=6371*2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))}return{toM:function(){return e*1E3},toKM:function(){return e},toString:function(){return e+"km"}}};GEO.Radius=function(c,a){return{distance:parseInt(c,10),uom:a}};
GEO.Position=function(c,a){if(!a&&c&&c.split&&c.indexOf(" ")>=0){a=c.split(" ");c=a[0];a=a[1]}if(!c)a=c=0;var e={lat:parseFloat(c),lon:parseFloat(a),copy:function(d){e.lat=d.lat;e.lon=d.lon},clear:function(){e.lat=0;e.lon=0},inBounds:function(d){var f=!(e.isEmpty()||d.isEmpty());return f=(f=f&&e.lat>=d.min.lat&&e.lat<=d.max.lat)&&e.lon>=d.min.lon&&e.lon<=d.max.lon},isEmpty:function(){return e.lat===0&&e.lon===0},getMercatorPixels:function(d){return new SLICK.Vector(GEO.Utilities.lon2pix(e.lon,d),
GEO.Utilities.lat2pix(e.lat,d))},setMercatorPixels:function(d,f,h){if(!h)throw"Unable to calculate position from mercator pixels without rads_per_pixel value";e.lat=GEO.Utilities.pix2lat(f,h);e.lon=GEO.Utilities.pix2lon(d,h)},toString:function(){return e.lat+" "+e.lon}};return e};
GEO.BoundingBox=function(c,a){if(c){if(c.split)c=new GEO.Position(c)}else c=new GEO.Position;if(a){if(a.split)a=new GEO.Position(a)}else a=new GEO.Position;var e={min:c,max:a,copy:function(d){e.min.copy(d.min);e.max.copy(d.max)},clear:function(){e.min.clear();e.max.clear()},isEmpty:function(){return e.min.isEmpty()||e.max.isEmpty()},transform:function(d){var f=new GEO.BoundingBox(e.min,e.max);LOGGER.info("applying "+d.length+" transformers");for(var h=0;d&&h<d.length;h++)d[h].apply(f);return f},toString:function(){return String.format("({0}, {1})",
e.min,e.max)}};return e};GEO.TRANSFORM=function(){return{Shrink:function(){return function(){}},Offset:function(){return function(){}}}}();
GEO.Utilities=function(){var c={lat2pix:function(a,e){a=parseFloat(a)*2*Math.PI/360;a=Math.sin(a);var d=0.08181919084262157*a;return Math.log((1+a)/(1-a)*Math.pow((1-d)/(1+d),0.08181919084262157))/2/e},lon2pix:function(a,e){return parseFloat(a)/180*Math.PI/e},pix2lon:function(a,e){return a*e*180/Math.PI},pix2lat:function(a,e){a=Math.pow(Math.E,-a*e);e=c.mercatorUnproject(a);for(var d=c.findRadPhi(e,a),f=0;f<12&&Math.abs(e-d)>1.0E-7;){e=d;d=c.findRadPhi(e,a);f++}return d*180/Math.PI},mercatorUnproject:function(a){return Math.PI/
2-2*Math.atan(a)},findRadPhi:function(a,e){a=0.08181919084262157*Math.sin(a);return Math.PI/2-2*Math.atan(e*Math.pow((1-a)/(1+a),0.040909595421310785))}};return c}();GEO.MapProvider=function(){return{zoomLevel:0,getMapTiles:function(){},getPositionForXY:function(){return null}}};
SLICK.MapTileGrid=function(c){function a(){if(!(f.isEmpty()||d===0)){var b=f.getMercatorPixels(d);h=new SLICK.Vector(b.x-g.getGridWidth()*0.5,b.y-g.getGridHeight()*0.5);LOGGER.info("CALCULATING GRID BOUNDS");LOGGER.info("center position:             "+f);LOGGER.info("center mercator pixels:      "+b);LOGGER.info("bottom left mercator pixels: "+h);e()}}function e(){j.min.setMercatorPixels(h.x,h.y,d);j.max.setMercatorPixels(h.x+g.getGridWidth(),h.y+g.getGridHeight(),d)}var d=0,f=new GEO.Position,h=
null,j=new GEO.BoundingBox;c=new SLICK.TileGrid(c);var g=jQuery.extend({},c,{getBoundingBox:function(){return j},getMercatorMin:function(){return new SLICK.Vector(h.x,h.y)},getCenterPos:function(){return f},setCenterPos:function(b){f.copy(b);a()},getTopLeftMercatorPixels:function(){return new SLICK.Vector(h.x,h.y+g.getGridHeight())},getMercatorPixelsForPos:function(b){return b.getMercatorPixels(d)},getGridXYForPosition:function(b){var l=b.getMercatorPixels(d);LOGGER.info("GETTING OFFSET for position: "+
b);b=Math.abs(l.x-h.x)+g.getTileSize();var k=g.getGridHeight()-Math.abs(l.y-h.y)+g.getTileSize();LOGGER.info("position mercator pixels: "+l);LOGGER.info("bottom left mercator pixels: "+h);LOGGER.info("calcalated pos offset:    "+b+", "+k);return new SLICK.Vector(b,k)},getRadsPerPixel:function(){return d},setRadsPerPixel:function(b){if(d!==b){d=b;a()}},pixelsToPos:function(b){var l=new GEO.Position;l.setMercatorPixels(h.x+b.x-g.getTileSize(),h.y+Math.abs(g.getGridHeight()-b.y)+g.getTileSize(),d);return l},
offsetPixelPositions:function(b){var l=-b.cols*g.getTileSize();b=-b.rows*g.getTileSize();LOGGER.info("OFFSETTING MERCATOR POSITIONS BY: x: "+l+", y: "+b);LOGGER.info("bottom left mercator before: "+h);h.x+=l;h.y-=b;LOGGER.info("bottom left mercator after:  "+h);e()}});return g};
SLICK.MappingTiler=function(c){c=jQuery.extend({},{tapExtent:10,provider:null},c);var a=c.provider,e=10;a||(a=new GEO.MapProvider);var d=c.panHandler,f=c.tapHandler,h={};c.panHandler=function(b,l){var k=g.getGrid();if(k)bounds=k.getBoundingBox();d&&d(b,l)};c.tapHandler=function(b,l){var k=g.getGrid(),i=null;if(k){var m=g.viewPixToGridPix(new SLICK.Vector(b,l));i=k.pixelsToPos(m.offset(-c.tapExtent,c.tapExtent));k=k.pixelsToPos(m.offset(c.tapExtent,-c.tapExtent));i=new GEO.BoundingBox(i.toString(),
k.toString());LOGGER.info("tap bounds = "+i)}f&&f(b,l,i)};c.onDraw=function(b){g.pannable?g.getOffset():new SLICK.Vector;var l=g.getGrid();for(var k in h)if(h[k]&&l){var i=g.gridPixToViewPix(l.getGridXYForPosition(h[k].poi.pos));h[k].drawToContext(b,i.x,i.y)}};var j=new SLICK.Tiler(c),g=jQuery.extend({},j,{getBoundingBox:function(b){b=b?b:0;var l=g.getDimensions(),k=g.getOffset();return g.getGrid().getBoundingBox().transform([GEO.TRANSFORM.Shrink(l.width+b*2,l.height+b*2),GEO.TRANSFORM.Offset(k.x+
b,k.y+b)])},getCenterPosition:function(){return null},gotoPosition:function(b,l,k){e=l?l:e;if(!e)throw"Zoom level required to goto a position.";a.zoomLevel=e;a.getMapTiles(g,b,function(i){LOGGER.info(String.format("created tile grid {0} x {1}",i.columns,i.rows));g.setGrid(i);g.panToPosition(b,k)})},panToPosition:function(b,l){var k=g.getGrid();if(k){b=k.getGridXYForPosition(b);k=g.getDimensions();b.x-=k.width*0.5;b.y-=k.height*0.5;LOGGER.info(String.format("need to apply pan vector of ({0}) to correctly center",
b));LOGGER.info("offset before pan = "+g.getOffset());g.pan(b.x,b.y);LOGGER.info("offset after pan = "+g.getOffset());l&&l(g)}},setZoomLevel:function(b){if(e!==b)e=b;g.gotoPosition(g.getCenterPosition(),e)},addPOI:function(b){if(g.getGrid()&&b&&b.id&&b.pos){h[b.id]=new GEO.POIPin({poi:b});g.invalidate()}},removePOI:function(b){LOGGER.info("removing poi: "+b);if(b&&b.id){h[b.id]=null;g.invalidate()}}},j);return g};
GEO.PointOfInterest=function(c){c=jQuery.extend({},{id:0,title:"",pos:null,lat:"",lon:"",type:"",retrieved:0},c);if(!c.pos&&c.lat&&c.lon)c.pos=new GEO.Position(c.lat,c.lon);var a={id:c.id,title:c.title,pos:c.pos,pin:null,type:c.type,toString:function(){return String.format("{0}: '{1}'",a.id,a.title)}};return a};
GEO.POIPin=function(c){c=jQuery.extend({},{poi:null},c);var a={poi:c.poi,drawToContext:function(d,f,h){if(e&&e.complete){LOGGER.info(String.format("DRAWING POI: {0} @ {1}, {2}",a.poi,f,h));d.drawImage(e,f,h)}}},e=new Image;e.src="/public/images/app/markers/"+a.poi.type+".png";return a};
GEO.POIInfoBox=function(c){function a(){var b=[];if(f.length>1){b.push({text:"Back",click:function(){g.setActivePOI(h-1)}});b.push({text:"Next",click:function(){g.setActivePOI(h+1)},align:"right"})}b.push({text:"View Details",click:function(){if(g.getDetailsVisible())g.hideDetails();else g.args.requirePOIDetails&&g.args.requirePOIDetails(g.getActivePOI(),function(l){g.showDetails(l)})},align:"center"});g.setButtons(b)}function e(){LOGGER.info("updating poi display: index = "+h);d=null;if(h>=0&&h<
f.length){d=f[h];g.updateContent("<h4>"+d.title+"</h4>");if(g.getDetailsVisible())g.args.requirePOIDetails?g.args.requirePOIDetails(d,function(b){g.showDetails(b)}):g.hideDetails()}}c=jQuery.extend({},{pois:[]},c);var d=null,f=c.pois,h=0,j=new SLICK.InfoBox(c),g=jQuery.extend({},j,{args:c,getActivePOI:function(){return d},setActivePOI:function(b,l){if(b<0)b=f.length-1;else if(b>=f.length)b=0;if(b!=h||l){h=b;e();c.handlePOIChange&&c.handlePOIChange(f[h])}},setPOIs:function(b){f=[];for(var l=0;b&&l<
b.length;l++)f.push(b[l]);if(f.length>0){a();g.show();g.setActivePOI(0,true)}else g.hide()}});return g};
GEO.POILayer=function(c){var a=[],e=true;return{args:jQuery.extend({},{visibilityChange:null},c),getPOIs:function(){for(var d=[],f=0;f<a.length;f++)d.push(a[f]);return d},getOldPOIs:function(d){for(var f=[],h=0;h<a.length;h++)a[h].retrieved<d&&f.push(a[h]);return f},getVisible:function(){return e},setVisible:function(d){if(d!=e){e=d;c.visibilityChange&&c.visibilityChange()}},findById:function(d){for(var f=0;f<a.length;f++)if(a[f].id==d)return a[f];return null},findByBounds:function(d){for(var f=[],
h=0;h<a.length;h++)a[h].pos&&a[h].pos.inBounds(d)&&f.push(a[h]);return f},removeById:function(d){for(var f=0;f<a.length;f++)if(a[f].id==d){a.splice(f,1);return}},addPOIs:function(d,f){if(f)a=[];for(f=0;d&&f<d.length;f++){d[f].retrieved=(new Date).getTime();a.push(d[f])}}}};
GEO.POIProvider=function(c){function a(l){var k=[],i=0,m=(new Date).getTime();LOGGER.info(String.format("{0} pois to process :)",l.length));for(i=0;i<l.length;i++){var p=b.pois.findById(l[i].id);if(p)p.retrieved=m;else k.push(l[i])}l=b.pois.getOldPOIs(m);b.pois.addPOIs(k);LOGGER.info(String.format("POI-UPDATE: {0} new, {1} deleted",k.length,l.length));for(i=0;b.args.onPOIAdded&&i<k.length;i++)b.args.onPOIAdded(k[i]);for(i=0;b.args.onPOIDeleted&&i<l.length;i++){b.args.onPOIDeleted(l[i]);b.pois.removeById(l[i].id)}for(i=
0;i<g.length;i++)g[i](b)}var e={poitype:"",onInitRequest:null,onCheckBounds:null,onParseResponse:null,onPOIAdded:null,onPOIDeleted:null,onChangedPOIs:null,layerClass:GEO.POILayer},d=new GEO.BoundingBox,f=new GEO.BoundingBox,h=false,j=0,g=[];c=jQuery.extend({},e,c);var b={args:c,pois:new c.layerClass,getForBounds:function(l,k){if(h)f.copy(l);else{j&&clearTimeout(j);j=setTimeout(function(){if(!l||l.isEmpty())LOGGER.warn("cannot get pois for empty bounding box");else{var i=null;d.isEmpty()||(i=new GEO.Distance(d.min,
l.min));if(!i||b.testBoundsChange(i)){LOGGER.info("yep - bounds changed = "+i);i=jQuery.extend({success:function(m,p,q){try{a(b.parseResponse(m,p,q));h=false;k&&k(b.pois);j=0;if(!f.isEmpty()){b.getForBounds(f,k);f.clear()}}catch(t){LOGGER.exception(t)}},error:function(m,p,q){h=false;LOGGER.error("failed getting POIS from server: "+p+":"+q)}},b.initRequest());d.copy(l);h=true;LOGGER.info("Looking for POIS within bounding box");jQuery.ajax(i)}}},500)}},initRequest:function(){return b.args.onInitRequest?
b.args.onInitRequest():{}},parseResponse:function(l,k,i){return b.args.onParseResponse?b.args.onParseResponse(l,k,i):[]},requestUpdates:function(l){g.push(l)},testBoundsChange:function(l){LOGGER.info("testing for bounds change: distance = "+l);if(l&&l.toKM()==0)return false;return b.args.onCheckBounds?b.args.onCheckBounds(l):true}};return b};
